var alphaTab=(()=>{var C=Object.defineProperty,R=Object.getOwnPropertyDescriptor,O=Object.getOwnPropertyNames,V=Object.prototype.hasOwnProperty,W=(e,t)=>Symbol[e]||Symbol.for("Symbol."+e),H=e=>{throw TypeError(e)},G=(e,t)=>{for(var s in t)C(e,s,{get:t[s],enumerable:!0})},z=(e,t,s)=>{var i,a;return null!=t?("object"!=typeof t&&"function"!=typeof t&&H("Object expected"),void 0===(i=s?t[W("asyncDispose")]:i)&&(i=t[W("dispose")],s)&&(a=i),"function"!=typeof i&&H("Object not disposable"),a&&(i=function(){try{a.call(this)}catch(e){return Promise.reject(e)}}),e.push([s,i,t])):s&&e.push([s]),t},U=(s,i,a)=>{var t="function"==typeof SuppressedError?SuppressedError:function(e,t,s,i){return(i=Error(s)).name="SuppressedError",i.error=e,i.suppressed=t,i},r=e=>i=a?new t(e,i,"An error was suppressed during disposal"):(a=!0,e),n=e=>{for(;e=s.pop();)try{var t=e[1]&&e[1].call(e[2]);if(e[0])return Promise.resolve(t).then(n,e=>(r(e),n()))}catch(e){r(e)}if(a)throw i};return n()},Y={},X=(G(Y,{AlphaTabApi:()=>Qo,AlphaTabApiBase:()=>Do,AlphaTabError:()=>b,AlphaTabErrorType:()=>X,ConsoleLogger:()=>_e,CoreSettings:()=>Rc,DisplaySettings:()=>Qr,EngravingSettings:()=>Jr,EngravingStemInfo:()=>Yr,Environment:()=>E,ExporterSettings:()=>_n,FileLoadError:()=>Io,FingeringMode:()=>pe,FontFileFormat:()=>Ac,FormatError:()=>Gt,ImporterSettings:()=>Zr,LayoutMode:()=>as,LogLevel:()=>ye,Logger:()=>M,NotationElement:()=>ge,NotationMode:()=>me,NotationSettings:()=>fe,PlayerMode:()=>rn,PlayerOutputMode:()=>an,PlayerSettings:()=>nn,ProgressEventArgs:()=>Ko,RenderEngineFactory:()=>Ic,RenderingResources:()=>jr,ResizeEventArgs:()=>yo,ScrollMode:()=>en,Settings:()=>Sn,SlidePlaybackSettings:()=>sn,StaveProfile:()=>$r,SystemsLayoutMode:()=>Kr,TabRhythmMode:()=>ue,VibratoPlaybackSettings:()=>tn,WebPlatform:()=>$n,exporter:()=>Hc,importer:()=>Oc,io:()=>Wc,json:()=>wu,meta:()=>J,midi:()=>lu,model:()=>Su,platform:()=>vu,rendering:()=>ss,synth:()=>ku}),"u"<typeof Symbol.dispose&&(Symbol.dispose=Symbol("Symbol.dispose")),typeof window<"u"&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=class{constructor(e){this._targets=new Set,this._callback=e,window.addEventListener("resize",this._onWindowResize.bind(this),!1)}observe(e){this._targets.add(e)}unobserve(e){this._targets.delete(e)}disconnect(){this._targets.clear()}_onWindowResize(){var e,t=[];for(e of this._targets)t.push({target:e,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(t,this)}}),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=class{constructor(e){this._elements=[],this._timer=null,this._callback=e,window.addEventListener("resize",()=>this._check,!0),document.addEventListener("scroll",()=>this._check,!0)}_check(){this._timer||(this._timer=setTimeout(()=>{this._doCheck(),this._timer=null},100))}observe(e){0<=this._elements.indexOf(e)||(this._elements.push(e),this._check())}unobserve(t){this._elements=this._elements.filter(e=>e!==t)}_doCheck(){var e,t=[];for(e of this._elements){var s=e.getBoundingClientRect();0<=s.top+s.height&&s.top<=window.innerHeight&&0<=s.left+s.width&&s.left<=window.innerWidth&&t.push({target:e,isIntersecting:!0})}t.length&&this._callback(t,this)}}),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...e){this.innerHTML="",this.append(...e)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)}),(x=X||{})[x.General=0]="General",x[x.Format=1]="Format",x[x.AlphaTex=2]="AlphaTex",x),b=class extends Error{constructor(e,t="",s){super(t??"",{cause:s}),this.type=e}},t=class t{static print(e){e("alphaTab "+t.version),e("commit: "+t.commit),e("build date: "+t.date)}},J=(t.version="1.7.0",t.date="2025-11-24T00:38:00.000Z",t.commit="dev",t),q=((x={})[x.PPP=0]="PPP",x[x.PP=1]="PP",x[x.P=2]="P",x[x.MP=3]="MP",x[x.MF=4]="MF",x[x.F=5]="F",x[x.FF=6]="FF",x[x.FFF=7]="FFF",x[x.PPPP=8]="PPPP",x[x.PPPPP=9]="PPPPP",x[x.PPPPPP=10]="PPPPPP",x[x.FFFF=11]="FFFF",x[x.FFFFF=12]="FFFFF",x[x.FFFFFF=13]="FFFFFF",x[x.SF=14]="SF",x[x.SFP=15]="SFP",x[x.SFPP=16]="SFPP",x[x.FP=17]="FP",x[x.RF=18]="RF",x[x.RFZ=19]="RFZ",x[x.SFZ=20]="SFZ",x[x.SFFZ=21]="SFFZ",x[x.FZ=22]="FZ",x[x.N=23]="N",x[x.PF=24]="PF",x[x.SFZP=25]="SFZP",x),i=class i{static ticksToMillis(e,t){return e*(6e4/(t*i.QuarterTime))|0}static millisToTicks(e,t){return e/(6e4/(t*i.QuarterTime))|0}static toTicks(e){return i.valueToTicks(e)}static valueToTicks(e){let t=e;return t<0&&(t=1/-t),i.QuarterTime*(4/t)|0}static applyDot(e,t){return t?e+3*(e/4|0):e+(e/2|0)}static applyTuplet(e,t,s){return e*s/t|0}static removeTuplet(e,t,s){return e*t/s|0}static dynamicToVelocity(e,t=0){let s=1;switch(e){case 0:s=i._minVelocity+0*i.VelocityIncrement;break;case 1:s=i._minVelocity+ +i.VelocityIncrement;break;case 2:s=i._minVelocity+2*i.VelocityIncrement;break;case 3:s=i._minVelocity+3*i.VelocityIncrement;break;case 4:s=i._minVelocity+4*i.VelocityIncrement;break;case 5:s=i._minVelocity+5*i.VelocityIncrement;break;case 6:s=i._minVelocity+6*i.VelocityIncrement;break;case 7:s=i._minVelocity+7*i.VelocityIncrement;break;case 8:s=10;break;case 9:s=5;break;case 10:s=3;break;case 11:s=i._minVelocity+8*i.VelocityIncrement;break;case 12:s=i._minVelocity+9*i.VelocityIncrement;break;case 13:s=i._minVelocity+10*i.VelocityIncrement;break;case 14:case 15:case 25:case 16:case 20:case 22:s=i._minVelocity+6*i.VelocityIncrement;break;case 17:s=i._minVelocity+5*i.VelocityIncrement;break;case 18:case 19:case 21:s=i._minVelocity+5*i.VelocityIncrement;break;case 23:s=1;break;case 24:s=i._minVelocity+(4.5*i.VelocityIncrement|0)}return s+=t*i.VelocityIncrement,Math.min(Math.max(s,1),127)}},N=(i.QuarterTime=960,i._minVelocity=15,i.VelocityIncrement=16,i),j=((t={})[t.Tempo=0]="Tempo",t[t.Volume=1]="Volume",t[t.Instrument=2]="Instrument",t[t.Balance=3]="Balance",t[t.SyncPoint=4]="SyncPoint",t[t.Bank=4]="Bank",t),$=class{constructor(){this.barOccurence=0,this.millisecondOffset=0}},K=class Bu{constructor(){this.isLinear=!1,this.type=0,this.value=0,this.ratioPosition=0,this.text="",this.isVisible=!0}static buildTempoAutomation(e,t,s,i,a=!0){(i<1||5<i)&&(i=2);var r=new Float32Array([1,.5,1,1.5,2,3]),n=new Bu;return n.type=0,n.isLinear=e,n.ratioPosition=t,n.value=s*r[i],n.isVisible=a,n}static buildInstrumentAutomation(e,t,s){var i=new Bu;return i.type=2,i.isLinear=e,i.ratioPosition=t,i.value=s,i}},w=class{constructor(e=0,t=0){this.offset=e,this.value=t}},Q=(w.MaxPosition=60,w.MaxValue=12,(x={})[x.Default=0]="Default",x[x.Gradual=1]="Gradual",x[x.Fast=2]="Fast",x),Z=((i={})[i.None=0]="None",i[i.Custom=1]="Custom",i[i.Bend=2]="Bend",i[i.Release=3]="Release",i[i.BendRelease=4]="BendRelease",i[i.Hold=5]="Hold",i[i.Prebend=6]="Prebend",i[i.PrebendBend=7]="PrebendBend",i[i.PrebendRelease=8]="PrebendRelease",i),ee=((t={})[t.None=0]="None",t[t.BrushUp=1]="BrushUp",t[t.BrushDown=2]="BrushDown",t[t.ArpeggioUp=3]="ArpeggioUp",t[t.ArpeggioDown=4]="ArpeggioDown",t),te=((x={})[x.None=0]="None",x[x.Crescendo=1]="Crescendo",x[x.Decrescendo=2]="Decrescendo",x),se=((i={})[i.QuadrupleWhole=-4]="QuadrupleWhole",i[i.DoubleWhole=-2]="DoubleWhole",i[i.Whole=1]="Whole",i[i.Half=2]="Half",i[i.Quarter=4]="Quarter",i[i.Eighth=8]="Eighth",i[i.Sixteenth=16]="Sixteenth",i[i.ThirtySecond=32]="ThirtySecond",i[i.SixtyFourth=64]="SixtyFourth",i[i.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",i[i.TwoHundredFiftySixth=256]="TwoHundredFiftySixth",i),ie=((t={})[t.None=0]="None",t[t.OnBeat=1]="OnBeat",t[t.BeforeBeat=2]="BeforeBeat",t[t.BendGrace=3]="BendGrace",t),ae=((x={})[x.None=0]="None",x[x.Normal=1]="Normal",x[x.Heavy=2]="Heavy",x[x.Tenuto=3]="Tenuto",x),re=((i={})[i.Unknown=-2]="Unknown",i[i.NoOrDead=-1]="NoOrDead",i[i.Thumb=0]="Thumb",i[i.IndexFinger=1]="IndexFinger",i[i.MiddleFinger=2]="MiddleFinger",i[i.AnnularFinger=3]="AnnularFinger",i[i.LittleFinger=4]="LittleFinger",i),ne=((t={})[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Artificial=2]="Artificial",t[t.Pinch=3]="Pinch",t[t.Tap=4]="Tap",t[t.Semi=5]="Semi",t[t.Feedback=6]="Feedback",t),oe=((x={})[x.Default=0]="Default",x[x.ForceNone=1]="ForceNone",x[x.ForceNatural=2]="ForceNatural",x[x.ForceSharp=3]="ForceSharp",x[x.ForceDoubleSharp=4]="ForceDoubleSharp",x[x.ForceFlat=5]="ForceFlat",x[x.ForceDoubleFlat=6]="ForceDoubleFlat",x),he=((i={})[i._15ma=0]="_15ma",i[i._8va=1]="_8va",i[i.Regular=2]="Regular",i[i._8vb=3]="_8vb",i[i._15mb=4]="_15mb",i),le=((t={})[t.None=0]="None",t[t.IntoFromBelow=1]="IntoFromBelow",t[t.IntoFromAbove=2]="IntoFromAbove",t),de=((x={})[x.None=0]="None",x[x.Shift=1]="Shift",x[x.Legato=2]="Legato",x[x.OutUp=3]="OutUp",x[x.OutDown=4]="OutDown",x[x.PickSlideDown=5]="PickSlideDown",x[x.PickSlideUp=6]="PickSlideUp",x),ce=((i={})[i.None=0]="None",i[i.Slight=1]="Slight",i[i.Wide=2]="Wide",i),ue=((t=ue||{})[t.Hidden=0]="Hidden",t[t.ShowWithBeams=1]="ShowWithBeams",t[t.ShowWithBars=2]="ShowWithBars",t[t.Automatic=3]="Automatic",t),pe=((x=pe||{})[x.ScoreDefault=0]="ScoreDefault",x[x.ScoreForcePiano=1]="ScoreForcePiano",x[x.SingleNoteEffectBand=2]="SingleNoteEffectBand",x[x.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",x),me=((i=me||{})[i.GuitarPro=0]="GuitarPro",i[i.SongBook=1]="SongBook",i),ge=((t=ge||{})[t.ScoreTitle=0]="ScoreTitle",t[t.ScoreSubTitle=1]="ScoreSubTitle",t[t.ScoreArtist=2]="ScoreArtist",t[t.ScoreAlbum=3]="ScoreAlbum",t[t.ScoreWords=4]="ScoreWords",t[t.ScoreMusic=5]="ScoreMusic",t[t.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",t[t.ScoreCopyright=7]="ScoreCopyright",t[t.GuitarTuning=8]="GuitarTuning",t[t.TrackNames=9]="TrackNames",t[t.ChordDiagrams=10]="ChordDiagrams",t[t.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",t[t.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",t[t.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",t[t.EffectAlternateEndings=14]="EffectAlternateEndings",t[t.EffectCapo=15]="EffectCapo",t[t.EffectChordNames=16]="EffectChordNames",t[t.EffectCrescendo=17]="EffectCrescendo",t[t.EffectDynamics=18]="EffectDynamics",t[t.EffectFadeIn=19]="EffectFadeIn",t[t.EffectFermata=20]="EffectFermata",t[t.EffectFingering=21]="EffectFingering",t[t.EffectHarmonics=22]="EffectHarmonics",t[t.EffectLetRing=23]="EffectLetRing",t[t.EffectLyrics=24]="EffectLyrics",t[t.EffectMarker=25]="EffectMarker",t[t.EffectOttavia=26]="EffectOttavia",t[t.EffectPalmMute=27]="EffectPalmMute",t[t.EffectPickSlide=28]="EffectPickSlide",t[t.EffectPickStroke=29]="EffectPickStroke",t[t.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",t[t.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",t[t.EffectTap=32]="EffectTap",t[t.EffectTempo=33]="EffectTempo",t[t.EffectText=34]="EffectText",t[t.EffectTrill=35]="EffectTrill",t[t.EffectTripletFeel=36]="EffectTripletFeel",t[t.EffectWhammyBar=37]="EffectWhammyBar",t[t.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",t[t.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",t[t.EffectLeftHandTap=40]="EffectLeftHandTap",t[t.EffectFreeTime=41]="EffectFreeTime",t[t.EffectSustainPedal=42]="EffectSustainPedal",t[t.EffectGolpe=43]="EffectGolpe",t[t.EffectWahPedal=44]="EffectWahPedal",t[t.EffectBeatBarre=45]="EffectBeatBarre",t[t.EffectNoteOrnament=46]="EffectNoteOrnament",t[t.EffectRasgueado=47]="EffectRasgueado",t[t.EffectDirections=48]="EffectDirections",t[t.EffectBeatTimer=49]="EffectBeatTimer",t),s=class s{constructor(){this.notationMode=0,this.fingeringMode=0,this.showChordDiagramsOnBeats=!0,this.elements=new Map,this.rhythmMode=3,this.rhythmHeight=15,this.transpositionPitches=[],this.displayTranspositionPitches=[],this.smallGraceTabNotes=!0,this.extendBendArrowsOnTiedNotes=!0,this.extendLineEffectsToBeatEnd=!1,this.slurHeight=5}isNotationElementVisible(e){return this.elements.has(e)?this.elements.get(e):!s.defaultElements.has(e)||s.defaultElements.get(e)}},fe=(s.defaultElements=new Map([[13,!1]]),s),be=class{constructor(e){this._value=void 0,this._factory=e}get hasValue(){return void 0!==this._value}get value(){return void 0===this._value&&(this._value=this._factory()),this._value}reset(){this._value=void 0}},ye=((x=ye||{})[x.None=0]="None",x[x.Debug=1]="Debug",x[x.Info=2]="Info",x[x.Warning=3]="Warning",x[x.Error=4]="Error",x),a=class a{static _format(e,t){return`[AlphaTab][${e}] `+t}debug(e,t,...s){console.debug(a._format(e,t),...s)}warning(e,t,...s){console.warn(a._format(e,t),...s)}info(e,t,...s){console.info(a._format(e,t),...s)}error(e,t,...s){console.error(a._format(e,t),...s)}},_e=(a.logLevel=2,a),r=class r{static _shouldLog(e){return 0!==r.logLevel&&e>=r.logLevel}static debug(e,t,...s){r._shouldLog(1)&&r.log.debug(e,t,...s)}static warning(e,t,...s){r._shouldLog(3)&&r.log.warning(e,t,...s)}static info(e,t,...s){r._shouldLog(2)&&r.log.info(e,t,...s)}static error(e,t,...s){r._shouldLog(4)&&r.log.error(e,t,...s)}},M=(r.logLevel=2,r.log=new _e,r),Se=((i={})[i.NoBrackets=0]="NoBrackets",i[i.GroupStaves=1]="GroupStaves",i[i.GroupSimilarInstruments=2]="GroupSimilarInstruments",i),ve=((t={})[t.Hidden=0]="Hidden",t[t.FirstSystem=1]="FirstSystem",t[t.AllSystems=2]="AllSystems",t),ke=((s={})[s.FullName=0]="FullName",s[s.ShortName=1]="ShortName",s),we=((x={})[x.Horizontal=0]="Horizontal",x[x.Vertical=1]="Vertical",x),Te=class{constructor(){this.hideDynamics=!1,this.bracketExtendMode=1,this.useSystemSignSeparator=!1,this.globalDisplayTuning=!0,this.perTrackDisplayTuning=null,this.globalDisplayChordDiagramsOnTop=!0,this.perTrackChordDiagramsOnTop=null,this.singleTrackTrackNamePolicy=1,this.multiTrackTrackNamePolicy=1,this.firstSystemTrackNameMode=1,this.otherSystemsTrackNameMode=1,this.firstSystemTrackNameOrientation=1,this.otherSystemsTrackNameOrientation=1,this.multiTrackMultiBarRest=!1,this.perTrackMultiBarRest=null}},Be=class{constructor(){this.masterBars=[],this.opening=null,this.closings=[],this.isClosed=!1}get openings(){var e=this.opening;return e?[e]:[]}get isOpened(){return!0===this.opening?.isRepeatStart}addMasterBar(e){null===this.opening&&(this.opening=e),this.masterBars.push(e),e.repeatGroup=this,e.isRepeatEnd&&(this.closings.push(e),this.isClosed=!0)}},xe=class{constructor(){this.colors=new Map}},Pe=((a={})[a.Neutral=0]="Neutral",a[a.C3=1]="C3",a[a.C4=2]="C4",a[a.F4=3]="F4",a[a.G2=4]="G2",a),Ne=((r={})[r.None=0]="None",r[r.Simple=1]="Simple",r[r.FirstOfDouble=2]="FirstOfDouble",r[r.SecondOfDouble=3]="SecondOfDouble",r),Me=((i={})[i.Cb=-7]="Cb",i[i.Gb=-6]="Gb",i[i.Db=-5]="Db",i[i.Ab=-4]="Ab",i[i.Eb=-3]="Eb",i[i.Bb=-2]="Bb",i[i.F=-1]="F",i[i.C=0]="C",i[i.G=1]="G",i[i.D=2]="D",i[i.A=3]="A",i[i.E=4]="E",i[i.B=5]="B",i[i.FSharp=6]="FSharp",i[i.CSharp=7]="CSharp",i),Ee=((t={})[t.Major=0]="Major",t[t.Minor=1]="Minor",t),Le=((s={})[s.Down=0]="Down",s[s.Hold=1]="Hold",s[s.Up=2]="Up",s),Ce=class{constructor(){this.ratioPosition=0,this.pedalType=0,this.nextPedalMarker=null,this.previousPedalMarker=null}},Fe=((x={})[x.StandardNotationRepeats=0]="StandardNotationRepeats",x[x.GuitarTabsRepeats=1]="GuitarTabsRepeats",x[x.SlashRepeats=2]="SlashRepeats",x[x.NumberedRepeats=3]="NumberedRepeats",x[x.StandardNotationBarNumber=4]="StandardNotationBarNumber",x[x.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",x[x.SlashBarNumber=6]="SlashBarNumber",x[x.NumberedBarNumber=7]="NumberedBarNumber",x[x.StandardNotationBarLines=8]="StandardNotationBarLines",x[x.GuitarTabsBarLines=9]="GuitarTabsBarLines",x[x.SlashBarLines=10]="SlashBarLines",x[x.NumberedBarLines=11]="NumberedBarLines",x[x.StandardNotationClef=12]="StandardNotationClef",x[x.GuitarTabsClef=13]="GuitarTabsClef",x[x.StandardNotationKeySignature=14]="StandardNotationKeySignature",x[x.NumberedKeySignature=15]="NumberedKeySignature",x[x.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",x[x.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",x[x.SlashTimeSignature=18]="SlashTimeSignature",x[x.NumberedTimeSignature=19]="NumberedTimeSignature",x[x.StandardNotationStaffLine=20]="StandardNotationStaffLine",x[x.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",x[x.SlashStaffLine=22]="SlashStaffLine",x[x.NumberedStaffLine=23]="NumberedStaffLine",x),De=class extends xe{},Ie=((a={})[a.Automatic=0]="Automatic",a[a.Dashed=1]="Dashed",a[a.Dotted=2]="Dotted",a[a.Heavy=3]="Heavy",a[a.HeavyHeavy=4]="HeavyHeavy",a[a.HeavyLight=5]="HeavyLight",a[a.LightHeavy=6]="LightHeavy",a[a.LightLight=7]="LightLight",a[a.None=8]="None",a[a.Regular=9]="Regular",a[a.Short=10]="Short",a[a.Tick=11]="Tick",a),n=class n{constructor(){this.id=n._globalBarId++,this.index=0,this.nextBar=null,this.previousBar=null,this.clef=4,this.clefOttava=2,this.voices=[],this.simileMark=0,this._filledVoices=new Set([0]),this.displayScale=1,this.displayWidth=-1,this.sustainPedals=[],this._isEmpty=!0,this._isRestOnly=!0,this.barLineLeft=0,this.barLineRight=0,this.keySignature=0,this.keySignatureType=0}static resetIds(){n._globalBarId=0}get isMultiVoice(){return 1<this._filledVoices.size}get filledVoices(){return this._filledVoices}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){return this._isEmpty}get hasChanges(){return 0===this.index||this.keySignature!==this.previousBar.keySignature||this.keySignatureType!==this.previousBar.keySignatureType||this.clef!==this.previousBar.clef||this.clefOttava!==this.previousBar.clefOttava||0!==this.simileMark||0<this.sustainPedals.length||0!==this.barLineLeft||0!==this.barLineRight}get isRestOnly(){return this._isRestOnly}getActualBarLineLeft(e){return n._actualBarLine(this,!1,e)}getActualBarLineRight(){return n._actualBarLine(this,!0,!1)}static _automaticToActualType(e,t,s){let i;return i=t?!e.isRepeatEnd&&e.nextMasterBar?e.isFreeTime?1:e.isDoubleBar?7:9:6:e.isRepeatStart?5:s?9:8}static _actualBarLine(e,t,s){let i=e.masterBar,a=t?e.barLineRight:e.barLineLeft,r;return r=0===a?n._automaticToActualType(i,t,s):a}addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(s,i=null){this._filledVoices.clear(),this._filledVoices.add(0),this._isEmpty=!0,this._isRestOnly=!0;for(let e=0,t=this.voices.length;e<t;e++){var a=this.voices[e];a.finish(s,i),a.isEmpty||(this._isEmpty=!1,this._filledVoices.add(e)),a.isRestOnly||(this._isRestOnly=!1)}var e,t=this.sustainPedals;if(0<t.length){let e=null;this.sustainPedals=[];var r,n=null!==(e=this.previousBar&&0<this.previousBar.sustainPedals.length&&2===(e=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1]).pedalType?null:e)&&2!==e.pedalType;for(r of t){if(e&&2!==e.pedalType){if(e.bar===this&&r.ratioPosition<=e.ratioPosition)continue;(e.nextPedalMarker=r).previousPedalMarker=e}n&&0===r.pedalType&&(r.pedalType=1),(r.bar=this).sustainPedals.push(r),e=r}}else this.previousBar&&0<this.previousBar.sustainPedals.length&&2!==(t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1]).pedalType&&((e=new Ce).ratioPosition=0,e.bar=this,e.pedalType=1,this.sustainPedals.push(e),(t.nextPedalMarker=e).previousPedalMarker=t)}calculateDuration(){let e=0;for(var t of this.voices){t=t.calculateDuration();t>e&&(e=t)}return e}},Ae=(n._globalBarId=0,n),Re=class{constructor(){this.beats=[],this.id="empty",this.isComplete=!1}addBeat(e){e.graceIndex=this.beats.length,(e.graceGroup=this).beats.push(e)}finish(){0<this.beats.length&&(this.id=this.beats[0].absoluteDisplayStart+"_"+this.beats[0].voice.index)}},Oe=((r={})[r.Glyphs=0]="Glyphs",r),Ve=class extends xe{},e=class e{constructor(){this._isEmpty=!0,this._isRestOnly=!0,this.id=e._globalVoiceId++,this.index=0,this.beats=[]}static resetIds(){e._globalVoiceId=0}get isEmpty(){return this._isEmpty}forceNonEmpty(){this._isEmpty=!1}get isRestOnly(){return this._isRestOnly}insertBeat(e,t){t.nextBeat=e.nextBeat,t.nextBeat&&(t.nextBeat.previousBeat=t),t.previousBeat=e,t.voice=this,e.nextBeat=t,this.beats.splice(e.index+1,0,t)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this._isEmpty=!1),e.isRest||(this._isRestOnly=!1)}_chain(e,t=null){var s;this.bar&&(e.index<this.beats.length-1?(e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e):e.isLastOfVoice&&e.voice.bar.nextBar&&(0<(s=this.bar.nextBar.voices[this.index]).beats.length&&(e.nextBeat=s.beats[0]),e.nextBeat.previousBeat=e),e.chain(t))}addGraceBeat(e){var t;0===this.beats.length?this.addBeat(e):(t=this.beats[this.beats.length-1],this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(t),this._isEmpty=!1,this._isRestOnly=!1)}getBeatAtPlaybackStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(t,s=null){this._isEmpty=!0,this._isRestOnly=!0,this._beatLookup=new Map;let i=null;for(let e=0;e<this.beats.length;e++){var a=this.beats[e];a.index=e,this._chain(a,s),0===a.graceType?((a.graceGroup=i)&&(i.isComplete=!0),i=null):(i=i||new Re).addBeat(a),a.isEmpty||(this._isEmpty=!1),a.isRest||(this._isRestOnly=!1)}let r=0,n=0;for(let e=0;e<this.beats.length;e++){var o=this.beats[e];if(o.index=e,o.finish(t,s),0===o.graceType){if(o.graceGroup){var h=o.graceGroup.beats[0],l=o.graceGroup.beats[o.graceGroup.beats.length-1];if(3!==h.graceType){var d=l.playbackStart+l.playbackDuration-h.playbackStart;switch(h.graceType){case 2:n=h.previousBeat&&(h.previousBeat.playbackDuration-=d,h.previousBeat.voice===this)?h.previousBeat.playbackStart+h.previousBeat.playbackDuration:-d;for(var c of o.graceGroup.beats)this._beatLookup.delete(c.playbackStart),c.playbackStart=n,this._beatLookup.set(c.playbackStart,o),n+=c.playbackDuration;break;case 1:o.playbackDuration-=d,n=l.voice===this?l.playbackStart+l.playbackDuration:-d}}}o.displayStart=r,o.playbackStart=n,this._beatLookup.set(o.playbackStart,o)}else o.displayStart=r,o.playbackStart=n;o.fermata?this.bar.masterBar.addFermata(o.playbackStart,o.fermata):o.fermata=this.bar.masterBar.getFermata(o),o.finishTuplet(),o.graceGroup&&o.graceGroup.finish(),r+=o.displayDuration,n+=o.playbackDuration}}calculateDuration(){var e,t;return this.isEmpty||0===this.beats.length?0:(e=this.beats[this.beats.length-1],t=this.beats[0],e.playbackStart+e.playbackDuration-t.playbackStart)}},We=(e._globalVoiceId=0,e),He=((i={})[i.Left=0]="Left",i[i.Center=1]="Center",i[i.Right=2]="Right",i),Ge=((t={})[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Bottom=2]="Bottom",t[t.Alphabetic=3]="Alphabetic",t),ze=class{constructor(e,t){this.width=e,this.height=t}},Ue=class{static fillMusicFontSymbolSafe(e,t,s,i,a,r){e.settings.display.resources.engravingSettings.hasSymbol(a)&&e.fillMusicFontSymbol(t,s,i,a,r)}static fillMusicFontSymbolsSafe(t,e,s,i,a,r){a=a.filter(e=>t.settings.display.resources.engravingSettings.hasSymbol(e));0!==a.length&&t.fillMusicFontSymbols(e,s,i,a,r)}},Ye=((s={})[s.Title=0]="Title",s[s.SubTitle=1]="SubTitle",s[s.Artist=2]="Artist",s[s.Album=3]="Album",s[s.Words=4]="Words",s[s.Music=5]="Music",s[s.WordsAndMusic=6]="WordsAndMusic",s[s.Transcriber=7]="Transcriber",s[s.Copyright=8]="Copyright",s[s.CopyrightSecondLine=9]="CopyrightSecondLine",s[s.ChordDiagramList=10]="ChordDiagramList",s),o=class o{constructor(e="",t=void 0,s=0){this.template=e,this.isVisible=t,this.textAlign=s}static equals(e,t){return!((void 0===e.isVisible||e.isVisible)!==(void 0===t.isVisible||t.isVisible)||e.template!==t.template||e.textAlign!==t.textAlign)}buildText(i){let a=!1,r=!1,e=this.template.replace(o._placeholderPattern,(e,t)=>{r=!0;let s="";switch(t){case"TITLE":s=i.title;break;case"SUBTITLE":s=i.subTitle;break;case"ARTIST":s=i.artist;break;case"ALBUM":s=i.album;break;case"WORDS":case"WORDSMUSIC":s=i.words;break;case"MUSIC":s=i.music;break;case"TABBER":s=i.tab;break;case"COPYRIGHT":s=i.copyright;break;default:s=""}return s&&(a=!0),s});return r&&!a?"":e}},Xe=(o._placeholderPattern=/%([^%]+)%/g,o),Je=class extends xe{constructor(){super(...arguments),this.headerAndFooter=new Map}},qe=(Je.defaultHeaderAndFooter=new Map([[0,new Xe("%TITLE%",void 0,1)],[1,new Xe("%SUBTITLE%",void 0,1)],[2,new Xe("%ARTIST%",void 0,1)],[3,new Xe("%ALBUM%",void 0,1)],[4,new Xe("Words by %WORDS%",void 0,0)],[5,new Xe("Music by %MUSIC%",void 0,2)],[6,new Xe("Words & Music by %MUSIC%",void 0,2)],[7,new Xe("Tabbed by %TABBER%",!1,2)],[8,new Xe("%COPYRIGHT%",void 0,1)],[9,new Xe("All Rights Reserved - International Copyright Secured",!0,1)]]),class{constructor(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0,this.album="",this.artist="",this.copyright="",this.instructions="",this.music="",this.notices="",this.subTitle="",this.title="",this.words="",this.tab="",this.masterBars=[],this.tracks=[],this.defaultSystemsLayout=3,this.systemsLayout=[],this.stylesheet=new Te}static resetIds(){Ae.resetIds(),wt.resetIds(),We.resetIds(),dt.resetIds()}get tempo(){return this.masterBars.length&&0<this.masterBars[0].tempoAutomations.length?this.masterBars[0].tempoAutomations[0].value:120}get tempoLabel(){return this.masterBars.length&&0<this.masterBars[0].tempoAutomations.length?this.masterBars[0].tempoAutomations[0].text:""}rebuildRepeatGroups(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0;for(var e of this.masterBars)this._addMasterBarToRepeatGroups(e)}addMasterBar(e){e.score=this,e.index=this.masterBars.length,0!==this.masterBars.length&&(e.previousMasterBar=this.masterBars[this.masterBars.length-1],(e.previousMasterBar.nextMasterBar=e).start=e.previousMasterBar.start+(e.previousMasterBar.isAnacrusis?0:e.previousMasterBar.calculateDuration())),this._addMasterBarToRepeatGroups(e),this.masterBars.push(e)}_addMasterBarToRepeatGroups(e){e.isRepeatStart?(this._currentRepeatGroup?.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new Be,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new Be,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(e),e.isRepeatEnd&&1<this._properlyOpenedRepeatGroups&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=0<this._openedRepeatGroups.length?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(e){e.score=this,e.index=this.tracks.length,this.tracks.push(e)}finish(s){var i=new Map;for(let e=0,t=this.tracks.length;e<t;e++)this.tracks[e].finish(s,i)}applyFlatSyncPoints(e){for(var t of this.masterBars)t.syncPoints=void 0;for(var s of e){var i=new K;i.ratioPosition=Math.min(1,Math.max(0,s.barPosition)),i.type=4,i.syncPointValue=new $,i.syncPointValue.millisecondOffset=s.millisecondOffset,i.syncPointValue.barOccurence=s.barOccurence,s.barIndex<this.masterBars.length&&this.masterBars[s.barIndex].addSyncPoint(i)}for(var a of this.masterBars)a.syncPoints&&a.syncPoints.sort((e,t)=>{var s=e.syncPointValue.barOccurence-t.syncPointValue.barOccurence;return 0!=s?s:e.ratioPosition-t.ratioPosition})}exportFlatSyncPoints(){var e,t=[];for(e of this.masterBars){var s=e.syncPoints;if(s)for(var i of s)t.push({barIndex:e.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return t}}),je=((x={})[x.NoTripletFeel=0]="NoTripletFeel",x[x.Triplet16th=1]="Triplet16th",x[x.Triplet8th=2]="Triplet8th",x[x.Dotted16th=3]="Dotted16th",x[x.Dotted8th=4]="Dotted8th",x[x.Scottish16th=5]="Scottish16th",x[x.Scottish8th=6]="Scottish8th",x),$e=class{constructor(){this.alternateEndings=0,this.nextMasterBar=null,this.previousMasterBar=null,this.index=0,this.isDoubleBar=!1,this.isRepeatStart=!1,this.repeatCount=0,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.timeSignatureCommon=!1,this.isFreeTime=!1,this.tripletFeel=0,this.section=null,this.tempoAutomations=[],this.fermata=null,this.start=0,this.isAnacrusis=!1,this.displayScale=1,this.displayWidth=-1,this.directions=null}get hasChanges(){return 0!==this.index&&(this.timeSignatureCommon!==this.previousMasterBar.timeSignatureCommon||this.timeSignatureNumerator!==this.previousMasterBar.timeSignatureNumerator||this.timeSignatureDenominator!==this.previousMasterBar.timeSignatureDenominator||this.tripletFeel!==this.previousMasterBar.tripletFeel||0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||0<this.tempoAutomations.length||this.syncPoints&&0<this.syncPoints.length||null!==this.fermata&&0<this.fermata.size||null!==this.directions&&0<this.directions.size||this.isAnacrusis)}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(e){this.score.tracks[0].staves[0].bars[this.index].keySignature=e}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(e){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=e}get isRepeatEnd(){return 0<this.repeatCount}get isSectionStart(){return!!this.section}get tempoAutomation(){return 0<this.tempoAutomations.length?this.tempoAutomations[0]:null}calculateDuration(e=!0){if(this.isAnacrusis&&e){let e=0;for(var t of this.score.tracks)for(var s of t.staves){s=this.index<s.bars.length?s.bars[this.index].calculateDuration():0;s>e&&(e=s)}return e}return this.timeSignatureNumerator*N.valueToTicks(this.timeSignatureDenominator)}addFermata(e,t){let s=this.fermata;null===s&&(s=new Map,this.fermata=s),s.set(e,t)}addDirection(e){null==this.directions&&(this.directions=new Set),this.directions.add(e)}getFermata(e){var t=this.fermata;return null===t?null:t.has(e.playbackStart)?t.get(e.playbackStart):0===e.index&&t.has(0)?t.get(0):null}addSyncPoint(e){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(e)}},Ke=($e.MaxAlternateEndings=8,class{}),_=(Ke.DefaultChannelCount=17,Ke.MetronomeChannel=Ke.DefaultChannelCount-1,Ke.MetronomeKey=33,Ke.AudioChannels=2,Ke.MinVolume=0,Ke.MinProgram=0,Ke.MaxProgram=127,Ke.MinPlaybackSpeed=.125,Ke.MaxPlaybackSpeed=8,Ke.PercussionChannel=9,Ke.PercussionBank=128,Ke.MaxPitchWheel=16384,Ke.MaxPitchWheel20=4294967296,Ke.DefaultPitchWheel=Ke.MaxPitchWheel/2,Ke.MicroBufferCount=32,Ke.MicroBufferSize=64,Ke),Qe=((a={})[a.None=-1]="None",a[a.Space=32]="Space",a[a.Brace=57344]="Brace",a[a.BracketTop=57347]="BracketTop",a[a.BracketBottom=57348]="BracketBottom",a[a.SystemDivider=57351]="SystemDivider",a[a.GClef=57424]="GClef",a[a.GClef15mb=57425]="GClef15mb",a[a.GClef8vb=57426]="GClef8vb",a[a.GClef8va=57427]="GClef8va",a[a.GClef15ma=57428]="GClef15ma",a[a.CClef=57436]="CClef",a[a.CClef8vb=57437]="CClef8vb",a[a.FClef=57442]="FClef",a[a.FClef15mb=57443]="FClef15mb",a[a.FClef8vb=57444]="FClef8vb",a[a.FClef8va=57445]="FClef8va",a[a.FClef15ma=57446]="FClef15ma",a[a.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",a[a.SixStringTabClef=57453]="SixStringTabClef",a[a.FourStringTabClef=57454]="FourStringTabClef",a[a.Clef8=57469]="Clef8",a[a.Clef15=57470]="Clef15",a[a.TimeSig0=57472]="TimeSig0",a[a.TimeSig1=57473]="TimeSig1",a[a.TimeSig2=57474]="TimeSig2",a[a.TimeSig3=57475]="TimeSig3",a[a.TimeSig4=57476]="TimeSig4",a[a.TimeSig5=57477]="TimeSig5",a[a.TimeSig6=57478]="TimeSig6",a[a.TimeSig7=57479]="TimeSig7",a[a.TimeSig8=57480]="TimeSig8",a[a.TimeSig9=57481]="TimeSig9",a[a.TimeSigCommon=57482]="TimeSigCommon",a[a.TimeSigCutCommon=57483]="TimeSigCutCommon",a[a.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",a[a.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",a[a.NoteheadWhole=57506]="NoteheadWhole",a[a.NoteheadHalf=57507]="NoteheadHalf",a[a.NoteheadBlack=57508]="NoteheadBlack",a[a.NoteheadNull=57509]="NoteheadNull",a[a.NoteheadXOrnate=57514]="NoteheadXOrnate",a[a.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",a[a.NoteheadPlusWhole=57517]="NoteheadPlusWhole",a[a.NoteheadPlusHalf=57518]="NoteheadPlusHalf",a[a.NoteheadPlusBlack=57519]="NoteheadPlusBlack",a[a.NoteheadSquareWhite=57528]="NoteheadSquareWhite",a[a.NoteheadSquareBlack=57529]="NoteheadSquareBlack",a[a.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",a[a.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",a[a.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",a[a.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",a[a.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",a[a.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",a[a.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",a[a.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",a[a.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",a[a.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",a[a.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",a[a.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",a[a.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",a[a.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",a[a.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",a[a.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",a[a.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",a[a.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",a[a.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",a[a.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",a[a.NoteheadCircleX=57523]="NoteheadCircleX",a[a.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",a[a.NoteheadXWhole=57511]="NoteheadXWhole",a[a.NoteheadXHalf=57512]="NoteheadXHalf",a[a.NoteheadXBlack=57513]="NoteheadXBlack",a[a.NoteheadParenthesis=57550]="NoteheadParenthesis",a[a.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",a[a.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",a[a.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",a[a.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",a[a.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",a[a.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",a[a.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",a[a.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",a[a.NoteheadCircledBlack=57572]="NoteheadCircledBlack",a[a.NoteheadCircledHalf=57573]="NoteheadCircledHalf",a[a.NoteheadCircledWhole=57574]="NoteheadCircledWhole",a[a.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",a[a.NoteheadCircleSlash=57591]="NoteheadCircleSlash",a[a.NoteheadHeavyX=57592]="NoteheadHeavyX",a[a.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",a[a.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",a[a.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",a[a.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",a[a.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",a[a.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",a[a.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",a[a.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",a[a.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",a[a.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",a[a.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",a[a.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",a[a.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",a[a.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",a[a.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",a[a.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",a[a.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",a[a.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",a[a.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",a[a.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",a[a.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",a[a.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",a[a.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",a[a.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",a[a.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",a[a.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",a[a.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",a[a.NoteQuarterUp=57813]="NoteQuarterUp",a[a.Note8thUp=57815]="Note8thUp",a[a.MetNoteQuarterUp=60581]="MetNoteQuarterUp",a[a.MetNote8thUp=60583]="MetNote8thUp",a[a.MetAugmentationDot=60599]="MetAugmentationDot",a[a.ArrowheadBlackUp=60280]="ArrowheadBlackUp",a[a.ArrowheadBlackDown=60284]="ArrowheadBlackDown",a[a.AugmentationDot=57831]="AugmentationDot",a[a.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",a[a.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",a[a.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",a[a.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",a[a.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",a[a.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",a[a.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",a[a.TextAugmentationDot=57852]="TextAugmentationDot",a[a.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",a[a.TextTuplet3LongStem=57858]="TextTuplet3LongStem",a[a.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",a[a.Tremolo3=57890]="Tremolo3",a[a.Tremolo2=57889]="Tremolo2",a[a.Tremolo1=57888]="Tremolo1",a[a.Flag8thUp=57920]="Flag8thUp",a[a.Flag8thDown=57921]="Flag8thDown",a[a.Flag16thUp=57922]="Flag16thUp",a[a.Flag16thDown=57923]="Flag16thDown",a[a.Flag32ndUp=57924]="Flag32ndUp",a[a.Flag32ndDown=57925]="Flag32ndDown",a[a.Flag64thUp=57926]="Flag64thUp",a[a.Flag64thDown=57927]="Flag64thDown",a[a.Flag128thUp=57928]="Flag128thUp",a[a.Flag128thDown=57929]="Flag128thDown",a[a.Flag256thUp=57930]="Flag256thUp",a[a.Flag256thDown=57931]="Flag256thDown",a[a.AccidentalFlat=57952]="AccidentalFlat",a[a.AccidentalNatural=57953]="AccidentalNatural",a[a.AccidentalSharp=57954]="AccidentalSharp",a[a.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",a[a.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",a[a.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",a[a.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",a[a.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",a[a.RepeatDot=57412]="RepeatDot",a[a.Segno=57415]="Segno",a[a.Coda=57416]="Coda",a[a.ArticAccentAbove=58528]="ArticAccentAbove",a[a.ArticAccentBelow=58529]="ArticAccentBelow",a[a.ArticStaccatoAbove=58530]="ArticStaccatoAbove",a[a.ArticStaccatoBelow=58531]="ArticStaccatoBelow",a[a.ArticTenutoAbove=58532]="ArticTenutoAbove",a[a.ArticTenutoBelow=58533]="ArticTenutoBelow",a[a.ArticMarcatoAbove=58540]="ArticMarcatoAbove",a[a.ArticMarcatoBelow=58541]="ArticMarcatoBelow",a[a.FermataAbove=58560]="FermataAbove",a[a.FermataShortAbove=58564]="FermataShortAbove",a[a.FermataLongAbove=58566]="FermataLongAbove",a[a.RestLonga=58593]="RestLonga",a[a.RestDoubleWhole=58594]="RestDoubleWhole",a[a.RestWhole=58595]="RestWhole",a[a.RestHalf=58596]="RestHalf",a[a.RestQuarter=58597]="RestQuarter",a[a.Rest8th=58598]="Rest8th",a[a.Rest16th=58599]="Rest16th",a[a.Rest32nd=58600]="Rest32nd",a[a.Rest64th=58601]="Rest64th",a[a.Rest128th=58602]="Rest128th",a[a.Rest256th=58603]="Rest256th",a[a.RestHBarLeft=58607]="RestHBarLeft",a[a.RestHBarMiddle=58608]="RestHBarMiddle",a[a.RestHBarRight=58609]="RestHBarRight",a[a.Repeat1Bar=58624]="Repeat1Bar",a[a.Repeat2Bars=58625]="Repeat2Bars",a[a.Ottava=58640]="Ottava",a[a.OttavaAlta=58641]="OttavaAlta",a[a.OttavaBassaVb=58652]="OttavaBassaVb",a[a.Quindicesima=58644]="Quindicesima",a[a.QuindicesimaAlta=58645]="QuindicesimaAlta",a[a.DynamicPPPPPP=58663]="DynamicPPPPPP",a[a.DynamicPPPPP=58664]="DynamicPPPPP",a[a.DynamicPPPP=58665]="DynamicPPPP",a[a.DynamicPPP=58666]="DynamicPPP",a[a.DynamicPP=58667]="DynamicPP",a[a.DynamicPiano=58656]="DynamicPiano",a[a.DynamicMP=58668]="DynamicMP",a[a.DynamicMF=58669]="DynamicMF",a[a.DynamicPF=58670]="DynamicPF",a[a.DynamicForte=58658]="DynamicForte",a[a.DynamicFF=58671]="DynamicFF",a[a.DynamicFFF=58672]="DynamicFFF",a[a.DynamicFFFF=58673]="DynamicFFFF",a[a.DynamicFFFFF=58674]="DynamicFFFFF",a[a.DynamicFFFFFF=58675]="DynamicFFFFFF",a[a.DynamicFortePiano=58676]="DynamicFortePiano",a[a.DynamicNiente=58662]="DynamicNiente",a[a.DynamicSforzando1=58678]="DynamicSforzando1",a[a.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",a[a.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",a[a.DynamicSforzato=58681]="DynamicSforzato",a[a.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",a[a.DynamicSforzatoFF=58683]="DynamicSforzatoFF",a[a.DynamicRinforzando1=58684]="DynamicRinforzando1",a[a.DynamicRinforzando2=58685]="DynamicRinforzando2",a[a.DynamicForzando=58677]="DynamicForzando",a[a.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",a[a.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",a[a.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",a[a.OrnamentTrill=58726]="OrnamentTrill",a[a.OrnamentTurn=58727]="OrnamentTurn",a[a.OrnamentTurnInverted=58728]="OrnamentTurnInverted",a[a.OrnamentShortTrill=58732]="OrnamentShortTrill",a[a.OrnamentMordent=58733]="OrnamentMordent",a[a.StringsDownBow=58896]="StringsDownBow",a[a.StringsUpBow=58898]="StringsUpBow",a[a.KeyboardPedalPed=58960]="KeyboardPedalPed",a[a.KeyboardPedalUp=58965]="KeyboardPedalUp",a[a.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",a[a.GuitarString0=59443]="GuitarString0",a[a.GuitarString1=59444]="GuitarString1",a[a.GuitarString2=59445]="GuitarString2",a[a.GuitarString3=59446]="GuitarString3",a[a.GuitarString4=59447]="GuitarString4",a[a.GuitarString5=59448]="GuitarString5",a[a.GuitarString6=59449]="GuitarString6",a[a.GuitarString7=59450]="GuitarString7",a[a.GuitarString8=59451]="GuitarString8",a[a.GuitarString9=59452]="GuitarString9",a[a.GuitarOpenPedal=59453]="GuitarOpenPedal",a[a.GuitarClosePedal=59455]="GuitarClosePedal",a[a.GuitarGolpe=59458]="GuitarGolpe",a[a.GuitarFadeIn=59459]="GuitarFadeIn",a[a.GuitarFadeOut=59460]="GuitarFadeOut",a[a.GuitarVolumeSwell=59461]="GuitarVolumeSwell",a[a.FretboardFilledCircle=59480]="FretboardFilledCircle",a[a.FretboardX=59481]="FretboardX",a[a.FretboardO=59482]="FretboardO",a[a.Tuplet0=59520]="Tuplet0",a[a.Tuplet1=59521]="Tuplet1",a[a.Tuplet2=59522]="Tuplet2",a[a.Tuplet3=59523]="Tuplet3",a[a.Tuplet4=59524]="Tuplet4",a[a.Tuplet5=59525]="Tuplet5",a[a.Tuplet6=59526]="Tuplet6",a[a.Tuplet7=59527]="Tuplet7",a[a.Tuplet8=59528]="Tuplet8",a[a.Tuplet9=59529]="Tuplet9",a[a.TupletColon=59530]="TupletColon",a[a.WiggleTrill=60068]="WiggleTrill",a[a.GuitarVibratoStroke=60082]="GuitarVibratoStroke",a[a.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",a[a.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",a[a.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",a[a.WiggleSawtooth=60091]="WiggleSawtooth",a[a.OctaveBaselineM=60565]="OctaveBaselineM",a[a.OctaveBaselineB=60563]="OctaveBaselineB",a[a.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",a[a.Fingering0=60688]="Fingering0",a[a.Fingering1=60689]="Fingering1",a[a.Fingering2=60690]="Fingering2",a[a.Fingering3=60691]="Fingering3",a[a.Fingering4=60692]="Fingering4",a[a.Fingering5=60693]="Fingering5",a[a.FingeringPLower=60695]="FingeringPLower",a[a.FingeringTLower=60696]="FingeringTLower",a[a.FingeringILower=60697]="FingeringILower",a[a.FingeringMLower=60698]="FingeringMLower",a[a.FingeringALower=60699]="FingeringALower",a[a.FingeringCLower=60700]="FingeringCLower",a),Ze=((n={})[n.None=0]="None",n[n.Natural=1]="Natural",n[n.Sharp=2]="Sharp",n[n.Flat=3]="Flat",n[n.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",n[n.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",n[n.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",n[n.DoubleSharp=7]="DoubleSharp",n[n.DoubleFlat=8]="DoubleFlat",n),et=class{constructor(){this.note=null,this.tone=new tt,this.octave=0}get realValue(){return 12*this.octave+this.tone.noteValue}},tt=class{constructor(e=0,t=0){this.noteValue=e,this.accidentalMode=t}},st=class st{static getIndex(e){return 0|Math.log2(Math.abs(e))}static keySignatureIsFlat(e){return e<0}static keySignatureIsNatural(e){return 0===e}static keySignatureIsSharp(e){return 0<e}static applyPitchOffsets(t,s){for(let e=0;e<s.tracks.length;e++){if(e<t.notation.displayTranspositionPitches.length)for(var i of s.tracks[e].staves)i.displayTranspositionPitch=-t.notation.displayTranspositionPitches[e];if(e<t.notation.transpositionPitches.length)for(var a of s.tracks[e].staves)a.transpositionPitch=-t.notation.transpositionPitches[e]}}static isTuning(e){return!!st.parseTuning(e)}static parseTuning(t){let s="",i="";for(let e=0;e<t.length;e++){var a=t.charCodeAt(e);if(48<=a&&a<=57){if(!s)return null;i+=String.fromCharCode(a)}else{if(0===s.length&&!st.tuningLetters.has(a))return null;s+=String.fromCharCode(a)}}var e,r;return!i||!s||((e=new et).octave=Number.parseInt(i,10)+1,e.note=s.toLowerCase(),null===(r=st.getToneForText(e.note)))?null:(e.tone=r,e.tone.noteValue<0&&(e.octave--,e.tone.noteValue+=12),e)}static getTuningForText(e){e=st.parseTuning(e);return e?e.realValue:-1}static getToneForText(e){let t=e.substring(0,1),s=e.substring(1),i,a;switch(t.toLowerCase()){case"c":i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11;break;default:return null}if(!st.accidentalModeMapping.has(s))return null;switch(a=st.parseAccidentalMode(s)){case 0:case 1:case 2:break;case 3:i++;break;case 4:i+=2;break;case 5:i--;break;case 6:i-=2}return new tt(i,a)}static parseAccidentalMode(e){e=e.toLowerCase();return st.accidentalModeMapping.has(e)?st.accidentalModeMapping.get(e):0}static newGuid(){return`${Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-`+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}static isAlmostEqualTo(e,t){return Math.abs(e-t)<1e-5}static toHexString(e,t=0){let s="";for(;s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&e))+s,0<(e>>=4););for(;s.length<t;)s="0"+s;return s}static getAlternateEndingsList(t){var s=[];for(let e=0;e<$e.MaxAlternateEndings;e++)0!=(t&1<<e)&&s.push(e);return s}static deltaFretToHarmonicValue(e){switch(e){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return e;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(e,t,s){return e<=t?t:s<=e?s:e}static buildMultiBarRestInfo(r,n,e){if(!r)return null;var t=r[0].score.stylesheet;if(!(1<r.length?t.multiTrackMultiBarRest:!0===t.perTrackMultiBarRest?.has(r[0].index)))return null;let s=new Map,o=r[0].score,h=n,l=o.tempo;for(;h<=e;){let i=h,a=null;for(;h<=e;){let e=o.masterBars[h],t=!1;for(var d of e.tempoAutomations)d.value!==l&&(t=!0),l=d.value;if(e.alternateEndings||e.isRepeatStart&&e.index!==i||e.isFreeTime||e.isAnacrusis||null!==e.section||e.index!==i&&t||null!==e.fermata&&0<e.fermata.size||null!==e.directions&&0<e.directions.size||n<i&&e.previousMasterBar&&(e.timeSignatureCommon!==e.previousMasterBar.timeSignatureCommon||e.timeSignatureNumerator!==e.previousMasterBar.timeSignatureNumerator||e.timeSignatureDenominator!==e.previousMasterBar.timeSignatureDenominator||e.tripletFeel!==e.previousMasterBar.tripletFeel))break;let s=!0;for(var c of r){for(var u of c.staves){u=u.bars[e.index];if(!u.isRestOnly){s=!1;break}if(0<u.index&&(u.keySignature!==u.previousBar.keySignature||u.keySignatureType!==u.previousBar.keySignatureType)){s=!1;break}}if(!s)break}if(!s||(h++,e.index>i&&(null===a?a=[e.index]:a.push(e.index)),e.isRepeatEnd))break}a?s.set(i,a):h++}return s}static computeFirstDisplayedBarIndex(e,t){t=t.display.startBar;return t--,Math.min(e.masterBars.length-1,Math.max(0,t))}static computeLastDisplayedBarIndex(e,t,s){let i=t.display.barCount;return i=s+(i=i<0?e.masterBars.length:i)-1,i=Math.min(e.masterBars.length-1,Math.max(0,i))}static getOrCreateHeaderFooterStyle(e,t){let s=e.style;e.style||(s=new Je,e.style=s);let i;return s.headerAndFooter.has(t)?i=s.headerAndFooter.get(t):(i=new Xe,Je.defaultHeaderAndFooter.has(t)&&(e=Je.defaultHeaderAndFooter.get(t),i.template=e.template,i.textAlign=e.textAlign),s.headerAndFooter.set(t,i)),i}static consolidate(e){var t;if(0===e.masterBars.length)t=new $e,e.addMasterBar(t),(a=new K).isLinear=!1,a.type=0,a.value=e.tempo,t.tempoAutomations.push(a),t=new Ae,e.tracks[0].staves[0].addBar(t),a=new We,t.addVoice(a),(t=new wt).isEmpty=!0,a.addBeat(t);else{var s,i,a,r=new Set([_.PercussionChannel]);for(s of e.tracks){if(1===s.staves.length&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=_.PercussionChannel,s.playbackInfo.secondaryChannel=_.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==_.PercussionChannel)for(;r.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(r.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==_.PercussionChannel)for(;r.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;r.add(s.playbackInfo.secondaryChannel)}for(var n of s.staves){for(var o of n.bars)for(var h of o.voices)h.isEmpty&&0===h.beats.length&&((i=new wt).isEmpty=!0,h.addBeat(i));for(var l=0===n.bars.length?1:n.bars[0].voices.length;n.bars.length<e.masterBars.length;){var d=new Ae,c=(n.addBar(d),d.previousBar);c&&(d.clef=c.clef,d.clefOttava=c.clefOttava,d.keySignature=d.previousBar.keySignature,d.keySignatureType=d.previousBar.keySignatureType);for(let e=0;e<l;e++){var u=new We,p=(d.addVoice(u),new wt);p.isEmpty=!0,u.addBeat(p)}}}}0<e.masterBars.length&&!e.masterBars[0].tempoAutomations.find(e=>0===e.type&&0===e.ratioPosition)&&((a=new K).isLinear=!1,a.type=0,a.value=e.tempo,a.text=e.tempoLabel,a.isVisible=!1,e.masterBars[0].tempoAutomations.push(a))}}static trimEmptyBarsAtEnd(e){for(;1<e.masterBars.length;){var t,s,i,a=e.masterBars.length-1,r=e.masterBars[a];if(r.hasChanges)return;for(t of e.tracks)for(var n of t.staves)if(a<n.bars.length){n=n.bars[a];if(!n.isEmpty||n.hasChanges)return}for(s of e.tracks)for(var o of s.staves)a<o.bars.length&&(i=o.bars[a],o.bars.pop(),i.previousBar.nextBar=null);e.masterBars.pop(),r.previousMasterBar.nextMasterBar=null}}static getAllMusicFontSymbols(){return 0===st._allMusicFontSymbols.length&&(st._allMusicFontSymbols=Object.values(Qe).filter(e=>"number"==typeof e).map(e=>e)),st._allMusicFontSymbols}static flooredDivision(e,t){return e-t*Math.floor(e/t)}static _translateKeyTransposeTable(e){var t,s=[];for(t of e){var i,a=[];s.push(a);for(i of t){var r=Number.parseInt(i.charAt(0),10)*("b"===i.charAt(1)?-1:1);a.push(r)}}return s}static transposeKey(e,t){var s;return 0===t?e:t<0?-1===(s=st._keyTransposeTable[-t].indexOf(e))?e:s-7:st._keyTransposeTable[t][e+7]}static computeAccidental(e,t,s,i,a=null){let r=e+7,n=s%12,o=r<7?3:2,h=st._keySignatureLookup[r][n],l=st.accidentalNotes[n],d=0;if(i)switch(d=l?o:1,d){case 1:d=4;break;case 2:d=5;break;case 3:d=6}else{switch(t){case 3:d=2;break;case 4:d=7;break;case 5:d=3;break;case 6:d=8;break;default:l?d=o:h&&(d=1)}0!==d?null!=a?a===d&&(d=0):h&&d===o&&(d=0):null!==a&&(d=1===a?0:1)}return d}static toArticulationId(e){return e.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}},F=(st.tuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]),st.reverseAccidentalModeMapping=new Map([[0,"d"],[1,"forcenone"],[2,"forcenatural"],[3,"#"],[4,"x"],[5,"b"],[6,"bb"]]),st.accidentalModeMapping=new Map([["default",0],["d",0],["",0],["forcenone",1],["-",1],["forcenatural",2],["n",2],["forcesharp",3],["#",3],["forcedoublesharp",4],["##",4],["x",4],["forceflat",5],["b",5],["forcedoubleflat",6],["bb",6]]),st._allMusicFontSymbols=[],st.displayTranspositionPitches=new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]]),st._keyTransposeTable=st._translateKeyTransposeTable([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]]),st._keySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],st.accidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1],st),it=((r={})[r.None=0]="None",r[r.Up=1]="Up",r[r.Down=2]="Down",r),at=((e={})[e.Above=0]="Above",e[e.Inside=1]="Inside",e[e.Below=2]="Below",e[e.Outside=3]="Outside",e),h=class{constructor(e="",t=0,s=0,i=-1,a=-1,r=-1,n=-1,o=1){this.elementType=e,this.outputMidiNumber=s,this.staffLine=t,this.noteHeadDefault=i,this.noteHeadHalf=-1!==a?a:i,this.noteHeadWhole=-1!==r?r:i,this.techniqueSymbol=n,this.techniqueSymbolPlacement=o}getSymbol(e){switch(e){case 1:return this.noteHeadWhole;case 2:return this.noteHeadHalf;default:return this.noteHeadDefault}}},l=class l{static articulationFromElementVariation(e,t){return e<l._gp6ElementAndVariationToArticulation.length?(t>=l._gp6ElementAndVariationToArticulation.length&&(t=0),l._gp6ElementAndVariationToArticulation[e][t]):38}static getArticulationName(e){let t=l.getArticulation(e),s=e.percussionArticulation;t&&(s=t.outputMidiNumber);for(var[i,a]of l.instrumentArticulationNames)if(a===s)return i;return"unknown"}static getArticulation(e){var t=e.percussionArticulation;return t<0?null:t<(e=e.beat.voice.bar.staff.track.percussionArticulations).length?e[t]:l.getArticulationByInputMidiNumber(t)}static getElementAndVariation(e){var s=l.getArticulation(e);if(s)for(let t=0;t<l._gp6ElementAndVariationToArticulation.length;t++){var i=l._gp6ElementAndVariationToArticulation[t];for(let e=0;e<i.length;e++)if(l.getArticulationByInputMidiNumber(i[e])?.outputMidiNumber===s.outputMidiNumber)return[t,e]}return[-1,-1]}static getArticulationByInputMidiNumber(e){return l.instrumentArticulations.has(e)?l.instrumentArticulations.get(e):null}},rt=(l._gp6ElementAndVariationToArticulation=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]],l.instrumentArticulations=new Map([[38,new h("snare",3,38,57508,57507,57506)],[37,new h("snare",3,37,57513,57513,57513)],[91,new h("snare",3,38,57565,57565,57565)],[42,new h("hiHat",-1,42,57513,57513,57513)],[92,new h("hiHat",-1,46,57591,57591,57591)],[46,new h("hiHat",-1,46,57523,57523,57523)],[44,new h("hiHat",9,44,57513,57513,57513)],[35,new h("kickDrum",8,35,57508,57507,57506)],[36,new h("kickDrum",7,36,57508,57507,57506)],[50,new h("tom",1,50,57508,57507,57506)],[48,new h("tom",2,48,57508,57507,57506)],[47,new h("tom",4,47,57508,57507,57506)],[45,new h("tom",5,45,57508,57507,57506)],[43,new h("tom",6,43,57508,57507,57506)],[93,new h("ride",0,51,57513,57513,57513,59177,2)],[51,new h("ride",0,51,57513,57513,57513)],[53,new h("ride",0,53,57565,57565,57565)],[94,new h("ride",0,51,57513,57513,57513,58530,0)],[55,new h("splash",-2,55,57513,57513,57513)],[95,new h("splash",-2,55,57513,57513,57513,58530,2)],[52,new h("china",-3,52,57593,57593,57593)],[96,new h("china",-3,52,57593,57593,57593)],[49,new h("crash",-2,49,57592,57592,57592)],[97,new h("crash",-2,49,57592,57592,57592,58530,2)],[57,new h("crash",-1,57,57592,57592,57592)],[98,new h("crash",-1,57,57592,57592,57592,58530,2)],[99,new h("cowbell",1,56,57534,57532,57531)],[100,new h("cowbell",1,56,57513,57512,57511)],[56,new h("cowbell",0,56,57534,57532,57531)],[101,new h("cowbell",0,56,57513,57512,57511)],[102,new h("cowbell",-1,56,57534,57532,57531)],[103,new h("cowbell",-1,56,57513,57512,57511)],[77,new h("woodblock",-9,77,57534,57534,57534)],[76,new h("woodblock",-10,76,57534,57534,57534)],[60,new h("bongo",-4,60,57508,57507,57506)],[104,new h("bongo",-5,60,57508,57507,57506,57550,1)],[105,new h("bongo",-6,60,57513,57513,57513)],[61,new h("bongo",-7,61,57508,57507,57506)],[106,new h("bongo",-8,61,57508,57507,57506,57550,1)],[107,new h("bongo",-16,61,57513,57513,57513)],[66,new h("timbale",10,66,57508,57507,57506)],[65,new h("timbale",9,65,57508,57507,57506)],[68,new h("agogo",12,68,57508,57507,57506)],[67,new h("agogo",11,67,57508,57507,57506)],[64,new h("conga",17,64,57508,57507,57506)],[108,new h("conga",16,64,57513,57513,57513)],[109,new h("conga",15,64,57508,57507,57506,57550,1)],[63,new h("conga",14,63,57508,57507,57506)],[110,new h("conga",13,63,57513,57513,57513)],[62,new h("conga",19,62,57508,57507,57506,57550,1)],[72,new h("whistle",-11,72,57508,57507,57506)],[71,new h("whistle",-17,71,57508,57507,57506)],[73,new h("guiro",38,73,57508,57507,57506)],[74,new h("guiro",37,74,57508,57507,57506)],[86,new h("surdo",36,86,57508,57507,57506)],[87,new h("surdo",35,87,57513,57513,57513,57550,1)],[54,new h("tambourine",3,54,57534,57534,57534)],[111,new h("tambourine",2,54,57534,57534,57534,58898,2)],[112,new h("tambourine",1,54,57534,57534,57534,58896,2)],[113,new h("tambourine",-7,54,57513,57513,57513)],[79,new h("cuica",30,79,57508,57507,57506)],[78,new h("cuica",29,78,57513,57513,57513)],[58,new h("vibraslap",28,58,57508,57507,57506)],[81,new h("triangle",27,81,57508,57507,57506)],[80,new h("triangle",26,80,57513,57513,57513,57550,1)],[114,new h("grancassa",25,43,57508,57507,57506)],[115,new h("piatti",18,49,57508,57507,57506)],[116,new h("piatti",24,49,57513,57513,57513)],[69,new h("cabasa",23,69,57508,57507,57506)],[117,new h("cabasa",22,69,57508,57507,57506,58898,2)],[85,new h("castanets",21,85,57508,57507,57506)],[75,new h("claves",20,75,57508,57507,57506)],[70,new h("maraca",-12,70,57508,57507,57506)],[118,new h("maraca",-13,70,57508,57507,57506,58898,2)],[119,new h("maraca",-14,70,57508,57507,57506)],[120,new h("maraca",-15,70,57508,57507,57506,58898,2)],[82,new h("shaker",-23,54,57508,57507,57506)],[122,new h("shaker",-24,54,57508,57507,57506,58898,2)],[84,new h("bellTree",-18,53,57508,57507,57506)],[123,new h("bellTree",-19,53,57508,57507,57506,58898,2)],[83,new h("jingleBell",-20,53,57508,57507,57506)],[124,new h("unpitched",-21,62,57509,57509,57509,59458,0)],[125,new h("unpitched",-22,62,57509,57509,57509,59458,2)],[39,new h("handClap",3,39,57508,57507,57506)],[40,new h("snare",3,40,57508,57507,57506)],[31,new h("snare",3,40,57552,57552,57552)],[41,new h("tom",5,41,57508,57507,57506)],[59,new h("ride",2,59,57513,57513,57513,59177,2)],[126,new h("ride",2,59,57513,57513,57513)],[127,new h("ride",2,59,57565,57565,57565)],[29,new h("ride",2,59,57513,57513,57513,58530,0)],[30,new h("crash",-3,49,57513,57513,57513)],[33,new h("snare",3,37,57513,57513,57513)],[34,new h("snare",3,38,57508,57508,57508)]]),l.instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Bongo high (hit)",60],["Bongo low (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]),l),nt=((i={})[i.None=0]="None",i[i.InvertedTurn=1]="InvertedTurn",i[i.Turn=2]="Turn",i[i.UpperMordent=3]="UpperMordent",i[i.LowerMordent=4]="LowerMordent",i),ot=class{constructor(){this.tieDestinationNoteId=-1,this.tieOriginNoteId=-1,this.slurDestinationNoteId=-1,this.slurOriginNoteId=-1,this.hammerPullDestinationNoteId=-1,this.hammerPullOriginNoteId=-1,this.slideTargetNoteId=-1,this.slideOriginNoteId=-1}},ht=((t={})[t.Effects=0]="Effects",t[t.StandardNotationNoteHead=1]="StandardNotationNoteHead",t[t.StandardNotationAccidentals=2]="StandardNotationAccidentals",t[t.StandardNotationEffects=3]="StandardNotationEffects",t[t.GuitarTabFretNumber=4]="GuitarTabFretNumber",t[t.GuitarTabEffects=5]="GuitarTabEffects",t[t.SlashNoteHead=6]="SlashNoteHead",t[t.SlashEffects=7]="SlashEffects",t[t.NumberedNumber=8]="NumberedNumber",t[t.NumberedAccidentals=9]="NumberedAccidentals",t[t.NumberedEffects=10]="NumberedEffects",t),lt=class extends xe{},d=class d{constructor(){this.id=d.globalNoteId++,this.index=0,this.accentuated=0,this.bendType=0,this.bendStyle=0,this.bendOrigin=null,this.isContinuedBend=!1,this.bendPoints=null,this.maxBendPoint=null,this.fret=-1,this.string=-1,this.showStringNumber=!1,this.octave=-1,this.tone=-1,this.percussionArticulation=-1,this.isVisible=!0,this.isLeftHandTapped=!1,this.isHammerPullOrigin=!1,this.hammerPullOrigin=null,this.hammerPullDestination=null,this.isSlurDestination=!1,this.slurOrigin=null,this.slurDestination=null,this.harmonicType=0,this.harmonicValue=0,this.isGhost=!1,this.isLetRing=!1,this.letRingDestination=null,this.isPalmMute=!1,this.palmMuteDestination=null,this.isDead=!1,this.isDeadVisual=!1,this.isStaccato=!1,this.slideInType=0,this.slideOutType=0,this.slideTarget=null,this.slideOrigin=null,this.vibrato=0,this.tieOrigin=null,this.tieDestination=null,this.isTieDestination=!1,this.leftHandFinger=-2,this.rightHandFinger=-2,this.trillValue=-1,this.trillSpeed=32,this.durationPercent=1,this.accidentalMode=0,this.dynamics=5,this.isEffectSlurOrigin=!1,this.hasEffectSlur=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.ornament=0,this._noteIdBag=null}static resetIds(){d.globalNoteId=0}get hasBend(){return null!==this.bendPoints&&0!==this.bendType}get isStringed(){return 0<=this.string}get isPiano(){return!this.isStringed&&0<=this.octave&&0<=this.tone}get isPercussion(){return!this.isStringed&&0<=this.percussionArticulation}get element(){return this.isPercussion?rt.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?rt.getElementAndVariation(this)[1]:-1}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return 0!==this.harmonicType}get isTieOrigin(){return null!==this.tieDestination}get isFingering(){return-2!==this.leftHandFinger||-2!==this.rightHandFinger}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return 0<=this.trillValue}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+d.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,t){return 0<e.tuning.length?e.tuning[e.tuning.length-(t-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(t,e){var s=t?this.beat.voice.bar.staff.transpositionPitch:0;if(e){let e=this.calculateRealValue(t,!1);return this.isStringed&&(1===this.harmonicType?e=this.harmonicPitch+this.stringTuning-s:e+=this.harmonicPitch),e}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?12*this.octave+this.tone-s:0}get harmonicPitch(){var e;return 0!==this.harmonicType&&this.isStringed?(e=this.harmonicValue,F.isAlmostEqualTo(e,2.4)?36:F.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:e<=24?24:0):0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let e=this.realValue;switch(1!==this.harmonicType&&0!==this.harmonicType&&(e-=this.harmonicPitch),this.beat.ottava){case 0:e-=24;break;case 1:e-=12;break;case 2:break;case 3:e+=12;break;case 4:e+=24}switch(this.beat.voice.bar.clefOttava){case 0:e-=24;break;case 1:e-=12;break;case 2:break;case 3:e+=12;break;case 4:e+=24}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(e){let t=this.bendPoints;null===t&&(t=[],this.bendPoints=t),t.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),0===this.bendType&&(this.bendType=1)}finish(e,t=null){var s=new be(()=>d.nextNoteOnSameLine(this)),e=e&&1===e.notation.notationMode;switch(this.isTieDestination&&(this.chain(t),e)&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0),this.isLetRing&&(s.value&&s.value.isLetRing?this.letRingDestination=s.value:this.letRingDestination=this,e)&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1),this.isPalmMute&&(s.value&&s.value.isPalmMute?this.palmMuteDestination=s.value:this.palmMuteDestination=this),this.isHammerPullOrigin&&((t=d.findHammerPullDestination(this))?(this.hammerPullDestination=t).hammerPullOrigin=this:this.isHammerPullOrigin=!1),this.slideOutType){case 1:case 2:this.slideTarget||(this.slideTarget=s.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=0}let i=null;this.isHammerPullOrigin&&this.hammerPullDestination?i=this.hammerPullDestination:2===this.slideOutType&&this.slideTarget&&(i=this.slideTarget),i&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&0===this.beat.pickStroke?(this.effectSlurOrigin.effectSlurDestination=i,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=i,this.effectSlurDestination.effectSlurOrigin=this));var a,r,n,e=this.bendPoints,t=null!=e&&0<e.length;t?(a=this.isTieDestination&&this.tieOrigin.hasBend,this.isContinuedBend=a):this.bendType=0,t&&1===this.bendType&&(4===e.length?(a=e[0],t=e[1],r=e[2],n=e[3],t.value===r.value?n.value>a.value?t.value>n.value?this.bendType=4:(!this.isContinuedBend&&0<a.value?this.bendType=7:this.bendType=2,e.splice(2,1),e.splice(1,1)):n.value<a.value?(this.isContinuedBend?this.bendType=3:this.bendType=8,e.splice(2,1),e.splice(1,1)):t.value>a.value?this.bendType=4:(0<a.value&&!this.isContinuedBend?this.bendType=6:this.bendType=5,e.splice(2,1),e.splice(1,1)):M.warning("Model","Unsupported bend type detected, fallback to custom",null)):2===e.length&&(r=e[0],(n=e[1]).value>r.value?!this.isContinuedBend&&0<r.value?this.bendType=7:this.bendType=2:n.value<r.value?this.isContinuedBend?this.bendType=3:this.bendType=8:0<r.value&&!this.isContinuedBend?this.bendType=6:this.bendType=5)),0<this.initialBendValue&&(this.accidentalMode=0)}static nextNoteOnSameLine(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+d._maxOffsetForSameLineSearch;){if(e.isStringed){var s=t.getNoteOnString(e.string);if(s)return s}else if(e.index<t.notes.length)return t.notes[e.index];t=t.nextBeat}return null}static findHammerPullDestination(s){let i=s.beat.nextBeat;for(;i&&i.voice.bar.index<=s.beat.voice.bar.index+d._maxOffsetForSameLineSearch;){if(s.isStringed){let t=i.getNoteOnString(s.string);if(t)return t;for(let e=s.string;0<e;e--)if(t=i.getNoteOnString(e)){if(t.isLeftHandTapped)return t;break}for(let e=s.string;e<=s.beat.voice.bar.staff.tuning.length;e++)if(t=i.getNoteOnString(e)){if(t.isLeftHandTapped)return t;break}}else if(s.index<i.notes.length)return i.notes[s.index];i=i.nextBeat}return null}static findTieOrigin(e){let t=e.beat.previousBeat;for(;t&&t.voice.bar.index>=e.beat.voice.bar.index-d._maxOffsetForSameLineSearch;){if(e.isStringed){var s=t.getNoteOnString(e.string);if(s)return s}else if(-1===e.octave&&-1===e.tone){if(e.index<t.notes.length)return t.notes[e.index]}else{s=t.getNoteWithRealValue(e.realValue);if(s)return s}t=t.previousBeat}return null}chain(t=null){if(null!==t)if(null!==this._noteIdBag){let e;t.has(d._noteIdLookupKey)?e=t.get(d._noteIdLookupKey):(e=new Map,t.set(d._noteIdLookupKey,e)),-1===this._noteIdBag.hammerPullDestinationNoteId&&-1===this._noteIdBag.tieDestinationNoteId&&-1===this._noteIdBag.slurDestinationNoteId&&-1===this._noteIdBag.slideTargetNoteId||e.set(this.id,this),-1!==this._noteIdBag.hammerPullOriginNoteId&&(this.hammerPullOrigin=e.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this._noteIdBag.tieOriginNoteId&&(this.tieOrigin=e.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this._noteIdBag.slurOriginNoteId&&(this.slurOrigin=e.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this._noteIdBag.slideOriginNoteId&&(this.slideOrigin=e.get(this._noteIdBag.slideOriginNoteId),this.slideOrigin.slideTarget=this),this._noteIdBag=null}else!this.isTieDestination&&null===this.tieOrigin||((t=this.tieOrigin??d.findTieOrigin(this))?((t.tieDestination=this).tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1)}toJson(e){null!==this.tieDestination&&e.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&e.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&e.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&e.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&e.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&e.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&e.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&e.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(e,t){switch(e){case"tiedestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new ot),this._noteIdBag.tieDestinationNoteId=t,!0;case"tieoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new ot),this._noteIdBag.tieOriginNoteId=t,!0;case"slurdestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new ot),this._noteIdBag.slurDestinationNoteId=t,!0;case"sluroriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new ot),this._noteIdBag.slurOriginNoteId=t,!0;case"hammerpulloriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new ot),this._noteIdBag.hammerPullOriginNoteId=t,!0;case"hammerpulldestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new ot),this._noteIdBag.hammerPullDestinationNoteId=t,!0;case"slidetargetnoteid":return null==this._noteIdBag&&(this._noteIdBag=new ot),this._noteIdBag.slideTargetNoteId=t,!0;case"slideoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new ot),this._noteIdBag.slideOriginNoteId=t,!0}return!1}},dt=(d.globalNoteId=0,d._maxOffsetForSameLineSearch=3,d._noteIdLookupKey="NoteIdLookup",d),ct=class ct{constructor(e){this._isEqualLengthTuplet=!0,this.totalDuration=0,this.beats=[],this.isFull=!1,this.voice=e}check(e){if(0===this.beats.length)this.beats.push(e),this.totalDuration+=e.playbackDuration;else if(0===e.graceType){if(e.voice!==this.voice||this.isFull||e.tupletNumerator!==this.beats[0].tupletNumerator||e.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(e.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(e),this.totalDuration+=e.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{var t,s=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(t of ct._allTicks)if(this.totalDuration===t*s){this.isFull=!0;break}}}return!0}},ut=(ct._halfTicks=1920,ct._quarterTicks=960,ct._eighthTicks=480,ct._sixteenthTicks=240,ct._thirtySecondTicks=120,ct._sixtyFourthTicks=60,ct._oneHundredTwentyEighthTicks=30,ct._twoHundredFiftySixthTicks=15,ct._allTicks=[ct._halfTicks,ct._quarterTicks,ct._eighthTicks,ct._sixteenthTicks,ct._thirtySecondTicks,ct._sixtyFourthTicks,ct._oneHundredTwentyEighthTicks,ct._twoHundredFiftySixthTicks],ct),pt=((s={})[s.None=0]="None",s[s.Custom=1]="Custom",s[s.Dive=2]="Dive",s[s.Dip=3]="Dip",s[s.Hold=4]="Hold",s[s.Predive=5]="Predive",s[s.PrediveDive=6]="PrediveDive",s),mt=((o={})[o.None=0]="None",o[o.Thumb=1]="Thumb",o[o.Finger=2]="Finger",o),gt=((x={})[x.None=0]="None",x[x.FadeIn=1]="FadeIn",x[x.FadeOut=2]="FadeOut",x[x.VolumeSwell=3]="VolumeSwell",x),ft=((Ke={})[Ke.None=0]="None",Ke[Ke.Open=1]="Open",Ke[Ke.Closed=2]="Closed",Ke),bt=((a={})[a.None=0]="None",a[a.Full=1]="Full",a[a.Half=2]="Half",a),yt=((n={})[n.None=0]="None",n[n.Ii=1]="Ii",n[n.Mi=2]="Mi",n[n.MiiTriplet=3]="MiiTriplet",n[n.MiiAnapaest=4]="MiiAnapaest",n[n.PmpTriplet=5]="PmpTriplet",n[n.PmpAnapaest=6]="PmpAnapaest",n[n.PeiTriplet=7]="PeiTriplet",n[n.PeiAnapaest=8]="PeiAnapaest",n[n.PaiTriplet=9]="PaiTriplet",n[n.PaiAnapaest=10]="PaiAnapaest",n[n.AmiTriplet=11]="AmiTriplet",n[n.AmiAnapaest=12]="AmiAnapaest",n[n.Ppp=13]="Ppp",n[n.Amii=14]="Amii",n[n.Amip=15]="Amip",n[n.Eami=16]="Eami",n[n.Eamii=17]="Eamii",n[n.Peami=18]="Peami",n),_t=((st={})[st.Auto=0]="Auto",st[st.ForceSplitToNext=1]="ForceSplitToNext",st[st.ForceMergeWithNext=2]="ForceMergeWithNext",st[st.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext",st),St=((r={})[r.Effects=0]="Effects",r[r.StandardNotationStem=1]="StandardNotationStem",r[r.StandardNotationFlags=2]="StandardNotationFlags",r[r.StandardNotationBeams=3]="StandardNotationBeams",r[r.StandardNotationTuplet=4]="StandardNotationTuplet",r[r.StandardNotationEffects=5]="StandardNotationEffects",r[r.StandardNotationRests=6]="StandardNotationRests",r[r.GuitarTabStem=7]="GuitarTabStem",r[r.GuitarTabFlags=8]="GuitarTabFlags",r[r.GuitarTabBeams=9]="GuitarTabBeams",r[r.GuitarTabTuplet=10]="GuitarTabTuplet",r[r.GuitarTabEffects=11]="GuitarTabEffects",r[r.GuitarTabRests=12]="GuitarTabRests",r[r.SlashStem=13]="SlashStem",r[r.SlashFlags=14]="SlashFlags",r[r.SlashBeams=15]="SlashBeams",r[r.SlashTuplet=16]="SlashTuplet",r[r.SlashRests=17]="SlashRests",r[r.SlashEffects=18]="SlashEffects",r[r.NumberedDuration=19]="NumberedDuration",r[r.NumberedEffects=20]="NumberedEffects",r[r.NumberedRests=21]="NumberedRests",r[r.NumberedTuplet=22]="NumberedTuplet",r),vt=class extends xe{},kt=class kt{constructor(){this.id=kt._globalBeatId++,this.index=0,this.previousBeat=null,this.nextBeat=null,this.notes=[],this.noteStringLookup=new Map,this.noteValueLookup=new Map,this.isEmpty=!1,this.whammyStyle=0,this.ottava=2,this.fermata=null,this.isLegatoOrigin=!1,this.minNote=null,this.maxNote=null,this.maxStringNote=null,this.minStringNote=null,this.duration=4,this.isLetRing=!1,this.isPalmMute=!1,this.automations=[],this.dots=0,this.fade=0,this.lyrics=null,this.pop=!1,this.slap=!1,this.tap=!1,this.text=null,this.slashed=!1,this.deadSlapped=!1,this.brushType=0,this.brushDuration=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.tupletGroup=null,this.isContinuedWhammy=!1,this.whammyBarType=0,this.whammyBarPoints=null,this.maxWhammyPoint=null,this.minWhammyPoint=null,this.vibrato=0,this.chordId=null,this.graceType=0,this.graceGroup=null,this.graceIndex=-1,this.pickStroke=0,this.tremoloSpeed=null,this.crescendo=0,this.displayStart=0,this.playbackStart=0,this.displayDuration=0,this.playbackDuration=0,this.golpe=0,this.dynamics=5,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isEffectSlurOrigin=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.beamingMode=0,this.wahPedal=0,this.barreFret=-1,this.barreShape=0,this.rasgueado=0,this.showTimer=!1,this.timer=null}static resetIds(){kt._globalBeatId=0}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&1===this.duration}get fadeIn(){return 1===this.fade}set fadeIn(e){this.fade=e?1:0}get hasRasgueado(){return 0!==this.rasgueado}get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}get hasWhammyBar(){return null!==this.whammyBarPoints&&0!==this.whammyBarType}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}get isTremolo(){return!!this.tremoloSpeed}get displayEnd(){return this.displayStart+this.displayDuration}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get isBarre(){return 0!==this.barreShape&&0<=this.barreFret}addWhammyBarPoint(e){let t=this.whammyBarPoints;null===t&&(t=[],this.whammyBarPoints=t),t.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),0===this.whammyBarType&&(this.whammyBarType=1)}removeWhammyBarPoint(e){var t=this.whammyBarPoints;if(!(null===t||e<0||e>=t.length)){t.splice(e,1);e=t[e];if(e===this.maxWhammyPoint){this.maxWhammyPoint=null;for(var s of t)(!this.maxWhammyPoint||s.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=s)}if(e===this.minWhammyPoint){this.minWhammyPoint=null;for(var i of t)(!this.minWhammyPoint||i.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=i)}}}addNote(e){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e)}removeNote(e){var t=this.notes.indexOf(e);0<=t&&(this.notes.splice(t,1),e.isStringed)&&this.noteStringLookup.delete(e.string)}getAutomation(s){for(let e=0,t=this.automations.length;e<t;e++){var i=this.automations[e];if(i.type===s)return i}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}_calculateDuration(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let e=N.toTicks(this.duration);return 2===this.dots?e=N.applyDot(e,!0):1===this.dots&&(e=N.applyDot(e,!1)),e=0<this.tupletDenominator&&0<=this.tupletNumerator?N.applyTuplet(e,this.tupletNumerator,this.tupletDenominator):e}updateDurations(){var e=this._calculateDuration();switch(this.playbackDuration=e,this.graceType){case 2:case 1:switch(this.duration){case 16:this.playbackDuration=N.toTicks(64);break;case 32:this.playbackDuration=N.toTicks(128);break;default:this.playbackDuration=N.toTicks(32)}this.displayDuration=0;break;case 3:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=e;var t=this.previousBeat;t&&3===t.graceType&&(this.playbackDuration=t.playbackDuration)}}finishTuplet(){let e=this.previousBeat,t=e?e.tupletGroup:null;(this.hasTuplet||0!==this.graceType&&t)&&(e&&t&&t.check(this)||(t=new ut(this.voice)).check(this),this.tupletGroup=t);var s,i=this.voice.bar.masterBar.calculateDuration(!1),a=[];for(s of this.automations)0===s.ratioPosition&&(s.ratioPosition=this.playbackStart/i),0!==s.type&&a.push(s);this.automations=a}finish(s,i=null){switch(null===this.getAutomation(2)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push(K.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case 1:case 2:var e=this.graceGroup.beats.length;this.duration=1===e?8:2===e?16:32}0===this.brushType&&(this.brushDuration=0);let a=s?s.notation.notationMode:0,r="grad"===this.text||"grad."===this.text,n=(r&&1===a&&(this.text=""),!1),o=(this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null,0),h=!1;for(let e=0,t=this.notes.length;e<t;e++){var l=this.notes[e];if(l.dynamics=this.dynamics,l.finish(s,i),l.isLetRing&&(this.isLetRing=!0),l.isPalmMute&&(this.isPalmMute=!0),1===a&&l.hasBend&&3!==this.graceType){if(!l.isTieOrigin)switch(l.bendType){case 2:case 8:case 7:n=!0}r||1===l.bendStyle?(r=!0,l.bendStyle=1,n=!1):l.bendStyle=2}l.isVisible&&(o++,(!this.minNote||l.realValue<this.minNote.realValue)&&(this.minNote=l),(!this.maxNote||l.realValue>this.maxNote.realValue)&&(this.maxNote=l),(!this.minStringNote||l.string<this.minStringNote.string)&&(this.minStringNote=l),(!this.maxStringNote||l.string>this.maxStringNote.string)&&(this.maxStringNote=l),l.hasEffectSlur)&&(h=!0)}if(h&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),0<this.notes.length&&0===o&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&s&&0===s.notation.notationMode&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute)&&(this.isPalmMute=!0);else{let e=this.previousBeat;for(;e&&e.isRest;)this.isLetRing||(e.isLetRing=!1),this.isPalmMute||(e.isPalmMute=!1),e=e.previousBeat}var t,d,c,u=this.whammyBarPoints,p=null!==u&&0<u.length;if(p?(t=!!this.previousBeat&&this.previousBeat.hasWhammyBar,this.isContinuedWhammy=t):this.whammyBarType=0,p&&1===this.whammyBarType&&(1===a&&(this.whammyStyle=r?1:2),4===u.length?(t=u[0],p=u[1],c=u[2],d=u[3],p.value===c.value&&(t.value<p.value&&p.value<d.value||t.value>p.value&&p.value>d.value?(0===t.value||this.isContinuedWhammy?this.whammyBarType=2:this.whammyBarType=6,u.splice(2,1),u.splice(1,1)):t.value>p.value&&p.value<d.value||t.value<p.value&&p.value>d.value?(this.whammyBarType=3,p.offset!==c.offset&&1!==a||u.splice(2,1)):t.value===p.value&&p.value===d.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=4:this.whammyBarType=5,u.splice(2,1),u.splice(1,1)))):2===u.length&&(c=u[0],p=u[1],c.value<p.value||c.value>p.value?0===c.value||this.isContinuedWhammy?this.whammyBarType=2:this.whammyBarType=6:c.value===p.value&&(0===c.value||this.isContinuedWhammy?this.whammyBarType=4:this.whammyBarType=5))),this.updateDurations(),n){var m=Pt.clone(this);m.id=kt._globalBeatId++;for(let e=m.pickStroke=0,t=m.notes.length;e<t;e++){var g,f=m.notes[e],b=this.notes[e];f.bendType=0,f.maxBendPoint=null,f.bendPoints=null,f.bendStyle=0,f.id=dt.globalNoteId++,b.isTieOrigin&&(f.tieDestination=b.tieDestination,b.tieDestination.tieOrigin=f),b.isTieDestination&&(f.tieOrigin=b.tieOrigin||null,b.tieOrigin.tieDestination=f),b.hasBend&&b.isTieOrigin&&(g=dt.findTieOrigin(b))&&g.hasBend&&(f.bendType=5,g=b.bendPoints[b.bendPoints.length-1],f.addBendPoint(new w(0,g.value)),f.addBendPoint(new w(w.MaxPosition,g.value))),f.isTieDestination=!0}this.graceType=3,this.graceGroup=new Re,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,m),m.graceGroup=new Re,m.graceGroup.addBeat(this),m.graceGroup.isComplete=!0,m.graceGroup.finish()}}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}chain(e=null){for(var t of this.notes)this.noteValueLookup.set(t.realValue,t),t.chain(e)}},wt=(kt._globalBeatId=0,kt),Tt=class{static clone(e){var t=new w;return t.offset=e.offset,t.value=e.value,t}},Bt=class{static clone(e){var t=new dt;if(t.index=e.index,t.accentuated=e.accentuated,t.bendType=e.bendType,t.bendStyle=e.bendStyle,t.isContinuedBend=e.isContinuedBend,e.bendPoints){t.bendPoints=[];for(var s of e.bendPoints)t.addBendPoint(Tt.clone(s))}return t.fret=e.fret,t.string=e.string,t.showStringNumber=e.showStringNumber,t.octave=e.octave,t.tone=e.tone,t.percussionArticulation=e.percussionArticulation,t.isVisible=e.isVisible,t.isLeftHandTapped=e.isLeftHandTapped,t.isHammerPullOrigin=e.isHammerPullOrigin,t.isSlurDestination=e.isSlurDestination,t.harmonicType=e.harmonicType,t.harmonicValue=e.harmonicValue,t.isGhost=e.isGhost,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.isDead=e.isDead,t.isDeadVisual=e.isDeadVisual,t.isStaccato=e.isStaccato,t.slideInType=e.slideInType,t.slideOutType=e.slideOutType,t.vibrato=e.vibrato,t.isTieDestination=e.isTieDestination,t.leftHandFinger=e.leftHandFinger,t.rightHandFinger=e.rightHandFinger,t.trillValue=e.trillValue,t.trillSpeed=e.trillSpeed,t.durationPercent=e.durationPercent,t.accidentalMode=e.accidentalMode,t.dynamics=e.dynamics,t.ornament=e.ornament,t}},xt=class{static clone(e){var t=new K;return t.isLinear=e.isLinear,t.type=e.type,t.value=e.value,t.syncPointValue=e.syncPointValue?class{static clone(e){var t=new $;return t.barOccurence=e.barOccurence,t.millisecondOffset=e.millisecondOffset,t}}.clone(e.syncPointValue):void 0,t.ratioPosition=e.ratioPosition,t.text=e.text,t.isVisible=e.isVisible,t}},Pt=class{static clone(e){var t,s,i=new wt;i.index=e.index,i.notes=[];for(t of e.notes)i.addNote(Bt.clone(t));i.isEmpty=e.isEmpty,i.whammyStyle=e.whammyStyle,i.ottava=e.ottava,i.isLegatoOrigin=e.isLegatoOrigin,i.duration=e.duration,i.isLetRing=e.isLetRing,i.isPalmMute=e.isPalmMute,i.automations=[];for(s of e.automations)i.automations.push(xt.clone(s));if(i.dots=e.dots,i.fade=e.fade,i.lyrics=e.lyrics?e.lyrics.slice():null,i.pop=e.pop,i.slap=e.slap,i.tap=e.tap,i.text=e.text,i.slashed=e.slashed,i.deadSlapped=e.deadSlapped,i.brushType=e.brushType,i.brushDuration=e.brushDuration,i.tupletDenominator=e.tupletDenominator,i.tupletNumerator=e.tupletNumerator,i.isContinuedWhammy=e.isContinuedWhammy,i.whammyBarType=e.whammyBarType,e.whammyBarPoints){i.whammyBarPoints=[];for(var a of e.whammyBarPoints)i.addWhammyBarPoint(Tt.clone(a))}return i.vibrato=e.vibrato,i.chordId=e.chordId,i.graceType=e.graceType,i.pickStroke=e.pickStroke,i.tremoloSpeed=e.tremoloSpeed,i.crescendo=e.crescendo,i.displayStart=e.displayStart,i.playbackStart=e.playbackStart,i.displayDuration=e.displayDuration,i.playbackDuration=e.playbackDuration,i.overrideDisplayDuration=e.overrideDisplayDuration,i.golpe=e.golpe,i.dynamics=e.dynamics,i.invertBeamDirection=e.invertBeamDirection,i.preferredBeamDirection=e.preferredBeamDirection,i.isEffectSlurOrigin=e.isEffectSlurOrigin,i.beamingMode=e.beamingMode,i.wahPedal=e.wahPedal,i.barreFret=e.barreFret,i.barreShape=e.barreShape,i.rasgueado=e.rasgueado,i.showTimer=e.showTimer,i.timer=e.timer,i}},Nt=((e={})[e.Hint=0]="Hint",e[e.Warning=1]="Warning",e[e.Error=2]="Error",e),Mt=((l={})[l.AT001=1]="AT001",l[l.AT002=2]="AT002",l[l.AT003=3]="AT003",l[l.AT004=4]="AT004",l[l.AT005=5]="AT005",l[l.AT006=6]="AT006",l[l.AT200=200]="AT200",l[l.AT201=201]="AT201",l[l.AT202=202]="AT202",l[l.AT203=203]="AT203",l[l.AT204=204]="AT204",l[l.AT205=205]="AT205",l[l.AT206=206]="AT206",l[l.AT207=207]="AT207",l[l.AT208=208]="AT208",l[l.AT209=209]="AT209",l[l.AT210=210]="AT210",l[l.AT211=211]="AT211",l[l.AT212=212]="AT212",l[l.AT213=213]="AT213",l[l.AT214=214]="AT214",l[l.AT215=215]="AT215",l[l.AT216=216]="AT216",l[l.AT217=217]="AT217",l[l.AT218=218]="AT218",l[l.AT300=300]="AT300",l[l.AT301=301]="AT301",l[l.AT302=302]="AT302",l[l.AT303=303]="AT303",l[l.AT304=304]="AT304",l[l.AT305=305]="AT305",l[l.AT306=306]="AT306",l[l.AT400=400]="AT400",l),Et=class{constructor(){this._hasErrors=!1,this.items=[]}get errors(){return this.items.filter(e=>2===e.severity)}get hasErrors(){return this._hasErrors}push(e){this.items.push(e),2===e.severity&&(this._hasErrors=!0)}[Symbol.iterator](){return this.items[Symbol.iterator]()}},Lt=class extends Error{},Ct=((i={})[i.Auto=0]="Auto",i[i.Explicit=1]="Explicit",i),Ft=((t={})[t.Pitched=0]="Pitched",t[t.Fretted=1]="Fretted",t[t.Articulation=2]="Articulation",t),Dt=((d={})[d.TargetFine=0]="TargetFine",d[d.TargetSegno=1]="TargetSegno",d[d.TargetSegnoSegno=2]="TargetSegnoSegno",d[d.TargetCoda=3]="TargetCoda",d[d.TargetDoubleCoda=4]="TargetDoubleCoda",d[d.JumpDaCapo=5]="JumpDaCapo",d[d.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",d[d.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",d[d.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",d[d.JumpDalSegno=9]="JumpDalSegno",d[d.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",d[d.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",d[d.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",d[d.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",d[d.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",d[d.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",d[d.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",d[d.JumpDaCoda=17]="JumpDaCoda",d[d.JumpDaDoubleCoda=18]="JumpDaDoubleCoda",d),It=((ct={})[ct.Short=0]="Short",ct[ct.Medium=1]="Medium",ct[ct.Long=2]="Long",ct),At=class{constructor(){this.type=0,this.length=0}},c=class c{static _toEnum(e,t){return t}static*_basicMappingIterator(e){for(var[t,s]of Object.entries(e).filter(e=>"number"==typeof e[1]))yield[(t.startsWith("_")?t.substring(1):t).toLowerCase(),c._toEnum(e,s)]}static _basic(e,t){var s=new Map(c._basicMappingIterator(e));if(t)for(var i of t)s.set(i[0],i[1]);return s}static _reverse(e){var t,s,i=new Map;for([t,s]of e)i.has(s)||i.set(s,t);return i}},v=(c.whammyTypes=c._basic(pt),c.whammyTypesReversed=c._reverse(c.whammyTypes),c.bendStyles=c._basic(Q),c.bendStylesReversed=c._reverse(c.bendStyles),c.graceTypes=new Map([["ob",1],["b",3],["bb",2]]),c.graceTypesReversed=c._reverse(c.graceTypes),c.fermataTypes=c._basic(It),c.fermataTypesReversed=c._reverse(c.fermataTypes),c.accidentalModes=c._basic(Ct),c.accidentalModesReversed=c._reverse(c.accidentalModes),c.barreShapes=c._basic(bt),c.barreShapesReversed=c._reverse(c.barreShapes),c.ottava=c._basic(he),c.ottavaReversed=c._reverse(c.ottava),c.rasgueadoPatterns=c._basic(yt),c.rasgueadoPatternsReversed=c._reverse(c.rasgueadoPatterns),c.dynamics=c._basic(q),c.dynamicsReversed=c._reverse(c.dynamics),c.bracketExtendModes=c._basic(Se),c.bracketExtendModesReversed=c._reverse(c.bracketExtendModes),c.trackNamePolicies=c._basic(ve),c.trackNamePoliciesReversed=c._reverse(c.trackNamePolicies),c.trackNameOrientations=c._basic(we),c.trackNameOrientationsReversed=c._reverse(c.trackNameOrientations),c.trackNameMode=c._basic(ke),c.trackNameModeReversed=c._reverse(c.trackNameMode),c.textAligns=c._basic(He),c.textAlignsReversed=c._reverse(c.textAligns),c.bendTypes=c._basic(Z),c.bendTypesReversed=c._reverse(c.bendTypes),c.keySignatures=c._basic(Me,[["cbmajor",-7],["abminor",-7],["gbmajor",-6],["ebminor",-6],["dbmajor",-5],["bbminor",-5],["abmajor",-4],["fminor",-4],["ebmajor",-3],["cminor",-3],["bbmajor",-2],["gminor",-2],["fmajor",-1],["dminor",-1],["cmajor",0],["aminor",0],["gmajor",1],["eminor",1],["dmajor",2],["bminor",2],["amajor",3],["f#minor",3],["emajor",4],["c#minor",4],["bmajor",5],["g#minor",5],["f#",6],["f#major",6],["d#minor",6],["c#",7],["c#major",7],["a#minor",7]]),c.keySignaturesMajorReversed=new Map([[-7,"cb"],[-6,"gb"],[-5,"db"],[-4,"ab"],[-3,"eb"],[-2,"bb"],[-1,"f"],[0,"c"],[1,"g"],[2,"d"],[3,"a"],[4,"e"],[5,"b"],[6,"f#"],[7,"c#"]]),c.keySignaturesMinorReversed=new Map([[-7,"abminor"],[-6,"ebminor"],[-5,"bbminor"],[-4,"fminor"],[-3,"cminor"],[-2,"gminor"],[-1,"dminor"],[0,"aminor"],[1,"eminor"],[2,"bminor"],[3,"f#minor"],[4,"c#minor"],[5,"g#minor"],[6,"d#minor"],[7,"a#minor"]]),c.keySignatureTypes=new Map([["cb",0],["cbmajor",0],["abminor",1],["gb",0],["gbmajor",0],["ebminor",1],["db",0],["dbmajor",0],["bbminor",1],["ab",0],["abmajor",0],["fminor",1],["eb",0],["ebmajor",0],["cminor",1],["bb",0],["bbmajor",0],["gminor",1],["f",0],["fmajor",0],["dminor",1],["c",0],["cmajor",0],["aminor",1],["g",0],["gmajor",0],["eminor",1],["d",0],["dmajor",0],["bminor",1],["a",0],["amajor",0],["f#minor",1],["e",0],["emajor",0],["c#minor",1],["b",0],["bmajor",0],["g#minor",1],["f#",0],["f#major",0],["d#minor",1],["c#",0],["c#major",0],["a#minor",1]]),c.clefs=c._basic(Pe,[["treble",4],["bass",3],["alto",1],["tenor",2],["n",0]]),c.clefsReversed=c._reverse(c.clefs),c.tripletFeels=c._basic(je,[["no",0],["none",0],["t16",1],["triplet-16th",1],["t8",2],["triplet-8th",2],["d16",3],["dotted-16th",3],["d8",4],["dotted-8th",4],["s16",5],["scottish-16th",5],["s8",6],["scottish-8th",6]]),c.tripletFeelsReversed=c._reverse(c.tripletFeels),c.barLines=c._basic(Ie),c.barLinesReversed=c._reverse(c.barLines),c.ottavia=c._basic(he),c.ottaviaReversed=c._reverse(c.ottavia),c.simileMarks=c._basic(Ne),c.simileMarksReversed=c._reverse(c.simileMarks),c.directions=new Map([["fine",0],["segno",1],["segnosegno",2],["coda",3],["doublecoda",4],["dacapo",5],["dacapoalcoda",6],["dacapoaldoublecoda",7],["dacapoalfine",8],["dalsegno",9],["dalsegnoalcoda",10],["dalsegnoaldoublecoda",11],["dalsegnoalfine",12],["dalsegnosegno",13],["dalsegnosegnoalcoda",14],["dalsegnosegnoaldoublecoda",15],["dalsegnosegnoalfine",16],["dacoda",17],["dadoublecoda",18]]),c.directionsReversed=c._reverse(c.directions),c),Rt=((s={})[s.Dot=0]="Dot",s[s.Backslash=1]="Backslash",s[s.DoubleBackslash=2]="DoubleBackslash",s[s.Pipe=3]="Pipe",s[s.LBrace=4]="LBrace",s[s.RBrace=5]="RBrace",s[s.LParen=6]="LParen",s[s.RParen=7]="RParen",s[s.Colon=8]="Colon",s[s.Asterisk=9]="Asterisk",s[s.Ident=10]="Ident",s[s.Tag=11]="Tag",s[s.Meta=12]="Meta",s[s.Values=13]="Values",s[s.Props=14]="Props",s[s.Prop=15]="Prop",s[s.Number=16]="Number",s[s.String=17]="String",s[s.Score=18]="Score",s[s.Bar=19]="Bar",s[s.Beat=20]="Beat",s[s.Duration=21]="Duration",s[s.NoteList=22]="NoteList",s[s.Note=23]="Note",s),u=class u{static _valueType(e,t,s,i){return{expectedTypes:new Set(e),parseMode:t,allowedValues:s?new Set(s):void 0,reservedIdentifiers:i?new Set(i):void 0}}static _basicList(e){return e.map(e=>u._valueType(e[0],e[1]))}},Ot=(u._scoreInfoValueListTypes=[u._valueType([17,10],0),u._valueType([17],1),u._valueType([17,10],1,Array.from(v.textAligns.keys()))],u._scoreInfoTemplateValueListTypes=[u._valueType([17],0),u._valueType([17,10],1,Array.from(v.textAligns.keys()))],u._numberOnlyValueListTypes=u._basicList([[[16],0]]),u._textLikeValueListTypes=u._basicList([[[17,10],0]]),u.chordPropertyValueListTypes=new Map([["firstfret",u._numberOnlyValueListTypes],["showdiagram",u._basicList([[[17,10,16],1]])],["showfingering",u._basicList([[[17,10,16],1]])],["showname",u._basicList([[[17,10,16],1]])],["barre",u._basicList([[[16],7]])]]),u.tuningPropertyValueListTypes=new Map([["hide",void 0],["label",u._basicList([[[17],0]])]]),u.staffPropertyValueListTypes=new Map([["score",u._basicList([[[16],1]])],["tabs",void 0],["slash",void 0],["numbered",void 0]]),u.trackPropertyValueListTypes=new Map([["color",u._textLikeValueListTypes],["defaultsystemslayout",u._numberOnlyValueListTypes],["volume",u._numberOnlyValueListTypes],["balance",u._numberOnlyValueListTypes],["bank",u._numberOnlyValueListTypes],["systemslayout",u._basicList([[[16],7]])],["instrument",u._basicList([[[10,17,16],0]])],["mute",void 0],["solo",void 0],["multibarrest",void 0]]),u.beatPropertyValueListTypes=new Map([["f",void 0],["fo",void 0],["vs",void 0],["v",void 0],["vw",void 0],["s",void 0],["p",void 0],["tt",void 0],["dd",void 0],["d",void 0],["su",void 0],["sd",void 0],["cre",void 0],["dec",void 0],["spd",void 0],["sph",void 0],["spu",void 0],["spe",void 0],["slashed",void 0],["ds",void 0],["glpf",void 0],["glpt",void 0],["waho",void 0],["wahc",void 0],["legatoorigin",void 0],["timer",void 0],["tu",u._basicList([[[16],0],[[16],1]])],["txt",u._textLikeValueListTypes],["lyrics",u._basicList([[[16],1],[[17],0]])],["tb",[u._valueType([17,10],1),u._valueType([17,10],1),u._valueType([16],6)]],["tbe",[u._valueType([17,10],1,Array.from(v.whammyTypes.keys())),u._valueType([17,10],1,Array.from(v.bendStyles.keys())),u._valueType([16],6)]],["bu",u._basicList([[[16],1]])],["bd",u._basicList([[[16],1]])],["au",u._basicList([[[16],1]])],["ad",u._basicList([[[16],1]])],["ch",u._textLikeValueListTypes],["gr",[u._valueType([17,10],1,Array.from(v.graceTypes.keys()))]],["dy",u._textLikeValueListTypes],["tempo",[u._valueType([16],0),u._valueType([17],1),u._valueType([10],1,["hide"])]],["volume",u._numberOnlyValueListTypes],["balance",u._numberOnlyValueListTypes],["tp",u._numberOnlyValueListTypes],["barre",[u._valueType([16],0),u._valueType([17,10],1,Array.from(v.barreShapes.keys()))]],["rasg",u._textLikeValueListTypes],["ot",u._textLikeValueListTypes],["instrument",u._basicList([[[10,17,16],0]])],["bank",u._numberOnlyValueListTypes],["fermata",[u._valueType([17,10],1,Array.from(v.fermataTypes.keys())),u._valueType([16],3)]],["beam",u._textLikeValueListTypes]]),u.beatDurationPropertyValueListTypes=new Map([["tu",u._basicList([[[16],0],[[16],1]])]]),u.notePropertyValueListTypes=new Map([["nh",u._basicList([[[16],1]])],["ah",u._basicList([[[16],1]])],["th",u._basicList([[[16],1]])],["ph",u._basicList([[[16],1]])],["sh",u._basicList([[[16],1]])],["fh",u._basicList([[[16],1]])],["v",void 0],["vw",void 0],["sl",void 0],["ss",void 0],["sib",void 0],["sia",void 0],["sou",void 0],["sod",void 0],["psd",void 0],["psu",void 0],["h",void 0],["lht",void 0],["g",void 0],["ac",void 0],["hac",void 0],["ten",void 0],["pm",void 0],["st",void 0],["lr",void 0],["x",void 0],["-",void 0],["t",void 0],["turn",void 0],["iturn",void 0],["umordent",void 0],["lmordent",void 0],["string",void 0],["hide",void 0],["b",[u._valueType([17,10],1),u._valueType([17,10],1),u._valueType([16],6)]],["be",[u._valueType([17,10],1,Array.from(v.bendTypes.keys())),u._valueType([17,10],1,Array.from(v.bendStyles.keys())),u._valueType([16],6)]],["tr",u._basicList([[[16],0],[[16],1]])],["lf",u._basicList([[[16],1]])],["rf",u._basicList([[[16],1]])],["acc",u._textLikeValueListTypes],["slur",u._textLikeValueListTypes]]),u.structuralMetaDataValueListTypes=new Map([["track",u._basicList([[[17],1],[[17],1]])],["staff",void 0],["voice",void 0]]),u.staffMetaDataValueListTypes=new Map([["tuning",[u._valueType([10,17],5,["piano","none","voice"]),u._valueType([10,17],7)]],["chord",u._basicList([[[10,17],0],[[10,17,16],7]])],["capo",u._numberOnlyValueListTypes],["instrument",u._basicList([[[10,17,16],0]])],["bank",u._numberOnlyValueListTypes],["lyrics",u._basicList([[[16],1],[[17],0]])],["articulation",u._basicList([[[17,10],0],[[16],1]])],["displaytranspose",u._numberOnlyValueListTypes],["transpose",u._numberOnlyValueListTypes]]),u.scoreMetaDataValueListTypes=new Map([["title",u._scoreInfoValueListTypes],["subtitle",u._scoreInfoValueListTypes],["artist",u._scoreInfoValueListTypes],["album",u._scoreInfoValueListTypes],["words",u._scoreInfoValueListTypes],["music",u._scoreInfoValueListTypes],["wordsandmusic",u._scoreInfoTemplateValueListTypes],["copyright",u._scoreInfoValueListTypes],["copyright2",u._scoreInfoTemplateValueListTypes],["instructions",u._scoreInfoValueListTypes],["notices",u._scoreInfoValueListTypes],["tab",u._scoreInfoValueListTypes],["defaultsystemslayout",u._numberOnlyValueListTypes],["systemslayout",u._basicList([[[16],7]])],["hidedynamics",void 0],["showdynamics",void 0],["usesystemsignseparator",void 0],["multibarrest",void 0],["bracketextendmode",u._textLikeValueListTypes],["singletracktracknamepolicy",u._textLikeValueListTypes],["multitracktracknamepolicy",u._textLikeValueListTypes],["firstsystemtracknamemode",u._textLikeValueListTypes],["othersystemstracknamemode",u._textLikeValueListTypes],["firstsystemtracknameorientation",u._textLikeValueListTypes],["othersystemstracknameorientation",u._textLikeValueListTypes]]),u.barMetaDataValueListTypes=new Map([["tempo",[u._valueType([16],2),u._valueType([17],1),u._valueType([16],4),u._valueType([10],1,["hide"])]],["rc",u._numberOnlyValueListTypes],["ae",u._basicList([[[16],6]])],["ts",u._basicList([[[17,10],5],[[16],0],[[16],0]])],["ks",u._textLikeValueListTypes],["clef",u._basicList([[[10,17,16],0]])],["section",[u._valueType([17,10],0),u._valueType([17,10],1,void 0,["x","-","r"])]],["tf",u._basicList([[[10,17,16],0]])],["barlineleft",u._textLikeValueListTypes],["barlineright",u._textLikeValueListTypes],["accidentals",u._textLikeValueListTypes],["jump",u._textLikeValueListTypes],["ottava",u._textLikeValueListTypes],["simile",u._textLikeValueListTypes],["width",u._numberOnlyValueListTypes],["scale",u._basicList([[[16],2]])],["spd",u._basicList([[[16],2]])],["spu",u._basicList([[[16],2]])],["sph",u._basicList([[[16],2]])],["ft",void 0],["ro",void 0],["ac",void 0],["db",void 0],["sync",u._basicList([[[16],0],[[16],0],[[16],0],[[16],3]])]]),u.metaDataValueListTypes=[u.scoreMetaDataValueListTypes,u.staffMetaDataValueListTypes,u.structuralMetaDataValueListTypes,u.barMetaDataValueListTypes],u),p=class xu{static ident(e){return{nodeType:10,text:e}}static string(e){return{nodeType:17,text:e}}static number(e){return{nodeType:16,value:e}}static meta(e,t,s){return{nodeType:12,tag:{nodeType:11,prefix:{nodeType:1},tag:{nodeType:10,text:e}},values:t,properties:s,propertiesBeforeValues:!1}}static identMeta(e,t){return xu.meta(e,xu.identValue(t))}static numberMeta(e,t){return xu.meta(e,xu.numberValue(t))}static values(e,t=void 0){e={nodeType:13,values:e.filter(e=>void 0!==e)};if((void 0===t?1<e.values.length:t)&&(e.openParenthesis={nodeType:6},e.closeParenthesis={nodeType:7}),0!==e.values.length)return e}static stringValue(e){return xu.values([xu.string(e)])}static identValue(e){return xu.values([xu.ident(e)])}static numberValue(e){return xu.values([xu.number(e)])}static props(e){var t,s={nodeType:14,properties:[],openBrace:{nodeType:4},closeBrace:{nodeType:5}};for(t of e)t&&s.properties.push({nodeType:15,property:xu.ident(t[0]),values:t[1]});return s}static prop(e,t,s){e.push({nodeType:15,property:xu.ident(t),values:s})}},Vt=class Vt{static getValue(e){return Vt._values||(Vt._values=new Map),e=e.toLowerCase().replaceAll(" ",""),Vt._values.has(e)?Vt._values.get(e):0}static getName(e){for(var[t,s]of Vt._values)if(s===e)return t;return e.toString()}static isPiano(e){return e<=7||16<=e&&e<=23}static isGuitar(e){return 24<=e&&e<=39||105===e||43===e}static isBass(e){return 32<=e&&e<=39}static bankToLsbMsb(e){return[127&e,e>>7&127]}},Wt=(Vt._values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]),Vt),Ht=class{constructor(){this.name="",this.firstFret=1,this.strings=[],this.barreFrets=[],this.showName=!0,this.showDiagram=!0,this.showFingering=!0}get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}},Gt=class extends b{constructor(e){super(1,e)}},zt=class zt{constructor(e,t,s,i=255){this.raw=0,this.raw=(255&i)<<24|(255&e)<<16|(255&t)<<8|255&s,this.updateRgba()}updateRgba(){255===this.a?this.rgba="#"+F.toHexString(this.r,2)+F.toHexString(this.g,2)+F.toHexString(this.b,2):this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}static random(e=100){return new zt(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,e)}static fromJson(e){if(e instanceof zt)return e;switch(typeof e){case"number":var t=new zt(0,0,0,0);return t.raw=e,t.updateRgba(),t;case"string":t=e;if(t.startsWith("#")){if(4===t.length)return new zt(17*Number.parseInt(t[1],16),17*Number.parseInt(t[2],16),17*Number.parseInt(t[3],16));if(5===t.length)return new zt(17*Number.parseInt(t[1],16),17*Number.parseInt(t[2],16),17*Number.parseInt(t[3],16),17*Number.parseInt(t[4],16));if(7===t.length)return new zt(Number.parseInt(t.substring(1,3),16),Number.parseInt(t.substring(3,5),16),Number.parseInt(t.substring(5,7),16));if(9===t.length)return new zt(Number.parseInt(t.substring(1,3),16),Number.parseInt(t.substring(3,5),16),Number.parseInt(t.substring(5,7),16),Number.parseInt(t.substring(7,9),16))}else if(t.startsWith("rgba")||t.startsWith("rgb")){var s=t.indexOf("("),i=t.lastIndexOf(")");if(-1===s||-1===i)throw new Gt("No values specified for rgb/rgba function");t=t.substring(s+1,i).split(",");if(3===t.length)return new zt(Number.parseInt(t[0],10),Number.parseInt(t[1],10),Number.parseInt(t[2],10));if(4===t.length)return new zt(Number.parseInt(t[0],10),Number.parseInt(t[1],10),Number.parseInt(t[2],10),255*Number.parseFloat(t[3]))}return null}throw new Gt("Unsupported format for color")}static toJson(e){return null===e?null:e.raw}},Ut=(zt.BlackRgb="#000000",zt),Yt=class Yt{constructor(){this.startBar=0,this.text=""}finish(e=!1){this.chunks=[],this._parse(this.text,0,this.chunks,e)}_parse(a,r,e,n){if(a){let e=1,t=1,s=!1,i=0;for(;r<a.length;){var o=a.charCodeAt(r);switch(e){case 0:switch(o){case Yt._charCodeLF:case Yt._charCodeCR:case Yt._charCodeTab:break;case Yt._charCodeSpace:if(s)break;e=t;continue;default:s=!1,e=t;continue}break;case 1:if(o!==Yt._charCodeBrackedOpen){i=r,e=2;continue}e=3;break;case 3:o===Yt._charCodeBrackedClose&&(e=1);break;case 2:switch(o){case Yt._charCodeDash:e=4;break;case Yt._charCodeCR:case Yt._charCodeLF:case Yt._charCodeSpace:var h=a.substr(i,r-i);this._addChunk(h,n),e=0,t=1}break;case 4:if(o!==Yt._charCodeDash){var l=a.substr(i,r-i);this._addChunk(l,n),s=!0,e=0,t=1;continue}}r+=1}2===e&&r!==i&&this._addChunk(a.substr(i,r-i),n)}}_addChunk(e,t){e=this._prepareChunk(e),(!t||0<e.length&&"-"!==e)&&this.chunks.push(e)}_prepareChunk(e){let t=e.split("+").join(" "),s=t.length;for(;0<s&&"_"===t.charAt(s-1);)s--;return s!==t.length?t.substr(0,s):t}},Xt=(Yt._charCodeLF=10,Yt._charCodeTab=9,Yt._charCodeCR=13,Yt._charCodeSpace=32,Yt._charCodeBrackedClose=93,Yt._charCodeBrackedOpen=91,Yt._charCodeDash=45,Yt),Jt=class{constructor(){this.marker="",this.text=""}},m=class m{static getTextForTuning(e,t){e=m.getTextPartsForTuning(e);return t?e.join(""):e[0]}static getTextPartsForTuning(e,t=-1){var s=e/12|0,e=e%12;return[m.noteNames[e],(s+t).toString()]}static getDefaultTuningFor(e){return m._defaultTunings.has(e)?(e=m._defaultTunings.get(e),new m(e.name,e.tunings,e.isStandard)):null}static getPresetsFor(e){switch(e){case 7:return m._sevenStrings;case 6:return m._sixStrings;case 5:return m._fiveStrings;case 4:return m._fourStrings}return[]}static initialize(){m._defaultTunings.set(7,new m("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),m._sevenStrings.push(m._defaultTunings.get(7)),m._defaultTunings.set(6,new m("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),m._sixStrings.push(m._defaultTunings.get(6)),m._sixStrings.push(new m("Guitar Tune down  step",[63,58,54,49,44,39],!1)),m._sixStrings.push(new m("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),m._sixStrings.push(new m("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),m._sixStrings.push(new m("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),m._sixStrings.push(new m("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),m._sixStrings.push(new m("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),m._sixStrings.push(new m("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),m._sixStrings.push(new m("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),m._sixStrings.push(new m("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),m._sixStrings.push(new m("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),m._sixStrings.push(new m("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),m._sixStrings.push(new m("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),m._sixStrings.push(new m("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),m._sixStrings.push(new m("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),m._sixStrings.push(new m("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),m._sixStrings.push(new m("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),m._sixStrings.push(new m("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),m._sixStrings.push(new m("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),m._sixStrings.push(new m("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),m._sixStrings.push(new m("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),m._sixStrings.push(new m("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),m._sixStrings.push(new m("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),m._sixStrings.push(new m("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),m._sixStrings.push(new m("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),m._sixStrings.push(new m("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),m._sixStrings.push(new m("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),m._sixStrings.push(new m("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),m._sixStrings.push(new m("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),m._sixStrings.push(new m("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),m._sixStrings.push(new m("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),m._defaultTunings.set(5,new m("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),m._fiveStrings.push(m._defaultTunings.get(5)),m._fiveStrings.push(new m("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),m._fiveStrings.push(new m("Banjo Open D Tuning",[62,57,54,50,69],!1)),m._fiveStrings.push(new m("Banjo Open G Tuning",[62,59,55,50,67],!1)),m._fiveStrings.push(new m("Banjo G Minor Tuning",[62,58,55,50,67],!1)),m._fiveStrings.push(new m("Banjo G Modal Tuning",[62,57,55,50,67],!1)),m._defaultTunings.set(4,new m("Bass Standard Tuning",[43,38,33,28],!0)),m._fourStrings.push(m._defaultTunings.get(4)),m._fourStrings.push(new m("Bass Tune down  step",[42,37,32,27],!1)),m._fourStrings.push(new m("Bass Tune down 1 step",[41,36,31,26],!1)),m._fourStrings.push(new m("Bass Tune down 2 step",[39,34,29,24],!1)),m._fourStrings.push(new m("Bass Dropped D Tuning",[43,38,33,26],!1)),m._fourStrings.push(new m("Ukulele C Tuning",[45,40,36,43],!1)),m._fourStrings.push(new m("Ukulele G Tuning",[52,47,43,38],!1)),m._fourStrings.push(new m("Mandolin Standard Tuning",[64,57,50,43],!1)),m._fourStrings.push(new m("Mandolin or Violin Tuning",[76,69,62,55],!1)),m._fourStrings.push(new m("Viola Tuning",[69,62,55,48],!1)),m._fourStrings.push(new m("Cello Tuning",[57,50,43,36],!1))}static findTuning(a){var r=m.getPresetsFor(a.length);for(let e=0,t=r.length;e<t;e++){let s=r[e],i=!0;for(let e=0,t=a.length;e<t;e++)if(a[e]!==s.tunings[e]){i=!1;break}if(i)return new m(s.name,s.tunings,s.isStandard)}return null}constructor(e="",t=null,s=!1){this.isStandard=s,this.name=e,this.tunings=t??[]}reset(){this.isStandard=!1,this.name="",this.tunings=[]}finish(){var e=m.findTuning(this.tunings);e&&(0===this.name.length&&(this.name=e.name),this.isStandard=e.isStandard)}},qt=(m._sevenStrings=[],m._sixStrings=[],m._fiveStrings=[],m._fourStrings=[],m._defaultTunings=new Map,m.noteNames=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],m),jt=(qt.initialize(),class jt{constructor(){this.index=0,this.bars=[],this.chords=null,this.capo=0,this.transpositionPitch=0,this.displayTranspositionPitch=0,this.stringTuning=new qt("",[],!1),this.showSlash=!1,this.showNumbered=!1,this.showTablature=!0,this.showStandardNotation=!0,this.isPercussion=!1,this.standardNotationLineCount=jt.DefaultStandardNotationLineCount,this._filledVoices=new Set([0])}get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return 0<this.stringTuning.tunings.length}get filledVoices(){return this._filledVoices}finish(s,i=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1,this.displayTranspositionPitch=0),this.stringTuning.finish();for(let e=0,t=this.bars.length;e<t;e++){this.bars[e].finish(s,i);for(var a of this.bars[e].filledVoices)this._filledVoices.add(a)}}addChord(e,t){let s=(t.staff=this).chords;null===s&&(s=new Map,this.chords=s),s.set(e,t)}hasChord(e){return this.chords?.has(e)??!1}getChord(e){return this.chords?.get(e)??null}addBar(e){var t=this.bars;e.staff=this,e.index=t.length,0<t.length&&(e.previousBar=t[t.length-1],e.previousBar.nextBar=e),t.push(e)}}),$t=(jt.DefaultStandardNotationLineCount=5,jt),Kt=class{constructor(){this.volume=15,this.balance=8,this.port=1,this.program=0,this.bank=0,this.primaryChannel=0,this.secondaryChannel=0,this.isMute=!1,this.isSolo=!1}},Qt=((o={})[o.TrackName=0]="TrackName",o[o.BracesAndBrackets=1]="BracesAndBrackets",o[o.SystemSeparator=2]="SystemSeparator",o[o.StringTuning=3]="StringTuning",o),Zt=class extends xe{},es=class es{constructor(){this.index=0,this.staves=[],this.playbackInfo=new Kt,this.color=new Ut(200,0,0,255),this.name="",this.isVisibleOnMultiTrack=!0,this.shortName="",this.defaultSystemsLayout=3,this.systemsLayout=[],this.percussionArticulations=[]}get isPercussion(){return this.staves.some(e=>e.isPercussion)}addLineBreaks(e){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(e)}ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new $t)}addStaff(e){e.index=this.staves.length,(e.track=this).staves.push(e)}finish(e,t=null){this.shortName||(this.shortName=this.name,this.shortName.length>es._shortNameMaxLength&&(this.shortName=this.shortName.substr(0,es._shortNameMaxLength)));for(var s of this.staves)s.finish(e,t),s.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(i){for(var e of i)e.finish();var a=this.staves[0];for(let s=0;s<i.length;s++){var r=i[s];if(0<=r.startBar&&r.startBar<a.bars.length){let t=a.bars[r.startBar].voices[0].beats[0];for(let e=0;e<r.chunks.length&&t;e++){for(;t&&(t.isEmpty||t.isRest);)t=t.nextBeat;t&&(t.lyrics||(t.lyrics=new Array(i.length),t.lyrics.fill("")),t.lyrics[s]=r.chunks[e],t=t.nextBeat)}}}}},ts=(es._shortNameMaxLength=10,es),ss={},is=(G(ss,{BarBounds:()=>ns,BeamDirection:()=>ms,BeatBounds:()=>os,Bounds:()=>hs,BoundsLookup:()=>us,MasterBarBounds:()=>ls,NoteBounds:()=>ds,RenderFinishedEventArgs:()=>is,ScoreRenderer:()=>ps,StaffSystemBounds:()=>cs}),class{constructor(){this.id=F.newGuid(),this.x=0,this.y=0,this.width=0,this.height=0,this.totalWidth=0,this.totalHeight=0,this.firstMasterBarIndex=-1,this.lastMasterBarIndex=-1,this.renderResult=null}}),as=((x=as||{})[x.Page=0]="Page",x[x.Horizontal=1]="Horizontal",x),rs=class{constructor(e=void 0){this._listeners=[],this._fireOnRegister=e}on(e){return this._listeners.push(e),this._fireOnRegister?.()&&e(),()=>{this.off(e)}}off(t){this._listeners=this._listeners.filter(e=>e!==t)}trigger(){for(var e of this._listeners)e()}},g=class{constructor(e=void 0){this._listeners=[],this._fireOnRegister=e}on(e){var t;return this._listeners.push(e),this._fireOnRegister&&null!==(t=this._fireOnRegister())&&e(t),()=>{this.off(e)}}off(t){this._listeners=this._listeners.filter(e=>e!==t)}trigger(e){for(var t of this._listeners)t(e)}},ns=class{constructor(){this.beats=[]}addBeat(e){(e.barBounds=this).beats.push(e),this.masterBarBounds.addBeat(e)}findBeatAtPos(e){let t=null;for(var s of this.beats)if(!t||s.realBounds.x<e)t=s;else if(s.realBounds.x>e)break;return t}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.beats.sort((e,t)=>e.realBounds.x-t.realBounds.x);for(var t of this.beats)t.finish(e)}},os=class{constructor(){this.onNotesX=0,this.notes=null}addNote(e){this.notes||(this.notes=[]),(e.beatBounds=this).notes.push(e)}findNoteAtPos(e,t){var s=this.notes;if(s)for(var i of s){var a=i.noteHeadBounds.y+i.noteHeadBounds.h,r=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=e&&i.noteHeadBounds.y<=t&&e<=r&&t<=a)return i.note}return null}finish(e=1){if(this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.onNotesX*=e,this.notes)for(var t of this.notes)t.finish(e)}},hs=class{constructor(){this.x=0,this.y=0,this.w=0,this.h=0}scaleWith(e){this.x*=e,this.y*=e,this.w*=e,this.h*=e}},ls=class{constructor(){this.index=0,this.isFirstOfLine=!1,this.bars=[],this.staffSystemBounds=null}get staveGroupBounds(){return this.staffSystemBounds}addBar(e){(e.masterBarBounds=this).bars.push(e)}findBeatAtPos(e){let t=null;for(var s of this.bars){var i,s=s.findBeatAtPos(e);s&&(!t||t.realBounds.x<s.realBounds.x)&&(i=Math.abs(s.realBounds.x-e),!t||i<1e7)&&(t=s)}return t?t.beat:null}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.lineAlignedBounds.scaleWith(e),this.bars.sort((e,t)=>e.realBounds.y<t.realBounds.y?-1:e.realBounds.y>t.realBounds.y?1:e.realBounds.x<t.realBounds.x?-1:e.realBounds.x>t.realBounds.x?1:0);for(var t of this.bars)t.finish(e)}addBeat(e){this.staffSystemBounds.boundsLookup.addBeat(e)}},ds=class{finish(e=1){this.noteHeadBounds.scaleWith(e)}},cs=class{constructor(){this.index=0,this.bars=[]}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e);for(var t of this.bars)t.finish(e)}addBar(e){this.boundsLookup.addMasterBar(e),(e.staffSystemBounds=this).bars.push(e)}findBarAtPos(e){let t=null;for(var s of this.bars)if(!t||s.realBounds.x<e)t=s;else if(e>s.realBounds.x+s.realBounds.w)break;return t}},us=class Pu{constructor(){this._beatLookup=new Map,this._masterBarLookup=new Map,this._currentStaffSystem=null,this.staffSystems=[],this.isFinished=!1}toJson(){var e,t={},s=[];t.staffSystems=s;for(e of this.staffSystems){var i,a={};a.visualBounds=this._boundsToJson(e.visualBounds),a.realBounds=this._boundsToJson(e.realBounds),a.bars=[];for(i of e.bars){var r,n={};n.lineAlignedBounds=this._boundsToJson(i.lineAlignedBounds),n.visualBounds=this._boundsToJson(i.visualBounds),n.realBounds=this._boundsToJson(i.realBounds),n.index=i.index,n.bars=[];for(r of i.bars){var o,h={};h.visualBounds=this._boundsToJson(r.visualBounds),h.realBounds=this._boundsToJson(r.realBounds),h.beats=[];for(o of r.beats){var l={},d=(l.visualBounds=this._boundsToJson(o.visualBounds),l.realBounds=this._boundsToJson(o.realBounds),l.onNotesX=o.onNotesX,l);if(d.beatIndex=o.beat.index,d.voiceIndex=o.beat.voice.index,d.barIndex=o.beat.voice.bar.index,d.staffIndex=o.beat.voice.bar.staff.index,d.trackIndex=o.beat.voice.bar.staff.track.index,o.notes){var c,u=[];l.notes=u;for(c of o.notes){var p={};p.index=c.note.index,p.noteHeadBounds=this._boundsToJson(c.noteHeadBounds),u.push(p)}}h.beats.push(l)}n.bars.push(h)}a.bars.push(n)}s.push(a)}return t}static fromJson(e,t){var s,i=new Pu;for(s of e.staffSystems){var a,r=new cs;r.visualBounds=Pu._boundsFromJson(s.visualBounds),r.realBounds=Pu._boundsFromJson(s.realBounds),i.addStaffSystem(r);for(a of s.bars){var n,o=new ls;o.index=a.index,o.isFirstOfLine=a.isFirstOfLine,o.lineAlignedBounds=Pu._boundsFromJson(a.lineAlignedBounds),o.visualBounds=Pu._boundsFromJson(a.visualBounds),o.realBounds=Pu._boundsFromJson(a.realBounds),r.addBar(o);for(n of a.bars){var h,l=new ns;l.visualBounds=Pu._boundsFromJson(n.visualBounds),l.realBounds=Pu._boundsFromJson(n.realBounds),o.addBar(l);for(h of n.beats){var d=new os,c=(d.visualBounds=Pu._boundsFromJson(h.visualBounds),d.realBounds=Pu._boundsFromJson(h.realBounds),d.onNotesX=h.onNotesX,h);if(d.beat=t.tracks[c.trackIndex].staves[c.staffIndex].bars[c.barIndex].voices[c.voiceIndex].beats[c.beatIndex],h.notes){d.notes=[];for(var u of h.notes){var p=new ds,m=u;p.note=d.beat.notes[m.index],p.noteHeadBounds=Pu._boundsFromJson(u.noteHeadBounds),d.addNote(p)}}l.addBeat(d)}}}}return i}static _boundsFromJson(e){var t=new hs;return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}_boundsToJson(e){var t={};return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}finish(e=1){for(var t of this.staffSystems)t.finish(e);this.isFinished=!0}addStaffSystem(e){e.index=this.staffSystems.length,(e.boundsLookup=this).staffSystems.push(e),this._currentStaffSystem=e}addMasterBar(e){e.staffSystemBounds?this._masterBarLookup.set(e.index,e):(e.staffSystemBounds=this._currentStaffSystem,this._masterBarLookup.set(e.index,e),this._currentStaffSystem.addBar(e))}addBeat(e){this._beatLookup.has(e.beat.id)||this._beatLookup.set(e.beat.id,[]),this._beatLookup.get(e.beat.id)?.push(e)}findMasterBarByIndex(e){return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findMasterBar(e){e=e.index;return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findBeat(e){e=this.findBeats(e);return e?e[0]:null}findBeats(e){e=e.id;return this._beatLookup.has(e)?this._beatLookup.get(e):null}getBeatAtPos(e,t){let s=0,i=this.staffSystems.length-1,a=-1;for(;s<=i;){var r=(i+s)/2|0,n=this.staffSystems[r];if(t>=n.realBounds.y&&t<=n.realBounds.y+n.realBounds.h){a=r;break}t<n.realBounds.y?i=r-1:s=1+r}var o;return-1!==a&&(o=this.staffSystems[a].findBarAtPos(e))?o.findBeatAtPos(e):null}getNoteAtPos(e,t,s){e=this.findBeats(e);if(e)for(var i of e){i=i.findNoteAtPos(t,s);if(i)return i}return null}},ps=class{constructor(e){this._currentLayoutMode=0,this._currentRenderEngine=null,this._renderedTracks=null,this.canvas=null,this.score=null,this.tracks=null,this.layout=null,this.boundsLookup=null,this.width=0,this.preRender=new g,this.renderFinished=new g,this.partialRenderFinished=new g,this.partialLayoutFinished=new g,this.postRenderFinished=new rs,this.error=new g,this.settings=e,this._recreateCanvas(),this._recreateLayout()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}_recreateCanvas(){return this._currentRenderEngine!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=E.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0)}_recreateLayout(){return!(this.layout&&this._currentLayoutMode===this.settings.display.layoutMode||(this.layout=E.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,0))}renderScore(t,s){try{this.score=t;let e=null;if(null!=t&&null!=s){if(s){e=[];for(var i of s)0<=i&&i<t.tracks.length&&e.push(t.tracks[i])}else e=t.tracks.slice(0);0===e.length&&0<t.tracks.length&&e.push(t.tracks[0])}this.tracks=e,this.render()}catch(e){this.error.trigger(e)}}renderTracks(e){0===e.length?this.score=null:this.score=e[0].score,this.tracks=e,this.render()}updateSettings(e){this.settings=e}renderResult(e){try{var t=this.layout;t?(M.debug("Rendering","Request render of lazy partial "+e),t.renderLazyPartial(e)):M.warning("Rendering",`Request render of lazy partial ${e} ignored, no layout exists`)}catch(e){this.error.trigger(e)}}render(){if(0===this.width)M.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null);else if(this.boundsLookup=new us,this._recreateCanvas(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){M.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let e=0;e<this.tracks.length;e++){var t=this.tracks[e];M.debug("Rendering",`Track ${e}: `+t.name)}this.preRender.trigger(!1),this._recreateLayout(),this._layoutAndRender(),M.debug("Rendering","Rendering finished")}else M.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this._onRenderFinished(),this.postRenderFinished.trigger(),M.debug("Rendering","Clearing finished")}resizeRender(){this._recreateLayout()||this._recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(M.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(M.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new us,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this._onRenderFinished(),this.postRenderFinished.trigger()):M.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),M.debug("Rendering","Resize finished")}_layoutAndRender(){M.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout `+this.layout.name,null),this.layout.layoutAndRender(),this._renderedTracks=this.tracks,this._onRenderFinished(),this.postRenderFinished.trigger()}_onRenderFinished(){this.boundsLookup?.finish(this.settings.display.scale);var e=new is;e.totalHeight=this.layout.height,e.totalWidth=this.layout.width,e.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(e)}},ms=((Ke=ms||{})[Ke.Up=0]="Up",Ke[Ke.Down=1]="Down",Ke),k=class k{constructor(){this._allKnownBarMetaDataTags=void 0,this._knownScoreMetaDataTags=void 0,this._knownStructuralMetaDataTags=void 0,this._knownBarMetaDataTags=void 0,this._knownStaffMetaDataTags=void 0,this._knownBeatDurationProperties=void 0,this._knownBeatProperties=void 0,this._knownNoteProperties=void 0}applyScoreMetaData(e,t,s){var i=this._checkValueListTypes(e,[Ot.scoreMetaDataValueListTypes],s,s.tag.tag.text.toLowerCase(),s.values);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"title":return t.title=s.values.values[0].text,this._headerFooterStyle(e,t,0,s),0;case"subtitle":return t.subTitle=s.values.values[0].text,this._headerFooterStyle(e,t,1,s),0;case"artist":return t.artist=s.values.values[0].text,this._headerFooterStyle(e,t,2,s),0;case"album":return t.album=s.values.values[0].text,this._headerFooterStyle(e,t,3,s),0;case"words":return t.words=s.values.values[0].text,this._headerFooterStyle(e,t,4,s),0;case"music":return t.music=s.values.values[0].text,this._headerFooterStyle(e,t,5,s),0;case"copyright":return t.copyright=s.values.values[0].text,this._headerFooterStyle(e,t,8,s),0;case"instructions":return t.instructions=s.values.values[0].text,0;case"notices":return t.notices=s.values.values[0].text,0;case"tab":return t.tab=s.values.values[0].text,this._headerFooterStyle(e,t,7,s),0;case"copyright2":return this._headerFooterStyle(e,t,9,s,0),0;case"wordsandmusic":return this._headerFooterStyle(e,t,6,s,0),0;case"defaultsystemslayout":return t.defaultSystemsLayout=s.values.values[0].value,0;case"systemslayout":for(var a of s.values.values)t.systemsLayout.push(a.value);return 0;case"hidedynamics":return t.stylesheet.hideDynamics=!0,0;case"showdynamics":return t.stylesheet.hideDynamics=!1,0;case"bracketextendmode":var r=k._parseEnumValue(e,s.values,"bracket extend mode",v.bracketExtendModes);return void 0===r?1:(t.stylesheet.bracketExtendMode=r,0);case"usesystemsignseparator":return t.stylesheet.useSystemSignSeparator=!0,0;case"multibarrest":return t.stylesheet.multiTrackMultiBarRest=!0,0;case"singletracktracknamepolicy":r=k._parseEnumValue(e,s.values,"track name policy",v.trackNamePolicies);return void 0===r?1:(t.stylesheet.singleTrackTrackNamePolicy=r,0);case"multitracktracknamepolicy":r=k._parseEnumValue(e,s.values,"track name policy",v.trackNamePolicies);return void 0===r?1:(t.stylesheet.multiTrackTrackNamePolicy=r,0);case"firstsystemtracknamemode":r=k._parseEnumValue(e,s.values,"track name mode",v.trackNameMode);return void 0===r?1:(t.stylesheet.firstSystemTrackNameMode=r,0);case"othersystemstracknamemode":r=k._parseEnumValue(e,s.values,"track name mode",v.trackNameMode);return void 0===r?1:(t.stylesheet.otherSystemsTrackNameMode=r,0);case"firstsystemtracknameorientation":r=k._parseEnumValue(e,s.values,"track name orientation",v.trackNameOrientations);return void 0===r?1:(t.stylesheet.firstSystemTrackNameOrientation=r,0);case"othersystemstracknameorientation":r=k._parseEnumValue(e,s.values,"track name orientation",v.trackNameOrientations);return void 0===r?1:(t.stylesheet.otherSystemsTrackNameOrientation=r,0);default:return 2}}_checkValueListTypes(e,t,s,i,a){var t=t.find(e=>e.has(i));return t?void 0!==(t=t.get(i))?this._validateValueListTypes(e,t,s,a)?void 0:1:void(a&&e.addSemanticDiagnostic({code:300,message:"Expected no values, but found some. Values are ignored.",start:a.start,end:a.end,severity:1})):2}applyStaffMetaData(a,r,n){var e=this._checkValueListTypes(a,[Ot.staffMetaDataValueListTypes],n,n.tag.tag.text.toLowerCase(),n.values);if(void 0!==e)return e;switch(n.tag.tag.text.toLowerCase()){case"capo":return r.capo=n.values.values[0].value,0;case"tuning":let t=[],s=!1,i="";for(let e=0;e<n.values.values.length;e++){var o=n.values.values[e],h=o.text;switch(h){case"piano":case"none":case"voice":a.applyStaffNoteKind(r,0),e=n.values.values.length;break;case"hide":s=!0,a.addSemanticDiagnostic({code:305,message:"This value should be rather specified via the properties.",start:o.start,end:o.end,severity:1});break;default:var l,d=F.parseTuning(h);d?t.push(d.realValue):e===n.values.values.length-1&&0<t.length?(i=h,a.addSemanticDiagnostic({code:305,message:"This value should be rather specified via the properties.",start:o.start,end:o.end,severity:1})):(d=Array.from(F.tuningLetters).join(","),l=Array.from(F.accidentalModeMapping.keys()).join(","),a.addSemanticDiagnostic({code:209,message:`Unexpected tuning value '${h}', expected: <note><accidental><octave> where <note>=oneOf(${d}) <accidental>=oneOf(${l}), <octave>=number`,start:o.start,end:o.end,severity:2}))}}return a.state.staffHasExplicitTuning.add(r),a.state.staffTuningApplied.delete(r),r.stringTuning=new qt,r.stringTuning.tunings=t,r.stringTuning.name=i,this._tuningProperties(a,r,r.stringTuning,n),s&&(r.track.score.stylesheet.perTrackDisplayTuning||(r.track.score.stylesheet.perTrackDisplayTuning=new Map),r.track.score.stylesheet.perTrackDisplayTuning.set(r.track.index,!1)),0;case"instrument":return a.state.staffTuningApplied.delete(r),this._readTrackInstrument(a,r.track,n.values),0;case"bank":return r.track.playbackInfo.bank=n.values.values[0].value,0;case"lyrics":var c=new Xt;return c.startBar=0,c.text="",2===n.values.values.length?(c.startBar=n.values.values[0].value,c.text=n.values.values[1].text):c.text=n.values.values[0].text,a.state.lyrics.get(r.track.index).push(c),0;case"chord":var u=new Ht;this._chordProperties(a,u,n),u.name=n.values.values[0].text;for(let e=1;e<n.values.values.length;e++){var p,m=n.values.values[e];16===m.nodeType?u.strings.push(m.value):10===m.nodeType&&("x"===(p=m.text)?u.strings.push(-1):a.addSemanticDiagnostic({code:209,message:`Unexpected chord value '${p}', expected: 'x'`,severity:2,start:m.start,end:m.end}))}return r.addChord(k._getChordId(r,u.name),u),0;case"articulation":var g,f,b,y=a.state.percussionArticulationNames,c=n.values.values[0].text;if("defaults"!==c)return 2===n.values.values.length?(g=n.values.values[1].value,rt.instrumentArticulations.has(g)?(y.set(c.toLowerCase(),g),0):(c=Array.from(rt.instrumentArticulations.keys()).map(e=>""+e).join(","),a.addSemanticDiagnostic({code:209,message:`Unexpected articulation value '${g}', expected: `+c,start:n.values.values[1].start,end:n.values.values[1].end,severity:2}),1)):0;for([f,b]of rt.instrumentArticulationNames)y.set(f.toLowerCase(),b),y.set(F.toArticulationId(f),b);return 0;case"accidentals":return k._handleAccidentalMode(a,n.values);case"displaytranspose":return r.displayTranspositionPitch=-1*n.values.values[0].value,a.state.staffHasExplicitDisplayTransposition.add(r),0;case"transpose":return r.transpositionPitch=-1*n.values.values[0].value,0;default:return 2}}applyBarMetaData(n,o,h){var e=this._checkValueListTypes(n,[Ot.barMetaDataValueListTypes],h,h.tag.tag.text.toLowerCase(),h.values);if(void 0!==e)return e;switch(h.tag.tag.text.toLowerCase()){case"sync":var l=this._buildSyncPoint(h);return n.state.syncPoints.push(l),0;case"tempo":let e=0,t=h.values.values[e++].value,s="",i=!0,a=0;for(;e<h.values.values.length;){switch(h.values.values[e].nodeType){case 10:case 17:var d=h.values.values[e].text;"hide"===d?i=!1:s=d;break;case 16:a=h.values.values[e].value}e++}let r=o.masterBar.tempoAutomations.find(e=>e.ratioPosition===a);return r||(r=new K,o.masterBar.tempoAutomations.push(r)),r.isLinear=!1,r.type=0,r.value=t,r.text=s,r.ratioPosition=a,r.isVisible=i,0;case"rc":return o.masterBar.repeatCount=h.values.values[0].value,0;case"ae":for(var c of h.values.values)if(16===c.nodeType){var u=c.value;if(u<1||31<u)return n.addSemanticDiagnostic({code:211,message:"Value is out of valid range. Allowed range: %s, Actual Value: %s",severity:2,start:c.start,end:c.end}),1;o.masterBar.alternateEndings|=1<<u-1}else n.addSemanticDiagnostic({code:202,message:`Unexpected '${Rt[c.nodeType]}' token. Expected one of following: `+Rt[16],severity:2,start:c.start,end:c.end});return 0;case"ts":switch(h.values.values[0].nodeType){case 16:o.masterBar.timeSignatureNumerator=h.values.values[0].value,o.masterBar.timeSignatureDenominator=h.values.values[1].value;break;case 10:case 17:var p=h.values.values[0].text;if("common"!==p.toLowerCase())return n.addSemanticDiagnostic({code:209,message:`Unexpected time signature value '${p}', expected: common or two numbers`,severity:2,start:h.values.values[0].start,end:h.values.values[0].end}),1;o.masterBar.timeSignatureCommon=!0,o.masterBar.timeSignatureNumerator=4,o.masterBar.timeSignatureDenominator=4}return 0;case"ks":l=k._parseEnumValue(n,h.values,"key signature",v.keySignatures);return void 0===l?1:void 0===(y=k._parseEnumValue(n,h.values,"key signature type",v.keySignatureTypes))?1:(o.keySignature=l,o.keySignatureType=y,0);case"clef":switch(h.values.values[0].nodeType){case 10:case 17:var m=k._parseEnumValue(n,h.values,"clef",v.clefs);if(void 0===m)return 1;o.clef=m;break;case 16:var g=h.values.values[0].value;switch(g){case 0:o.clef=0;break;case 43:o.clef=4;break;case 65:o.clef=3;break;case 48:o.clef=1;break;case 60:o.clef=2;break;default:return n.addSemanticDiagnostic({code:209,message:`Unexpected clef value '${g}', expected: `+Array.from(v.clefs.keys()).join(","),severity:2,start:h.values.values[0].start,end:h.values.values[0].end}),1}}return 0;case"section":l=new Jt;return 1===h.values.values.length?l.text=h.values.values[0].text:(l.marker=h.values.values[0].text,l.text=h.values.values[1].text),o.masterBar.section=l,0;case"tf":switch(h.values.values[0].nodeType){case 10:case 17:var f=k._parseEnumValue(n,h.values,"triplet feel",v.tripletFeels);if(void 0===f)return 1;o.masterBar.tripletFeel=f;break;case 16:var b=h.values.values[0].value;switch(b){case 0:o.masterBar.tripletFeel=0;break;case 1:o.masterBar.tripletFeel=1;break;case 2:o.masterBar.tripletFeel=2;break;case 3:o.masterBar.tripletFeel=3;break;case 4:o.masterBar.tripletFeel=4;break;case 5:o.masterBar.tripletFeel=5;break;case 6:o.masterBar.tripletFeel=6;break;default:return n.addSemanticDiagnostic({code:209,message:`Unexpected triplet feel value '${b}', expected: `+Array.from(v.tripletFeels.keys()).join(","),severity:2,start:h.values.values[0].start,end:h.values.values[0].end}),1}}return 0;case"barlineleft":var y=k._parseEnumValue(n,h.values,"bar line",v.barLines);return void 0===y?1:(o.barLineLeft=y,0);case"barlineright":l=k._parseEnumValue(n,h.values,"bar line",v.barLines);return void 0===l?1:(o.barLineRight=l,0);case"accidentals":return k._handleAccidentalMode(n,h.values);case"jump":y=k._parseEnumValue(n,h.values,"direction",v.directions);return void 0===y?1:(o.masterBar.addDirection(y),0);case"ottava":l=k._parseEnumValue(n,h.values,"clef ottava",v.ottavia);return void 0===l?1:(o.clefOttava=l,0);case"simile":y=k._parseEnumValue(n,h.values,"simile mark",v.simileMarks);return void 0===y?1:(o.simileMark=y,0);case"width":return o.masterBar.displayWidth=h.values.values[0].value,o.displayWidth=o.masterBar.displayWidth,0;case"scale":return o.masterBar.displayScale=h.values.values[0].value,o.displayScale=o.masterBar.displayScale,0;case"spd":l=new Ce;return l.pedalType=0,l.ratioPosition=h.values.values[0].value,o.sustainPedals.push(l),0;case"spu":y=new Ce;return y.pedalType=2,y.ratioPosition=h.values.values[0].value,o.sustainPedals.push(y),0;case"sph":l=new Ce;return l.pedalType=1,l.ratioPosition=h.values.values[0].value,o.sustainPedals.push(l),0;case"ft":return o.masterBar.isFreeTime=!0,0;case"ro":return o.masterBar.isRepeatStart=!0,0;case"ac":return o.masterBar.isAnacrusis=!0,0;case"db":return o.masterBar.isDoubleBar=!0,o.barLineRight=7,0;default:return 2}}static _handleAccidentalMode(e,t){t=k._parseEnumValue(e,t,"accidental mode",v.accidentalModes);return void 0===t?1:(e.state.accidentalMode=t,0)}static _getChordId(e,t){return t.toLowerCase()+e.index+e.track.index}_buildSyncPoint(e){let t=e.values.values[0].value,s=e.values.values[1].value,i=e.values.values[2].value,a=0;return{barIndex:t,barOccurence:s,barPosition:a=3<e.values.values.length?e.values.values[3].value:a,millisecondOffset:i}}_validateValueListTypes(e,t,s,i){let a=!1,r=0,n=0;var o;if(!i)return!t.some(e=>0===e.parseMode||2===e.parseMode||6===e.parseMode)||(o=k._buildExpectedTypesMessage(t),e.addSemanticDiagnostic({code:210,message:"Missing value. Expected following values: "+o,severity:2,start:s.start,end:s.end}),!1);if(i.validated)return!0;for(;r<t.length;){var h=t[r],l=n<i.values.length?i.values[n]:void 0;if(l&&h.expectedTypes.has(l.nodeType)&&this._checkRestrictions(h,l))switch(h.parseMode){case 5:r=t.length,n++;break;case 7:case 6:n++;break;default:r++,n++}else if(l)switch(h.parseMode){case 7:case 6:r++;break;case 0:case 2:a=!0,e.addSemanticDiagnostic({code:209,message:`Unexpected required value '${Rt[l.nodeType]}', expected: `+k._buildExpectedTypesMessage([h]),severity:2,start:l.start,end:l.end}),r++,n++;break;case 1:case 3:case 4:case 5:r++}else switch(h.parseMode){case 7:case 6:r++;break;case 0:case 2:a=!0,e.addSemanticDiagnostic({code:210,message:"Missing values. Expected following values: "+k._buildExpectedTypesMessage([h]),severity:2,start:i.end,end:i.end}),r=t.length;break;case 1:case 3:case 4:case 5:r++}}if(n<i.values.length)for(;n<i.values.length;){var d=k._buildExpectedTypesMessage(t),c=i.values[n];e.addSemanticDiagnostic({code:209,message:`Unexpected additional value '${Rt[c.nodeType]}', expected: `+d,severity:2,start:c.start,end:c.end}),n++}return!a}_checkRestrictions(e,t){switch(t.nodeType){case 10:var s=t;return e?.allowedValues?e.allowedValues.has(s.text.toLowerCase()):!e?.reservedIdentifiers||!e.reservedIdentifiers.has(s.text.toLowerCase());case 17:s=t;return!e?.allowedValues||e.allowedValues.has(s.text.toLowerCase());default:return!0}}_headerFooterStyle(e,t,s,i,a=1){var r=i.values.values.length-a;r<1||(void 0===(t=F.getOrCreateHeaderFooterStyle(t,s)).isVisible&&(t.isVisible=!0),(s=i.values.values[a].text)?t.template=s:t.isVisible=!1,r<2)||void 0!==(s=k._parseEnumValue(e,i.values,"textAlign",v.textAligns,a+1))&&(t.textAlign=s)}static _buildExpectedTypesMessage(e){var t,s=[];for(t of e){var i=Array.from(t.expectedTypes).map(e=>Rt[e]).join("|");switch(t.parseMode){case 0:case 2:s.push(`required(${i})`);break;case 1:case 3:s.push(`optional(${i})`);break;case 5:s.push(`only(${i})`);break;case 7:s.push(`listOf(${i})`)}}return s.join(",")}_readTrackInstrument(e,t,s){switch(s.values[0].nodeType){case 16:var i=s.values[0].value;0<=i&&i<=127?t.playbackInfo.program=i:e.addSemanticDiagnostic({code:211,message:"Value is out of valid range. Allowed range: 0-127, Actual Value: "+i,start:s.values[0].start,end:s.values[0].end,severity:2});break;case 10:case 17:i=s.values[0].text.toLowerCase();if("percussion"===i){for(var a of t.staves)e.applyStaffNoteKind(a,2);t.playbackInfo.primaryChannel=_.PercussionChannel,t.playbackInfo.secondaryChannel=_.PercussionChannel}else t.playbackInfo.program=Wt.getValue(i)}}_chordProperties(e,t,s){if(s.properties)for(var i of s.properties.properties)if(this._checkProperty(e,[Ot.chordPropertyValueListTypes],i))switch(i.property.text.toLowerCase()){case"firstfret":t.firstFret=i.values.values[0].value;break;case"showdiagram":t.showDiagram=k._booleanLikeValue(i.values.values,0);break;case"showfingering":t.showFingering=k._booleanLikeValue(i.values.values,0);break;case"showname":t.showName=k._booleanLikeValue(i.values.values,0);break;case"barre":t.barreFrets=i.values.values.map(e=>e.value)}}_tuningProperties(e,t,s,i){if(i.properties)for(var a of i.properties.properties)if(this._checkProperty(e,[Ot.tuningPropertyValueListTypes],a))switch(a.property.text.toLowerCase()){case"hide":t.track.score.stylesheet.perTrackDisplayTuning||(t.track.score.stylesheet.perTrackDisplayTuning=new Map),t.track.score.stylesheet.perTrackDisplayTuning.set(t.track.index,!1);break;case"label":s.name=a.values.values[0].text}}static _booleanLikeValue(e,t){if(t>=e.length)return!0;var s=e[t];switch(s.nodeType){case 17:case 10:return"false"!==s.text;case 16:return 0!==s.value;default:return!1}}applyStructuralMetaData(e,t){switch(t.tag.tag.text.toLowerCase()){case"staff":var s=e.startNewStaff();return this._staffProperties(e,s,t),1;case"track":s=e.startNewTrack();return t.values&&0<t.values.values.length&&(s.name=t.values.values[0].text,1<t.values.values.length)&&(s.shortName=t.values.values[1].text),this._trackProperties(e,s,t),0;case"voice":return e.startNewVoice(),2;default:return 4}}_checkProperty(e,t,s){var i=this._checkValueListTypes(e,t,s,s.property.text.toLowerCase(),s.values);if(void 0!==i)switch(i){case 0:case 1:return!1;case 2:var a=t.flatMap(e=>Array.from(e.keys()));return e.addSemanticDiagnostic({code:212,message:`Unrecogized property '${s.property.text}', expected one of `+a,severity:2,start:s.start,end:s.end}),!1}return!0}_staffProperties(a,r,n){if(n.properties){let e=!1,t=!1,s=!1,i=!1;for(var o of n.properties.properties)if(this._checkProperty(a,[Ot.staffPropertyValueListTypes],o))switch(o.property.text.toLowerCase()){case"score":e=!0,o.values&&0<o.values.values.length&&(r.standardNotationLineCount=o.values.values[0].value);break;case"tabs":t=!0;break;case"slash":s=!0;break;case"numbered":i=!0}(e||t||s||i)&&(r.showStandardNotation=e,r.showTablature=t,r.showSlash=s,r.showNumbered=i)}}_trackProperties(e,t,s){if(s.properties)for(var i of s.properties.properties)if(this._checkProperty(e,[Ot.trackPropertyValueListTypes],i))switch(i.property.text.toLowerCase()){case"color":try{t.color=Ut.fromJson(i.values.values[0].text)}catch{e.addSemanticDiagnostic({code:213,message:"Invalid format for color",severity:2,start:i.values.values[0].start,end:i.values.values[0].end})}break;case"defaultsystemslayout":t.defaultSystemsLayout=i.values.values[0].value;break;case"systemslayout":t.systemsLayout=i.values.values.map(e=>e.value);break;case"volume":t.playbackInfo.volume=i.values.values[0].value;break;case"balance":t.playbackInfo.balance=i.values.values[0].value;break;case"mute":t.playbackInfo.isMute=!0;break;case"solo":t.playbackInfo.isSolo=!0;break;case"multibarrest":t.score.stylesheet.perTrackMultiBarRest||(t.score.stylesheet.perTrackMultiBarRest=new Set),t.score.stylesheet.perTrackMultiBarRest.add(t.index);break;case"instrument":this._readTrackInstrument(e,t,i.values);break;case"bank":t.playbackInfo.bank=i.values.values[0].value}}applyBeatDurationProperty(e,t){var s,i=this._checkValueListTypes(e,[Ot.beatDurationPropertyValueListTypes],t,t.property.text.toLowerCase(),t.values);return void 0!==i?i:"tu"===t.property.text.toLowerCase()?(2===t.values.values.length?(e.state.currentTupletNumerator=t.values.values[0].value,e.state.currentTupletDenominator=t.values.values[1].value):(i=t.values.values[0].value,e.state.currentTupletNumerator=i,(s=k._getTupletDenominator(i))<0?(e.addSemanticDiagnostic({code:209,message:`Unexpected default tuplet value '${i}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:2,start:t.values.values[0].start,end:t.values.values[0].end}),e.state.currentTupletNumerator=-1,e.state.currentTupletDenominator=-1):e.state.currentTupletDenominator=s),0):2}static _getTupletDenominator(e){switch(e){case 3:return 2;case 5:case 6:case 7:return 4;case 9:case 10:case 11:case 12:return 8;default:return-1}}get allKnownMetaDataTags(){if(!this._allKnownBarMetaDataTags){var e;this._allKnownBarMetaDataTags=new Set;for(e of[Ot.scoreMetaDataValueListTypes.keys(),Ot.structuralMetaDataValueListTypes.keys(),Ot.staffMetaDataValueListTypes.keys(),Ot.barMetaDataValueListTypes.keys()])for(var t of e)this._allKnownBarMetaDataTags.add(t)}return this._allKnownBarMetaDataTags}get knownScoreMetaDataTags(){return this._knownScoreMetaDataTags||(this._knownScoreMetaDataTags=new Set(Ot.scoreMetaDataValueListTypes.keys())),this._knownScoreMetaDataTags}get knownStructuralMetaDataTags(){return this._knownStructuralMetaDataTags||(this._knownStructuralMetaDataTags=new Set(Ot.structuralMetaDataValueListTypes.keys())),this._knownStructuralMetaDataTags}get knownBarMetaDataTags(){return this._knownBarMetaDataTags||(this._knownBarMetaDataTags=new Set(Ot.barMetaDataValueListTypes.keys())),this._knownBarMetaDataTags}get knownStaffMetaDataTags(){return this._knownStaffMetaDataTags||(this._knownStaffMetaDataTags=new Set(Ot.staffMetaDataValueListTypes.keys())),this._knownStaffMetaDataTags}get knownBeatDurationProperties(){return this._knownBeatDurationProperties||(this._knownBeatDurationProperties=new Set(Ot.beatDurationPropertyValueListTypes.keys())),this._knownBeatDurationProperties}get knownBeatProperties(){return this._knownBeatProperties||(this._knownBeatProperties=new Set(Ot.beatPropertyValueListTypes.keys())),this._knownBeatProperties}get knownNoteProperties(){return this._knownNoteProperties||(this._knownNoteProperties=new Set(Ot.notePropertyValueListTypes.keys())),this._knownNoteProperties}applyBeatProperty(o,h,l){var d=l.property.text.toLowerCase(),e=this._checkValueListTypes(o,[Ot.beatPropertyValueListTypes],l,d,l.values);if(void 0!==e)return e;switch(d){case"f":return h.fade=1,0;case"fo":return h.fade=2,0;case"vs":return h.fade=3,0;case"v":return h.vibrato=1,0;case"vw":return h.vibrato=2,0;case"s":return h.slap=!0,0;case"p":return h.pop=!0,0;case"tt":return h.tap=!0,0;case"txt":return h.text=l.values.values[0].text,0;case"lyrics":let e=0,t="";for(t=(2===l.values.values.length?(e=l.values.values[0].value,l.values.values[1]):l.values.values[0]).text,h.lyrics||(h.lyrics=[]);h.lyrics.length<=e;)h.lyrics.push("");return h.lyrics[e]=t,0;case"dd":return h.dots=2,0;case"d":return h.dots=1,0;case"su":return h.pickStroke=1,0;case"sd":return h.pickStroke=2,0;case"tu":if(2===l.values.values.length)h.tupletNumerator=l.values.values[0].value,h.tupletDenominator=l.values.values[1].value;else{var c=l.values.values[0].value,u=(h.tupletNumerator=c,k._getTupletDenominator(c));if(u<0)return o.addSemanticDiagnostic({code:209,message:`Unexpected default tuplet value '${c}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:2,start:l.values.values[0].start,end:l.values.values[0].end}),h.tupletNumerator=-1,h.tupletDenominator=-1,1;h.tupletDenominator=u}return 0;case"tb":case"tbe":let s=0;switch(l.values.values[s].nodeType){case 10:case 17:var p=k._parseEnumValue(o,l.values,"whammy type",v.whammyTypes,s);if(void 0===p)return 1;h.whammyBarType=p,s++}switch(l.values.values[s].nodeType){case 10:case 17:var m=k._parseEnumValue(o,l.values,"whammy style",v.bendStyles,s);if(void 0===m)return 1;h.whammyStyle=m,s++}c=this._getBendPoints(o,l,s,"tbe"===d);if(c)for(var g of c)h.addWhammyBarPoint(g);return 0;case"bu":return k._applyBrush(h,l,1,.25),0;case"bd":return k._applyBrush(h,l,2,.25),0;case"au":return k._applyBrush(h,l,3,1),0;case"ad":return k._applyBrush(h,l,4,1),0;case"ch":var u=h.voice.bar.staff,c=l.values.values[0].text,f=k._getChordId(u,c);return u.hasChord(f)||((b=new Ht).showDiagram=!1,b.name=c,u.addChord(f,b)),o.state.currentChordId=f,k.applyChordToBeat(h,f,!0),0;case"gr":if(l.values&&0<l.values.values.length){c=k._parseEnumValue(o,l.values,"whammy style",v.graceTypes);if(void 0===c)return 1;h.graceType=c}else h.graceType=2;return 0;case"dy":u=k._parseEnumValue(o,l.values,"dynamic",v.dynamics);return void 0===u?1:(h.dynamics=u,o.state.currentDynamics=u,0);case"cre":return h.crescendo=1,0;case"dec":return h.crescendo=2,0;case"tempo":let i=l.values.values[0].value,a="",r=!0;if(2<l.values.values.length){a=l.values.values[1].text;var b=l.values.values[2].text;if("hide"!==b)return o.addSemanticDiagnostic({code:209,message:`Unexpected third tempo property value '${b}', expected: 'hide'`,severity:2,start:l.values.values[2].start,end:l.values.values[2].end}),1;r=!1}else 1<l.values.values.length&&"hide"===(a=l.values.values[1].text)&&(r=!1,a="");f=new K;return f.isLinear=!1,f.type=0,f.value=i,f.text=a,f.isVisible=r,h.automations.push(f),h.voice.bar.masterBar.tempoAutomations.push(f),0;case"volume":c=new K;return c.isLinear=!0,c.type=1,c.value=l.values.values[0].value,h.automations.push(c),0;case"balance":u=new K;return u.isLinear=!0,u.type=3,u.value=F.clamp(l.values.values[0].value,0,16),h.automations.push(u),0;case"tp":if(h.tremoloSpeed=8,l.values&&0<l.values.values.length){var y=l.values.values[0].value;switch(y){case 8:h.tremoloSpeed=8;break;case 16:h.tremoloSpeed=16;break;case 32:h.tremoloSpeed=32;break;default:return o.addSemanticDiagnostic({code:209,message:`Unexpected tremolo speed value '${y}, expected: 8, 16 or 32`,severity:2,start:l.values.values[0].start,end:l.values.values[0].end}),1}}return 0;case"spd":return k._applySustainPedal(o,h,0),0;case"sph":return k._applySustainPedal(o,h,1),0;case"spu":return k._applySustainPedal(o,h,2),0;case"spe":return k._applySustainPedal(o,h,2,!0),0;case"slashed":return h.slashed=!0,0;case"ds":return h.deadSlapped=!0,1===h.notes.length&&h.notes[0].isDead&&h.removeNote(h.notes[0]),0;case"glpf":return h.golpe=2,0;case"glpt":return h.golpe=1,0;case"waho":return h.wahPedal=1,0;case"wahc":return h.wahPedal=2,0;case"barre":if(h.barreFret=l.values.values[0].value,(h.barreShape=1)<l.values.values.length){b=k._parseEnumValue(o,l.values,"barre shape",v.barreShapes,1);if(void 0===b)return 1;h.barreShape=b}return 0;case"rasg":f=k._parseEnumValue(o,l.values,"rasgueado pattern",v.rasgueadoPatterns);return void 0===f?1:(h.rasgueado=f,0);case"ot":c=k._parseEnumValue(o,l.values,"ottava",v.ottava);return void 0===c?1:(h.ottava=c,0);case"legatoorigin":return h.isLegatoOrigin=!0,0;case"instrument":let n=0;switch(l.values.values[0].nodeType){case 10:case 17:n=Wt.getValue(l.values.values[0].text);break;case 16:n=l.values.values[0].value}u=new K;return u.isLinear=!1,u.type=2,u.value=n,h.automations.push(u),0;case"bank":b=new K;return b.isLinear=!1,b.type=4,b.value=l.values.values[0].value,h.automations.push(b),0;case"fermata":f=k._parseEnumValue(o,l.values,"fermata",v.fermataTypes);return void 0===f?1:((c=new At).type=f,1<l.values.values.length&&(c.length=l.values.values[1].value),h.fermata=c,0);case"beam":var _=l.values.values[0].text;switch(_.toLowerCase()){case"invert":h.invertBeamDirection=!0;break;case"up":h.preferredBeamDirection=0;break;case"down":h.preferredBeamDirection=1;break;case"auto":h.beamingMode=0;break;case"split":h.beamingMode=1;break;case"merge":h.beamingMode=2;break;case"splitsecondary":h.beamingMode=3;break;default:var S=["invert","up","down","auto","split","merge","splitsecondary"];return o.addSemanticDiagnostic({code:209,message:`Unexpected beam value '${_}', expected: `+S.join(","),severity:2,start:l.values.values[0].start,end:l.values.values[0].end}),1}return 0;case"timer":return h.showTimer=!0,0}return 2}static _applySustainPedal(e,t,s,i=!1){var a=new Ce;a.pedalType=s,a.ratioPosition=i?1:.001*t.voice.bar.sustainPedals.length,e.state.sustainPedalToBeat.set(a,t),t.voice.bar.sustainPedals.push(a)}static _applyBrush(e,t,s,i){e.brushType=s,t.values&&0<t.values.values.length?e.brushDuration=t.values.values[0].value:(e.updateDurations(),e.brushDuration=e.playbackDuration*i/e.notes.length)}applyNoteProperty(r,n,o){var h=o.property.text.toLowerCase(),e=this._checkValueListTypes(r,[Ot.notePropertyValueListTypes],o,h,o.values);if(void 0!==e)return e;switch(h){case"b":case"be":let e=0;switch(o.values.values[e].nodeType){case 10:case 17:var l=k._parseEnumValue(r,o.values,"bend type",v.bendTypes,e);if(void 0===l)return 1;n.bendType=l,e++}switch(o.values.values[e].nodeType){case 10:case 17:var d=k._parseEnumValue(r,o.values,"bend style",v.bendStyles,e);if(void 0===d)return 1;n.bendStyle=d,e++}var c=this._getBendPoints(r,o,e,"be"===h);if(c)for(var u of c)n.addBendPoint(u);return 0;case"nh":return n.harmonicType=1,n.harmonicValue=F.deltaFretToHarmonicValue(n.fret),0;case"ah":return n.harmonicType=2,n.harmonicValue=k._harmonicValue(o.values,n.harmonicValue),0;case"th":return n.harmonicType=4,n.harmonicValue=k._harmonicValue(o.values,n.harmonicValue),0;case"ph":return n.harmonicType=3,n.harmonicValue=k._harmonicValue(o.values,n.harmonicValue),0;case"sh":return n.harmonicType=5,n.harmonicValue=k._harmonicValue(o.values,n.harmonicValue),0;case"fh":return n.harmonicType=6,n.harmonicValue=k._harmonicValue(o.values,n.harmonicValue),0;case"tr":let t=o.values.values[0].value,s=16;if(1<o.values.values.length){var p=o.values.values[1].value;switch(p){case 16:s=16;break;case 32:s=32;break;case 64:s=64;break;default:return r.addSemanticDiagnostic({code:209,message:`Unexpected trill duration value '${p}', expected: 16, 32 or 64`,severity:2,start:o.values.values[1].start,end:o.values.values[1].end}),1}}return n.trillValue=t+n.stringTuning,n.trillSpeed=s,0;case"v":return n.vibrato=1,0;case"vw":return n.vibrato=2,0;case"sl":return n.slideOutType=2,0;case"ss":return n.slideOutType=1,0;case"sib":return n.slideInType=1,0;case"sia":return n.slideInType=2,0;case"sou":return n.slideOutType=3,0;case"sod":return n.slideOutType=4,0;case"psd":return n.slideOutType=5,0;case"psu":return n.slideOutType=6,0;case"h":return n.isHammerPullOrigin=!0,0;case"lht":return n.isLeftHandTapped=!0,0;case"g":return n.isGhost=!0,0;case"ac":return n.accentuated=1,0;case"hac":return n.accentuated=2,0;case"ten":return n.accentuated=3,0;case"pm":return n.isPalmMute=!0,0;case"st":return n.isStaccato=!0,0;case"lr":return n.isLetRing=!0,0;case"x":return n.isDead=!0,0;case"-":case"t":return n.isTieDestination=!0,0;case"lf":let i=0;if(o.values&&0<o.values.values.length){c=k._toFinger(r,o.values);if(void 0===c)return 1;i=c}return n.leftHandFinger=i,0;case"rf":let a=0;if(o.values&&0<o.values.values.length){c=k._toFinger(r,o.values);if(void 0===c)return 1;a=c}return n.rightHandFinger=a,0;case"acc":return n.accidentalMode=F.parseAccidentalMode(o.values.values[0].text),0;case"turn":return n.ornament=2,0;case"iturn":return n.ornament=1,0;case"umordent":return n.ornament=3,0;case"lmordent":return n.ornament=4,0;case"string":return n.showStringNumber=!0,0;case"hide":return n.isVisible=!1,0;case"slur":var m,c=o.values.values[0].text;return r.state.slurs.has(c)?(((m=r.state.slurs.get(c)).slurDestination=n).slurOrigin=m,n.isSlurDestination=!0):r.state.slurs.set(c,n),0;default:return this.applyBeatProperty(r,n.beat,o)}return 2}static _toFinger(e,t){var s=t.values[0].value;switch(s){case 1:return 0;case 2:return 1;case 3:return 2;case 4:return 3;case 5:return 4;default:return void e.addSemanticDiagnostic({code:211,message:"Value is out of valid range. Allowed range: 1-5, Actual Value: "+s,start:t.values[0].start,end:t.values[0].end,severity:2})}}static _harmonicValue(e,t){return t=e?e.values[0].value:t}_getBendPoints(e,t,a,r){let n=t.values.values,s=n.length-a,i=t.values;0<s&&13===n[a].nodeType&&(n=n[a].values,a=0,s=n.length,i=n[a]);var o,h=r?2:1;if(s%h!=0)o=Math.ceil(s/h),e.addSemanticDiagnostic({code:214,message:`The '${t.property.text}' effect needs ${h} values per item. With ${o} points, ${o*h} values are needed, only ${s} values found.`,severity:2,start:i.end,end:i.end});else{let i=[],s=a;for(;s<n.length;){let e=0,t=0;t=(e=r?n[s++].value:0,n[s++].value),i.push(new w(e,t))}if(0<i.length){if(60<i.length&&i.splice(60,i.length-60),r)i.sort((e,t)=>e.offset-t.offset);else{let e=i.length,t=w.MaxPosition/(e-1)|0,s=0;for(;s<e;)i[s].offset=Math.min(w.MaxPosition,s*t),s++}return i}}}static _parseEnumValue(e,t,s,i,a=0){var r;if(!(a>=t.values.length))return r=t.values[a].text,i.has(r.toLowerCase())?i.get(r.toLowerCase()):void e.addSemanticDiagnostic({code:209,message:`Unexpected ${s} value '${r}', expected: `+Array.from(i.keys()).join(","),severity:2,start:t.values[a].start,end:t.values[a].end})}buildScoreMetaDataNodes(e){var t=[];return k._buildScoreInfoMeta(t,"album",e,e.album,3),k._buildScoreInfoMeta(t,"artist",e,e.artist,2),k._buildScoreInfoMeta(t,"copyright",e,e.copyright,8),k._buildScoreInfoMeta(t,"copyright2",e,void 0,9),k._buildScoreInfoMeta(t,"wordsandmusic",e,void 0,6,!0),k._buildScoreInfoMeta(t,"instructions",e,e.instructions,void 0),k._buildScoreInfoMeta(t,"music",e,e.music,5),k._buildScoreInfoMeta(t,"notices",e,e.notices,void 0),k._buildScoreInfoMeta(t,"subtitle",e,e.subTitle,1),k._buildScoreInfoMeta(t,"title",e,e.title,0),k._buildScoreInfoMeta(t,"words",e,e.words,4),k._buildScoreInfoMeta(t,"tab",e,e.tab,7),e.defaultSystemsLayout!==k._defaultScore.defaultSystemsLayout&&t.push(p.numberMeta("defaultSystemsLayout",e.defaultSystemsLayout)),0<e.systemsLayout.length&&t.push(p.meta("systemsLayout",p.values(e.systemsLayout.map(e=>p.number(e))))),k._buildStyleSheetMetaData(t,e.stylesheet),0<t.length&&(t[0].leadingComments=[{text:"Score Metadata",multiLine:!1}]),t}static _buildStyleSheetMetaData(e,t){var s=e.length;t.hideDynamics&&e.push(p.meta("hideDynamics")),t.bracketExtendMode!==k._defaultScore.stylesheet.bracketExtendMode&&e.push(p.identMeta("bracketExtendMode",v.bracketExtendModesReversed.get(t.bracketExtendMode))),t.useSystemSignSeparator&&e.push(p.meta("useSystemSignSeparator")),t.multiTrackMultiBarRest&&e.push(p.meta("multiBarRest")),t.singleTrackTrackNamePolicy!==k._defaultScore.stylesheet.singleTrackTrackNamePolicy&&e.push(p.identMeta("singleTrackTrackNamePolicy",v.trackNamePoliciesReversed.get(t.singleTrackTrackNamePolicy))),t.multiTrackTrackNamePolicy!==k._defaultScore.stylesheet.multiTrackTrackNamePolicy&&e.push(p.identMeta("multiTrackTrackNamePolicy",v.trackNamePoliciesReversed.get(t.multiTrackTrackNamePolicy))),t.firstSystemTrackNameMode!==k._defaultScore.stylesheet.firstSystemTrackNameMode&&e.push(p.identMeta("firstSystemTrackNameMode",v.trackNameModeReversed.get(t.firstSystemTrackNameMode))),t.otherSystemsTrackNameMode!==k._defaultScore.stylesheet.otherSystemsTrackNameMode&&e.push(p.identMeta("otherSystemsTrackNameMode",v.trackNameModeReversed.get(t.otherSystemsTrackNameMode))),t.firstSystemTrackNameOrientation!==k._defaultScore.stylesheet.firstSystemTrackNameOrientation&&e.push(p.identMeta("firstSystemTrackNameOrientation",v.trackNameOrientationsReversed.get(t.firstSystemTrackNameOrientation))),t.otherSystemsTrackNameOrientation!==k._defaultScore.stylesheet.otherSystemsTrackNameOrientation&&e.push(p.identMeta("otherSystemsTrackNameOrientation",v.trackNameOrientationsReversed.get(t.otherSystemsTrackNameOrientation))),s<e.length&&(e[s].leadingComments=[{multiLine:!1,text:"Score Stylesheet"}])}static _buildScoreInfoMeta(e,t,s,i,a,r=!1){void 0!==i&&0===i.length&&!r||(r=[],void 0!==i&&r.push(p.string(i)),void 0!==a&&(s=s.style&&s.style.headerAndFooter.has(a)?s.style.headerAndFooter.get(a):void 0,a=Je.defaultHeaderAndFooter.has(a)?Je.defaultHeaderAndFooter.get(a):void 0,!s||a&&Xe.equals(a,s)||(r.push(p.string(!1===s.isVisible?"":s.template)),r.push(p.ident(v.textAlignsReversed.get(s.textAlign))))),void 0===i&&0===r.length)||void 0!==i&&0===i.length&&1===r.length||e.push(p.meta(t,p.values(r)))}buildSyncPointNodes(e){var t,s=[];for(t of e.exportFlatSyncPoints())s.push(p.meta("sync",p.values([p.number(t.barIndex),p.number(t.barOccurence),p.number(t.millisecondOffset),0<t.barPosition?p.number(t.barPosition):void 0])));return s}buildBarMetaDataNodes(e,t,s,i){var a=[];if(k._buildStructuralMetaDataNodes(t,e,a,i,s),t){0===s&&0===e.index&&0===e.track.index&&k._buildMasterBarMetaDataNodes(a,t.masterBar);var r,i=a.length;0===s&&0===t.index&&0===e.index&&0===e.track.index&&a.push(p.identMeta("accidentals","auto")),0!==t.index&&t.clef===t.previousBar?.clef||a.push(p.identMeta("clef",v.clefsReversed.get(t.clef))),(0===t.index&&2!==t.clefOttava||t.clefOttava!==t.previousBar?.clefOttava)&&a.push(p.identMeta("ottava",v.ottavaReversed.get(t.clefOttava))),(0===t.index&&0!==t.simileMark||t.simileMark!==t.previousBar?.simileMark)&&a.push(p.identMeta("simile",v.simileMarksReversed.get(t.simileMark))),1!==t.displayScale&&a.push(p.numberMeta("scale",t.displayScale)),0<t.displayWidth&&a.push(p.numberMeta("width",t.displayWidth));for(r of t.sustainPedals){let e="";switch(r.pedalType){case 0:e="spd";break;case 1:e="sph";break;case 2:e="spu"}e&&a.push(p.numberMeta(e,r.ratioPosition))}if(0!==t.barLineLeft&&a.push(p.identMeta("barLineLeft",v.barLinesReversed.get(t.barLineLeft))),0!==t.barLineRight&&a.push(p.identMeta("barLineRight",v.barLinesReversed.get(t.barLineRight))),0===t.index||t.keySignature!==t.previousBar.keySignature||t.keySignatureType!==t.previousBar.keySignatureType){let e="";e=(1===t.keySignatureType?v.keySignaturesMinorReversed:v.keySignaturesMajorReversed).get(t.keySignature),a.push(p.identMeta("ks",e))}i<a.length&&(a[i].leadingComments=[{multiLine:!1,text:`Bar ${t.index+1} Metadata`}])}return a}static _buildStaffMetaDataNodes(e,t){var s=e.length,i=(0!==t.capo&&e.push(p.numberMeta("capo",t.capo)),t.isPercussion?e.push(p.identMeta("articulation","defaults")):t.isStringed&&(i=p.meta("tuning",p.values(t.stringTuning.tunings.map(e=>p.ident(qt.getTextForTuning(e,!0))))),e.push(i),t.track.score.stylesheet.perTrackDisplayTuning&&t.track.score.stylesheet.perTrackDisplayTuning.has(t.track.index)&&(i.properties=p.props([["hide",void 0]])),0<t.stringTuning.name.length)&&(i.properties??(i.properties=p.props([])),p.prop(i.properties.properties,"label",p.stringValue(t.stringTuning.name))),0!==t.transpositionPitch&&e.push(p.numberMeta("transpose",-t.transpositionPitch)),F.displayTranspositionPitches.has(t.track.playbackInfo.program)?F.displayTranspositionPitches.get(t.track.playbackInfo.program):0);if(t.displayTranspositionPitch!==i&&e.push(p.numberMeta("displaytranspose",-t.displayTranspositionPitch)),null!=t.chords)for(var[a,r]of t.chords)e.push(k._buildChordNode(r));s<e.length&&(e[s].leadingComments=[{multiLine:!1,text:`Staff ${t.index+1} Metadata`}])}static _buildChordNode(t){var s=p.meta("chord",p.stringValue(t.name),p.props([0<=t.firstFret?["firstfret",p.numberValue(t.firstFret)]:void 0,["showdiagram",p.identValue(t.showDiagram?"true":"false")],["showfingering",p.identValue(t.showFingering?"true":"false")],["showname",p.identValue(t.showName?"true":"false")],0<t.barreFrets.length?["barre",p.values(t.barreFrets.map(e=>p.number(e)))]:void 0]));s.propertiesBeforeValues=!0;for(let e=0;e<t.staff.tuning.length;e++)e<t.strings.length&&0<=t.strings[e]?s.values.values.push(p.number(t.strings[e])):s.values.values.push(p.ident("x"));return s}static _buildMasterBarMetaDataNodes(e,t){var s,i=e.length;if(0!==t.alternateEndings&&e.push(p.meta("ae",p.values(F.getAlternateEndingsList(t.alternateEndings).map(e=>p.number(e+1))))),t.isRepeatStart&&e.push(p.meta("ro")),t.isRepeatEnd&&e.push(p.numberMeta("rc",t.repeatCount)),0!==t.index&&t.timeSignatureCommon===t.previousMasterBar?.timeSignatureCommon&&t.timeSignatureNumerator===t.previousMasterBar.timeSignatureNumerator&&t.timeSignatureDenominator===t.previousMasterBar.timeSignatureDenominator||(t.timeSignatureCommon?e.push(p.identMeta("ts","common")):e.push(p.meta("ts",p.values([p.number(t.timeSignatureNumerator),p.number(t.timeSignatureDenominator)])))),(0<t.index&&t.tripletFeel!==t.previousMasterBar?.tripletFeel||0===t.index&&0!==t.tripletFeel)&&e.push(p.identMeta("tf",v.tripletFeelsReversed.get(t.tripletFeel))),t.isFreeTime&&e.push(p.meta("ft")),null!=t.section&&e.push(p.meta("section",p.values([p.string(t.section.marker),p.string(t.section.text)]))),t.isAnacrusis&&e.push(p.meta("ac")),1!==t.displayScale&&e.push(p.numberMeta("scale",t.displayScale)),0<t.displayWidth&&e.push(p.numberMeta("width",t.displayWidth)),t.directions)for(var a of t.directions)e.push(p.identMeta("jump",v.directionsReversed.get(a)));for(s of t.tempoAutomations){var r=p.meta("tempo",p.values([p.number(s.value),s.text?p.string(s.text):void 0,0<s.ratioPosition?p.number(s.ratioPosition):void 0,s.isVisible?void 0:p.ident("hide")]));1===r.values.values.length&&(r.values.openParenthesis=void 0,r.values.closeParenthesis=void 0),e.push(r)}i<e.length&&(e[i].leadingComments=[{multiLine:!1,text:`Masterbar ${t.index+1} Metadata`}])}static _buildStructuralMetaDataNodes(e,t,s,i,a){void 0!==e&&0!==e.index||(0===a&&(0===t.index&&s.push(k._buildNewTrackNode(t.track)),s.push(k._buildNewStaffNode(t)),k._buildStaffMetaDataNodes(s,t)),!i)||((e=p.meta("voice")).trailingComments=[{multiLine:!0,text:"Voice "+(a+1)}],s.push(e))}static _buildNewStaffNode(e){e=p.meta("staff",void 0,p.props([e.showStandardNotation?["score",p.values([e.standardNotationLineCount!==$t.DefaultStandardNotationLineCount?p.number(e.standardNotationLineCount):void 0])]:void 0,e.showTablature?["tabs",void 0]:void 0,e.showSlash?["slash",void 0]:void 0,e.showNumbered?["numbered",void 0]:void 0]));return e.properties&&0<e.properties.properties.length&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Staff Properties"}]),e}static _buildNewTrackNode(e){e=p.meta("track",p.values([p.string(e.name),0<e.shortName.length?p.string(e.shortName):void 0]),p.props([e.color.rgba!==k._defaultTrack.color.rgba?["color",p.stringValue(e.color.rgba)]:void 0,e.defaultSystemsLayout!==k._defaultTrack.defaultSystemsLayout?["defaultSystemsLayout",p.numberValue(e.defaultSystemsLayout)]:void 0,e.systemsLayout.length?["systemsLayout",p.values(e.systemsLayout.map(e=>p.number(e)))]:void 0,["volume",p.numberValue(e.playbackInfo.volume)],["balance",p.numberValue(e.playbackInfo.balance)],e.playbackInfo.isMute?["mute",void 0]:void 0,e.playbackInfo.isSolo?["solo",void 0]:void 0,e.score.stylesheet.perTrackMultiBarRest&&e.score.stylesheet.perTrackMultiBarRest.has(e.index)?["multiBarRest",void 0]:void 0,["instrument",p.identValue(e.isPercussion?"percussion":Wt.getName(e.playbackInfo.program))],0<e.playbackInfo.bank?["bank",p.numberValue(e.playbackInfo.bank)]:void 0]));return e.properties&&0<e.properties.properties.length&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Track Properties"}]),e}buildNoteEffects(e){var t,s=[];if(e.hasBend){var i,a=p.values([p.ident(v.bendTypesReversed.get(e.bendType)),0!==e.bendStyle?p.ident(v.bendStylesReversed.get(e.bendStyle)):void 0],!0);for(i of e.bendPoints)a.values.push(p.number(i.offset)),a.values.push(p.number(i.value));p.prop(s,"be",a)}let r="";switch(e.harmonicType){case 1:p.prop(s,"nh");break;case 2:r="ah";break;case 3:r="ph";break;case 4:r="th";break;case 5:r="sh";break;case 6:r="fh"}switch(r&&p.prop(s,r,p.numberValue(e.harmonicValue)),e.showStringNumber&&p.prop(s,"string"),e.isTrill&&p.prop(s,"tr",p.values([p.number(e.trillFret),p.number(e.trillSpeed)])),e.vibrato){case 1:p.prop(s,"v");break;case 2:p.prop(s,"vw")}switch(e.slideInType){case 1:p.prop(s,"sib");break;case 2:p.prop(s,"sia")}switch(e.slideOutType){case 1:p.prop(s,"ss");break;case 2:p.prop(s,"sl");break;case 3:p.prop(s,"sou");break;case 4:p.prop(s,"sod");break;case 5:p.prop(s,"psd");break;case 6:p.prop(s,"psu")}switch(e.isHammerPullOrigin&&p.prop(s,"h"),e.isLeftHandTapped&&p.prop(s,"lht"),e.isGhost&&p.prop(s,"g"),e.accentuated){case 1:p.prop(s,"ac");break;case 2:p.prop(s,"hac");break;case 3:p.prop(s,"ten")}switch(e.isPalmMute&&p.prop(s,"pm"),e.isStaccato&&p.prop(s,"st"),e.isLetRing&&p.prop(s,"lr"),e.isDead&&p.prop(s,"x"),e.isTieDestination&&p.prop(s,"t"),0<=e.leftHandFinger&&p.prop(s,"lf",p.numberValue(e.leftHandFinger+1)),0<=e.rightHandFinger&&p.prop(s,"rf",p.numberValue(e.rightHandFinger+1)),e.isVisible||p.prop(s,"hide"),e.isSlurOrigin&&(t="s"+e.id,p.prop(s,"slur",p.identValue(t))),e.isSlurDestination&&(t="s"+e.slurOrigin.id,p.prop(s,"slur",p.identValue(t))),0!==e.accidentalMode&&p.prop(s,"acc",p.identValue(F.reverseAccidentalModeMapping.get(e.accidentalMode))),e.ornament){case 1:p.prop(s,"iturn");break;case 2:p.prop(s,"turn");break;case 3:p.prop(s,"umordent");break;case 4:p.prop(s,"lmordent")}return s}buildBeatEffects(t){var e,s=[];switch(t.fade){case 1:p.prop(s,"f");break;case 2:p.prop(s,"fo");break;case 3:p.prop(s,"vs")}if(1===t.vibrato?p.prop(s,"v"):2===t.vibrato&&p.prop(s,"vw"),t.slap&&p.prop(s,"s"),t.pop&&p.prop(s,"p"),t.tap&&p.prop(s,"tt"),2<=t.dots?p.prop(s,"dd"):0<t.dots&&p.prop(s,"d"),1===t.pickStroke?p.prop(s,"su"):2===t.pickStroke&&p.prop(s,"sd"),t.hasTuplet&&p.prop(s,"tu",p.values([p.number(t.tupletNumerator),p.number(t.tupletDenominator)])),t.hasWhammyBar){var i,a=p.values([p.ident(v.whammyTypesReversed.get(t.whammyBarType)),p.ident(v.bendStylesReversed.get(t.whammyStyle))],!0);for(i of t.whammyBarPoints)a.values.push(p.number(i.offset)),a.values.push(p.number(i.value));p.prop(s,"tbe",a)}let r="";switch(t.brushType){case 1:r="bu";break;case 2:r="bd";break;case 3:r="au";break;case 4:r="ad"}if(r&&p.prop(s,r,p.numberValue(t.brushDuration)),null!=t.chord&&p.prop(s,"ch",p.stringValue(t.chord.name)),2!==t.ottava&&p.prop(s,"ot",p.identValue(v.ottavaReversed.get(t.ottava))),t.hasRasgueado&&p.prop(s,"rasg",p.identValue(v.rasgueadoPatternsReversed.get(t.rasgueado))),null!=t.text&&p.prop(s,"txt",p.stringValue(t.text)),null!=t.lyrics&&0<t.lyrics.length)if(1<t.lyrics.length)for(let e=0;e<t.lyrics.length;e++)p.prop(s,"lyrics",p.values([p.number(e),p.string(t.lyrics[e])]));else p.prop(s,"lyrics",p.stringValue(t.lyrics[0]));switch(0!==t.graceType&&p.prop(s,"gr",2===t.graceType?void 0:p.identValue(v.graceTypesReversed.get(t.graceType))),t.isTremolo&&p.prop(s,"tp",p.numberValue(t.tremoloSpeed)),t.crescendo){case 1:p.prop(s,"cre");break;case 2:p.prop(s,"dec")}(0===t.voice.bar.index&&0===t.index||t.dynamics!==t.previousBeat?.dynamics)&&p.prop(s,"dy",p.identValue(v.dynamicsReversed.get(t.dynamics))),null!=t.fermata&&p.prop(s,"fermata",p.values([p.ident(v.fermataTypesReversed.get(t.fermata.type)),p.number(t.fermata.length)])),t.isLegatoOrigin&&p.prop(s,"legatoorigin");for(e of t.automations)switch(e.type){case 0:p.prop(s,"tempo",p.values([p.number(e.value),0===e.text.length?void 0:p.string(e.text)]));break;case 1:p.prop(s,"volume",p.numberValue(e.value));break;case 2:t.voice.bar.staff.isPercussion||p.prop(s,"instrument",p.identValue(Wt.getName(e.value)));break;case 3:p.prop(s,"balance",p.numberValue(e.value))}switch(t.wahPedal){case 1:p.prop(s,"waho");break;case 2:p.prop(s,"wahc")}switch(t.isBarre&&p.prop(s,"barre",p.values([p.number(t.barreFret),p.ident(v.barreShapesReversed.get(t.barreShape))])),t.slashed&&p.prop(s,"slashed"),t.deadSlapped&&p.prop(s,"ds"),t.golpe){case 1:p.prop(s,"glpt");break;case 2:p.prop(s,"glpf")}t.invertBeamDirection?p.prop(s,"beam",p.identValue("invert")):null!==t.preferredBeamDirection&&p.prop(s,"beam",p.identValue(ms[t.preferredBeamDirection]));let n="";switch(t.beamingMode){case 1:n="split";break;case 2:n="merge";break;case 3:n="splitsecondary"}return n&&p.prop(s,"beam",p.identValue(n)),t.showTimer&&p.prop(s,"timer"),s}static applyChordToBeat(e,t,s){var i=e.voice.bar.staff,a=i.tuning.length,r=(s&&(e.chordId=t),i.getChord(t));if(r)for(var n of e.notes){var o=a-n.string;0<=o&&o<r.strings.length&&r.strings[o]===n.fret&&(n.isDeadVisual=!0)}}},gs=(k.instance=new k,k._defaultScore=new qe,k._defaultTrack=new ts,k),fs=class fs{readMetaDataValues(e,t){var s,i,a=t.tag.text.toLowerCase();for(s of Ot.metaDataValueListTypes)if(s.has(a))return(i=s.get(a))?this._readTypedValueList(e,i):void 0;throw e.addParserDiagnostic({code:204,message:`Unrecognized metadata '${t.tag.text}'.`,severity:2,start:t.start,end:t.end}),new Lt}readMetaDataPropertyValues(e,t,s){switch(t.tag.text.toLowerCase()){case"track":return this._readPropertyValues(e,[Ot.trackPropertyValueListTypes],s);case"chord":return this._readPropertyValues(e,[Ot.chordPropertyValueListTypes],s);case"tuning":return this._readPropertyValues(e,[Ot.tuningPropertyValueListTypes],s);case"staff":return this._readPropertyValues(e,[Ot.staffPropertyValueListTypes],s);default:return}}readBeatPropertyValues(e,t){return this._readPropertyValues(e,[Ot.beatPropertyValueListTypes],t)}readDurationChangePropertyValues(e,t){return this._readPropertyValues(e,[Ot.beatDurationPropertyValueListTypes],t)}readNotePropertyValues(e,t){return this._readPropertyValues(e,[Ot.notePropertyValueListTypes,Ot.beatPropertyValueListTypes],t)}_readPropertyValues(e,t,s){var i,a,r=s.property.text.toLowerCase(),n=new Set([10,5]);for(i of t)if(i.has(r))return(a=i.get(r))?this._readTypedValueList(e,a,n):void 0;throw e.addParserDiagnostic({code:205,message:`Unrecognized property '${s.property.text}'.`,severity:2,start:s.property.start,end:s.property.end}),new Lt}_readTypedValueList(t,e,s){let i=[],a=t.lexer.peekToken()?.start,r=!1,n=void 0!==s,o=0;for(;o<e.length;){var h=e[o],l=t.lexer.peekToken();if(4===h.parseMode){n=!1;break}if(l&&(h.expectedTypes.has(l.nodeType)||fs._isValueListMatch(l,h))&&this._handleTypeValueListItem(t,i,l,h))switch(h.parseMode){case 5:o=e.length;break;case 7:break;default:o++}else switch(h.parseMode){case 7:o++;break;case 0:case 2:t.unexpectedToken(l,Array.from(h.expectedTypes),!0),r=!0;break;case 1:case 3:case 5:case 6:o++}}if(r)throw new Lt;if(n){let e=t.lexer.peekToken();for(;e&&!s.has(e.nodeType);)e=this._handleTypeValueListItem(t,i,e,void 0)?t.lexer.peekToken():void 0}var d;if(0!==i.length)return(d=p.values(i,!1)).start=a,d.end=t.lexer.previousTokenEndLocation(),d.validated=!0,d}_handleTypeValueListItem(e,t,s,i){switch(s.nodeType){case 10:var a=s;if(i?.allowedValues){if(!i.allowedValues.has(a.text.toLowerCase()))return!1}else if(i?.reservedIdentifiers&&i.reservedIdentifiers.has(a.text.toLowerCase()))return!1;return t.push(a),e.lexer.advance(),!0;case 17:a=s;return i?.allowedValues&&!i.allowedValues.has(a.text.toLowerCase())||(t.push(a),e.lexer.advance()),!0;case 16:switch(i?.parseMode??1){case 2:case 3:t.push(e.lexer.extendToFloat(s)),e.lexer.advance();break;default:t.push(s),e.lexer.advance()}return!0;case 6:a=e.valueList();if(a)for(var r of a.values)t.push(r);return!0}return!1}static _isValueListMatch(e,t){return 6===e.nodeType&&(t.expectedTypes.has(13)||7===t.parseMode||6===t.parseMode)}},bs=(fs.instance=new fs,fs),ys=class ys{static float64ToBytes(e){return ys._dataView.setFloat64(0,e,!0),ys._conversionByteArray}static bytesToInt64LE(e){ys._conversionByteArray.set(e,0);e=ys._dataView.getBigInt64(0,!0);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?Number(e):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(e){return ys._conversionByteArray.set(e,0),ys._dataView.getFloat64(0,!0)}static bytesToFloat32LE(e){return ys._conversionByteArray.set(e,0),ys._dataView.getFloat32(0,!0)}static float32BEToBytes(e){return ys._dataView.setFloat32(0,e,!1),ys._conversionByteArray.slice(0,4)}static uint16ToInt16(e){return ys._dataView.setUint16(0,e,!0),ys._dataView.getInt16(0,!0)}static int16ToUint32(e){return ys._dataView.setInt16(0,e,!0),ys._dataView.getUint32(0,!0)}static int32ToUint16(e){return ys._dataView.setInt32(0,e,!0),ys._dataView.getUint16(0,!0)}static int32ToInt16(e){return ys._dataView.setInt32(0,e,!0),ys._dataView.getInt16(0,!0)}static int32ToUint32(e){return ys._dataView.setInt32(0,e,!0),ys._dataView.getUint32(0,!0)}static uint8ToInt8(e){return ys._dataView.setUint8(0,e),ys._dataView.getInt8(0)}},_s=(ys._conversionBuffer=new ArrayBuffer(8),ys._conversionByteArray=new Uint8Array(ys._conversionBuffer),ys._dataView=new DataView(ys._conversionBuffer),ys),f=class Nu{static readInt32BE(e){return e.readByte()<<24|e.readByte()<<16|e.readByte()<<8|e.readByte()}static readFloat32BE(e){var t=new Uint8Array(4);return e.read(t,0,t.length),t.reverse(),_s.bytesToFloat32LE(t)}static readFloat64BE(e){var t=new Uint8Array(8);return e.read(t,0,t.length),t.reverse(),_s.bytesToFloat64LE(t)}static readInt32LE(e){var t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static readInt64LE(e){var t=new Uint8Array(8);return e.read(t,0,t.length),_s.bytesToInt64LE(t)}static readUInt32LE(e){var t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static decodeUInt32LE(e,t){var s=e[t];return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|s}static readUInt16LE(e){var t=e.readByte(),e=e.readByte();return _s.int32ToUint16(e<<8|t)}static readInt16LE(e){var t=e.readByte(),e=e.readByte();return _s.int32ToInt16(e<<8|t)}static readUInt32BE(e){var t=e.readByte(),s=e.readByte(),i=e.readByte(),e=e.readByte();return _s.int32ToUint32(t<<24|s<<16|i<<8|e)}static readUInt16BE(e){var t=e.readByte(),e=e.readByte();return _s.int32ToInt16(t<<8|e)}static readInt16BE(e){var t=e.readByte(),e=e.readByte();return _s.int32ToInt16(t<<8|e)}static readByteArray(e,t){var s=new Uint8Array(t);return e.read(s,0,t),s}static read8BitChars(e,t){t=new Uint8Array(t);return e.read(t,0,t.length),Nu.toString(t,"utf-8")}static read8BitString(e){let t="",s=e.readByte();for(;0!==s;)t+=String.fromCharCode(s),s=e.readByte();return t}static read8BitStringLength(t,s){let i="",a=-1;for(let e=0;e<s;e++){var r=t.readByte();0===r&&-1===a&&(a=e),i+=String.fromCharCode(r)}var e=i;return 0<=a?e.substr(0,a):e}static readSInt8(e){e=e.readByte();return-256*((255&e)>>7)+(255&e)}static readInt24(e,t){let s=e[t]|e[t+1]<<8|e[t+2]<<16;return 8388608==(8388608&s)&&(s|=255<<24),s}static readInt16(e,t){return _s.int32ToInt16(e[t]|e[t+1]<<8)}static toString(e,t){var s=Nu._detectEncoding(e);return t=(t=s?s:t)||"utf-8",new TextDecoder(t).decode(e.buffer)}static _detectEncoding(e){return 2<e.length&&254===e[0]&&255===e[1]?"utf-16be":2<e.length&&255===e[0]&&254===e[1]?"utf-16le":4<e.length&&0===e[0]&&0===e[1]&&254===e[2]&&255===e[3]?"utf-32be":4<e.length&&255===e[0]&&254===e[1]&&0===e[2]&&0===e[3]?"utf-32le":null}static stringToBytes(e){return(new TextEncoder).encode(e)}static writeInt32BE(e,t){e.writeByte(t>>24&255),e.writeByte(t>>16&255),e.writeByte(t>>8&255),e.writeByte(t>>0&255)}static writeInt32LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255),e.writeByte(t>>16&255),e.writeByte(t>>24&255)}static writeUInt16LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255)}static writeInt16LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255)}static writeInt16BE(e,t){e.writeByte(t>>8&255),e.writeByte(t>>0&255)}static writeFloat32BE(e,t){t=_s.float32BEToBytes(t);e.write(t,0,t.length)}static*iterateCodepoints(t){let s=0;for(;s<t.length;){let e=t.charCodeAt(s);Nu.isLeadingSurrogate(e)&&s+1<t.length&&(s++,e=1024*(e-55296)+(t.charCodeAt(s)-56320)+65536),s++,yield e}}static isLeadingSurrogate(e){return 55296<=e&&e<=56319}static isTrailingSurrogate(e){return 56320<=e&&e<=57343}},Ss=class Ss{constructor(e){this._codepoint=Ss._eof,this._offset=0,this._line=1,this._col=1,this._fatalError=!1,this._tokenStart={line:0,col:0,offset:0},this.lexerDiagnostics=new Et,this._codepoints=[...f.iterateCodepoints(e)],this._offset=0,this._line=1,this._col=1,this._codepoint=0<this._codepoints.length?this._codepoints[0]:Ss._eof}peekToken(){var e;if(!this._fatalError)return this._peekedToken||(e=this._readToken(),this._peekedToken=e)}extendToFloat(t){if(!(46!==this._codepoint||this._offset+1>=this._codepoints.length)&&Ss._isDigit(this._codepoints[this._offset+1])){let e=this._offset+2;for(;e<this._codepoints.length&&Ss._isDigit(this._codepoints[e]);)e++;var s;e<this._codepoints.length&&Ss._isIdentifierCharacter(this._codepoints[e])||(s=e-this._offset-1,this._offset+=s,this._col+=s,this._nextCodepoint(),t.end=this._currentLexerLocation(),t.value=Number.parseFloat(String.fromCodePoint(...this._codepoints.slice(t.start.offset,t.end.offset))))}return t}advance(){this._previousToken=this._peekedToken,this._peekedToken=void 0}_nextCodepoint(){var e,t=this._codepoints,s=this._offset;return s<t.length-1?(e=t[++s],10===(this._codepoint=e)?(this._trailingCommentNode=void 0,++this._line,this._col=1):++this._col,this._offset=s,e):(this._codepoint!==Ss._eof&&(this._codepoint=Ss._eof,++this._col,this._offset=t.length),Ss._eof)}previousTokenEndLocation(){return this._previousToken?.end??this._currentLexerLocation()}currentTokenLocation(){return this._peekedToken?.start??this._currentLexerLocation()}_currentLexerLocation(){return{line:this._line,col:this._col,offset:this._offset}}_readToken(){for(this._leadingComments=void 0;this._codepoint!==Ss._eof;)if(this._tokenStart=this._currentLexerLocation(),Ss._terminalTokens.has(this._codepoint)){var e=Ss._terminalTokens.get(this._codepoint)(this);if(e)return this._trailingCommentNode=e}else{if(Ss._isIdentifierCharacter(this._codepoint))return e=this._numberOrIdentifier(),this._trailingCommentNode=e;this._codepoint=this._nextCodepoint()}}_comment(){this._codepoint=this._nextCodepoint(),47===this._codepoint?this._singleLineComment():42===this._codepoint?this._multiLineComment():(this.lexerDiagnostics.push({code:1,message:`Unexpected character at comment start, expected '//' or '/*' but found '/${String.fromCodePoint(this._codepoint)}'`,severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),this._fatalError=!0)}_metaCommand(){var e=this._currentLexerLocation();this._codepoint=this._nextCodepoint();let t,s,i=(t=92===this._codepoint?(this._codepoint=this._nextCodepoint(),{nodeType:2,start:e,end:s=this._currentLexerLocation()}):{nodeType:1,start:e,end:s=this._currentLexerLocation()},"");for(;Ss._isIdentifierCharacter(this._codepoint);)i+=String.fromCodePoint(this._codepoint),this._codepoint=this._nextCodepoint();if(0!==i.length)return{nodeType:11,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),prefix:t,tag:{nodeType:10,text:i,start:s,end:this._currentLexerLocation()}};this.lexerDiagnostics.push({code:2,message:"Missing identifier after meta data start",severity:2,start:this._tokenStart,end:this._currentLexerLocation()})}_token(e){return e.leadingComments=this._leadingComments,e.start=this._tokenStart,e.end=this._currentLexerLocation(),this._codepoint=this._nextCodepoint(),e}_string(){var e,t=this._codepoint;this._codepoint=this._nextCodepoint();let s="",i=-1;for(;this._codepoint!==t&&this._codepoint!==Ss._eof;){let e=-1;if(92===this._codepoint)if(this._codepoint=this._nextCodepoint(),92===this._codepoint)e=92;else if(this._codepoint===t)e=t;else if(82===this._codepoint||114===this._codepoint)e=13;else if(78===this._codepoint||110===this._codepoint)e=10;else if(84===this._codepoint||116===this._codepoint)e=9;else{if(117!==this._codepoint)return this.lexerDiagnostics.push({code:5,message:`Unsupported escape sequence. Expected '\\n', '\\r', '\\t', or '\\uXXXX' but found '\\${String.fromCodePoint(this._codepoint)}'.`,severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),void(this._fatalError=!0);{let t="";for(let e=0;e<4;e++){if(this._codepoint=this._nextCodepoint(),this._codepoint===Ss._eof)return this.lexerDiagnostics.push({code:3,message:"Unexpected end of file. Need 4 hex characters on a \\uXXXX escape sequence",severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),void(this._fatalError=!0);t+=String.fromCodePoint(this._codepoint)}if(e=Number.parseInt(t,16),Number.isNaN(e))return this.lexerDiagnostics.push({code:4,message:"Invalid unicode value. Need 4 hex characters on a \\uXXXX escape sequence.",severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),void(this._fatalError=!0)}}else e=this._codepoint;f.isLeadingSurrogate(i)&&f.isTrailingSurrogate(e)?(e=1024*(i-55296)+(e-56320)+65536,s+=String.fromCodePoint(e)):f.isLeadingSurrogate(e)||(f.isLeadingSurrogate(i)&&(s+=String.fromCodePoint(i)),0<e&&(s+=String.fromCodePoint(e))),i=e,this._codepoint=this._nextCodepoint()}if(this._codepoint!==Ss._eof)return e={nodeType:17,text:s,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation()},this._codepoint=this._nextCodepoint(),e;this.lexerDiagnostics.push({code:6,message:"Unexpected end of file. String not closed.",severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),this._fatalError=!0}_multiLineComment(){for(var e=this._trailingCommentNode,t={start:this._tokenStart,end:this._currentLexerLocation(),text:"",multiLine:!0};this._codepoint!==Ss._eof;){if(42===this._codepoint){if(this._codepoint=this._nextCodepoint(),47===this._codepoint){this._codepoint=this._nextCodepoint();break}t.text+="*"+String.fromCodePoint(this._codepoint)}else this._codepoint=this._nextCodepoint(),t.text+=String.fromCodePoint(this._codepoint);t.end.line=this._line,t.end.col=this._col,t.end.offset=this._offset}(e?(e.trailingComments??(e.trailingComments=[]),e.trailingComments):(this._leadingComments??(this._leadingComments=[]),this._leadingComments)).push(t)}_numberOrIdentifier(){let e="",t=!0,s=this._codepoint,i=(45===s&&(e+=String.fromCodePoint(s),s=this._nextCodepoint(),Ss._isDigit(s)||(t=!1)),!0);for(;i=t?Ss._isDigit(s)?(e+=String.fromCodePoint(s),s=this._nextCodepoint(),!0):!!Ss._isIdentifierCharacter(s)&&(t=!1,e+=String.fromCodePoint(s),s=this._nextCodepoint(),!0):!!Ss._isIdentifierCharacter(s)&&(e+=String.fromCodePoint(s),s=this._nextCodepoint(),!0););return t?{nodeType:16,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),value:Number.parseInt(e,10)}:{nodeType:10,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),text:e}}_singleLineComment(){let e=this._trailingCommentNode,t={start:this._tokenStart,end:this._currentLexerLocation(),text:"",multiLine:!1},s=this._codepoint;for(;s!==Ss._eof&&10!==(s=this._nextCodepoint())&&s!==Ss._eof;)t.text+=String.fromCodePoint(s),t.end.line=this._line,t.end.col=this._col,t.end.offset=this._offset;(e?(e.trailingComments??(e.trailingComments=[]),e.trailingComments):(this._leadingComments??(this._leadingComments=[]),this._leadingComments)).push(t)}_whitespace(){let e=this._codepoint;for(;Ss._isWhiteSpace(e);)10===e&&(this._trailingCommentNode=void 0),e=this._nextCodepoint()}static _isDigit(e){return 48<=e&&e<=57}static _buildNonIdentifierChars(){var e,t=new Set;for(e of Ss._terminalTokens.keys())t.add(e);return t.delete(45),t.add(Ss._eof),t}static _isIdentifierCharacter(e){return!Ss._nonIdentifierChars.has(e)}static _isWhiteSpace(e){return 32===e||10===e||13===e||9===e||11===e}},vs=(Ss._eof=0,Ss._terminalTokens=new Map([[47,e=>e._comment()],[34,e=>e._string()],[39,e=>e._string()],[45,e=>e._numberOrIdentifier()],[46,e=>e._token({nodeType:0})],[58,e=>e._token({nodeType:8})],[40,e=>e._token({nodeType:6})],[41,e=>e._token({nodeType:7})],[123,e=>e._token({nodeType:4})],[125,e=>e._token({nodeType:5})],[124,e=>e._token({nodeType:3})],[42,e=>e._token({nodeType:9})],[92,e=>e._metaCommand()],[9,e=>e._whitespace()],[10,e=>e._whitespace()],[11,e=>e._whitespace()],[13,e=>e._whitespace()],[32,e=>e._whitespace()]]),Ss._nonIdentifierChars=Ss._buildNonIdentifierChars(),Ss),ks=class{constructor(e){this._metaDataReader=bs.instance,this.parserDiagnostics=new Et,this.lexer=new vs(e)}get lexerDiagnostics(){return this.lexer.lexerDiagnostics}addParserDiagnostic(e){this.parserDiagnostics.push(e)}unexpectedToken(e,t,s){if(e?this.addParserDiagnostic({code:202,message:`Unexpected '${Rt[e.nodeType]}' token. Expected one of following: `+t.map(e=>Rt[e]).join(","),severity:2,start:e.start,end:e.end}):this.addParserDiagnostic({code:203,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation(),severity:2,message:"Unexpected end of file."}),s)throw new Lt}read(){return this._score(),this._scoreNode}_score(){this._scoreNode={nodeType:18,bars:[],start:this.lexer.currentTokenLocation()};try{this._bars()}catch(e){if(!(e instanceof Lt))throw e}finally{this._scoreNode.end=this.lexer.previousTokenEndLocation()}}_bars(){let e=this.lexer.peekToken();for(;e;)this._bar(),e=this.lexer.peekToken()}_bar(){var e={nodeType:19,metaData:[],beats:[],pipe:void 0,start:this.lexer.currentTokenLocation()};try{this._barMetaData(e),this._barBeats(e);var t=this.lexer.peekToken();3===t?.nodeType&&(e.pipe=t,this.lexer.advance()),(0<e.metaData.length||0<e.beats.length||e.pipe)&&(e.end=this.lexer.previousTokenEndLocation(),this._scoreNode.bars.push(e))}finally{e.end=this.lexer.previousTokenEndLocation()}}_barMetaData(e){let t=this.lexer.peekToken();for(;t&&(11===t.nodeType||0===t.nodeType);)0===t.nodeType?(this.lexer.advance(),this.addParserDiagnostic({code:400,message:"The dots separating score metadata, score contents and the sync points can be removed.",severity:0,start:t.start,end:t.end})):e.metaData.push(this._metaData()),t=this.lexer.peekToken()}_barBeats(e){let t=this.lexer.peekToken();for(;t&&3!==t.nodeType&&0!==t.nodeType&&11!==t.nodeType;){var s=this._beat();s&&e.beats.push(s),t=this.lexer.peekToken()}}_beat(){var e={nodeType:20,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0,beatMultiplier:void 0,beatMultiplierValue:void 0,start:this.lexer.peekToken()?.start};try{if(e.durationChange=this._beatDurationChange(),this._beatContent(e),!e.notes&&!e.rest)return e;this._beatDuration(e),this._beatMultiplier(e),e.beatEffects=this._properties(e=>this._metaDataReader.readBeatPropertyValues(this,e)),void 0!==e.beatMultiplierValue&&e.beatEffects?.openBrace&&this.addParserDiagnostic({code:304,message:"The beat multiplier should be specified after the beat effects.",severity:1,start:e.beatMultiplier.start,end:e.beatMultiplierValue.end}),this._beatMultiplier(e)}finally{e.end=this.lexer.previousTokenEndLocation()}return e}_beatDuration(e){var t=this.lexer.peekToken();0===t?.nodeType&&(e.durationDot=t,this.lexer.advance(),16===(t=this.lexer.peekToken())?.nodeType?(e.durationValue=t,this.lexer.advance()):11===t?.nodeType?e.durationDot=void 0:t&&this.unexpectedToken(t,[16],!0))}_beatDurationChange(){var e=this.lexer.peekToken();if(8===e?.nodeType){this.lexer.advance();var t={nodeType:21,colon:e,value:void 0,properties:void 0,start:e.start};try{var s=this.lexer.peekToken();if(!s||16!==s.nodeType)return void this.addParserDiagnostic({code:201,message:"Missing duration value after ':'.",severity:2,start:e.start,end:e.end});this.lexer.advance(),t.value=s,t.properties=this._properties(e=>this._metaDataReader.readDurationChangePropertyValues(this,e))}finally{t.end=this.lexer.previousTokenEndLocation()}return t}}_beatContent(e){var t=this.lexer.peekToken();t&&(10===t.nodeType&&"r"===t.text?(e.rest=t,this.lexer.advance()):6===t.nodeType?e.notes=this._noteList(t):(t=this._note(t))&&(e.notes={nodeType:22,openParenthesis:void 0,notes:[t],closeParenthesis:void 0,start:t.start,end:t.end}))}_beatMultiplier(e){var t=this.lexer.peekToken();t&&9===t.nodeType&&(this.lexer.advance(),e.beatMultiplier=t,(t=this.lexer.peekToken())&&16===t.nodeType?(e.beatMultiplierValue=t,this.lexer.advance()):this.addParserDiagnostic({code:200,message:"Missing beat multiplier value after '*'.",severity:2,start:e.beatMultiplier.start,end:e.beatMultiplier.end}))}_noteList(t){var s={nodeType:22,openParenthesis:void 0,notes:[],closeParenthesis:void 0,start:this.lexer.currentTokenLocation()};try{s.openParenthesis=t,this.lexer.advance();let e=this.lexer.peekToken();for(;e&&7!==e.nodeType;){var i=this._note(e);if(!i)break;s.notes.push(i),e=this.lexer.peekToken()}var a=this.lexer.peekToken();7===a?.nodeType?(s.closeParenthesis=a,this.lexer.advance()):this.addParserDiagnostic({code:206,message:"Unexpected end of file. Group not closed.",severity:2,start:a?.start??this.lexer.currentTokenLocation(),end:a?.end??this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}_note(t){var s={nodeType:23,noteValue:{nodeType:10,text:""},start:t.start};try{let e=!1;switch(t.nodeType){case 16:s.noteValue=t,this.lexer.advance(),e=!0;break;case 17:case 10:switch(s.noteValue=t,this.lexer.advance(),s.noteValue.text){case"x":case"-":e=!0}break;default:return void this.unexpectedToken(t,[16,17,10],!0)}if(e){var i=this.lexer.peekToken();if(0===i?.nodeType){var a=i,r=(this.lexer.advance(),this.lexer.peekToken());if(!r)return void this.unexpectedToken(r,[16],!0);if(11===r.nodeType)return s;if(16!==r.nodeType)return void this.unexpectedToken(r,[16],!0);s.noteStringDot=a,s.noteString=r,this.lexer.advance()}}s.noteEffects=this._properties(e=>this._metaDataReader.readNotePropertyValues(this,e))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}_metaData(){var e=this.lexer.peekToken();if(e&&11===e.nodeType){let t={nodeType:12,tag:e,start:e.start,properties:void 0,propertiesBeforeValues:!1};this.lexer.advance();try{4===this.lexer.peekToken()?.nodeType?(t.propertiesBeforeValues=!0,t.properties=this._properties(e=>this._metaDataReader.readMetaDataPropertyValues(this,t.tag,e)),t.values=this.valueList(),t.values||(t.values=this._metaDataReader.readMetaDataValues(this,t.tag),t.values&&1<t.values.values.length&&(this.addParserDiagnostic({code:301,message:"Metadata values should be wrapped into parenthesis.",severity:1,start:t.values?.start??t.start,end:t.values?.end??t.end}),this.addParserDiagnostic({code:302,message:"Metadata values should be placed before metadata properties.",severity:1,start:t.values?.start??t.start,end:t.values?.end??t.end})))):(t.values=this.valueList(),t.values||(t.values=this._metaDataReader.readMetaDataValues(this,t.tag),t.values&&1<t.values.values.length&&this.addParserDiagnostic({code:301,message:"Metadata values should be wrapped into parenthesis.",severity:1,start:t.values?.start??t.start,end:t.values?.end??t.end})),t.properties=this._properties(e=>this._metaDataReader.readMetaDataPropertyValues(this,t.tag,e)))}finally{t.end=this.lexer.previousTokenEndLocation()}return t}}_properties(t){var e=this.lexer.peekToken();if(e&&4===e.nodeType){var s={nodeType:14,openBrace:e,properties:[],closeBrace:void 0,start:e.start};this.lexer.advance();try{let e=this.lexer.peekToken();for(;10===e?.nodeType;)s.properties.push(this._property(e,t)),e=this.lexer.peekToken();var i=this.lexer.peekToken();5===i?.nodeType?(s.closeBrace=i,this.lexer.advance()):this.addParserDiagnostic({code:206,message:"Unexpected end of file. Group not closed.",severity:2,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}}_property(e,t){e={nodeType:15,property:e,values:void 0};this.lexer.advance(),e.start=e.property.start;try{e.values=this.valueList(),e.values||(e.values=t(e),e.values&&1<e.values.values.length&&this.addParserDiagnostic({code:303,message:"Property values should be wrapped into parenthesis.",severity:1,start:e.values.start,end:e.values.end}))}finally{e.end=this.lexer.previousTokenEndLocation()}return e}valueList(){var e=this.lexer.peekToken();if(6===e?.nodeType){var t={nodeType:13,openParenthesis:e,values:[],closeParenthesis:void 0,start:e.start};this.lexer.advance();try{let e=this.lexer.peekToken();for(;e&&7!==e?.nodeType;){switch(e.nodeType){case 10:case 17:t.values.push(e),this.lexer.advance();break;case 16:t.values.push(this.lexer.extendToFloat(e)),this.lexer.advance();break;default:this.unexpectedToken(e,[10,17,16],!1),this.lexer.advance()}e=this.lexer.peekToken()}var s=this.lexer.peekToken();7===s?.nodeType?(t.closeParenthesis=s,this.lexer.advance()):this.addParserDiagnostic({code:206,message:"Unexpected end of file. Group not closed.",severity:2,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{t.end=this.lexer.previousTokenEndLocation()}return t}}},ws=class{init(e,t){this.data=e,this.settings=t,qe.resetIds()}},Ts=class extends b{constructor(e=null,t){super(1,e??"Unsupported format",t)}},Bs=class Mu{constructor(){this.length=0,this.position=0}get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return Mu.withCapacity(0)}static withCapacity(e){var t=new Mu;return t._buffer=new Uint8Array(e),t}static fromBuffer(e){var t=new Mu;return t._buffer=e,t.length=e.length,t}static fromString(e){e=f.stringToBytes(e);return Mu.fromBuffer(e)}reset(){this.position=0}skip(e){this.position+=e}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(e,t,s){let i=this.length-this.position;return(i=i>s?s:i)<=0?0:(e.set(this._buffer.subarray(this.position,this.position+i),t),this.position+=i,i)}writeByte(e){var t=this.position+1;this._ensureCapacity(t),this._buffer[this.position]=255&e,t>this.length&&(this.length=t),this.position=t}write(e,t,s){var i=this.position+s,s=(this._ensureCapacity(i),Math.min(s,e.length-t));this._buffer.set(e.subarray(t,t+s),this.position),i>this.length&&(this.length=i),this.position=i}_ensureCapacity(t){if(t>this._buffer.length){let e=t;(e=e<256?256:e)<2*this._buffer.length&&(e=2*this._buffer.length);t=new Uint8Array(e);0<this.length&&t.set(this._buffer.subarray(0,0+this.length),0),this._buffer=t}}readAll(){return this.toArray()}toArray(){var e=new Uint8Array(this.length);return e.set(this._buffer.subarray(0,0+this.length),0),e}copyTo(e){e.write(this._buffer,0,this.length)}},xs=class Eu extends b{*iterateDiagnostics(){if(this.lexerDiagnostics)for(var e of this.lexerDiagnostics.items)yield e;if(this.parserDiagnostics)for(var t of this.parserDiagnostics.items)yield t;if(this.semanticDiagnostics)for(var s of this.semanticDiagnostics.items)yield s}constructor(e,t,s,i){super(2,e),this.lexerDiagnostics=t,this.parserDiagnostics=s,this.semanticDiagnostics=i}toString(){return[this.message,"lexer diagnostics:",Eu._diagnosticsToString(this.lexerDiagnostics,"  "),"parser diagnostics:",Eu._diagnosticsToString(this.parserDiagnostics,"  "),"semantic diagnostics:",Eu._diagnosticsToString(this.semanticDiagnostics,"  ")].join(`
`)}static _diagnosticsToString(e,t){return e?e.items.map(e=>""+t+Nt[e.severity]+` AT${e.code.toString().padStart(3,"0")}${Eu._locationToString(e)}: `+e.message).join(`
`):t+"none"}static _locationToString(e){let t="";return e.start&&(t+=`(${e.start.line},${e.start.col})`),e.end&&(0<t.length&&(t+="->"),t+=`(${e.end.line},${e.end.col})`),t}},Ps=class{constructor(){this.trackChannel=0,this.barIndex=0,this.voiceIndex=0,this.ignoredInitialVoice=!1,this.ignoredInitialStaff=!1,this.ignoredInitialTrack=!1,this.currentDuration=4,this.articulationValueToIndex=new Map,this.hasAnyProperData=!1,this.percussionArticulationNames=new Map,this.slurs=new Map,this.lyrics=new Map,this.sustainPedalToBeat=new Map,this.staffTuningApplied=new Set,this.staffNoteKind=new Map,this.staffHasExplicitTuning=new Set,this.staffHasExplicitDisplayTransposition=new Set,this.staffDisplayTranspositionApplied=new Set,this.staffInitialClef=new Map,this.syncPoints=[],this.currentDynamics=5,this.accidentalMode=1,this.currentTupletNumerator=-1,this.currentTupletDenominator=-1,this.currentChordId=null}},Ns=class extends ws{constructor(){super(...arguments),this._handler=gs.instance,this._state=new Ps,this.logErrors=!1,this.semanticDiagnostics=new Et}get state(){return this._state}get name(){return"AlphaTex"}get lexerDiagnostics(){return this._parser.lexerDiagnostics}get parserDiagnostics(){return this._parser.parserDiagnostics}addSemanticDiagnostic(e){this.semanticDiagnostics.push(e)}initFromString(e,t){this.data=Bs.empty(),this._parser=new ks(e),this.settings=t,qe.resetIds()}readScore(){this._state=new Ps,this._createDefaultScore(),0<this.data.length&&(this._parser=new ks(f.toString(this.data.readAll(),this.settings.importer.encoding)));let e;try{e=this._parser.read()}catch(e){throw this.logErrors&&M.error("AlphaTex","Error while parsing alphaTex: "+e.toString()),new Ts("Error parsing alphaTex, check inner error for details",e)}var t,s,i,a,r,n;if(this._parser.parserDiagnostics.hasErrors||this._parser.lexer.lexerDiagnostics.hasErrors)throw t=new xs("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics),this.logErrors&&M.error("AlphaTex","Error while parsing alphaTex: "+t.toString()),new Ts("Error parsing alphaTex, check diagnostics on inner error for details",t);if(0===e.bars.length)throw new Ts("No alphaTex data found");if(this._bars(e),this.semanticDiagnostics.hasErrors)throw this._state.hasAnyProperData?(t=new xs("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics),this.logErrors&&M.error("AlphaTex","Error while parsing alphaTex: "+t.toString()),t):new Ts("No alphaTex data found");F.consolidate(this._state.score),this._state.score.finish(this.settings),F.trimEmptyBarsAtEnd(this._state.score),this._state.score.rebuildRepeatGroups(),this._state.score.applyFlatSyncPoints(this._state.syncPoints);for([s,i]of this._state.lyrics)this._state.score.tracks[s].applyLyrics(i);for([a,r]of this._state.sustainPedalToBeat)a.ratioPosition<1&&(n=r.voice.bar.masterBar.calculateDuration(),a.ratioPosition=r.playbackStart/n);return this._state.score}_createDefaultScore(){this._state.score=new qe,this._newTrack()}_newTrack(){this._state.currentTrack=new ts,this._state.currentTrack.ensureStaveCount(1),this._state.currentTrack.playbackInfo.program=25,this._state.currentTrack.playbackInfo.primaryChannel=this._state.trackChannel++,this._state.currentTrack.playbackInfo.secondaryChannel=this._state.trackChannel++;var e=this._state.currentTrack.staves[0];e.displayTranspositionPitch=0,e.stringTuning=qt.getDefaultTuningFor(6),this._state.articulationValueToIndex.clear(),this._beginStaff(e),this._state.score.addTrack(this._state.currentTrack),this._state.lyrics.set(this._state.currentTrack.index,[]),this._state.currentDynamics=5,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1}_beginStaff(e){this._state.currentStaff&&(this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff)),this._state.currentStaff=e,this._state.currentChordId=null,this._state.slurs.clear(),this._state.barIndex=0,this._state.voiceIndex=0}_bars(e){if(0<e.bars.length)for(var t of e.bars)this._bar(t);else this._newBar(this._state.currentStaff),this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff)}_bar(e){this._state.currentChordId=null;var t,s=this._barMeta(e),i=(this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff),0===s.index&&this._state.staffInitialClef.has(this._state.currentStaff)&&(s.clef=this._state.staffInitialClef.get(this._state.currentStaff)),s.voices[this._state.voiceIndex]);for(t of e.beats)this._beat(i,t);0===i.beats.length&&((s=new wt).isEmpty=!0,i.addBeat(s))}_beat(s,e){if(e.durationChange&&this._beatDuration(e.durationChange),e.notes||e.rest){var i=new wt;if(s.addBeat(i),e.notes)for(var a of e.notes.notes)this._note(i,a);else e.rest;e.durationValue&&(this._state.currentDuration=this._parseDuration(e.durationValue)),i.duration=this._state.currentDuration,i.dynamics=this._state.currentDynamics,-1===this._state.currentTupletNumerator||i.hasTuplet||(i.tupletNumerator=this._state.currentTupletNumerator,i.tupletDenominator=this._state.currentTupletDenominator);let t=1;void 0!==e.beatMultiplierValue&&(t=e.beatMultiplierValue.value),e.beatEffects&&this._beatEffects(i,e.beatEffects),!i.chordId&&this._state.currentChordId&&gs.applyChordToBeat(i,this._state.currentChordId,!1);for(let e=0;e<t-1;e++)s.addBeat(Pt.clone(i))}}_beatEffects(e,t){for(var s of t.properties)switch(this._handler.applyBeatProperty(this,e,s)){case 0:case 1:this._state.hasAnyProperData=!0;break;case 2:var i=Array.from(this._handler.knownBeatProperties).join(",");this.addSemanticDiagnostic({code:212,message:`Unrecogized property '${s.property.text}', expected one of `+i,severity:2,start:s.start,end:s.end})}}_beatDuration(e){if(e.value&&(this._state.currentDuration=this._parseDuration(e.value)),this._state.currentTupletNumerator=-1,this._state.currentTupletDenominator=-1,e.properties)for(var t of e.properties.properties)switch(this._handler.applyBeatDurationProperty(this,t)){case 0:case 1:this._state.hasAnyProperData=!0;break;case 2:var s=Array.from(this._handler.knownBeatDurationProperties).join(",");this.addSemanticDiagnostic({code:212,message:`Unrecogized property '${t.property.text}', expected one of `+s,severity:2,start:t.start,end:t.end})}}_parseDuration(e){switch(e.value){case-4:return-4;case-2:return-2;case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:return 256;default:return this.addSemanticDiagnostic({code:209,message:`Unexpected duration value '${e.value}', expected: -4, -2, 1, 2, 4, 8, 16, 32, 64, 128 or 256`,severity:2,start:e.start,end:e.end}),this._state.currentDuration}}_note(e,t){let s=!1,i=!1,a=-1,r=-1,n=-1,o=0,h=t.noteValue,l,d=this._state.staffNoteKind.has(this._state.currentStaff)?this._state.staffNoteKind.get(this._state.currentStaff):void 0;switch(h.nodeType){case 16:a=h.value,l=void 0!==t.noteString?1:2;break;case 17:case 10:var c=h.text;if(s="x"===c,(i="-"===c)||s)a=0,l=void 0;else{var u=F.parseTuning(c);if(u)l=0,r=u.octave,n=u.tone.noteValue,1===this._state.accidentalMode&&(o=u.tone.accidentalMode);else{l=2;var u=c.toLowerCase(),p=this._state.percussionArticulationNames;if(void 0===d&&0===p.size)for(var[m,g]of rt.instrumentArticulationNames)p.set(m.toLowerCase(),g),p.set(F.toArticulationId(m),g);if(!p.has(u))return this.addSemanticDiagnostic({code:209,message:`Unexpected percussion articulation value '${u}', expected: oneOf(${Array.from(this._state.percussionArticulationNames.keys()).join(",")}).`,severity:2,start:h.start,end:h.end}),void(a=Array.from(rt.instrumentArticulationNames.values())[0]);a=p.get(u)}}}void 0!==l?void 0===d?(d=l,this.applyStaffNoteKind(this._state.currentStaff,d)):d!==l&&this.addSemanticDiagnostic({code:218,message:`Wrong note kind '${Ft[l]}' for staff with note kind ''${Ft[d]}'. Do not mix incompatible staves and notes.`,severity:2}):void 0!==d&&(l=d);var f=new dt;if(((f.isDead=s)||i)&&(f.fret=a),f.isTieDestination=i,void 0!==l&&l===d)switch(l){case 0:f.octave=r,f.tone=n,f.accidentalMode=o;break;case 1:if(!t.noteString)return void this.addSemanticDiagnostic({code:207,message:"Missing string for fretted note.",severity:2,start:h.end,end:h.end});var b=t.noteString.value;if(b<1||b>this._state.currentStaff.tuning.length)return void this.addSemanticDiagnostic({code:208,message:"Note string is out of range. Available range: 1-"+this._state.currentStaff.tuning.length,severity:2,start:h.end,end:h.end});f.string=this._state.currentStaff.tuning.length-(b-1),i||(f.fret=a);break;case 2:let e=0;if(this._state.articulationValueToIndex.has(a))e=this._state.articulationValueToIndex.get(a);else{e=this._state.currentTrack.percussionArticulations.length;b=rt.getArticulationByInputMidiNumber(a);if(null===b)return void this.addSemanticDiagnostic({code:209,message:`Unexpected articulation value '${a}', expected: oneOf(${Array.from(rt.instrumentArticulations.keys()).join(",")}).`,severity:2,start:h.end,end:h.end});this._state.currentTrack.percussionArticulations.push(b),this._state.articulationValueToIndex.set(a,e)}f.percussionArticulation=e}e.addNote(f),this._state.hasAnyProperData=!0,t.noteEffects&&this._noteEffects(f,t.noteEffects)}getStaffNoteKind(e){return this._state.staffNoteKind.has(e)?this._state.staffNoteKind.get(e):void 0}applyStaffNoteKind(e,t){switch(this._state.staffNoteKind.set(e,t),t){case 0:e.isPercussion=!1,e.stringTuning.reset(),this._state.staffHasExplicitDisplayTransposition.has(e)||(e.displayTranspositionPitch=0);break;case 1:e.isPercussion=!1,this._detectTuningForStaff(e),this._handleTransposition(e);break;case 2:e.isPercussion=!0,e.stringTuning.reset(),this._state.staffHasExplicitDisplayTransposition.has(e)||(e.displayTranspositionPitch=0)}}_noteEffects(t,e){for(var s of e.properties){let e=this._handler.applyNoteProperty(this,t,s);switch(e=2===e?this._handler.applyBeatProperty(this,t.beat,s):e){case 0:case 1:break;case 2:var i=Array.from(this._handler.knownNoteProperties).concat(Array.from(this._handler.knownBeatProperties)).join(",");this.addSemanticDiagnostic({code:212,message:`Unrecogized property '${s.property.text}', expected one of `+i,severity:2,start:s.start,end:s.end})}}}_handleTransposition(e){var t;this._state.staffDisplayTranspositionApplied.has(e)||this._state.staffHasExplicitDisplayTransposition.has(e)||(t=e.track.playbackInfo.program,F.displayTranspositionPitches.has(t)?e.displayTranspositionPitch=F.displayTranspositionPitches.get(t):this._state.currentStaff.displayTranspositionPitch=0,this._state.staffDisplayTranspositionApplied.add(e))}_detectTuningForStaff(e){var t=e.track.playbackInfo.program;this._state.staffTuningApplied.has(e)||this._state.staffHasExplicitTuning.has(e)||(e.stringTuning.reset(),15===t||24<=t&&t<=31?e.stringTuning.tunings=qt.getDefaultTuningFor(6).tunings:32<=t&&t<=39?(e.stringTuning.tunings=[43,38,33,28],this._state.staffInitialClef.set(e,3)):40===t||44===t||45===t||48===t||49===t||50===t||51===t?e.stringTuning.tunings=[52,57,50,43]:41===t?e.stringTuning.tunings=[57,50,43,36]:42===t?e.stringTuning.tunings=[45,38,31,24]:43===t?e.stringTuning.tunings=[43,38,33,28]:105===t?e.stringTuning.tunings=[50,47,43,38,55]:106===t?e.stringTuning.tunings=[57,52,45]:107===t?e.stringTuning.tunings=[52,45,38,31]:110===t?e.stringTuning.tunings=[64,57,50,43]:this._state.staffNoteKind.has(e)&&1===this._state.staffNoteKind.get(e)&&(e.stringTuning=qt.getDefaultTuningFor(6)),this._state.staffTuningApplied.add(e))}_barMeta(e){let s=0<this._state.score.masterBars.length?void 0:[],t=this._state.currentStaff,i=!1,a=!1,r=!1,n=()=>{s&&(s=void 0,t=this._state.currentStaff,i=!1,a=!1,r=!1)},o=new be(()=>{var e=this._newBar(this._state.currentStaff);if(s){for(var t of s)this._handler.applyBarMetaData(this,e,t);n()}return e});for(var h of e.metaData){var l=h.tag.tag.text.toLowerCase();if(this._handler.knownStructuralMetaDataTags.has(l)){switch(this._state.hasAnyProperData=!0,this._handler.applyStructuralMetaData(this,h)){case 0:a||i?r=!0:(i=!0,t=this._state.currentStaff),o.reset();break;case 1:a?r=!0:(a=!0,t=this._state.currentStaff),o.reset()}if(s&&r){if(0!==t.bars.length)throw new b(2,"Unexpected internal error, didn't expect a filled staff after multiple \\track and/or \\staff tags. Please report this problem providing the input alphaTex.");var d,c=new Ae,l=(t.addBar(c),new We);c.addVoice(l),t.bars.length>this._state.score.masterBars.length&&(l=new $e,this._state.score.addMasterBar(l));for(d of s)this._handler.applyBarMetaData(this,c,d);n()}}else this._handler.knownScoreMetaDataTags.has(h.tag.tag.text.toLowerCase())?(this._state.hasAnyProperData=!0,this._handler.applyScoreMetaData(this,this._state.score,h)):this._handler.knownStaffMetaDataTags.has(h.tag.tag.text.toLowerCase())?(this._state.hasAnyProperData=!0,this._handler.applyStaffMetaData(this,this._state.currentStaff,h),this.addSemanticDiagnostic({code:306,message:"This staff metadata tag should be specified as staff property.",severity:1,start:h.start,end:h.end})):this._handler.knownBarMetaDataTags.has(h.tag.tag.text.toLowerCase())?(this._state.hasAnyProperData=!0,s?s.push(h):this._handler.applyBarMetaData(this,o.value,h)):(l=Array.from(this._handler.allKnownMetaDataTags).join(","),this.addSemanticDiagnostic({code:204,message:`Unrecognized metadata '${h.tag.tag.text}', expected one of: `+l,severity:2,start:h.tag.start,end:h.tag.end}))}return o.value}_newBar(e){if(this._state.barIndex<e.bars.length)return t=e.bars[this._state.barIndex],this._state.barIndex++,t;var t,s=0===e.bars.length?1:e.bars[0].voices.length,i=new Ae;e.addBar(i),i.previousBar&&(i.clef=i.previousBar.clef,i.clefOttava=i.previousBar.clefOttava,i.keySignature=i.previousBar.keySignature,i.keySignatureType=i.previousBar.keySignatureType),this._state.barIndex++,0<i.index&&(i.clef=i.previousBar.clef);for(let e=0;e<s;e++){var a=new We;i.addVoice(a)}return this._state.currentStaff.bars.length>this._state.score.masterBars.length&&(t=new $e,this._state.score.addMasterBar(t),0<t.index)&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel),i}startNewStaff(){var e,t;return this._state.ignoredInitialVoice=!1,this._state.ignoredInitialStaff||0<this._state.currentTrack.staves[0].bars.length?(e=this._state.currentStaff.isPercussion,this._state.currentTrack.ensureStaveCount(this._state.currentTrack.staves.length+1),t=this._state.currentTrack.staves[this._state.currentTrack.staves.length-1],this._beginStaff(t),e&&this.applyPercussionStaff(this._state.currentStaff),this._state.currentDynamics=5):this._state.ignoredInitialStaff=!0,this._state.currentStaff}applyPercussionStaff(e){e.isPercussion=!0,e.showTablature=!1,e.track.playbackInfo.program=0}startNewTrack(){return this._state.ignoredInitialVoice=!1,this._state.ignoredInitialStaff=!1,this._state.ignoredInitialTrack||0<this._state.score.masterBars.length?this._newTrack():this._state.ignoredInitialTrack=!0,this._state.currentTrack}startNewVoice(){if(0===this._state.voiceIndex&&(0===this._state.currentStaff.bars.length||1===this._state.currentStaff.bars.length&&this._state.currentStaff.bars[0].isEmpty&&!this._state.ignoredInitialVoice))this._state.ignoredInitialVoice=!0;else{for(var e of this._state.currentStaff.bars){var t=new We;e.addVoice(t)}this._state.voiceIndex++,this._state.barIndex=0,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1}}},a=class{},Ms=class extends a{constructor(e){super(),this.n=e}},Es=class extends a{constructor(e,t){super(),this.left=e,this.right=t}},Ls=class extends a{constructor(e,t){super(),this.n=e,this.table=t}},Cs=class Lu{static make(t,s,i,a){var r=[],n=[];if(32<a)throw new Gt("Invalid huffman");for(let e=0;e<a;e++)r.push(0),n.push(0);for(let e=0;e<i;e++){var o=t[e+s];if(a<=o)throw new Gt("Invalid huffman");r[o]++}let h=0;for(let e=1;e<a-1;e++)h=h+r[e]<<1,n[e]=h;var l=new Map;for(let e=0;e<i;e++){var d,c=t[e+s];0!==c&&(n[c-1]=(d=n[c-1])+1,l.set(d<<5|c,e))}return Lu._treeCompress(new Es(Lu._treeMake(l,a,0,1),Lu._treeMake(l,a,1,1)))}static _treeMake(e,t,s,i){if(t<i)throw new Gt("Invalid huffman");var a=s<<5|i;return e.has(a)?new Ms(e.get(a)):(s<<=1,i+=1,new Es(Lu._treeMake(e,t,s,i),Lu._treeMake(e,t,1|s,i)))}static _treeCompress(e){var t=Lu._treeDepth(e);if(0===t)return e;if(1===t){if(e instanceof Es)return new Es(Lu._treeCompress(e.left),Lu._treeCompress(e.right));throw new Gt("assert")}var s=1<<t,i=[];for(let e=0;e<s;e++)i.push(new Ms(-1));return Lu._treeWalk(i,0,0,t,e),new Ls(t,i)}static _treeWalk(e,t,s,i,a){a instanceof Es&&0<i?(Lu._treeWalk(e,t,s+1,i-1,a.left),Lu._treeWalk(e,t|1<<s,s+1,i-1,a.right)):e[t]=Lu._treeCompress(a)}static _treeDepth(e){if(e instanceof Ms)return 0;if(e instanceof Ls)throw new Gt("assert");var t;return e instanceof Es?1+((t=Lu._treeDepth(e.left))<(e=Lu._treeDepth(e.right))?t:e):0}},Fs=class Fs{constructor(){this.buffer=new Uint8Array(Fs._bufferSize),this.pos=0}slide(){var e=new Uint8Array(Fs._bufferSize);this.pos-=Fs._size,e.set(this.buffer.subarray(Fs._size,Fs._size+this.pos),0),this.buffer=e}addBytes(e,t,s){this.pos+s>Fs._bufferSize&&this.slide(),this.buffer.set(e.subarray(t,t+s),this.pos),this.pos+=s}addByte(e){this.pos===Fs._bufferSize&&this.slide(),this.buffer[this.pos]=e,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}},Ds=(Fs._size=32768,Fs._bufferSize=65536,Fs),y=class y{constructor(e){this._nbits=0,this._bits=0,this._state=1,this._isFinal=!1,this._huffman=y._fixedHuffman,this._huffdist=null,this._len=0,this._dist=0,this._needed=0,this._output=null,this._outpos=0,this._lengths=[],this._window=new Ds,this._input=e;for(let e=0;e<19;e++)this._lengths.push(-1)}static _buildFixedHuffman(){var t=[];for(let e=0;e<288;e++)t.push(e<=143?8:e<=255?9:e<=279?7:8);return Cs.make(t,0,288,10)}readBytes(e,t,s){if(this._needed=s,this._outpos=t,this._output=e,0<s)for(;this._inflateLoop(););return s-this._needed}_inflateLoop(){switch(this._state){case 0:var e=this._input.readByte();if(8!=(15&e))throw new Gt("Invalid data");var t=this._input.readByte(),s=0!=(32&t);if(((e<<8)+t)%31!=0)throw new Gt("Invalid data");if(s)throw new Gt("Unsupported dictionary");return this._state=1,!0;case 4:return this._state=7,!0;case 7:return!1;case 1:switch(this._isFinal=this._getBit(),this._getBits(2)){case 0:if(this._len=f.readUInt16LE(this._input),f.readUInt16LE(this._input)!==65535-this._len)throw new Gt("Invalid data");this._state=3;var i=this._inflateLoop();return this._resetBits(),i;case 1:return this._huffman=y._fixedHuffman,this._huffdist=null,this._state=2,!0;case 2:var a=this._getBits(5)+257,r=this._getBits(5)+1,n=this._getBits(4)+4;for(let e=0;e<n;e++)this._lengths[y._codeLengthsPos[e]]=this._getBits(3);for(let e=n;e<19;e++)this._lengths[y._codeLengthsPos[e]]=0;this._huffman=Cs.make(this._lengths,0,19,8);var o=[];for(let e=0;e<a+r;e++)o.push(0);return this._inflateLengths(o,a+r),this._huffdist=Cs.make(o,a,r,16),this._huffman=Cs.make(o,0,a,16),this._state=2,!0;default:throw new Gt("Invalid data")}case 3:e=this._len<this._needed?this._len:this._needed,t=f.readByteArray(this._input,e);return this._len-=e,this._addBytes(t,0,e),0===this._len&&(this._state=this._isFinal?4:1),0<this._needed;case 6:s=this._len<this._needed?this._len:this._needed;return this._addDistOne(s),this._len-=s,0===this._len&&(this._state=2),0<this._needed;case 5:for(;0<this._len&&0<this._needed;){var h=this._len<this._dist?this._len:this._dist,h=this._needed<h?this._needed:h;this._addDist(this._dist,h),this._len-=h}return 0===this._len&&(this._state=2),0<this._needed;case 2:if((t=this._applyHuffman(this._huffman))<256)return this._addByte(t),0<this._needed;if(256===t)this._state=this._isFinal?4:1;else{t=t-257&255,e=y._lenExtraBitsTbl[t];if(-1===e)throw new Gt("Invalid data");this._len=y._lenBaseValTbl[t]+this._getBits(e);s=this._huffdist,t=s?this._applyHuffman(s):this._getRevBits(5);if(-1===(e=y._distExtraBitsTbl[t]))throw new Gt("Invalid data");if(this._dist=y._distBaseValTbl[t]+this._getBits(e),this._dist>this._window.available())throw new Gt("Invalid data");this._state=1===this._dist?6:5}return!0}return!1}_addDistOne(t){var s=this._window.getLastChar();for(let e=0;e<t;e++)this._addByte(s)}_addByte(e){this._window.addByte(e),this._output[this._outpos]=e,this._needed--,this._outpos++}_addDist(e,t){this._addBytes(this._window.buffer,this._window.pos-e,t)}_getBit(){0===this._nbits&&(this._nbits=8,this._bits=this._input.readByte());var e=1==(1&this._bits);return this._nbits--,this._bits=this._bits>>1,e}_getBits(e){for(;this._nbits<e;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;var t=this._bits&(1<<e)-1;return this._nbits-=e,this._bits=this._bits>>e,t}_getRevBits(e){return 0===e?0:this._getBit()?1<<e-1|this._getRevBits(e-1):this._getRevBits(e-1)}_resetBits(){this._bits=0,this._nbits=0}_addBytes(e,t,s){this._window.addBytes(e,t,s),this._output.set(e.subarray(t,t+s),this._outpos),this._needed-=s,this._outpos+=s}_inflateLengths(e,t){let s=0,i=0;for(;s<t;){var a=this._applyHuffman(this._huffman);switch(a){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=a,e[s]=a,s++;break;case 16:var r=s+3+this._getBits(2);if(t<r)throw new Gt("Invalid data");for(;s<r;)e[s]=i,s++;break;case 17:if((s+=3+this._getBits(3))>t)throw new Gt("Invalid data");break;case 18:if((s+=11+this._getBits(7))>t)throw new Gt("Invalid data");break;default:throw new Gt("Invalid data")}}}_applyHuffman(e){if(e instanceof Ms)return e.n;if(e instanceof Es)return this._applyHuffman(this._getBit()?e.right:e.left);if(e instanceof Ls)return this._applyHuffman(e.table[this._getBits(e.n)]);throw new Gt("Invalid data")}},Is=(y._lenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1],y._lenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],y._distExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1],y._distBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],y._codeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],y._fixedHuffman=y._buildFixedHuffman(),y),As=class{constructor(e,t){var s=(this.fullName=e).lastIndexOf("/");this.fileName=-1===s||s===e.length-1?this.fullName:e.substr(s+1),this.data=t}},Rs=(As.OptionalDataDescriptorSignature=134695760,As.CompressionMethodDeflate=8,As.LocalFileHeaderSignature=67324752,As.CentralFileHeaderSignature=33639248,As.EndOfCentralDirSignature=101010256,class{constructor(e){this._readable=e}read(){for(var e=[];;){var t=this._readEntry();if(!t)break;e.push(t)}return e}_readEntry(){var e=this._readable;if(f.readInt32LE(e)!==As.LocalFileHeaderSignature)return null;f.readUInt16LE(e);var t=f.readUInt16LE(e),s=f.readUInt16LE(e),i=0!==s;if(i&&s!==As.CompressionMethodDeflate)return null;f.readInt16LE(this._readable),f.readInt16LE(this._readable),f.readInt32LE(e),f.readInt32LE(e);var s=f.readInt32LE(e),a=f.readInt16LE(e),r=f.readInt16LE(e),a=f.toString(f.readByteArray(e,a),"utf-8");e.skip(r);let n;if(i){for(var o=Bs.empty(),h=new Is(this._readable),l=new Uint8Array(65536);;){var d=h.readBytes(l,0,l.length);if(o.write(l,0,d),d<l.length)break}n=o.toArray()}else n=f.readByteArray(this._readable,s);return 0!=(8&t)&&(f.readInt32LE(this._readable)===As.OptionalDataDescriptorSignature&&f.readInt32LE(this._readable),f.readInt32LE(this._readable),f.readInt32LE(this._readable)),new As(a,n)}}),Os=class Cu{constructor(){this.nodeType=0,this.localName=null,this.value=null,this.childNodes=[],this.attributes=new Map,this.firstChild=null,this.firstElement=null}*childElements(){for(var e of this.childNodes)1===e.nodeType&&(yield e)}addChild(e){this.childNodes.push(e),1!==(this.firstChild=e).nodeType&&3!==e.nodeType||(this.firstElement=e)}getAttribute(e,t=""){return this.attributes.has(e)?this.attributes.get(e):t}getElementsByTagName(e,t=!1){var s=[];return this._searchElementsByTagName(this.childNodes,s,e,t),s}_searchElementsByTagName(e,t,s,i=!1){for(var a of e)a&&1===a.nodeType&&a.localName===s&&t.push(a),i&&this._searchElementsByTagName(a.childNodes,t,s,!0)}findChildElement(e){for(var t of this.childNodes)if(t&&1===t.nodeType&&t.localName===e)return t;return null}addElement(e){var t=new Cu;return t.nodeType=1,t.localName=e,this.addChild(t),t}get innerText(){if(1!==this.nodeType&&4!==this.nodeType)return this.value??"";{if(this.firstElement&&3===this.firstElement.nodeType)return this.firstElement.innerText;let e="";for(var t of this.childNodes)e+=t.innerText?.toString();return e.trim()}}set innerText(e){var t=new Cu;t.nodeType=2,t.value=e,this.childNodes=[t]}setCData(e){var t=new Cu;t.nodeType=3,t.value=e,this.childNodes=[t]}},Vs=class extends b{constructor(e,t,s){super(1,e),this.pos=0,this.xml=t,this.pos=s}},S=class S{static parse(e,t,s){e.charCodeAt(t);let i,a=1,r=1,n=0,o="",h=1,l=null,d=null,c=0,u=0;for(;t<e.length;){switch(i=e.charCodeAt(t),a){case 0:switch(i){case S.CharCodeLF:case S.CharCodeCR:case S.CharCodeTab:case S.CharCodeSpace:break;default:a=r;continue}break;case 1:if(i!==S.CharCodeLowerThan){n=t,a=13;continue}a=0,r=2;break;case 13:i===S.CharCodeLowerThan?(o+=e.substr(n,t-n),(p=new Os).nodeType=2,p.value=o,o="",s.addChild(p),a=0,r=2):i===S.CharCodeAmp&&(o+=e.substr(n,t-n),a=18,h=13,n=t+1);break;case 17:var p;i===S.CharCodeBrackedClose&&e.charCodeAt(t+1)===S.CharCodeBrackedClose&&e.charCodeAt(t+2)===S.CharCodeGreaterThan&&((p=new Os).nodeType=3,p.value=e.substr(n,t-n),s.addChild(p),t+=2,a=1);break;case 2:switch(i){case S.CharCodeExclamation:if(e.charCodeAt(t+1)===S.CharCodeBrackedOpen){if(t+=2,"CDATA["!==e.substr(t,6).toUpperCase())throw new Vs("Expected <![CDATA[",e,t);t+=5,a=17}else if(e.charCodeAt(t+1)===S.CharCodeUpperD||e.charCodeAt(t+1)===S.CharCodeLowerD){if("OCTYPE"!==e.substr(t+2,6).toUpperCase())throw new Vs("Expected <!DOCTYPE",e,t);t+=8,a=16}else{if(e.charCodeAt(t+1)!==S.CharCodeMinus||e.charCodeAt(t+2)!==S.CharCodeMinus)throw new Vs("Expected \x3c!--",e,t);t+=2,a=15}n=t+1;break;case S.CharCodeQuestion:a=14,n=t;break;case S.CharCodeSlash:if(!s)throw new Vs("Expected node name",e,t);n=t+1,a=0,r=10;break;default:a=3,n=t;continue}break;case 3:if(S._isValidChar(i))break;if(t===n)throw new Vs("Expected node name",e,t);(l=new Os).nodeType=1,l.localName=e.substr(n,t-n),s.addChild(l),a=0,r=4;continue;case 4:switch(i){case S.CharCodeSlash:a=11;break;case S.CharCodeGreaterThan:a=9;break;default:a=5,n=t;continue}break;case 5:if(S._isValidChar(i))break;if(n===t)throw new Vs("Expected attribute name",e,t);if(d=e.substr(n,t-n),l.attributes.has(d))throw new Vs(`Duplicate attribute [${d}]`,e,t);a=0,r=6;continue;case 6:if(i!==S.CharCodeEquals)throw new Vs("Expected =",e,t);a=0,r=7;break;case 7:switch(i){case S.CharCodeDoubleQuote:case S.CharCodeSingleQuote:o="",a=8,n=t+1,u=i}break;case 8:i===S.CharCodeAmp?(o+=e.substr(n,t-n),a=18,h=8,n=t+1):i===u&&(m=o+=e.substr(n,t-n),o="",l.attributes.set(d,m),a=0,r=4);break;case 9:t=S.parse(e,t,l),n=t,a=1;break;case 11:if(i!==S.CharCodeGreaterThan)throw new Vs("Expected >",e,t);a=1;break;case 12:if(i===S.CharCodeGreaterThan)return t;throw new Vs("Expected >",e,t);case 10:if(S._isValidChar(i))break;if(n===t)throw new Vs("Expected node name",e,t);if(e.substr(n,t-n)!==s.localName)throw new Vs(`Expected </${s.localName}>`,e,t);a=0,r=12;continue;case 15:i===S.CharCodeMinus&&e.charCodeAt(t+1)===S.CharCodeMinus&&e.charCodeAt(t+2)===S.CharCodeGreaterThan&&(t+=2,a=1);break;case 16:var m;i===S.CharCodeBrackedOpen?c++:i===S.CharCodeBrackedClose?c--:i===S.CharCodeGreaterThan&&0===c&&((m=new Os).nodeType=5,m.value=e.substr(n,t-n),s.addChild(m),a=1);break;case 14:i===S.CharCodeQuestion&&e.charCodeAt(t+1)===S.CharCodeGreaterThan&&(t++,a=1);break;case 18:var g,f;i===S.CharCodeSemi?((g=e.substr(n,t-n)).charCodeAt(0)===S.CharCodeSharp?(f=g.charCodeAt(1)===S.CharCodeLowerX?Number.parseInt("0"+g.substr(1,g.length-1),10):Number.parseInt(g.substr(1,g.length-1),10),o+=String.fromCharCode(f)):S._escapes.has(g)?o+=S._escapes.get(g):o+=`&${g};`?.toString(),n=t+1,a=h):S._isValidChar(i)||i===S.CharCodeSharp||(o=(o+="&")+e.substr(n,t-n),t--,n=t+1,a=h)}t++}var b;if(1===a&&(n=t,a=13),13===a)return t!==n&&(o+=e.substr(n,t-n),(b=new Os).nodeType=2,b.value=o,s.addChild(b)),t;if(18===a&&13===h)return o=(o+="&")+e.substr(n,t-n),(b=new Os).nodeType=2,b.value=o,s.addChild(b),t;throw new Vs("Unexpected end",e,t)}static _isValidChar(e){return e>=S.CharCodeLowerA&&e<=S.CharCodeLowerZ||e>=S.CharCodeUpperA&&e<=S.CharCodeUpperZ||e>=S.CharCode0&&e<=S.CharCode9||e===S.CharCodeColon||e===S.CharCodeDot||e===S.CharCodeUnderscore||e===S.CharCodeMinus}},Ws=(S.CharCodeLF=10,S.CharCodeTab=9,S.CharCodeCR=13,S.CharCodeSpace=32,S.CharCodeLowerThan=60,S.CharCodeAmp=38,S.CharCodeBrackedClose=93,S.CharCodeBrackedOpen=91,S.CharCodeGreaterThan=62,S.CharCodeExclamation=33,S.CharCodeUpperD=68,S.CharCodeLowerD=100,S.CharCodeMinus=45,S.CharCodeQuestion=63,S.CharCodeSlash=47,S.CharCodeEquals=61,S.CharCodeDoubleQuote=34,S.CharCodeSingleQuote=39,S.CharCodeSharp=35,S.CharCodeLowerX=120,S.CharCodeLowerA=97,S.CharCodeLowerZ=122,S.CharCodeUpperA=65,S.CharCodeUpperZ=90,S.CharCode0=48,S.CharCode9=57,S.CharCodeColon=58,S.CharCodeDot=46,S.CharCodeUnderscore=95,S.CharCodeSemi=59,S._escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]),S),Hs=class Fu{constructor(e,t){this._result=[],this._indention=e,this._xmlHeader=t,this._currentIndention="",this._isStartOfLine=!0}writeNode(e){switch(e.nodeType){case 0:break;case 1:0<this._result.length&&this._writeLine(),this._write("<"+e.localName);for(var[t,s]of e.attributes)this._write(` ${t}="`),this._writeAttributeValue(s),this._write('"');if(0===e.childNodes.length)this._write("/>");else{if(this._write(">"),1!==e.childNodes.length||e.firstElement){this._indent();for(var i of e.childNodes)1!==i.nodeType&&6!==i.nodeType||this.writeNode(i);this._unindend(),this._writeLine()}else this.writeNode(e.childNodes[0]);this._write(`</${e.localName}>`)}break;case 2:e.value&&this._write(e.value);break;case 3:null!==e.value&&this._write(`<![CDATA[${e.value}]]>`);break;case 4:this._xmlHeader&&this._write('<?xml version="1.0" encoding="utf-8"?>');for(var a of e.childNodes)this.writeNode(a);break;case 5:this._write(`<!DOCTYPE ${e.value}>`);break;case 6:this._write(`<!-- ${e.value} -->`)}}_unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}_indent(){this._currentIndention+=this._indention}_writeAttributeValue(t){for(let e=0;e<t.length;e++){var s=t.charAt(e);switch(s){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(s)}}}static write(e,t,s){t=new Fu(t,s);return t.writeNode(e),t.toString()}_write(e){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(e),this._isStartOfLine=!1}_writeLine(e=null){e&&this._write(e),0<this._indention.length&&!this._isStartOfLine&&(this._result.push(`
`),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}},Gs=class extends Os{constructor(){super(),this.nodeType=4}parse(e){Ws.parse(e,0,this)}toString(){return this.toFormattedString()}toFormattedString(e="",t=!1){return Hs.write(this,e,t)}},n=class{constructor(){this.noteRange=1,this.x=0,this.y=0}},zs=class extends n{constructor(){super(...arguments),this.align=0,this.frame=0,this.text="",this.fontFace="",this.weight=0,this.height=0}},Us=class extends n{constructor(){super(...arguments),this.chord=new Ht}},Ys=class extends n{},Xs=class extends n{},Js=class extends n{constructor(){super(...arguments),this.number=0}},qs=class extends n{constructor(){super(...arguments),this.decrescendo=!1}},js=class extends n{constructor(){super(...arguments),this.allNumbers=!1,this.firstNumber=0,this.lastNumber=0}},$s=class extends n{constructor(){super(...arguments),this.octave=1}},Ks=class extends n{},Qs=class{constructor(){this.defaultClef=4,this.description="",this.percussion=!1,this.instrument=0,this.volume=0,this.transpose=0,this.index=0}},Zs=class{constructor(){this.from=0,this.to=0,this.curly=!1}},ei=class{constructor(){this.currentBarIndex=-1,this.currentBarComplete=!0,this.currentBarDuration=0,this.currentPosition=0,this.voiceStemDir=null,this.repeatCount=0,this.repeatEnd=null}},ti=class Du{constructor(){this._trackChannel=0,this._beamingMode=0,this._isFirstSystem=!0,this._initialTempo=-1,this._staffLookup=new Map,this._brackets=[],this._staffLayoutLookup=new Map,this._staffLayouts=[],this._timeSignature=new $e,this._voiceStates=new Map}parseXml(e,t){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;var s=new Gs;try{s.parse(e)}catch(e){throw new Ts("Could not parse XML",e)}this._parseDom(s),this._consolidate(),this.score.finish(t)}_consolidate(){F.consolidate(this.score),Du._applyEffectRange(this._slurs,(e,t)=>{t.isLegatoOrigin=!0}),Du._applyEffectRange(this._crescendo,(e,t)=>{t.crescendo=e.decrescendo?2:1})}static _applyEffectRange(e,i){for(var[a,r]of e){let t=r.noteRange,s=a;for(let e=0;e<t;e++)if(i(r,s),s.index+1<s.voice.beats.length)s=s.voice.beats[s.index+1];else{if(!(s.voice.bar.index+1<s.voice.bar.staff.bars.length))break;s=s.voice.bar.staff.bars[s.voice.bar.index+1].voices[s.voice.index].beats[0]}}}_parseDom(e){var t,e=e.firstElement;if(!e)throw new Ts("No valid XML");if("score"!==e.localName)throw new Ts('Root node of XML was not "score"');this.score=new qe;for(t of e.childElements())switch(t.localName){case"info":this._parseInfo(t);break;case"layout":this._parseLayout(t);break;case"gallery":this._parseGallery(t);break;case"pageObjects":this._parsePageObjects(t);break;case"systems":this._parseSystems(t)}}_parseLayout(e){for(var t of e.childElements())switch(t.localName){case"staves":this._parseLayoutStaves(t);break;case"brackets":this._parseBrackets(t)}var s=this._brackets.filter(e=>!!e.curly);s.sort((e,t)=>e.from-t.from);let i=0,a=null;for(let e=0;e<this._staffLayouts.length;e++){for(var r=this._staffLayouts[e];i<s.length&&e>s[i].to;)i++;a&&i<s.length&&e>s[i].from&&e<=s[i].to?a.ensureStaveCount(a.staves.length+1):((a=new ts).ensureStaveCount(1),a.name=r.description,a.playbackInfo.volume=Math.floor(r.volume/128*16),a.playbackInfo.program=r.instrument,r.percussion?(a.playbackInfo.primaryChannel=9,a.playbackInfo.secondaryChannel=9):(a.playbackInfo.primaryChannel=this._trackChannel++,a.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(a));var n=a.staves[a.staves.length-1];n.isPercussion=r.percussion,n.transpositionPitch=r.transpose,n.displayTranspositionPitch=0,n.showTablature=!1,this._staffLookup.set(r.index,n)}}_parseBrackets(e){for(var t of e.childElements())"bracket"===t.localName&&this._parseBracket(t)}_parseBracket(e){var t=new Zs;t.from=Number.parseInt(e.getAttribute("from"),10),t.to=Number.parseInt(e.getAttribute("to"),10),e.attributes.has("curly")&&(t.curly="true"===e.attributes.get("curly")),this._brackets.push(t)}_parseLayoutStaves(e){for(var t of e.childElements())"staffLayout"===t.localName&&this._parseStaffLayout(t)}_parseStaffLayout(e){var t,s=new Qs;s.description=e.getAttribute("description");for(t of e.childElements())switch(t.localName){case"notation":t.attributes.has("defaultClef")&&(s.defaultClef=this._parseClef(t.attributes.get("defaultClef")));break;case"sound":t.attributes.has("percussion")&&(s.percussion="true"===t.attributes.get("percussion")),t.attributes.has("instr")&&(s.instrument=Number.parseInt(t.attributes.get("instr"),10)),t.attributes.has("volume")&&(s.volume=Number.parseInt(t.attributes.get("volume"),10)),t.attributes.has("transpose")&&(s.transpose=Number.parseInt(t.attributes.get("transpose"),10))}this._staffLayoutLookup.set(s.description,s),s.index=this._staffLayouts.length,this._staffLayouts.push(s)}_parseClef(e){switch(e){case"treble":return 4;case"bass":return 3;case"alto":case"tenor":return 2}return 4}_parseClefOttava(e){return e.endsWith("-")?3:e.endsWith("+")?1:2}_parseSystems(e){for(var t of e.childElements())"system"===t.localName&&this._parseSystem(t)}_parseSystem(e){e.attributes.has("tempo")&&0===this.score.masterBars.length&&(this._initialTempo=Number.parseInt(e.attributes.get("tempo"),10)),"0"===e.getAttribute("beamGrouping")&&(this._beamingMode=1);for(var t of e.childElements())"staves"===t.localName&&this._parseStaves(e,t);this._isFirstSystem=!1}_parseStaves(e,t){var s,i=this.score.masterBars.length;for(s of t.childElements())"staff"===s.localName&&this._parseStaff(e,i,s)}_parseStaff(e,t,s){for(var i,a=s.getAttribute("layout"),r=(this._currentStaffLayout=this._staffLayoutLookup.get(a),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this._parseTime(s.getAttribute("defaultTime")),this._staffLookup.get(this._currentStaffLayout.index));r.bars.length<t;)this._addNewBar(r);for(i of s.childElements())"voices"===i.localName&&this._parseVoices(a,r,e,t,i)}_parseTime(e){switch(e){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:var t;0<e.indexOf("/")&&(t=e.split("/"),this._timeSignature.timeSignatureNumerator=Number.parseInt(t[0],10),this._timeSignature.timeSignatureDenominator=Number.parseInt(t[1],10),this._timeSignature.timeSignatureCommon=!1)}}_parseVoices(e,t,s,i,a){let r=0;for(var n of a.childElements())"voice"===n.localName&&(this._parseVoice(e,t,s,r,i,n),r++)}_getOrCreateBar(e,t){return t<e.bars.length?e.bars[t]:this._addNewBar(e)}_addNewBar(e){var t=new Ae;return 0<e.bars.length?(t.clef=e.bars[e.bars.length-1].clef,t.clefOttava=e.bars[e.bars.length-1].clefOttava,t.keySignature=e.bars[e.bars.length-1].keySignature,t.keySignatureType=e.bars[e.bars.length-1].keySignatureType):t.clef=this._currentStaffLayout.defaultClef,e.addBar(t),e.bars.length>this.score.masterBars.length&&(e=new $e,this.score.addMasterBar(e),0<e.index?e.tripletFeel=e.previousMasterBar.tripletFeel:0<this._initialTempo&&e.tempoAutomations.push(K.buildTempoAutomation(!1,0,this._initialTempo,0)),e.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,e.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,e.timeSignatureCommon=this._timeSignature.timeSignatureCommon),t}_newBar(e,t){this._currentVoiceState.currentBarIndex++,this._currentBar=this._getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this._ensureVoice(e,t)}_parseVoice(e,t,s,i,a,r){e=e+"_"+i;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(e)?(this._currentVoiceState=this._voiceStates.get(e),this._currentBar=this._getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this._ensureVoice(t,i)):(this._currentVoiceState=new ei,this._currentVoiceState.currentBarIndex=a-1,this._voiceStates.set(e,this._currentVoiceState),this._newBar(t,i)),r.attributes.has("stemDir"))switch(r.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=0;break;case"down":this._currentVoiceState.voiceStemDir=1;break;default:this._currentVoiceState.voiceStemDir=null}else this._currentVoiceState.voiceStemDir=null;a=r.findChildElement("noteObjects");if(s.attributes.has("tempo")&&((e=new K).isLinear=!0,e.type=0,e.value=Number.parseInt(s.attributes.get("tempo"),10),e.ratioPosition=this._currentVoiceState.currentPosition/this._currentVoiceState.currentBarDuration,this._currentBar.masterBar.tempoAutomations.push(e)),a)for(var n of a.childElements())switch(this._currentVoiceState.currentBarComplete&&"barline"!==n.localName&&this._newBar(t,i),n.localName){case"clefSign":this._currentBar.clef=this._parseClef(n.getAttribute("clef")),this._currentBar.clefOttava=this._parseClefOttava(n.getAttribute("clef"));break;case"keySign":this._currentBar.keySignature=Number.parseInt(n.getAttribute("fifths"),10);break;case"timeSign":this._parseTime(n.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(n.getAttribute("type")){case"double":this._currentBar.barLineRight=7,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this._parseBarDrawObject(n),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this._newBar(t,i),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this._parseBarDrawObject(n),this._newBar(t,i),this._currentBar.masterBar.isRepeatStart=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0}break;case"chord":var o=new wt;this._initFromPreviousBeat(o,this._currentVoice),o.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(o.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this._parseDuration(o,n.findChildElement("duration")),o.updateDurations(),this._currentVoiceState.currentPosition+=o.playbackDuration,this._currentVoice.addBeat(o),this._parseChord(o,n),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":o=this._parseRestDurations(n.findChildElement("duration"));o&&(this._initFromPreviousBeat(o,this._currentVoice),o.updateDurations(),this._currentVoiceState.currentPosition+=o.playbackDuration,this._currentVoice.addBeat(o),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration)&&(this._currentVoiceState.currentBarComplete=!0)}}_initFromPreviousBeat(e,t){t=this._getLastBeat(t);t&&(e.dynamics=t.dynamics)}_getLastBeat(e){if(0<e.beats.length)return e.beats[e.beats.length-1];if(0<e.bar.index){var t=e.bar.staff.bars[e.bar.index-1];if(e.index<t.voices.length)return t=t.voices[e.index],this._getLastBeat(t)}return null}_ensureVoice(e,t){for(;this._currentBar.voices.length<t+1;)this._currentBar.addVoice(new We);(!this._voiceCounts.has(e.track.index)||this._voiceCounts.get(e.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(e.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[t]}_parseChord(e,t){var s,i=new dt;for(s of t.childElements())switch(s.localName){case"stem":switch(s.getAttribute("dir")){case"up":e.preferredBeamDirection=0;break;case"down":e.preferredBeamDirection=1}break;case"articulation":switch(s.getAttribute("type")){case"staccato":i.isStaccato=!0;break;case"normalAccent":i.accentuated=1;break;case"strongAccent":i.accentuated=2}break;case"lyric":this._parseLyric(e,s);break;case"drawObjects":this._parseBeatDrawObject(e,s);break;case"heads":this._parseHeads(e,i,s);break;case"beam":switch(s.getAttribute("group")){case"force":e.beamingMode=2;break;case"divide":e.beamingMode=1}}}_parseHeads(e,t,s){for(var i of s.childElements())"head"===i.localName&&this._parseHead(e,t,i)}_parseHead(e,t,s){var i,a=new dt,r=F.parseTuning(s.getAttribute("pitch"));a.octave=r.octave-1,a.tone=r.tone.noteValue,a.isStaccato=t.isStaccato,a.accentuated=t.accentuated,e.addNote(a);for(i of s.childElements())switch(i.localName){case"alter":i.attributes.has("step")&&(a.tone+=Number.parseInt(i.attributes.get("step"),10));break;case"tie":i.attributes.has("begin")?this._tieStartIds.has(a.id)||(this._tieStartIds.set(a.id,!0),this._tieStarts.push(a)):i.attributes.has("end")&&0<this._tieStarts.length&&!a.isTieDestination&&(a.isTieDestination=!0,a.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(a.id))}}_parseBeatDrawObject(e,t){for(var s of t.childElements())"drawObj"===s.localName&&(s=this._parseDrawObj(s))&&(s instanceof zs?s.fontFace.startsWith("capella")?"u"===s.text?(e.fermata=new At,e.fermata.type=1):"f"===s.text?e.dynamics=5:"j"===s.text&&(e.dynamics=4):this._isFirstSystem&&""===this.score.title&&1===s.align&&16<s.height&&400<s.weight?this.score.title=s.text:this._isFirstSystem&&""===this.score.artist&&1===s.align&&s.y<0?this.score.artist=s.text:this._isFirstSystem&&""===this.score.music&&2===s.align&&s.y<0?this.score.music=s.text:s.text.startsWith("by capella")||(e.text=s.text):s instanceof Us||(s instanceof Xs?e.vibrato=1:s instanceof qs?(e.crescendo=s.decrescendo?2:1,s.noteRange++,this._crescendo.set(e,s)):s instanceof Ys?this._slurs.set(e,s):s instanceof js&&this._applyVolta(s)))}_parseBarDrawObject(e){for(var t of e.childElements())"drawObj"===t.localName&&(t=this._parseDrawObj(t))&&t instanceof js&&this._applyVolta(t)}_applyVolta(s){if(0<s.lastNumber?(this._currentVoiceState.repeatCount=s.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):0<s.firstNumber&&(this._currentVoiceState.repeatCount=s.firstNumber,this._currentVoiceState.repeatEnd)&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount),0<s.lastNumber&&0<s.firstNumber){let t=0;for(let e=s.firstNumber;e<=s.lastNumber;e++)t|=1<<e-1;this._currentBar.masterBar.alternateEndings=t}else 0<s.lastNumber?this._currentBar.masterBar.alternateEndings=1<<s.lastNumber-1:0<s.firstNumber&&(this._currentBar.masterBar.alternateEndings=1<<s.firstNumber-1)}_parseLyric(t,e){for(var s of e.childElements())if("verse"===s.localName){t.lyrics||(t.lyrics=[]);let e=s.innerText;"true"===s.getAttribute("hyphen")&&(e+="-"),t.lyrics.push(e)}}_parseRestDurations(e){var t,s=e.getAttribute("base");return-1!==s.indexOf("/")?((t=new wt).beamingMode=this._beamingMode,this._parseDuration(t,e),t):1===Number.parseInt(s,10)?((e=new wt).beamingMode=this._beamingMode,e.duration=1,e):(M.warning("Importer","Multi-Bar rests are not supported"),null)}_parseDurationValue(e){switch(e){case"2/1":return-2;case"1/1":return 1;case"1/2":return 2;case"1/4":return 4;case"1/8":return 8;case"1/16":return 16;case"1/32":return 32;case"1/64":return 64;case"1/128":return 128;default:return M.warning("Importer","Unsupported duration"),4}}_parseDuration(i,e){var a=e.getAttribute("base"),a=(i.duration=this._parseDurationValue(a),e.attributes.has("dots")&&(i.dots=Number.parseInt(e.attributes.get("dots"),10)),e.findChildElement("tuplet"));if(a){i.tupletNumerator=Number.parseInt(a.getAttribute("count"),10);let e="true"===a.getAttribute("tripartite")?3:1,t="true"===a.getAttribute("prolong")?0:1,s=0;for(;e*Math.pow(2,s+t)<i.tupletNumerator;)s++;i.tupletDenominator=e*Math.pow(2,s)}}_parsePageObjects(e){for(var t of e.childElements())if("drawObj"===t.localName){var s=this._parseDrawObj(t);if(s&&s instanceof zs)switch(s.align){case 1:this.score.title?this.score.subTitle||(this.score.subTitle=t.innerText):this.score.title=t.innerText;break;case 2:this.score.artist||(this.score.artist=t.innerText)}}}_parseGallery(e){for(var t of e.childElements()){var s;"drawObj"===t.localName&&(s=this._parseDrawObj(t))&&this._galleryObjects.set(t.getAttribute("name"),s)}}_parseDrawObj(e){let t=null,s=1;for(var i of e.childElements())switch(i.localName){case"text":t=this._parseText(i);break;case"guitar":t=this._parseGuitar(i);break;case"slur":t=this._parseSlur(i);break;case"wavyLine":t=this._parseWavyLine(i);break;case"bracket":t=this._parseTupletBracket(i);break;case"wedge":t=this._parseWedge(i);break;case"volta":t=this._parseVolta(i);break;case"octaveClef":t=this._parseOctaveClef(i);break;case"trill":t=this._parseTrill(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10))}return t&&(t.noteRange=s),t}_parseTrill(e){return new Ks}_parseOctaveClef(e){var t=new $s;return e.attributes.has("octave")&&(t.octave=Number.parseInt(e.attributes.get("octave"),10)),t}_parseVolta(e){var t=new js;return t.allNumbers="true"===e.attributes.get("allNumbers"),e.attributes.has("firstNumber")&&(t.firstNumber=Number.parseInt(e.attributes.get("firstNumber"),10)),e.attributes.has("lastNumber")&&(t.lastNumber=Number.parseInt(e.attributes.get("lastNumber"),10)),t}_parseWedge(e){var t=new qs;return t.decrescendo="true"===e.attributes.get("decrescendo"),t}_parseTupletBracket(e){var t=new Js;return e.attributes.has("number")&&(t.number=Number.parseInt(e.attributes.get("number"),10)),t}_parseWavyLine(e){return new Xs}_parseSlur(e){return new Ys}_parseGuitar(e){var t=new Us,s=e.innerText.trim();for(let e=0;e<s.length;e++)"/"===s.charAt(e)?t.chord.strings.push(0):t.chord.strings.push(Number.parseInt(s.charAt(e),10));return t}_parseText(e){var t=new zs;switch(e.attributes.has("x")&&(t.x=Number.parseFloat(e.attributes.get("x"))),e.attributes.has("x")&&(t.y=Number.parseFloat(e.attributes.get("y"))),e.getAttribute("align")){case"left":t.align=0;break;case"center":t.align=1;break;case"right":t.align=2}switch(e.getAttribute("frame")){case"rectangle":t.frame=1;break;case"ellipse":t.frame=2;break;case"circle":t.frame=3;break;case"none":t.frame=0}if(e.firstElement)for(var s of e.childElements())switch(s.localName){case"font":t.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(t.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(t.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":t.text=s.innerText}else t.text=e.innerText;return t}_parseInfo(e){for(var t of e.childElements())switch(t.localName){case"author":this.score.tab=t.firstChild.innerText;break;case"comment":this.score.notices=t.firstChild.innerText}}},si=class extends ws{get name(){return"Capella"}readScore(){M.debug(this.name,"Loading ZIP entries");let e=new Rs(this.data),t,s=null;if(t=e.read(),M.debug(this.name,"Zip entries loaded"),0<t.length)for(var i of t)"score.xml"===i.fileName&&(s=f.toString(i.data,this.settings.importer.encoding));else this.data.reset(),s=f.toString(this.data.readAll(),this.settings.importer.encoding);if(!s)throw new Ts("No valid capella file");M.debug(this.name,"Start Parsing score.xml");try{var a=new ti;return a.parseXml(s,this.settings),M.debug(this.name,"score.xml parsed"),a.score}catch(e){throw new Ts("Failed to parse CapXML",e)}}},ii=class ii extends ws{constructor(){super(...arguments),this._versionNumber=0,this._globalTripletFeel=0,this._lyricsTrack=0,this._lyrics=[],this._barCount=0,this._trackCount=0,this._playbackInfos=[],this._doubleBars=new Set,this._clefsPerTrack=new Map,this._keySignatures=new Map,this._beatTextChunksByTrack=new Map,this._directionLookup=new Map}get name(){return"Guitar Pro 3-5"}readScore(){var e;return this._directionLookup.clear(),this.readVersion(),this._score=new qe,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=ri.gpReadBool(this.data)?2:0),400<=this._versionNumber&&this.readLyrics(),510<=this._versionNumber&&this.data.skip(19),this._initialTempo=K.buildTempoAutomation(!1,0,0,0),500<=this._versionNumber&&(this.readPageSetup(),this._initialTempo.text=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._initialTempo.value=f.readInt32LE(this.data),510<=this._versionNumber&&ri.gpReadBool(this.data),f.readInt32LE(this.data),400<=this._versionNumber&&this.data.readByte(),this.readPlaybackInfos(),500<=this._versionNumber&&(this._readDirection(3),this._readDirection(4),this._readDirection(1),this._readDirection(2),this._readDirection(0),this._readDirection(5),this._readDirection(6),this._readDirection(7),this._readDirection(8),this._readDirection(9),this._readDirection(10),this._readDirection(11),this._readDirection(12),this._readDirection(13),this._readDirection(14),this._readDirection(15),this._readDirection(16),this._readDirection(17),this._readDirection(18),this.data.skip(4)),this._barCount=f.readInt32LE(this.data),this._trackCount=f.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),0<this._score.masterBars.length&&((e=K.buildTempoAutomation(!1,0,this._score.tempo,2)).text=this._score.tempoLabel,this._score.masterBars[0].tempoAutomations.push(e)),F.consolidate(this._score),this._score.finish(this.settings),this._lyrics&&0<=this._lyricsTrack&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}_readDirection(t){var s=f.readInt16LE(this.data);if(-1!==s){let e;this._directionLookup.has(--s)?e=this._directionLookup.get(s):(e=[],this._directionLookup.set(s,e)),e.push(t)}}readVersion(){let e=ri.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith(ii._versionString))throw new Ts("Unsupported format");var t=(e=e.substr(ii._versionString.length+1)).indexOf(".");this._versionNumber=100*Number.parseInt(e.substr(0,t),10)+Number.parseInt(e.substr(t+1),10),M.debug(this.name,`Guitar Pro version ${e} detected`)}readScoreInformation(){this._score.title=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=500<=this._versionNumber?ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding);let t=f.readInt32LE(this.data),s="";for(let e=0;e<t;e++)0<e&&(s+=`\r
`),s+=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this._score.notices=s}readLyrics(){this._lyrics=[],this._lyricsTrack=f.readInt32LE(this.data)-1;for(let e=0;e<5;e++){var t=new Xt;t.startBar=f.readInt32LE(this.data)-1,t.text=ri.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(t)}}readPageSetup(){this.data.skip(28);var e=f.readInt16LE(this.data);F.getOrCreateHeaderFooterStyle(this._score,0).isVisible=0!=(1&e),F.getOrCreateHeaderFooterStyle(this._score,0).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),F.getOrCreateHeaderFooterStyle(this._score,1).isVisible=0!=(2&e),F.getOrCreateHeaderFooterStyle(this._score,1).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),F.getOrCreateHeaderFooterStyle(this._score,2).isVisible=0!=(4&e),F.getOrCreateHeaderFooterStyle(this._score,2).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),F.getOrCreateHeaderFooterStyle(this._score,3).isVisible=0!=(8&e),F.getOrCreateHeaderFooterStyle(this._score,3).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),F.getOrCreateHeaderFooterStyle(this._score,4).isVisible=0!=(16&e),F.getOrCreateHeaderFooterStyle(this._score,4).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),F.getOrCreateHeaderFooterStyle(this._score,5).isVisible=0!=(32&e),F.getOrCreateHeaderFooterStyle(this._score,5).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),F.getOrCreateHeaderFooterStyle(this._score,6).isVisible=0!=(64&e),F.getOrCreateHeaderFooterStyle(this._score,6).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),F.getOrCreateHeaderFooterStyle(this._score,8).isVisible=0!=(128&e),F.getOrCreateHeaderFooterStyle(this._score,8).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),F.getOrCreateHeaderFooterStyle(this._score,9).isVisible=0!=(128&e),F.getOrCreateHeaderFooterStyle(this._score,9).template=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),ri.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];let t=0;for(let e=0;e<64;e++){var s=new Kt;s.primaryChannel=t++,s.secondaryChannel=t++,s.program=f.readInt32LE(this.data),s.volume=this.data.readByte(),s.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(s)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let a=null;0<this._score.masterBars.length&&(a=this._score.masterBars[this._score.masterBars.length-1]);var r=new $e,e=(!a&&0<this._initialTempo.value&&r.tempoAutomations.push(this._initialTempo),this.data.readByte());if(0!=(1&e)?r.timeSignatureNumerator=this.data.readByte():a&&(r.timeSignatureNumerator=a.timeSignatureNumerator),0!=(2&e)?r.timeSignatureDenominator=this.data.readByte():a&&(r.timeSignatureDenominator=a.timeSignatureDenominator),r.isRepeatStart=0!=(4&e),0!=(8&e)&&(r.repeatCount=this.data.readByte()+(500<=this._versionNumber?0:1)),0!=(16&e)&&this._versionNumber<500){let e=a,t=0;for(;e&&!(e.isRepeatEnd&&e!==a||e.isRepeatStart);)t|=e.alternateEndings,e=e.previousMasterBar;let s=0,i=this.data.readByte();for(let e=0;e<8;e++){var n=1<<e;i>e&&0==(t&n)&&(s|=n)}r.alternateEndings=s}if(0!=(32&e)&&((t=new Jt).text=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.marker="",ri.gpReadColor(this.data,!1),r.section=t),0!=(64&e)&&this._keySignatures.set(this._score.masterBars.length,[f.readSInt8(this.data),this.data.readByte()]),500<=this._versionNumber&&0!=(3&e)&&this.data.skip(4),500<=this._versionNumber&&(r.alternateEndings=this.data.readByte()),500<=this._versionNumber){switch(this.data.readByte()){case 1:r.tripletFeel=2;break;case 2:r.tripletFeel=1}this.data.readByte()}else r.tripletFeel=this._globalTripletFeel;var t=0!=(128&e),e=(r.isDoubleBar=t,this._score.masterBars.length);if(this._directionLookup.has(e))for(var s of this._directionLookup.get(e))r.addDirection(s);this._score.addMasterBar(r),t&&this._doubleBars.add(r.index)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){var e=new ts,t=(e.ensureStaveCount(1),this._score.addTrack(e),e.staves[0]),s=this.data.readByte(),i=(e.name=ri.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),0!=(1&s)&&(t.isPercussion=!0),500<=this._versionNumber&&(e.isVisibleOnMultiTrack=0!=(8&s)),null===this._score.stylesheet.perTrackDisplayTuning&&(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(e.index,0!=(128&s)),f.readInt32LE(this.data)),a=[];for(let e=0;e<7;e++){var r=f.readInt32LE(this.data);i>e&&a.push(r)}t.stringTuning.tunings=a;var n,o=f.readInt32LE(this.data),h=f.readInt32LE(this.data)-1,l=f.readInt32LE(this.data)-1;this.data.skip(4),0<=h&&h<this._playbackInfos.length&&((n=this._playbackInfos[h]).port=o,n.isSolo=0!=(16&s),n.isMute=0!=(32&s),n.secondaryChannel=l,Wt.isGuitar(n.program)&&(t.displayTranspositionPitch=-12),e.playbackInfo=n),t.capo=f.readInt32LE(this.data),e.color=ri.gpReadColor(this.data,!1),500<=this._versionNumber?(o=this.data.readByte(),t.showTablature=0!=(1&o),t.showStandardNotation=0!=(2&o),s=0!=(100&o),null===this._score.stylesheet.perTrackChordDiagramsOnTop&&(this._score.stylesheet.perTrackChordDiagramsOnTop=new Map),this._score.stylesheet.perTrackChordDiagramsOnTop.set(e.index,s),this.data.readByte(),this.data.readByte(),e.playbackInfo.bank=this.data.readByte(),this.data.readByte(),12===f.readInt32LE(this.data)?this._clefsPerTrack.set(h,3):this._clefsPerTrack.set(h,4),f.readInt32LE(this.data),f.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this._readRseBank(),510<=this._versionNumber&&(this.data.skip(4),ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),ri.gpReadStringIntByte(this.data,this.settings.importer.encoding))):Wt.isBass(e.playbackInfo.program)?this._clefsPerTrack.set(h,3):this._clefsPerTrack.set(h,4)}readBars(){for(let e=0;e<this._barCount;e++)for(let e=0;e<this._trackCount;e++)this.readBar(this._score.tracks[e])}readBar(t){var s=new Ae,e=t.staves[0];e.isPercussion?s.clef=0:this._clefsPerTrack.has(t.index)&&(s.clef=this._clefsPerTrack.get(t.index)),e.addBar(s),this._keySignatures.has(s.index)?(e=this._keySignatures.get(s.index),s.keySignature=e[0],s.keySignatureType=e[1]):0<s.index&&(s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType),this._doubleBars.has(s.index)&&(s.barLineRight=7);let i=1;500<=this._versionNumber&&(this.data.readByte(),i=2);for(let e=0;e<i;e++)this.readVoice(t,s)}readVoice(t,s){var i=f.readInt32LE(this.data);if(0!==i){var a=new We;s.addVoice(a);for(let e=0;e<i;e++)this.readBeat(t,s,a)}}readBeat(t,s,i){var a=new wt,e=this.data.readByte();switch(0!=(1&e)&&(a.dots=1),0!=(64&e)&&(r=this.data.readByte(),a.isEmpty=0==(2&r)),i.addBeat(a),f.readSInt8(this.data)){case-2:a.duration=1;break;case-1:a.duration=2;break;case 0:a.duration=4;break;case 1:a.duration=8;break;case 2:a.duration=16;break;case 3:a.duration=32;break;case 4:a.duration=64;break;default:a.duration=4}if(0!=(32&e))switch(a.tupletNumerator=f.readInt32LE(this.data),a.tupletNumerator){case 1:a.tupletDenominator=1;break;case 3:a.tupletDenominator=2;break;case 5:case 6:case 7:a.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:a.tupletDenominator=8;break;case 2:case 4:case 8:break;default:a.tupletNumerator=1,a.tupletDenominator=1}0!=(2&e)&&this.readChord(a);var r=this.settings.importer.beatTextAsLyrics&&t.index!==this._lyricsTrack;if(0!=(4&e)){var n=ri.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){var o=new Xt,h=(o.text=n.trim(),o.finish(!0),[]);for(let e=o.chunks.length-1;0<=e;e--)h.push(o.chunks[e]);this._beatTextChunksByTrack.set(t.index,h)}else a.text=n}let l=0;0!=(8&e)&&(l=this.readBeatEffects(a)),0!=(16&e)&&this.readMixTableChange(a);var d,c=this.data.readByte();for(let e=6;0<=e;e--)0!=(c&1<<e)&&6-e<s.staff.tuning.length&&(d=this.readNote(t,s,i,a,6-e),0!==l)&&(d.harmonicType=l,1===d.harmonicType)&&(d.harmonicValue=F.deltaFretToHarmonicValue(d.fret));500<=this._versionNumber&&(0!=(1&(n=f.readInt16LE(this.data)))&&0<a.index&&(i.beats[a.index-1].beamingMode=1),0!=(2&n)&&(a.preferredBeamDirection=1),0!=(4&n)&&0<a.index&&(i.beats[a.index-1].beamingMode=2),0!=(8&n)&&(a.preferredBeamDirection=0),0!=(16&n)&&(a.ottava=1),0!=(32&n)&&(a.ottava=3),0!=(64&n)&&(a.ottava=0),0!=(256&n)&&(a.ottava=4),0!=(2048&n))&&(e=0!==this.data.readByte(),0<a.index)&&e&&(i.beats[a.index-1].beamingMode=3),r&&!a.isRest&&this._beatTextChunksByTrack.has(t.index)&&0<this._beatTextChunksByTrack.get(t.index).length&&(a.lyrics=[this._beatTextChunksByTrack.get(t.index).pop()])}readChord(t){var s=new Ht,e=F.newGuid();if(500<=this._versionNumber){this.data.skip(17),s.name=ri.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),s.firstFret=f.readInt32LE(this.data);for(let e=0;e<7;e++){var i=f.readInt32LE(this.data);e<t.voice.bar.staff.tuning.length&&s.strings.push(i)}var a=this.data.readByte(),r=new Uint8Array(5);this.data.read(r,0,r.length);for(let e=0;e<a;e++)s.barreFrets.push(r[e]);this.data.skip(26)}else if(0!==this.data.readByte())if(400<=this._versionNumber){this.data.skip(16),s.name=ri.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),s.firstFret=f.readInt32LE(this.data);for(let e=0;e<7;e++){var n=f.readInt32LE(this.data);e<t.voice.bar.staff.tuning.length&&s.strings.push(n)}var o=this.data.readByte(),h=new Uint8Array(5);this.data.read(h,0,h.length);for(let e=0;e<o;e++)s.barreFrets.push(h[e]);this.data.skip(26)}else{this.data.skip(25),s.name=ri.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),s.firstFret=f.readInt32LE(this.data);for(let e=0;e<6;e++){var l=f.readInt32LE(this.data);e<t.voice.bar.staff.tuning.length&&s.strings.push(l)}this.data.skip(36)}else{var d=406<=this._versionNumber?7:6;if(s.name=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),s.firstFret=f.readInt32LE(this.data),0<s.firstFret)for(let e=0;e<d;e++){var c=f.readInt32LE(this.data);e<t.voice.bar.staff.tuning.length&&s.strings.push(c)}}s.name&&(t.chordId=e,t.voice.bar.staff.addChord(t.chordId,s))}readBeatEffects(s){let e=this.data.readByte(),t=0;if(400<=this._versionNumber&&(t=this.data.readByte()),0!=(16&e)&&(s.fade=1),(this._versionNumber<400&&0!=(1&e)||0!=(2&e))&&(s.vibrato=1),0!=(1&t)&&(s.rasgueado=1),0!=(32&e)&&400<=this._versionNumber)switch(f.readSInt8(this.data)){case 1:s.tap=!0;break;case 2:s.slap=!0;break;case 3:s.pop=!0}else if(0!=(32&e)){switch(f.readSInt8(this.data)){case 1:s.tap=!0;break;case 2:s.slap=!0;break;case 3:s.pop=!0}this.data.skip(4)}if(0!=(4&t)&&this.readTremoloBarEffect(s),0!=(64&e)){let e=0,t=0;this._versionNumber<500?(t=this.data.readByte(),e=this.data.readByte()):(e=this.data.readByte(),t=this.data.readByte()),0<e?(s.brushType=1,s.brushDuration=ii._toStrokeValue(e)):0<t&&(s.brushType=2,s.brushDuration=ii._toStrokeValue(t))}if(0!=(2&t))switch(f.readSInt8(this.data)){case 0:s.pickStroke=0;break;case 1:s.pickStroke=1;break;case 2:s.pickStroke=2}if(this._versionNumber<400){if(0!=(4&e))return 1;if(0!=(8&e))return 2}return 0}readTremoloBarEffect(t){this.data.readByte(),f.readInt32LE(this.data);var s=f.readInt32LE(this.data);if(0<s)for(let e=0;e<s;e++){var i=new w(0,0);i.offset=f.readInt32LE(this.data),i.value=f.readInt32LE(this.data)/ii._bendStep|0,ri.gpReadBool(this.data),t.addWhammyBarPoint(i)}}static _toStrokeValue(e){switch(e){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}_readRseBank(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(e){var s=new ni,t=(s.instrument=f.readSInt8(this.data),500<=this._versionNumber&&this._readRseBank(),s.volume=f.readSInt8(this.data),s.balance=f.readSInt8(this.data),f.readSInt8(this.data)),i=f.readSInt8(this.data),a=f.readSInt8(this.data),r=f.readSInt8(this.data);if(500<=this._versionNumber&&(s.tempoName=ri.gpReadStringIntByte(this.data,this.settings.importer.encoding)),s.tempo=f.readInt32LE(this.data),0<=s.volume&&this.data.readByte(),0<=s.balance&&this.data.readByte(),0<=t&&this.data.readByte(),0<=i&&this.data.readByte(),0<=a&&this.data.readByte(),0<=r&&this.data.readByte(),0<=s.tempo&&(s.duration=f.readSInt8(this.data),510<=this._versionNumber)&&this.data.readByte(),400<=this._versionNumber&&this.data.readByte(),500<=this._versionNumber&&(100<=(t=f.readSInt8(this.data))?e.wahPedal=2:0<=t&&(e.wahPedal=1)),510<=this._versionNumber&&(ri.gpReadStringIntByte(this.data,this.settings.importer.encoding),ri.gpReadStringIntByte(this.data,this.settings.importer.encoding)),0<=s.volume&&((i=new K).isLinear=!0,i.type=1,i.value=s.volume,e.automations.push(i)),0<=s.balance&&((a=new K).isLinear=!0,a.type=3,a.value=s.balance,e.automations.push(a)),0<=s.instrument&&((r=new K).isLinear=!0,r.type=2,r.value=s.instrument,e.automations.push(r)),0<=s.tempo){let t=new K;t.isLinear=!0,t.type=0,t.value=s.tempo,e.automations.push(t),e.voice.bar.masterBar.tempoAutomations.some(e=>e.ratioPosition===t.ratioPosition&&e.value===t.value)||e.voice.bar.masterBar.tempoAutomations.push(t)}}readNote(e,t,s,i,a){var r,n=new dt,a=(n.string=t.staff.tuning.length-a,this.data.readByte());0!=(2&a)?n.accentuated=2:0!=(64&a)&&(n.accentuated=1),n.isGhost=0!=(4&a),0!=(32&a)&&(3===(r=this.data.readByte())?n.isDead=!0:2===r&&(n.isTieDestination=!0)),0!=(1&a)&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),0!=(16&a)&&(r=f.readSInt8(this.data),n.dynamics=this.toDynamicValue(r),i.dynamics=n.dynamics),0!=(32&a)&&(n.fret=f.readSInt8(this.data)),0!=(128&a)&&(n.leftHandFinger=f.readSInt8(this.data),n.rightHandFinger=f.readSInt8(this.data));let o=!1;return 500<=this._versionNumber&&(0!=(1&a)&&(n.durationPercent=f.readFloat64BE(this.data)),o=0!=(2&this.data.readByte())),i.addNote(n),0!=(8&a)&&this.readNoteEffects(e,s,i,n),t.staff.isPercussion&&(n.percussionArticulation=n.fret,n.string=-1,n.fret=-1),o&&(2===(r=F.computeAccidental(t.keySignature,0,n.realValueWithoutHarmonic,!1))?n.accidentalMode=5:3===r&&(n.accidentalMode=3)),n}toDynamicValue(e){switch(e){case 1:return 0;case 2:return 1;case 3:return 2;case 4:return 3;case 5:return 4;case 6:return 5;case 7:return 6;case 8:return 7;default:return 5}}readNoteEffects(e,t,s,i){let a=this.data.readByte(),r=0;400<=this._versionNumber&&(r=this.data.readByte()),0!=(1&a)&&this.readBend(i),0!=(16&a)&&this.readGrace(t,i),0!=(4&r)&&this.readTremoloPicking(s),0!=(8&r)?this.readSlide(i):this._versionNumber<400&&0!=(4&a)&&(i.slideOutType=1),0!=(16&r)&&this.readArtificialHarmonic(i),0!=(32&r)&&this.readTrill(i),i.isLetRing=0!=(8&a),i.isHammerPullOrigin=0!=(2&a),0!=(64&r)&&(i.vibrato=1),i.isPalmMute=0!=(2&r),i.isStaccato=0!=(1&r)}readBend(t){this.data.readByte(),f.readInt32LE(this.data);var s=f.readInt32LE(this.data);if(0<s)for(let e=0;e<s;e++){var i=new w(0,0);i.offset=f.readInt32LE(this.data),i.value=f.readInt32LE(this.data)/ii._bendStep|0,ri.gpReadBool(this.data),t.addBendPoint(i)}}readGrace(e,t){var s,i=new wt,a=new dt;switch(a.string=t.string,a.fret=f.readSInt8(this.data),i.duration=32,i.dynamics=this.toDynamicValue(f.readSInt8(this.data)),f.readSInt8(this.data)){case 0:break;case 1:a.slideOutType=2,a.slideTarget=t;break;case 2:break;case 3:a.isHammerPullOrigin=!0}a.dynamics=i.dynamics,this.data.skip(1),this._versionNumber<500?i.graceType=2:(s=this.data.readByte(),a.isDead=0!=(1&s),i.graceType=0!=(2&s)?1:2),e.addGraceBeat(i),i.addNote(a)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=8;break;case 2:e.tremoloSpeed=16;break;case 3:e.tremoloSpeed=32}}readSlide(e){if(500<=this._versionNumber){var t=f.readSInt8(this.data);0!=(1&t)?e.slideOutType=1:0!=(2&t)?e.slideOutType=2:0!=(4&t)?e.slideOutType=4:0!=(8&t)&&(e.slideOutType=3),0!=(16&t)?e.slideInType=1:0!=(32&t)&&(e.slideInType=2)}else switch(f.readSInt8(this.data)){case 1:e.slideOutType=1;break;case 2:e.slideOutType=2;break;case 3:e.slideOutType=4;break;case 4:e.slideOutType=3;break;case-1:e.slideInType=1;break;case-2:e.slideInType=2}}readArtificialHarmonic(e){var t=this.data.readByte();if(500<=this._versionNumber)switch(t){case 1:e.harmonicType=1,e.harmonicValue=F.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=2;break;case 3:e.harmonicType=4,e.harmonicValue=F.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=3,e.harmonicValue=12;break;case 5:e.harmonicType=5,e.harmonicValue=12}else if(400<=this._versionNumber)switch(t){case 1:e.harmonicType=1;break;case 3:e.harmonicType=4;break;case 4:e.harmonicType=3;break;case 5:e.harmonicType=5;break;case 15:case 17:case 22:e.harmonicType=2}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=16;break;case 2:e.trillSpeed=32;break;case 3:e.trillSpeed=64}}},ai=(ii._versionString="FICHIER GUITAR PRO ",ii._bendStep=25,ii),ri=class Iu{static gpReadColor(e,t=!1){let s=e.readByte(),i=e.readByte(),a=e.readByte(),r=255;return t?r=e.readByte():e.skip(1),new Ut(s,i,a,r)}static gpReadBool(e){return 0!==e.readByte()}static gpReadStringIntUnused(e,t){return e.skip(4),Iu.gpReadString(e,e.readByte(),t)}static gpReadStringInt(e,t){return Iu.gpReadString(e,f.readInt32LE(e),t)}static gpReadStringIntByte(e,t){var s=f.readInt32LE(e)-1;return e.readByte(),Iu.gpReadString(e,s,t)}static gpReadString(e,t,s){t=new Uint8Array(t);return e.read(t,0,t.length),f.toString(t,s)}static gpWriteString(e,t){var s=f.stringToBytes(t);e.writeByte(t.length),e.write(s,0,s.length)}static gpReadStringByteLength(e,t,s){var i=e.readByte(),s=Iu.gpReadString(e,i,s);return i<t&&e.skip(t-i),s}},ni=class{constructor(){this.volume=-1,this.balance=-1,this.instrument=-1,this.tempoName="",this.tempo=-1,this.duration=-1}},oi=class Au{constructor(e){this._types=new Map,this.raw=new Map,e&&this._read(e)}_read(e){var t=Bs.fromBuffer(e),s=f.readInt32BE(t);for(let e=0;e<s;e++){var i=ri.gpReadString(t,t.readByte(),"utf-8"),a=t.readByte();switch(this._types.set(i,a),a){case 0:var r=1===t.readByte();this.addValue(i,r);break;case 1:r=f.readInt32BE(t);this.addValue(i,r);break;case 2:var n=f.readFloat32BE(t);this.addValue(i,n);break;case 3:n=ri.gpReadString(t,f.readInt16BE(t),"utf-8");this.addValue(i,n);break;case 4:var o=f.readInt32BE(t),h=f.readInt32BE(t);this.addValue(i,new w(o,h));break;case 5:o=f.readInt32BE(t),h=f.readInt32BE(t);this.addValue(i,new w(o,h));break;case 6:var l=new hs;l.x=f.readInt32BE(t),l.y=f.readInt32BE(t),l.w=f.readInt32BE(t),l.h=f.readInt32BE(t),this.addValue(i,l);break;case 7:l=ri.gpReadColor(t,!0);this.addValue(i,l)}}}apply(e){for(var[t,s]of this.raw)switch(t){case"StandardNotation/hideDynamics":e.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":e.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":e.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":e.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":e.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/showTrackNameSingle":s||(e.stylesheet.singleTrackTrackNamePolicy=0);break;case"System/showTrackNameMulti":s||(e.stylesheet.multiTrackTrackNamePolicy=0);break;case"System/trackNameModeSingle":if(0!==e.stylesheet.singleTrackTrackNamePolicy)switch(s){case 0:case 1:e.stylesheet.singleTrackTrackNamePolicy=1;break;case 2:e.stylesheet.singleTrackTrackNamePolicy=2}break;case"System/trackNameModeMulti":if(0!==e.stylesheet.multiTrackTrackNamePolicy)switch(s){case 0:case 1:e.stylesheet.multiTrackTrackNamePolicy=1;break;case 2:e.stylesheet.multiTrackTrackNamePolicy=2}break;case"System/shortTrackNameOnFirstSystem":s?e.stylesheet.firstSystemTrackNameMode=1:e.stylesheet.firstSystemTrackNameMode=0;break;case"System/shortTrackNameOnOtherSystems":s?e.stylesheet.otherSystemsTrackNameMode=1:e.stylesheet.otherSystemsTrackNameMode=0;break;case"System/horizontalTrackNameOnFirstSystem":s?e.stylesheet.firstSystemTrackNameOrientation=0:e.stylesheet.firstSystemTrackNameOrientation=1;break;case"System/horizontalTrackNameOnOtherSystems":s?e.stylesheet.otherSystemsTrackNameOrientation=0:e.stylesheet.otherSystemsTrackNameOrientation=1;break;case"Header/Title":F.getOrCreateHeaderFooterStyle(e,0).template=s;break;case"Header/TitleAlignment":F.getOrCreateHeaderFooterStyle(e,0).textAlign=this._toTextAlign(s);break;case"Header/drawTitle":F.getOrCreateHeaderFooterStyle(e,0).isVisible=s;break;case"Header/Subtitle":F.getOrCreateHeaderFooterStyle(e,1).template=s;break;case"Header/SubtitleAlignment":F.getOrCreateHeaderFooterStyle(e,1).textAlign=this._toTextAlign(s);break;case"Header/drawSubtitle":F.getOrCreateHeaderFooterStyle(e,1).isVisible=s;break;case"Header/Artist":F.getOrCreateHeaderFooterStyle(e,2).template=s;break;case"Header/ArtistAlignment":F.getOrCreateHeaderFooterStyle(e,2).textAlign=this._toTextAlign(s);break;case"Header/drawArtist":F.getOrCreateHeaderFooterStyle(e,2).isVisible=s;break;case"Header/Album":F.getOrCreateHeaderFooterStyle(e,3).template=s;break;case"Header/AlbumAlignment":F.getOrCreateHeaderFooterStyle(e,3).textAlign=this._toTextAlign(s);break;case"Header/drawAlbum":F.getOrCreateHeaderFooterStyle(e,3).isVisible=s;break;case"Header/Words":F.getOrCreateHeaderFooterStyle(e,4).template=s;break;case"Header/WordsAlignment":F.getOrCreateHeaderFooterStyle(e,4).textAlign=this._toTextAlign(s);break;case"Header/drawWords":F.getOrCreateHeaderFooterStyle(e,4).isVisible=s;break;case"Header/Music":F.getOrCreateHeaderFooterStyle(e,5).template=s;break;case"Header/MusicAlignment":F.getOrCreateHeaderFooterStyle(e,5).textAlign=this._toTextAlign(s);break;case"Header/drawMusic":F.getOrCreateHeaderFooterStyle(e,5).isVisible=s;break;case"Header/WordsAndMusic":F.getOrCreateHeaderFooterStyle(e,6).template=s;break;case"Header/WordsAndMusicAlignment":F.getOrCreateHeaderFooterStyle(e,6).textAlign=this._toTextAlign(s);break;case"Header/drawWordsAndMusic":F.getOrCreateHeaderFooterStyle(e,6).isVisible=s;break;case"Header/Tabber":F.getOrCreateHeaderFooterStyle(e,7).template=s;break;case"Header/TabberAlignment":F.getOrCreateHeaderFooterStyle(e,7).textAlign=this._toTextAlign(s);break;case"Header/drawTabber":F.getOrCreateHeaderFooterStyle(e,7).isVisible=s;break;case"Footer/Copyright":F.getOrCreateHeaderFooterStyle(e,8).template=s;break;case"Footer/CopyrightAlignment":F.getOrCreateHeaderFooterStyle(e,8).textAlign=this._toTextAlign(s);break;case"Footer/drawCopyright":F.getOrCreateHeaderFooterStyle(e,8).isVisible=s;break;case"Footer/Copyright2":F.getOrCreateHeaderFooterStyle(e,9).template=s;break;case"Footer/Copyright2Alignment":F.getOrCreateHeaderFooterStyle(e,9).textAlign=this._toTextAlign(s);break;case"Footer/drawCopyright2":F.getOrCreateHeaderFooterStyle(e,9).isVisible=s}}_toTextAlign(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2}return 0}addValue(e,t,s){this.raw.set(e,t),void 0!==s&&this._types.set(e,s)}writeTo(e){f.writeInt32BE(e,this.raw.size);for(var[t,s]of this.raw){var i=this._getDataType(t,s);switch(ri.gpWriteString(e,t),e.writeByte(i),i){case 0:e.writeByte(s?1:0);break;case 1:f.writeInt32BE(e,s);break;case 2:f.writeFloat32BE(e,s);break;case 3:var a=f.stringToBytes(s);f.writeInt16BE(e,a.length),e.write(a,0,a.length);break;case 4:case 5:f.writeInt32BE(e,s.offset),f.writeInt32BE(e,s.value);break;case 6:f.writeInt32BE(e,s.x),f.writeInt32BE(e,s.y),f.writeInt32BE(e,s.w),f.writeInt32BE(e,s.h);break;case 7:e.writeByte(s.r),e.writeByte(s.g),e.writeByte(s.b),e.writeByte(s.a)}}}_getDataType(e,t){if(this._types.has(e))return this._types.get(e);e=typeof t;switch(typeof t){case"string":return 3;case"number":return t===(0|t)?1:2;case"object":if(t instanceof w)return 4;if(t instanceof hs)return 6;if(t instanceof Ut)return 7}throw new b(0,"Unknown value type in BinaryStylesheet: "+e)}static writeForScore(e){var t=new Au;switch(t.addValue("StandardNotation/hideDynamics",e.stylesheet.hideDynamics,0),t.addValue("System/bracketExtendMode",e.stylesheet.bracketExtendMode,1),t.addValue("Global/useSystemSignSeparator",e.stylesheet.useSystemSignSeparator,0),t.addValue("Global/DisplayTuning",e.stylesheet.globalDisplayTuning,0),t.addValue("Global/DrawChords",e.stylesheet.globalDisplayChordDiagramsOnTop,0),e.stylesheet.singleTrackTrackNamePolicy){case 0:t.addValue("System/showTrackNameSingle",!1,0);break;case 1:t.addValue("System/trackNameModeSingle",0,1);break;case 2:t.addValue("System/trackNameModeSingle",2,1)}switch(e.stylesheet.multiTrackTrackNamePolicy){case 0:t.addValue("System/showTrackNameMulti",!1,0);break;case 1:t.addValue("System/trackNameModeMulti",0,1);break;case 2:t.addValue("System/trackNameModeMulti",2,1)}switch(e.stylesheet.firstSystemTrackNameMode){case 0:t.addValue("System/shortTrackNameOnFirstSystem",!1,0);break;case 1:t.addValue("System/shortTrackNameOnFirstSystem",!0,0)}switch(e.stylesheet.otherSystemsTrackNameMode){case 0:t.addValue("System/shortTrackNameOnOtherSystems",!1,0);break;case 1:t.addValue("System/shortTrackNameOnOtherSystems",!0,0)}switch(e.stylesheet.firstSystemTrackNameOrientation){case 0:t.addValue("System/horizontalTrackNameOnFirstSystem",!0,0);break;case 1:t.addValue("System/horizontalTrackNameOnFirstSystem",!1,0)}switch(e.stylesheet.otherSystemsTrackNameOrientation){case 0:t.addValue("System/horizontalTrackNameOnOtherSystems",!0,0);break;case 1:t.addValue("System/horizontalTrackNameOnOtherSystems",!1,0)}e=e.style;if(e)for(var[s,i]of e.headerAndFooter)switch(s){case 0:Au._addHeaderAndFooter(t,i,"Header/","Title");break;case 1:Au._addHeaderAndFooter(t,i,"Header/","Subtitle");break;case 2:Au._addHeaderAndFooter(t,i,"Header/","Artist");break;case 3:Au._addHeaderAndFooter(t,i,"Header/","Album");break;case 4:Au._addHeaderAndFooter(t,i,"Header/","Words");break;case 5:Au._addHeaderAndFooter(t,i,"Header/","Music");break;case 6:Au._addHeaderAndFooter(t,i,"Header/","WordsAndMusic");break;case 7:Au._addHeaderAndFooter(t,i,"Header/","Tabber");break;case 8:Au._addHeaderAndFooter(t,i,"Footer/","Copyright");break;case 9:Au._addHeaderAndFooter(t,i,"Footer/","Copyright2")}e=Bs.withCapacity(128);return t.writeTo(e),e.toArray()}static _addHeaderAndFooter(e,t,s,i){e.addValue(""+s+i,t.template,3),e.addValue(""+s+i+"Alignment",t.textAlign,1),void 0!==t.isVisible&&e.addValue(s+"draw"+i,t.isVisible,0)}},hi=class{},li=class{constructor(){this.id="",this.dots=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.value=4}},di=class{constructor(){this.name="",this.path="",this.role="",this.program=0,this.bank=0}get uniqueId(){return`${this.path};${this.name};`+this.role}},D=class D{constructor(){this._hasAnacrusis=!1,this._skipApplyLyrics=!1,this._backingTrackPadding=0,this._doubleBars=new Set,this._keySignatures=new Map,this._transposeKeySignaturePerTrack=new Map}parseXml(e,t){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._sustainPedalsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;var s=new Gs;try{s.parse(e)}catch(e){throw new Ts("Could not parse XML",e)}if(this._parseDom(s),this._buildModel(),F.consolidate(this.score),this.score.finish(t),!this._skipApplyLyrics&&0<this._lyricsByTrack.size)for(var[i,a]of this._lyricsByTrack)this._tracksById.get(i).applyLyrics(a)}_parseDom(e){e=e.firstElement;if(e){if("GPIF"!==e.localName)throw new Ts("Root node of XML was not GPIF");this.score=new qe;for(var t of e.childElements())switch(t.localName){case"Score":this._parseScoreNode(t);break;case"MasterTrack":this._parseMasterTrackNode(t);break;case"BackingTrack":this._parseBackingTrackNode(t);break;case"Tracks":this._parseTracksNode(t);break;case"MasterBars":this._parseMasterBarsNode(t);break;case"Bars":this._parseBars(t);break;case"Voices":this._parseVoices(t);break;case"Beats":this._parseBeats(t);break;case"Notes":this._parseNotes(t);break;case"Rhythms":this._parseRhythms(t);break;case"Assets":this._parseAssets(t)}}}_parseAssets(e){for(var t of e.childElements())"Asset"===t.localName&&t.getAttribute("id")===this._backingTrackAssetId&&this._parseBackingTrackAsset(t)}_parseBackingTrackAsset(e){let t="";for(var s of e.childElements())"EmbeddedFilePath"===s.localName&&(t=s.innerText);var e=this.loadAsset;e&&((e=e(t))?this.score.backingTrack.rawAudioFile=e:this.score.backingTrack=void 0)}_parseScoreNode(e){for(var t of e.childElements())switch(t.localName){case"Title":this.score.title=t.innerText;break;case"SubTitle":this.score.subTitle=t.innerText;break;case"Artist":this.score.artist=t.innerText;break;case"Album":this.score.album=t.innerText;break;case"Words":this.score.words=t.innerText;break;case"Music":this.score.music=t.innerText;break;case"WordsAndMusic":var s=t.innerText;""!==s&&(s&&!this.score.words&&(this.score.words=s),s)&&!this.score.music&&(this.score.music=s);break;case"Copyright":this.score.copyright=t.innerText;break;case"Tabber":this.score.tab=t.innerText;break;case"Instructions":this.score.instructions=t.innerText;break;case"Notices":this.score.notices=t.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=D._parseIntSafe(t.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=D._splitSafe(t.innerText).map(e=>D._parseIntSafe(e,4))}}static _parseIntSafe(e,t){return!e||(e=Number.parseInt(e,10),Number.isNaN(e))?t:e}static _parseFloatSafe(e,t){return!e||(e=Number.parseFloat(e),Number.isNaN(e))?t:e}static _splitSafe(e,t=" "){return e?e.split(t).map(e=>e.trim()).filter(e=>0<e.length):[]}_parseBackingTrackNode(e){let t=new hi,s=!1,i="",a="";for(var r of e.childElements())switch(r.localName){case"Enabled":s="true"===r.innerText;break;case"Source":i=r.innerText;break;case"AssetId":a=r.innerText;break;case"FramePadding":this._backingTrackPadding=D._parseIntSafe(r.innerText,0)/D._sampleRate*1e3}s&&"Local"===i&&(this.score.backingTrack=t,this._backingTrackAssetId=a)}_parseMasterTrackNode(e){for(var t of e.childElements())switch(t.localName){case"Automations":this._parseAutomations(t,this._masterTrackAutomations,null,null);break;case"Tracks":this._tracksMapping=D._splitSafe(t.innerText);break;case"Anacrusis":this._hasAnacrusis=!0}}_parseAutomations(e,t,s,i){for(var a of e.childElements())"Automation"===a.localName&&this._parseAutomation(a,t,s,i)}_parseAutomation(e,t,s,i){let a=null,r=!1,n=-1,o=0,h=0,l=null,d=0,c=null,u,p=!0;for(var m of e.childElements())switch(m.localName){case"Type":a=m.innerText;break;case"Linear":r="true"===m.innerText.toLowerCase();break;case"Bar":n=D._parseIntSafe(m.innerText,0);break;case"Position":o=D._parseFloatSafe(m.innerText,0);break;case"Value":if(m.firstElement&&3===m.firstElement.nodeType)l=m.innerText;else if(m.firstElement&&1===m.firstElement.nodeType&&"SyncPoint"===a){u=new $;for(var g of m.childElements())switch(g.localName){case"BarIndex":n=D._parseIntSafe(g.innerText,0);break;case"BarOccurrence":u.barOccurence=D._parseIntSafe(g.innerText,0);break;case"FrameOffset":var f=D._parseFloatSafe(g.innerText,0);u.millisecondOffset=f/D._sampleRate*1e3}}else{var b=D._splitSafe(m.innerText);d=1===b.length?(h=D._parseFloatSafe(b[0],0),1):(h=D._parseFloatSafe(b[0],0),D._parseIntSafe(b[1],0))}break;case"Text":c=m.innerText;break;case"Visible":p="true"===m.innerText.toLowerCase()}if(a){var y=[];switch(a){case"Tempo":y.push(K.buildTempoAutomation(r,o,h,d,p));break;case"SyncPoint":var _=new K;_.type=4,_.isLinear=r,_.ratioPosition=o,_.syncPointValue=u,_.isVisible=p,y.push(_);break;case"Sound":l&&s&&s.has(l)&&((_=new K).type=4,_.ratioPosition=o,_.value=s.get(l).bank,_.isVisible=p,y.push(_),_=K.buildInstrumentAutomation(r,o,s.get(l).program),y.push(_));break;case"SustainPedal":if(i){let e;i.has(n)?e=i.get(n):(e=[],i.set(n,e));var S=new Ce;switch(S.ratioPosition=o,d){case 1:S.pedalType=0;break;case 3:S.pedalType=2}e.push(S)}}if(y.length){if(c)for(var v of y)v.text=c;if(0<=n){t.has(n)||t.set(n,[]);for(var k of y)t.get(n).push(k)}}}}_parseTracksNode(e){for(var t of e.childElements())"Track"===t.localName&&this._parseTrack(t)}_parseTrack(e){this._articulationByName=new Map;var t=new ts;t.ensureStaveCount(1);t.staves[0].showStandardNotation=!0;var s,i=e.getAttribute("id");for(s of e.childElements())switch(s.localName){case"Name":t.name=s.innerText;break;case"Color":var a=D._splitSafe(s.innerText);3<=a.length&&(r=D._parseIntSafe(a[0],0),n=D._parseIntSafe(a[1],0),a=D._parseIntSafe(a[2],0),t.color=new Ut(r,n,a,255));break;case"Instrument":var r=s.getAttribute("ref");(r.endsWith("-gs")||r.endsWith("GrandStaff"))&&(t.ensureStaveCount(2),t.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this._parseInstrumentSet(t,s);break;case"NotationPatch":this._parseNotationPatch(t,s);break;case"ShortName":t.shortName=s.innerText;break;case"SystemsDefautLayout":t.defaultSystemsLayout=D._parseIntSafe(s.innerText,4);break;case"SystemsLayout":t.systemsLayout=D._splitSafe(s.innerText).map(e=>D._parseIntSafe(e,4));break;case"Lyrics":this._parseLyrics(i,s);break;case"Properties":this._parseTrackProperties(t,s);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this._parseGeneralMidi(t,s);break;case"Sounds":this._parseSounds(i,t,s);break;case"PlaybackState":var n=s.innerText;t.playbackInfo.isSolo="Solo"===n,t.playbackInfo.isMute="Mute"===n;break;case"PartSounding":this._parsePartSounding(i,t,s);break;case"Staves":this._parseStaves(t,s);break;case"Transpose":this._parseTranspose(i,t,s);break;case"RSE":this._parseRSE(t,s);break;case"Automations":this._parseTrackAutomations(i,s)}this._tracksById.set(i,t)}_parseTrackAutomations(e,t){var s=new Map,i=(this._automationsPerTrackIdAndBarIndex.set(e,s),new Map);this._sustainPedalsPerTrackIdAndBarIndex.set(e,i),this._parseAutomations(t,s,this._soundsByTrack.get(e),i)}_parseNotationPatch(e,t){for(var s of t.childElements())switch(s.localName){case"LineCount":var i,a=D._parseIntSafe(s.innerText,5);for(i of e.staves)i.standardNotationLineCount=a;break;case"Elements":this._parseElements(e,s)}}_parseInstrumentSet(e,t){for(var s of t.childElements())switch(s.localName){case"Type":if("drumKit"===s.innerText)for(var i of e.staves)i.isPercussion=!0;break;case"Elements":this._parseElements(e,s);break;case"LineCount":var a,r=D._parseIntSafe(s.innerText,5);for(a of e.staves)a.standardNotationLineCount=r}}_parseElements(e,t){for(var s of t.childElements())"Element"===s.localName&&this._parseElement(e,s)}_parseElement(e,t){var s,i=t.findChildElement("Type")?.innerText??"";for(s of t.childElements())switch(s.localName){case"Name":case"Articulations":this._parseArticulations(e,s,i)}}_parseArticulations(e,t,s){for(var i of t.childElements())"Articulation"===i.localName&&this._parseArticulation(e,i,s)}_parseArticulation(e,t,s){var i,a=new h;a.outputMidiNumber=-1,a.elementType=s;let r="";for(i of t.childElements()){var n=i.innerText;switch(i.localName){case"Name":r=i.innerText;break;case"OutputMidiNumber":a.outputMidiNumber=D._parseIntSafe(n,0);break;case"TechniqueSymbol":a.techniqueSymbol=this._parseTechniqueSymbol(n);break;case"TechniquePlacement":switch(n){case"outside":a.techniqueSymbolPlacement=3;break;case"inside":a.techniqueSymbolPlacement=1;break;case"above":a.techniqueSymbolPlacement=0;break;case"below":a.techniqueSymbolPlacement=2}break;case"Noteheads":var o=D._splitSafe(n);1<=o.length&&(a.noteHeadDefault=this._parseNoteHead(o[0])),2<=o.length&&(a.noteHeadHalf=this._parseNoteHead(o[1])),3<=o.length&&(a.noteHeadWhole=this._parseNoteHead(o[2])),-1===a.noteHeadHalf&&(a.noteHeadHalf=a.noteHeadDefault),-1===a.noteHeadWhole&&(a.noteHeadWhole=a.noteHeadDefault);break;case"StaffLine":a.staffLine=D._parseIntSafe(n,0)}}-1!==a.outputMidiNumber?(e.percussionArticulations.push(a),0<r.length&&this._articulationByName.set(r,a)):0<r.length&&this._articulationByName.has(r)&&(this._articulationByName.get(r).staffLine=a.staffLine)}_parseTechniqueSymbol(e){switch(e){case"pictEdgeOfCymbal":return 59177;case"articStaccatoAbove":return 58530;case"noteheadParenthesis":return 57550;case"stringsUpBow":return 58898;case"stringsDownBow":return 58896;case"guitarGolpe":return 59458;default:return-1}}_parseNoteHead(e){switch(e){case"noteheadDoubleWholeSquare":return 57505;case"noteheadDoubleWhole":return 57504;case"noteheadWhole":return 57506;case"noteheadHalf":return 57507;case"noteheadBlack":return 57508;case"noteheadNull":return 57509;case"noteheadXOrnate":return 57514;case"noteheadTriangleUpWhole":return 57531;case"noteheadTriangleUpHalf":return 57532;case"noteheadTriangleUpBlack":return 57534;case"noteheadDiamondBlackWide":return 57564;case"noteheadDiamondWhite":return 57565;case"noteheadDiamondWhiteWide":return 57566;case"noteheadCircleX":return 57523;case"noteheadXWhole":return 57511;case"noteheadXHalf":return 57512;case"noteheadXBlack":return 57513;case"noteheadParenthesis":return 57550;case"noteheadSlashedBlack2":return 57552;case"noteheadCircleSlash":return 57591;case"noteheadHeavyX":return 57592;case"noteheadHeavyXHat":return 57593;default:return M.warning("GPIF","Unknown notehead symbol",e),-1}}_parseStaves(e,t){let s=0;for(var i of t.childElements()){var a;"Staff"===i.localName&&(e.ensureStaveCount(s+1),a=e.staves[s],this._parseStaff(a,i),s++)}}_parseStaff(e,t){for(var s of t.childElements())"Properties"===s.localName&&this._parseStaffProperties(e,s)}_parseStaffProperties(e,t){for(var s of t.childElements())"Property"===s.localName&&this._parseStaffProperty(e,s)}_parseStaffProperty(e,t){switch(t.getAttribute("name")){case"Tuning":for(var s of t.childElements())switch(s.localName){case"Pitches":var i=D._splitSafe(t.findChildElement("Pitches")?.innerText),a=new Array(i.length);for(let e=0;e<a.length;e++)a[a.length-1-e]=D._parseIntSafe(i[e],0);e.stringTuning.tunings=a;break;case"Label":e.stringTuning.name=s.innerText}e.isPercussion||(e.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this._parseDiagramCollectionForStaff(e,t);break;case"CapoFret":var r=D._parseIntSafe(t.findChildElement("Fret")?.innerText,0);e.capo=r}}_parseLyrics(e,t){var s,i=[];for(s of t.childElements())"Line"===s.localName&&i.push(this._parseLyricsLine(s));this._lyricsByTrack.set(e,i)}_parseLyricsLine(e){var t,s=new Xt;for(t of e.childElements())switch(t.localName){case"Offset":s.startBar=D._parseIntSafe(t.innerText,0);break;case"Text":s.text=t.innerText}return s}_parseDiagramCollectionForTrack(e,t){t=t.findChildElement("Items");if(t)for(var s of t.childElements())"Item"===s.localName&&this._parseDiagramItemForTrack(e,s)}_parseDiagramCollectionForStaff(e,t){t=t.findChildElement("Items");if(t)for(var s of t.childElements())"Item"===s.localName&&this._parseDiagramItemForStaff(e,s)}_parseDiagramItemForTrack(e,t){var s,i=new Ht,a=t.getAttribute("id");for(s of e.staves)s.addChord(a,i);this._parseDiagramItemForChord(i,t)}_parseDiagramItemForStaff(e,t){var s=new Ht,i=t.getAttribute("id");e.addChord(i,s),this._parseDiagramItemForChord(s,t)}_parseDiagramItemForChord(s,e){s.name=e.getAttribute("name");e=e.findChildElement("Diagram");if(e){var t,i=D._parseIntSafe(e.getAttribute("stringCount"),6),a=D._parseIntSafe(e.getAttribute("baseFret"),0);s.firstFret=a+1;for(let e=0;e<i;e++)s.strings.push(-1);for(t of e.childElements())switch(t.localName){case"Fret":var r=D._parseIntSafe(t.getAttribute("string"),0);s.strings[i-r-1]=a+D._parseIntSafe(t.getAttribute("fret"),0);break;case"Fingering":var n,o=new Map;for(n of t.childElements())if("Position"===n.localName){let e=-2,t=a+D._parseIntSafe(n.getAttribute("fret"),0);switch(n.getAttribute("finger")){case"Index":e=1;break;case"Middle":e=2;break;case"Rank":e=3;break;case"Pinky":e=4;break;case"Thumb":e=0}-2!==e&&(o.has(e)?s.barreFrets.push(t):o.set(e,!0))}break;case"Property":switch(t.getAttribute("name")){case"ShowName":s.showName="true"===t.getAttribute("value");break;case"ShowDiagram":s.showDiagram="true"===t.getAttribute("value");break;case"ShowFingering":s.showFingering="true"===t.getAttribute("value")}}}else s.showDiagram=!1,s.showFingering=!1}_parseTrackProperties(e,t){for(var s of t.childElements())"Property"===s.localName&&this._parseTrackProperty(e,s)}_parseTrackProperty(e,t){switch(t.getAttribute("name")){case"Tuning":var s,i=D._splitSafe(t.findChildElement("Pitches")?.innerText),a=new Array(i.length);for(let e=0;e<a.length;e++)a[a.length-1-e]=D._parseIntSafe(i[e],0);for(s of e.staves)s.stringTuning.tunings=a,s.showStandardNotation=!0,s.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this._parseDiagramCollectionForTrack(e,t);break;case"CapoFret":var r,n=D._parseIntSafe(t.findChildElement("Fret")?.innerText,0);for(r of e.staves)r.capo=n}}_parseGeneralMidi(e,t){for(var s of t.childElements())switch(s.localName){case"Program":e.playbackInfo.program=D._parseIntSafe(s.innerText,0);break;case"Port":e.playbackInfo.port=D._parseIntSafe(s.innerText,0);break;case"PrimaryChannel":e.playbackInfo.primaryChannel=D._parseIntSafe(s.innerText,0);break;case"SecondaryChannel":e.playbackInfo.secondaryChannel=D._parseIntSafe(s.innerText,0)}if("Percussion"===t.getAttribute("table"))for(var i of e.staves)i.isPercussion=!0}_parseSounds(e,t,s){for(var i of s.childElements())"Sound"===i.localName&&this._parseSound(e,t,i)}_parseSound(e,t,s){var i,a=new di;for(i of s.childElements())switch(i.localName){case"Name":a.name=i.innerText;break;case"Path":a.path=i.innerText;break;case"Role":a.role=i.innerText;break;case"MIDI":this._parseSoundMidi(a,i)}this._soundsByTrack.has(e)||(this._soundsByTrack.set(e,new Map),t.playbackInfo.program=a.program,t.playbackInfo.bank=a.bank),this._soundsByTrack.get(e).set(a.uniqueId,a)}_parseSoundMidi(e,t){let s=0,i=0;for(var a of t.childElements())switch(a.localName){case"Program":e.program=D._parseIntSafe(a.innerText,0);break;case"MSB":s=D._parseIntSafe(a.innerText,0);break;case"LSB":i=D._parseIntSafe(a.innerText,0)}e.bank=(127&s)<<7|i}_parsePartSounding(e,t,s){for(var i of s.childElements())switch(i.localName){case"TranspositionPitch":for(var a of t.staves)a.displayTranspositionPitch=D._parseIntSafe(i.innerText,0);break;case"NominalKey":var r=Math.max(0,qt.noteNames.indexOf(i.innerText));this._transposeKeySignaturePerTrack.set(e,r)}}_parseTranspose(e,t,s){let i=0,a=0;for(var r of s.childElements())switch(r.localName){case"Chromatic":a=D._parseIntSafe(r.innerText,0);break;case"Octave":i=D._parseIntSafe(r.innerText,0)}var n,o=12*i+a;for(n of t.staves)n.displayTranspositionPitch=o;s=F.flooredDivision(o,12);this._transposeKeySignaturePerTrack.set(e,s)}_parseRSE(e,t){for(var s of t.childElements())"ChannelStrip"===s.localName&&this._parseChannelStrip(e,s)}_parseChannelStrip(e,t){for(var s of t.childElements())"Parameters"===s.localName&&this._parseChannelStripParameters(e,s)}_parseChannelStripParameters(e,t){t.firstChild&&t.firstChild.value&&12<=(t=D._splitSafe(t.firstChild.value)).length&&(e.playbackInfo.balance=Math.floor(16*D._parseFloatSafe(t[11],.5)),e.playbackInfo.volume=Math.floor(16*D._parseFloatSafe(t[12],.9)))}_parseMasterBarsNode(e){for(var t of e.childElements())"MasterBar"===t.localName&&this._parseMasterBar(t)}_parseMasterBar(e){var r,n=new $e;0===this._masterBars.length&&this._hasAnacrusis&&(n.isAnacrusis=!0);for(r of e.childElements())switch(r.localName){case"Time":var o=r.innerText.split("/");n.timeSignatureNumerator=D._parseIntSafe(o[0],4),n.timeSignatureDenominator=D._parseIntSafe(o[1],4);break;case"FreeTime":n.isFreeTime=!0;break;case"DoubleBar":n.isDoubleBar=!0,this._doubleBars.add(n);break;case"Section":n.section=new Jt,n.section.marker=r.findChildElement("Letter")?.innerText??"",n.section.text=r.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===r.getAttribute("start").toLowerCase()&&(n.isRepeatStart=!0),"true"===r.getAttribute("end").toLowerCase()&&r.getAttribute("count")&&(n.repeatCount=D._parseIntSafe(r.getAttribute("count"),1));break;case"AlternateEndings":let t=D._splitSafe(r.innerText),s=0;for(let e=0;e<t.length;e++)s|=1<<-1+D._parseIntSafe(t[e],0);n.alternateEndings=s;break;case"Bars":this._barsOfMasterBar.push(D._splitSafe(r.innerText));break;case"TripletFeel":switch(r.innerText){case"NoTripletFeel":n.tripletFeel=0;break;case"Triplet8th":n.tripletFeel=2;break;case"Triplet16th":n.tripletFeel=1;break;case"Dotted8th":n.tripletFeel=4;break;case"Dotted16th":n.tripletFeel=3;break;case"Scottish8th":n.tripletFeel=6;break;case"Scottish16th":n.tripletFeel=5}break;case"Key":let e=D._parseIntSafe(r.findChildElement("AccidentalCount")?.innerText,0),i=r.findChildElement("Mode"),a=0;if(i)switch(i.innerText.toLowerCase()){case"major":a=0;break;case"minor":a=1}this._keySignatures.set(this._masterBars.length,[e,a]);break;case"Fermatas":this._parseFermatas(n,r);break;case"XProperties":this._parseMasterBarXProperties(n,r);break;case"Directions":this._parseDirections(n,r)}this._masterBars.push(n)}_parseDirections(e,t){for(var s of t.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":e.addDirection(3);break;case"DoubleCoda":e.addDirection(4);break;case"Segno":e.addDirection(1);break;case"SegnoSegno":e.addDirection(2);break;case"Fine":e.addDirection(0)}break;case"Jump":switch(s.innerText){case"DaCapo":e.addDirection(5);break;case"DaCapoAlCoda":e.addDirection(6);break;case"DaCapoAlDoubleCoda":e.addDirection(7);break;case"DaCapoAlFine":e.addDirection(8);break;case"DaSegno":e.addDirection(9);break;case"DaSegnoAlCoda":e.addDirection(10);break;case"DaSegnoAlDoubleCoda":e.addDirection(11);break;case"DaSegnoAlFine":e.addDirection(12);break;case"DaSegnoSegno":e.addDirection(13);break;case"DaSegnoSegnoAlCoda":e.addDirection(14);break;case"DaSegnoSegnoAlDoubleCoda":e.addDirection(15);break;case"DaSegnoSegnoAlFine":e.addDirection(16);break;case"DaCoda":e.addDirection(17);break;case"DaDoubleCoda":e.addDirection(18)}}}_parseFermatas(e,t){for(var s of t.childElements())"Fermata"===s.localName&&this._parseFermata(e,s)}_parseFermata(e,t){let s=0,i=new At;for(var a of t.childElements())switch(a.localName){case"Type":switch(a.innerText){case"Short":i.type=0;break;case"Medium":i.type=1;break;case"Long":i.type=2}break;case"Length":i.length=D._parseFloatSafe(a.innerText,0);break;case"Offset":var r,n=a.innerText.split("/");2===n.length&&(r=D._parseIntSafe(n[0],4),n=D._parseIntSafe(n[1],4),s=r/n*N.QuarterTime|0)}e.addFermata(s,i)}_parseBars(e){for(var t of e.childElements())"Bar"===t.localName&&this._parseBar(t)}_parseBar(e){var t,s=new Ae,i=e.getAttribute("id");for(t of e.childElements())switch(t.localName){case"Voices":this._voicesOfBar.set(i,D._splitSafe(t.innerText));break;case"Clef":switch(t.innerText){case"Neutral":s.clef=0;break;case"G2":s.clef=4;break;case"F4":s.clef=3;break;case"C4":s.clef=2;break;case"C3":s.clef=1}break;case"Ottavia":switch(t.innerText){case"8va":s.clefOttava=1;break;case"15ma":s.clefOttava=0;break;case"8vb":s.clefOttava=3;break;case"15mb":s.clefOttava=4}break;case"SimileMark":switch(t.innerText){case"Simple":s.simileMark=1;break;case"FirstOfDouble":s.simileMark=2;break;case"SecondOfDouble":s.simileMark=3}break;case"XProperties":this._parseBarXProperties(t,s)}this._barsById.set(i,s)}_parseVoices(e){for(var t of e.childElements())"Voice"===t.localName&&this._parseVoice(t)}_parseVoice(e){var t,s=new We,i=e.getAttribute("id");for(t of e.childElements())"Beats"===t.localName&&this._beatsOfVoice.set(i,D._splitSafe(t.innerText));this._voiceById.set(i,s)}_parseBeats(e){for(var t of e.childElements())"Beat"===t.localName&&this._parseBeat(t)}_parseBeat(e){var t,s=new wt,i=e.getAttribute("id");for(t of e.childElements())switch(t.localName){case"Notes":this._notesOfBeat.set(i,D._splitSafe(t.innerText));break;case"Rhythm":this._rhythmOfBeat.set(i,t.getAttribute("ref"));break;case"Fadding":switch(t.innerText){case"FadeIn":s.fade=1;break;case"FadeOut":s.fade=2;break;case"VolumeSwell":s.fade=3}break;case"Tremolo":switch(t.innerText){case"1/2":s.tremoloSpeed=8;break;case"1/4":s.tremoloSpeed=16;break;case"1/8":s.tremoloSpeed=32}break;case"Chord":s.chordId=t.innerText;break;case"Hairpin":switch(t.innerText){case"Crescendo":s.crescendo=1;break;case"Decrescendo":s.crescendo=2}break;case"Arpeggio":"Up"===t.innerText?s.brushType=3:s.brushType=4;break;case"Properties":this._parseBeatProperties(t,s);break;case"XProperties":this._parseBeatXProperties(t,s);break;case"FreeText":s.text=t.innerText;break;case"TransposedPitchStemOrientation":switch(t.innerText){case"Upward":s.preferredBeamDirection=0;break;case"Downward":s.preferredBeamDirection=1}break;case"Dynamic":switch(t.innerText){case"PPP":s.dynamics=0;break;case"PP":s.dynamics=1;break;case"P":s.dynamics=2;break;case"MP":s.dynamics=3;break;case"MF":s.dynamics=4;break;case"F":s.dynamics=5;break;case"FF":s.dynamics=6;break;case"FFF":s.dynamics=7}break;case"GraceNotes":switch(t.innerText){case"OnBeat":s.graceType=1;break;case"BeforeBeat":s.graceType=2}break;case"Legato":"true"===t.getAttribute("origin")&&(s.isLegatoOrigin=!0);break;case"Whammy":var a=new w(0,0),a=(a.value=this._toBendValue(D._parseFloatSafe(t.getAttribute("originValue"),0)),a.offset=this._toBendOffset(D._parseFloatSafe(t.getAttribute("originOffset"),0)),s.addWhammyBarPoint(a),new w(0,0)),a=(a.value=this._toBendValue(D._parseFloatSafe(t.getAttribute("middleValue"),0)),a.offset=this._toBendOffset(D._parseFloatSafe(t.getAttribute("middleOffset1"),0)),s.addWhammyBarPoint(a),new w(0,0)),a=(a.value=this._toBendValue(D._parseFloatSafe(t.getAttribute("middleValue"),0)),a.offset=this._toBendOffset(D._parseFloatSafe(t.getAttribute("middleOffset2"),0)),s.addWhammyBarPoint(a),new w(0,0));a.value=this._toBendValue(D._parseFloatSafe(t.getAttribute("destinationValue"),0)),a.offset=this._toBendOffset(D._parseFloatSafe(t.getAttribute("destinationOffset"),0)),s.addWhammyBarPoint(a);break;case"Ottavia":switch(t.innerText){case"8va":s.ottava=1;break;case"8vb":s.ottava=3;break;case"15ma":s.ottava=0;break;case"15mb":s.ottava=4}break;case"Lyrics":s.lyrics=this._parseBeatLyrics(t),this._skipApplyLyrics=!0;break;case"Slashed":s.slashed=!0;break;case"DeadSlapped":s.deadSlapped=!0;break;case"Golpe":switch(t.innerText){case"Finger":s.golpe=2;break;case"Thumb":s.golpe=1}break;case"Wah":switch(t.innerText){case"Open":s.wahPedal=1;break;case"Closed":s.wahPedal=2}break;case"UserTransposedPitchStemOrientation":switch(t.innerText){case"Downward":s.preferredBeamDirection=1;break;case"Upward":s.preferredBeamDirection=0}break;case"Timer":s.showTimer=!0,s.timer=D._parseIntSafe(t.innerText,-1),s.timer<0&&(s.timer=null)}this._beatById.set(i,s)}_parseBeatLyrics(e){var t,s=[];for(t of e.childElements())"Line"===t.localName&&s.push(t.innerText);return s}_parseBeatXProperties(e,s){for(var i of e.childElements())if("XProperty"===i.localName){let e=i.getAttribute("id"),t=0;switch(e){case"1124204546":switch(t=D._parseIntSafe(i.findChildElement("Int")?.innerText,0)){case 1:s.beamingMode=2;break;case 2:s.beamingMode=1}break;case"1124204552":1===(t=D._parseIntSafe(i.findChildElement("Int")?.innerText,0))&&1!==s.beamingMode&&(s.beamingMode=3);break;case"1124204545":t=D._parseIntSafe(i.findChildElement("Int")?.innerText,0),s.invertBeamDirection=1===t;break;case"687935489":t=D._parseIntSafe(i.findChildElement("Int")?.innerText,0),s.brushDuration=t}}}_parseBarXProperties(e,t){for(var s of e.childElements())"XProperty"===s.localName&&"1124139520"===s.getAttribute("id")&&(s=s.findChildElement("Double")??s.findChildElement("Float"),t.displayScale=D._parseFloatSafe(s?.innerText,1))}_parseMasterBarXProperties(e,t){for(var s of t.childElements())"XProperty"===s.localName&&"1124073984"===s.getAttribute("id")&&(e.displayScale=D._parseFloatSafe(s.findChildElement("Double")?.innerText,1))}_parseBeatProperties(e,t){let s=!1,i=null,a=null,r=null,n=null,o=null;for(var h of e.childElements())if("Property"===h.localName)switch(h.getAttribute("name")){case"Brush":"Up"===h.findChildElement("Direction")?.innerText?t.brushType=1:t.brushType=2;break;case"PickStroke":"Up"===h.findChildElement("Direction")?.innerText?t.pickStroke=1:t.pickStroke=2;break;case"Slapped":h.findChildElement("Enable")&&(t.slap=!0);break;case"Popped":h.findChildElement("Enable")&&(t.pop=!0);break;case"VibratoWTremBar":switch(h.findChildElement("Strength")?.innerText){case"Wide":t.vibrato=2;break;case"Slight":t.vibrato=1}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":(i=i||new w(0,0)).value=this._toBendValue(D._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":(i=i||new w(0,0)).offset=this._toBendOffset(D._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":a=this._toBendValue(D._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":r=this._toBendOffset(D._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":n=this._toBendOffset(D._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":(o=o||new w(w.MaxPosition,0)).value=this._toBendValue(D._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":(o=o||new w(0,0)).offset=this._toBendOffset(D._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"BarreFret":t.barreFret=D._parseIntSafe(h.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(h.findChildElement("String")?.innerText){case"0":t.barreShape=1;break;case"1":t.barreShape=2}break;case"Rasgueado":switch(h.findChildElement("Rasgueado")?.innerText){case"ii_1":t.rasgueado=1;break;case"mi_1":t.rasgueado=2;break;case"mii_1":t.rasgueado=3;break;case"mii_2":t.rasgueado=4;break;case"pmp_1":t.rasgueado=5;break;case"pmp_2":t.rasgueado=6;break;case"pei_1":t.rasgueado=7;break;case"pei_2":t.rasgueado=8;break;case"pai_1":t.rasgueado=9;break;case"pai_2":t.rasgueado=10;break;case"ami_1":t.rasgueado=11;break;case"ami_2":t.rasgueado=12;break;case"ppp_1":t.rasgueado=13;break;case"amii_1":t.rasgueado=14;break;case"amip_1":t.rasgueado=15;break;case"eami_1":t.rasgueado=16;break;case"eamii_1":t.rasgueado=17;break;case"peami_1":t.rasgueado=18}}s&&(i=i||new w(0,0),o=o||new w(w.MaxPosition,0),t.addWhammyBarPoint(i),r&&a&&t.addWhammyBarPoint(new w(r,a)),n&&a&&t.addWhammyBarPoint(new w(n,a)),r||n||!a||t.addWhammyBarPoint(new w(w.MaxPosition/2|0,a)),t.addWhammyBarPoint(o))}_parseNotes(e){for(var t of e.childElements())"Note"===t.localName&&this._parseNote(t)}_parseNote(e){var t,s=new dt,i=e.getAttribute("id");for(t of e.childElements())switch(t.localName){case"Properties":this._parseNoteProperties(t,s,i);break;case"AntiAccent":"normal"===t.innerText.toLowerCase()&&(s.isGhost=!0);break;case"LetRing":s.isLetRing=!0;break;case"Trill":s.trillValue=D._parseIntSafe(t.innerText,-1),s.trillSpeed=16;break;case"Accent":var a=D._parseIntSafe(t.innerText,0);0!=(1&a)&&(s.isStaccato=!0),0!=(4&a)&&(s.accentuated=2),0!=(8&a)&&(s.accentuated=1),0!=(16&a)&&(s.accentuated=3);break;case"Tie":"true"===t.getAttribute("destination").toLowerCase()&&(s.isTieDestination=!0);break;case"Vibrato":switch(t.innerText){case"Slight":s.vibrato=1;break;case"Wide":s.vibrato=2}break;case"LeftFingering":switch(t.innerText){case"P":s.leftHandFinger=0;break;case"I":s.leftHandFinger=1;break;case"M":s.leftHandFinger=2;break;case"A":s.leftHandFinger=3;break;case"C":s.leftHandFinger=4}break;case"RightFingering":switch(t.innerText){case"P":s.rightHandFinger=0;break;case"I":s.rightHandFinger=1;break;case"M":s.rightHandFinger=2;break;case"A":s.rightHandFinger=3;break;case"C":s.rightHandFinger=4}break;case"InstrumentArticulation":s.percussionArticulation=D._parseIntSafe(t.innerText,0);break;case"Ornament":switch(t.innerText){case"Turn":s.ornament=2;break;case"InvertedTurn":s.ornament=1;break;case"UpperMordent":s.ornament=3;break;case"LowerMordent":s.ornament=4}}this._noteById.set(i,s)}_parseNoteProperties(e,t,s){let i=!1,a=null,r=null,n=null,o=null,h=null,l=-1,d=-1,c=!1;for(var u of e.childElements())if("Property"===u.localName)switch(u.getAttribute("name")){case"ShowStringNumber":u.findChildElement("Enable")&&(t.showStringNumber=!0);break;case"String":t.string=D._parseIntSafe(u.findChildElement("String")?.innerText,0)+1;break;case"Fret":t.fret=D._parseIntSafe(u.findChildElement("Fret")?.innerText,0);break;case"Element":l=D._parseIntSafe(u.findChildElement("Element")?.innerText,0);break;case"Variation":d=D._parseIntSafe(u.findChildElement("Variation")?.innerText,0);break;case"Tapped":this._tappedNotes.set(s,!0);break;case"HarmonicType":var p=u.findChildElement("HType");if(p)switch(p.innerText){case"NoHarmonic":t.harmonicType=0;break;case"Natural":t.harmonicType=1;break;case"Artificial":t.harmonicType=2;break;case"Pinch":t.harmonicType=3;break;case"Tap":t.harmonicType=4;break;case"Semi":t.harmonicType=5;break;case"Feedback":t.harmonicType=6}break;case"HarmonicFret":p=u.findChildElement("HFret");p&&(t.harmonicValue=D._parseFloatSafe(p.innerText,0));break;case"Muted":u.findChildElement("Enable")&&(t.isDead=!0);break;case"PalmMuted":u.findChildElement("Enable")&&(t.isPalmMute=!0);break;case"Octave":t.octave=D._parseIntSafe(u.findChildElement("Number")?.innerText,0),-1===t.tone&&(t.tone=0);break;case"Tone":t.tone=D._parseIntSafe(u.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":c||this._parseConcertPitch(u,t);break;case"TransposedPitch":t.accidentalMode=0,this._parseConcertPitch(u,t),c=!0;break;case"Bended":i=!0;break;case"BendOriginValue":(a=a||new w(0,0)).value=this._toBendValue(D._parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":(a=a||new w(0,0)).offset=this._toBendOffset(D._parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":r=this._toBendValue(D._parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":n=this._toBendOffset(D._parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":o=this._toBendOffset(D._parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":(h=h||new w(w.MaxPosition,0)).value=this._toBendValue(D._parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":(h=h||new w(0,0)).offset=this._toBendOffset(D._parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":u.findChildElement("Enable")&&(t.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":t.isLeftHandTapped=!0;break;case"Slide":var m=D._parseIntSafe(u.findChildElement("Flags")?.innerText,0);0!=(1&m)?t.slideOutType=1:0!=(2&m)?t.slideOutType=2:0!=(4&m)?t.slideOutType=4:0!=(8&m)&&(t.slideOutType=3),0!=(16&m)?t.slideInType=1:0!=(32&m)&&(t.slideInType=2),0!=(64&m)?t.slideOutType=5:0!=(128&m)&&(t.slideOutType=6)}i&&(a=a||new w(0,0),h=h||new w(w.MaxPosition,0),t.addBendPoint(a),n&&r&&t.addBendPoint(new w(n,r)),o&&r&&t.addBendPoint(new w(o,r)),n||o||!r||t.addBendPoint(new w(w.MaxPosition/2|0,r)),t.addBendPoint(h)),-1!==l&&-1!==d&&(t.percussionArticulation=rt.articulationFromElementVariation(l,d))}_parseConcertPitch(e,t){e=e.findChildElement("Pitch");if(e)for(var s of e.childElements())if("Accidental"===s.localName)switch(s.innerText){case"x":t.accidentalMode=4;break;case"#":t.accidentalMode=3;break;case"b":t.accidentalMode=5;break;case"bb":t.accidentalMode=6}}_toBendValue(e){return e*D._bendPointValueFactor|0}_toBendOffset(e){return e*D._bendPointPositionFactor}_parseRhythms(e){for(var t of e.childElements())"Rhythm"===t.localName&&this._parseRhythm(t)}_parseRhythm(e){var t,s=new li,i=e.getAttribute("id");s.id=i;for(t of e.childElements())switch(t.localName){case"NoteValue":switch(t.innerText){case"Long":s.value=-4;break;case"DoubleWhole":s.value=-2;break;case"Whole":s.value=1;break;case"Half":s.value=2;break;case"Quarter":s.value=4;break;case"Eighth":s.value=8;break;case"16th":s.value=16;break;case"32nd":s.value=32;break;case"64th":s.value=64;break;case"128th":s.value=128;break;case"256th":s.value=256}break;case"PrimaryTuplet":s.tupletNumerator=D._parseIntSafe(t.getAttribute("num"),-1),s.tupletDenominator=D._parseIntSafe(t.getAttribute("den"),-1);break;case"AugmentationDot":s.dots=D._parseIntSafe(t.getAttribute("count"),0)}this._rhythmById.set(i,s)}_buildModel(){for(let e=0,t=this._masterBars.length;e<t;e++){var s=this._masterBars[e];this.score.addMasterBar(s)}var e,t,i,a,r,n,o,h,l,d,c=this._masterBars[this._masterBars.length-1],u=(this._doubleBars.has(c)&&(this._doubleBars.delete(c),c.isDoubleBar=!1),[]);for(e of this._tracksMapping)e&&(t=this._tracksById.get(e),this.score.addTrack(t),u.push(e));let p;for(i of this._barsOfMasterBar){let t=0,s=0;p=[0,0],this._transposeKeySignaturePerTrack.has(u[0])&&(p=[F.transposeKey(p[0],this._transposeKeySignaturePerTrack.get(u[0])),p[1]]);for(let e=0;e<i.length&&s<this.score.tracks.length;e++){var m=i[e];if(m!==D._invalidId){var g=this._barsById.get(m),f=this.score.tracks[s],b=f.staves[t],y=(b.addBar(g),b.bars.length-1);if(this._keySignatures.has(y)&&(p=this._keySignatures.get(y),this._transposeKeySignaturePerTrack.has(u[s]))&&(p=[F.transposeKey(p[0],this._transposeKeySignaturePerTrack.get(u[s])),p[1]]),g.keySignature=p[0],g.keySignatureType=p[1],this._doubleBars.has(g.masterBar)&&(g.barLineRight=7),this._voicesOfBar.has(m))for(var _ of this._voicesOfBar.get(m))if(_!==D._invalidId){var S=this._voiceById.get(_);if(g.addVoice(S),this._beatsOfVoice.has(_))for(var v of this._beatsOfVoice.get(_))if(v!==D._invalidId){var k,w=Pt.clone(this._beatById.get(v)),T=(S.addBeat(w),this._rhythmOfBeat.get(v)),T=this._rhythmById.get(T);if(w.duration=T.value,w.dots=T.dots,w.tupletNumerator=T.tupletNumerator,w.tupletDenominator=T.tupletDenominator,this._notesOfBeat.has(v))for(var B of this._notesOfBeat.get(v))B!==D._invalidId&&(k=Bt.clone(this._noteById.get(B)),b.isPercussion?(k.fret=-1,k.string=-1):k.percussionArticulation=-1,w.addNote(k),this._tappedNotes.has(B))&&(w.tap=!0)}}else{var _=new We,x=(g.addVoice(_),new wt);x.isEmpty=!0,x.duration=4,_.addBeat(x)}t===f.staves.length-1?(s++,t=0):t++,p=[0,0],s<u.length&&this._transposeKeySignaturePerTrack.has(u[s])&&(p=[F.transposeKey(p[0],this._transposeKeySignaturePerTrack.get(u[s])),p[1]])}else s++}}for(a of this._tracksMapping)if(a){let e=this._tracksById.get(a),t=!1;for(var P of e.staves)if(P.isPercussion){t=!0;break}if(t||(e.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(a))for([r,n]of this._automationsPerTrackIdAndBarIndex.get(a))if(0<e.staves.length&&r<e.staves[0].bars.length){var N=e.staves[0].bars[r];if(0<N.voices.length&&0<N.voices[0].beats.length){var M,E=N.voices[0].beats[0];for(M of n)4===M.type&&0===M.value&&0===N.index||E.automations.push(M)}}if(this._sustainPedalsPerTrackIdAndBarIndex.has(a))for([o,h]of this._sustainPedalsPerTrackIdAndBarIndex.get(a))0<e.staves.length&&o<e.staves[0].bars.length&&(e.staves[0].bars[o].sustainPedals=h)}for([l,d]of this._masterTrackAutomations){var L=this.score.masterBars[l];for(let e=0,t=d.length;e<t;e++){var C=d[e];switch(C.type){case 0:L.tempoAutomations.push(C);break;case 4:C.syncPointValue.millisecondOffset-=this._backingTrackPadding,L.addSyncPoint(C)}}}}},ci=(D._invalidId="-1",D._bendPointPositionFactor=w.MaxPosition/100,D._bendPointValueFactor=.04,D._sampleRate=44100,D),ui=class{constructor(){this.isMultiRest=!1,this.trackViewGroups=[]}},pi=class{constructor(){this.showNumbered=!1,this.showSlash=!1,this.showStandardNotation=!1,this.showTablature=!1}},mi=class{constructor(e){this.scoreViews=[];var t=Bs.fromBuffer(e),s=f.readInt32BE(t);for(let e=0;e<s;e++){var i=new ui,a=(this.scoreViews.push(i),i.isMultiRest=ri.gpReadBool(t),f.readInt32BE(t));for(let e=0;e<a;e++){let e=t.readByte();0===e&&(e=1);var r=new pi;r.showStandardNotation=0!=(1&e),r.showTablature=0!=(2&e),r.showSlash=0!=(4&e),r.showNumbered=0!=(8&e),i.trackViewGroups.push(r)}}}apply(s){if(0<this.scoreViews.length){let t=0;s.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(var e of this.scoreViews[0].trackViewGroups){var i;if(t<s.tracks.length)for(i of s.tracks[t].staves)i.isPercussion||(i.showTablature=e.showTablature),i.showStandardNotation=e.showStandardNotation,i.showSlash=e.showSlash,i.showNumbered=e.showNumbered;t++}for(let e=1;e<this.scoreViews.length;e++)this.scoreViews[e].isMultiRest&&(s.stylesheet.perTrackMultiBarRest||(s.stylesheet.perTrackMultiBarRest=new Set),t=e-1,s.stylesheet.perTrackMultiBarRest.add(t))}}static writeForScore(e){var t,s,i=Bs.withCapacity(128),a=[new ui];a[0].isMultiRest=e.stylesheet.multiTrackMultiBarRest;for(t of e.tracks){var r=new pi,n=(r.showStandardNotation=t.staves[0].showStandardNotation,r.showTablature=t.staves[0].showTablature,r.showSlash=t.staves[0].showSlash,r.showNumbered=t.staves[0].showNumbered,a[0].trackViewGroups.push(r),new ui);n.isMultiRest=!0===e.stylesheet.perTrackMultiBarRest?.has(t.index),n.trackViewGroups.push(r),a.push(n)}f.writeInt32BE(i,a.length);for(s of a){i.writeByte(s.isMultiRest?1:0),f.writeInt32BE(i,s.trackViewGroups.length);for(var o of s.trackViewGroups){let e=0;o.showStandardNotation&&(e|=1),o.showTablature&&(e|=2),o.showSlash&&(e|=4),o.showNumbered&&(e|=8),i.writeByte(e)}}return f.writeInt32BE(i,1),i.toArray()}},gi=class{constructor(){this.trackViewGroups=[]}},fi=class{constructor(){this.isVisible=!1}},bi=class{constructor(t,e){this.zoomLevel=4,this.view=0,this.muiltiVoiceCursor=!1,this.scoreViews=[];var s=Bs.fromBuffer(e),i=(this.zoomLevel=f.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=0!==s.readByte(),t.scoreViews.length);for(let e=0;e<i;e++){var a=new gi,r=(this.scoreViews.push(a),t.scoreViews[e]);for(let e=0;e<r.trackViewGroups.length;e++){var n=new fi;n.isVisible=0!==s.readByte(),a.trackViewGroups.push(n)}}}apply(t){if(0<this.scoreViews.length){let e=0;for(var s of this.scoreViews[0].trackViewGroups)e<t.tracks.length&&(t.tracks[e].isVisibleOnMultiTrack=s.isVisible),e++}}static writeForScore(e){var t,s,i=Bs.withCapacity(128),a=(f.writeInt32BE(i,4),i.writeByte(0),0<e.tracks.length&&e.tracks[0].staves[0].bars[0].isMultiVoice);i.writeByte(a?255:0);for(t of e.tracks)i.writeByte(t.isVisibleOnMultiTrack?255:0);for(s of e.tracks)i.writeByte(255);return i.toArray()}},yi=class extends ws{get name(){return"Guitar Pro 7-8"}readScore(){M.debug(this.name,"Loading ZIP entries");let e=new Rs(this.data),t;try{t=e.read()}catch(e){throw new Ts("No Zip archive",e)}M.debug(this.name,"Zip entries loaded");let s=null,i=null,a=null,r=null,n=new Map;for(var o of t)switch(n.set(o.fullName,o),o.fileName){case"score.gpif":s=f.toString(o.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=o.data;break;case"PartConfiguration":a=o.data;break;case"LayoutConfiguration":r=o.data}if(!s)throw new Ts("No score.gpif found in zip archive");M.debug(this.name,"Start Parsing score.gpif");var h=new ci,h=(h.loadAsset=e=>{if(n.has(e))return n.get(e).data},h.parseXml(s,this.settings),M.debug(this.name,"score.gpif parsed"),h.score);i&&(M.debug(this.name,"Start Parsing BinaryStylesheet"),new oi(i).apply(h),M.debug(this.name,"BinaryStylesheet parsed"));let l=null;return a&&(M.debug(this.name,"Start Parsing Part Configuration"),(l=new mi(a)).apply(h),M.debug(this.name,"Part Configuration parsed")),r&&null!=l&&(M.debug(this.name,"Start Parsing Layout Configuration"),new bi(l,r).apply(h),M.debug(this.name,"Layout Configuration parsed")),h}},_i=class extends b{constructor(){super(1,"Unexpected end of data within reader")}},Si=class Si{constructor(e){this._currentByte=0,this._position=Si._byteSize,this._source=e}readByte(){return this.readBits(8)}readBytes(t){var s=new Uint8Array(t);for(let e=0;e<t;e++)s[e]=255&this.readByte();return s}readBits(e){let t=0,s=e-1;for(;0<=s;)t|=this.readBit()<<s,s--;return t}readBitsReversed(t){let s=0;for(let e=0;e<t;e++)s|=this.readBit()<<e;return s}readBit(){if(8<=this._position){if(this._currentByte=this._source.readByte(),-1===this._currentByte)throw new _i;this._position=0}var e=this._currentByte>>Si._byteSize-this._position-1&1;return this._position++,e}readAll(){var e=Bs.empty();try{for(;;)e.writeByte(255&this.readByte())}catch(e){if(!(e instanceof _i))throw e}return e.toArray()}},vi=(Si._byteSize=8,Si),ki=class{constructor(){this.fileName="",this.fileSize=0,this.data=null}},wi=class{constructor(){this.files=[],this.files=[],this.fileFilter=e=>!0}load(e){e=new vi(e);this._readBlock(e)}readHeader(e){return this._getString(e.readBytes(4),0,4)}decompress(t,e=!1){let s=Bs.empty(),i,a=this._getInteger(t.readBytes(4),0);try{for(;s.length<a;)if(1===t.readBits(1)){var r=t.readBits(4),n=t.readBitsReversed(r),o=t.readBitsReversed(r),h=s.length-n,l=Math.min(n,o);i=s.getBuffer(),s.write(i,h,l)}else{var d=t.readBitsReversed(2);for(let e=0;e<d;e++)s.writeByte(t.readByte())}}catch(e){if(!(e instanceof _i))throw e}i=s.getBuffer();var e=e?4:0,c=s.length-e,u=new Uint8Array(c);return u.set(i.subarray(e,e+c),0),u}_readBlock(e){var t=this.readHeader(e);if("BCFZ"===t)this._readUncompressedBlock(this.decompress(e,!0));else{if("BCFS"!==t)throw new Ts("Unsupported format");this._readUncompressedBlock(e.readAll())}}_readUncompressedBlock(a){let r=4096;for(;r+3<a.length;){if(2===this._getInteger(a,r)){var n,o=new ki,h=(o.fileName=this._getString(a,r+4,127),o.fileSize=this._getInteger(a,r+140),!this.fileFilter||this.fileFilter(o.fileName));h&&this.files.push(o);let e=r+148,t,s=0,i=h?Bs.withCapacity(o.fileSize):null;for(;0!==(t=this._getInteger(a,e+4*s++));)r=4096*t,h&&i.write(a,r,4096);h&&(o.data=new Uint8Array(Math.min(o.fileSize,i.length)),n=i.toArray(),o.data.set(n.subarray(0,0+o.data.length),0))}r+=4096}}_getString(t,s,i){let a="";for(let e=0;e<i;e++){var r=255&t[s+e];if(0==r)break;a+=String.fromCharCode(r)}return a}_getInteger(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}},Ti=(wi.HeaderBcFs="BCFS",wi.HeaderBcFz="BCFZ",class extends ws{get name(){return"Guitar Pro 6"}readScore(){M.debug(this.name,"Loading GPX filesystem");var e,t=new wi;t.fileFilter=e=>e.endsWith("score.gpif")||e.endsWith("BinaryStylesheet")||e.endsWith("PartConfiguration")||e.endsWith("LayoutConfiguration"),t.load(this.data),M.debug(this.name,"GPX filesystem loaded");let s=null,i=null,a=null,r=null;for(e of t.files)switch(e.fileName){case"score.gpif":s=f.toString(e.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=e.data;break;case"PartConfiguration":a=e.data;break;case"LayoutConfiguration":r=e.data}if(!s)throw new Ts("No score.gpif found in GPX");M.debug(this.name,"Start Parsing score.gpif");t=new ci,t.parseXml(s,this.settings),M.debug(this.name,"score.gpif parsed"),t=t.score;i&&(M.debug(this.name,"Start Parsing BinaryStylesheet"),new oi(i).apply(t),M.debug(this.name,"BinaryStylesheet parsed"));let n=null;return a&&(M.debug(this.name,"Start Parsing Part Configuration"),(n=new mi(a)).apply(t),M.debug(this.name,"Part Configuration parsed")),r&&null!=n&&(M.debug(this.name,"Start Parsing Layout Configuration"),new bi(n,r).apply(t),M.debug(this.name,"Layout Configuration parsed")),t}}),Bi=class{constructor(){this.maxLine=-1e3,this.maxLineNote=null,this.minLine=-1e3,this.minLineNote=null}},xi=class xi{constructor(e){this._registeredAccidentals=new Map,this._appliedScoreLines=new Map,this._appliedScoreLinesByValue=new Map,this._notesByValue=new Map,this._beatLines=new Map,this.maxLineBeat=null,this.minLineBeat=null,this.maxLine=-1e3,this.minLine=-1e3,this._barRenderer=e,this._bar=e.bar}static getPercussionLine(e,t){return t<e.staff.track.percussionArticulations.length?e.staff.track.percussionArticulations[t].staffLine:rt.getArticulationByInputMidiNumber(t)?.staffLine??0}static getNoteValue(e){if(e.isPercussion)return e.percussionArticulation;let t=e.displayValue;switch(e.accidentalMode){case 6:t+=2;break;case 4:t-=2;break;case 5:t+=1;break;case 3:--t}return t}applyAccidental(e){var t=xi.getNoteValue(e),s=e.hasQuarterToneOffset;return this._getAccidental(t,s,e.beat,!1,e)}applyAccidentalForValue(e,t,s,i){return this._getAccidental(t,s,e,i,null)}static computeLineWithoutAccidentals(e,t){let s=0,i=xi.getNoteValue(t);return s=t.isPercussion?xi.getPercussionLine(e,i):xi.calculateNoteSteps(e.keySignature,e.clef,i)}_getAccidental(t,s,e,i,a=null){let r=0,n=0;if((null!=a?a:this._bar.staff).isPercussion)r=xi.getPercussionLine(this._bar,t);else{var o,h=a?a.accidentalMode:0,l=(r=xi.calculateNoteSteps(this._bar.keySignature,this._bar.clef,t),this._registeredAccidentals.has(r)?this._registeredAccidentals.get(r):null);let e=!1;switch(n=F.computeAccidental(this._bar.keySignature,h,t,s,l)){case 4:case 5:case 6:break;default:(e=a&&a.isTieDestination&&0===a.beat.index&&(o=this._barRenderer.scoreRenderer.layout?.getRendererForBar(this._barRenderer.staff.staffId,a.tieOrigin.beat.voice.bar))&&o.staff===this._barRenderer.staff&&o.accidentalHelper.getNoteLine(a.tieOrigin)===r?!0:e)?n=0:0!==n&&this._registeredAccidentals.set(r,n)}}return a?(this._appliedScoreLines.set(a.id,r),this._notesByValue.set(t,a)):this._appliedScoreLinesByValue.set(t,r),(-1e3===this.minLine||this.minLine<r)&&(this.minLine=r,this.minLineBeat=e),(-1e3===this.maxLine||this.maxLine>r)&&(this.maxLine=r,this.maxLineBeat=e),i||this._registerLine(e,r,a),n}_registerLine(e,t,s){let i;this._beatLines.has(e.id)?i=this._beatLines.get(e.id):(i=new Bi,this._beatLines.set(e.id,i)),(-1e3===i.minLine||t<i.minLine)&&(i.minLine=t,i.minLineNote=s),(-1e3===i.minLine||t>i.maxLine)&&(i.maxLine=t,i.maxLineNote=s)}getMaxLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLine:0}getMaxLineNote(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLineNote:null}getMinLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLine:0}getMinLineNote(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLineNote:null}static calculateNoteSteps(e,t,s){var i=s%12,s=(s/12|0)-1,t=xi._octaveSteps[t],s=(t-=s*xi._stepsPerOctave,F.keySignatureIsSharp(e)||F.keySignatureIsNatural(e)?xi.sharpNoteSteps:xi.flatNoteSteps);return t-=s[i]}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,t=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):t&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}},Pi=(xi._stepsPerOctave=7,xi._octaveSteps=[38,32,30,26,38],xi.sharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6],xi.flatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6],xi),Ni=class{constructor(){this.currentDynamics=5,this.slideOrigins=new Map,this.transpose=0,this.isExplicitlyBeamed=!1,this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}},Mi=class extends h{constructor(){super(...arguments),this.outputMidiChannel=-1,this.outputMidiProgram=-1,this.outputMidiBank=-1,this.outputVolume=-1,this.outputBalance=-1}},Ei=class Ei{constructor(e){this.instruments=new Map,this._instrumentIdToArticulationIndex=new Map,this._lyricsLine=0,this._lyricsLines=new Map,this.track=e}getLyricLine(e){var t;return this._lyricsLines.has(e)?this._lyricsLines.get(e):(t=this._lyricsLine,this._lyricsLines.set(e,t),this._lyricsLine++,t)}getOrCreateArticulation(e,t){var s=12*t.octave+t.tone,i=e+"_"+s;if(this._instrumentIdToArticulationIndex.has(i))return this._instrumentIdToArticulationIndex.get(i);let a,r=(a=this.instruments.has(e)?this.instruments.get(e):Ei._defaultNoteArticulation,this.track.percussionArticulations.length),n=t.beat.voice.bar,o;o=0===s?4:Pi.calculateNoteSteps(n.keySignature,n.clef,s);e=9-(2*t.beat.voice.bar.staff.standardNotationLineCount-1),s=o-e,t=new h(a.elementType,s,a.outputMidiNumber,a.noteHeadDefault,a.noteHeadHalf,a.noteHeadWhole,a.techniqueSymbol,a.techniqueSymbolPlacement);return this._instrumentIdToArticulationIndex.set(i,r),this.track.percussionArticulations.push(t),r}},Li=(Ei._defaultNoteArticulation=new h("Default",0,0,57508,57507,57506),Ei),Ci=class Ci extends ws{constructor(){super(...arguments),this._idToTrackInfo=new Map,this._indexToTrackInfo=new Map,this._staffToContext=new Map,this._divisionsPerQuarterNote=1,this._currentDynamics=5,this._musicalPosition=0,this._lastBeat=null,this._nextMasterBarRepeatEnding=0,this._nextBeatAutomations=null,this._nextBeatChord=null,this._nextBeatCrescendo=null,this._nextBeatLetRing=!1,this._nextBeatPalmMute=!1,this._nextBeatOttavia=null,this._nextBeatText=null,this._simileMarkAllStaves=null,this._simileMarkPerStaff=null,this._isBeatSlash=!1,this._keyAllStaves=null,this._currentTrillStep=-1}get name(){return"MusicXML"}readScore(){var e=this._extractMusicXml(),t=new Gs;try{t.parse(e)}catch(e){throw new Ts("Unsupported format",e)}return this._score=new qe,this._score.stylesheet.hideDynamics=!0,this._parseDom(t),F.consolidate(this._score),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}_extractMusicXml(){let e=new Rs(this.data),t;try{t=e.read()}catch{t=[]}if(0===t.length)return this.data.reset(),f.toString(this.data.readAll(),this.settings.importer.encoding);var s=t.find(e=>"META-INF/container.xml"===e.fullName);if(!s)throw new Ts("No compressed MusicXML");var i=new Gs;try{i.parse(f.toString(s.data,this.settings.importer.encoding))}catch(e){throw new Ts("Malformed container.xml, could not parse as XML",e)}s=i.firstElement;if(!s||"container"!==s.localName)throw new Ts("Malformed container.xml, root element not 'container'");var a,i=s.findChildElement("rootfiles");if(!i)throw new Ts("Malformed container.xml, 'container/rootfiles' not found");let r="";for(a of i.childElements())if("rootfile"===a.localName){r=a.getAttribute("full-path");break}if(!r)throw new Ts("Unsupported compressed MusicXML, missing rootfile");s=t.find(e=>e.fullName===r);if(s)return f.toString(s.data,this.settings.importer.encoding);throw new Ts(`Malformed container.xml, '${r}' not contained in zip`)}_parseDom(e){var t=e.firstElement;if(!t)throw new Ts("Unsupported format");switch(t.localName){case"score-partwise":this._parsePartwise(t);break;case"score-timewise":this._parseTimewise(t);break;default:throw new Ts("Unsupported format")}}_parsePartwise(e){for(var t of e.childElements())switch(t.localName){case"credit":this._parseCredit(t);break;case"identification":this._parseIdentification(t);break;case"movement-title":this._parseMovementTitle(t);break;case"part":this._parsePartwisePart(t);break;case"part-list":this._parsePartList(t);break;case"work":this._parseWork(t)}}_parseTimewise(e){let t=0;for(var s of e.childElements())switch(s.localName){case"credit":this._parseCredit(s);break;case"identification":this._parseIdentification(s);break;case"movement-title":this._parseMovementTitle(s);break;case"part-list":this._parsePartList(s);break;case"work":this._parseWork(s);break;case"measure":this._parseTimewiseMeasure(s,t),t++}}_parseCredit(i){if("1"===i.getAttribute("page","1")){let e=[],t=null,s="";for(var a of i.childElements())switch(a.localName){case"credit-type":e.push(a.innerText);break;case"credit-words":null===t&&(t=a),s+=a.innerText}if(0<e.length)for(var r of e)switch(r){case"title":this._score.title=Ci._sanitizeDisplay(s);break;case"subtitle":this._score.subTitle=Ci._sanitizeDisplay(s);break;case"composer":case"arranger":this._score.artist=Ci._sanitizeDisplay(s);break;case"lyricist":this._score.words=Ci._sanitizeDisplay(s);break;case"rights":this._score.copyright=Ci._sanitizeDisplay(s)}else if(t){var i=t.getAttribute("font-size","0"),n=t.getAttribute("font-size","top"),o=t.getAttribute("halign","left");if("top"===n)if(s.includes("copyright")||s.includes("Copyright")||s.includes("")||s.includes("(c)")||s.includes("(C)"))this._score.copyright=Ci._sanitizeDisplay(s);else{if("center"===o||"center"===i){if(0===this._score.title.length)return void(this._score.title=Ci._sanitizeDisplay(s));if(0===this._score.subTitle.length)return void(this._score.subTitle=Ci._sanitizeDisplay(s));if(0===this._score.album.length)return void(this._score.album=Ci._sanitizeDisplay(s))}else if(("right"===o||"right"===i)&&0===this._score.music.length)return void(this._score.music=Ci._sanitizeDisplay(s));0===this._score.artist.length?this._score.artist=Ci._sanitizeDisplay(s):0===this._score.words.length&&(this._score.words=Ci._sanitizeDisplay(s))}}}}static _sanitizeDisplay(e){return e.replaceAll("\r","").replaceAll(`
`," ").replaceAll("\t","").replaceAll(" ","")}_parseIdentification(e){for(var t of e.childElements())switch(t.localName){case"creator":if(t.attributes.has("type"))switch(t.attributes.get("type")){case"composer":this._score.artist=Ci._sanitizeDisplay(t.innerText);break;case"lyricist":this._score.words=Ci._sanitizeDisplay(t.innerText);break;case"arranger":this._score.music=Ci._sanitizeDisplay(t.innerText)}else this._score.artist=Ci._sanitizeDisplay(t.innerText);break;case"rights":0<this._score.copyright.length&&(this._score.copyright+=", "),this._score.copyright+=t.innerText,t.attributes.has("type")&&(this._score.copyright+=` (${t.attributes.get("type")})`);break;case"encoding":this._parseEncoding(t)}}_parseEncoding(e){for(var t of e.childElements())switch(t.localName){case"encoder":0<this._score.tab.length&&(this._score.tab+=", "),this._score.tab+=t.innerText,t.attributes.has("type")&&(this._score.tab+=` (${t.attributes.get("type")})`);break;case"encoding-description":this._score.notices+=Ci._sanitizeDisplay(t.innerText)}}_parseMovementTitle(e){0===this._score.title.length?this._score.title=Ci._sanitizeDisplay(e.innerText):this._score.subTitle=Ci._sanitizeDisplay(e.innerText)}_parsePartList(e){for(var t of e.childElements())"score-part"===t.localName&&this._parseScorePart(t)}_parseScorePart(e){var t,s=new ts,i=(s.ensureStaveCount(1),this._score.addTrack(s),e.attributes.get("id")),a=new Li(s);this._idToTrackInfo.set(i,a),this._indexToTrackInfo.set(s.index,a);for(t of e.childElements())switch(t.localName){case"part-name":s.name=Ci._sanitizeDisplay(t.innerText);break;case"part-name-display":s.name=this._parsePartDisplayAsText(t);break;case"part-abbreviation":s.shortName=Ci._sanitizeDisplay(t.innerText);break;case"part-abbreviation-display":s.shortName=this._parsePartDisplayAsText(t);break;case"score-instrument":this._parseScoreInstrument(t,a);break;case"midi-device":t.attributes.has("port")&&(s.playbackInfo.port=Number.parseInt(t.attributes.get("port"),10));break;case"midi-instrument":this._parseScorePartMidiInstrument(t,a)}a.firstArticulation&&(0<=a.firstArticulation.outputMidiProgram&&(s.playbackInfo.program=a.firstArticulation.outputMidiProgram),0<=a.firstArticulation.outputMidiBank&&(s.playbackInfo.bank=a.firstArticulation.outputMidiBank),0<=a.firstArticulation.outputBalance&&(s.playbackInfo.balance=a.firstArticulation.outputBalance),0<=a.firstArticulation.outputVolume&&(s.playbackInfo.volume=a.firstArticulation.outputVolume),0<=a.firstArticulation.outputMidiChannel)&&(s.playbackInfo.primaryChannel=a.firstArticulation.outputMidiChannel,s.playbackInfo.secondaryChannel=a.firstArticulation.outputMidiChannel)}_parseScoreInstrument(e,t){var s=new Mi;t.firstArticulation||(t.firstArticulation=s),t.instruments.set(e.getAttribute("id",""),s)}_parseScorePartMidiInstrument(e,t){var s=e.getAttribute("id","");if(t.instruments.has(s)){var i,a=t.instruments.get(s);for(i of e.childElements())switch(i.localName){case"midi-channel":a.outputMidiChannel=Number.parseInt(i.innerText,10)-1;break;case"midi-bank":a.outputMidiBank=Number.parseInt(i.innerText,10)-1;break;case"midi-program":a.outputMidiProgram=Number.parseInt(i.innerText,10)-1;break;case"midi-unpitched":a.outputMidiNumber=Number.parseInt(i.innerText,10)-1;break;case"volume":a.outputVolume=Ci._interpolatePercent(Number.parseFloat(i.innerText));break;case"pan":a.outputBalance=Ci._interpolatePan(Number.parseFloat(i.innerText))}}}static _interpolatePercent(e){return 0|Ci._interpolate(0,100,0,16,e)}static _interpolatePan(e){return 0|Ci._interpolate(-90,90,0,16,e)}static _interpolate(e,t,s,i,a){return s+(i-s)*((a-e)/(t-e))}_parsePartDisplayAsText(e){let t="";for(var s of e.childElements())switch(s.localName){case"display-text":t+=s.innerText;break;case"accidental-text":switch(s.innerText){case"sharp":t+="";break;case"natural":t+="";break;case"flat":t+="";break;case"double-sharp":t+="";break;case"sharp-sharp":t+="";break;case"flat-flat":t+="";break;case"natural-sharp":t+="";break;case"natural-flat":t+="";break;case"sharp-down":t+="";break;case"sharp-up":t+="";break;case"natural-down":t+="";break;case"natural-up":t+="";break;case"flat-down":t+="";break;case"flat-up":t+="";break;case"arrow-down":t+="";break;case"arrow-up":t+="";break;case"triple-sharp":t+="";break;case"triple-flat":t+="";break;case"sharp-1":t+="";break;case"sharp-2":t+="";break;case"sharp-3":t+="";break;case"sharp-4":t+="";break;case"sharp-5":t+="";break;case"flat-1":t+="";break;case"flat-2":t+="";break;case"flat-3":t+="";break;case"flat-4":t+="";break;case"flat-5":t+=""}}return Ci._sanitizeDisplay(t)}_parseWork(e){for(var t of e.childElements())"work-title"===t.localName&&(this._score.title=Ci._sanitizeDisplay(t.innerText))}_parsePartwisePart(s){var i=s.attributes.get("id");if(i&&this._idToTrackInfo.has(i)){let e=this._idToTrackInfo.get(i).track,t=0;for(var a of s.childElements())"measure"===a.localName&&(this._parsePartwiseMeasure(a,e,t),t++)}}_parsePartwiseMeasure(e,t,s){s=this._getOrCreateMasterBar(e,s);this._parsePartMeasure(e,s,t)}_parseTimewiseMeasure(e,t){var s,i=this._getOrCreateMasterBar(e,t);for(s of e.childElements())"part"===s.localName&&this._parseTimewisePart(s,i)}_getOrCreateMasterBar(e,t){for(var s="yes"===e.attributes.get("implicit");this._score.masterBars.length<=t;){var i=new $e;s&&(i.isAnacrusis=!0),this._score.addMasterBar(i),0<i.index&&(i.timeSignatureDenominator=i.previousMasterBar.timeSignatureDenominator,i.timeSignatureNumerator=i.previousMasterBar.timeSignatureNumerator,i.tripletFeel=i.previousMasterBar.tripletFeel)}return this._score.masterBars[t]}_parseTimewisePart(e,t){var s=e.attributes.get("id");s&&this._idToTrackInfo.has(s)&&(s=this._idToTrackInfo.get(s).track,this._parsePartMeasure(e,t,s))}_parsePartMeasure(e,t,s){this._musicalPosition=0,this._lastBeat=null,t.alternateEndings=this._nextMasterBarRepeatEnding;var i,a,r=[];for(i of e.childElements())switch(i.localName){case"note":this._parseNote(i,t,s);break;case"backup":this._parseBackup(i);break;case"forward":this._parseForward(i);break;case"direction":this._parseDirection(i,t,s);break;case"attributes":this._parseAttributes(i,t,s);break;case"harmony":this._parseHarmony(i,s);break;case"print":this._parsePrint(i,t,s);break;case"sound":this._parseSound(i,t,s);break;case"barline":r.push(i)}for(a of r)this._parseBarLine(a,t,s);this._applySimileMarks(t,s);e=this._getOrCreateStaff(s,0);this._getOrCreateBar(e,t),this._keyAllStaves=null}_parsePrint(e,t,s){"yes"!==e.getAttribute("new-system","no")&&"yes"!==e.getAttribute("new-page","no")||s.addLineBreaks(t.index)}_applySimileMarks(e,t){if(null!==this._simileMarkAllStaves){for(var s of t.staves){s=this._getOrCreateBar(s,e);s.simileMark=this._simileMarkAllStaves,0!==s.simileMark&&this._clearBar(s)}2===this._simileMarkAllStaves?this._simileMarkAllStaves=3:this._simileMarkAllStaves=null}if(null!==this._simileMarkPerStaff){var i;for(i of Array.from(this._simileMarkPerStaff.keys())){var a=this._getOrCreateStaff(t,i),a=this._getOrCreateBar(a,e);a.simileMark=this._simileMarkPerStaff.get(i),0!==a.simileMark&&this._clearBar(a),2===a.simileMark?this._simileMarkPerStaff.set(i,3):this._simileMarkPerStaff.delete(i)}0===this._simileMarkPerStaff.size&&(this._simileMarkPerStaff=null)}}_clearBar(e){for(var t of e.voices){var s=new wt;s.isEmpty=!0,t.addBeat(s)}}_parseBarLine(e,t,s){for(var i of e.childElements())switch(i.localName){case"bar-style":this._parseBarStyle(i,t,s,e.getAttribute("location","right"));break;case"ending":this._parseEnding(i,t);break;case"repeat":this._parseRepeat(i,t)}}_parseRepeat(e,t){let s=e.getAttribute("direction"),i=Number.parseInt(e.getAttribute("times"),10);(i<0||Number.isNaN(i))&&(i=2),"backward"===s?t.repeatCount=i:"forward"===s&&(t.isRepeatStart=!0)}_parseEnding(e,t){let s=e.getAttribute("number").split(",").map(e=>Number.parseInt(e,10)),i=0;for(var a of s)i|=1<<a-1&255;switch(t.alternateEndings=i,e.getAttribute("type","")){case"start":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding|i;break;case"stop":case"discontinue":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding&~i}}_parseBarStyle(e,t,s,i){let a=0;switch(e.innerText){case"dashed":a=1;break;case"dotted":a=2;break;case"heavy":a=3;break;case"heavy-heavy":a=4;break;case"heavy-light":a=5;break;case"light-heavy":a=6;break;case"light-light":a=7;break;case"none":a=8;break;case"regular":a=9;break;case"short":a=10;break;case"tick":a=11}for(var r of s.staves){var n=this._getOrCreateBar(r,t);switch(i){case"left":n.barLineLeft=a;break;case"right":n.barLineRight=a}}}_parseSound(e,t,s){for(var i of e.childElements())switch(i.localName){case"midi-instrument":this._parseSoundMidiInstrument(i,t);break;case"swing":this._parseSwing(i,t)}var a;e.attributes.has("coda")&&t.addDirection(3),e.attributes.has("tocoda")&&t.addDirection(17),e.attributes.has("dacapo")&&t.addDirection(5),e.attributes.has("dalsegno")&&t.addDirection(9),e.attributes.has("fine")&&t.addDirection(0),e.attributes.has("segno")&&t.addDirection(1),e.attributes.has("pan")&&(this._nextBeatAutomations||(this._nextBeatAutomations=[]),(a=new K).type=3,a.value=Ci._interpolatePan(Number.parseFloat(e.attributes.get("pan"))),this._nextBeatAutomations.push(a)),e.attributes.has("tempo")&&(this._nextBeatAutomations||(this._nextBeatAutomations=[]),(a=new K).type=0,a.value=Ci._interpolatePercent(Number.parseFloat(e.attributes.get("tempo"))),this._nextBeatAutomations.push(a))}_parseSwing(e,t){let s=0,i=0,a=null;for(var r of e.childElements())switch(r.localName){case"straight":return void(t.tripletFeel=0);case"first":s=Number.parseInt(r.innerText,10);break;case"second":i=Number.parseInt(r.innerText,10);break;case"swing-type":a=this._parseBeatDuration(r)}8===(a=a||8)?2===s&&1===i?t.tripletFeel=2:3===s&&1===i?t.tripletFeel=4:1===s&&3===i&&(t.tripletFeel=6):16===a&&(2===s&&1===i?t.tripletFeel=1:3===s&&1===i?t.tripletFeel=3:1===s&&3===i&&(t.tripletFeel=5))}_parseSoundMidiInstrument(e,t){let s;for(var i of e.childElements())switch(i.localName){case"midi-bank":this._nextBeatAutomations||(this._nextBeatAutomations=[]),(s=new K).type=4,s.value=Number.parseInt(i.innerText,10)-1,this._nextBeatAutomations.push(s);break;case"midi-program":this._nextBeatAutomations||(this._nextBeatAutomations=[]),(s=new K).type=2,s.value=Number.parseInt(i.innerText,10)-1,this._nextBeatAutomations.push(s);break;case"volume":this._nextBeatAutomations||(this._nextBeatAutomations=[]),(s=new K).type=1,s.value=Ci._interpolatePercent(Number.parseFloat(i.innerText)),this._nextBeatAutomations.push(s);break;case"pan":this._nextBeatAutomations||(this._nextBeatAutomations=[]),(s=new K).type=3,s.value=Ci._interpolatePan(Number.parseFloat(i.innerText)),this._nextBeatAutomations.push(s)}}_parseHarmony(e,t){let s=new Ht,i=!1,a="";for(var r of e.childElements())switch(r.localName){case"root":s.name=this._parseHarmonyRoot(r);break;case"kind":s.name=s.name+this._parseHarmonyKind(r),"yes"===r.getAttribute("parentheses-degrees","no")&&(i=!0);break;case"frame":this._parseHarmonyFrame(r,s);break;case"degree":a+=this._parseDegree(r)}a&&(s.name+=i?`(${a})`:a),null===this._nextBeatChord&&(this._nextBeatChord=s)}_parseDegree(e){let t="",s="",i="";for(var a of e.childElements())switch(a.localName){case"degree-value":t=a.innerText;break;case"degree-alter":switch(a.innerText){case"-1":s="";break;case"1":s=""}break;case"degree-type":i+=a.getAttribute("text","")}return""+i+s+t}_parseHarmonyRoot(e){let t="",s="";for(var i of e.childElements())switch(i.localName){case"root-step":t=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##"}}return t+s}_parseHarmonyKind(e){let t=e.getAttribute("text"),s="";if(t)s=t;else{var i=e.innerText;switch(i){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="II";break;case"Italian":s="It";break;case"French":case"German":s="Fr";break;default:s=i}}return s}_parseHarmonyFrame(e,s){for(var i of e.childElements())switch(i.localName){case"frame-strings":var a=Number.parseInt(i.innerText,10);s.strings=new Array(a);for(let e=0;e<a;e++)s.strings[e]=-1;break;case"first-fret":s.firstFret=Number.parseInt(i.innerText,10);break;case"frame-note":let e=null,t=null;for(var r of i.childElements())switch(r.localName){case"string":e=Number.parseInt(r.innerText,10);break;case"fret":t=Number.parseInt(r.innerText,10),e&&0<=t&&(s.strings[e-1]=t);break;case"barre":e&&t&&"start"===r.getAttribute("type")&&s.barreFrets.push(t)}}}_parseAttributes(e,t,s){let i,a,r;if(null==this._lastBeat)for(var n of e.childElements())switch(n.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(n.innerText);break;case"key":this._parseKey(n,t,s);break;case"time":this._parseTime(n,t);break;case"staves":s.ensureStaveCount(Number.parseInt(n.innerText,10));break;case"clef":i=Number.parseInt(n.getAttribute("number","1"),10)-1,a=this._getOrCreateStaff(s,i),r=this._getOrCreateBar(a,t),this._parseClef(n,r);break;case"staff-details":i=Number.parseInt(n.getAttribute("number","1"),10)-1,a=this._getOrCreateStaff(s,i),this._parseStaffDetails(n,a);break;case"transpose":this._parseTranspose(n,s);break;case"measure-style":this._parseMeasureStyle(n,s,!1)}else for(var o of e.childElements())switch(o.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(o.innerText);break;case"measure-style":this._parseMeasureStyle(o,s,!0)}}_parseMeasureStyle(t,e,s){for(var i of t.childElements())switch(i.localName){case"measure-repeat":if(!s){let e=null;switch(i.getAttribute("type")){case"start":switch(Number.parseInt(i.getAttribute("slashes","1"),10)){case 1:e=1;break;case 2:e=2}break;case"stop":e=null}var a;t.attributes.has("number")?(this._simileMarkPerStaff=this._simileMarkPerStaff??new Map,a=Number.parseInt(t.attributes.get("number"),10)-1,null==e?this._simileMarkPerStaff.delete(a):this._simileMarkPerStaff.set(a,e)):this._simileMarkAllStaves=e}break;case"slash":switch(i.getAttribute("type")){case"start":this._isBeatSlash=!0;break;case"stop":this._isBeatSlash=!1}}}_parseTranspose(e,t){let s=0;for(var i of e.childElements())switch(i.localName){case"chromatic":s+=Number.parseFloat(i.innerText);break;case"octave-change":s+=12*Number.parseFloat(i.innerText)}if(e.attributes.has("number")){e=this._getOrCreateStaff(t,Number.parseInt(e.attributes.get("number"),10)-1);this._getStaffContext(e).transpose=s,e.displayTranspositionPitch=s}else for(var a of t.staves)this._getStaffContext(a).transpose=s,a.displayTranspositionPitch=s}_parseStaffDetails(e,t){for(var s of e.childElements())switch(s.localName){case"staff-lines":t.standardNotationLineCount=Number.parseInt(s.innerText,10);break;case"staff-tuning":this._parseStaffTuning(s,t);break;case"capo":t.capo=Number.parseInt(s.innerText,10)}}_parseStaffTuning(e,t){0===t.stringTuning.tunings.length&&(t.showTablature=!0,t.showStandardNotation=!1,t.stringTuning.tunings=new Array(t.standardNotationLineCount).fill(0));let s=Number.parseInt(e.getAttribute("line"),10),i="C",a="",r=0;for(var n of e.childElements())switch(n.localName){case"tuning-step":i=n.innerText;break;case"tuning-alter":r=Number.parseFloat(n.innerText);break;case"tuning-octave":a=n.innerText}e=F.getTuningForText(i+a)+r;t.tuning[t.tuning.length-s]=e}_parseClef(e,t){let s="s",i=0;for(var a of e.childElements())switch(a.localName){case"sign":s=a.innerText.toLowerCase();break;case"line":i=Number.parseInt(a.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(a.innerText,10)){case-2:t.clefOttava=4;break;case-1:t.clefOttava=3;break;case 1:t.clefOttava=1;break;case 2:t.clefOttava=4}}switch(s){case"g":t.clef=4;break;case"f":t.clef=3;break;case"c":3===i?t.clef=1:t.clef=2;break;case"percussion":t.clef=0,t.staff.isPercussion=!0;break;case"tab":t.clef=4,t.staff.showTablature=!0;break;default:t.clef=4}}_parseTime(e,t){let s=!1,i=!1;for(var a of e.childElements()){var r=a.innerText;switch(a.localName){case"beats":s||(-1===r.indexOf("+")?t.timeSignatureNumerator=Number.parseInt(r,10):t.timeSignatureNumerator=r.split("+").map(e=>Number.parseInt(e,10)).reduce((e,t)=>t+e,0),s=!0);break;case"beat-type":i||(-1===r.indexOf("+")?t.timeSignatureDenominator=Number.parseInt(r,10):t.timeSignatureDenominator=r.split("+").map(e=>Number.parseInt(e,10)).reduce((e,t)=>t+e,0),i=!0)}}switch(e.getAttribute("symbol","")){case"common":case"cut":t.timeSignatureCommon=!0}}_parseKey(e,t,s){let i=-0,a="";for(var r of e.childElements())switch(r.localName){case"fifths":i=Number.parseInt(r.innerText,10);break;case"mode":a=r.innerText}let n;n=-7<=i&&i<=7?i:0;let o;if(o="minor"===a?1:0,e.attributes.has("number")){e=this._getOrCreateStaff(s,Number.parseInt(e.attributes.get("number"),10)-1),e=this._getOrCreateBar(e,t);e.keySignature=n,e.keySignatureType=o}else{this._keyAllStaves=[n,o];for(var h of s.staves)h.bars.length>t.index&&(h.bars[t.index].keySignature=n,h.bars[t.index].keySignatureType=o)}}_parseDirection(e,s,t){let i=[],a=null,r=-1,n=-1;for(var o of e.childElements())switch(o.localName){case"direction-type":var h=o.firstElement;h&&i.push(h);break;case"offset":a=Number.parseFloat(o.innerText);break;case"voice":break;case"staff":r=Number.parseInt(o.innerText,10)-1;break;case"sound":o.attributes.has("tempo")&&(n=Number.parseFloat(o.attributes.get("tempo")))}let l=null;var d,c=(l=0<=r?this._getOrCreateStaff(t,r):null!==this._lastBeat?this._lastBeat.voice.bar.staff:this._getOrCreateStaff(t,0))?this._getOrCreateBar(l,s):null,u=()=>{let e=this._musicalPosition;null!==a&&(e+=a);var t=s.calculateDuration(!1);return e/t};0<n&&((e=new K).type=0,e.value=n,e.ratioPosition=u(),this._hasSameTempo(s,e)||s.tempoAutomations.push(e));let p="";for(d of i)switch(d.localName){case"rehearsal":s.section=new Jt,s.section.marker=d.innerText;break;case"segno":s.addDirection(1);break;case"coda":s.addDirection(3);break;case"words":p=d.innerText;break;case"wedge":switch(d.getAttribute("type")){case"crescendo":this._nextBeatCrescendo=1;break;case"diminuendo":this._nextBeatCrescendo=2;break;case"stop":this._nextBeatCrescendo=null}break;case"dynamics":var m=this._parseDynamics(d);null!==m&&(this._currentDynamics=m,this._score.stylesheet.hideDynamics=!1);break;case"dashes":var g=d.getAttribute("type","start");switch(p){case"LetRing":this._nextBeatLetRing="start"===g||"continue"===g;break;case"P.M.":this._nextBeatPalmMute="start"===g||"continue"===g}p="";break;case"pedal":var f,m=this._parsePedal(d);m&&c&&(m.ratioPosition=u(),f=0<c.sustainPedals.length&&2!==c.sustainPedals[c.sustainPedals.length-1].pedalType,2===m.pedalType&&!f||c.sustainPedals.push(m));break;case"metronome":this._parseMetronome(d,s,u());break;case"octave-shift":this._nextBeatOttavia=this._parseOctaveShift(d)}p&&(this._nextBeatText=p)}_parseOctaveShift(e){var t=e.getAttribute("type");switch(Number.parseInt(e.getAttribute("size","8"),10)){case 15:switch(t){case"up":return 4;case"down":return 0;case"stop":return 2;case"continue":return this._nextBeatOttavia}break;case 8:switch(t){case"up":return 3;case"down":return 1;case"stop":return 2;case"continue":return this._nextBeatOttavia}}return null}_parseMetronome(e,t,s){let i=null,a=-1;for(var r of e.childElements())switch(r.localName){case"beat-unit":i=this._parseBeatDuration(r);break;case"per-minute":a=Number.parseFloat(r.innerText)}null!==i&&0<a&&((e=new K).type=0,e.value=a*(i/4)|0,e.ratioPosition=s,this._hasSameTempo(t,e)||t.tempoAutomations.push(e))}_hasSameTempo(e,t){for(var s of e.tempoAutomations)if(t.ratioPosition===s.ratioPosition&&t.value===s.value)return!0;return!1}_parsePedal(e){var t=new Ce;switch(e.getAttribute("type")){case"start":t.pedalType=0;break;case"stop":t.pedalType=2;break;case"continue":t.pedalType=1;break;default:return null}return t}_parseDynamics(e){for(var t of e.childElements()){var s=t.localName.toUpperCase();switch(s){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return q[s]}}return null}_parseForward(e){for(var t of e.childElements())"duration"===t.localName&&(this._musicalPosition+=this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText)))}_parseBackup(e){for(var t of e.childElements())if("duration"===t.localName)if(this._lastBeat){let e=this._musicalPosition;(e-=this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText)))<0&&(e=0),this._musicalPosition=e}}_getOrCreateStaff(e,t){for(;e.staves.length<=t;){var s=new $t;e.addStaff(s),0<this._score.masterBars.length&&this._getOrCreateBar(s,this._score.masterBars[this._score.masterBars.length-1])}return e.staves[t]}_getOrCreateBar(e,t){for(var s=0===e.bars.length?1:e.bars[0].voices.length;e.bars.length<=t.index;){var i=new Ae;e.addBar(i),i.previousBar&&(i.clef=i.previousBar.clef,i.clefOttava=i.previousBar.clefOttava,i.keySignature=i.previousBar.keySignature,i.keySignatureType=i.previousBar.keySignatureType),null!=this._keyAllStaves&&(i.keySignature=this._keyAllStaves[0],i.keySignatureType=this._keyAllStaves[1]);for(let e=0;e<s;e++){var a=new We;i.addVoice(a)}}return e.bars[t.index]}_getOrCreateVoice(e,t){let s=!1;for(;e.voices.length<=t;)e.addVoice(new We),s=!0;if(s)for(var i of e.staff.bars)for(;i.voices.length<=t;)i.addVoice(new We);return e.voices[t]}_parseNote(e,d,c){let u=null,p=0,m=0,g=null,t=!1,f=0,b=0,y=-1,_=null,S=0,v=-1,k=-1,w=null,T=null,B=!1,x=null,P="no"!==e.getAttribute("print-object","yes"),s=()=>{if(null===u){t&&!this._lastBeat&&(M.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),t=!1),t&&!T&&(M.warning("MusicXML","Cannot mix <chord /> and <rest />"),t=!1);var a=this._getOrCreateStaff(c,f);if(t)(u=this._lastBeat).addNote(T);else{let e=this._getOrCreateBar(a,d),t=this._getOrCreateVoice(e,b),s=0===t.beats.length?0:t.beats[t.beats.length-1].displayEnd,i=this._musicalPosition-s;if(0<i){if(this._lastBeat&&2===this._lastBeat.beamingMode&&this._lastBeat.voice.bar.staff.index!==f&&0<t.beats.length&&2===t.beats[t.beats.length-1].beamingMode)for(var r=t.beats[t.beats.length-1].duration;0<i;){var n=this._createRestForGap(i,r);if(null===n)break;this._insertBeatToVoice(n,t),i-=n.playbackDuration}0<i&&((h=new wt).dynamics=this._currentDynamics,h.isEmpty=!0,h.duration=256,h.overrideDisplayDuration=i,h.updateDurations(),this._insertBeatToVoice(h,t))}else i<0&&M.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");y<0&&null!==_&&(y=N.toTicks(_),0<S)&&(y=N.applyDot(y,2===S));var o=new wt,h=(u=o,null===g?o.beamingMode=this._getStaffContext(a).isExplicitlyBeamed?1:0:(o.beamingMode=g,this._getStaffContext(a).isExplicitlyBeamed=!0),o.isEmpty=!1,o.dynamics=this._currentDynamics,this._isBeatSlash&&(o.slashed=!0),this._nextBeatAutomations);if((this._nextBeatAutomations=null)!==h)for(var l of h)o.automations.push(l);var a=this._nextBeatChord,h=((this._nextBeatChord=null)!==a&&(o.chordId=a.uniqueId,t.bar.staff.hasChord(a.uniqueId)||t.bar.staff.addChord(o.chordId,a)),this._nextBeatCrescendo),a=(null!==h&&(o.crescendo=h),this._nextBeatOttavia);null!==a&&(o.ottava=a),o.isLetRing=this._nextBeatLetRing,o.isPalmMute=this._nextBeatPalmMute,this._nextBeatText&&(o.text=this._nextBeatText,this._nextBeatText=null),null!==T&&o.addNote(T),this._insertBeatToVoice(o,t),null!==T&&(T.isVisible=P,h=this._indexToTrackInfo.get(c.index),null!==x?T.percussionArticulation=h.getOrCreateArticulation(x,T):B||(T.percussionArticulation=h.getOrCreateArticulation("",T))),0!==p?(o.graceType=p,this._applyBeatDurationFromTicks(o,m,null,!1)):(o.tupletNumerator=v,o.tupletDenominator=k,o.dots=S,o.preferredBeamDirection=w,this._applyBeatDurationFromTicks(o,y,_,!0)),this._musicalPosition=o.displayEnd,this._lastBeat=o}}};for(var i of e.childElements())switch(i.localName){case"grace":var a=Number.parseFloat(i.getAttribute("make-time","-1"));p=0<=a?(m=this._musicXmlDivisionsToAlphaTabTicks(a),2):1,"yes"===i.getAttribute("slash")&&(p=2);break;case"chord":t=!0;break;case"cue":return;case"pitch":T=this._parsePitch(i),B=!0;break;case"unpitched":T=this._parseUnpitched(i,c);break;case"rest":(T=null)===_&&(_=1);break;case"duration":y=this._parseDuration(i);break;case"instrument":x=i.getAttribute("id","");break;case"voice":b=Number.parseInt(i.innerText,10),Number.isNaN(b)?(M.warning("MusicXML","Voices need to be specified as numbers"),b=0):b-=1;break;case"type":_=this._parseBeatDuration(i);break;case"dot":S++;break;case"accidental":null===T?M.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this._parseAccidental(i,T);break;case"time-modification":for(var r of i.childElements())switch(r.localName){case"actual-notes":v=Number.parseInt(r.innerText,10);break;case"normal-notes":k=Number.parseInt(r.innerText,10)}break;case"stem":w=this._parseStem(i);break;case"notehead":null===T?M.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this._parseNoteHead(i,T,_??4,w??this._estimateBeamDirection(T));break;case"staff":f=Number.parseInt(i.innerText,10)-1;break;case"beam":if("1"===i.getAttribute("number","1"))switch(i.innerText){case"begin":case"continue":g=2;break;case"end":g=1}break;case"notations":s(),this._parseNotations(i,T,u);break;case"lyric":s(),this._parseLyric(i,u,c);break;case"play":this._parsePlay(i,T)}B&&(e=this._getOrCreateStaff(c,f),0!==(e=this._getStaffContext(e).transpose))&&(e=12*T.octave+T.tone+e,T.octave=e/12|0,T.tone=e-12*T.octave),s()}_parsePlay(e,t){for(var s of e.childElements())"mute"===s.localName&&t&&"palm"===s.innerText&&(t.isPalmMute=!0)}_estimateBeamDirection(e){return e.calculateRealValue(!1,!1)<Ci._b4Value?1:0}_parseNoteHead(e,t,s,i){"yes"===e.getAttribute("parentheses","no")&&(t.isGhost=!0);let a=e.getAttribute("filled",""),r;switch("yes"===a?r=!0:"no"===a&&(r=!1),t.style=new lt,e.innerText){case"arrow down":t.style.noteHeadCenterOnStem=!0,this._applyNoteHead(t,s,r,57548,57540,57541,57543);break;case"arrow up":t.style.noteHeadCenterOnStem=!0,this._applyNoteHead(t,s,r,57530,57531,57532,57534);break;case"back slashed":this._applyNoteHead(t,s,r,57558,57556,57554,57552);break;case"circle dot":t.style.noteHead=57621;break;case"circle-x":this._applyNoteHead(t,s,r,57520,57521,57522,57523);break;case"circled":this._applyNoteHead(t,s,r,57575,57574,57573,57572);break;case"cluster":this._applyNoteHead(t,s,r,57640,57641,57642,57643);break;case"cross":this._applyNoteHead(t,s,r,57516,57517,57518,57519);break;case"diamond":this._applyNoteHead(t,s,r,57559,57560,57561,57563);break;case"do":this._applyNoteHead(t,s,r,57786,57786,57786,57787);break;case"fa":0===i?this._applyNoteHead(t,s,r,57780,57780,57780,57781):this._applyNoteHead(t,s,r,57782,57782,57782,57783);break;case"fa up":this._applyNoteHead(t,s,r,57782,57782,57782,57783);break;case"inverted triangle":this._applyNoteHead(t,s,r,57548,57540,57541,57543);break;case"la":this._applyNoteHead(t,s,r,57778,57778,57778,57779);break;case"left triangle":this._applyNoteHead(t,s,r,57537,57537,57537,57538);break;case"mi":this._applyNoteHead(t,s,r,57784,57784,57784,57785);break;case"none":t.style.noteHead=57509;break;case"normal":this._applyNoteHead(t,s,r,57504,57506,57507,57508);break;case"re":this._applyNoteHead(t,s,r,57788,57788,57788,57789);break;case"rectangle":this._applyNoteHead(t,s,r,57528,57528,57528,57529);break;case"slash":this._applyNoteHead(t,s,r,57602,57602,57603,57601);break;case"slashed":this._applyNoteHead(t,s,r,57557,57555,57553,57551);break;case"so":this._applyNoteHead(t,s,r,57776,57776,57776,57777);break;case"square":this._applyNoteHead(t,s,r,57778,57778,57778,57779);break;case"ti":this._applyNoteHead(t,s,r,57790,57790,57790,57791);break;case"triangle":this._applyNoteHead(t,s,r,57530,57531,57532,57534);break;case"x":this._applyNoteHead(t,s,r,57510,57511,57512,57513)}}_createRestForGap(e,t){let s=N.toTicks(t);for(;s>e;){if(256===t)return null;t*=2,s=N.toTicks(t)}var i=new wt;return i.dynamics=this._currentDynamics,i.isEmpty=!1,i.duration=t,i.overrideDisplayDuration=s,i.updateDurations(),i}_insertBeatToVoice(t,s){if(0<s.beats.length){var i=s.beats[s.beats.length-1];let e=(i.nextBeat=t).previousBeat=i;for(;null!==e&&0!==e.graceType;)e=0<e.index?e.previousBeat:null;null!==e&&(t.displayStart=e.displayEnd)}s.addBeat(t)}_musicXmlDivisionsToAlphaTabTicks(e){return e*N.QuarterTime/this._divisionsPerQuarterNote}_parseBeatDuration(e){switch(e.innerText){case"1024th":case"512th":case"256th":return 256;case"128th":return 128;case"64th":return 64;case"32nd":return 32;case"16th":return 16;case"eighth":return 8;case"quarter":return 4;case"half":return 2;case"whole":return 1;case"breve":return-2;case"long":return-4}return null}_applyBeatDurationFromTicks(e,t,s,i){if(!s)for(let e=0;e<Ci._allDurations.length;e++){if(!(Ci._allDurationTicks[e]<=t))break;s=Ci._allDurations[e]}e.duration=s??16,i&&(e.overrideDisplayDuration=t),e.updateDurations()}_parseLyric(e,t,s){var i,a=this._indexToTrackInfo.get(s.index).getLyricLine(e.getAttribute("number",""));for(null===t.lyrics&&(t.lyrics=[]);t.lyrics.length<=a;)t.lyrics.push("");for(i of e.childElements())switch(i.localName){case"text":t.lyrics[a]?t.lyrics[a]+=" "+i.innerText:t.lyrics[a]=i.innerText;break;case"elision":t.lyrics[a]+=i.innerText}}_parseNotations(e,t,s){for(var i of e.childElements())switch(i.localName){case"tied":t&&this._parseTied(i,t,s.voice.bar.staff);break;case"slur":t&&this._parseSlur(i,t);break;case"glissando":t&&this._parseGlissando(i,t);break;case"slide":t&&this._parseSlide(i,t);break;case"ornaments":t&&this._parseOrnaments(i,t);break;case"technical":this._parseTechnical(i,t,s);break;case"articulations":t&&this._parseArticulations(i,t);break;case"dynamics":var a=this._parseDynamics(i);null!==a&&(s.dynamics=a,this._currentDynamics=a);break;case"fermata":this._parseFermata(i,s);break;case"arpeggiate":this._parseArpeggiate(i,s)}}_getStaffContext(e){var t;return this._staffToContext.has(e)?this._staffToContext.get(e):(t=new Ni,this._staffToContext.set(e,t),t)}_parseGlissando(e,t){var s,i=e.getAttribute("type"),a=e.getAttribute("number","1"),r=this._getStaffContext(t.beat.voice.bar.staff);switch(i){case"start":r.slideOrigins.set(a,t);break;case"stop":r.slideOrigins.has(a)&&((((s=r.slideOrigins.get(a)).slideTarget=t).slideOrigin=s).slideOutType=1)}}_parseSlur(e,t){var s,i=e.getAttribute("number","1"),a=this._getStaffContext(t.beat.voice.bar.staff);switch(e.getAttribute("type")){case"start":a.slurStarts.set(i,t);break;case"stop":a.slurStarts.has(i)&&(t.isSlurDestination=!0,((s=a.slurStarts.get(i)).slurDestination=t).slurOrigin=s,a.slurStarts.delete(i))}}_parseArpeggiate(e,t){switch(e.getAttribute("direction","down")){case"down":t.brushType=4;break;case"up":t.brushType=3}}_parseFermata(e,t){let s;switch(e.innerText){case"normal":s=1;break;case"angled":s=0;break;case"square":s=2;break;default:s=1}t.fermata=new At,t.fermata.type=s}_parseArticulations(e,t){for(var s of e.childElements())switch(s.localName){case"accent":t.accentuated=1;break;case"strong-accent":t.accentuated=2;break;case"staccato":t.isStaccato=!0;break;case"tenuto":t.accentuated=3}}_parseTechnical(e,t,s){var i,a=[];for(i of e.childElements())switch(i.localName){case"up-bow":s.pickStroke=1;break;case"down-bow":s.pickStroke=2;break;case"harmonic":break;case"fingering":t&&(t.leftHandFinger=this._parseFingering(i));break;case"pluck":t&&(t.rightHandFinger=this._parseFingering(i));break;case"fret":t&&(t.fret=Number.parseInt(i.innerText,10));break;case"string":t&&(t.string=s.voice.bar.staff.tuning.length-Number.parseInt(i.innerText,10)+1);break;case"hammer-on":case"pull-off":t&&(t.isHammerPullOrigin=!0);break;case"bend":a.push(i);break;case"tap":s.tap=!0;break;case"smear":t&&(t.vibrato=1);break;case"golpe":switch(i.getAttribute("placement","above")){case"above":s.golpe=2;break;case"below":s.golpe=1}}t&&0<a.length&&this._parseBends(a,t)}_parseBends(e,t){let s=w.MaxPosition/e.length,i=0,a=0,r=!0;for(var n of e){var o=n.findChildElement("bend-alter");o&&(o=Math.round(2*Math.abs(Number.parseFloat(o.innerText))),n.findChildElement("pre-bend")?r?(i+=o,t.addBendPoint(new w(a,i)),a+=s,t.addBendPoint(new w(a,i)),r=!1):a+=s:r=(n.findChildElement("release")?(r&&(i+=o),t.addBendPoint(new w(a,i)),a+=s,i-=o):(t.addBendPoint(new w(a,i)),i+=o,a+=s),t.addBendPoint(new w(a,i)),!1))}}_parseFingering(e){switch(e.innerText){case"0":return-1;case"1":case"p":case"t":return 0;case"2":case"i":return 1;case"3":case"m":return 2;case"4":case"a":return 3;case"5":case"c":return 4}return-2}_parseOrnaments(e,t){let s=-1;for(var i of e.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2"),10),t.isStringed?t.trillValue=t.stringTuning+s:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+s);break;case"turn":t.ornament=2;break;case"inverted-turn":t.ornament=1;break;case"wavy-line":0<s?"start"===i.getAttribute("type")&&(this._currentTrillStep=s):0<this._currentTrillStep?"stop"===i.getAttribute("type")?this._currentTrillStep=-1:t.isStringed?t.trillValue=t.stringTuning+this._currentTrillStep:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+this._currentTrillStep):t.vibrato=1;break;case"mordent":t.ornament=4;break;case"inverted-mordent":t.ornament=3;break;case"tremolo":switch(i.innerText){case"1":t.beat.tremoloSpeed=8;break;case"2":t.beat.tremoloSpeed=16;break;case"3":t.beat.tremoloSpeed=32}}}_parseSlide(e,t){var s,i=e.getAttribute("type"),a=e.getAttribute("number","1"),r=this._getStaffContext(t.beat.voice.bar.staff);switch(i){case"start":r.slideOrigins.set(a,t);break;case"stop":r.slideOrigins.has(a)&&((((s=r.slideOrigins.get(a)).slideTarget=t).slideOrigin=s).slideOutType=1)}}_parseTied(t,s,e){var i=t.getAttribute("type"),t=t.getAttribute("number",""),a=this._getStaffContext(e);if("start"===i)t&&(a.tieStartIds.has(t)&&(e=a.tieStartIds.get(t),a.tieStarts.delete(e)),a.tieStartIds.set(t,s)),a.tieStarts.add(s);else if("stop"===i&&!s.isTieDestination){let e=null;if(t){if(!a.tieStartIds.has(t))return;e=a.tieStartIds.get(t),a.tieStartIds.delete(t),a.tieStarts.delete(s)}else{var r,n=this._calculatePitchedNoteValue(s);for(r of a.tieStarts)if(this._calculatePitchedNoteValue(r)===n){e=r,a.tieStarts.delete(e);break}}e&&(s.isTieDestination=!0,s.tieOrigin=e)}}_parseStem(e){switch(e.innerText){case"down":return 1;case"up":return 0;default:return null}}_parseAccidental(e,t){switch(e.innerText){case"sharp":t.accidentalMode=3;break;case"natural":t.accidentalMode=2;break;case"flat":t.accidentalMode=5;break;case"double-sharp":t.accidentalMode=4;break;case"flat-flat":t.accidentalMode=6}}_calculatePitchedNoteValue(e){return 12*e.octave+e.tone}_parseDuration(e){return this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(e.innerText))}_parseUnpitched(e,t){let s="",i=0;for(var a of e.childElements())switch(a.localName){case"display-step":s=a.innerText;break;case"display-octave":i=Number.parseInt(a.innerText,10)+1}var r,e=new dt;return""===s?(e.octave=0,e.tone=0):(r=12*i+(F.getToneForText(s)?.noteValue??0),e.octave=r/12|0,e.tone=r-12*e.octave),e}_parsePitch(e){let t="",s=0,i=0;for(var a of e.childElements())switch(a.localName){case"step":t=a.innerText;break;case"alter":s=Number.parseFloat(a.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(a.innerText,10)+1}s|=0;var e=12*i+(F.getToneForText(t)?.noteValue??0)+s,r=new dt;return r.octave=e/12|0,r.tone=e-12*r.octave,r}_applyNoteHead(e,t,s,i,a,r,n){if(void 0===s)switch(t){case-4:case-2:e.style.noteHead=i;break;case 1:e.style.noteHead=a;break;case 2:e.style.noteHead=r;break;default:e.style.noteHead=n}else if(!0===s)e.style.noteHead=n;else switch(t){case-4:case-2:e.style.noteHead=i;break;case 1:e.style.noteHead=a;break;default:e.style.noteHead=r}}},Fi=(Ci._b4Value=71,Ci._allDurations=[256,128,64,32,16,8,4,2,1,-2,-4],Ci._allDurationTicks=Ci._allDurations.map(e=>N.toTicks(e)),Ci),Di=class{constructor(e){this._writePosition=0,this._readPosition=0,this.count=0,this._buffer=new Float32Array(e)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(e,t,s){let i=0;s>this._buffer.length-this.count&&(s=this._buffer.length-this.count);var a=Math.min(this._buffer.length-this._writePosition,s);return this._buffer.set(e.subarray(t,t+a),this._writePosition),this._writePosition+=a,this._writePosition%=this._buffer.length,(i+=a)<s&&(this._buffer.set(e.subarray(t+i,t+i+s-i),this._writePosition),this._writePosition+=s-i,i=s),this.count+=i,i}read(e,t,s){s>this.count&&(s=this.count);let i=0,a=Math.min(this._buffer.length-this._readPosition,s);return e.set(this._buffer.subarray(this._readPosition,this._readPosition+a),t),i+=a,this._readPosition+=a,this._readPosition%=this._buffer.length,i<s&&(e.set(this._buffer.subarray(this._readPosition,this._readPosition+s-i),t+i),this._readPosition+=s-i,i=s),this.count-=i,i}},Ii=class Ii{constructor(){this.ready=new rs,this.samplesPlayed=new g,this.sampleRequest=new rs}get sampleRate(){return Ii.preferredSampleRate}open(){M.debug("AlphaSynth","Initializing synth worker"),this._worker=E.globalThis,this._worker.addEventListener("message",this._handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}_handleMessage(e){var t=e.data;switch(t.cmd){case Ii.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case Ii.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(t.samples)}}addSamples(e){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:E.prepareForPostMessage(e)})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}},Ai=(Ii.CmdOutputPrefix="alphaSynth.output.",Ii.CmdOutputAddSamples=Ii.CmdOutputPrefix+"addSamples",Ii.CmdOutputPlay=Ii.CmdOutputPrefix+"play",Ii.CmdOutputPause=Ii.CmdOutputPrefix+"pause",Ii.CmdOutputResetSamples=Ii.CmdOutputPrefix+"resetSamples",Ii.CmdOutputStop=Ii.CmdOutputPrefix+"stop",Ii.CmdOutputSampleRequest=Ii.CmdOutputPrefix+"sampleRequest",Ii.CmdOutputSamplesPlayed=Ii.CmdOutputPrefix+"samplesPlayed",Ii.preferredSampleRate=0,Ii),Ri=class{constructor(e){this.isDefault=!1,this.device=e}get deviceId(){return this.device.deviceId}get label(){return this.device.label}},Oi=class Oi{static findKnownDevice(t){return Oi._knownDevices.find(e=>e.deviceId===t)}static createAudioContext(){if("AudioContext"in E.globalThis)return new AudioContext;if("webkitAudioContext"in E.globalThis)return new webkitAudioContext;throw new b(0,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in Oi.createAudioContext()||(M.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await Oi.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){M.warning("WebAudio","Output device permission rejected",e)}let e=await navigator.mediaDevices.enumerateDevices(),t="",s="",i=new Map;for(var n of e)"audiooutput"===n.kind&&(i.set(n.groupId,new Ri(n)),"default"===n.deviceId||""===n.deviceId)&&(t=n.groupId,s=n.deviceId);let a=Array.from(i.values()),r=a.find(e=>e.deviceId===s);return(r=!(r=r||a.find(e=>e.device.groupId===t))&&0<a.length?a[0]:r)&&(r.isDefault=!0),Oi._knownDevices=a}catch(e){return M.error("WebAudio","Failed to enumerate output devices",e),[]}}},Vi=(Oi._knownDevices=[],Oi),Wi=class Wi{constructor(){this.context=null,this.buffer=null,this.source=null,this.ready=new rs,this.samplesPlayed=new g,this.sampleRequest=new rs}get sampleRate(){return this.context?this.context.sampleRate:Wi.PreferredSampleRate}activate(e){this.context||(this.context=Vi.createAudioContext()),"suspended"!==this.context.state&&"interrupted"!==this.context.state||(M.debug("WebAudio","Audio Context is suspended, trying resume"),this.context.resume().then(()=>{M.debug("WebAudio",`Audio Context resume success: state=${this.context?.state}, sampleRate:`+this.context?.sampleRate),e&&e()},e=>{M.warning("WebAudio",`Audio Context resume failed: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}, reason=`+e)}))}_patchIosSampleRate(){var e,t,s=navigator.userAgent;-1===s.indexOf("iPhone")&&-1===s.indexOf("iPad")||(e=(s=Vi.createAudioContext()).createBuffer(1,1,Wi.PreferredSampleRate),(t=s.createBufferSource()).buffer=e,t.connect(s.destination),t.start(0),t.disconnect(0),s.close())}open(e){this._patchIosSampleRate(),this.context=Vi.createAudioContext(),"suspended"===this.context.state&&this._registerResumeHandler()}_registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this._unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}_unregisterResumeHandler(){var e=this._resumeHandler;e&&(document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("click",e,!1))}play(){var e=this.context;this.activate(),this.buffer=e.createBuffer(2,Wi.BufferSize,e.sampleRate),this.source=e.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0}pause(){this.source&&(this.source.stop(0),this.source.disconnect()),this.source=null}destroy(){this.pause(),this.context?.close(),this.context=null,this._unregisterResumeHandler()}onSamplesPlayed(e){this.samplesPlayed.trigger(e)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return Vi.enumerateOutputDevices()}async setOutputDevice(e){await Vi.checkSinkIdSupport()&&(e?await this.context.setSinkId(e.deviceId):await this.context.setSinkId(""))}async getOutputDevice(){if(!await Vi.checkSinkIdSupport())return null;let t=this.context.sinkId;var e;return"string"!=typeof t||""===t||"default"===t?null:Vi.findKnownDevice(t)||(e=await this.enumerateOutputDevices()).find(e=>e.deviceId===t)||(M.warning("WebAudio","Could not find output device in device list",t,e),null)}},Hi=(Wi.BufferSize=4096,Wi.PreferredSampleRate=44100,Wi),Gi=class Gi{static init(){var s;Gi._isRegistered||(Gi._isRegistered=!0,registerProcessor("alphatab",((s=class extends AudioWorkletProcessor{constructor(e){super(e),this._outputBuffer=new Float32Array(0),this._bufferCount=0,this._requestedBufferCount=0,this._isStopped=!1,M.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(e.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/s.BufferSize),this._circularBuffer=new Di(s.BufferSize*this._bufferCount),this.port.onmessage=this._handleMessage.bind(this)}_handleMessage(e){var t=e.data;switch(t.cmd){case Ai.CmdOutputAddSamples:var s=t.samples;this._circularBuffer.write(s,0,s.length),this._requestedBufferCount--;break;case Ai.CmdOutputResetSamples:this._circularBuffer.clear();break;case Ai.CmdOutputStop:this._isStopped=!0}}process(e,t,s){if(1!==t.length&&2!==t[0].length)return!1;var i=t[0][0],a=t[0][1];if(!i||!a)return!0;let r=i.length+a.length,n=this._outputBuffer,o=(n.length!==r&&(n=new Float32Array(r),this._outputBuffer=n),this._circularBuffer.read(n,0,Math.min(n.length,this._circularBuffer.count))),h=0,l=Math.min(i.length,o);for(let e=0;e<l;e++)i[e]=n[h++],a[e]=n[h++];if(o<i.length)for(let e=o;e<i.length;e++)i[e]=0,a[e]=0;return this.port.postMessage({cmd:Ai.CmdOutputSamplesPlayed,samples:o/_.AudioChannels}),this._requestBuffers(),0<this._circularBuffer.count||!this._isStopped}_requestBuffers(){var t=this._bufferCount/2|0,e=t*s.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*s.BufferSize<e){for(let e=0;e<t;e++)this.port.postMessage({cmd:Ai.CmdOutputSampleRequest});this._requestedBufferCount+=t}}}).BufferSize=4096,s)))}},zi=(Gi._isRegistered=!1,Gi),Ui=class extends Hi{constructor(e){super(),this._worklet=null,this._bufferTimeInMilliseconds=0,this._settings=e}open(e){super.open(e),this._bufferTimeInMilliseconds=e,this.onReady()}play(){super.play();let e=this.context;E.createAudioWorklet(e,this._settings).then(()=>{this._worklet=new AudioWorkletNode(e,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this._handleMessage.bind(this),this.source.connect(this._worklet),this.source.start(0),this._worklet.connect(e.destination)},e=>{M.error("WebAudio","Audio Worklet creation failed: reason="+e)})}_handleMessage(e){var t=e.data;switch(t.cmd){case Ai.CmdOutputSamplesPlayed:this.onSamplesPlayed(t.samples);break;case Ai.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this._worklet&&(this._worklet.port.postMessage({cmd:Ai.CmdOutputStop}),this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(e){this._worklet?.port.postMessage({cmd:Ai.CmdOutputAddSamples,samples:E.prepareForPostMessage(e)})}resetSamples(){this._worklet?.port.postMessage({cmd:Ai.CmdOutputResetSamples})}},Yi=((st={})[st.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",st[st.MultiTrack=1]="MultiTrack",st),Xi=class{constructor(){this.events=[]}addEvent(t){if(0===this.events.length||t.tick>=this.events[this.events.length-1].tick)this.events.push(t);else{let e=this.events.length;for(;0<e&&this.events[e-1].tick>t.tick;)e--;this.events.splice(e,0,t)}}writeTo(e){let t=Bs.empty(),s=0;for(var i of this.events){var a=i.tick-s;Ji.writeVariableInt(t,a),i.writeTo(t),s=i.tick}var r=new Uint8Array([77,84,114,107]),r=(e.write(r,0,r.length),t.toArray());f.writeInt32BE(e,r.length),e.write(r,0,r.length)}},Ji=class{constructor(){this.format=0,this.division=N.QuarterTime,this.tracks=[]}get events(){if(1===this.tracks.length)return this.tracks[0].events;var e,t=[];for(e of this.tracks)this.events.push(...e.events);return t.sort((e,t)=>e.tick-t.tick),t}_ensureTracks(e){for(;this.tracks.length<e;)this.tracks.push(new Xi)}addEvent(e){(0===this.format?(this._ensureTracks(1),this.tracks[0]):(this._ensureTracks(e.track+1),this.tracks[e.track])).addEvent(e)}toBinary(){var e=Bs.empty();return this.writeTo(e),e.toArray()}writeTo(e){var t,s=new Uint8Array([77,84,104,100]);e.write(s,0,s.length),f.writeInt32BE(e,6),f.writeInt16BE(e,this.format),f.writeInt16BE(e,this.tracks.length),f.writeInt16BE(e,this.division);for(t of this.tracks)t.writeTo(e)}static writeVariableInt(e,t){let s=new Uint8Array(4),i=0;for(;s[i++]=127&t,0<(t>>=7););for(;0<i;)0<--i?e.writeByte(128|s[i]):e.writeByte(s[i])}},qi=((r={})[r.TimeSignature=88]="TimeSignature",r[r.NoteOn=128]="NoteOn",r[r.NoteOff=144]="NoteOff",r[r.ControlChange=176]="ControlChange",r[r.ProgramChange=192]="ProgramChange",r[r.TempoChange=81]="TempoChange",r[r.PitchBend=224]="PitchBend",r[r.PerNotePitchBend=96]="PerNotePitchBend",r[r.EndOfTrack=47]="EndOfTrack",r[r.AlphaTabRest=241]="AlphaTabRest",r[r.AlphaTabMetronome=242]="AlphaTabMetronome",r[r.SystemExclusive=240]="SystemExclusive",r[r.SystemExclusive2=247]="SystemExclusive2",r[r.Meta=255]="Meta",r),ji=class{constructor(e,t,s){this.track=e,this.tick=t,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}},$i=class extends ji{constructor(e,t,s,i,a,r){super(e,t,88),this.track=e,this.tick=t,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=a,this.thirtySecondNodesInQuarter=r}writeTo(e){e.writeByte(255),e.writeByte(88),Ji.writeVariableInt(e,4),e.writeByte(255&this.numerator),e.writeByte(255&this.denominatorIndex),e.writeByte(255&this.midiClocksPerMetronomeClick),e.writeByte(255&this.thirtySecondNodesInQuarter)}},Ki=class Ki extends ji{writeTo(e){e.writeByte(240);var t=Bs.withCapacity(16);t.writeByte(Ki.AlphaTabManufacturerId),this.writeEventData(t),t.writeByte(247),Ji.writeVariableInt(e,t.length),t.copyTo(e)}},Qi=(Ki.AlphaTabManufacturerId=125,Ki.MetronomeEventId=0,Ki.RestEventId=1,Ki),Zi=class extends Qi{constructor(e,t,s,i,a){super(e,t,242),this.isMetronome=!0,this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=a,this.metronomeDurationInTicks=i}writeEventData(e){e.writeByte(Qi.MetronomeEventId),e.writeByte(this.metronomeNumerator),f.writeInt32LE(e,this.metronomeDurationInTicks),f.writeInt32LE(e,this.metronomeDurationInMilliseconds)}},ea=class extends Qi{constructor(e,t,s){super(e,t,241),this.channel=s}writeEventData(e){e.writeByte(Qi.RestEventId),e.writeByte(this.channel)}},ta=class extends ji{constructor(e,t,s,i,a,r){super(e,t,s),this.channel=i,this.noteKey=a,this.noteVelocity=r}get data1(){return this.noteKey}get data2(){return this.noteVelocity}},sa=class extends ta{constructor(e,t,s,i,a){super(e,t,128,s,i,a)}writeTo(e){e.writeByte(15&this.channel|144),e.writeByte(255&this.noteKey),e.writeByte(255&this.noteVelocity)}},ia=class extends ta{constructor(e,t,s,i,a){super(e,t,144,s,i,a)}writeTo(e){e.writeByte(15&this.channel|128),e.writeByte(255&this.noteKey),e.writeByte(255&this.noteVelocity)}},aa=class extends ji{constructor(e,t,s,i,a){super(e,t,176),this.channel=s,this.controller=i,this.value=a}writeTo(e){e.writeByte(15&this.channel|176),e.writeByte(255&this.controller),e.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}},ra=class extends ji{constructor(e,t,s,i){super(e,t,192),this.channel=s,this.program=i}writeTo(e){e.writeByte(15&this.channel|192),e.writeByte(255&this.program)}get data1(){return this.program}},na=class extends ji{constructor(e,t){super(0,e,81),this.beatsPerMinute=0,this.microSecondsPerQuarterNote=t}get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(e){this.beatsPerMinute=6e7/e}writeTo(e){e.writeByte(255),e.writeByte(81),e.writeByte(3),e.writeByte(this.microSecondsPerQuarterNote>>16&255),e.writeByte(this.microSecondsPerQuarterNote>>8&255),e.writeByte(255&this.microSecondsPerQuarterNote)}},oa=class extends ji{constructor(e,t,s,i){super(e,t,224),this.channel=s,this.value=i}writeTo(e){e.writeByte(15&this.channel|224),e.writeByte(127&this.value),e.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}},ha=class extends ji{constructor(e,t,s,i,a){super(e,t,96),this.channel=s,this.noteKey=i,this.value=a}writeTo(e){throw new b(0,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}},la=class extends ji{constructor(e,t){super(e,t,47)}writeTo(e){e.writeByte(255),e.writeByte(47),e.writeByte(0)}},da=class Ru{constructor(e,t){this.time=0,this.eventIndex=e,this.event=t,this.isMetronome=242===this.event.type}static newMetronomeEvent(e,t,s,i,a){t=new Zi(0,t,s,i,a);return new Ru(e,t)}},ca=class{constructor(){this.masterBarIndex=0,this.masterBarOccurence=0,this.synthBpm=0,this.synthTime=0,this.synthTick=0,this.syncTime=0,this.syncBpm=0}updateSyncBpm(e,t){e=(e-this.synthTime)/(t-this.syncTime)*this.synthBpm;this.syncBpm=e}},ua=class{constructor(e,t,s){this.bpm=e,this.ticks=t,this.time=s}},pa=class{constructor(){this.tempoChanges=[],this.tempoChangeIndex=0,this.syncPoints=[],this.firstProgramEventPerChannel=new Map,this.firstTimeSignatureNumerator=0,this.firstTimeSignatureDenominator=0,this.synthData=[],this.division=N.QuarterTime,this.eventIndex=0,this.currentTime=0,this.syncPointIndex=0,this.playbackRange=null,this.playbackRangeStartTime=0,this.playbackRangeEndTime=0,this.endTick=0,this.endTime=0,this.currentTempo=0,this.syncPointTempo=0}},ma=class{constructor(e){this._oneTimeState=null,this._countInState=null,this.isLooping=!1,this.playbackSpeed=1,this.instrumentPrograms=new Set,this.percussionKeys=new Set,this._synthesizer=e,this._mainState=new pa,this._currentState=this._mainState}get isPlayingMain(){return this._currentState===this._mainState}get isPlayingOneTimeMidi(){return this._currentState===this._oneTimeState}get isPlayingCountIn(){return this._currentState===this._countInState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(e){(this._mainState.playbackRange=e)&&(this._mainState.playbackRangeStartTime=this._tickPositionToTimePositionWithSpeed(this._mainState,e.startTick,1),this._mainState.playbackRangeEndTime=this._tickPositionToTimePositionWithSpeed(this._mainState,e.endTick,1))}get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}get currentTempo(){return this._currentState.currentTempo}get modifiedTempo(){return this._currentState.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this._currentState.syncPointTempo}get currentSyncPoints(){return this._currentState.syncPoints}mainSeek(e){var t;e*=this.playbackSpeed,this.mainPlaybackRange&&(e<this._mainState.playbackRangeStartTime?e=this._mainState.playbackRangeStartTime:e>this._mainState.playbackRangeEndTime&&(e=this._mainState.playbackRangeEndTime)),e>this._mainState.currentTime?this._mainSilentProcess(e-this._mainState.currentTime):e<this._mainState.currentTime&&(this._mainState.currentTime=0,this._mainState.eventIndex=0,this._mainState.syncPointIndex=0,this._mainState.tempoChangeIndex=0,this._mainState.currentTempo=this._mainState.tempoChanges[0].bpm,this._mainState.syncPointTempo=0<this._mainState.syncPoints.length?this._mainState.syncPoints[0].syncBpm:this._mainState.currentTempo,this.isPlayingMain&&(t=this._synthesizer.metronomeVolume,this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(t)),this._mainSilentProcess(e))}_mainSilentProcess(e){if(!(e<=0)){var t=Date.now(),s=this._mainState.currentTime+e;if(this.isPlayingMain)for(;this._mainState.currentTime<s;)this._fillMidiEventQueueLimited(s-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(_.MicroBufferSize);this._mainState.currentTime=s;e=Date.now()-t;M.debug("Sequencer",`Silent seek finished in ${e}ms (main)`)}}loadOneTimeMidi(e){this._oneTimeState=this.createStateFromFile(e),this._currentState=this._oneTimeState}loadMidi(e){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this._mainState=this.createStateFromFile(e),this._currentState=this._mainState}createStateFromFile(e){var t,s=new pa;this.percussionKeys.add(_.MetronomeKey),s.tempoChanges=[],s.division=e.division,s.eventIndex=0,s.currentTime=0,s.synthData=[];let i=120,a=0,r=0,n=0,o=0,h=0,l=0,d=0,c=0;for(t of e.events){var u,p=new da(s.synthData.length,t),m=(s.synthData.push(p),t.tick-c);if(a+=m,r+=m*(6e4/(i*e.division)),p.time=r,c=t.tick,0<o)for(;l<a;){var g=da.newMetronomeEvent(s.synthData.length,l,Math.floor(l/o)%n,o,h);s.synthData.push(g),g.time=d,l+=o,d+=h}81===t.type?(i=t.beatsPerMinute,s.tempoChanges.push(new ua(i,a,r)),h=o*(6e4/(i*e.division))):88===t.type?(m=t,u=Math.pow(2,m.denominatorIndex),n=m.numerator,o=s.division*(4/u)|0,h=o*(6e4/(i*e.division)),0===s.firstTimeSignatureDenominator&&(s.firstTimeSignatureNumerator=m.numerator,s.firstTimeSignatureDenominator=u)):192===t.type?(u=(m=t).channel,s.firstProgramEventPerChannel.has(u)||s.firstProgramEventPerChannel.set(u,p),u!==_.PercussionChannel&&this.instrumentPrograms.add(m.program)):128===t.type&&(p=t).channel===_.PercussionChannel&&this.percussionKeys.add(p.noteKey)}return s.currentTempo=0<s.tempoChanges.length?s.tempoChanges[0].bpm:i,s.syncPointTempo=s.currentTempo,s.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),s.endTime=r,s.endTick=a,s}fillMidiEventQueue(){return this._fillMidiEventQueueLimited(-1)}fillMidiEventQueueToEndTime(e){for(;this._mainState.currentTime<e;)this._fillMidiEventQueueLimited(e-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(_.MicroBufferSize);let t=!1;for(this._currentState.currentTime=e;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime;){var s=this._currentState.synthData[this._currentState.eventIndex];this._synthesizer.dispatchEvent(s),this._currentState.eventIndex++,t=!0}return t}_fillMidiEventQueueLimited(e){let t=_.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,s=this._internalEndTime,i=(0<e&&(e<t&&(t=e),s=Math.min(this._internalEndTime,this._currentState.currentTime+e)),!1);for(this._currentState.currentTime+=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<s;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(e){return this._tickPositionToTimePositionWithSpeed(this._mainState,e,this.playbackSpeed)}mainUpdateSyncPoints(d){var c,u,p,m=this._mainState;if(d.sort((e,t)=>e.synthTick-t.synthTick),m.syncPoints=[],0<=d.length){let n=120,o=0,h=0,l=0;for(let r=0;r<d.length;r++){let e=d[r],t=0,s,i,a;for(a=0===r?(s=n,i=0):(c=d[r-1],s=c.syncBpm,i=c.syncTime,c.synthTick);l<m.tempoChanges.length&&m.tempoChanges[l].ticks<=e.synthTick;)0<(t=m.tempoChanges[l].ticks-o)&&(o+=t,h+=t*(6e4/(n*m.division)),u=(e.syncTime-i)/(e.synthTick-a),u=(o-a)*u+i,(p=new ca).synthTick=o,p.synthBpm=n,p.synthTime=h,p.syncTime=u,p.syncBpm=s),n=m.tempoChanges[l].bpm,l++;t=e.synthTick-o,o+=t,h+=t*(6e4/(n*m.division)),m.syncPoints.push(e)}}m.syncPointIndex=0,m.syncPointTempo=0<m.syncPoints.length?m.syncPoints[0].syncBpm:m.currentTempo}currentTimePositionToTickPosition(e){var t=this._currentState;if(0===t.tempoChanges.length)return 0;e*=this.playbackSpeed,this._updateCurrentTempo(t,e);var s=t.tempoChanges[t.tempoChangeIndex],e=(e-s.time)/(6e4/(s.bpm*t.division))|0;return s.ticks+e+1}currentUpdateCurrentTempo(e){this._updateCurrentTempo(this._mainState,e*this.playbackSpeed)}_updateCurrentTempo(e,t){let s=e.tempoChangeIndex;for(t<e.tempoChanges[s].time&&(s=0);s+1<e.tempoChanges.length&&e.tempoChanges[s+1].time<=t;)s++;s!==e.tempoChangeIndex&&(e.tempoChangeIndex=s,e.currentTempo=e.tempoChanges[e.tempoChangeIndex].bpm,0===e.syncPoints.length)&&(e.syncPointTempo=e.currentTempo)}currentUpdateSyncPoints(e){this._updateSyncPoints(this._mainState,e)}_updateSyncPoints(t,s){var i=t.syncPoints;if(0<i.length){let e=Math.min(t.syncPointIndex,i.length-1);for(s<i[e].syncTime&&(e=0);e+1<i.length&&i[e+1].syncTime<=s;)e++;e!==t.syncPointIndex&&(t.syncPointIndex=e,t.syncPointTempo=i[e].syncBpm)}else t.syncPointTempo=t.currentTempo}mainTimePositionFromBackingTrack(e,t){var s=this._mainState,i=s.syncPoints;if(e<0||0===i.length)return e;this._updateSyncPoints(this._mainState,e);let a=Math.min(s.syncPointIndex,i.length-1),r=i[a],n=e-r.syncTime,o;return o=a+1<i.length?(i=n/((e=i[a+1]).syncTime-r.syncTime),(e.synthTime-r.synthTime)*i):(e=n/(t-r.syncTime),(s.endTime-r.synthTime)*e),(r.synthTime+o)/this.playbackSpeed}mainTimePositionToBackingTrack(e,t){var s,i,a=this._mainState,r=a.syncPoints;if(e<0||0===r.length)return e;e*=this.playbackSpeed;let n=Math.min(a.syncPointIndex,r.length-1);for(e<r[n].synthTime&&(n=0);n+1<r.length&&r[n+1].synthTime<=e;)n++;let o=r[n],h=e-o.synthTime,l;return l=n+1<r.length?(i=h/((s=r[n+1]).synthTime-o.synthTime),s=s.syncTime-o.syncTime,o.syncTime+s*i):(s=h/(a.endTime-o.synthTime),i=t-o.syncTime,o.syncTime+i*s)}_tickPositionToTimePositionWithSpeed(e,t,s){let i=0,a=120,r=0;for(var n of e.tempoChanges){if(t<n.ticks)break;i=n.time,a=n.bpm,r=n.ticks}return t-=r,(i+=t*(6e4/(a*e.division)))/s}get _internalEndTime(){return this.isPlayingMain&&this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this._internalEndTime}stop(){this.isPlayingMain&&this.mainPlaybackRange?this._currentState.currentTime=this.mainPlaybackRange.startTick:this._currentState.currentTime=0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){var t=new pa;t.division=this._mainState.division;let e=120,s=4,i=4,a=(i=0===this._mainState.eventIndex?(e=this._mainState.tempoChanges[0].bpm,s=this._mainState.firstTimeSignatureNumerator,this._mainState.firstTimeSignatureDenominator):(e=this._synthesizer.currentTempo,s=this._synthesizer.timeSignatureNumerator,this._synthesizer.timeSignatureDenominator),t.tempoChanges.push(new ua(e,0,0)),t.division*(4/i)|0),r=a*(6e4/(e*this._mainState.division)),n=0,o=0;for(let e=0;e<s;e++){var h=da.newMetronomeEvent(t.synthData.length,n,e,a,r);t.synthData.push(h),h.time=o,n+=a,o+=r}t.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),t.endTime=o,t.endTick=n,t.currentTempo=e,t.syncPointTempo=e,this._countInState=t}},ga=((kt={})[kt.Paused=0]="Paused",kt[kt.Playing=1]="Playing",kt),fa=class{constructor(e,t){this.state=e,this.stopped=t}},ba=class{constructor(e,t,s,i,a,r,n){this.originalTempo=0,this.modifiedTempo=0,this.currentTime=e,this.endTime=t,this.currentTick=s,this.endTick=i,this.isSeek=a,this.originalTempo=r,this.modifiedTempo=n}},ya=class ya{constructor(){this.id="",this.size=0}static load(e,t,s){if(e&&ya.HeaderSize>e.size||s.position+ya.HeaderSize>=s.length||(t.id=f.read8BitStringLength(s,4),t.id.charCodeAt(0)<=32)||122<=t.id.charCodeAt(0)||(t.size=f.readUInt32LE(s),e&&ya.HeaderSize+t.size>e.size))return!1;e&&(e.size-=ya.HeaderSize+t.size);var i="RIFF"===t.id;return!(i&&e||(i||"LIST"===t.id)&&(t.id=f.read8BitStringLength(s,4),t.id.charCodeAt(0)<=32||122<=t.id.charCodeAt(0)||(t.size-=4,0)))}},_a=(ya.HeaderSize=8,ya),Sa=class{constructor(e,t,s,i){this.packetData=e,this.isBeginningOfStream=t,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(e){var t=this.packetData,s=new Uint8Array(t.length+e.length);s.set(t,0),s.set(e,t.length)}},va=class{constructor(e){this._readable=e}read(){for(var e=[];this._findAndReadPage(e););return e}_findAndReadPage(e){return!!this._seekPageHeader()&&this._readPage(e)}_seekPageHeader(){for(let e=0;e<65536;e++){if(1399285583===f.readInt32LE(this._readable))return!0;this._readable.position-=3}return!1}_readPage(t){var e=this._readable.readByte();if(-1===e||0!==e)return!1;var s=this._readable.readByte(),i=f.readInt64LE(this._readable),a=(this._readable.skip(4),this._readable.skip(4),this._readable.skip(4),this._readable.readByte());if(-1===a)return!1;let r=[],n=0;for(let e=0;e<a;e++){var o=this._readable.readByte();n===r.length&&r.push(0),r[n]+=o,o<255&&n++}for(let e=0;e<r.length;e++){var h=new Uint8Array(r[e]);if(this._readable.read(h,0,h.length)!==h.length)return!1;if(0!=(1&s)){if(0===t.length)throw new b(1,"OGG: Continuation page without any previous packets");t[t.length-1].addData(h)}else{h=new Sa(h,0!=(2&s)&&0===e,0!=(4&s)&&e===r.length-1,i);t.push(h)}}return!0}},ka=class{constructor(){this.audioChannels=0,this.audioSampleRate=0,this.samples=new Float32Array(0),this.bitrateMaximum=0,this.bitrateNominal=0,this.bitrateMinimum=0,this.blocksize0=0,this.blocksize1=0}},wa=class{constructor(){this.value=0,this.bitsRead=0}},Ta=class Ta{constructor(e){this._bitBucket=0n,this._bitCount=0n,this._overflowBits=0n,this._source=e}readByte(){return this.readBits(Ta._byteSize)}readBit(){return 1===this.readBits(1)}readBytes(t){var s=new Uint8Array(t);for(let e=0;e<t;e++)s[e]=255&this.readByte();return s}readBits(e){var t;return 0===e?0:(t=this.tryPeekBits(e),this.skipBits(e),t.value)}tryPeekBits(e){if(e<0||32<e)throw new b(0,"IO: Cannot read more than 32 bits in one go");if(0===e)return new wa;for(var t=new wa;this._bitCount<e;){var s=BigInt(this._source.readByte());if(-1n===s)return t.bitsRead=Number(this._bitCount),t.value=Number(this._bitBucket),this._bitBucket=0n,this._bitCount=0n,t;this._bitBucket=(0xffn&s)<<this._bitCount|this._bitBucket,this._bitCount+=8n,32<this._bitCount&&(this._overflowBits=s>>40n-this._bitCount&0xffn)}let i=this._bitBucket;return e<64&&(i&=(1n<<BigInt(e))-1n),t.value=Number(i),t.bitsRead=e,t}skipBits(e){let t=BigInt(e);if(0!==e)if(this._bitCount>t){var s;this._bitBucket=31<e?0n:this._bitBucket>>t,32<this._bitCount&&(s=this._bitCount-32n,this._bitBucket=this._bitBucket|this._overflowBits<<this._bitCount-t-s,e<s)&&(this._overflowBits=this._overflowBits>>t&0xffn),this._bitCount-=t}else if(this._bitCount===t)this._bitBucket=0n,this._bitCount=0n;else{for(t-=this._bitCount,this._bitCount=0n,this._bitBucket=0n;8<t;){if(-1===this._source.readByte()){t=0n;break}t-=8n}0<t&&-1n!==(e=BigInt(this._source.readByte()))&&(this._bitBucket=e>>t,this._bitCount=8n-t)}}},Ba=(Ta._byteSize=8,Ta),xa=class{constructor(){this.codebooks=[],this.timeDomainTransforms=[],this.floors=[],this.residues=[],this.mappings=[],this.modes=[]}},Pa=class{static ilog(e){let t=0;for(;0<e;)++t,e>>=1;return t}static bitReverse(e,t=32){e=BigInt(e);return e=((e=((e=((e=((e=(e&BigInt(2863311530))>>1n|(e&BigInt(1431655765))<<1n)&BigInt(3435973836))>>2n|(e&BigInt(858993459))<<2n)&BigInt(4042322160))>>4n|(e&BigInt(252645135))<<4n)&BigInt(4278255360))>>8n|(e&BigInt(16711935))<<8n)>>16n|e<<16n)>>32n-BigInt(t),Number(BigInt.asUintN(32,e))}static convertFromVorbisFloat32(e){let t=BigInt(e),s=t&BigInt(2097151),i=t&BigInt(2147483648),a=(t&BigInt(2145386496))>>21n;return 0n!==i&&(s=-s),Number(s)*Math.pow(2,Number(a)-788)}},Na=class{constructor(e){this._data=e}get(e){return this._data[e]}},Ma=class{get(e){return e}},Ea=(Ma.instance=new Ma,Ma),La=class{constructor(e,t){if(this._maxBits=0,this._overflowList=null,this._prefixList=null,this._prefixBitLength=0,this.dimensions=0,this.entries=0,this.mapType=0,5653314!==e.readBits(24))throw new b(1,"Vorbis: Book header had invalid signature!");this.dimensions=e.readBits(16),this.entries=e.readBits(24),this._lengths=new Int32Array(this.entries),this._initTree(e,t),this._initLookupTable(e)}get(e,t){return this._lookupTable[e*this.dimensions+t]}decodeScalar(s){var i=s.tryPeekBits(this._prefixBitLength);if(0!==i.bitsRead){let t=this._prefixList[i.value];if(null!=t)return s.skipBits(t.length),t.value;if(i=s.tryPeekBits(this._maxBits),null!==this._overflowList)for(let e=0;e<this._overflowList.length;e++){t=this._overflowList[e];var a=i.value&t.mask;if(t.bits===a)return s.skipBits(t.length),t.value}}return-1}_initTree(i,a){let r,n=0,t;if(i.readBit()){let s=i.readBits(5)+1;for(let t=0;t<this.entries;){let e=i.readBits(Pa.ilog(this.entries-t));for(;0<=--e;)this._lengths[t++]=s;++s}n=0,r=!1,t=s}else{t=-1,r=i.readBit();for(let e=0;e<this.entries;e++)!r||i.readBit()?(this._lengths[e]=i.readBits(5)+1,++n):this._lengths[e]=-1,this._lengths[e]>t&&(t=this._lengths[e])}if(-1<(this._maxBits=t)){let e=null;r&&n>=this.entries>>2&&((e=new Int32Array(this.entries)).set(this._lengths.subarray(0,this.entries),0),r=!1);let t,s=(t=r?n:0,null),i=null;if(r?0!==t&&(e=new Int32Array(t),i=new Int32Array(t),s=new Int32Array(t)):i=new Int32Array(this.entries),!this._computeCodewords(r,i,e,this._lengths,this.entries,s))throw new b(1,"Vorbis: Failed to compute codewords");var o=null==s?Ea.instance:new Na(s);a.generateTable(o,e??this._lengths,i),this._prefixList=a.prefixTree,this._prefixBitLength=a.tableBits,this._overflowList=a.overflowList}}_computeCodewords(e,i,a,r,t,n){let o=new Uint32Array(32),h=0,l=0;for(h=0;h<t&&!(0<r[h]);++h);if(h!==t){this._addEntry(e,i,a,0,h,l++,r[h],n);for(let e=1;e<=r[h];++e)o[e]=1<<32-e;for(let s=h+1;s<t;++s){let t=r[s];if(!(t<=0)){for(;0<t&&0===o[t];)--t;if(0===t)return!1;var d=o[t];if(o[t]=0,this._addEntry(e,i,a,Pa.bitReverse(d),s,l++,r[s],n),t!==r[s])for(let e=r[s];e>t;--e)o[e]=d+(1<<32-e)}}}return!0}_addEntry(e,t,s,i,a,r,n,o){e?(t[r]=i,s[r]=n,o[r]=a):t[a]=i}_initLookupTable(s){if(this.mapType=s.readBits(4),0!==this.mapType){let a=Pa.convertFromVorbisFloat32(s.readBits(32)),r=Pa.convertFromVorbisFloat32(s.readBits(32)),t=s.readBits(4)+1,n=s.readBit(),o=this.entries*this.dimensions,h=new Float32Array(o);1===this.mapType&&(o=this._lookup1Values());var l=new Uint32Array(o);for(let e=0;e<o;e++)l[e]=s.readBits(t);if(1===this.mapType)for(let i=0;i<this.entries;i++){let t=0,s=1;for(let e=0;e<this.dimensions;e++){var d=l[i/s%o|0]*r+a+t;h[i*this.dimensions+e]=d,n&&(t=d),s*=o}}else for(let i=0;i<this.entries;i++){let t=0,s=i*this.dimensions;for(let e=0;e<this.dimensions;e++){var c=l[s]*r+a+t;h[i*this.dimensions+e]=c,n&&(t=c),++s}}this._lookupTable=h}}_lookup1Values(){let e=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(e+1,this.dimensions))<=this.entries&&++e,e}},Ca=class{constructor(){this.value=0,this.length=0,this.bits=0,this.mask=0}},Fa=class Fa{constructor(){this.tableBits=0,this.prefixTree=[],this.overflowList=null}generateTable(t,s,i){let a=new Array(s.length),r=0;for(let e=0;e<a.length;e++){var n=new Ca;n.value=t.get(e),n.length=s[e]<=0?99999:s[e],n.bits=i[e],n.mask=(1<<s[e])-1,a[e]=n,0<s[e]&&r<s[e]&&(r=s[e])}a.sort((e,t)=>{var s=e.length-t.length;return 0==s?e.bits-t.bits:s});let o=r>Fa.maxTableBits?Fa.maxTableBits:r,h=[],l=null;for(let e=0;e<a.length&&a[e].length<99999;e++){var d=a[e].length;if(o<d)for(l=[];e<a.length&&a[e].length<99999;e++)l.push(a[e]);else{var c=1<<o-d,u=a[e];for(let e=0;e<c;e++){for(var p=e<<d|u.bits;h.length<=p;)h.push(null);h[p]=u}}}for(;h.length<1<<o;)h.push(null);this.tableBits=o,this.prefixTree=h,this.overflowList=l}},Da=(Fa.maxTableBits=10,Fa),Ia=class{constructor(e){e.readBits(16)}},Aa=class{constructor(e){this.amp=0,this.forceEnergy=!1,this.forceNoEnergy=!1,this.coeff=e}get executeChannel(){return(this.forceEnergy||0<this.amp)&&!this.forceNoEnergy}},Ra=class Ou{constructor(t,e,s,i){if(this._order=t.readBits(8),this._rate=t.readBits(16),this._barkMapSize=t.readBits(16),this._ampBits=t.readBits(6),this._ampOfs=t.readBits(8),this._books=new Array(t.readBits(4)+1),this._order<1||this._rate<1||this._barkMapSize<1||0===this._books.length)throw new b(1,"Vorbis: Invalid Floor0 Data");this._ampDiv=(1<<this._ampBits)-1;for(let e=0;e<this._books.length;e++){var a=t.readBits(8);if(a<0||a>=i.length)throw new b(1,"Vorbis: Invalid Floor0 Data");a=i[a];if(0===a.mapType||a.dimensions<1)throw new b(1,"Vorbis: Invalid Floor0 Data");this._books[e]=a}this._bookBits=Pa.ilog(this._books.length),this._barkMaps=new Map([[e,this._synthesizeBarkCurve(e/2)],[s,this._synthesizeBarkCurve(s/2)]]),this._wMap=new Map([[e,this._synthesizeWDelMap(e/2)],[s,this._synthesizeWDelMap(s/2)]])}_synthesizeBarkCurve(t){var s=this._barkMapSize/Ou._toBARK(this._rate/2),i=new Int32Array(t+1);for(let e=0;e<t-1;e++)i[e]=Math.min(this._barkMapSize-1,Math.floor(Ou._toBARK(this._rate/2/t*e)*s));return i[t]=-1,i}static _toBARK(e){return 13.1*Math.atan(74e-5*e)+2.24*Math.atan(1.85e-8*e*e)+1e-4*e}_synthesizeWDelMap(t){var s=Math.PI/this._barkMapSize,i=new Float32Array(t);for(let e=0;e<t;e++)i[e]=2*Math.cos(s*e);return i}unpack(e,t,s){var i=new Aa(new Float32Array(this._order+1));if(i.amp=e.readBits(this._ampBits),0<i.amp){i.amp=i.amp/this._ampDiv*this._ampOfs;var a=e.readBits(this._bookBits);if(a>=this._books.length)return i.amp=0,i;var r=this._books[a];for(let t=0;t<this._order;){var n=r.decodeScalar(e);if(-1===n)return i.amp=0,i;for(let e=0;t<this._order&&e<r.dimensions;e++,t++)i.coeff[t]=r.get(n,e)}let s=0;for(let t=0;t<this._order;){for(let e=0;t<this._order&&e<r.dimensions;t++,e++)i.coeff[t]+=s;s=i.coeff[t-1]}}return i}apply(e,t,h){var l=e,s=t/2;if(0<l.amp){let r=this._barkMaps.get(t),n=this._wMap.get(t),o=0;for(o=0;o<this._order;o++)l.coeff[o]=2*Math.cos(l.coeff[o]);for(o=0;o<s;){let e=0,t=r[o],s=.5,i=.5,a=n[t];for(e=1;e<this._order;e+=2)i*=a-l.coeff[e-1],s*=a-l.coeff[e];for(e===this._order?(i*=a-l.coeff[e-1],s*=s*(4-a*a),i*=i):(s*=s*(2-a),i*=i*(2+a)),i=l.amp/Math.sqrt(s+i)-this._ampOfs,i=Math.exp(.11512925*i),h[o]*=i;r[++o]===t;)h[o]*=i}}else h.fill(0,0,s)}},Oa=class{constructor(){this.posts=new Int32Array(64),this.postCount=0,this.forceEnergy=!1,this.forceNoEnergy=!1}get executeChannel(){return(this.forceEnergy||0<this.postCount)&&!this.forceNoEnergy}},Va=class Va{constructor(s,i){let a=-1;this._partitionClass=new Int32Array(s.readBits(5));for(let e=0;e<this._partitionClass.length;e++)this._partitionClass[e]=s.readBits(4),this._partitionClass[e]>a&&(a=this._partitionClass[e]);++a,this._classDimensions=new Int32Array(a),this._classSubclasses=new Int32Array(a),this._classMasterbooks=new Array(a),this._classMasterBookIndex=new Int32Array(a),this._subclassBooks=new Array(a),this._subclassBookIndex=new Array(a);for(let t=0;t<a;t++){this._classDimensions[t]=s.readBits(3)+1,this._classSubclasses[t]=s.readBits(2),0<this._classSubclasses[t]&&(this._classMasterBookIndex[t]=s.readBits(8),this._classMasterbooks[t]=i[this._classMasterBookIndex[t]]),this._subclassBooks[t]=new Array(1<<this._classSubclasses[t]),this._subclassBookIndex[t]=new Int32Array(this._subclassBooks[t].length);for(let e=0;e<this._subclassBooks[t].length;e++){var r=s.readBits(8)-1;0<=r&&(this._subclassBooks[t][e]=i[r]),this._subclassBookIndex[t][e]=r}}this._multiplier=s.readBits(2),this._range=Va._rangeLookup[this._multiplier],this._yBits=Va._yBitsLookup[this._multiplier],++this._multiplier;var n,t=s.readBits(4),o=[];o.push(0),o.push(1<<t);for(let e=0;e<this._partitionClass.length;e++){var h=this._partitionClass[e];for(let e=0;e<this._classDimensions[h];e++)o.push(s.readBits(t))}this._xList=new Int32Array(o),this._lNeigh=new Int32Array(o.length),this._hNeigh=new Int32Array(o.length),this._sortIdx=new Int32Array(o.length),this._sortIdx[0]=0,this._sortIdx[1]=1;for(let t=2;t<this._lNeigh.length;t++){this._lNeigh[t]=0,this._hNeigh[t]=1,this._sortIdx[t]=t;for(let e=2;e<t;e++){var l=this._xList[e];l<this._xList[t]?l>this._xList[this._lNeigh[t]]&&(this._lNeigh[t]=e):l<this._xList[this._hNeigh[t]]&&(this._hNeigh[t]=e)}}for(let t=0;t<this._sortIdx.length-1;t++)for(let e=t+1;e<this._sortIdx.length;e++){if(this._xList[t]===this._xList[e])throw new b(1,"Vorbis: Invalid Floor1 Data");this._xList[this._sortIdx[t]]>this._xList[this._sortIdx[e]]&&(n=this._sortIdx[t],this._sortIdx[t]=this._sortIdx[e],this._sortIdx[e]=n)}}unpack(h,e,t){var l=new Oa;if(h.readBit()){let o=2;l.posts[0]=h.readBits(this._yBits),l.posts[1]=h.readBits(this._yBits);for(let n=0;n<this._partitionClass.length;n++){let t=this._partitionClass[n],s=this._classDimensions[t],i=this._classSubclasses[t],a=(1<<i)-1,r=0;if(0<i&&-1===(r=this._classMasterbooks[t].decodeScalar(h))){o=0;break}for(let e=0;e<s;e++){var d=this._subclassBooks[t][r&a];if(r>>=i,null!=d&&(l.posts[o]=d.decodeScalar(h),-1===l.posts[o])){o=0,n=this._partitionClass.length;break}++o}}l.postCount=o}return l}apply(e,t,a){var r=e,n=t/2;if(0<r.postCount){let t=this._unwrapPosts(r),s=0,i=r.posts[0]*this._multiplier;for(let e=1;e<r.postCount;e++){var o,h=this._sortIdx[e];if(t[h]&&(o=this._xList[h],h=r.posts[h]*this._multiplier,s<n&&this._renderLineMulti(s,i,Math.min(o,n),h,a),s=o,i=h),s>=n)break}s<n&&this._renderLineMulti(s,i,n,i,a)}else a.fill(0,0,n)}_unwrapPosts(h){var l=new Array(64),d=(l.fill(!1),l[0]=!0,l[1]=!0,new Int32Array(64));d[0]=h.posts[0],d[1]=h.posts[1];for(let o=2;o<h.postCount;o++){let e=this._lNeigh[o],t=this._hNeigh[o],s=this._renderPoint(this._xList[e],d[e],this._xList[t],d[t],this._xList[o]),i=h.posts[o],a=this._range-s,r=s,n;n=a<r?2*a:2*r,0!==i?(l[e]=!0,l[t]=!0,l[o]=!0,i>=n?d[o]=r<a?i-r+s:s-i+a-1:d[o]=i%2==1?s-(i+1)/2:s+i/2):(l[o]=!1,d[o]=s)}for(let e=0;e<h.postCount;e++)h.posts[e]=d[e];return l}_renderPoint(e,t,s,i,a){i-=t,s-=e,a=Math.abs(i)*(a-e)/s|0;return i<0?t-a:t+a}_renderLineMulti(e,t,s,i,a){let r=i-t,n=s-e,o=Math.abs(r),h=1-2*(r>>31&1),l=r/n|0,d=e,c=t,u=-n;for(a[e]*=Va._inverseDbTable[t],o-=Math.abs(l)*n;++d<s;)c+=l,0<=(u+=o)&&(u-=n,c+=h),a[d]*=Va._inverseDbTable[c]}},Wa=(Va._rangeLookup=[256,128,86,64],Va._yBitsLookup=[8,7,7,6],Va._inverseDbTable=new Float32Array([1.0649863e-7,1.1341951e-7,1.2079015e-7,1.2863978e-7,1.3699951e-7,1.4590251e-7,1.5538408e-7,1.6548181e-7,1.7623575e-7,1.8768855e-7,1.9988561e-7,2.128753e-7,2.2670913e-7,2.4144197e-7,2.5713223e-7,2.7384213e-7,2.9163793e-7,3.1059021e-7,3.3077411e-7,3.5226968e-7,3.7516214e-7,3.9954229e-7,4.255068e-7,4.5315863e-7,4.8260743e-7,5.1396998e-7,5.4737065e-7,5.8294187e-7,6.2082472e-7,6.6116941e-7,7.0413592e-7,7.4989464e-7,7.9862701e-7,8.505263e-7,9.0579828e-7,9.6466216e-7,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1]),Va),Ha=class{constructor(e,t,s,i){var a=e.readBits(16);switch(a){case 0:this.floor=new Ra(e,t,s,i);break;case 1:this.floor=new Wa(e,i);break;default:throw new b(1,"Vorbis: Invalid Floor type: "+a)}}apply(e,t,s){this.floor.apply(e,t,s)}unpack(e,t,s){return this.floor.unpack(e,t,s)}},Ga=class Vu{constructor(t,e,s){this._begin=t.readBits(24),this._end=t.readBits(24),this._partitionSize=t.readBits(24)+1,this._classifications=t.readBits(6)+1,this._classBook=s[t.readBits(8)],this._cascade=new Int32Array(this._classifications);let i=0;for(let e=0;e<this._classifications;e++){var a=t.readBits(3);t.readBit()?this._cascade[e]=t.readBits(5)<<3|a:this._cascade[e]=a,i+=Vu._icount(this._cascade[e])}var r=new Int32Array(i);for(let e=0;e<i;e++)if(r[e]=t.readBits(8),0===s[r[e]].mapType)throw new b(1,"Vorbis: Invalid Residue 0");let n=this._classBook.entries,o=this._classBook.dimensions,h=1;for(;0<o;){if((h*=this._classifications)>n)throw new b(1,"Vorbis: Invalid Residue 0");--o}this._books=new Array(this._classifications);let l=i=0,d;for(let t=0;t<this._classifications;t++)if(d=Pa.ilog(this._cascade[t]),this._books[t]=new Array(d),0<d){l=Math.max(l,d);for(let e=0;e<d;e++)0<(this._cascade[t]&1<<e)&&(this._books[t][e]=s[r[i++]])}this._maxStages=l,this._decodeMap=new Array(h);for(let i=0;i<h;i++){let t=i,s=h/this._classifications|0;this._decodeMap[i]=new Int32Array(this._classBook.dimensions);for(let e=0;e<this._classBook.dimensions;e++){var c=t/s|0;t-=c*s,s=s/this._classifications|0,this._decodeMap[i][e]=c}}this._channels=e}static _icount(e){let t=0;for(;0!==e;)t+=1&e,e>>=1;return t}decode(r,e,t,n){t=(this._end<t/2?this._end:t/2)-this._begin;if(0<t&&-1!==e.indexOf(!1)){var o=t/this._partitionSize,s=(o+this._classBook.dimensions-1)/this._classBook.dimensions|0,h=[];for(let e=0;e<this._channels;e++)h.push(new Array(s));for(let a=0;a<this._maxStages;a++)for(let s=0,i=0;s<o;i++){if(0===a)for(let e=0;e<this._channels;e++){var l=this._classBook.decodeScalar(r);if(!(0<=l&&l<this._decodeMap.length)){s=o,a=this._maxStages;break}h[e][i]=this._decodeMap[l]}for(let t=0;s<o&&t<this._classBook.dimensions;t++,s++){var d=this._begin+s*this._partitionSize;for(let e=0;e<this._channels;e++){var c=h[e][i][t];if(0!=(this._cascade[c]&1<<a)){c=this._books[c][a];if(c&&this.writeVectors(c,r,n,e,d,this._partitionSize)){s=o,a=this._maxStages;break}}}}}}}writeVectors(s,t,e,i,a,r){var n=e[i],o=r/s.dimensions,h=new Int32Array(o);for(let e=0;e<o;e++)if(h[e]=s.decodeScalar(t),-1===h[e])return!0;for(let t=0;t<s.dimensions;t++)for(let e=0;e<o;e++,a++)n[a]+=s.get(h[e],t);return!1}},za=class extends Ga{writeVectors(s,e,t,i,a,r){var n=t[i];for(let t=0;t<r;){var o=s.decodeScalar(e);if(-1===o)return!0;for(let e=0;e<s.dimensions;t++,e++)n[a+t]+=s.get(o,e)}return!1}},Ua=class extends Ga{constructor(e,t,s){super(e,1,s),this._realChannels=t}decode(e,t,s,i){super.decode(e,t,s*this._realChannels,i)}writeVectors(s,e,i,t,a,r){let n=0;a/=this._realChannels;for(let t=0;t<r;){var o=s.decodeScalar(e);if(-1===o)return!0;for(let e=0;e<s.dimensions;e++,t++)i[n][a]+=s.get(o,e),++n===this._realChannels&&(n=0,a++)}return!1}},Ya=class{constructor(e,t,s){var i=e.readBits(16);switch(i){case 0:this.residue=new Ga(e,t,s);break;case 1:this.residue=new za(e,t,s);break;case 2:this.residue=new Ua(e,t,s);break;default:throw new b(1,"Vorbis: Invalid Residue type: "+i)}}decode(e,t,s,i){this.residue.decode(e,t,s,i)}},Xa=class{constructor(t,s,i,a,e){if(0!==t.readBits(16))throw new b(1,"Vorbis: Invalid mapping type!");let r=1,n=(t.readBit()&&(r+=t.readBits(4)),0);t.readBit()&&(n=t.readBits(8)+1);var o=Pa.ilog(s-1);this._couplingAngle=new Int32Array(n),this._couplingMangitude=new Int32Array(n);for(let e=0;e<n;e++){var h=t.readBits(o),l=t.readBits(o);if(h===l||s-1<h||s-1<l)throw new b(1,"Vorbis: Invalid magnitude or angle in mapping header!");this._couplingAngle[e]=l,this._couplingMangitude[e]=h}if(0!==t.readBits(2))throw new b(1,"Vorbis: Reserved bits not 0 in mapping header.");var d=new Int32Array(s);if(1<r)for(let e=0;e<s;e++)if(d[e]=t.readBits(4),d[e]>r)throw new b(1,"Vorbis: Invalid channel mux submap index in mapping header!");this._submapFloor=new Array(r),this._submapResidue=new Array(r);for(let e=0;e<r;e++){t.skipBits(8);var c=t.readBits(8);if(c>=i.length)throw new b(1,"Vorbis: Invalid floor number in mapping header!");var u=t.readBits(8);if(u>=a.length)throw new b(1,"Vorbis: Invalid residue number in mapping header!");this._submapFloor[e]=i[c],this._submapResidue[e]=a[u]}this._channelFloor=new Array(s),this._channelResidue=new Array(s);for(let e=0;e<s;e++)this._channelFloor[e]=this._submapFloor[d[e]],this._channelResidue[e]=this._submapResidue[d[e]];this._mdct=e}decodePacket(s,i,a){var t=i>>1,r=new Array(this._channelFloor.length),n=new Array(this._channelFloor.length);n.fill(!1);for(let e=0;e<this._channelFloor.length;e++)r[e]=this._channelFloor[e].unpack(s,i,e),n[e]=!r[e].executeChannel,a[e].fill(0,0,t);for(let e=0;e<this._couplingAngle.length;e++)(r[this._couplingAngle[e]].executeChannel||r[this._couplingMangitude[e]].executeChannel)&&(r[this._couplingAngle[e]].forceEnergy=!0,r[this._couplingMangitude[e]].forceEnergy=!0);for(let t=0;t<this._submapFloor.length;t++){for(let e=0;e<this._channelFloor.length;e++)this._submapFloor[t]===this._channelFloor[e]&&this._submapResidue[t]===this._channelResidue[e]||(r[e].forceNoEnergy=!0);this._submapResidue[t].decode(s,n,i,a)}for(let e=this._couplingAngle.length-1;0<=e;e--)if(r[this._couplingAngle[e]].executeChannel||r[this._couplingMangitude[e]].executeChannel){var o=a[this._couplingMangitude[e]],h=a[this._couplingAngle[e]];for(let a=0;a<t;a++){let e,t,s=o[a],i=h[a];0<s?0<i?(e=s,t=s-i):(t=s,e=s+i):0<i?(e=s,t=s+i):(t=s,e=s-i),o[a]=e,h[a]=t}}for(let e=0;e<this._channelFloor.length;e++)r[e].executeChannel?(this._channelFloor[e].apply(r[e],i,a[e]),this._mdct.reverse(a[e],i)):a[e].fill(0,t,2*t)}},Ja=class{constructor(){this.packetStartIndex=0,this.packetTotalLength=0,this.packetValidLength=0}},qa=class{constructor(){this.overlapInfo=new Ja,this.windowIndex=0}},ja=class{constructor(e=null){this.samplePosition=null,this.samplePosition=e}},$a=class $a{constructor(e,t,s,i,a){if(this._overlapInfo=null,this._channels=t,this._blockFlag=e.readBit(),0!==e.readBits(32))throw new b(1,"Vorbis: Mode header had invalid window or transform type!");t=e.readBits(8);if(t>=a.length)throw new b(1,"Vorbis: Mode header had invalid mapping index!");this._mapping=a[t],this._blockFlag?(this._blockSize=i,this._windows=[$a._calcWindow(s,i,s),$a._calcWindow(i,i,s),$a._calcWindow(s,i,i),$a._calcWindow(i,i,i)],this._overlapInfo=[$a._calcOverlap(s,i,s),$a._calcOverlap(i,i,s),$a._calcOverlap(s,i,i),$a._calcOverlap(i,i,i)]):(this._blockSize=s,this._windows=[$a._calcWindow(s,s,s)])}decode(e,s){var t=this._getPacketInfo(e),i=(this._mapping.decodePacket(e,this._blockSize,s),this._windows[t.windowIndex]);for(let t=0;t<this._blockSize;t++)for(let e=0;e<this._channels;e++)s[e][t]*=i[t];return t.overlapInfo}_getPacketInfo(e){var t,s=new qa;return this._blockFlag?(t=e.readBit(),e=e.readBit(),s.windowIndex=(t?1:0)+(e?2:0),t=this._overlapInfo[s.windowIndex],s.overlapInfo.packetStartIndex=t.packetStartIndex,s.overlapInfo.packetValidLength=t.packetValidLength,s.overlapInfo.packetTotalLength=t.packetTotalLength):(s.windowIndex=0,s.overlapInfo.packetStartIndex=0,s.overlapInfo.packetValidLength=this._blockSize/2,s.overlapInfo.packetTotalLength=this._blockSize),s}static _calcWindow(e,t,s){var i=new Float32Array(t),a=e/2,r=s/2,n=t/4-a/2,o=t-t/4-r/2;for(let e=0;e<a;e++){var h=Math.sin((e+.5)/a*$a._piHalf);h*=h,i[n+e]=Math.sin(h*$a._piHalf)}for(let e=n+a;e<o;e++)i[e]=1;for(let e=0;e<r;e++){var l=Math.sin((r-e-.5)/r*$a._piHalf);l*=l,i[o+e]=Math.sin(l*$a._piHalf)}return i}static _calcOverlap(e,t,s){var s=s/4,e=t/4-e/4,t=t/4*3+s,s=t-2*s,i=new Ja;return i.packetStartIndex=e,i.packetValidLength=s,i.packetTotalLength=t,i}},Ka=($a._piHalf=1.57079632695,$a),Qa=class Qa{constructor(e){this._n=e,this._n2=e>>1,this._n4=this._n2>>1,this._n8=this._n4>>1,this._ld=Pa.ilog(e)-1,this._a=new Float32Array(this._n2),this._b=new Float32Array(this._n2),this._c=new Float32Array(this._n4);let t=0,s=0;for(;t<this._n4;++t,s+=2)this._a[s]=Math.cos(4*t*Qa._pi/e),this._a[s+1]=-Math.sin(4*t*Qa._pi/e),this._b[s]=.5*Math.cos((s+1)*Qa._pi/e/2),this._b[s+1]=.5*Math.sin((s+1)*Qa._pi/e/2);for(t=0,s=0;t<this._n8;++t,s+=2)this._c[s]=Math.cos(2*(s+1)*Qa._pi/e),this._c[s+1]=-Math.sin(2*(s+1)*Qa._pi/e);this._bitrev=new Uint16Array(this._n8);for(let e=0;e<this._n8;++e)this._bitrev[e]=_s.int32ToUint16(Pa.bitReverse(e,this._ld-3)<<2)}calcReverse(n){var h,r,o=new Float32Array(this._n2);{let e=this._n2-2,t=0,s=0,i=this._n2;for(;s!==i;)o[e+1]=n[s]*this._a[t]-n[s+2]*this._a[t+1],o[e]=n[s]*this._a[t+1]+n[s+2]*this._a[t],e-=2,t+=2,s+=4;for(s=this._n2-3;0<=e;)o[e+1]=-n[s+2]*this._a[t]- -n[s]*this._a[t+1],o[e]=-n[s+2]*this._a[t+1]+-n[s]*this._a[t],e-=2,t+=2,s-=4}h=n,r=o;{let e=this._n2-8,t=this._n4,s=0,i=this._n4,a=0;for(;0<=e;){var l=r[t+1]-r[s+1],d=r[t]-r[s];h[i+1]=r[t+1]+r[s+1],h[i]=r[t]+r[s],h[a+1]=l*this._a[e+4]-d*this._a[e+5],h[a]=d*this._a[e+4]+l*this._a[e+5],l=r[t+3]-r[s+3],d=r[t+2]-r[s+2],h[i+3]=r[t+3]+r[s+3],h[i+2]=r[t+2]+r[s+2],h[a+3]=l*this._a[e]-d*this._a[e+1],h[a+2]=d*this._a[e]+l*this._a[e+1],e-=8,i+=4,a+=4,t+=4,s+=4}}this._step3Iter0Loop(this._n>>4,h,this._n2-1-0*this._n4,-this._n8),this._step3Iter0Loop(this._n>>4,h,this._n2-1-+this._n4,-this._n8),this._step3InnerRLoop(this._n>>5,h,this._n2-1-0*this._n8,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,h,this._n2-1-+this._n8,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,h,this._n2-1-2*this._n8,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,h,this._n2-1-3*this._n8,-(this._n>>4),16);let c=2;for(;c<this._ld-3>>1;++c){var t=this._n>>c+2,s=t>>1,i=1<<c+1;for(let e=0;e<i;++e)this._step3InnerRLoop(this._n>>c+4,h,this._n2-1-t*e,-s,1<<c+3)}for(;c<this._ld-6;++c){let t=this._n>>c+2,s=1<<c+3,i=t>>1,a=this._n>>c+6,r=1<<c+1,n=this._n2-1,o=0;for(let e=a;0<e;--e)this._step3InnerSLoop(r,h,n,-i,o,s,t),o+=4*s,n-=8}this._step3InnerSLoopLd654(this._n>>5,h,this._n2-1,this._n);{let e=0,t=this._n4-4,s=this._n2-4;for(;0<=t;){var a=this._bitrev[e];r[s+3]=h[a],r[s+2]=h[a+1],r[t+3]=h[a+2],r[t+2]=h[a+3],a=this._bitrev[e+1],r[s+1]=h[a],r[s]=h[a+1],r[t+1]=h[a+2],r[t]=h[a+3],t-=4,s-=4,e+=2}}{let e=0,t=0,s=this._n2-4;for(;t<s;){var u=r[t]-r[s+2],p=r[t+1]+r[s+3],m=this._c[e+1]*u+this._c[e]*p,g=this._c[e+1]*p-this._c[e]*u,f=r[t]+r[s+2],b=r[t+1]-r[s+3];r[t]=f+m,r[t+1]=b+g,r[s+2]=f-m,r[s+3]=g-b,u=r[t+2]-r[s],p=r[t+3]+r[s+1],m=this._c[e+3]*u+this._c[e+2]*p,g=this._c[e+3]*p-this._c[e+2]*u,f=r[t+2]+r[s],b=r[t+3]-r[s+1],r[t+2]=f+m,r[t+3]=b+g,r[s]=f-m,r[s+1]=g-b,e+=4,t+=4,s-=4}}{let e=this._n2-8,t=this._n2-8,s=0,i=this._n2-4,a=this._n2,r=this._n-4;for(;0<=t;){var y,_,S=o[t+6]*this._b[e+7]-o[t+7]*this._b[e+6],v=-o[t+6]*this._b[e+6]-o[t+7]*this._b[e+7];n[s]=S,n[i+3]=-S,n[a]=v,n[r+3]=v,_=o[t+4]*this._b[e+5]-o[t+5]*this._b[e+4],y=-o[t+4]*this._b[e+4]-o[t+5]*this._b[e+5],n[s+1]=_,n[i+2]=-_,n[a+1]=y,n[r+2]=y,S=o[t+2]*this._b[e+3]-o[t+3]*this._b[e+2],v=-o[t+2]*this._b[e+2]-o[t+3]*this._b[e+3],n[s+2]=S,n[i+1]=-S,n[a+2]=v,n[r+1]=v,_=o[t]*this._b[e+1]-o[t+1]*this._b[e],y=-o[t]*this._b[e]-o[t+1]*this._b[e+1],n[s+3]=_,n[i]=-_,n[a+3]=y,n[r]=y,e-=8,t-=8,s+=4,a+=4,i-=4,r-=4}}}_step3InnerRLoop(t,s,e,i,a){let r,n,o=e,h=o+i,l=0;for(let e=t>>2;0<e;--e)r=s[o]-s[h],n=s[o-1]-s[h-1],s[o]+=s[h],s[o-1]+=s[h-1],s[h]=r*this._a[l]-n*this._a[l+1],s[h-1]=n*this._a[l]+r*this._a[l+1],l+=a,r=s[o-2]-s[h-2],n=s[o-3]-s[h-3],s[o-2]+=s[h-2],s[o-3]+=s[h-3],s[h-2]=r*this._a[l]-n*this._a[l+1],s[h-3]=n*this._a[l]+r*this._a[l+1],l+=a,r=s[o-4]-s[h-4],n=s[o-5]-s[h-5],s[o-4]+=s[h-4],s[o-5]+=s[h-5],s[h-4]=r*this._a[l]-n*this._a[l+1],s[h-5]=n*this._a[l]+r*this._a[l+1],l+=a,r=s[o-6]-s[h-6],n=s[o-7]-s[h-7],s[o-6]+=s[h-6],s[o-7]+=s[h-7],s[h-6]=r*this._a[l]-n*this._a[l+1],s[h-7]=n*this._a[l]+r*this._a[l+1],l+=a,o-=8,h-=8}_step3Iter0Loop(t,s,e,i){let a=e,r=a+i,n=0;for(let e=t>>2;0<e;--e){var o=s[a]-s[r],h=s[a-1]-s[r-1];s[a]+=s[r],s[a-1]+=s[r-1],s[r]=o*this._a[n]-h*this._a[n+1],s[r-1]=h*this._a[n]+o*this._a[n+1],n+=8,o=s[a-2]-s[r-2],h=s[a-3]-s[r-3],s[a-2]+=s[r-2],s[a-3]+=s[r-3],s[r-2]=o*this._a[n]-h*this._a[n+1],s[r-3]=h*this._a[n]+o*this._a[n+1],n+=8,o=s[a-4]-s[r-4],h=s[a-5]-s[r-5],s[a-4]+=s[r-4],s[a-5]+=s[r-5],s[r-4]=o*this._a[n]-h*this._a[n+1],s[r-5]=h*this._a[n]+o*this._a[n+1],n+=8,o=s[a-6]-s[r-6],h=s[a-7]-s[r-7],s[a-6]+=s[r-6],s[a-7]+=s[r-7],s[r-6]=o*this._a[n]-h*this._a[n+1],s[r-7]=h*this._a[n]+o*this._a[n+1],n+=8,a-=8,r-=8}}_step3InnerSLoop(t,s,e,i,a,r,n){let o=this._a[a],h=this._a[a+1],l=this._a[a+r],d=this._a[a+r+1],c=this._a[a+2*r],u=this._a[a+2*r+1],p=this._a[a+3*r],m=this._a[a+3*r+1],g,f,b=e,y=b+i;for(let e=t;0<e;--e)g=s[b]-s[y],f=s[b-1]-s[y-1],s[b]+=s[y],s[b-1]+=s[y-1],s[y]=g*o-f*h,s[y-1]=f*o+g*h,g=s[b-2]-s[y-2],f=s[b-3]-s[y-3],s[b-2]+=s[y-2],s[b-3]+=s[y-3],s[y-2]=g*l-f*d,s[y-3]=f*l+g*d,g=s[b-4]-s[y-4],f=s[b-5]-s[y-5],s[b-4]+=s[y-4],s[b-5]+=s[y-5],s[y-4]=g*c-f*u,s[y-5]=f*c+g*u,g=s[b-6]-s[y-6],f=s[b-7]-s[y-7],s[b-6]+=s[y-6],s[b-7]+=s[y-7],s[y-6]=g*p-f*m,s[y-7]=f*p+g*m,b-=n,y-=n}_step3InnerSLoopLd654(e,t,s,i){let a=i>>3,r=this._a[a],n=s,o=n-16*e;for(;n>o;){var h=t[n]-t[n-8],l=t[n-1]-t[n-9];t[n]+=t[n-8],t[n-1]+=t[n-9],t[n-8]=h,t[n-9]=l,h=t[n-2]-t[n-10],l=t[n-3]-t[n-11],t[n-2]+=t[n-10],t[n-3]+=t[n-11],t[n-10]=(h+l)*r,t[n-11]=(l-h)*r,h=t[n-12]-t[n-4],l=t[n-5]-t[n-13],t[n-4]+=t[n-12],t[n-5]+=t[n-13],t[n-12]=l,t[n-13]=h,h=t[n-14]-t[n-6],l=t[n-7]-t[n-15],t[n-6]+=t[n-14],t[n-7]+=t[n-15],t[n-14]=(h+l)*r,t[n-15]=(h-l)*r,this._iter54(t,n),this._iter54(t,n-8),n-=16}}_iter54(e,t){var s=e[t]-e[t-4],i=e[t]+e[t-4],a=e[t-2]+e[t-6],r=e[t-2]-e[t-6],i=(e[t]=i+a,e[t-2]=i-a,e[t-3]-e[t-7]),a=(e[t-4]=s+i,e[t-6]=s-i,e[t-1]-e[t-5]),s=e[t-1]+e[t-5],i=e[t-3]+e[t-7];e[t-1]=s+i,e[t-3]=s-i,e[t-5]=a-r,e[t-7]=a+r}},Za=(Qa._pi=3.141592653589793,Qa),er=class{constructor(){this._setupCache=new Map}reverse(e,t){let s;this._setupCache.has(t)?s=this._setupCache.get(t):(s=new Za(t),this._setupCache.set(t,s)),s.calcReverse(e)}},tr=class Wu{constructor(e,t,s){this._packetIndex=0,this._stream=e,this._setup=t,this._packets=s,this._currentPosition=0,this._prevPacketBuf=null,this._prevPacketStart=0,this._prevPacketEnd=0,this._prevPacketStop=0,this._nextPacketBuf=null,this._eosFound=!1,this._hasPosition=!1,this._modeFieldBits=Pa.ilog(t.modes.length-1)}decode(){let e=new Float32Array(this._packets[this._packets.length-1].granulePosition*this._stream.audioChannels),t=new Float32Array(.2*this._stream.audioSampleRate*this._stream.audioChannels),s,i=0;for(;0!==(s=this.read(t,0,t.length));){var a;i+s>=e.length&&((a=new Float32Array(e.length+t.length)).set(e,0),e=a),e.set(t.subarray(0,s),i),i+=s}return e.subarray(0,i)}read(e,t,s){if(0===s)return 0;let i=t,a=t+s;for(;i<a;){if(this._prevPacketStart===this._prevPacketEnd){if(this._eosFound){this._nextPacketBuf=null,this._prevPacketBuf=null;break}var r=this._readNextPacket((i-t)/this._stream.audioChannels);null===r&&(this._prevPacketEnd=this._prevPacketStop),null===r||null===r.samplePosition||this._hasPosition||(this._hasPosition=!0,this._currentPosition=r.samplePosition-(this._prevPacketEnd-this._prevPacketStart)-(i-t)/this._stream.audioChannels)}r=Math.min((a-i)/this._stream.audioChannels,this._prevPacketEnd-this._prevPacketStart);0<r&&(i+=this._copyBuffer(e,i,r))}return s=i-t,this._currentPosition+=s/this._stream.audioChannels,s}_copyBuffer(t,e,s){let i=e;for(;0<s;this._prevPacketStart++,s--)for(let e=0;e<this._stream.audioChannels;e++)t[i++]=this._prevPacketBuf[e][this._prevPacketStart];return i-e}_readNextPacket(e){var t=this._decodeNextPacket();return this._eosFound=this._eosFound||t.isEndOfStream,null==t.curPacket?null:(null!==t.samplePosition&&t.isEndOfStream&&(e=this._currentPosition+e+t.validLen-t.startIndex,(e=t.samplePosition-e)<0)&&(t.validLen+=e,t.validLen<0)&&(t.validLen=0),0<this._prevPacketEnd?(Wu._overlapBuffers(this._prevPacketBuf,t.curPacket,this._prevPacketStart,this._prevPacketStop,t.startIndex,this._stream.audioChannels),this._prevPacketStart=t.startIndex):null==this._prevPacketBuf&&(this._prevPacketStart=t.validLen),this._nextPacketBuf=this._prevPacketBuf,this._prevPacketEnd=t.validLen,this._prevPacketStop=t.totalLen,this._prevPacketBuf=t.curPacket,new ja(t.samplePosition))}static _overlapBuffers(t,s,i,e,a,r){for(;i<e;i++,a++)for(let e=0;e<r;e++)s[e][a]+=t[e][i]}_decodeNextPacket(){var e=new sr;if(this._packetIndex>=this._packets.length)e.isEndOfStream=!0;else{var t=this._packets[this._packetIndex++],s=new Ba(Bs.fromBuffer(t.packetData));if(e.isEndOfStream=t.isEndOfStream,!s.readBit()){var i=this._setup.modes[s.readBits(this._modeFieldBits)];if(null==this._nextPacketBuf){this._nextPacketBuf=new Array(this._stream.audioChannels);for(let e=0;e<this._stream.audioChannels;e++)this._nextPacketBuf[e]=new Float32Array(this._stream.blocksize1)}i=i.decode(s,this._nextPacketBuf);e.startIndex=i.packetStartIndex,e.validLen=i.packetValidLength,e.totalLen=i.packetTotalLength,e.samplePosition=t.granulePosition,e.curPacket=this._nextPacketBuf}}return e}},sr=class{constructor(){this.curPacket=null,this.startIndex=0,this.validLen=0,this.totalLen=0,this.isEndOfStream=!1,this.samplePosition=null}},ir=class ir{constructor(e){this._packetIndex=-1,this._packets=e}read(){for(;;){if(null==(e=this._nextPacket()))return null;if(e.isBeginningOfStream){var e=this._readStream(e);if(null!=e)return e}}}_nextPacket(){return this._packetIndex++,this._packetIndex<this._packets.length?this._packets[this._packetIndex]:null}_readStream(e){var t=new ka;if(!this._readIdentificationHeader(t,e)||!this._readComments(this._nextPacket()))return null;e=new xa;if(!this._readSetupHeader(t,e,this._nextPacket()))return null;for(var s,i=[];null!=(s=this._nextPacket())&&(i.push(s),!s.isEndOfStream););e=new tr(t,e,i);return t.samples=e.decode(),t}_commonHeaderDecode(e,t){var s=new Uint8Array(7);if(t.read(s,0,s.length),s[0]!==e)return!1;for(let e=0;e<ir.vorbisHeaderMarker.length;e++)if(s[1+e]!==ir.vorbisHeaderMarker[e])return!1;return!0}_commonHeaderDecodeBit(e,t){var s=t.readBytes(7);if(s[0]!==e)return!1;for(let e=0;e<ir.vorbisHeaderMarker.length;e++)if(s[1+e]!==ir.vorbisHeaderMarker[e])return!1;return!0}_readIdentificationHeader(e,t){t=Bs.fromBuffer(t.packetData);if(!this._commonHeaderDecode(1,t)||0!==f.readUInt32LE(t)||(e.audioChannels=t.readByte(),e.audioSampleRate=f.readUInt32LE(t),e.audioChannels<=0)||e.audioSampleRate<=0)return!1;e.bitrateMaximum=f.readInt32LE(t),e.bitrateNominal=f.readInt32LE(t),e.bitrateMinimum=f.readInt32LE(t);var s=t.readByte();return e.blocksize0=1<<(15&s),e.blocksize1=1<<(s>>4),!(e.blocksize1<e.blocksize0||!ir._isAllowedBlockSize(e.blocksize0)||!ir._isAllowedBlockSize(e.blocksize0)||0===t.readByte())}static _isAllowedBlockSize(e){switch(e){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}_readComments(e){if(null==e)return!1;var t=Bs.fromBuffer(e.packetData);if(!this._commonHeaderDecode(3,t))return!1;var e=f.readUInt32LE(t),s=(t.skip(e),f.readUInt32LE(t));for(let e=0;e<s;e++){var i=f.readUInt32LE(t);t.skip(i)}return 0!==t.readByte()}_readSetupHeader(t,s,e){if(null==e)return!1;var i=new Ba(Bs.fromBuffer(e.packetData)),a=new er,r=new Da;if(!this._commonHeaderDecodeBit(5,i))return!1;let n=i.readByte()+1;for(let e=0;e<n;e++)s.codebooks.push(new La(i,r));n=i.readBits(6)+1;for(let e=0;e<n;e++)s.timeDomainTransforms.push(new Ia(i));n=i.readBits(6)+1;for(let e=0;e<n;e++)s.floors.push(new Ha(i,t.blocksize0,t.blocksize1,s.codebooks));n=i.readBits(6)+1;for(let e=0;e<n;e++)s.residues.push(new Ya(i,t.audioChannels,s.codebooks));n=i.readBits(6)+1;for(let e=0;e<n;e++)s.mappings.push(new Xa(i,t.audioChannels,s.floors,s.residues,a));n=i.readBits(6)+1;for(let e=0;e<n;e++)s.modes.push(new Ka(i,t.audioChannels,t.blocksize0,t.blocksize1,s.mappings));return!!i.readBit()}},ar=(ir.vorbisHeaderMarker=new Uint8Array([118,111,114,98,105,115]),ir),rr=class{constructor(e){this.streams=[];for(var e=new va(e).read(),t=new ar(e);;){var s=t.read();if(null==s)break;this.streams.push(s)}}},nr=class{constructor(){this.phdrs=[],this.pbags=[],this.pmods=[],this.pgens=[],this.insts=[],this.ibags=[],this.imods=[],this.igens=[],this.sHdrs=[],this.sampleData=new Uint8Array(0),this._sampleCache=new Map}decodeSamples(s,i,a){var r=s+`_${i}_`+a;if(this._sampleCache.has(r))return this._sampleCache.get(r);{let t,e=this.sampleData.slice(s,i);if(a)t=new rr(Bs.fromBuffer(e)).streams[0].samples;else{var n=new DataView(e.buffer,e.byteOffset,e.length);t=new Float32Array(e.length/2);for(let e=0;e<t.length;e++)t[e]=n.getInt16(2*e,!0)/32767}return this._sampleCache.set(r,t),t}}load(s){var e=new _a,t=new _a;if(!_a.load(null,e,s)||"sfbk"!==e.id)throw new Gt("Soundfont is not a valid Soundfont2 file");for(;_a.load(e,t,s);){var i=new _a;if("pdta"===t.id)for(;_a.load(t,i,s);)switch(i.id){case"phdr":for(let e=0,t=i.size/pr.SizeInFile|0;e<t;e++)this.phdrs.push(new pr(s));break;case"pbag":for(let e=0,t=i.size/cr.SizeInFile|0;e<t;e++)this.pbags.push(new cr(s));break;case"pmod":for(let e=0,t=i.size/mr.SizeInFile|0;e<t;e++)this.pmods.push(new mr(s));break;case"pgen":for(let e=0,t=i.size/ur.SizeInFile|0;e<t;e++)this.pgens.push(new ur(s));break;case"inst":for(let e=0,t=i.size/dr.SizeInFile|0;e<t;e++)this.insts.push(new dr(s));break;case"ibag":for(let e=0,t=i.size/or.SizeInFile|0;e<t;e++)this.ibags.push(new or(s));break;case"imod":for(let e=0,t=i.size/hr.SizeInFile|0;e<t;e++)this.imods.push(new hr(s));break;case"igen":for(let e=0,t=i.size/lr.SizeInFile|0;e<t;e++)this.igens.push(new lr(s));break;case"shdr":for(let e=0,t=i.size/gr.SizeInFile|0;e<t;e++)this.sHdrs.push(new gr(s));break;default:s.position+=i.size}else if("sdta"===t.id)for(;_a.load(t,i,s);)"smpl"===i.id?(this.sampleData=new Uint8Array(i.size),s.read(this.sampleData,0,i.size)):s.position+=i.size;else s.position+=t.size}}},or=class{constructor(e){this.instGenNdx=f.readUInt16LE(e),this.instModNdx=f.readUInt16LE(e)}},hr=(or.SizeInFile=4,class{constructor(e){this.modSrcOper=f.readUInt16LE(e),this.modDestOper=f.readUInt16LE(e),this.modAmount=f.readInt16LE(e),this.modAmtSrcOper=f.readUInt16LE(e),this.modTransOper=f.readUInt16LE(e)}}),lr=(hr.SizeInFile=10,class{constructor(e){this.genOper=f.readUInt16LE(e),this.genAmount=new fr(e)}}),dr=(lr.SizeInFile=4,class{constructor(e){this.instName=f.read8BitStringLength(e,20),this.instBagNdx=f.readUInt16LE(e)}}),cr=(dr.SizeInFile=22,class{constructor(e){this.genNdx=f.readUInt16LE(e),this.modNdx=f.readUInt16LE(e)}}),ur=(cr.SizeInFile=4,class{constructor(e){this.genOper=f.readUInt16LE(e),this.genAmount=new fr(e)}}),pr=(ur.SizeInFile=4,ur.GenInstrument=41,ur.GenKeyRange=43,ur.GenVelRange=44,ur.GenSampleId=53,class{constructor(e){this.presetName=f.read8BitStringLength(e,20),this.preset=f.readUInt16LE(e),this.bank=f.readUInt16LE(e),this.presetBagNdx=f.readUInt16LE(e),this.library=f.readUInt32LE(e),this.genre=f.readUInt32LE(e),this.morphology=f.readUInt32LE(e)}}),mr=(pr.SizeInFile=38,class{constructor(e){this.modSrcOper=f.readUInt16LE(e),this.modDestOper=f.readUInt16LE(e),this.modAmount=f.readUInt16LE(e),this.modAmtSrcOper=f.readUInt16LE(e),this.modTransOper=f.readUInt16LE(e)}}),gr=(mr.SizeInFile=10,class{constructor(e){this.sampleName=f.read8BitStringLength(e,20),this.start=f.readUInt32LE(e),this.end=f.readUInt32LE(e),this.startLoop=f.readUInt32LE(e),this.endLoop=f.readUInt32LE(e),this.sampleRate=f.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=f.readSInt8(e),this.sampleLink=f.readUInt16LE(e),this.sampleType=f.readUInt16LE(e)}}),fr=(gr.SizeInFile=46,class{get shortAmount(){return _s.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(e){this.wordAmount=f.readUInt16LE(e)}}),br=class{constructor(){this.presetIndex=0,this.bank=0,this.pitchWheel=0,this.perNotePitchWheel=new Map,this.midiPan=0,this.midiVolume=0,this.midiExpression=0,this.midiRpn=0,this.midiData=0,this.panOffset=0,this.gainDb=0,this.pitchRange=0,this.tuning=0,this.mixVolume=0,this.mute=!1,this.solo=!1}},yr=class{constructor(){this.activeChannel=0,this.channelList=[]}setupVoice(e,t){var s=this.channelList[this.activeChannel],i=t.region.pan+s.panOffset;t.playingChannel=this.activeChannel,t.mixVolume=s.mixVolume,t.noteGainDb+=s.gainDb,t.updatePitchRatio(s,e.outSampleRate),i<=-.5?(t.panFactorLeft=1,t.panFactorRight=0):.5<=i?(t.panFactorLeft=0,t.panFactorRight=1):(t.panFactorLeft=Math.sqrt(.5-i),t.panFactorRight=Math.sqrt(.5+i))}},_r=class{constructor(){this.name="",this.presetNumber=0,this.bank=0,this.regions=null}},Sr=class{static timecents2Secs(e){return Math.pow(2,e/1200)}static decibelsToGain(e){return-100<e?Math.pow(10,.05*e):0}static gainToDecibels(e){return e<=1e-5?-100:20*Math.log10(e)}static cents2Hertz(e){return 8.176*Math.pow(2,e/1200)}},vr=class{constructor(e){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0,e&&(this.delay=e.delay,this.attack=e.attack,this.hold=e.hold,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.keynumToHold=e.keynumToHold,this.keynumToDecay=e.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(e){this.delay=this.delay<-11950?0:Sr.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Sr.timecents2Secs(this.attack),this.release=this.release<-11950?0:Sr.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:Sr.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:Sr.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=e?Sr.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}},kr=class kr{constructor(e){this.loopMode=0,this.samples=kr._noSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv=new vr,this.modEnv=new vr,this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,e&&(this.loopMode=e.loopMode,this.samples=e.samples,this.sampleRate=e.sampleRate,this.loKey=e.loKey,this.hiKey=e.hiKey,this.loVel=e.loVel,this.hiVel=e.hiVel,this.group=e.group,this.offset=e.offset,this.end=e.end,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.transpose=e.transpose,this.tune=e.tune,this.pitchKeyCenter=e.pitchKeyCenter,this.pitchKeyTrack=e.pitchKeyTrack,this.attenuation=e.attenuation,this.pan=e.pan,this.ampEnv=new vr(e.ampEnv),this.modEnv=new vr(e.modEnv),this.initialFilterQ=e.initialFilterQ,this.initialFilterFc=e.initialFilterFc,this.modEnvToPitch=e.modEnvToPitch,this.modEnvToFilterFc=e.modEnvToFilterFc,this.modLfoToFilterFc=e.modLfoToFilterFc,this.modLfoToVolume=e.modLfoToVolume,this.delayModLFO=e.delayModLFO,this.freqModLFO=e.freqModLFO,this.modLfoToPitch=e.modLfoToPitch,this.delayVibLFO=e.delayVibLFO,this.freqVibLFO=e.freqVibLFO,this.vibLfoToPitch=e.vibLfoToPitch)}clear(e){this.loopMode=0,this.samples=kr._noSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,e||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(e,t){switch(e){case 0:this.offset+=_s.int16ToUint32(t.shortAmount);break;case 1:this.end+=_s.int16ToUint32(t.shortAmount);break;case 2:this.loopStart+=_s.int16ToUint32(t.shortAmount);break;case 3:this.loopEnd+=_s.int16ToUint32(t.shortAmount);break;case 4:this.offset+=32768*_s.int16ToUint32(t.shortAmount);break;case 5:this.modLfoToPitch=t.shortAmount;break;case 6:this.vibLfoToPitch=t.shortAmount;break;case 7:this.modEnvToPitch=t.shortAmount;break;case 8:this.initialFilterFc=t.shortAmount;break;case 9:this.initialFilterQ=t.shortAmount;break;case 10:this.modLfoToFilterFc=t.shortAmount;break;case 11:this.modEnvToFilterFc=t.shortAmount;break;case 12:this.end+=32768*_s.int16ToUint32(t.shortAmount);break;case 13:this.modLfoToVolume=t.shortAmount;break;case 17:this.pan=t.shortAmount/1e3;break;case 21:this.delayModLFO=t.shortAmount;break;case 22:this.freqModLFO=t.shortAmount;break;case 23:this.delayVibLFO=t.shortAmount;break;case 24:this.freqVibLFO=t.shortAmount;break;case 25:this.modEnv.delay=t.shortAmount;break;case 26:this.modEnv.attack=t.shortAmount;break;case 27:this.modEnv.hold=t.shortAmount;break;case 28:this.modEnv.decay=t.shortAmount;break;case 29:this.modEnv.sustain=t.shortAmount;break;case 30:this.modEnv.release=t.shortAmount;break;case 31:this.modEnv.keynumToHold=t.shortAmount;break;case 32:this.modEnv.keynumToDecay=t.shortAmount;break;case 33:this.ampEnv.delay=t.shortAmount;break;case 34:this.ampEnv.attack=t.shortAmount;break;case 35:this.ampEnv.hold=t.shortAmount;break;case 36:this.ampEnv.decay=t.shortAmount;break;case 37:this.ampEnv.sustain=t.shortAmount;break;case 38:this.ampEnv.release=t.shortAmount;break;case 39:this.ampEnv.keynumToHold=t.shortAmount;break;case 40:this.ampEnv.keynumToDecay=t.shortAmount;break;case 43:this.loKey=t.lowByteAmount,this.hiKey=t.highByteAmount;break;case 44:this.loVel=t.lowByteAmount,this.hiVel=t.highByteAmount;break;case 45:this.loopStart+=32768*_s.int16ToUint32(t.shortAmount);break;case 48:this.attenuation+=.1*t.shortAmount;break;case 50:this.loopEnd+=32768*_s.int16ToUint32(t.shortAmount);break;case 51:this.transpose+=t.shortAmount;break;case 52:this.tune+=t.shortAmount;break;case 54:this.loopMode=3==(3&t.wordAmount)?2:1==(3&t.wordAmount)?1:0;break;case 56:this.pitchKeyTrack=t.shortAmount;break;case 57:this.group=t.wordAmount;break;case 58:this.pitchKeyCenter=t.shortAmount}}},wr=(kr._noSamples=new Float32Array(0),kr),Tr=class Tr{constructor(){this.level=0,this.slope=0,this.samplesUntilNextSegment=0,this.segment=0,this.midiVelocity=0,this.parameters=null,this.segmentIsExponential=!1,this.isAmpEnv=!1}nextSegment(e,t){if(this.parameters)for(;;)switch(e){case 0:if(this.samplesUntilNextSegment=this.parameters.delay*t|0,0<this.samplesUntilNextSegment)return this.segment=1,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);e=1;break;case 1:if(this.samplesUntilNextSegment=this.parameters.attack*t|0,0<this.samplesUntilNextSegment)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*t|0),this.segment=2,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);e=2;break;case 2:if(this.samplesUntilNextSegment=this.parameters.hold*t|0,0<this.samplesUntilNextSegment)return this.segment=3,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);e=3;break;case 3:if(this.samplesUntilNextSegment=this.parameters.decay*t|0,0<this.samplesUntilNextSegment)return this.segment=4,this.level=1,void(this.isAmpEnv?(s=-9.226/this.samplesUntilNextSegment,this.slope=Math.exp(s),this.segmentIsExponential=!0,0<this.parameters.sustain&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/s|0)):(this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*t|0,this.segmentIsExponential=!1));e=4;break;case 4:return this.segment=5,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case 5:var s;return this.segment=6,this.samplesUntilNextSegment=(this.parameters.release<=0?Tr._fastReleaseTime:this.parameters.release)*t|0,void(this.isAmpEnv?(s=-9.226/this.samplesUntilNextSegment,this.slope=Math.exp(s),this.segmentIsExponential=!0):(this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1));default:return this.segment=7,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(e,t,s,i,a){this.parameters=new vr(e),0<this.parameters.keynumToHold&&(this.parameters.hold+=this.parameters.keynumToHold*(60-t),this.parameters.hold=this.parameters.hold<-1e4?0:Sr.timecents2Secs(this.parameters.hold)),0<this.parameters.keynumToDecay&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-t),this.parameters.decay=this.parameters.decay<-1e4?0:Sr.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|s,this.isAmpEnv=i,this.nextSegment(0,a)}process(e,t){0<this.slope&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),this.samplesUntilNextSegment-=e,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,t)}},Br=(Tr._fastReleaseTime=.01,Tr),xr=class{constructor(){this.samplesUntil=0,this.level=0,this.delta=0}setup(e,t,s){this.samplesUntil=e*s|0,this.delta=4*Sr.cents2Hertz(t)/s,this.level=0}process(e){this.samplesUntil>e?this.samplesUntil-=e:(this.level+=this.delta*e,1<this.level?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}},Pr=class{constructor(e){this.qInv=0,this.a0=0,this.a1=0,this.b1=0,this.b2=0,this.z1=0,this.z2=0,this.active=!1,e&&(this.qInv=e.qInv,this.a0=e.a0,this.a1=e.a1,this.b1=e.b1,this.b2=e.b2,this.z1=e.z1,this.z2=e.z2,this.active=e.active)}setup(e){var e=Math.tan(Math.PI*e),t=e*e,s=1/(1+e*this.qInv+t);this.a0=t*s,this.a1=2*this.a0,this.b1=2*(t-1)*s,this.b2=(1-e*this.qInv+t)*s}process(e){var t=e*this.a0+this.z1;return this.z1=e*this.a1+this.z2-this.b1*t,this.z2=e*this.a0-this.b2*t,t}},Nr=class Nr{constructor(){this.playingPreset=0,this.playingKey=0,this.playingChannel=0,this.region=null,this.pitchInputTimecents=0,this.pitchOutputFactor=0,this.sourceSamplePosition=0,this.noteGainDb=0,this.panFactorLeft=0,this.panFactorRight=0,this.playIndex=0,this.loopStart=0,this.loopEnd=0,this.ampEnv=new Br,this.modEnv=new Br,this.lowPass=new Pr,this.modLfo=new xr,this.vibLfo=new xr,this.mixVolume=0,this.mute=!1}updatePitchRatio(e,t){let s=e.pitchWheel;e.perNotePitchWheel.has(this.playingKey)&&(s+=e.perNotePitchWheel.get(this.playingKey)-8192);e=8192===s?e.tuning:s/16383*e.pitchRange*2-e.pitchRange+e.tuning;this.calcPitchRatio(e,t)}calcPitchRatio(s,i){if(this.region){let e=this.playingKey+this.region.transpose+this.region.tune/100,t=this.region.pitchKeyCenter+(e-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==s&&(t+=s),this.pitchInputTimecents=100*t,this.pitchOutputFactor=this.region.sampleRate/(Sr.timecents2Secs(100*this.region.pitchKeyCenter)*i)}}end(e){this.region&&(this.ampEnv.nextSegment(5,e),this.modEnv.nextSegment(5,e),2===this.region.loopMode)&&(this.loopEnd=this.loopStart)}endQuick(e){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(5,e),this.modEnv.parameters.release=0,this.modEnv.nextSegment(5,e)}render(E,L,C,F,D){if(this.region){let e=this.region,o=e.samples,h=0,l=1===E.outputMode?F:-1,t=0!==e.modEnvToPitch||0!==e.modEnvToFilterFc,s=0<this.modLfo.delta&&(0!==e.modLfoToPitch||0!==e.modLfoToFilterFc||0!==e.modLfoToVolume),i=0<this.vibLfo.delta&&0!==e.vibLfoToPitch,d=this.loopStart<this.loopEnd,c=this.loopStart,u=this.loopEnd,p=e.end,m=u+1,g=this.sourceSamplePosition,f=new Pr(this.lowPass),b=0!==e.modLfoToFilterFc||0!==e.modEnvToFilterFc,y=0,_=0,S=0,v=0,k=0!==e.modLfoToPitch||0!==e.modEnvToPitch||0!==e.vibLfoToPitch,w=0,T=0,B=0,x=0,P=0!==e.modLfoToVolume,N=0,M=0;for(v=b?(y=E.outSampleRate,_=e.initialFilterFc,S=e.modLfoToFilterFc,e.modEnvToFilterFc):(y=0,_=0,S=0),x=k?(w=0,T=e.modLfoToPitch,B=e.vibLfoToPitch,e.modEnvToPitch):(w=Sr.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,T=0,B=0),M=P?.1*e.modLfoToVolume:(N=Sr.decibelsToGain(this.noteGainDb),0);0<F;){let a,r,n=0,e=F>Nr.renderEffectSampleBlock?Nr.renderEffectSampleBlock:F;var I;switch(F-=e,b&&(I=_+this.modLfo.level*S+this.modEnv.level*v,f.active=I<=13500,f.active)&&f.setup(Sr.cents2Hertz(I)/y),k&&(w=Sr.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*T+this.vibLfo.level*B+this.modEnv.level*x))*this.pitchOutputFactor),P&&(N=Sr.decibelsToGain(this.noteGainDb+this.modLfo.level*M)),a=N*this.ampEnv.level,D?a=0:a*=this.mixVolume,this.ampEnv.process(e,E.outSampleRate),t&&this.modEnv.process(e,E.outSampleRate),s&&this.modLfo.process(e),i&&this.vibLfo.process(e),E.outputMode){case 0:for(r=a*this.panFactorLeft,n=a*this.panFactorRight;0<e--&&g<p;){let e=0|g,t=u<=e&&d?c:1+e,s=g-e,i=o[e]*(1-s)+o[t]*s;f.active&&(i=f.process(i)),L[C+h]+=i*r,L[C+ ++h]+=i*n,h++,(g+=w)>=m&&d&&(g-=u-c+1)}break;case 1:for(r=a*this.panFactorLeft,n=a*this.panFactorRight;0<e--&&g<p;){let e=0|g,t=u<=e&&d?c:1+e,s=g-e,i=o[e]*(1-s)+o[t]*s;f.active&&(i=f.process(i)),L[C+h]+=i*r,h++,L[C+l]+=i*n,l++,(g+=w)>=m&&d&&(g-=u-c+1)}break;case 2:for(;0<e--&&g<p;){let e=0|g,t=u<=e&&d?c:1+e,s=g-e,i=o[e]*(1-s)+o[t]*s;f.active&&(i=f.process(i)),L[C+h]=i*a,h++,(g+=w)>=m&&d&&(g-=u-c+1)}}if(g>=p||7===this.ampEnv.segment)return void this.kill()}this.sourceSamplePosition=g,(f.active||b)&&(this.lowPass=f)}}kill(){this.playingPreset=-1}},Mr=(Nr.renderEffectSampleBlock=_.MicroBufferSize,Nr),Er=class{constructor(e){this.value=e}},Lr=class{get isEmpty(){return void 0===this._head}clear(){this._head=void 0,this._tail=void 0}enqueue(e){e=new Er(e);this._tail?this._tail.next=e:this._head=e,this._tail=e}enqueueFront(e){e=new Er(e);e.next=this._head,this._head?this._head=e:(this._head=e,this._tail=e)}peek(){var e=this._head;if(e)return e.value}dequeue(){var e,t=this._head;if(t)return e=t.next,(this._head=e)||(this._tail=void 0),t.value}},Cr=((e={})[e.BankSelectCoarse=0]="BankSelectCoarse",e[e.ModulationCoarse=1]="ModulationCoarse",e[e.DataEntryCoarse=6]="DataEntryCoarse",e[e.VolumeCoarse=7]="VolumeCoarse",e[e.PanCoarse=10]="PanCoarse",e[e.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",e[e.BankSelectFine=32]="BankSelectFine",e[e.ModulationFine=33]="ModulationFine",e[e.DataEntryFine=38]="DataEntryFine",e[e.VolumeFine=39]="VolumeFine",e[e.PanFine=42]="PanFine",e[e.ExpressionControllerFine=43]="ExpressionControllerFine",e[e.HoldPedal=64]="HoldPedal",e[e.LegatoPedal=68]="LegatoPedal",e[e.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",e[e.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",e[e.RegisteredParameterFine=100]="RegisteredParameterFine",e[e.RegisteredParameterCourse=101]="RegisteredParameterCourse",e[e.AllSoundOff=120]="AllSoundOff",e[e.ResetControllers=121]="ResetControllers",e[e.AllNotesOff=123]="AllNotesOff",e),Fr=class Hu{constructor(e){this._midiEventQueue=new Lr,this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1,this._transpositionPitches=new Map,this._liveTranspositionPitches=new Map,this.currentTempo=0,this.timeSignatureNumerator=0,this.timeSignatureDenominator=0,this.presets=null,this._voices=[],this._channels=null,this._voicePlayIndex=0,this.outputMode=0,this.outSampleRate=0,this.globalGainDb=0,this.outSampleRate=e}synthesize(e,t,s){return this._fillWorkingBuffer(e,t,s)}synthesizeSilent(e){this._fillWorkingBuffer(null,0,e)}channelGetMixVolume(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].mixVolume:1}channelSetMixVolume(e,t){var s,i=this._channelInit(e);for(s of this._voices)s.playingChannel===e&&-1!==s.playingPreset&&(s.mixVolume=t);i.mixVolume=t}channelSetMute(e,t){t?this._mutedChannels.set(e,!0):this._mutedChannels.delete(e)}channelSetSolo(e,t){t?this._soloChannels.set(e,!0):this._soloChannels.delete(e),this._isAnySolo=0<this._soloChannels.size}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._liveTranspositionPitches=new Map,this.applyTranspositionPitches(new Map),this._isAnySolo=!1}setChannelTranspositionPitch(e,t){let s=0;this._liveTranspositionPitches.has(e)&&(s=this._liveTranspositionPitches.get(e)),0===t?this._liveTranspositionPitches.delete(e):this._liveTranspositionPitches.set(e,t);for(var i of this._voices){var a;i.playingChannel===e&&9!==i.playingChannel&&(a=(a=0)-s+t,i.playingKey+=a,this._channels)&&i.updatePitchRatio(this._channels.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(t){var s,i=this._transpositionPitches;for(s of this._voices)if(0<=s.playingChannel&&9!==s.playingChannel){let e=0;i.has(s.playingChannel)&&(e-=i.get(s.playingChannel)),t.has(s.playingChannel)&&(e+=t.get(s.playingChannel)),s.playingKey+=e,this._channels&&s.updatePitchRatio(this._channels.channelList[s.playingChannel],this.outSampleRate)}this._transpositionPitches=t}dispatchEvent(e){this._midiEventQueue.enqueue(e)}_fillWorkingBuffer(e,t,s){for(var i,a,r=this._isAnySolo,n=[];!this._midiEventQueue.isEmpty;){var o=this._midiEventQueue.dequeue();o.isMetronome&&0<this.metronomeVolume?(this.channelNoteOff(_.MetronomeChannel,_.MetronomeKey),this.channelNoteOn(_.MetronomeChannel,_.MetronomeKey,95/127)):o.event&&this.processMidiMessage(o.event),n.push(o)}for(i of this._voices)-1!==i.playingPreset&&(a=i.playingChannel,a=this._mutedChannels.has(a)||r&&a!==_.MetronomeChannel&&!this._soloChannels.has(a),e?i.render(this,e,t,s,a):i.kill());return n}processMidiMessage(e){switch(e.type){case 88:var t=e;this.timeSignatureNumerator=t.numerator,this.timeSignatureDenominator=Math.pow(2,t.denominatorIndex);break;case 128:this.channelNoteOn(e.channel,e.noteKey,e.noteVelocity/127);break;case 144:this.channelNoteOff(e.channel,e.noteKey);break;case 176:this.channelMidiControl(e.channel,e.controller,e.value);break;case 192:this.channelSetPresetNumber(e.channel,e.program,9===e.channel);break;case 81:this.currentTempo=e.beatsPerMinute;break;case 224:this.channelSetPitchWheel(e.channel,e.value);break;case 96:t=e.value;this.channelSetPerNotePitchWheel(e.channel,e.noteKey,t*_.MaxPitchWheel/_.MaxPitchWheel20)}}get metronomeVolume(){return this.channelGetMixVolume(_.MetronomeChannel)}set metronomeVolume(e){this.setupMetronomeChannel(e)}setupMetronomeChannel(e){this.channelSetMixVolume(_.MetronomeChannel,e),0<e&&(this.channelSetVolume(_.MetronomeChannel,1),this.channelSetPresetNumber(_.MetronomeChannel,0,!0))}get masterVolume(){return Sr.decibelsToGain(this.globalGainDb)}set masterVolume(e){var e=Sr.gainToDecibels(e),t=e-this.globalGainDb;if(0!=t){for(var s of this._voices)-1!==s.playingPreset&&(s.noteGainDb+=t);this.globalGainDb=e}}resetSoft(){for(var e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<6||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);if(this._channels)for(var t of this._channels.channelList)t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.perNotePitchWheel.clear(),t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0}get presetCount(){return this.presets?.length??0}reset(){for(var e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<6||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);this._channels=null}setOutput(e,t,s){this.outputMode=e,this.outSampleRate=1<=t?t:44100,this.globalGainDb=s}noteOn(t,s,i){if(this.presets){var a=127*i|0;if(!(t<0||t>=this.presets.length))if(i<=0)this.noteOff(t,s);else{var r,n=this._voicePlayIndex++;for(r of this.presets[t].regions)if(!(s<r.loKey||s>r.hiKey||a<r.loVel||a>r.hiVel)){let e=null;if(0!==r.group)for(var o of this._voices)o.playingPreset===t&&o.region.group===r.group?o.endQuick(this.outSampleRate):-1!==o.playingPreset||(e=e||o);else for(var h of this._voices)-1===h.playingPreset&&(e=h);if(!e){for(let e=0;e<4;e++){var l=new Mr;l.playingPreset=-1,this._voices.push(l)}e=this._voices[this._voices.length-4]}e.region=r,e.playingPreset=t,e.playingKey=s,e.playIndex=n,e.noteGainDb=this.globalGainDb-r.attenuation-Sr.gainToDecibels(1/i),this._channels?this._channels.setupVoice(this,e):(e.calcPitchRatio(0,this.outSampleRate),e.panFactorLeft=Math.sqrt(.5-r.pan),e.panFactorRight=Math.sqrt(.5+r.pan)),e.sourceSamplePosition=r.offset;var d=0!==r.loopMode&&r.loopStart<r.loopEnd,d=(e.loopStart=d?r.loopStart:0,e.loopEnd=d?r.loopEnd:0,e.ampEnv.setup(r.ampEnv,s,a,!0,this.outSampleRate),e.modEnv.setup(r.modEnv,s,a,!1,this.outSampleRate),r.initialFilterQ/10);e.lowPass.qInv=1/Math.pow(10,d/20),e.lowPass.z1=0,e.lowPass.z2=0,e.lowPass.active=r.initialFilterFc<=13500,e.lowPass.active&&e.lowPass.setup(Sr.cents2Hertz(r.initialFilterFc)/this.outSampleRate),e.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),e.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}}}bankNoteOn(e,t,s,i){e=this._getPresetIndex(e,t);return-1!==e&&(this.noteOn(e,s,i),!0)}noteOff(e,t){let s=null,i=null,a=[];for(var r of this._voices)r.playingPreset!==e||r.playingKey!==t||6<=r.ampEnv.segment||(!s||r.playIndex<s.playIndex?(s=r,i=r,a.push(r)):r.playIndex===s.playIndex&&(i=r,a.push(r)));if(s)for(var n of a)n!==s&&n!==i&&(n.playIndex!==s.playIndex||n.playingPreset!==e||n.playingKey!==t||6<=n.ampEnv.segment)||n.end(this.outSampleRate)}bankNoteOff(e,t,s){e=this._getPresetIndex(e,t);return-1!==e&&(this.noteOff(e,s),!0)}noteOffAll(e){for(var t of this._voices)-1!==t.playingPreset&&(e?t.endQuick(this.outSampleRate):t.ampEnv.segment<6&&t.end(this.outSampleRate))}get activeVoiceCount(){let e=0;for(var t of this._voices)-1!==t.playingPreset&&e++;return e}_channelInit(t){if(!(this._channels&&t<this._channels.channelList.length)){this._channels||(this._channels=new yr);for(let e=this._channels.channelList.length;e<=t;e++){var s=new br;s.presetIndex=0,s.bank=0,s.pitchWheel=8192,s.midiPan=8192,s.midiVolume=16383,s.midiExpression=16383,s.midiRpn=65535,s.midiData=0,s.panOffset=0,s.gainDb=0,s.pitchRange=2,s.tuning=0,s.mixVolume=1,this._channels.channelList.push(s)}}return this._channels.channelList[t]}_getPresetIndex(t,s){if(this.presets)for(let e=this.presets.length-1;0<=e;e--){var i=this.presets[e];if(i.presetNumber===s&&i.bank===t)return e}return-1}getPresetName(e){return!this.presets||e<0||e>=this.presets.length?null:this.presets[e].name}bankGetPresetName(e,t){return this.getPresetName(this._getPresetIndex(e,t))}channelNoteOn(e,t,s){!this._channels||e>this._channels.channelList.length||(this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e)),this._channels.activeChannel=e,this.noteOn(this._channels.channelList[e].presetIndex,t,s))}channelNoteOff(e,t){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));let s=[],i=null,a=null;for(var r of this._voices)-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||6<=r.ampEnv.segment||(!i||r.playIndex<i.playIndex?(i=r,a=r,s.push(r)):r.playIndex===i.playIndex&&(a=r,s.push(r)));if(this._channelInit(e).perNotePitchWheel.delete(t),i)for(var n of s)n!==i&&n!==a&&(n.playIndex!==i.playIndex||-1===n.playingPreset||n.playingChannel!==e||n.playingKey!==t||6<=n.ampEnv.segment)||n.end(this.outSampleRate)}channelNoteOffAll(e){this._channelInit(e).perNotePitchWheel.clear();for(var t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&t.ampEnv.segment<6&&t.end(this.outSampleRate)}channelSoundsOffAll(e){this._channelInit(e).perNotePitchWheel.clear();for(var t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&(t.ampEnv.segment<6||0===t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate)}channelSetPresetIndex(e,t){this._channelInit(e).presetIndex=_s.int32ToUint16(t)}channelSetPresetNumber(e,t,s=!1){let i=this._channelInit(e),a=0;return s&&-1!==(a=-1===(a=-1===(a=this._getPresetIndex(128|32767&i.bank,t))?this._getPresetIndex(128,t):a)?this._getPresetIndex(128,0):a)||(a=this._getPresetIndex(2047&i.bank,t)),-1!==(i.presetIndex=a)}channelSetBank(e,t){this._channelInit(e).bank=_s.int32ToUint16(t)}channelSetBankPreset(e,t,s){e=this._channelInit(e),s=this._getPresetIndex(t,s);return-1!==s&&(e.presetIndex=_s.int32ToUint16(s),e.bank=_s.int32ToUint16(t),!0)}channelSetPan(e,t){for(var s of this._voices){var i;s.playingChannel===e&&-1!==s.playingPreset&&((i=s.region.pan+t-.5)<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):.5<=i?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-i),s.panFactorRight=Math.sqrt(.5+i)))}this._channelInit(e).panOffset=t-.5}channelSetVolume(e,t){var s=this._channelInit(e),t=Sr.gainToDecibels(t),i=t-s.gainDb;if(0!=i){for(var a of this._voices)a.playingChannel===e&&-1!==a.playingPreset&&(a.noteGainDb+=i);s.gainDb=t}}channelSetPitchWheel(e,t){var s=this._channelInit(e);s.pitchWheel!==t&&(s.pitchWheel=_s.int32ToUint16(t),this._channelApplyPitch(e,s))}channelSetPerNotePitchWheel(e,t,s){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));var i=this._channelInit(e);i.perNotePitchWheel.has(t)&&i.perNotePitchWheel.get(t)===s||(i.perNotePitchWheel.set(t,s),this._channelApplyPitch(e,i,t))}_channelApplyPitch(e,t,s=-1){for(var i of this._voices)i.playingChannel!==e||-1===i.playingPreset||-1!==s&&i.playingKey!==s||i.updatePitchRatio(t,this.outSampleRate)}channelSetPitchRange(e,t){var s=this._channelInit(e);s.pitchRange!==t&&(s.pitchRange=t,8192!==s.pitchWheel)&&this._channelApplyPitch(e,s)}channelSetTuning(e,t){var s=this._channelInit(e);s.tuning!==t&&(s.tuning=t,this._channelApplyPitch(e,s))}channelMidiControl(e,t,s){var i=this._channelInit(e);switch(t){case 38:return i.midiData=_s.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(e,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(e,s-64+(i.tuning-(0|i.tuning))));case 7:return i.midiVolume=_s.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 39:return i.midiVolume=_s.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 11:return i.midiExpression=_s.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 43:return i.midiExpression=_s.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 10:return i.midiPan=_s.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(e,i.midiPan/16383);case 42:return i.midiPan=_s.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(e,i.midiPan/16383);case 6:return i.midiData=_s.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(e,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&6===t&&this.channelSetTuning(e,s-64+(i.tuning-(0|i.tuning))));case 0:return void(i.bank=_s.int32ToUint16(32768|s));case 32:return void(i.bank=_s.int32ToUint16((0!=(32768&i.bank)?(127&i.bank)<<7:0)|s));case 101:return void(i.midiRpn=_s.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case 100:return void(i.midiRpn=_s.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case 98:case 99:return void(i.midiRpn=65535);case 120:return void this.channelSoundsOffAll(e);case 123:return void this.channelNoteOffAll(e);case 121:return i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(e,1),this.channelSetPan(e,.5),void this.channelSetPitchRange(e,2)}}channelGetPresetIndex(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].presetIndex:0}channelGetPresetBank(e){return this._channels&&e<this._channels.channelList.length?32767&this._channels.channelList[e].bank:0}channelGetPan(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].panOffset-.5:.5}channelGetVolume(e){return this._channels&&e<this._channels.channelList.length?Sr.decibelsToGain(this._channels.channelList[e].gainDb):1}channelGetPitchWheel(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchWheel:8192}channelGetPitchRange(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchRange:2}channelGetTuning(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].tuning:0}resetPresets(){this.presets=[]}loadPresets(u,l,d,e){var s=[];for(let t=0;t<u.phdrs.length-1;t++){let n=u.phdrs[t],o=0,h=new _r,c=(s.push(h),h.name=n.presetName,h.bank=n.bank,h.presetNumber=n.preset,0);for(let s=n.presetBagNdx;s<u.phdrs[t+1].presetBagNdx;s++){let t=u.pbags[s],o=0,h=127,l=0,d=127;for(let e=t.genNdx;e<u.pbags[s+1].genNdx;e++){var i=u.pgens[e];if(i.genOper===ur.GenKeyRange)o=i.genAmount.lowByteAmount,h=i.genAmount.highByteAmount;else if(i.genOper===ur.GenVelRange)l=i.genAmount.lowByteAmount,d=i.genAmount.highByteAmount;else if(!(i.genOper!==ur.GenInstrument||i.genAmount.wordAmount>=u.insts.length))for(let n=u.insts[i.genAmount.wordAmount].instBagNdx;n<u.insts[i.genAmount.wordAmount+1].instBagNdx;n++){let t=u.ibags[n],s=0,i=127,a=0,r=127;for(let e=t.instGenNdx;e<u.ibags[n+1].instGenNdx;e++){var p=u.igens[e];p.genOper===ur.GenKeyRange?(s=p.genAmount.lowByteAmount,i=p.genAmount.highByteAmount):p.genOper===ur.GenVelRange?(a=p.genAmount.lowByteAmount,r=p.genAmount.highByteAmount):53===p.genOper&&i>=o&&s<=h&&r>=l&&a<=d&&c++}}}}h.regions=new Array(c);let e=new wr;e.clear(!0);for(let i=n.presetBagNdx;i<u.phdrs[t+1].presetBagNdx;i++){let t=u.pbags[i],r=new wr(e),s=!1;for(let e=t.genNdx;e<u.pbags[i+1].genNdx;e++){var a=u.pgens[e];if(a.genOper===ur.GenInstrument){var m=a.genAmount.wordAmount;if(!(m>=u.insts.length)){let e=new wr;e.clear(!1);var g=u.insts[m];for(let a=g.instBagNdx;a<u.insts[m+1].instBagNdx;a++){let t=u.ibags[a],s=new wr(e),i=!1;for(let e=t.instGenNdx;e<u.ibags[a+1].instGenNdx;e++){var f,b,y=u.igens[e];y.genOper===ur.GenSampleId?s.hiKey<r.loKey||s.loKey>r.hiKey||s.hiVel<r.loVel||s.loVel>r.hiVel||(r.loKey>s.loKey&&(s.loKey=r.loKey),r.hiKey<s.hiKey&&(s.hiKey=r.hiKey),r.loVel>s.loVel&&(s.loVel=r.loVel),r.hiVel<s.hiVel&&(s.hiVel=r.hiVel),s.offset+=r.offset,s.end+=r.end,s.loopStart+=r.loopStart,s.loopEnd+=r.loopEnd,s.transpose+=r.transpose,s.tune+=r.tune,s.pitchKeyTrack+=r.pitchKeyTrack,s.attenuation+=r.attenuation,s.pan+=r.pan,s.ampEnv.delay+=r.ampEnv.delay,s.ampEnv.attack+=r.ampEnv.attack,s.ampEnv.hold+=r.ampEnv.hold,s.ampEnv.decay+=r.ampEnv.decay,s.ampEnv.sustain+=r.ampEnv.sustain,s.ampEnv.release+=r.ampEnv.release,s.modEnv.delay+=r.modEnv.delay,s.modEnv.attack+=r.modEnv.attack,s.modEnv.hold+=r.modEnv.hold,s.modEnv.decay+=r.modEnv.decay,s.modEnv.sustain+=r.modEnv.sustain,s.modEnv.release+=r.modEnv.release,s.initialFilterQ+=r.initialFilterQ,s.initialFilterFc+=r.initialFilterFc,s.modEnvToPitch+=r.modEnvToPitch,s.modEnvToFilterFc+=r.modEnvToFilterFc,s.delayModLFO+=r.delayModLFO,s.freqModLFO+=r.freqModLFO,s.modLfoToPitch+=r.modLfoToPitch,s.modLfoToFilterFc+=r.modLfoToFilterFc,s.modLfoToVolume+=r.modLfoToVolume,s.delayVibLFO+=r.delayVibLFO,s.freqVibLFO+=r.freqVibLFO,s.vibLfoToPitch+=r.vibLfoToPitch,s.ampEnv.envToSecs(!0),s.modEnv.envToSecs(!1),s.delayModLFO=s.delayModLFO<-11950?0:Sr.timecents2Secs(s.delayModLFO),s.delayVibLFO=s.delayVibLFO<-11950?0:Sr.timecents2Secs(s.delayVibLFO),s.pan<-.5?s.pan=-.5:.5<s.pan&&(s.pan=.5),(s.initialFilterQ<1500||13500<s.initialFilterQ)&&(s.initialFilterQ=0),f=u.sHdrs[y.genAmount.wordAmount],s.offset+=f.start,s.end+=f.end,s.loopStart+=f.startLoop,s.loopEnd+=f.endLoop,0<f.endLoop&&--s.loopEnd,-1===s.pitchKeyCenter&&(s.pitchKeyCenter=f.originalPitch),s.tune+=f.pitchCorrection,s.sampleRate=f.sampleRate,(b=n.bank===_.PercussionBank)&&Hu._setContainsRange(d,s.loKey,s.hiKey)||!b&&l.has(n.preset)?0!=(1&f.sampleType)?(M.debug("AlphaSynth",`Loading of used sample ${f.sampleName} for preset ${n.presetName} (bank ${h.bank} program ${h.presetNumber})`),0!=(16&f.sampleType)?s.samples=u.decodeSamples(f.start,f.end,!0):(s.samples=u.decodeSamples(2*s.offset,2*s.end,!1),0<s.loopStart&&(s.loopStart-=s.offset),0<s.loopEnd&&(s.loopEnd-=s.offset)),s.offset=0,s.end=s.samples.length-1):0!=(32783&f.sampleType)?(M.debug("AlphaSynth",`Loading sample ${f.sampleName} for preset ${n.presetName} as mono fallback (type ${f.sampleType})`),s.samples=u.decodeSamples(2*s.offset,2*s.end,!1),0<s.loopStart&&(s.loopStart-=s.offset),0<s.loopEnd&&(s.loopEnd-=s.offset),s.offset=0,s.end=s.samples.length-1):(M.warning("AlphaSynth",`Skipping load of unsupported sample ${f.sampleName} for preset ${n.presetName}, sample type ${f.sampleType} is not supported (bank ${h.bank} program ${h.presetNumber})`),s.samples=new Float32Array(0)):(M.debug("AlphaSynth",`Skipping load of unused sample ${f.sampleName} for preset ${n.presetName} (bank ${h.bank} program ${h.presetNumber})`),s.samples=new Float32Array(0)),h.regions[o]=new wr(s),o++,i=!0):s.operator(y.genOper,y.genAmount)}t!==u.ibags[g.instBagNdx]||i||(e=new wr(s))}s=!0}}else r.operator(a.genOper,a.genAmount)}t!==u.pbags[n.presetBagNdx]||s||(e=r)}}if(e&&this.presets)for(var t of s)this.presets.push(t);else this.presets=s}static _setContainsRange(t,s,i){for(let e=s;e<=i;e++)if(t.has(e))return!0;return!1}hasSamplesForProgram(e){var t=this.presets;if(t)for(var s of t)if(s.presetNumber===e)for(var i of s.regions)if(0<i.samples.length)return!0;return!1}hasSamplesForPercussion(e){var t=this.presets;if(t)for(var s of t)if(s.bank===_.PercussionBank)for(var i of s.regions)if(i.loKey>=e&&i.hiKey<=e&&0<i.samples.length)return!0;return!1}},Dr=class{constructor(e){this.events=e}},Ir=class{constructor(e){this.playbackRange=e}},Ar=class{constructor(){this.sampleRate=44100,this.useSyncPoints=!1,this.masterVolume=1,this.metronomeVolume=0,this.trackVolume=new Map,this.trackTranspositionPitches=new Map}},Rr=class{constructor(){this.currentTime=0,this.endTime=0,this.currentTick=0,this.endTick=0}},Or=class{constructor(e,t,s){this.isSoundFontLoaded=!1,this._isMidiLoaded=!1,this._tickPosition=0,this._timePosition=0,this._metronomeVolume=0,this._countInVolume=0,this.playedEventsQueue=new Lr,this.midiEventsPlayedFilterSet=new Set,this._notPlayedSamples=0,this._synthStopping=!1,this._currentPosition=new ba(0,0,0,0,!1,120,120),this.isReady=!1,this.state=0,this._loadedSoundFonts=[],this.readyForPlayback=new rs,this.finished=new rs,this.soundFontLoaded=new rs,this.soundFontLoadFailed=new g,this.midiLoadFailed=new g,this.midiEventsPlayed=new g,M.debug("AlphaSynth","Initializing player"),this.state=0,this.ready=new rs(()=>this.isReady),this.readyForPlayback=new rs(()=>this.isReadyForPlayback),this.midiLoaded=new g(()=>this._loadedMidiInfo||null),this.stateChanged=new g(()=>new fa(this.state,!1)),this.positionChanged=new g(()=>this._currentPosition),this.playbackRangeChanged=new g(()=>this.playbackRange?new Ir(this.playbackRange):null),M.debug("AlphaSynth","Creating output"),this._output=e,M.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=t,this.sequencer=new ma(this.synthesizer),M.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this._checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this._onSamplesPlayed.bind(this)),this.output.open(s)}get output(){return this._output}get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return M.logLevel}set logLevel(e){M.logLevel=e}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(e){e=Math.max(e,_.MinVolume),this.updateMasterVolume(e)}updateMasterVolume(e){this.synthesizer.masterVolume=e}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,_.MinVolume),this._metronomeVolume=e,this.synthesizer.metronomeVolume=e}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,_.MinVolume),this._countInVolume=e}get midiEventsPlayedFilter(){return Array.from(this.midiEventsPlayedFilterSet)}set midiEventsPlayedFilter(e){this.midiEventsPlayedFilterSet=new Set(e)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(e){e=F.clamp(e,_.MinPlaybackSpeed,_.MaxPlaybackSpeed),this.updatePlaybackSpeed(e)}updatePlaybackSpeed(e){var t=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=e,this.timePosition=this.timePosition*(t/e)}get loadedMidiInfo(){return this._loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._tickPosition}set tickPosition(e){this.timePosition=this.sequencer.mainTickPositionToTimePosition(e)}get timePosition(){return this._timePosition}set timePosition(e){M.debug("AlphaSynth",`Seeking to position ${e}ms (main)`),this.sequencer.mainSeek(e),this.updateTimePosition(e,!0),this.sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(e){(this.sequencer.mainPlaybackRange=e)&&(this.tickPosition=e.startTick),this.playbackRangeChanged.trigger(new Ir(e))}get isLooping(){return this.sequencer.isLooping}set isLooping(e){this.sequencer.isLooping=e}destroy(){M.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}onSampleRequest(){if(1===this.state&&(!this.sequencer.isFinished||0<this.synthesizer.activeVoiceCount)){let t=new Float32Array(_.MicroBufferSize*_.MicroBufferCount*_.AudioChannels),s=0;for(let e=0;e<_.MicroBufferCount;e++){this.sequencer.fillMidiEventQueue();var i,a=this.synthesizer.synthesize(t,s,_.MicroBufferSize);s+=_.MicroBufferSize*_.AudioChannels;for(i of a)this.midiEventsPlayedFilterSet.has(i.event.type)&&this.playedEventsQueue.enqueue(i);if(this.sequencer.isFinished)break}s<t.length&&(t=t.subarray(0,s)),this._notPlayedSamples+=t.length,this.output.addSamples(t)}else{var e=new Float32Array(0);this.output.addSamples(e)}}play(){return!(0!==this.state||!this._isMidiLoaded||(this.output.activate(),this._playInternal(),0<this._countInVolume&&(M.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),0))}_playInternal(){this.sequencer.isPlayingOneTimeMidi&&(M.debug("AlphaSynth","Cancelling one time midi"),this._stopOneTimeMidi()),M.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this._synthStopping=!1,this.state=1,this.stateChanged.trigger(new fa(this.state,!1))}pause(){0!==this.state&&this._isMidiLoaded&&(M.debug("AlphaSynth","Pausing playback"),this.state=0,this.stateChanged.trigger(new fa(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){0===this.state&&this._isMidiLoaded?this.play():this.pause()}stop(){this._isMidiLoaded&&(M.debug("AlphaSynth","Stopping playback"),this.state=0,this.output.pause(),this._notPlayedSamples=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new fa(this.state,!0)))}playOneTimeMidiFile(e){this.sequencer.isPlayingOneTimeMidi?this._stopOneTimeMidi():this.pause(),this.sequencer.loadOneTimeMidi(e),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this._loadedSoundFonts=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}loadSoundFont(e,t){this.pause();e=Bs.fromBuffer(e);try{M.debug("AlphaSynth","Loading soundfont from bytes");var s=new nr;s.load(e),t||(this._loadedSoundFonts=[]),this._loadedSoundFonts.push(s),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),M.debug("AlphaSynth","soundFont successfully loaded"),this._checkReadyForPlayback()}catch(e){M.error("AlphaSynth","Could not load soundfont from bytes "+e),this.soundFontLoadFailed.trigger(e)}}_checkReadyForPlayback(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);let e=this.sequencer.instrumentPrograms,t=this.sequencer.percussionKeys,s=!1;for(var i of this._loadedSoundFonts)this.synthesizer.loadPresets(i,e,t,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(e){this.stop();try{M.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(e),this._isMidiLoaded=!0,this._loadedMidiInfo=new ba(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo),M.debug("AlphaSynth","Midi successfully loaded"),this._checkReadyForPlayback(),this.tickPosition=0}catch(e){M.error("AlphaSynth","Could not load midi from model "+e),this.midiLoadFailed.trigger(e)}}applyTranspositionPitches(e){this.synthesizer.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this.synthesizer.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this.synthesizer.channelSetMute(e,t)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(e,t){this.synthesizer.channelSetSolo(e,t)}setChannelVolume(e,t){t=Math.max(t,_.MinVolume),this.synthesizer.channelSetMixVolume(e,t)}_onSamplesPlayed(e){var t;0!==e&&(t=e/this.synthesizer.outSampleRate*1e3,this._notPlayedSamples-=e*_.AudioChannels,this.updateTimePosition(this._timePosition+t,!1),this.checkForFinish())}checkForFinish(){let e=0,t=0;t=this.playbackRange&&this.sequencer.isPlayingMain?(e=this.playbackRange.startTick,this.playbackRange.endTick):this.sequencer.currentEndTick,this._tickPosition>=t&&(this._notPlayedSamples<=0?(this._notPlayedSamples=0,this.sequencer.isPlayingCountIn?(M.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this._playInternal(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(M.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=0,this._stopOneTimeMidi()):this.isLooping?(M.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=e,this._synthStopping=!1):0<this.synthesizer.activeVoiceCount?this._synthStopping||(M.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0):(this._synthStopping=!1,M.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this._synthStopping||(M.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0))}_stopOneTimeMidi(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}_createPositionChangedEventArgs(e){let t=this._timePosition,s=this.sequencer.currentTimePositionToTickPosition(t),i=this.sequencer.currentEndTime,a=this.sequencer.currentEndTick;return t>i&&(t=i,s=a),new ba(t,i,s,a,e,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(e,t){this._timePosition=e;var s=this._createPositionChangedEventArgs(t),e=(this._tickPosition=s.currentTick,this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time");if(M.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${e}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this._currentPosition=s,this.positionChanged.trigger(s)),t)this.playedEventsQueue.clear();else{for(var i=[];!this.playedEventsQueue.isEmpty&&this.playedEventsQueue.peek().time<s.currentTime;){var a=this.playedEventsQueue.dequeue();i.push(a.event)}0<i.length&&(i.reverse(),this.midiEventsPlayed.trigger(new Dr(i)))}}hasSamplesForProgram(e){return this.synthesizer.hasSamplesForProgram(e)}hasSamplesForPercussion(e){return this.synthesizer.hasSamplesForPercussion(e)}loadBackingTrack(e){}updateSyncPoints(e){}},Vr=class extends Or{constructor(e,t){super(e,new Fr(e.sampleRate),t)}exportAudio(e,t,s,i){var a,r,n,o,h=new Wr(e);h.loadMidiFile(t),e.useSyncPoints&&h.updateSyncPoints(s),h.applyTranspositionPitches(i);for([a,r]of e.trackTranspositionPitches)h.setChannelTranspositionPitch(a,r);for([n,o]of e.trackVolume)h.channelSetMixVolume(n,o);if(e.soundFonts)for(var l of e.soundFonts)h.loadSoundFont(l);else h.loadPresets(this.synthesizer.presets);return e.playbackRange&&h.limitExport(e.playbackRange),h.setup(),h}},Wr=class{constructor(e){this._generatedAudioCurrentTime=0,this._generatedAudioEndTime=0,this._synth=new Fr(e.sampleRate),this._sequencer=new ma(this._synth),this._synth.masterVolume=Math.max(e.masterVolume,_.MinVolume),this._synth.metronomeVolume=Math.max(e.metronomeVolume,_.MinVolume)}loadSoundFont(e){var e=Bs.fromBuffer(e),t=new nr,e=(t.load(e),this._sequencer.instrumentPrograms),s=this._sequencer.percussionKeys;this._synth.loadPresets(t,e,s,!0)}loadPresets(e){this._synth.presets=e}limitExport(e){this._sequencer.mainPlaybackRange=e,this._sequencer.mainSeek(this._sequencer.mainTickPositionToTimePosition(e.startTick))}setChannelTranspositionPitch(e,t){this._synth.setChannelTranspositionPitch(e,t)}applyTranspositionPitches(e){this._synth.applyTranspositionPitches(e)}loadMidiFile(e){this._sequencer.loadMidi(e)}updateSyncPoints(e){this._sequencer.mainUpdateSyncPoints(e)}channelSetMixVolume(e,t){t=Math.max(t,_.MinVolume),this._synth.channelSetMixVolume(e,t)}setup(){this._synth.setupMetronomeChannel(this._synth.metronomeVolume);var i=this._sequencer.currentSyncPoints,e=this._sequencer.currentEndTime;if(0===i.length)this._generatedAudioEndTime=e;else{let e=i[i.length-1],t=e.syncTime,s=this._sequencer.currentEndTick-e.synthTick;0<s&&(t+=N.ticksToMillis(s,e.syncBpm)),this._generatedAudioEndTime=t}}render(e){if(!this._sequencer.isFinished){let t=1e3*_.MicroBufferSize/this._synth.outSampleRate,s=Math.ceil(e/t),i=new Float32Array(_.MicroBufferSize*s*_.AudioChannels),a=this._sequencer.currentSyncPoints,r=0,n=this._generatedAudioCurrentTime;for(let e=0;e<s;e++){var o;if(0<a.length&&(this._sequencer.currentUpdateSyncPoints(n),this._sequencer.currentUpdateCurrentTempo(this._sequencer.currentTime),o=this._sequencer.syncPointTempo/this._sequencer.currentTempo,this._sequencer.playbackSpeed!==o)&&(this._sequencer.playbackSpeed=o),this._sequencer.fillMidiEventQueue(),this._synth.synthesize(i,r,_.MicroBufferSize),r+=_.MicroBufferSize*_.AudioChannels,n+=t,this._sequencer.isFinished)break}r<i.length&&(i=i.subarray(0,r));var h=new Rr;return h.currentTime=this._generatedAudioCurrentTime,h.endTime=this._generatedAudioEndTime,h.currentTick=this._sequencer.currentTimePositionToTickPosition(this._sequencer.currentTime),h.endTick=this._sequencer.currentEndTick,this._generatedAudioCurrentTime+=e,h.samples=i,this._sequencer.isFinished&&this._synth.noteOffAll(!0),h}}},T=class{static parseEnum(t,e){switch(typeof t){case"string":var s=Number.parseInt(t,10);return Number.isNaN(s)?e[Object.keys(e).find(e=>e.toLowerCase()===t.toLowerCase())]:s;case"number":return t;case"undefined":case"object":return}throw new b(1,`Could not parse enum value '${t}'`)}static parseEnumExact(e,t){if(e in t)return t[e]}static forEach(e,t){if(e instanceof Map)e.forEach(t);else if("object"==typeof e)for(var s in e)t(e[s],s)}static getValue(e,t){return e instanceof Map?e.get(t):"object"==typeof e?e[t]:null}},Hr=class{constructor(e,t,s){this.text=e,this.startPos=t,this.endPos=s}},Gr=class Gu{constructor(e){this.style="normal",this.variant="normal",this.weight="normal",this.stretch="normal",this.lineHeight="normal",this.size="1rem",this.families=[],this.parseOnlyFamilies=!1,this._currentTokenIndex=-1,this._input="",this._currentToken=null,this._input=e,this._tokens=this._splitToTokens(e)}_splitToTokens(t){let s=[],i=0;for(;i<t.length;){let e=i;for(;e<t.length&&" "!==t.charAt(e);)e++;e>i&&s.push(new Hr(t.substring(i,e),i,e)),i=e+1}return s}parse(){if(this._reset(),1===this._tokens.length)switch(this._currentToken?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this._fontStyleVariantWeight(),this._fontSizeLineHeight()),this._fontFamily()}static parseFamilies(e){e=new Gu(e);return e.parseOnlyFamilies=!0,e.parse(),e.families}_fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}let e=this._input.substr(this._currentToken.startPos).trim(),t=0;for(;t<e.length;){var s,i=e.charAt(t);" "===i||","===i?t++:t='"'===i||"'"===i?(s=this._findEndOfQuote(e,t+1,i),this.families.push(e.substring(t+1,s).split("\\"+i).join(i)),s+1):(i=this._findEndOfQuote(e,t+1,","),this.families.push(e.substring(t,i).trim()),i+1)}}_findEndOfQuote(e,t,s){let i=!1;for(;t<e.length;){var a=e.charAt(t);if(!i&&a===s)return t;i=!i&&"\\"===a,t+=1}return e.length}_fontSizeLineHeight(){if(!this._currentToken)throw new Error("Missing font size");var e=this._currentToken.text.split("/");if(3<=e.length)throw new Error(`Invalid font size '${this._currentToken}' specified`);if(this._nextToken(),2<=e.length)if("/"===e[1]){if(!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this._nextToken()}else this.size=e[0],this.lineHeight=e[1];else{if(!(1<=e.length))throw new Error("Missing font size");if(this.size=e[0],this._currentToken&&0===this._currentToken.text.indexOf("/")){if("/"===this._currentToken.text){if(this._nextToken(),!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text}else this.lineHeight=this._currentToken.text.substr(1);this._nextToken()}}}_nextToken(){this._currentTokenIndex++,this._currentTokenIndex<this._tokens.length?this._currentToken=this._tokens[this._currentTokenIndex]:this._currentToken=null}_fontStyleVariantWeight(){let e=!1,t=!1,s=!1,i=3,a=[];for(;;){if(!this._currentToken)return;var r=this._currentToken.text;switch(r){case"normal":case"inherit":a.push(r),i--,this._nextToken();break;case"italic":case"oblique":this.style=r,e=!0,i--,this._nextToken();break;case"small-caps":this.variant=r,t=!0,i--,this._nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,s=!0,i--,this._nextToken();break;default:return}if(0===i)break}for(;0<a.length;){var n=a.pop();s?t?e||(this.style=n):this.variant=n:this.weight=n}}_reset(){this._currentTokenIndex=-1,this._nextToken()}static quoteFont(e){return-1===e.indexOf(" ")?e:`"${e.replaceAll('"','\\"')}"`}},zr=((l={})[l.Plain=0]="Plain",l[l.Italic=1]="Italic",l),Ur=((i={})[i.Regular=0]="Regular",i[i.Bold=1]="Bold",i),A=class zu{constructor(e,t,s=0,i=0){this._cssScale=0,this._families=Gr.parseFamilies(e),this._size=t,this._style=s,this._weight=i,this._css=this.toCssString()}_reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(e){this.families=Gr.parseFamilies(e)}get families(){return this._families}set families(e){this._families=e,this._reset()}get size(){return this._size}set size(e){this._size=e,this._reset()}get style(){return this._style}set style(e){this._style=e,this._reset()}get weight(){return this._weight}set weight(e){this._weight=e,this._reset()}get isBold(){return 1===this.weight}get isItalic(){return 1===this.style}withSize(e){return zu.withFamilyList(this._families,e,this._style,this._weight)}static withFamilyList(e,t,s=0,i=0){t=new zu("",t,s,i);return t.families=e,t}toCssString(t=1){if(!(this._css&&Math.abs(t-this._cssScale)<.01)){let e="";this.isBold&&(e+="bold "),this.isItalic&&(e+="italic "),e=(e=e+this.size*t+"px ")+this.families.map(e=>Gr.quoteFont(e)).join(", "),this._css=e,this._cssScale=t}return this._css}static fromJson(r){if(r instanceof zu)return r;switch(typeof r){case"undefined":return;case"object":var e=r,n=e.get("families"),t=e.get("size"),s=T.parseEnum(e.get("style"),zr),e=T.parseEnum(e.get("weight"),Ur);return zu.withFamilyList(n,t,s,e);case"string":{n=new Gr(r);n.parse();let e=n.families,t=n.size.toLowerCase(),s=0;switch(t){case"xx-small":s=7;break;case"x-small":s=10;break;case"small":case"smaller":s=13;break;case"medium":s=16;break;case"large":case"larger":s=18;break;case"x-large":s=24;break;case"xx-large":s=32;break;default:try{s=t.endsWith("em")?16*Number.parseFloat(t.substr(0,t.length-2)):t.endsWith("pt")?16*Number.parseFloat(t.substr(0,t.length-2))/12:t.endsWith("px")?Number.parseFloat(t.substr(0,t.length-2)):12}catch{s=12}}let i=0,a=("italic"===n.style&&(i=1),0);switch(n.weight.toLowerCase()){case"normal":case"lighter":break;default:a=1}return zu.withFamilyList(e,s,i,a)}default:return}}static toJson(e){var t;if(e)return(t=new Map).set("families",e.families),t.set("size",e.size),t.set("style",e.style),t.set("weight",e.weight),t}},Yr=class{constructor(){this.topY=0,this.bottomY=0,this.x=0}},Xr=class Xr{constructor(){this.musicFontSize=0,this.oneStaffSpace=0,this.tabLineSpacing=0,this.arrowShaftThickness=0,this.barlineSeparation=0,this.beamSpacing=0,this.beamThickness=0,this.bracketThickness=0,this.dashedBarlineDashLength=0,this.dashedBarlineGapLength=0,this.dashedBarlineThickness=0,this.hairpinThickness=0,this.legerLineThickness=0,this.legerLineExtension=0,this.octaveLineThickness=0,this.pedalLineThickness=0,this.repeatBarlineDotSeparation=0,this.repeatEndingLineThickness=0,this.slurMidpointThickness=0,this.staffLineThickness=0,this.stemThickness=0,this.thickBarlineThickness=0,this.thinBarlineThickness=0,this.thinThickBarlineSeparation=0,this.tieMidpointThickness=0,this.tupletBracketThickness=0,this.stemUp=new Map,this.stemDown=new Map,this.repeatOffsetX=new Map,this.standardStemLength=0,this.stemFlagOffsets=new Map,this.glyphTop=new Map,this.glyphBottom=new Map,this.glyphWidths=new Map,this.glyphHeights=new Map,this.numberedBarRendererBarSize=0,this.numberedBarRendererBarSpacing=0,this.numberedDashGlyphPadding=0,this.numberedDashGlyphWidth=0,this.lineRangedGlyphDashGap=0,this.lineRangedGlyphDashSize=0,this.preNoteEffectPadding=0,this.postNoteEffectPadding=0,this.onNoteEffectPadding=0,this.stringNumberCirclePadding=0,this.rowContainerPadding=0,this.rowContainerGap=0,this.alternateEndingsPadding=0,this.sustainPedalLinePadding=0,this.tieHeight=0,this.beatTimerPadding=0,this.bendNoteHeadElementPadding=0,this.ghostParenthesisWidth=0,this.ghostParenthesisPadding=0,this.brokenBeamWidth=0,this.tabWhammyTextPadding=0,this.tabWhammyPerHalfHeight=0,this.tabWhammyDashSize=0,this.songBookWhammyDipHeight=0,this.deadSlappedLineWidth=0,this.leftHandTabTieWidth=0,this.tabBendDashSize=0,this.tabBendPerValueHeight=0,this.tabBendLabelPadding=0,this.simpleSlideWidth=0,this.simpleSlideHeight=0,this.chordDiagramPaddingX=0,this.chordDiagramPaddingY=0,this.chordDiagramStringSpacing=0,this.chordDiagramFretSpacing=0,this.chordDiagramNutHeight=0,this.chordDiagramFretHeight=0,this.chordDiagramLineWidth=0,this.tripletFeelBracketPadding=0,this.accidentalPadding=0,this.preBeatGlyphSpacing=0,this.tempoNoteScale=.7,this.tuningGlyphCircleNumberScale=.7,this.tuningGlyphStringColumnScale=1.5,this.tuningGlyphStringRowPadding=0,this.directionsScale=.6}static get bravuraDefaults(){let e=Xr._bravuraDefaults;return e||((e=new Xr).fillFromSmufl(Xr.bravuraMetadata),Xr._bravuraDefaults=e),class{static clone(e){var t=new Jr;return t.musicFontSize=e.musicFontSize,t.oneStaffSpace=e.oneStaffSpace,t.tabLineSpacing=e.tabLineSpacing,t.arrowShaftThickness=e.arrowShaftThickness,t.barlineSeparation=e.barlineSeparation,t.beamSpacing=e.beamSpacing,t.beamThickness=e.beamThickness,t.bracketThickness=e.bracketThickness,t.dashedBarlineDashLength=e.dashedBarlineDashLength,t.dashedBarlineGapLength=e.dashedBarlineGapLength,t.dashedBarlineThickness=e.dashedBarlineThickness,t.hairpinThickness=e.hairpinThickness,t.legerLineThickness=e.legerLineThickness,t.legerLineExtension=e.legerLineExtension,t.octaveLineThickness=e.octaveLineThickness,t.pedalLineThickness=e.pedalLineThickness,t.repeatBarlineDotSeparation=e.repeatBarlineDotSeparation,t.repeatEndingLineThickness=e.repeatEndingLineThickness,t.slurMidpointThickness=e.slurMidpointThickness,t.staffLineThickness=e.staffLineThickness,t.stemThickness=e.stemThickness,t.thickBarlineThickness=e.thickBarlineThickness,t.thinBarlineThickness=e.thinBarlineThickness,t.thinThickBarlineSeparation=e.thinThickBarlineSeparation,t.tieMidpointThickness=e.tieMidpointThickness,t.tupletBracketThickness=e.tupletBracketThickness,t.stemUp=new Map(e.stemUp),t.stemDown=new Map(e.stemDown),t.repeatOffsetX=new Map(e.repeatOffsetX),t.standardStemLength=e.standardStemLength,t.stemFlagOffsets=new Map(e.stemFlagOffsets),t.glyphTop=new Map(e.glyphTop),t.glyphBottom=new Map(e.glyphBottom),t.glyphWidths=new Map(e.glyphWidths),t.glyphHeights=new Map(e.glyphHeights),t.numberedBarRendererBarSize=e.numberedBarRendererBarSize,t.numberedBarRendererBarSpacing=e.numberedBarRendererBarSpacing,t.numberedDashGlyphPadding=e.numberedDashGlyphPadding,t.numberedDashGlyphWidth=e.numberedDashGlyphWidth,t.lineRangedGlyphDashGap=e.lineRangedGlyphDashGap,t.lineRangedGlyphDashSize=e.lineRangedGlyphDashSize,t.preNoteEffectPadding=e.preNoteEffectPadding,t.postNoteEffectPadding=e.postNoteEffectPadding,t.onNoteEffectPadding=e.onNoteEffectPadding,t.stringNumberCirclePadding=e.stringNumberCirclePadding,t.rowContainerPadding=e.rowContainerPadding,t.rowContainerGap=e.rowContainerGap,t.alternateEndingsPadding=e.alternateEndingsPadding,t.sustainPedalLinePadding=e.sustainPedalLinePadding,t.tieHeight=e.tieHeight,t.beatTimerPadding=e.beatTimerPadding,t.bendNoteHeadElementPadding=e.bendNoteHeadElementPadding,t.ghostParenthesisWidth=e.ghostParenthesisWidth,t.ghostParenthesisPadding=e.ghostParenthesisPadding,t.brokenBeamWidth=e.brokenBeamWidth,t.tabWhammyTextPadding=e.tabWhammyTextPadding,t.tabWhammyPerHalfHeight=e.tabWhammyPerHalfHeight,t.tabWhammyDashSize=e.tabWhammyDashSize,t.songBookWhammyDipHeight=e.songBookWhammyDipHeight,t.deadSlappedLineWidth=e.deadSlappedLineWidth,t.leftHandTabTieWidth=e.leftHandTabTieWidth,t.tabBendDashSize=e.tabBendDashSize,t.tabBendPerValueHeight=e.tabBendPerValueHeight,t.tabBendLabelPadding=e.tabBendLabelPadding,t.simpleSlideWidth=e.simpleSlideWidth,t.simpleSlideHeight=e.simpleSlideHeight,t.chordDiagramPaddingX=e.chordDiagramPaddingX,t.chordDiagramPaddingY=e.chordDiagramPaddingY,t.chordDiagramStringSpacing=e.chordDiagramStringSpacing,t.chordDiagramFretSpacing=e.chordDiagramFretSpacing,t.chordDiagramNutHeight=e.chordDiagramNutHeight,t.chordDiagramFretHeight=e.chordDiagramFretHeight,t.chordDiagramLineWidth=e.chordDiagramLineWidth,t.tripletFeelBracketPadding=e.tripletFeelBracketPadding,t.accidentalPadding=e.accidentalPadding,t.preBeatGlyphSpacing=e.preBeatGlyphSpacing,t.tempoNoteScale=e.tempoNoteScale,t.tuningGlyphCircleNumberScale=e.tuningGlyphCircleNumberScale,t.tuningGlyphStringColumnScale=e.tuningGlyphStringColumnScale,t.tuningGlyphStringRowPadding=e.tuningGlyphStringRowPadding,t.directionsScale=e.directionsScale,t}}.clone(e)}hasSymbol(e){return 0<this.glyphWidths.get(e)&&0<this.glyphHeights.get(e)}fillFromSmufl(e,t=36){this.musicFontSize=t,this.oneStaffSpace=t/4,this.tabLineSpacing=Math.floor(1.5*this.oneStaffSpace),this.arrowShaftThickness=e.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=e.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=e.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=e.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=e.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=e.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=e.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=e.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=e.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=e.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=e.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=e.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=e.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=e.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=e.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=e.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=e.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=e.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=e.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=e.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,"number"==typeof e.engravingDefaults.thinThickBarlineSeparation?this.thinThickBarlineSeparation=e.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=e.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=e.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=e.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;var s,i,t=3*this.oneStaffSpace;this.standardStemLength=t,this.stemFlagOffsets.set(-4,0),this.stemFlagOffsets.set(-2,0),this.stemFlagOffsets.set(1,0),this.stemFlagOffsets.set(2,0),this.stemFlagOffsets.set(4,0),this.stemFlagOffsets.set(8,0),this.stemFlagOffsets.set(16,0),this.stemFlagOffsets.set(32,0),this.stemFlagOffsets.set(64,0),this.stemFlagOffsets.set(128,0),this.stemFlagOffsets.set(256,0);for([s,i]of Object.entries(e.glyphsWithAnchors)){var a,r,n=Xr._smuflNameToMusicFontSymbol(s);if(n)if(i.stemDownNW&&((a=new Yr).x=i.stemDownNW[0]*this.oneStaffSpace,a.topY=i.stemDownNW[1]*this.oneStaffSpace,i.stemDownSW?a.bottomY=i.stemDownSW[1]*this.oneStaffSpace:a.bottomY=0,this.stemDown.set(n,a)),i.stemUpSE&&(a=new Yr,r=i.stemUpSE[0]*this.oneStaffSpace,a.bottomY=i.stemUpSE[1]*this.oneStaffSpace,i.stemUpNW?(a.x=i.stemUpNW[0]*this.oneStaffSpace,a.topY=i.stemUpNW[1]*this.oneStaffSpace):(a.x=r-this.stemThickness,a.topY=0),this.stemUp.set(n,a)),i.repeatOffset&&this.repeatOffsetX.set(n,i.repeatOffset[0]*this.oneStaffSpace),i.stemUpNW){var o=i.stemUpNW[1]*this.oneStaffSpace;switch(n){case 57920:this.stemFlagOffsets.set(8,o);break;case 57922:this.stemFlagOffsets.set(16,o);break;case 57924:this.stemFlagOffsets.set(32,o);break;case 57926:this.stemFlagOffsets.set(64,o);break;case 57928:this.stemFlagOffsets.set(128,o);break;case 57930:this.stemFlagOffsets.set(256,o)}}}var h=new Set,t=e.glyphBBoxes;if(t)for(var[l,d]of Object.entries(t)){l=Xr._smuflNameToMusicFontSymbol(l);l&&(h.add(l),this.glyphTop.set(l,d.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(l,d.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(l,(d.bBoxNE[0]-d.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(l,(d.bBoxNE[1]-d.bBoxSW[1])*this.oneStaffSpace))}var c,u=new Set([-1,32,57509]);for(c of F.getAllMusicFontSymbols())h.has(c)||(u.has(c)||M.warning("SmuFL",`The provided SmuFL font is missing the glyph ${Qe[c]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(c,0),this.glyphBottom.set(c,0),this.glyphWidths.set(c,0),this.glyphHeights.set(c,0));this.numberedBarRendererBarSize=+this.staffLineThickness,this.numberedBarRendererBarSpacing=this.beamSpacing+this.numberedBarRendererBarSize,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=+this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(+this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=+this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static _smuflNameToMusicFontSymbol(e){e=Xr.smuflNameToGlyphNameMapping.has(e)?Xr.smuflNameToGlyphNameMapping.get(e):e.substring(0,1).toUpperCase()+e.substring(1);return T.parseEnumExact(e,Qe)}},Jr=(Xr.smuflNameToGlyphNameMapping=new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]]),Xr.bravuraMetadata={engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}},Xr),qr=class qr{constructor(){this.engravingSettings=Jr.bravuraDefaults,this.copyrightFont=new A(qr._sansFont,12,0,1),this.titleFont=new A(qr._serifFont,32,0),this.subTitleFont=new A(qr._serifFont,20,0),this.wordsFont=new A(qr._serifFont,15,0),this.effectFont=new A(qr._serifFont,12,1),this.timerFont=new A(qr._serifFont,12,0),this.directionsFont=new A(qr._serifFont,14,0),this.fretboardNumberFont=new A(qr._sansFont,11,0),this.numberedNotationFont=new A(qr._sansFont,16,0),this.numberedNotationGraceFont=new A(qr._sansFont,14,0),this.tablatureFont=new A(qr._sansFont,14,0),this.graceFont=new A(qr._sansFont,12,0),this.staffLineColor=new Ut(165,165,165,255),this.barSeparatorColor=new Ut(34,34,17,255),this.barNumberFont=new A(qr._sansFont,11,0),this.barNumberColor=new Ut(200,0,0,255),this.fingeringFont=new A(qr._serifFont,14,0),this.inlineFingeringFont=new A(qr._serifFont,12,0),this.markerFont=new A(qr._serifFont,14,0,1),this.mainGlyphColor=new Ut(0,0,0,255),this.secondaryGlyphColor=new Ut(0,0,0,100),this.scoreInfoColor=new Ut(0,0,0,255)}getFontForElement(e){switch(e){case 0:return this.titleFont;case 1:case 2:case 3:return this.subTitleFont;case 4:case 5:case 6:case 7:return this.wordsFont;case 8:case 9:return this.copyrightFont}return this.wordsFont}},jr=(qr._sansFont="Arial, sans-serif",qr._serifFont="Georgia, serif",qr),$r=((t=$r||{})[t.Default=0]="Default",t[t.ScoreTab=1]="ScoreTab",t[t.Score=2]="Score",t[t.Tab=3]="Tab",t[t.TabMixed=4]="TabMixed",t),Kr=((d=Kr||{})[d.Automatic=0]="Automatic",d[d.UseModelLayout=1]="UseModelLayout",d),Qr=class{constructor(){this.scale=1,this.stretchForce=1,this.layoutMode=0,this.staveProfile=0,this.barsPerRow=-1,this.startBar=1,this.barCount=-1,this.barCountPerPartial=10,this.justifyLastSystem=!1,this.resources=new jr,this.padding=[35,35],this.firstSystemPaddingTop=5,this.systemPaddingTop=10,this.systemPaddingBottom=10,this.lastSystemPaddingBottom=0,this.systemLabelPaddingLeft=0,this.systemLabelPaddingRight=3,this.accoladeBarPaddingRight=3,this.notationStaffPaddingTop=5,this.notationStaffPaddingBottom=5,this.effectStaffPaddingTop=0,this.effectStaffPaddingBottom=0,this.firstStaffPaddingLeft=6,this.staffPaddingLeft=2,this.effectBandPaddingBottom=2,this.systemsLayoutMode=0}},Zr=class{constructor(){this.encoding="utf-8",this.mergePartGroupsInMusicXml=!1,this.beatTextAsLyrics=!1}},en=((ct=en||{})[ct.Off=0]="Off",ct[ct.Continuous=1]="Continuous",ct[ct.OffScreen=2]="OffScreen",ct),tn=class{constructor(){this.noteWideLength=240,this.noteWideAmplitude=1,this.noteSlightLength=360,this.noteSlightAmplitude=.5,this.beatWideLength=480,this.beatWideAmplitude=2,this.beatSlightLength=480,this.beatSlightAmplitude=2}},sn=class{constructor(){this.simpleSlidePitchOffset=6,this.simpleSlideDurationRatio=.25,this.shiftSlideDurationRatio=.5}},an=((c=an||{})[c.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",c[c.WebAudioScriptProcessor=1]="WebAudioScriptProcessor",c),rn=((s=rn||{})[s.Disabled=0]="Disabled",s[s.EnabledAutomatic=1]="EnabledAutomatic",s[s.EnabledSynthesizer=2]="EnabledSynthesizer",s[s.EnabledBackingTrack=3]="EnabledBackingTrack",s[s.EnabledExternalMedia=4]="EnabledExternalMedia",s),nn=class{constructor(){this.soundFont=null,this.scrollElement="html,body",this.outputMode=0,this.enablePlayer=!1,this.playerMode=0,this.enableCursor=!0,this.enableAnimatedBeatCursor=!0,this.enableElementHighlighting=!0,this.enableUserInteraction=!0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollMode=1,this.scrollSpeed=300,this.nativeBrowserSmoothScroll=!0,this.songBookBendDuration=75,this.songBookDipDuration=150,this.vibrato=new tn,this.slide=new sn,this.playTripletFeel=!0,this.bufferTimeInMilliseconds=500}},on=class Uu{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Uu.setProperty(s,t.toLowerCase(),e))}static toJson(e){if(!e)return null;var t=new Map;if(t.set("scriptfile",e.scriptFile),t.set("fontdirectory",e.fontDirectory),null!==e.smuflFontSources){var s,i,a=new Map;t.set("smuflfontsources",a);for([s,i]of e.smuflFontSources)a.set(s.toString(),i)}return t.set("file",e.file),t.set("tex",e.tex),t.set("tracks",e.tracks),t.set("enablelazyloading",e.enableLazyLoading),t.set("engine",e.engine),t.set("loglevel",e.logLevel),t.set("useworkers",e.useWorkers),t.set("includenotebounds",e.includeNoteBounds),t}static setProperty(s,e,t){switch(e){case"scriptfile":return s.scriptFile=t,!0;case"fontdirectory":return s.fontDirectory=t,!0;case"smuflfontsources":return s.smuflFontSources=new Map,T.forEach(t,(e,t)=>{s.smuflFontSources.set(T.parseEnum(t,Ac),e)}),!0;case"file":return s.file=t,!0;case"tex":return s.tex=t,!0;case"tracks":return s.tracks=t,!0;case"enablelazyloading":return s.enableLazyLoading=t,!0;case"engine":return s.engine=t,!0;case"loglevel":return s.logLevel=T.parseEnum(t,ye),!0;case"useworkers":return s.useWorkers=t,!0;case"includenotebounds":return s.includeNoteBounds=t,!0}return!1}},hn=class Yu{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Yu.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("topy",e.topY),t.set("bottomy",e.bottomY),t.set("x",e.x),t):null}static setProperty(e,t,s){switch(t){case"topy":return e.topY=s,!0;case"bottomy":return e.bottomY=s,!0;case"x":return e.x=s,!0}return!1}},ln=class Xu{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Xu.setProperty(s,t.toLowerCase(),e))}static toJson(e){if(!e)return null;var t,s,i=new Map,a=(i.set("musicfontsize",e.musicFontSize),i.set("onestaffspace",e.oneStaffSpace),i.set("tablinespacing",e.tabLineSpacing),i.set("arrowshaftthickness",e.arrowShaftThickness),i.set("barlineseparation",e.barlineSeparation),i.set("beamspacing",e.beamSpacing),i.set("beamthickness",e.beamThickness),i.set("bracketthickness",e.bracketThickness),i.set("dashedbarlinedashlength",e.dashedBarlineDashLength),i.set("dashedbarlinegaplength",e.dashedBarlineGapLength),i.set("dashedbarlinethickness",e.dashedBarlineThickness),i.set("hairpinthickness",e.hairpinThickness),i.set("legerlinethickness",e.legerLineThickness),i.set("legerlineextension",e.legerLineExtension),i.set("octavelinethickness",e.octaveLineThickness),i.set("pedallinethickness",e.pedalLineThickness),i.set("repeatbarlinedotseparation",e.repeatBarlineDotSeparation),i.set("repeatendinglinethickness",e.repeatEndingLineThickness),i.set("slurmidpointthickness",e.slurMidpointThickness),i.set("stafflinethickness",e.staffLineThickness),i.set("stemthickness",e.stemThickness),i.set("thickbarlinethickness",e.thickBarlineThickness),i.set("thinbarlinethickness",e.thinBarlineThickness),i.set("thinthickbarlineseparation",e.thinThickBarlineSeparation),i.set("tiemidpointthickness",e.tieMidpointThickness),i.set("tupletbracketthickness",e.tupletBracketThickness),new Map);i.set("stemup",a);for([t,s]of e.stemUp)a.set(t.toString(),hn.toJson(s));var r,n,o=new Map;i.set("stemdown",o);for([r,n]of e.stemDown)o.set(r.toString(),hn.toJson(n));var h,l,d=new Map;i.set("repeatoffsetx",d);for([h,l]of e.repeatOffsetX)d.set(h.toString(),l);i.set("standardstemlength",e.standardStemLength);var c,u,p=new Map;i.set("stemflagoffsets",p);for([c,u]of e.stemFlagOffsets)p.set(c.toString(),u);var m,g,f=new Map;i.set("glyphtop",f);for([m,g]of e.glyphTop)f.set(m.toString(),g);var b,y,_=new Map;i.set("glyphbottom",_);for([b,y]of e.glyphBottom)_.set(b.toString(),y);var S,v,k=new Map;i.set("glyphwidths",k);for([S,v]of e.glyphWidths)k.set(S.toString(),v);var w,T,B=new Map;i.set("glyphheights",B);for([w,T]of e.glyphHeights)B.set(w.toString(),T);return i.set("numberedbarrendererbarsize",e.numberedBarRendererBarSize),i.set("numberedbarrendererbarspacing",e.numberedBarRendererBarSpacing),i.set("numbereddashglyphpadding",e.numberedDashGlyphPadding),i.set("numbereddashglyphwidth",e.numberedDashGlyphWidth),i.set("linerangedglyphdashgap",e.lineRangedGlyphDashGap),i.set("linerangedglyphdashsize",e.lineRangedGlyphDashSize),i.set("prenoteeffectpadding",e.preNoteEffectPadding),i.set("postnoteeffectpadding",e.postNoteEffectPadding),i.set("onnoteeffectpadding",e.onNoteEffectPadding),i.set("stringnumbercirclepadding",e.stringNumberCirclePadding),i.set("rowcontainerpadding",e.rowContainerPadding),i.set("rowcontainergap",e.rowContainerGap),i.set("alternateendingspadding",e.alternateEndingsPadding),i.set("sustainpedallinepadding",e.sustainPedalLinePadding),i.set("tieheight",e.tieHeight),i.set("beattimerpadding",e.beatTimerPadding),i.set("bendnoteheadelementpadding",e.bendNoteHeadElementPadding),i.set("ghostparenthesiswidth",e.ghostParenthesisWidth),i.set("ghostparenthesispadding",e.ghostParenthesisPadding),i.set("brokenbeamwidth",e.brokenBeamWidth),i.set("tabwhammytextpadding",e.tabWhammyTextPadding),i.set("tabwhammyperhalfheight",e.tabWhammyPerHalfHeight),i.set("tabwhammydashsize",e.tabWhammyDashSize),i.set("songbookwhammydipheight",e.songBookWhammyDipHeight),i.set("deadslappedlinewidth",e.deadSlappedLineWidth),i.set("lefthandtabtiewidth",e.leftHandTabTieWidth),i.set("tabbenddashsize",e.tabBendDashSize),i.set("tabbendpervalueheight",e.tabBendPerValueHeight),i.set("tabbendlabelpadding",e.tabBendLabelPadding),i.set("simpleslidewidth",e.simpleSlideWidth),i.set("simpleslideheight",e.simpleSlideHeight),i.set("chorddiagrampaddingx",e.chordDiagramPaddingX),i.set("chorddiagrampaddingy",e.chordDiagramPaddingY),i.set("chorddiagramstringspacing",e.chordDiagramStringSpacing),i.set("chorddiagramfretspacing",e.chordDiagramFretSpacing),i.set("chorddiagramnutheight",e.chordDiagramNutHeight),i.set("chorddiagramfretheight",e.chordDiagramFretHeight),i.set("chorddiagramlinewidth",e.chordDiagramLineWidth),i.set("tripletfeelbracketpadding",e.tripletFeelBracketPadding),i.set("accidentalpadding",e.accidentalPadding),i.set("prebeatglyphspacing",e.preBeatGlyphSpacing),i.set("temponotescale",e.tempoNoteScale),i.set("tuningglyphcirclenumberscale",e.tuningGlyphCircleNumberScale),i.set("tuningglyphstringcolumnscale",e.tuningGlyphStringColumnScale),i.set("tuningglyphstringrowpadding",e.tuningGlyphStringRowPadding),i.set("directionsscale",e.directionsScale),i}static setProperty(i,e,t){switch(e){case"musicfontsize":return i.musicFontSize=t,!0;case"onestaffspace":return i.oneStaffSpace=t,!0;case"tablinespacing":return i.tabLineSpacing=t,!0;case"arrowshaftthickness":return i.arrowShaftThickness=t,!0;case"barlineseparation":return i.barlineSeparation=t,!0;case"beamspacing":return i.beamSpacing=t,!0;case"beamthickness":return i.beamThickness=t,!0;case"bracketthickness":return i.bracketThickness=t,!0;case"dashedbarlinedashlength":return i.dashedBarlineDashLength=t,!0;case"dashedbarlinegaplength":return i.dashedBarlineGapLength=t,!0;case"dashedbarlinethickness":return i.dashedBarlineThickness=t,!0;case"hairpinthickness":return i.hairpinThickness=t,!0;case"legerlinethickness":return i.legerLineThickness=t,!0;case"legerlineextension":return i.legerLineExtension=t,!0;case"octavelinethickness":return i.octaveLineThickness=t,!0;case"pedallinethickness":return i.pedalLineThickness=t,!0;case"repeatbarlinedotseparation":return i.repeatBarlineDotSeparation=t,!0;case"repeatendinglinethickness":return i.repeatEndingLineThickness=t,!0;case"slurmidpointthickness":return i.slurMidpointThickness=t,!0;case"stafflinethickness":return i.staffLineThickness=t,!0;case"stemthickness":return i.stemThickness=t,!0;case"thickbarlinethickness":return i.thickBarlineThickness=t,!0;case"thinbarlinethickness":return i.thinBarlineThickness=t,!0;case"thinthickbarlineseparation":return i.thinThickBarlineSeparation=t,!0;case"tiemidpointthickness":return i.tieMidpointThickness=t,!0;case"tupletbracketthickness":return i.tupletBracketThickness=t,!0;case"stemup":return i.stemUp=new Map,T.forEach(t,(e,t)=>{var s=new Yr;hn.fromJson(s,e),i.stemUp.set(T.parseEnum(t,Qe),s)}),!0;case"stemdown":return i.stemDown=new Map,T.forEach(t,(e,t)=>{var s=new Yr;hn.fromJson(s,e),i.stemDown.set(T.parseEnum(t,Qe),s)}),!0;case"repeatoffsetx":return i.repeatOffsetX=new Map,T.forEach(t,(e,t)=>{i.repeatOffsetX.set(T.parseEnum(t,Qe),e)}),!0;case"standardstemlength":return i.standardStemLength=t,!0;case"stemflagoffsets":return i.stemFlagOffsets=new Map,T.forEach(t,(e,t)=>{i.stemFlagOffsets.set(T.parseEnum(t,se),e)}),!0;case"glyphtop":return i.glyphTop=new Map,T.forEach(t,(e,t)=>{i.glyphTop.set(T.parseEnum(t,Qe),e)}),!0;case"glyphbottom":return i.glyphBottom=new Map,T.forEach(t,(e,t)=>{i.glyphBottom.set(T.parseEnum(t,Qe),e)}),!0;case"glyphwidths":return i.glyphWidths=new Map,T.forEach(t,(e,t)=>{i.glyphWidths.set(T.parseEnum(t,Qe),e)}),!0;case"glyphheights":return i.glyphHeights=new Map,T.forEach(t,(e,t)=>{i.glyphHeights.set(T.parseEnum(t,Qe),e)}),!0;case"numberedbarrendererbarsize":return i.numberedBarRendererBarSize=t,!0;case"numberedbarrendererbarspacing":return i.numberedBarRendererBarSpacing=t,!0;case"numbereddashglyphpadding":return i.numberedDashGlyphPadding=t,!0;case"numbereddashglyphwidth":return i.numberedDashGlyphWidth=t,!0;case"linerangedglyphdashgap":return i.lineRangedGlyphDashGap=t,!0;case"linerangedglyphdashsize":return i.lineRangedGlyphDashSize=t,!0;case"prenoteeffectpadding":return i.preNoteEffectPadding=t,!0;case"postnoteeffectpadding":return i.postNoteEffectPadding=t,!0;case"onnoteeffectpadding":return i.onNoteEffectPadding=t,!0;case"stringnumbercirclepadding":return i.stringNumberCirclePadding=t,!0;case"rowcontainerpadding":return i.rowContainerPadding=t,!0;case"rowcontainergap":return i.rowContainerGap=t,!0;case"alternateendingspadding":return i.alternateEndingsPadding=t,!0;case"sustainpedallinepadding":return i.sustainPedalLinePadding=t,!0;case"tieheight":return i.tieHeight=t,!0;case"beattimerpadding":return i.beatTimerPadding=t,!0;case"bendnoteheadelementpadding":return i.bendNoteHeadElementPadding=t,!0;case"ghostparenthesiswidth":return i.ghostParenthesisWidth=t,!0;case"ghostparenthesispadding":return i.ghostParenthesisPadding=t,!0;case"brokenbeamwidth":return i.brokenBeamWidth=t,!0;case"tabwhammytextpadding":return i.tabWhammyTextPadding=t,!0;case"tabwhammyperhalfheight":return i.tabWhammyPerHalfHeight=t,!0;case"tabwhammydashsize":return i.tabWhammyDashSize=t,!0;case"songbookwhammydipheight":return i.songBookWhammyDipHeight=t,!0;case"deadslappedlinewidth":return i.deadSlappedLineWidth=t,!0;case"lefthandtabtiewidth":return i.leftHandTabTieWidth=t,!0;case"tabbenddashsize":return i.tabBendDashSize=t,!0;case"tabbendpervalueheight":return i.tabBendPerValueHeight=t,!0;case"tabbendlabelpadding":return i.tabBendLabelPadding=t,!0;case"simpleslidewidth":return i.simpleSlideWidth=t,!0;case"simpleslideheight":return i.simpleSlideHeight=t,!0;case"chorddiagrampaddingx":return i.chordDiagramPaddingX=t,!0;case"chorddiagrampaddingy":return i.chordDiagramPaddingY=t,!0;case"chorddiagramstringspacing":return i.chordDiagramStringSpacing=t,!0;case"chorddiagramfretspacing":return i.chordDiagramFretSpacing=t,!0;case"chorddiagramnutheight":return i.chordDiagramNutHeight=t,!0;case"chorddiagramfretheight":return i.chordDiagramFretHeight=t,!0;case"chorddiagramlinewidth":return i.chordDiagramLineWidth=t,!0;case"tripletfeelbracketpadding":return i.tripletFeelBracketPadding=t,!0;case"accidentalpadding":return i.accidentalPadding=t,!0;case"prebeatglyphspacing":return i.preBeatGlyphSpacing=t,!0;case"temponotescale":return i.tempoNoteScale=t,!0;case"tuningglyphcirclenumberscale":return i.tuningGlyphCircleNumberScale=t,!0;case"tuningglyphstringcolumnscale":return i.tuningGlyphStringColumnScale=t,!0;case"tuningglyphstringrowpadding":return i.tuningGlyphStringRowPadding=t,!0;case"directionsscale":return i.directionsScale=t,!0}return!1}},dn=class Ju{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Ju.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("smuflfontfamilyname",e.smuflFontFamilyName),t.set("engravingsettings",ln.toJson(e.engravingSettings)),t.set("copyrightfont",A.toJson(e.copyrightFont)),t.set("titlefont",A.toJson(e.titleFont)),t.set("subtitlefont",A.toJson(e.subTitleFont)),t.set("wordsfont",A.toJson(e.wordsFont)),t.set("effectfont",A.toJson(e.effectFont)),t.set("timerfont",A.toJson(e.timerFont)),t.set("directionsfont",A.toJson(e.directionsFont)),t.set("fretboardnumberfont",A.toJson(e.fretboardNumberFont)),t.set("numberednotationfont",A.toJson(e.numberedNotationFont)),t.set("numberednotationgracefont",A.toJson(e.numberedNotationGraceFont)),t.set("tablaturefont",A.toJson(e.tablatureFont)),t.set("gracefont",A.toJson(e.graceFont)),t.set("stafflinecolor",Ut.toJson(e.staffLineColor)),t.set("barseparatorcolor",Ut.toJson(e.barSeparatorColor)),t.set("barnumberfont",A.toJson(e.barNumberFont)),t.set("barnumbercolor",Ut.toJson(e.barNumberColor)),t.set("fingeringfont",A.toJson(e.fingeringFont)),t.set("inlinefingeringfont",A.toJson(e.inlineFingeringFont)),t.set("markerfont",A.toJson(e.markerFont)),t.set("mainglyphcolor",Ut.toJson(e.mainGlyphColor)),t.set("secondaryglyphcolor",Ut.toJson(e.secondaryGlyphColor)),t.set("scoreinfocolor",Ut.toJson(e.scoreInfoColor)),t):null}static setProperty(e,t,s){switch(t){case"smuflfontfamilyname":return e.smuflFontFamilyName=s,!0;case"copyrightfont":return e.copyrightFont=A.fromJson(s),!0;case"titlefont":return e.titleFont=A.fromJson(s),!0;case"subtitlefont":return e.subTitleFont=A.fromJson(s),!0;case"wordsfont":return e.wordsFont=A.fromJson(s),!0;case"effectfont":return e.effectFont=A.fromJson(s),!0;case"timerfont":return e.timerFont=A.fromJson(s),!0;case"directionsfont":return e.directionsFont=A.fromJson(s),!0;case"fretboardnumberfont":return e.fretboardNumberFont=A.fromJson(s),!0;case"numberednotationfont":return e.numberedNotationFont=A.fromJson(s),!0;case"numberednotationgracefont":return e.numberedNotationGraceFont=A.fromJson(s),!0;case"tablaturefont":return e.tablatureFont=A.fromJson(s),!0;case"gracefont":return e.graceFont=A.fromJson(s),!0;case"stafflinecolor":return e.staffLineColor=Ut.fromJson(s),!0;case"barseparatorcolor":return e.barSeparatorColor=Ut.fromJson(s),!0;case"barnumberfont":return e.barNumberFont=A.fromJson(s),!0;case"barnumbercolor":return e.barNumberColor=Ut.fromJson(s),!0;case"fingeringfont":return e.fingeringFont=A.fromJson(s),!0;case"inlinefingeringfont":return e.inlineFingeringFont=A.fromJson(s),!0;case"markerfont":return e.markerFont=A.fromJson(s),!0;case"mainglyphcolor":return e.mainGlyphColor=Ut.fromJson(s),!0;case"secondaryglyphcolor":return e.secondaryGlyphColor=Ut.fromJson(s),!0;case"scoreinfocolor":return e.scoreInfoColor=Ut.fromJson(s),!0}return 0<=["engravingsettings"].indexOf(t)&&(ln.fromJson(e.engravingSettings,s),!0)}},cn=class qu{static fromJson(s,e){e&&T.forEach(e,(e,t)=>qu.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("scale",e.scale),t.set("stretchforce",e.stretchForce),t.set("layoutmode",e.layoutMode),t.set("staveprofile",e.staveProfile),t.set("barsperrow",e.barsPerRow),t.set("startbar",e.startBar),t.set("barcount",e.barCount),t.set("barcountperpartial",e.barCountPerPartial),t.set("justifylastsystem",e.justifyLastSystem),t.set("resources",dn.toJson(e.resources)),t.set("padding",e.padding),t.set("firstsystempaddingtop",e.firstSystemPaddingTop),t.set("systempaddingtop",e.systemPaddingTop),t.set("systempaddingbottom",e.systemPaddingBottom),t.set("lastsystempaddingbottom",e.lastSystemPaddingBottom),t.set("systemlabelpaddingleft",e.systemLabelPaddingLeft),t.set("systemlabelpaddingright",e.systemLabelPaddingRight),t.set("accoladebarpaddingright",e.accoladeBarPaddingRight),t.set("notationstaffpaddingtop",e.notationStaffPaddingTop),t.set("notationstaffpaddingbottom",e.notationStaffPaddingBottom),t.set("effectstaffpaddingtop",e.effectStaffPaddingTop),t.set("effectstaffpaddingbottom",e.effectStaffPaddingBottom),t.set("firststaffpaddingleft",e.firstStaffPaddingLeft),t.set("staffpaddingleft",e.staffPaddingLeft),t.set("effectbandpaddingbottom",e.effectBandPaddingBottom),t.set("systemslayoutmode",e.systemsLayoutMode),t):null}static setProperty(e,t,s){switch(t){case"scale":return e.scale=s,!0;case"stretchforce":return e.stretchForce=s,!0;case"layoutmode":return e.layoutMode=T.parseEnum(s,as),!0;case"staveprofile":return e.staveProfile=T.parseEnum(s,$r),!0;case"barsperrow":return e.barsPerRow=s,!0;case"startbar":return e.startBar=s,!0;case"barcount":return e.barCount=s,!0;case"barcountperpartial":return e.barCountPerPartial=s,!0;case"justifylastsystem":return e.justifyLastSystem=s,!0;case"padding":return e.padding=s,!0;case"firstsystempaddingtop":return e.firstSystemPaddingTop=s,!0;case"systempaddingtop":return e.systemPaddingTop=s,!0;case"systempaddingbottom":return e.systemPaddingBottom=s,!0;case"lastsystempaddingbottom":return e.lastSystemPaddingBottom=s,!0;case"systemlabelpaddingleft":return e.systemLabelPaddingLeft=s,!0;case"systemlabelpaddingright":return e.systemLabelPaddingRight=s,!0;case"accoladebarpaddingright":return e.accoladeBarPaddingRight=s,!0;case"notationstaffpaddingtop":return e.notationStaffPaddingTop=s,!0;case"notationstaffpaddingbottom":return e.notationStaffPaddingBottom=s,!0;case"effectstaffpaddingtop":return e.effectStaffPaddingTop=s,!0;case"effectstaffpaddingbottom":return e.effectStaffPaddingBottom=s,!0;case"firststaffpaddingleft":return e.firstStaffPaddingLeft=s,!0;case"staffpaddingleft":return e.staffPaddingLeft=s,!0;case"effectbandpaddingbottom":return e.effectBandPaddingBottom=s,!0;case"systemslayoutmode":return e.systemsLayoutMode=T.parseEnum(s,Kr),!0}if(0<=["resources"].indexOf(t))return dn.fromJson(e.resources,s),!0;for(var i of["resources"])if(0===t.indexOf(i)&&dn.setProperty(e.resources,t.substring(i.length),s))return!0;return!1}},un=class ju{static fromJson(s,e){e&&T.forEach(e,(e,t)=>ju.setProperty(s,t.toLowerCase(),e))}static toJson(e){if(!e)return null;var t,s,i=new Map,a=(i.set("notationmode",e.notationMode),i.set("fingeringmode",e.fingeringMode),new Map);i.set("elements",a);for([t,s]of e.elements)a.set(t.toString(),s);return i.set("rhythmmode",e.rhythmMode),i.set("rhythmheight",e.rhythmHeight),i.set("transpositionpitches",e.transpositionPitches),i.set("displaytranspositionpitches",e.displayTranspositionPitches),i.set("smallgracetabnotes",e.smallGraceTabNotes),i.set("extendbendarrowsontiednotes",e.extendBendArrowsOnTiedNotes),i.set("extendlineeffectstobeatend",e.extendLineEffectsToBeatEnd),i.set("slurheight",e.slurHeight),i.set("showchorddiagramsonbeats",e.showChordDiagramsOnBeats),i}static setProperty(s,e,t){switch(e){case"notationmode":return s.notationMode=T.parseEnum(t,me),!0;case"fingeringmode":return s.fingeringMode=T.parseEnum(t,pe),!0;case"elements":return s.elements=new Map,T.forEach(t,(e,t)=>{s.elements.set(T.parseEnum(t,ge),e)}),!0;case"rhythmmode":return s.rhythmMode=T.parseEnum(t,ue),!0;case"rhythmheight":return s.rhythmHeight=t,!0;case"transpositionpitches":return s.transpositionPitches=t,!0;case"displaytranspositionpitches":return s.displayTranspositionPitches=t,!0;case"smallgracetabnotes":return s.smallGraceTabNotes=t,!0;case"extendbendarrowsontiednotes":return s.extendBendArrowsOnTiedNotes=t,!0;case"extendlineeffectstobeatend":return s.extendLineEffectsToBeatEnd=t,!0;case"slurheight":return s.slurHeight=t,!0;case"showchorddiagramsonbeats":return s.showChordDiagramsOnBeats=t,!0}return!1}},pn=class $u{static fromJson(s,e){e&&T.forEach(e,(e,t)=>$u.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("encoding",e.encoding),t.set("mergepartgroupsinmusicxml",e.mergePartGroupsInMusicXml),t.set("beattextaslyrics",e.beatTextAsLyrics),t):null}static setProperty(e,t,s){switch(t){case"encoding":return e.encoding=s,!0;case"mergepartgroupsinmusicxml":return e.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return e.beatTextAsLyrics=s,!0}return!1}},mn=class Ku{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Ku.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("notewidelength",e.noteWideLength),t.set("notewideamplitude",e.noteWideAmplitude),t.set("noteslightlength",e.noteSlightLength),t.set("noteslightamplitude",e.noteSlightAmplitude),t.set("beatwidelength",e.beatWideLength),t.set("beatwideamplitude",e.beatWideAmplitude),t.set("beatslightlength",e.beatSlightLength),t.set("beatslightamplitude",e.beatSlightAmplitude),t):null}static setProperty(e,t,s){switch(t){case"notewidelength":return e.noteWideLength=s,!0;case"notewideamplitude":return e.noteWideAmplitude=s,!0;case"noteslightlength":return e.noteSlightLength=s,!0;case"noteslightamplitude":return e.noteSlightAmplitude=s,!0;case"beatwidelength":return e.beatWideLength=s,!0;case"beatwideamplitude":return e.beatWideAmplitude=s,!0;case"beatslightlength":return e.beatSlightLength=s,!0;case"beatslightamplitude":return e.beatSlightAmplitude=s,!0}return!1}},gn=class Qu{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Qu.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("simpleslidepitchoffset",e.simpleSlidePitchOffset),t.set("simpleslidedurationratio",e.simpleSlideDurationRatio),t.set("shiftslidedurationratio",e.shiftSlideDurationRatio),t):null}static setProperty(e,t,s){switch(t){case"simpleslidepitchoffset":return e.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return e.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return e.shiftSlideDurationRatio=s,!0}return!1}},fn=class Zu{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Zu.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("soundfont",e.soundFont),t.set("outputmode",e.outputMode),t.set("enableplayer",e.enablePlayer),t.set("playermode",e.playerMode),t.set("enablecursor",e.enableCursor),t.set("enableanimatedbeatcursor",e.enableAnimatedBeatCursor),t.set("enableelementhighlighting",e.enableElementHighlighting),t.set("enableuserinteraction",e.enableUserInteraction),t.set("scrolloffsetx",e.scrollOffsetX),t.set("scrolloffsety",e.scrollOffsetY),t.set("scrollmode",e.scrollMode),t.set("scrollspeed",e.scrollSpeed),t.set("nativebrowsersmoothscroll",e.nativeBrowserSmoothScroll),t.set("songbookbendduration",e.songBookBendDuration),t.set("songbookdipduration",e.songBookDipDuration),t.set("vibrato",mn.toJson(e.vibrato)),t.set("slide",gn.toJson(e.slide)),t.set("playtripletfeel",e.playTripletFeel),t.set("buffertimeinmilliseconds",e.bufferTimeInMilliseconds),t):null}static setProperty(e,t,s){switch(t){case"soundfont":return e.soundFont=s,!0;case"scrollelement":return e.scrollElement=s,!0;case"outputmode":return e.outputMode=T.parseEnum(s,an),!0;case"enableplayer":return e.enablePlayer=s,!0;case"playermode":return e.playerMode=T.parseEnum(s,rn),!0;case"enablecursor":return e.enableCursor=s,!0;case"enableanimatedbeatcursor":return e.enableAnimatedBeatCursor=s,!0;case"enableelementhighlighting":return e.enableElementHighlighting=s,!0;case"enableuserinteraction":return e.enableUserInteraction=s,!0;case"scrolloffsetx":return e.scrollOffsetX=s,!0;case"scrolloffsety":return e.scrollOffsetY=s,!0;case"scrollmode":return e.scrollMode=T.parseEnum(s,en),!0;case"scrollspeed":return e.scrollSpeed=s,!0;case"nativebrowsersmoothscroll":return e.nativeBrowserSmoothScroll=s,!0;case"songbookbendduration":return e.songBookBendDuration=s,!0;case"songbookdipduration":return e.songBookDipDuration=s,!0;case"playtripletfeel":return e.playTripletFeel=s,!0;case"buffertimeinmilliseconds":return e.bufferTimeInMilliseconds=s,!0}if(0<=["vibrato"].indexOf(t))return mn.fromJson(e.vibrato,s),!0;for(var i of["vibrato"])if(0===t.indexOf(i)&&mn.setProperty(e.vibrato,t.substring(i.length),s))return!0;if(0<=["slide"].indexOf(t))return gn.fromJson(e.slide,s),!0;for(var a of["slide"])if(0===t.indexOf(a)&&gn.setProperty(e.slide,t.substring(a.length),s))return!0;return!1}},bn=class ep{static fromJson(s,e){e&&T.forEach(e,(e,t)=>ep.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("indent",e.indent),t.set("comments",e.comments),t):null}static setProperty(e,t,s){switch(t){case"indent":return e.indent=s,!0;case"comments":return e.comments=s,!0}return!1}},yn=class tp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>tp.setProperty(s,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("core",on.toJson(e.core)),t.set("display",cn.toJson(e.display)),t.set("notation",un.toJson(e.notation)),t.set("importer",pn.toJson(e.importer)),t.set("player",fn.toJson(e.player)),t.set("exporter",bn.toJson(e.exporter)),t):null}static setProperty(e,t,s){if(0<=["core",""].indexOf(t))return on.fromJson(e.core,s),!0;for(var i of["core",""])if(0===t.indexOf(i)&&on.setProperty(e.core,t.substring(i.length),s))return!0;if(0<=["display",""].indexOf(t))return cn.fromJson(e.display,s),!0;for(var a of["display",""])if(0===t.indexOf(a)&&cn.setProperty(e.display,t.substring(a.length),s))return!0;if(0<=["notation"].indexOf(t))return un.fromJson(e.notation,s),!0;for(var r of["notation"])if(0===t.indexOf(r)&&un.setProperty(e.notation,t.substring(r.length),s))return!0;if(0<=["importer"].indexOf(t))return pn.fromJson(e.importer,s),!0;for(var n of["importer"])if(0===t.indexOf(n)&&pn.setProperty(e.importer,t.substring(n.length),s))return!0;if(0<=["player"].indexOf(t))return fn.fromJson(e.player,s),!0;for(var o of["player"])if(0===t.indexOf(o)&&fn.setProperty(e.player,t.substring(o.length),s))return!0;if(0<=["exporter"].indexOf(t))return bn.fromJson(e.exporter,s),!0;for(var h of["exporter"])if(0===t.indexOf(h)&&bn.setProperty(e.exporter,t.substring(h.length),s))return!0;return!1}},_n=class{constructor(){this.indent=2,this.comments=!1}},Sn=class sp{constructor(){this.core=new Rc,this.display=new Qr,this.notation=new fe,this.importer=new Zr,this.player=new nn,this.exporter=new _n}setSongBookModeSettings(){this.notation.notationMode=1,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=2,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(11,!1),this.notation.elements.set(12,!1),this.notation.elements.set(13,!0)}static get songBook(){var e=new sp;return e.setSongBookModeSettings(),e}fillFromJson(e){yn.fromJson(this,e)}handleBackwardsCompatibility(){0===this.player.playerMode&&this.player.enablePlayer&&(this.player.playerMode=1)}},vn=class ip{static fromJson(s,e){e&&T.forEach(e,(e,t)=>ip.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("marker",e.marker),t.set("text",e.text),t):null}static setProperty(e,t,s){switch(t){case"marker":return e.marker=s,!0;case"text":return e.text=s,!0}return!1}},kn=class ap{static fromJson(s,e){e&&T.forEach(e,(e,t)=>ap.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("baroccurence",e.barOccurence),t.set("millisecondoffset",e.millisecondOffset),t):null}static setProperty(e,t,s){switch(t){case"baroccurence":return e.barOccurence=s,!0;case"millisecondoffset":return e.millisecondOffset=s,!0}return!1}},wn=class rp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>rp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("islinear",e.isLinear),t.set("type",e.type),t.set("value",e.value),e.syncPointValue&&t.set("syncpointvalue",kn.toJson(e.syncPointValue)),t.set("ratioposition",e.ratioPosition),t.set("text",e.text),t.set("isvisible",e.isVisible),t):null}static setProperty(e,t,s){switch(t){case"islinear":return e.isLinear=s,!0;case"type":return e.type=T.parseEnum(s,j),!0;case"value":return e.value=s,!0;case"syncpointvalue":return s?(e.syncPointValue=new $,kn.fromJson(e.syncPointValue,s)):e.syncPointValue=void 0,!0;case"ratioposition":return e.ratioPosition=s,!0;case"text":return e.text=s,!0;case"isvisible":return e.isVisible=s,!0}return!1}},Tn=class np{static fromJson(s,e){e&&T.forEach(e,(e,t)=>np.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("type",e.type),t.set("length",e.length),t):null}static setProperty(e,t,s){switch(t){case"type":return e.type=T.parseEnum(s,It),!0;case"length":return e.length=s,!0}return!1}},Bn=class op{static fromJson(s,e){e&&T.forEach(e,(e,t)=>op.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t=new Map;if(t.set("alternateendings",e.alternateEndings),t.set("isdoublebar",e.isDoubleBar),t.set("isrepeatstart",e.isRepeatStart),t.set("repeatcount",e.repeatCount),t.set("timesignaturenumerator",e.timeSignatureNumerator),t.set("timesignaturedenominator",e.timeSignatureDenominator),t.set("timesignaturecommon",e.timeSignatureCommon),t.set("isfreetime",e.isFreeTime),t.set("tripletfeel",e.tripletFeel),e.section&&t.set("section",vn.toJson(e.section)),t.set("tempoautomations",e.tempoAutomations.map(e=>wn.toJson(e))),void 0!==e.syncPoints&&t.set("syncpoints",e.syncPoints?.map(e=>wn.toJson(e))),null!==e.fermata){var s,i,a=new Map;t.set("fermata",a);for([s,i]of e.fermata)a.set(s.toString(),Tn.toJson(i))}if(t.set("start",e.start),t.set("isanacrusis",e.isAnacrusis),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),null!==e.directions){var r,n=[];t.set("directions",n);for(r of e.directions)n.push(r)}return t}static setProperty(i,e,t){switch(e){case"alternateendings":return i.alternateEndings=t,!0;case"isdoublebar":return i.isDoubleBar=t,!0;case"isrepeatstart":return i.isRepeatStart=t,!0;case"repeatcount":return i.repeatCount=t,!0;case"timesignaturenumerator":return i.timeSignatureNumerator=t,!0;case"timesignaturedenominator":return i.timeSignatureDenominator=t,!0;case"timesignaturecommon":return i.timeSignatureCommon=t,!0;case"isfreetime":return i.isFreeTime=t,!0;case"tripletfeel":return i.tripletFeel=T.parseEnum(t,je),!0;case"section":return t?(i.section=new Jt,vn.fromJson(i.section,t)):i.section=null,!0;case"tempoautomations":i.tempoAutomations=[];for(var s of t){var a=new K;wn.fromJson(a,s),i.tempoAutomations.push(a)}return!0;case"syncpoints":if(t){i.syncPoints=[];for(var r of t){var n=new K;wn.fromJson(n,r),i.addSyncPoint(n)}}return!0;case"fermata":return i.fermata=new Map,T.forEach(t,(e,t)=>{var s=new At;Tn.fromJson(s,e),i.addFermata(Number.parseInt(t),s)}),!0;case"start":return i.start=t,!0;case"isanacrusis":return i.isAnacrusis=t,!0;case"displayscale":return i.displayScale=t,!0;case"displaywidth":return i.displayWidth=t,!0;case"directions":for(var o of t)i.addDirection(T.parseEnum(o,Dt));return!0}return!1}},xn=class hp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>hp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("offset",e.offset),t.set("value",e.value),t):null}static setProperty(e,t,s){switch(t){case"offset":return e.offset=s,!0;case"value":return e.value=s,!0}return!1}},Pn=class lp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>lp.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t,s,i=new Map,a=(i.set("notehead",e.noteHead),i.set("noteheadcenteronstem",e.noteHeadCenterOnStem),new Map);i.set("colors",a);for([t,s]of e.colors)a.set(t.toString(),Ut.toJson(s));return i}static setProperty(s,e,t){switch(e){case"notehead":return s.noteHead=T.parseEnum(t,Qe),!0;case"noteheadcenteronstem":return s.noteHeadCenterOnStem=t,!0;case"colors":return s.colors=new Map,T.forEach(t,(e,t)=>{s.colors.set(T.parseEnum(t,ht),Ut.fromJson(e))}),!0}return!1}},Nn=class dp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>dp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("id",e.id),t.set("accentuated",e.accentuated),t.set("bendtype",e.bendType),t.set("bendstyle",e.bendStyle),t.set("iscontinuedbend",e.isContinuedBend),null!==e.bendPoints&&t.set("bendpoints",e.bendPoints?.map(e=>xn.toJson(e))),t.set("fret",e.fret),t.set("string",e.string),t.set("showstringnumber",e.showStringNumber),t.set("octave",e.octave),t.set("tone",e.tone),t.set("percussionarticulation",e.percussionArticulation),t.set("isvisible",e.isVisible),t.set("islefthandtapped",e.isLeftHandTapped),t.set("ishammerpullorigin",e.isHammerPullOrigin),t.set("isslurdestination",e.isSlurDestination),t.set("harmonictype",e.harmonicType),t.set("harmonicvalue",e.harmonicValue),t.set("isghost",e.isGhost),t.set("isletring",e.isLetRing),t.set("ispalmmute",e.isPalmMute),t.set("isdead",e.isDead),t.set("isdeadvisual",e.isDeadVisual),t.set("isstaccato",e.isStaccato),t.set("slideintype",e.slideInType),t.set("slideouttype",e.slideOutType),t.set("vibrato",e.vibrato),t.set("istiedestination",e.isTieDestination),t.set("lefthandfinger",e.leftHandFinger),t.set("righthandfinger",e.rightHandFinger),t.set("trillvalue",e.trillValue),t.set("trillspeed",e.trillSpeed),t.set("durationpercent",e.durationPercent),t.set("accidentalmode",e.accidentalMode),t.set("dynamics",e.dynamics),t.set("ornament",e.ornament),e.style&&t.set("style",Pn.toJson(e.style)),e.toJson(t),t):null}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"accentuated":return e.accentuated=T.parseEnum(s,ae),!0;case"bendtype":return e.bendType=T.parseEnum(s,Z),!0;case"bendstyle":return e.bendStyle=T.parseEnum(s,Q),!0;case"iscontinuedbend":return e.isContinuedBend=s,!0;case"bendpoints":if(s){e.bendPoints=[];for(var i of s){var a=new w;xn.fromJson(a,i),e.addBendPoint(a)}}return!0;case"fret":return e.fret=s,!0;case"string":return e.string=s,!0;case"showstringnumber":return e.showStringNumber=s,!0;case"octave":return e.octave=s,!0;case"tone":return e.tone=s,!0;case"percussionarticulation":return e.percussionArticulation=s,!0;case"isvisible":return e.isVisible=s,!0;case"islefthandtapped":return e.isLeftHandTapped=s,!0;case"ishammerpullorigin":return e.isHammerPullOrigin=s,!0;case"isslurdestination":return e.isSlurDestination=s,!0;case"harmonictype":return e.harmonicType=T.parseEnum(s,ne),!0;case"harmonicvalue":return e.harmonicValue=s,!0;case"isghost":return e.isGhost=s,!0;case"isletring":return e.isLetRing=s,!0;case"ispalmmute":return e.isPalmMute=s,!0;case"isdead":return e.isDead=s,!0;case"isdeadvisual":return e.isDeadVisual=s,!0;case"isstaccato":return e.isStaccato=s,!0;case"slideintype":return e.slideInType=T.parseEnum(s,le),!0;case"slideouttype":return e.slideOutType=T.parseEnum(s,de),!0;case"vibrato":return e.vibrato=T.parseEnum(s,ce),!0;case"istiedestination":return e.isTieDestination=s,!0;case"lefthandfinger":return e.leftHandFinger=T.parseEnum(s,re),!0;case"righthandfinger":return e.rightHandFinger=T.parseEnum(s,re),!0;case"trillvalue":return e.trillValue=s,!0;case"trillspeed":return e.trillSpeed=T.parseEnum(s,se),!0;case"durationpercent":return e.durationPercent=s,!0;case"accidentalmode":return e.accidentalMode=T.parseEnum(s,oe),!0;case"dynamics":return e.dynamics=T.parseEnum(s,q),!0;case"ornament":return e.ornament=T.parseEnum(s,nt),!0;case"style":return s?(e.style=new lt,Pn.fromJson(e.style,s)):e.style=void 0,!0}return e.setProperty(t,s)}},Mn=class cp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>cp.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t,s,i=new Map,a=new Map;i.set("colors",a);for([t,s]of e.colors)a.set(t.toString(),Ut.toJson(s));return i}static setProperty(s,e,t){return"colors"===e&&(s.colors=new Map,T.forEach(t,(e,t)=>{s.colors.set(T.parseEnum(t,St),Ut.fromJson(e))}),!0)}},En=class up{static fromJson(s,e){e&&T.forEach(e,(e,t)=>up.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("id",e.id),t.set("notes",e.notes.map(e=>Nn.toJson(e))),t.set("isempty",e.isEmpty),t.set("whammystyle",e.whammyStyle),t.set("ottava",e.ottava),t.set("islegatoorigin",e.isLegatoOrigin),t.set("duration",e.duration),t.set("automations",e.automations.map(e=>wn.toJson(e))),t.set("dots",e.dots),t.set("fade",e.fade),t.set("lyrics",e.lyrics),t.set("pop",e.pop),t.set("slap",e.slap),t.set("tap",e.tap),t.set("text",e.text),t.set("slashed",e.slashed),t.set("deadslapped",e.deadSlapped),t.set("brushtype",e.brushType),t.set("brushduration",e.brushDuration),t.set("tupletdenominator",e.tupletDenominator),t.set("tupletnumerator",e.tupletNumerator),t.set("iscontinuedwhammy",e.isContinuedWhammy),t.set("whammybartype",e.whammyBarType),null!==e.whammyBarPoints&&t.set("whammybarpoints",e.whammyBarPoints?.map(e=>xn.toJson(e))),t.set("vibrato",e.vibrato),t.set("chordid",e.chordId),t.set("gracetype",e.graceType),t.set("pickstroke",e.pickStroke),t.set("tremolospeed",e.tremoloSpeed),t.set("crescendo",e.crescendo),t.set("displaystart",e.displayStart),t.set("playbackstart",e.playbackStart),t.set("displayduration",e.displayDuration),t.set("playbackduration",e.playbackDuration),t.set("overridedisplayduration",e.overrideDisplayDuration),t.set("golpe",e.golpe),t.set("dynamics",e.dynamics),t.set("invertbeamdirection",e.invertBeamDirection),t.set("preferredbeamdirection",e.preferredBeamDirection),t.set("beamingmode",e.beamingMode),t.set("wahpedal",e.wahPedal),t.set("barrefret",e.barreFret),t.set("barreshape",e.barreShape),t.set("rasgueado",e.rasgueado),t.set("showtimer",e.showTimer),t.set("timer",e.timer),e.style&&t.set("style",Mn.toJson(e.style)),t):null}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"notes":e.notes=[];for(var i of s){var a=new dt;Nn.fromJson(a,i),e.addNote(a)}return!0;case"isempty":return e.isEmpty=s,!0;case"whammystyle":return e.whammyStyle=T.parseEnum(s,Q),!0;case"ottava":return e.ottava=T.parseEnum(s,he),!0;case"islegatoorigin":return e.isLegatoOrigin=s,!0;case"duration":return e.duration=T.parseEnum(s,se),!0;case"automations":e.automations=[];for(var r of s){var n=new K;wn.fromJson(n,r),e.automations.push(n)}return!0;case"dots":return e.dots=s,!0;case"fade":return e.fade=T.parseEnum(s,gt),!0;case"lyrics":return e.lyrics=s,!0;case"pop":return e.pop=s,!0;case"slap":return e.slap=s,!0;case"tap":return e.tap=s,!0;case"text":return e.text=s,!0;case"slashed":return e.slashed=s,!0;case"deadslapped":return e.deadSlapped=s,!0;case"brushtype":return e.brushType=T.parseEnum(s,ee),!0;case"brushduration":return e.brushDuration=s,!0;case"tupletdenominator":return e.tupletDenominator=s,!0;case"tupletnumerator":return e.tupletNumerator=s,!0;case"iscontinuedwhammy":return e.isContinuedWhammy=s,!0;case"whammybartype":return e.whammyBarType=T.parseEnum(s,pt),!0;case"whammybarpoints":if(s){e.whammyBarPoints=[];for(var o of s){var h=new w;xn.fromJson(h,o),e.addWhammyBarPoint(h)}}return!0;case"vibrato":return e.vibrato=T.parseEnum(s,ce),!0;case"chordid":return e.chordId=s,!0;case"gracetype":return e.graceType=T.parseEnum(s,ie),!0;case"pickstroke":return e.pickStroke=T.parseEnum(s,it),!0;case"tremolospeed":return e.tremoloSpeed=T.parseEnum(s,se)??null,!0;case"crescendo":return e.crescendo=T.parseEnum(s,te),!0;case"displaystart":return e.displayStart=s,!0;case"playbackstart":return e.playbackStart=s,!0;case"displayduration":return e.displayDuration=s,!0;case"playbackduration":return e.playbackDuration=s,!0;case"overridedisplayduration":return e.overrideDisplayDuration=s,!0;case"golpe":return e.golpe=T.parseEnum(s,mt),!0;case"dynamics":return e.dynamics=T.parseEnum(s,q),!0;case"invertbeamdirection":return e.invertBeamDirection=s,!0;case"preferredbeamdirection":return e.preferredBeamDirection=T.parseEnum(s,ms)??null,!0;case"beamingmode":return e.beamingMode=T.parseEnum(s,_t),!0;case"wahpedal":return e.wahPedal=T.parseEnum(s,ft),!0;case"barrefret":return e.barreFret=s,!0;case"barreshape":return e.barreShape=T.parseEnum(s,bt),!0;case"rasgueado":return e.rasgueado=T.parseEnum(s,yt),!0;case"showtimer":return e.showTimer=s,!0;case"timer":return e.timer=s,!0;case"style":return s?(e.style=new vt,Mn.fromJson(e.style,s)):e.style=void 0,!0}return!1}},Ln=class pp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>pp.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t,s,i=new Map,a=new Map;i.set("colors",a);for([t,s]of e.colors)a.set(t.toString(),Ut.toJson(s));return i}static setProperty(s,e,t){return"colors"===e&&(s.colors=new Map,T.forEach(t,(e,t)=>{s.colors.set(T.parseEnum(t,Oe),Ut.fromJson(e))}),!0)}},Cn=class mp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>mp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("id",e.id),t.set("beats",e.beats.map(e=>En.toJson(e))),e.style&&t.set("style",Ln.toJson(e.style)),t):null}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"beats":e.beats=[];for(var i of s){var a=new wt;En.fromJson(a,i),e.addBeat(a)}return!0;case"style":return s?(e.style=new Ve,Ln.fromJson(e.style,s)):e.style=void 0,!0}return!1}},Fn=class gp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>gp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("ratioposition",e.ratioPosition),t.set("pedaltype",e.pedalType),t):null}static setProperty(e,t,s){switch(t){case"ratioposition":return e.ratioPosition=s,!0;case"pedaltype":return e.pedalType=T.parseEnum(s,Le),!0}return!1}},Dn=class fp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>fp.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t,s,i=new Map,a=new Map;i.set("colors",a);for([t,s]of e.colors)a.set(t.toString(),Ut.toJson(s));return i}static setProperty(s,e,t){return"colors"===e&&(s.colors=new Map,T.forEach(t,(e,t)=>{s.colors.set(T.parseEnum(t,Fe),Ut.fromJson(e))}),!0)}},In=class bp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>bp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("id",e.id),t.set("clef",e.clef),t.set("clefottava",e.clefOttava),t.set("voices",e.voices.map(e=>Cn.toJson(e))),t.set("similemark",e.simileMark),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),t.set("sustainpedals",e.sustainPedals.map(e=>Fn.toJson(e))),t.set("barlineleft",e.barLineLeft),t.set("barlineright",e.barLineRight),t.set("keysignature",e.keySignature),t.set("keysignaturetype",e.keySignatureType),e.style&&t.set("style",Dn.toJson(e.style)),t):null}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"clef":return e.clef=T.parseEnum(s,Pe),!0;case"clefottava":return e.clefOttava=T.parseEnum(s,he),!0;case"voices":e.voices=[];for(var i of s){var a=new We;Cn.fromJson(a,i),e.addVoice(a)}return!0;case"similemark":return e.simileMark=T.parseEnum(s,Ne),!0;case"displayscale":return e.displayScale=s,!0;case"displaywidth":return e.displayWidth=s,!0;case"sustainpedals":e.sustainPedals=[];for(var r of s){var n=new Ce;Fn.fromJson(n,r),e.sustainPedals.push(n)}return!0;case"barlineleft":return e.barLineLeft=T.parseEnum(s,Ie),!0;case"barlineright":return e.barLineRight=T.parseEnum(s,Ie),!0;case"keysignature":return e.keySignature=T.parseEnum(s,Me),!0;case"keysignaturetype":return e.keySignatureType=T.parseEnum(s,Ee),!0;case"style":return s?(e.style=new De,Dn.fromJson(e.style,s)):e.style=void 0,!0}return!1}},An=class yp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>yp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("name",e.name),t.set("firstfret",e.firstFret),t.set("strings",e.strings),t.set("barrefrets",e.barreFrets),t.set("showname",e.showName),t.set("showdiagram",e.showDiagram),t.set("showfingering",e.showFingering),t):null}static setProperty(e,t,s){switch(t){case"name":return e.name=s,!0;case"firstfret":return e.firstFret=s,!0;case"strings":return e.strings=s,!0;case"barrefrets":return e.barreFrets=s,!0;case"showname":return e.showName=s,!0;case"showdiagram":return e.showDiagram=s,!0;case"showfingering":return e.showFingering=s,!0}return!1}},Rn=class _p{static fromJson(s,e){e&&T.forEach(e,(e,t)=>_p.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("isstandard",e.isStandard),t.set("name",e.name),t.set("tunings",e.tunings),t):null}static setProperty(e,t,s){switch(t){case"isstandard":return e.isStandard=s,!0;case"name":return e.name=s,!0;case"tunings":return e.tunings=s,!0}return!1}},On=class Sp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Sp.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t=new Map;if(t.set("bars",e.bars.map(e=>In.toJson(e))),null!==e.chords){var s,i,a=new Map;t.set("chords",a);for([s,i]of e.chords)a.set(s.toString(),An.toJson(i))}return t.set("capo",e.capo),t.set("transpositionpitch",e.transpositionPitch),t.set("displaytranspositionpitch",e.displayTranspositionPitch),t.set("stringtuning",Rn.toJson(e.stringTuning)),t.set("showslash",e.showSlash),t.set("shownumbered",e.showNumbered),t.set("showtablature",e.showTablature),t.set("showstandardnotation",e.showStandardNotation),t.set("ispercussion",e.isPercussion),t.set("standardnotationlinecount",e.standardNotationLineCount),t}static setProperty(i,e,t){switch(e){case"bars":i.bars=[];for(var s of t){var a=new Ae;In.fromJson(a,s),i.addBar(a)}return!0;case"chords":return i.chords=new Map,T.forEach(t,(e,t)=>{var s=new Ht;An.fromJson(s,e),i.addChord(t,s)}),!0;case"capo":return i.capo=t,!0;case"transpositionpitch":return i.transpositionPitch=t,!0;case"displaytranspositionpitch":return i.displayTranspositionPitch=t,!0;case"stringtuning":return Rn.fromJson(i.stringTuning,t),!0;case"showslash":return i.showSlash=t,!0;case"shownumbered":return i.showNumbered=t,!0;case"showtablature":return i.showTablature=t,!0;case"showstandardnotation":return i.showStandardNotation=t,!0;case"ispercussion":return i.isPercussion=t,!0;case"standardnotationlinecount":return i.standardNotationLineCount=t,!0}return!1}},Vn=class vp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>vp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("volume",e.volume),t.set("balance",e.balance),t.set("port",e.port),t.set("program",e.program),t.set("bank",e.bank),t.set("primarychannel",e.primaryChannel),t.set("secondarychannel",e.secondaryChannel),t.set("ismute",e.isMute),t.set("issolo",e.isSolo),t):null}static setProperty(e,t,s){switch(t){case"volume":return e.volume=s,!0;case"balance":return e.balance=s,!0;case"port":return e.port=s,!0;case"program":return e.program=s,!0;case"bank":return e.bank=s,!0;case"primarychannel":return e.primaryChannel=s,!0;case"secondarychannel":return e.secondaryChannel=s,!0;case"ismute":return e.isMute=s,!0;case"issolo":return e.isSolo=s,!0}return!1}},Wn=class kp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>kp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("elementtype",e.elementType),t.set("staffline",e.staffLine),t.set("noteheaddefault",e.noteHeadDefault),t.set("noteheadhalf",e.noteHeadHalf),t.set("noteheadwhole",e.noteHeadWhole),t.set("techniquesymbol",e.techniqueSymbol),t.set("techniquesymbolplacement",e.techniqueSymbolPlacement),t.set("outputmidinumber",e.outputMidiNumber),t):null}static setProperty(e,t,s){switch(t){case"elementtype":return e.elementType=s,!0;case"staffline":return e.staffLine=s,!0;case"noteheaddefault":return e.noteHeadDefault=T.parseEnum(s,Qe),!0;case"noteheadhalf":return e.noteHeadHalf=T.parseEnum(s,Qe),!0;case"noteheadwhole":return e.noteHeadWhole=T.parseEnum(s,Qe),!0;case"techniquesymbol":return e.techniqueSymbol=T.parseEnum(s,Qe),!0;case"techniquesymbolplacement":return e.techniqueSymbolPlacement=T.parseEnum(s,at),!0;case"outputmidinumber":return e.outputMidiNumber=s,!0}return!1}},Hn=class wp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>wp.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t,s,i=new Map,a=new Map;i.set("colors",a);for([t,s]of e.colors)a.set(t.toString(),Ut.toJson(s));return i}static setProperty(s,e,t){return"colors"===e&&(s.colors=new Map,T.forEach(t,(e,t)=>{s.colors.set(T.parseEnum(t,Qt),Ut.fromJson(e))}),!0)}},Gn=class Tp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Tp.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t=new Map;if(t.set("staves",e.staves.map(e=>On.toJson(e))),t.set("playbackinfo",Vn.toJson(e.playbackInfo)),t.set("color",Ut.toJson(e.color)),t.set("name",e.name),t.set("isvisibleonmultitrack",e.isVisibleOnMultiTrack),t.set("shortname",e.shortName),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),void 0!==e.lineBreaks){var s,i=[];t.set("linebreaks",i);for(s of e.lineBreaks)i.push(s)}return t.set("percussionarticulations",e.percussionArticulations.map(e=>Wn.toJson(e))),e.style&&t.set("style",Hn.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"staves":e.staves=[];for(var i of s){var a=new $t;On.fromJson(a,i),e.addStaff(a)}return!0;case"playbackinfo":return Vn.fromJson(e.playbackInfo,s),!0;case"color":return e.color=Ut.fromJson(s),!0;case"name":return e.name=s,!0;case"isvisibleonmultitrack":return e.isVisibleOnMultiTrack=s,!0;case"shortname":return e.shortName=s,!0;case"defaultsystemslayout":return e.defaultSystemsLayout=s,!0;case"systemslayout":return e.systemsLayout=s,!0;case"linebreaks":for(var r of s)e.addLineBreaks(r);return!0;case"percussionarticulations":e.percussionArticulations=[];for(var n of s){var o=new h;Wn.fromJson(o,n),e.percussionArticulations.push(o)}return!0;case"style":return s?(e.style=new Zt,Hn.fromJson(e.style,s)):e.style=void 0,!0}return!1}},zn=class Bp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Bp.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t=new Map;if(t.set("hidedynamics",e.hideDynamics),t.set("bracketextendmode",e.bracketExtendMode),t.set("usesystemsignseparator",e.useSystemSignSeparator),t.set("globaldisplaytuning",e.globalDisplayTuning),null!==e.perTrackDisplayTuning){var s,i,a=new Map;t.set("pertrackdisplaytuning",a);for([s,i]of e.perTrackDisplayTuning)a.set(s.toString(),i)}if(t.set("globaldisplaychorddiagramsontop",e.globalDisplayChordDiagramsOnTop),null!==e.perTrackChordDiagramsOnTop){var r,n,o=new Map;t.set("pertrackchorddiagramsontop",o);for([r,n]of e.perTrackChordDiagramsOnTop)o.set(r.toString(),n)}if(t.set("singletracktracknamepolicy",e.singleTrackTrackNamePolicy),t.set("multitracktracknamepolicy",e.multiTrackTrackNamePolicy),t.set("firstsystemtracknamemode",e.firstSystemTrackNameMode),t.set("othersystemstracknamemode",e.otherSystemsTrackNameMode),t.set("firstsystemtracknameorientation",e.firstSystemTrackNameOrientation),t.set("othersystemstracknameorientation",e.otherSystemsTrackNameOrientation),t.set("multitrackmultibarrest",e.multiTrackMultiBarRest),null!==e.perTrackMultiBarRest){var h,l=[];t.set("pertrackmultibarrest",l);for(h of e.perTrackMultiBarRest)l.push(h)}return t}static setProperty(s,e,t){switch(e){case"hidedynamics":return s.hideDynamics=t,!0;case"bracketextendmode":return s.bracketExtendMode=T.parseEnum(t,Se),!0;case"usesystemsignseparator":return s.useSystemSignSeparator=t,!0;case"globaldisplaytuning":return s.globalDisplayTuning=t,!0;case"pertrackdisplaytuning":return s.perTrackDisplayTuning=new Map,T.forEach(t,(e,t)=>{s.perTrackDisplayTuning.set(Number.parseInt(t),e)}),!0;case"globaldisplaychorddiagramsontop":return s.globalDisplayChordDiagramsOnTop=t,!0;case"pertrackchorddiagramsontop":return s.perTrackChordDiagramsOnTop=new Map,T.forEach(t,(e,t)=>{s.perTrackChordDiagramsOnTop.set(Number.parseInt(t),e)}),!0;case"singletracktracknamepolicy":return s.singleTrackTrackNamePolicy=T.parseEnum(t,ve),!0;case"multitracktracknamepolicy":return s.multiTrackTrackNamePolicy=T.parseEnum(t,ve),!0;case"firstsystemtracknamemode":return s.firstSystemTrackNameMode=T.parseEnum(t,ke),!0;case"othersystemstracknamemode":return s.otherSystemsTrackNameMode=T.parseEnum(t,ke),!0;case"firstsystemtracknameorientation":return s.firstSystemTrackNameOrientation=T.parseEnum(t,we),!0;case"othersystemstracknameorientation":return s.otherSystemsTrackNameOrientation=T.parseEnum(t,we),!0;case"multitrackmultibarrest":return s.multiTrackMultiBarRest=t,!0;case"pertrackmultibarrest":return s.perTrackMultiBarRest=new Set(t),!0}return!1}},Un=class xp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>xp.setProperty(s,t,e))}static toJson(e){return e?new Map:null}static setProperty(e,t,s){return!1}},Yn=class Pp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Pp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("template",e.template),t.set("isvisible",e.isVisible),t.set("textalign",e.textAlign),t):null}static setProperty(e,t,s){switch(t){case"template":return e.template=s,!0;case"isvisible":return e.isVisible=s,!0;case"textalign":return e.textAlign=T.parseEnum(s,He),!0}return!1}},Xn=class Np{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Np.setProperty(s,t,e))}static toJson(e){if(!e)return null;var t,s,i=new Map,a=new Map;i.set("headerandfooter",a);for([t,s]of e.headerAndFooter)a.set(t.toString(),Yn.toJson(s));var r,n,o=new Map;i.set("colors",o);for([r,n]of e.colors)o.set(r.toString(),Ut.toJson(n));return i}static setProperty(i,e,t){switch(e){case"headerandfooter":return i.headerAndFooter=new Map,T.forEach(t,(e,t)=>{var s=new Xe;Yn.fromJson(s,e),i.headerAndFooter.set(T.parseEnum(t,Ye),s)}),!0;case"colors":return i.colors=new Map,T.forEach(t,(e,t)=>{i.colors.set(T.parseEnum(t,Ye),Ut.fromJson(e))}),!0}return!1}},Jn=class Mp{static fromJson(s,e){e&&T.forEach(e,(e,t)=>Mp.setProperty(s,t,e))}static toJson(e){var t;return e?((t=new Map).set("album",e.album),t.set("artist",e.artist),t.set("copyright",e.copyright),t.set("instructions",e.instructions),t.set("music",e.music),t.set("notices",e.notices),t.set("subtitle",e.subTitle),t.set("title",e.title),t.set("words",e.words),t.set("tab",e.tab),t.set("masterbars",e.masterBars.map(e=>Bn.toJson(e))),t.set("tracks",e.tracks.map(e=>Gn.toJson(e))),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),t.set("stylesheet",zn.toJson(e.stylesheet)),e.backingTrack&&t.set("backingtrack",Un.toJson(e.backingTrack)),e.style&&t.set("style",Xn.toJson(e.style)),t):null}static setProperty(e,t,s){switch(t){case"album":return e.album=s,!0;case"artist":return e.artist=s,!0;case"copyright":return e.copyright=s,!0;case"instructions":return e.instructions=s,!0;case"music":return e.music=s,!0;case"notices":return e.notices=s,!0;case"subtitle":return e.subTitle=s,!0;case"title":return e.title=s,!0;case"words":return e.words=s,!0;case"tab":return e.tab=s,!0;case"masterbars":e.masterBars=[];for(var i of s){var a=new $e;Bn.fromJson(a,i),e.addMasterBar(a)}return!0;case"tracks":e.tracks=[];for(var r of s){var n=new ts;Gn.fromJson(n,r),e.addTrack(n)}return!0;case"defaultsystemslayout":return e.defaultSystemsLayout=s,!0;case"systemslayout":return e.systemsLayout=s,!0;case"stylesheet":return zn.fromJson(e.stylesheet,s),!0;case"backingtrack":return s?(e.backingTrack=new hi,Un.fromJson(e.backingTrack,s)):e.backingTrack=void 0,!0;case"style":return s?(e.style=new Je,Xn.fromJson(e.style,s)):e.style=void 0,!0}return!1}},qn=class Ep{static _jsonReplacer(e,t){if(t instanceof Map){if("fromEntries"in Object)return Object.fromEntries(t);var s,i,a={};for([s,i]of t)a[s]=i;return a}return ArrayBuffer.isView(t)?Array.apply([],[t]):t}static scoreToJson(e){e=Ep.scoreToJsObject(e);return JSON.stringify(e,Ep._jsonReplacer)}static jsonToScore(e,t){return Ep.jsObjectToScore(JSON.parse(e),t)}static scoreToJsObject(e){return Jn.toJson(e)}static jsObjectToScore(e,t){var s=new qe;return Jn.fromJson(s,e),s.finish(t??new Sn),s}static settingsToJson(e){e=Ep.settingsToJsObject(e);return JSON.stringify(e,Ep._jsonReplacer)}static jsonToSettings(e){return Ep.jsObjectToSettings(JSON.parse(e))}static settingsToJsObject(e){return yn.toJson(e)}static jsObjectToSettings(e){var t=new Sn;return yn.fromJson(t,e),t}static jsObjectToMidiFile(e){let i=new Ji;return T.forEach(e,(e,t)=>{switch(t){case"division":i.division=e;break;case"tracks":for(var s of e){s=Ep._jsObjectToMidiTrack(s);i.tracks.push(s)}}}),i}static _jsObjectToMidiTrack(e){let i=new Xi;return T.forEach(e,(e,t)=>{if("events"===t)for(var s of e){s=Ep.jsObjectToMidiEvent(s);i.events.push(s)}}),i}static jsObjectToMidiEvent(e){var t=T.getValue(e,"track"),s=T.getValue(e,"tick"),i=T.getValue(e,"type");switch(i){case 88:return new $i(t,s,T.getValue(e,"numerator"),T.getValue(e,"denominatorIndex"),T.getValue(e,"midiClocksPerMetronomeClick"),T.getValue(e,"thirdySecondNodesInQuarter"));case 241:return new ea(t,s,T.getValue(e,"channel"));case 242:return new Zi(t,s,T.getValue(e,"metronomeNumerator"),T.getValue(e,"metronomeDurationInTicks"),T.getValue(e,"metronomeDurationInMilliseconds"));case 128:return new sa(t,s,T.getValue(e,"channel"),T.getValue(e,"noteKey"),T.getValue(e,"noteVelocity"));case 144:return new ia(t,s,T.getValue(e,"channel"),T.getValue(e,"noteKey"),T.getValue(e,"noteVelocity"));case 176:return new aa(t,s,T.getValue(e,"channel"),T.getValue(e,"controller"),T.getValue(e,"value"));case 192:return new ra(t,s,T.getValue(e,"channel"),T.getValue(e,"program"));case 81:var a=new na(s,0);return a.beatsPerMinute=T.getValue(e,"beatsPerMinute"),a;case 224:return new oa(t,s,T.getValue(e,"channel"),T.getValue(e,"value"));case 96:return new ha(t,s,T.getValue(e,"channel"),T.getValue(e,"noteKey"),T.getValue(e,"value"));case 47:return new la(t,s)}throw new b(1,"Unknown Midi Event type: "+i)}static midiFileToJsObject(e){var t,s=new Map,i=(s.set("division",e.division),[]);for(t of e.tracks)i.push(Ep._midiTrackToJsObject(t));return s.set("tracks",i),s}static _midiTrackToJsObject(e){var t,s=new Map,i=[];for(t of e.events)i.push(Ep.midiEventToJsObject(t));return s.set("events",i),s}static midiEventToJsObject(e){var t=new Map;switch(t.set("track",e.track),t.set("tick",e.tick),t.set("type",e.type),e.type){case 88:t.set("numerator",e.numerator),t.set("denominatorIndex",e.denominatorIndex),t.set("midiClocksPerMetronomeClick",e.midiClocksPerMetronomeClick),t.set("thirdySecondNodesInQuarter",e.thirtySecondNodesInQuarter);break;case 241:t.set("channel",e.channel);break;case 242:t.set("metronomeNumerator",e.metronomeNumerator),t.set("metronomeDurationInMilliseconds",e.metronomeDurationInMilliseconds),t.set("metronomeDurationInTicks",e.metronomeDurationInTicks);break;case 128:case 144:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("noteVelocity",e.noteVelocity);break;case 176:t.set("channel",e.channel),t.set("controller",e.controller),t.set("value",e.value);break;case 192:t.set("channel",e.channel),t.set("program",e.program);break;case 81:t.set("beatsPerMinute",e.beatsPerMinute);break;case 224:t.set("channel",e.channel),t.set("value",e.value);break;case 96:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("value",e.value)}return t}},jn=class Lp{constructor(e,t){this._exporter=new Map,this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new Vr(new Ai,t),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){let t=E.globalThis;t.addEventListener("message",e=>{e=e.data;"alphaSynth.initialize"===e.cmd&&(Ai.preferredSampleRate=e.sampleRate,M.logLevel=e.logLevel,E.globalThis.alphaSynthWebWorker=new Lp(t,e.bufferTimeInMilliseconds))})}handleMessage(e){var t=e.data,s=t.cmd;switch(s){case"alphaSynth.setLogLevel":M.logLevel=t.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=t.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=t.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=t.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=t.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=t.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=t.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=t.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=t.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=t.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(qn.jsObjectToMidiFile(t.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(t.data,t.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(qn.jsObjectToMidiFile(t.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(t.channel,t.mute);break;case"alphaSynth.setChannelTranspositionPitch":this._player.setChannelTranspositionPitch(t.channel,t.semitones);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(t.channel,t.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(t.channel,t.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this._player.applyTranspositionPitches(new Map(JSON.parse(t.transpositionPitches)))}s.startsWith("alphaSynth.exporter")&&this._handleExporterMessage(e)}_handleExporterMessage(e){var t,s=e.data,e=s.cmd;try{switch(e){case"alphaSynth.exporter.initialize":var i=this._player.exportAudio(s.options,qn.jsObjectToMidiFile(s.midi),s.syncPoints,s.transpositionPitches);this._exporter.set(s.exporterId,i),this._main.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:s.exporterId});break;case"alphaSynth.exporter.render":this._exporter.has(s.exporterId)?(t=this._exporter.get(s.exporterId).render(s.milliseconds),this._main.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:s.exporterId,chunk:t})):this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:s.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this._exporter.delete(s.exporterId)}}catch(e){this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:s.exporterId,error:e})}}onPositionChanged(e){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onPlayerStateChanged(e){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:e.state,stopped:e.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this._serializeException(E.prepareForPostMessage(e))})}_serializeException(e){var t=JSON.parse(JSON.stringify(e));return e.message&&(t.message=e.message),e.stack&&(t.stack=e.stack),e.constructor&&e.constructor.name&&(t.type=e.constructor.name),t}onMidiLoaded(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onMidiLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this._serializeException(E.prepareForPostMessage(e))})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(e){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:e.events.map(qn.midiEventToJsObject)})}onPlaybackRangeChanged(e){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:e.playbackRange})}},$n=((u=$n||{})[u.Browser=0]="Browser",u[u.NodeJs=1]="NodeJs",u[u.BrowserModule=2]="BrowserModule",u),Kn=class{constructor(e,t){this.characterWidths=e,this.characterHeights=t}},Qn=class Qn{static generateFontLookup(e){if(!Qn.fontSizeLookupTables.has(e))if(E.isRunningInWorker||1===E.webPlatform){var t=new Kn(new Uint8Array([8]),new Uint8Array([10]));Qn.fontSizeLookupTables.set(e,t)}else{var s=document.createElement("canvas").getContext("2d"),i=(s.font="11px "+e,[]),a=[];for(let e=Qn.ControlChars;e<255;e++){var r=String.fromCharCode(e),r=s.measureText(r),r=(i.push(r.width),r.actualBoundingBoxDescent+r.actualBoundingBoxAscent);a.push(r)}t=new Kn(new Uint8Array(i),new Uint8Array(a));Qn.fontSizeLookupTables.set(e,t)}}static measureString(t,s,i,e,a){let r,n=s[0];for(let e=0;e<s.length;e++)if(Qn.fontSizeLookupTables.has(s[e])){n=s[e];break}Qn.fontSizeLookupTables.has(n)||Qn.generateFontLookup(n),r=Qn.fontSizeLookupTables.get(n);let o=1,h=(1===e&&(o*=1.1),1===a&&(o*=1.1),0),l=0;for(let e=0;e<t.length;e++){var d=Math.min(r.characterWidths.length-1,t.charCodeAt(e)-Qn.ControlChars);0<=d&&(h+=r.characterWidths[d]*i/11,l=Math.max(l,r.characterHeights[d]*i/11))}return o*=1.07,new ze(h*o,l)}},Zn=(Qn.fontSizeLookupTables=new Map,Qn.ControlChars=32,Qn),eo=class Cp{constructor(e){this._main=e,this._main.addEventListener("message",this._handleMessage.bind(this),!1)}static init(){E.globalThis.alphaTabWebWorker=new Cp(E.globalThis)}_handleMessage(e){var t=e.data;switch(t?t.cmd:""){case"alphaTab.initialize":var s=qn.jsObjectToSettings(t.settings);M.logLevel=s.core.logLevel,this._renderer=new ps(s),this._renderer.partialRenderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:e})}),this._renderer.partialLayoutFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:e})}),this._renderer.renderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:e})}),this._renderer.postRenderFinished.on(()=>{this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this._renderer.boundsLookup?.toJson()??null})}),this._renderer.preRender.on(e=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:e})}),this._renderer.error.on(this._error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(t.resultId);break;case"alphaTab.setWidth":this._renderer.width=t.width;break;case"alphaTab.renderScore":this._updateFontSizes(t.fontSizes);s=null==t.score?null:qn.jsObjectToScore(t.score,this._renderer.settings);this._renderMultiple(s,t.trackIndexes);break;case"alphaTab.updateSettings":this._updateSettings(t.settings)}}_updateFontSizes(e){if(!(e instanceof Map)){var t,s=e;for(t in e=new Map,s)e.set(t,s[t])}if(e)for(var[i,a]of e)Zn.fontSizeLookupTables.set(i,a)}_updateSettings(e){yn.fromJson(this._renderer.settings,e)}_renderMultiple(e,t){try{this._renderer.renderScore(e,t)}catch(e){this._error(e)}}_error(e){M.error("Worker","An unexpected error occurred in worker",e),this._main.postMessage({cmd:"alphaTab.error",error:e})}},to=class{constructor(){this._canvas=null,this._color=new Ut(0,0,0,255),this._font=new A("Arial",10,0),this._lineWidth=0,this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(e,t){this._musicFont=new A(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,0,0);var s=this.settings.display.scale;this._canvas=document.createElement("canvas"),this._canvas.width=e*E.highDpiFactor|0,this._canvas.height=t*E.highDpiFactor|0,this._canvas.style.width=e+"px",this._canvas.style.height=t+"px",this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(E.highDpiFactor*s,E.highDpiFactor*s),this._context.lineWidth=this._lineWidth}endRender(){var e=this._canvas;return this._canvas=null,e}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._context.strokeStyle=e.rgba,this._context.fillStyle=e.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._context&&(this._context.lineWidth=e)}fillRect(e,t,s,i){0<s&&this._context.fillRect(e,t,s,i)}strokeRect(e,t,s,i){var a=this.lineWidth%2==0?0:.5;this._context.strokeRect(e+a,t+a,s,i)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(e,t){this._context.moveTo(e,t)}lineTo(e,t){this._context.lineTo(e,t)}quadraticCurveTo(e,t,s,i){this._context.quadraticCurveTo(e,t,s,i)}bezierCurveTo(e,t,s,i,a,r){this._context.bezierCurveTo(e,t,s,i,a,r)}fillCircle(e,t,s){this._context.beginPath(),this._context.arc(e,t,s,0,2*Math.PI,!0),this.fill()}strokeCircle(e,t,s){this._context.beginPath(),this._context.arc(e,t,s,0,2*Math.PI,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(e){this._font=e,this._context&&(this._context.font=e.toCssString(1)),this._measureContext.font=e.toCssString(1)}get textAlign(){switch(this._context.textAlign){case"left":return 0;case"center":return 1;case"right":return 2;default:return 0}}set textAlign(e){switch(e){case 0:this._context.textAlign="left";break;case 1:this._context.textAlign="center";break;case 2:this._context.textAlign="right"}}get textBaseline(){switch(this._context.textBaseline){case"hanging":return 0;case"middle":return 1;case"bottom":return 2;case"alphabetic":return 3;default:return 0}}set textBaseline(e){switch(e){case 0:this._context.textBaseline="hanging";break;case 1:this._context.textBaseline="middle";break;case 2:this._context.textBaseline="bottom";break;case 3:this._context.textBaseline="alphabetic"}}beginGroup(e){}endGroup(){}fillText(e,t,s){this._context.fillText(e,t,s)}measureText(e){e=this._measureContext.measureText(e);return new ze(e.width,e.actualBoundingBoxDescent+e.actualBoundingBoxAscent)}fillMusicFontSymbol(e,t,s,i,a=!1){-1!==i&&this._fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),a)}fillMusicFontSymbols(e,t,s,i,a=!1){let r="";for(var n of i)-1!==n&&(r+=String.fromCharCode(n));this._fillMusicFontSymbolText(e,t,s,r,a)}_fillMusicFontSymbolText(e,t,s,i,a){var r=this._context.textAlign,n=this._context.textBaseline,o=this._context.font;this._context.font=this._musicFont.toCssString(s),this._context.textBaseline="alphabetic",this._context.textAlign=a?"center":"left",this._context.fillText(i,e,t),this._context.textBaseline=n,this._context.font=o,this._context.textAlign=r}beginRotate(e,t,s){this._context.save(),this._context.translate(e,t),this._context.rotate(s*Math.PI/180)}endRotate(){this._context.restore()}},so=class Fp{constructor(e,t=!1){this._midiFile=e,this._smf1Mode=t}addTimeSignature(e,t,s){let i=0,a=s;for(;0<(a>>=1);)i++;this._midiFile.addEvent(new $i(0,e,t,i,48,8))}addRest(e,t,s){this._smf1Mode||this._midiFile.addEvent(new ea(e,t,s))}addNote(e,t,s,i,a,r){this._midiFile.addEvent(new sa(e,t,r,Fp._fixValue(i),Fp._fixValue(a))),this._midiFile.addEvent(new ia(e,t+s,r,Fp._fixValue(i),Fp._fixValue(a)))}static _fixValue(e){return 127<e?127:e<0?0:e}addControlChange(e,t,s,i,a){this._midiFile.addEvent(new aa(e,t,s,i,Fp._fixValue(a)))}addProgramChange(e,t,s,i){this._midiFile.addEvent(new ra(e,t,s,i))}addTempo(e,t){e=new na(e,0);e.beatsPerMinute=t,this._midiFile.addEvent(e)}addBend(e,t,s,i){i=_.MaxPitchWheel<=i?_.MaxPitchWheel:Math.floor(i),this._midiFile.addEvent(new oa(e,t,s,i))}addNoteBend(e,t,s,i,a){this._smf1Mode?this.addBend(e,t,s,a):this._midiFile.addEvent(new ha(e,t,s,i,a=a*_.MaxPitchWheel20/_.MaxPitchWheel))}finishTrack(e,t){1!==this._midiFile.format&&0!==e||this._midiFile.addEvent(new la(e,t))}},io=class{constructor(e,t){this.closingIndex=0,this.group=e,this.opening=t,e.closings=e.closings.sort((e,t)=>e.index-t.index),this.iterations=e.closings.map(e=>0)}},ao=class{constructor(e){this._repeatStack=[],this._groupsOnStack=new Set,this._previousAlternateEndings=0,this._state=0,this.shouldPlay=!0,this.index=0,this.currentTick=0,this._score=e}get finished(){return this.index>=this._score.masterBars.length}processCurrent(){var t,s=this._score.masterBars[this.index];if(0===this._state){let e=s.alternateEndings;0===e&&(e=this._previousAlternateEndings),s===s.repeatGroup.opening&&s.repeatGroup.isClosed&&!this._groupsOnStack.has(s.repeatGroup)&&(t=new io(s.repeatGroup,s),this._repeatStack.push(t),this._groupsOnStack.add(s.repeatGroup),this._previousAlternateEndings=0,e=s.alternateEndings),0!==this._repeatStack.length&&0!==e&&(t=(t=this._repeatStack[this._repeatStack.length-1]).iterations[t.closingIndex],0==((this._previousAlternateEndings=e)&1<<t))?this.shouldPlay=!1:this.shouldPlay=!0}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=s.calculateDuration())}moveNext(){this._moveNextWithDirections()||this._moveNextWithNormalRepeats()}_resetRepeats(){this._groupsOnStack.clear(),this._previousAlternateEndings=0,this._repeatStack=[]}_handleDaCapo(e,t,s){return!!e.has(t)&&(this.index=0,this._state=s,this._resetRepeats(),!0)}_handleDalSegno(e,t,s,i){return!!e.has(t)&&-1!==(e=this._findJumpTarget(i,this.index,!0))&&(this.index=e,this._state=s,this._resetRepeats(),!0)}_handleDaCoda(e,t,s){return!!e.has(t)&&(-1===(e=this._findJumpTarget(s,this.index,!1))?this.index++:(this.index=e,this._state=0),!0)}_moveNextWithDirections(){var e=this._score.masterBars[this.index],t=null!==e.directions&&0<e.directions.size;if(0===this._state&&!t)return!1;if(t)switch(this._state){case 0:return!!(this._handleDaCapo(e.directions,5,1)||this._handleDaCapo(e.directions,6,2)||this._handleDaCapo(e.directions,7,3)||this._handleDaCapo(e.directions,8,4)||this._handleDalSegno(e.directions,9,1,1)||this._handleDalSegno(e.directions,10,2,1)||this._handleDalSegno(e.directions,11,3,1)||this._handleDalSegno(e.directions,12,4,1)||this._handleDalSegno(e.directions,13,1,2)||this._handleDalSegno(e.directions,14,2,2)||this._handleDalSegno(e.directions,15,3,2)||this._handleDalSegno(e.directions,16,4,2));case 1:return this.index++,!0;case 2:return this._handleDaCoda(e.directions,17,3)||this.index++,!0;case 3:return this._handleDaCoda(e.directions,18,4)||this.index++,!0;case 4:return e.directions.has(0)?this.index=this._score.masterBars.length:this.index++,!0}else this.index++;return!0}_findJumpTarget(e,t,s){let i;return s?-1===(i=this._findJumpTargetBackwards(e,t))&&(i=this._findJumpTargetForwards(e,t)):-1===(i=this._findJumpTargetForwards(e,t))&&(i=this._findJumpTargetBackwards(e,t)),i}_findJumpTargetForwards(e,t){let s=t;for(;s<this._score.masterBars.length;){var i=this._score.masterBars[s].directions;if(i&&i.has(e))return s;s++}return-1}_findJumpTargetBackwards(e,t){let s=t;for(;0<=s;){var i=this._score.masterBars[s].directions;if(i&&i.has(e))return s;s--}return-1}_moveNextWithNormalRepeats(){var e=this._score.masterBars[this.index].repeatCount-1;if(0<this._repeatStack.length&&0<e){var t=this._repeatStack[this._repeatStack.length-1];if(t.iterations[t.closingIndex]<e){this.index=t.opening.index,t.iterations[t.closingIndex]++;for(let e=0;e<t.closingIndex;e++)t.iterations[e]=0;t.closingIndex=0,this._previousAlternateEndings=0}else t.closingIndex<t.group.closings.length-1?t.closingIndex++:(this._repeatStack.pop(),this._groupsOnStack.delete(t.group)),this.index++}else this.index++}},ro=class{constructor(e,t){this.beat=e,this.playbackStart=t}},no=class{constructor(e,t){this._highlightedBeats=new Map,this.highlightedBeats=[],this.nextBeat=null,this.previousBeat=null,this.start=e,this.end=t}get duration(){return this.end-this.start}highlightBeat(e,t){e.isEmpty&&!e.voice.isEmpty||this._highlightedBeats.has(e.id)||(this._highlightedBeats.set(e.id,!0),this.highlightedBeats.push(new ro(e,t)))}getVisibleBeatAtStart(e){for(var t of this.highlightedBeats)if(t.playbackStart===this.start&&e.has(t.beat.voice.bar.staff.track.index))return t.beat;return null}},oo=class{constructor(e,t){this.tick=e,this.tempo=t}},ho=class{constructor(){this.start=0,this.end=0,this.tempoChanges=[],this.firstBeat=null,this.lastBeat=null,this.nextMasterBar=null,this.previousMasterBar=null}get tempo(){return this.tempoChanges[0].tempo}_insertAfter(e,t){null==this.firstBeat||null==e||null==this.lastBeat?(this.firstBeat=t,this.lastBeat=t):(t.nextBeat=e.nextBeat,(t.previousBeat=e).nextBeat&&(e.nextBeat.previousBeat=t),e.nextBeat=t,e===this.lastBeat&&(this.lastBeat=t))}_insertBefore(e,t){null==this.firstBeat||null==e||null==this.lastBeat?(this.firstBeat=t,this.lastBeat=t):(t.previousBeat=e.previousBeat,(t.nextBeat=e).previousBeat&&(e.previousBeat.nextBeat=t),e.previousBeat=t,e===this.firstBeat&&(this.firstBeat=t))}addBeat(e,s,i,a){a=i+a;if(null==this.firstBeat){var r=new no(i,a);r.highlightBeat(e,s),this._insertAfter(this.firstBeat,r)}else if(i>=this.lastBeat.end){var r=new no(this.lastBeat.end,a);r.highlightBeat(e,s),this._insertAfter(this.lastBeat,r)}else{let t=null;if(i<this.firstBeat.start)t=this.firstBeat;else{let e=this.firstBeat;for(;null!=e;){if(i>=e.start&&i<e.end){t=e;break}e=e.nextBeat}if(null===t)throw new b(0,"Error on building lookup, unknown variant")}if(i<t.start)if(a===t.start){var r=new no(i,t.start);r.highlightBeat(e,s),this._insertBefore(this.firstBeat,r)}else if(a<t.end){var n,r=new no(i,t.start),o=(r.highlightBeat(e,s),this._insertBefore(t,r),new no(t.start,a));for(n of t.highlightedBeats)o.highlightBeat(n.beat,n.playbackStart);o.highlightBeat(e,s),this._insertBefore(t,o),t.start=a}else a===t.end?((r=new no(i,t.start)).highlightBeat(e,s),t.highlightBeat(e,s),this._insertBefore(t,r)):((r=new no(i,t.start)).highlightBeat(e,s),t.highlightBeat(e,s),this._insertBefore(t,r),this.addBeat(e,s,t.end,a-t.end));else if(i>t.start)if(a===t.end){var h,l=new no(t.start,i);for(h of t.highlightedBeats)l.highlightBeat(h.beat,h.playbackStart);t.start=i,t.highlightBeat(e,s),this._insertBefore(t,l)}else if(a<t.end){var d,c=new no(t.start,i),u=(this._insertBefore(t,c),new no(i,a));this._insertBefore(t,u);for(d of t.highlightedBeats)c.highlightBeat(d.beat,d.playbackStart),u.highlightBeat(d.beat,d.playbackStart);u.highlightBeat(e,s),t.start=a}else{var p,m=new no(t.start,i);for(p of t.highlightedBeats)m.highlightBeat(p.beat,p.playbackStart);t.start=i,t.highlightBeat(e,s),this._insertBefore(t,m),this.addBeat(e,s,t.end,a-t.end)}else if(a===t.end)t.highlightBeat(e,s);else if(a<t.end){var g,f=new no(t.start,a);for(g of t.highlightedBeats)f.highlightBeat(g.beat,g.playbackStart);f.highlightBeat(e,s),t.start=a,this._insertBefore(t,f)}else t.highlightBeat(e,s),this.addBeat(e,s,t.end,a-t.end)}}},lo=((Vt={})[Vt.Unknown=0]="Unknown",Vt[Vt.ToNextBext=1]="ToNextBext",Vt[Vt.ToEndOfBar=2]="ToEndOfBar",Vt),co=class{constructor(e){this.nextBeat=null,this.tickDuration=0,this.duration=0,this.cursorMode=0,this.masterBar=e}get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=N.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let e=0,t=this.start,s=this.masterBar.tempoChanges[0].tempo,i=this.end;for(var a of this.masterBar.tempoChanges)if(a.tick<t)s=a.tempo;else{if(a.tick>i)break;e+=N.ticksToMillis(a.tick-t,s),s=a.tempo,t=a.tick}i>t&&(e+=N.ticksToMillis(i-t,s)),this.duration=e}}},uo=class{constructor(){this._currentMasterBar=null,this.masterBarLookup=new Map,this.masterBars=[],this.multiBarRestInfo=null}findBeat(e,t,s=null){let i=null;return i=(i=s?this._findBeatFast(e,s,t):i)||this._findBeatSlow(e,s,t,!1)}_findBeatFast(e,t,s){return s>=t.start&&s<t.end?t:t.nextBeat&&s>=t.nextBeat.start&&s<t.nextBeat.end?(s=t.nextBeat,this._fillNextBeat(s,e),s):null}_fillNextBeatMultiBarRest(e,t){let s=this.multiBarRestInfo.get(e.masterBar.masterBar.index),i=e.masterBar;for(let e=0;e<s.length&&i;e++)i=i.nextMasterBar;i?i.nextMasterBar?(e.nextBeat=this._firstBeatInMasterBar(t,i.nextMasterBar,i.nextMasterBar.start,!0),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=1,e.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==i.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=2)):(e.tickDuration=i.nextMasterBar.end-e.start,e.cursorMode=2)):(e.tickDuration=i.end-e.start,e.cursorMode=2):(M.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),e.tickDuration=(e.masterBar.end-e.masterBar.start)*(s.length+1),e.cursorMode=2),e.calculateDuration()}_fillNextBeat(e,t){this._isMultiBarRestResult(e)?this._fillNextBeatMultiBarRest(e,t):this._fillNextBeatDefault(e,t)}_fillNextBeatDefault(e,t){e.nextBeat=this._findBeatInMasterBar(e.masterBar,e.beatLookup.nextBeat,e.end,t,!0),null==e.nextBeat&&(e.nextBeat=this._findBeatSlow(t,e,e.end,!0)),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=1):(e.tickDuration=e.masterBar.end-e.start,e.cursorMode=2),e.calculateDuration(),e.nextBeat&&e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=2)}_isMultiBarRestResult(e){return this._internalIsMultiBarRestResult(e.masterBar.masterBar.index,e.beat)}_internalIsMultiBarRestResult(e,t){return this.multiBarRestInfo&&this.multiBarRestInfo.has(e)&&t.isRest&&t.voice.bar.isRestOnly}_findBeatSlow(e,t,s,i){let a=null;return null!=t&&(t.masterBar.start<=s&&t.masterBar.end>s?a=t.masterBar:t.masterBar.nextMasterBar&&t.masterBar.nextMasterBar.start<=s&&t.masterBar.nextMasterBar.end>s&&(a=t.masterBar.nextMasterBar)),(a=a||this._findMasterBar(s))?this._firstBeatInMasterBar(e,a,s,i):null}_firstBeatInMasterBar(e,t,s,i){let a=t;for(;a;){if(a.firstBeat){var r=this._findBeatInMasterBar(a,a.firstBeat,s,e,i);if(r)return r}a=a.nextMasterBar}return null}_findBeatInMasterBar(t,s,e,i,a){if(!s)return null;let r=null,n=null,o=e-t.start;for(;null!=s&&null==n;){if((s.start<=o||a&&o<0)&&o<s.end){if(r=s,!(n=s.getVisibleBeatAtStart(i)))if(a){let e=t;for(;null!=e&&null==n;){for(;null!=s;){if(n=s.getVisibleBeatAtStart(i)){r=s,t=e;break}s=s.nextBeat}n&&r||(s=(e=e.nextMasterBar)?.firstBeat??null)}}else{let e=t;for(;null!=e&&null==n;){for(;null!=s;){if(n=s.getVisibleBeatAtStart(i)){r=s,t=e;break}s=s.previousBeat}n&&r||(s=(e=e.previousMasterBar)?.firstBeat??null)}}}else if(s.end>o)break;s=s?.nextBeat??null}return null==n?null:this._createResult(t,r,n,a,i)}_createResult(e,i,t,s,a){var r=new co(e);if(r.beat=t,r.beatLookup=i,r.tickDuration=i.end-i.start,s){if(this._isMultiBarRestResult(r)){let t=this.multiBarRestInfo.get(e.masterBar.index),s=e;for(let e=0;e<t.length&&s;e++)s=s.nextMasterBar;s?s.nextMasterBar?r.tickDuration=s.nextMasterBar.start-i.start:r.tickDuration=s.end-i.start:M.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this._fillNextBeat(r,a);return r.calculateDuration(),r}_findMasterBar(e){let t=this.masterBars,s=0,i=t.length-1;for(;s<=i;){var a=(i+s)/2|0,r=t[a];if(e>=r.start&&e<r.end)return r;e<r.start?i=a-1:s=1+a}return null}getMasterBar(e){var t;return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index):((t=new ho).masterBar=e,t)}getMasterBarStart(e){return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index).start:0}getBeatStart(e){return this.masterBarLookup.has(e.voice.bar.index)?this.masterBarLookup.get(e.voice.bar.index).start+e.playbackStart:0}addMasterBar(e){this.masterBars.push(e),this._currentMasterBar&&(e.previousMasterBar=this._currentMasterBar,this._currentMasterBar.nextMasterBar=e),this._currentMasterBar=e,this.masterBarLookup.has(e.masterBar.index)||this.masterBarLookup.set(e.masterBar.index,e)}addBeat(e,t,s){var i,a,r,n=this._currentMasterBar;n&&(t<0&&n.previousMasterBar?(r=(a=(i=n.previousMasterBar.end-n.previousMasterBar.start)+t)+s,n.previousMasterBar.addBeat(e,a,a,s),i<r&&n.addBeat(e,t,0,s+t)):n.addBeat(e,t,t,s))}},po=class{constructor(){this.noteOnly=0,this.untilTieOrSlideEnd=0,this.letRingEnd=0}},mo=class{constructor(){this.firstBeatDuration=0,this.secondBeatStartOffset=0,this.secondBeatDuration=0}},go=class{constructor(){this.durations=[],this.brushInfos=[]}},fo=class{constructor(){this.synthTick=0,this.synthTime=0,this.currentTempo=0,this.automationToSyncPoint=new Map,this.createNewSyncPoints=!1}},B=class B{constructor(e,t,s){this._programsPerChannel=new Map,this._currentTime=0,this._calculatedBeatTimers=new Set,this.tickLookup=new uo,this.applyTranspositionPitches=!0,this.syncPoints=[],this.transpositionPitches=new Map,this._currentTripletFeel=null,this.vibratoResolution=16,this._score=e,this._settings=t||new Sn,this._handler=s}generate(){this.transpositionPitches.clear(),this._calculatedBeatTimers.clear(),this._currentTime=0;for(var e of this._score.tracks)this._generateTrack(e);M.debug("Midi","Begin midi generation"),this.syncPoints=[],B._playThroughSong(this._score,this.syncPoints,!1,(e,t,s,i,a)=>{this._generateMasterBar(e,t,s,i,a)},(e,t,s)=>{for(var i of this._score.tracks)for(var a of i.staves)e<a.bars.length&&this._generateBar(a.bars[e],t,s)},e=>{for(var t of this._score.tracks)this._handler.finishTrack(t.index,e)}),M.debug("Midi","Midi generation done")}_generateTrack(e){this._generateChannel(e,e.playbackInfo.primaryChannel,e.playbackInfo),e.playbackInfo.primaryChannel!==e.playbackInfo.secondaryChannel&&this._generateChannel(e,e.playbackInfo.secondaryChannel,e.playbackInfo)}_addProgramChange(e,t,s,i){this._programsPerChannel.has(s)&&this._programsPerChannel.get(s)===i||(this._handler.addProgramChange(e.index,t,s,i),this._programsPerChannel.set(s,i))}_addBankChange(e,t,s,i){i=Wt.bankToLsbMsb(i);this._handler.addControlChange(e.index,t,s,0,i[1]),this._handler.addControlChange(e.index,t,s,32,i[0])}static buildTranspositionPitches(e,t){var s,i=new Map;for(s of e.tracks){var a=s.index<t.notation.transpositionPitches.length?t.notation.transpositionPitches[s.index]:-s.staves[0].transpositionPitch;i.set(s.playbackInfo.primaryChannel,a),i.set(s.playbackInfo.secondaryChannel,a)}return i}_generateChannel(e,t,s){var i=e.index<this._settings.notation.transpositionPitches.length?this._settings.notation.transpositionPitches[e.index]:-e.staves[0].transpositionPitch,i=(this.transpositionPitches.set(t,i),B._toChannelShort(s.volume)),a=B._toChannelShort(s.balance);this._handler.addControlChange(e.index,0,t,7,i),this._handler.addControlChange(e.index,0,t,10,a),this._handler.addControlChange(e.index,0,t,11,127),this._handler.addControlChange(e.index,0,t,100,0),this._handler.addControlChange(e.index,0,t,101,0),this._handler.addControlChange(e.index,0,t,38,0),this._handler.addControlChange(e.index,0,t,6,B._pitchBendRangeInSemitones),this._addBankChange(e,0,t,s.bank),this._addProgramChange(e,0,t,s.program)}static generateSyncPoints(e,t=!1){var s=[];return B._playThroughSong(e,s,t,(e,t,s,i,a)=>{},(e,t,s)=>{},e=>{}),s}static buildModifiedTempoLookup(e){return B._playThroughSong(e,[],!1,(e,t,s,i,a)=>{},(e,t,s)=>{},e=>{}).automationToSyncPoint}static _playThroughSong(e,t,s,i,a,r){var n,o,h=new ao(e),l=new fo;l.currentTempo=e.tempo,l.syncPoints=t,l.createNewSyncPoints=s;let d=null,c=new Map;for(;!h.finished;){var u,p=h.index,m=e.masterBars[p],g=h.currentTick;h.processCurrent(),h.shouldPlay&&(u=c.has(p)?c.get(p):-1,u++,c.set(p,u),i(m,d,g,l.currentTempo,u),a(p,g,0<m.tempoAutomations.length?m.tempoAutomations[0].value:l.currentTempo),l.synthTick=g,B._processBarTime(m,u,l)),h.moveNext(),d=m}return 0<t.length&&(s=t[t.length-1],0<(n=h.currentTick-s.synthTick))&&((o=new ca).masterBarIndex=d.index,o.masterBarOccurence=c.get(d.index)-1,o.synthTick=h.currentTick,o.synthBpm=l.currentTempo,l.createNewSyncPoints?(o.syncBpm=s.synthBpm,o.synthBpm=s.synthBpm):1===t.length?o.syncBpm=s.synthBpm:o.syncBpm=t[t.length-2].syncBpm,o.synthTime=s.synthTime+N.ticksToMillis(n,s.synthBpm),o.syncTime=s.syncTime+N.ticksToMillis(n,o.syncBpm),l.createNewSyncPoints||s.updateSyncBpm(o.synthTime,o.syncTime),t.push(o)),r(h.currentTick),l}static _processBarTime(e,t,s){var i=e.calculateDuration(),a=e.syncPoints,r=s.synthTick,a=(s.createNewSyncPoints?B._processBarTimeWithNewSyncPoints(e,t,s):a?B._processBarTimeWithSyncPoints(e,t,s):B._processBarTimeNoSyncPoints(e,s),r+i),t=a-s.synthTick;0<t&&(s.synthTime+=N.ticksToMillis(t,s.currentTempo),s.synthTick=a)}static _processBarTimeWithNewSyncPoints(e,t,s){var i,a,r=s.synthTick,n=(0===e.index&&0===t&&(s.currentTempo=e.score.tempo,(i=new ca).masterBarIndex=e.index,i.masterBarOccurence=t,i.synthTick=r,i.synthBpm=s.currentTempo,i.synthTime=s.synthTime,i.syncBpm=s.currentTempo,i.syncTime=s.synthTime,s.syncPoints.push(i)),e.calculateDuration());for(a of e.tempoAutomations){var o=r+a.ratioPosition*n,h=o-s.synthTick;0<h&&(s.synthTick=o,s.synthTime+=N.ticksToMillis(h,s.currentTempo)),a.value!==s.currentTempo&&(s.currentTempo=a.value,(h=new ca).masterBarIndex=e.index,h.masterBarOccurence=t,h.synthTick=o,h.synthBpm=s.currentTempo,h.synthTime=s.synthTime,h.syncBpm=s.currentTempo,h.syncTime=s.synthTime,s.syncPoints.push(h))}}static _processBarTimeWithSyncPoints(e,t,s){let i=s.synthTick,a=e.calculateDuration(),r=0,n;for(var o of e.syncPoints)if(o.syncPointValue.barOccurence===t){for(var h=i+o.ratioPosition*a;r<e.tempoAutomations.length&&e.tempoAutomations[r].ratioPosition<=o.ratioPosition;){var l=e.tempoAutomations[r],d=i+l.ratioPosition*a;0<(n=d-s.synthTick)&&(s.synthTick=d,s.synthTime+=N.ticksToMillis(n,s.currentTempo)),s.currentTempo=l.value,r++}0<(n=h-s.synthTick)&&(s.synthTick=h,s.synthTime+=N.ticksToMillis(n,s.currentTempo)),0<s.syncPoints.length&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,o.syncPointValue.millisecondOffset);var c=new ca;c.masterBarIndex=e.index,c.masterBarOccurence=t,c.synthTick=h,c.synthBpm=s.currentTempo,c.synthTime=s.synthTime,c.syncTime=o.syncPointValue.millisecondOffset,c.syncBpm=0,s.syncPoints.push(c),s.automationToSyncPoint.set(o,c)}for(;r<e.tempoAutomations.length;){var u=e.tempoAutomations[r],p=i+u.ratioPosition*a;0<(n=p-s.synthTick)&&(s.synthTick=p,s.synthTime+=N.ticksToMillis(n,s.currentTempo)),s.currentTempo=u.value,r++}}static _processBarTimeNoSyncPoints(e,t){var s,i=t.synthTick,a=e.calculateDuration();for(s of e.tempoAutomations){var r=i+s.ratioPosition*a,n=r-t.synthTick;0<n&&(t.synthTick=r,t.synthTime+=N.ticksToMillis(n,t.currentTempo)),t.currentTempo=s.value}}static _toChannelShort(e){e=Math.max(-32768,Math.min(32767,8*e-1));return Math.max(e,-1)+1}_generateMasterBar(e,t,s,i,a){t&&t.timeSignatureDenominator===e.timeSignatureDenominator&&t.timeSignatureNumerator===e.timeSignatureNumerator||this._handler.addTimeSignature(s,e.timeSignatureNumerator,e.timeSignatureDenominator);var r=e.calculateDuration(),n=new ho;if(0<e.tempoAutomations.length){0<e.tempoAutomations[0].ratioPosition&&n.tempoChanges.push(new oo(s,i));for(var o of e.tempoAutomations){var h=s+r*o.ratioPosition;this._handler.addTempo(h,o.value),n.tempoChanges.push(new oo(h,o.value))}}else t?n.tempoChanges.push(new oo(s,i)):(this._handler.addTempo(s,e.score.tempo),n.tempoChanges.push(new oo(s,e.score.tempo)));n.masterBar=e,n.start=s,n.end=n.start+r,this.tickLookup.addMasterBar(n)}_generateBar(e,i,a){var t,s=this._getPlaybackBar(e),r=this._currentTime;for(t of s.voices)this._currentTime=r,this._generateVoice(t,i,e,a);var n=s.masterBar,o=n.calculateDuration(),n=n.tempoAutomations.slice();if(0===n.length)this._currentTime=r+N.ticksToMillis(o,a);else{this._currentTime=r;let e=i,t=a,s=i+o;for(var h of n){var l=o*h.ratioPosition-e;0<l&&(this._currentTime+=N.ticksToMillis(l,t)),t=h.value,e+=l}n=s-e;0<n&&(this._currentTime+=N.ticksToMillis(n,t))}s.id!==e.id&&this.tickLookup.addBeat(e.voices[0].beats[0],0,o)}_getPlaybackBar(e){switch(e.simileMark){case 1:e.previousBar&&(e=this._getPlaybackBar(e.previousBar));break;case 2:case 3:e.previousBar&&e.previousBar.previousBar&&(e=this._getPlaybackBar(e.previousBar.previousBar))}return e}_generateVoice(i,a,r,n){if(!i.isEmpty||i.bar.isEmpty&&0===i.index){let e=r.masterBar.tempoAutomations.slice(),t=n,s=r.masterBar.calculateDuration();for(var o of i.beats){for(var h=o.playbackStart/s;0<e.length&&e[0].ratioPosition<=h;)t=e.shift().value;this._generateBeat(o,a,r,t)}}}_generateBeat(s,i,e,t){let a=s.playbackStart,r=s.playbackDuration,n=s.voice.bar.masterBar.calculateDuration(),o=(s.voice.bar.isEmpty?r=n:0!==s.voice.bar.masterBar.tripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(a-=this._currentTripletFeel.secondBeatStartOffset,r=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=B._calculateTripletFeelInfo(a,r,s),this._currentTripletFeel&&(r=this._currentTripletFeel.firstBeatDuration))),s.showTimer&&!this._calculatedBeatTimers.has(s.id)&&(s.timer=this._currentTime,this._calculatedBeatTimers.add(s.id)),this._currentTime+=N.ticksToMillis(r,t),e===s.voice.bar&&this.tickLookup.addBeat(s,a,r),s.voice.bar.staff.track);for(var h of s.automations)this._generateNonTempoAutomation(s,h,i);if(s.isRest)this._handler.addRest(o.index,i+a,o.playbackInfo.primaryChannel);else if(s.deadSlapped)this._generateDeadSlap(s,i+a);else{var l,d=this._getBrushInfo(s),c=this._getRasgueadoInfo(s,r);for(l of s.notes)this._generateNote(l,i+a,r,t,d,c)}if(0!==s.fade&&this._generateFade(s,i+a,r),0!==s.vibrato){let e=240,t=3;switch(s.vibrato){case 1:e=this._settings.player.vibrato.beatSlightLength,t=this._settings.player.vibrato.beatSlightAmplitude;break;case 2:e=this._settings.player.vibrato.beatWideLength,t=this._settings.player.vibrato.beatWideAmplitude}this._generateVibratorWithParams(i+a,s.playbackDuration,e,0,t,(e,t)=>{this._handler.addBend(s.voice.bar.staff.track.index,e,o.playbackInfo.secondaryChannel,t)})}}static _calculateTripletFeelInfo(e,t,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case 2:case 4:case 6:i=8;break;case 1:case 3:case 5:i=16;break;default:return null}var a=N.toTicks(i);if(t!==a||e%a!=0||!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==a)return null;var r=new mo;switch(s.voice.bar.masterBar.tripletFeel){case 2:r.firstBeatDuration=N.applyTuplet(N.toTicks(4),3,2),r.secondBeatDuration=N.applyTuplet(N.toTicks(8),3,2);break;case 4:r.firstBeatDuration=N.applyDot(N.toTicks(8),!1),r.secondBeatDuration=N.toTicks(16);break;case 6:r.firstBeatDuration=N.toTicks(16),r.secondBeatDuration=N.applyDot(N.toTicks(8),!1);break;case 1:r.firstBeatDuration=N.applyTuplet(N.toTicks(8),3,2),r.secondBeatDuration=N.applyTuplet(N.toTicks(16),3,2);break;case 3:r.firstBeatDuration=N.applyDot(N.toTicks(16),!1),r.secondBeatDuration=N.toTicks(32);break;case 5:r.firstBeatDuration=N.toTicks(32),r.secondBeatDuration=N.applyDot(N.toTicks(16),!1)}return r.secondBeatStartOffset=t-r.firstBeatDuration,r}_generateDeadSlap(e,t){var s=N.toTicks(64),i=e.voice.bar.staff;if(0<i.tuning.length)for(var a of i.tuning)this._handler.addNote(i.track.index,t,s,a,N.dynamicToVelocity(5),i.track.playbackInfo.primaryChannel)}_needsSecondaryChannel(e){return e.hasBend||e.beat.hasWhammyBar||0!==e.beat.vibrato}_determineChannel(e,t){if(this._needsSecondaryChannel(t))return e.playbackInfo.secondaryChannel;let s=t;for(;s.isTieDestination;)if(s=s.tieOrigin,this._needsSecondaryChannel(s))return e.playbackInfo.secondaryChannel;for(s=t;s.isTieOrigin;)if(s=s.tieDestination,this._needsSecondaryChannel(s))return e.playbackInfo.secondaryChannel;return e.playbackInfo.primaryChannel}_generateNote(e,t,s,i,a,r){let n=e.beat.voice.bar.staff.track,o=e.beat.voice.bar.staff,h=e.calculateRealValue(this.applyTranspositionPitches,!0);e.isPercussion&&(l=rt.getArticulation(e))&&(h=l.outputMidiNumber);var l=null==r&&e.isStringed&&e.string<=a.length?a[e.string-1]:0,a=t+l,t=this._getNoteDuration(e,s,i);t.untilTieOrSlideEnd-=l,t.noteOnly-=l,t.letRingEnd-=l;let d=B._getNoteVelocity(e),c=this._determineChannel(n,e),u=0,p=Math.max(t.untilTieOrSlideEnd,t.letRingEnd);0<=(u=e.hasBend?B.getPitchWheel(e.bendPoints[0].value):e.beat.hasWhammyBar?B.getPitchWheel(e.beat.whammyBarPoints[0].value):e.isTieDestination||e.slideOrigin&&2===e.slideOrigin.slideOutType?-1:B.getPitchWheel(0))&&this._handler.addNoteBend(n.index,a,c,h,u),e.beat.hasRasgueado?this._generateRasgueado(n,e,a,h,d,c,r):0!==e.ornament?this._generateOrnament(n,e,a,p,h,d,c):e.isTrill&&!o.isPercussion?this._generateTrill(e,a,t,h,d,c):e.beat.isTremolo?this._generateTremoloPicking(e,a,t,h,d,c):(e.hasBend?this._generateBend(e,a,t,h,c,i):e.beat.hasWhammyBar&&0===e.index?this._generateWhammy(e.beat,a,t,c,i):0!==e.slideInType||0!==e.slideOutType?this._generateSlide(e,a,t,h,c,i):(0!==e.vibrato||e.isTieDestination&&0!==e.tieOrigin.vibrato)&&this._generateVibrato(e,a,t,h,c),e.isTieDestination||e.slideOrigin&&2===e.slideOrigin.slideOutType||this._handler.addNote(n.index,a,p,h,d,c))}_generateOrnament(t,e,s,i,a,r,n){let o,h,l=a%12;switch(e.ornament){case 2:o=[a+B._ornamentKeysUp[l],a,a+B.ornamentKeysDown[l]],h=[N.toTicks(16)*(1/3),N.toTicks(16)*(1/3),N.toTicks(16)*(1/3)];break;case 1:o=[a+B.ornamentKeysDown[l],a,a+B._ornamentKeysUp[l]],h=[N.toTicks(16)*(1/3),N.toTicks(16)*(1/3),N.toTicks(16)*(1/3)];break;case 3:o=[a,a+B._ornamentKeysUp[l]],h=[N.toTicks(32),N.toTicks(32)];break;case 4:o=[a,a+B.ornamentKeysDown[l]],h=[N.toTicks(32),N.toTicks(32)];break;default:return}let d=1,c=(i<N.QuarterTime&&(d=i/N.QuarterTime),r-=N.VelocityIncrement,0);for(let e=0;e<o.length;e++){var u=h[e]*d;this._handler.addNote(t.index,s,u,o[e],r,n),s+=u,c+=u}e=i-c;this._handler.addNote(t.index,s,e,a,r,n)}_getNoteDuration(i,a,e){var t,s,r,n=new po;if(n.noteOnly=a,n.untilTieOrSlideEnd=a,n.letRingEnd=a,i.isDead)n.noteOnly=this._applyStaticDuration(B._defaultDurationDead,a,e),n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly;else if(i.isPalmMute)n.noteOnly=this._applyStaticDuration(B._defaultDurationPalmMute,a,e),n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly;else if(i.isStaccato)n.noteOnly=a/2|0,n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly;else if(i.isTieOrigin?(s=i.tieDestination)&&(i.isTieDestination?(r=this._getNoteDuration(s,s.beat.playbackDuration,e),n.untilTieOrSlideEnd=a+r.untilTieOrSlideEnd):(r=i.beat.absolutePlaybackStart,t=this._getNoteDuration(s,s.beat.playbackDuration,e),s=s.beat.absolutePlaybackStart+t.untilTieOrSlideEnd,n.untilTieOrSlideEnd=s-r)):2===i.slideOutType&&(t=i.slideTarget)&&(s=i.beat.absolutePlaybackStart,r=this._getNoteDuration(t,t.beat.playbackDuration,e),e=t.beat.absolutePlaybackStart+r.untilTieOrSlideEnd,n.untilTieOrSlideEnd=e-s),i.isLetRing&&0===this._settings.notation.notationMode){let e=i.beat,t=0,s=i.beat.voice.bar.masterBar.calculateDuration();for(;e.nextBeat;){var o=e.nextBeat;if(o.isRest||i.isStringed&&o.hasNoteOnString(i.string))break;if(e=e.nextBeat,(t=e.absolutePlaybackStart-i.beat.absolutePlaybackStart+e.playbackDuration)>s){t=s;break}}e===i.beat?n.letRingEnd=a:n.letRingEnd=t}else n.letRingEnd=n.untilTieOrSlideEnd;return n}_applyStaticDuration(e,t,s){return Math.min(s*e/w.MaxPosition|0,t)}static _getNoteVelocity(e){let t=0;switch(!e.beat.voice.bar.staff.isPercussion&&e.hammerPullOrigin&&t--,e.isGhost&&t--,e.accentuated){case 1:t++;break;case 2:t+=2}return N.dynamicToVelocity(e.dynamics,t)}_generateFade(e,t,s){var i=e.voice.bar.staff.track;switch(e.fade){case 1:this._generateFadeSteps(i,t,s,0,B._toChannelShort(i.playbackInfo.volume));break;case 2:this._generateFadeSteps(i,t,s,B._toChannelShort(i.playbackInfo.volume),0);break;case 3:var a=s/2|0;this._generateFadeSteps(i,t,a,0,B._toChannelShort(i.playbackInfo.volume)),this._generateFadeSteps(i,t+a,a,B._toChannelShort(i.playbackInfo.volume),0)}}_generateFadeSteps(t,s,e,i,a){var r=(a-i)/(e=.8*e|0),n=e/120+1|0,o=s+e;for(let e=0;e<n;e++){var h=e===n-1,l=h?o:s+120*e,h=h?a:Math.round(i+(l-s)*r);this._handler.addControlChange(t.index,l,t.playbackInfo.primaryChannel,7,h),this._handler.addControlChange(t.index,l,t.playbackInfo.secondaryChannel,7,h)}}_generateVibrato(e,t,s,i,a){let r=0,n=0;switch(0!==e.vibrato?e.vibrato:e.isTieDestination?e.tieOrigin.vibrato:1){case 1:r=this._settings.player.vibrato.noteSlightLength,n=this._settings.player.vibrato.noteSlightAmplitude;break;case 2:r=this._settings.player.vibrato.noteWideLength,n=this._settings.player.vibrato.noteWideAmplitude;break;default:return}let o=e.beat.voice.bar.staff.track,h=0;e.isTieDestination&&e.tieOrigin.hasBend&&(e=e.tieOrigin.bendPoints,h=e[e.length-1].value),this._generateVibratorWithParams(t,s.noteOnly,r,h,n,(e,t)=>{this._handler.addNoteBend(o.index,e,a,i,t)})}_generateVibratorWithParams(s,e,i,a,r,n){for(var o=this.vibratoResolution,h=i/2|0,l=s+e;s<l;){let e=0,t=s+i<l?i:l-s;for(;e<t;){var d=a+r*Math.sin(e*Math.PI/h);n(s+e|0,B.getPitchWheel(d)),e+=o}s+=i}n(0|l,B.getPitchWheel(a))}static getPitchWheel(e){return _.DefaultPitchWheel+e/2*B._pitchValuePerSemitone}_generateSlide(e,t,s,i,a,r){let n=2===e.slideOutType?s.noteOnly:s.untilTieOrSlideEnd,o=[],h=e.beat.voice.bar.staff.track,l=this._settings.player.slide.simpleSlidePitchOffset,d=Math.floor(w.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),c=Math.floor(w.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(e.slideInType){case 2:o.push(new w(0,l)),o.push(new w(d,0));break;case 1:o.push(new w(0,-l)),o.push(new w(d,0))}switch(e.slideOutType){case 2:case 1:o.push(new w(c,0));var u=2*(e.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-e.calculateRealValue(this.applyTranspositionPitches,!0));o.push(new w(w.MaxPosition,u));break;case 4:o.push(new w(w.MaxPosition-d,0)),o.push(new w(w.MaxPosition,-l));break;case 3:o.push(new w(w.MaxPosition-d,0)),o.push(new w(w.MaxPosition,l))}this._generateWhammyOrBend(t,n,o,r,(e,t)=>{this._handler.addNoteBend(h.index,e,a,i,t)})}_generateBend(t,e,s,i,a,r){let n=t.bendPoints,o=t.beat.voice.bar.staff.track,h=(e,t)=>{this._handler.addNoteBend(o.index,e,a,i,t)},l=null,d;if(t.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let e=t;for(;e.isTieOrigin&&!e.tieDestination.hasBend&&0===e.tieDestination.vibrato;)e=e.tieDestination;d=e.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this._getNoteDuration(e,e.beat.playbackDuration,r).noteOnly}else if(t.isTieOrigin&&0!==t.beat.graceType){switch(t.tieDestination.bendType){case 2:case 4:case 7:l=t.tieDestination.bendPoints[1].value;break;case 6:case 8:l=t.tieDestination.bendPoints[0].value}d=Math.max(s.noteOnly,N.millisToTicks(this._settings.player.songBookBendDuration,r))}else d=s.noteOnly;0<n[0].value&&!t.isContinuedBend&&0<e&&e--;let c=Math.min(d,N.millisToTicks(this._settings.player.songBookBendDuration,r)),u=[];switch(t.bendType){case 1:u=n;break;case 2:case 3:switch(t.bendStyle){case 0:u=n;break;case 1:u.push(new w(0,t.bendPoints[0].value)),(!l||l<t.bendPoints[1].value)&&(l=t.bendPoints[1].value),u.push(new w(w.MaxPosition,l));break;case 2:return(!l||l<t.bendPoints[1].value)&&(l=t.bendPoints[1].value),void(3===t.beat.graceType?this._generateSongBookWhammyOrBend(e,d,!0,[t.bendPoints[0].value,l],c,r,h):this._generateSongBookWhammyOrBend(e,d,!1,[t.bendPoints[0].value,l],c,r,h))}break;case 4:switch(t.bendStyle){case 0:u=n;break;case 1:u.push(new w(0,t.bendPoints[0].value)),u.push(new w(w.MaxPosition/2|0,t.bendPoints[1].value)),u.push(new w(w.MaxPosition,t.bendPoints[2].value));break;case 2:return void this._generateSongBookWhammyOrBend(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],c,r,h)}break;case 5:case 6:u=n;break;case 7:switch(t.bendStyle){case 0:u=n;break;case 1:u.push(new w(0,t.bendPoints[0].value)),u.push(new w(w.MaxPosition,t.bendPoints[1].value));break;case 2:return h(e,0|B.getPitchWheel(t.bendPoints[0].value)),(!l||l<t.bendPoints[1].value)&&(l=t.bendPoints[1].value),void this._generateSongBookWhammyOrBend(e,d,!1,[t.bendPoints[0].value,l],c,r,h)}break;case 8:switch(t.bendStyle){case 0:u=n;break;case 1:u.push(new w(0,t.bendPoints[0].value)),u.push(new w(w.MaxPosition,t.bendPoints[1].value));break;case 2:return h(e,0|B.getPitchWheel(t.bendPoints[0].value)),void this._generateSongBookWhammyOrBend(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value],c,r,h)}}this._generateWhammyOrBend(e,d,u,r,h)}_generateSongBookWhammyOrBend(e,t,s,i,a,r,n){var o=s?e:e+t-a,h=a/(i.length-1);for(let e=0;e<i.length-1;e++){var l=B.getPitchWheel(i[e]),d=B.getPitchWheel(i[e+1]),c=o+h*e;this._generateBendValues(c,h,l,d,r,n)}}_generateWhammy(e,t,s,i,a){let r=e.whammyBarPoints,n=e.voice.bar.staff.track,o=s.noteOnly,h=(0<r[0].value&&!e.isContinuedWhammy&&t--,(e,t)=>{this._handler.addBend(n.index,e,i,t)}),l=[];switch(e.whammyBarType){case 1:l=r;break;case 2:switch(e.whammyStyle){case 0:l=r;break;case 1:l.push(new w(0,r[0].value)),l.push(new w(w.MaxPosition,r[1].value));break;case 2:var d=Math.min(o,N.millisToTicks(this._settings.player.songBookBendDuration,a));return void this._generateSongBookWhammyOrBend(t,o,!1,[r[0].value,r[1].value],d,a,h)}break;case 3:switch(e.whammyStyle){case 0:l=r;break;case 1:l.push(new w(0,r[0].value)),l.push(new w(w.MaxPosition/2|0,r[1].value)),l.push(new w(w.MaxPosition,r[2].value));break;case 2:var c=Math.min(o,N.millisToTicks(this._settings.player.songBookDipDuration,a));return void this._generateSongBookWhammyOrBend(t,o,!0,[r[0].value,r[1].value,r[2].value],c,a,h)}break;case 4:case 5:l=r;break;case 6:switch(e.whammyStyle){case 0:l=r;break;case 1:l.push(new w(0,r[0].value)),l.push(new w(w.MaxPosition/2|0,r[0].value)),l.push(new w(w.MaxPosition,r[1].value));break;case 2:var u=B.getPitchWheel(r[0].value),u=(this._handler.addBend(n.index,t,i,0|u),Math.min(o,N.millisToTicks(this._settings.player.songBookBendDuration,a)));return void this._generateSongBookWhammyOrBend(t,o,!1,[r[0].value,r[1].value],u,a,h)}}this._generateWhammyOrBend(t,o,l,a,h)}_generateWhammyOrBend(t,e,s,i,a){var r=e/w.MaxPosition;for(let e=0;e<s.length-1;e++){var n=s[e],o=s[e+1],h=B.getPitchWheel(n.value),l=B.getPitchWheel(o.value),o=r*(o.offset-n.offset),n=t+r*n.offset;this._generateBendValues(n,o,h,l,i,a)}}_generateBendValues(t,e,s,i,a,r){var a=N.ticksToMillis(e,a),n=Math.abs(i-s)/B._pitchValuePerSemitone,o=Math.max(B._minBreakpointsPerSemitone*n,a/B._millisecondsPerBreakpoint),h=e/o,l=(i-s)/o,n=t+e;for(let e=0;e<o;e++)r(0|t,Math.round(s)),s+=l,t+=h;r(0|n,i)}_generateRasgueado(t,s,e,i,a,r,n){let o=e;for(let e=0;e<n.durations.length;e++){var h=n.brushInfos[e],h=s.isStringed&&s.string<=h.length?h[s.string-1]:0,l=n.durations[e];this._handler.addNote(t.index,o+h,l-h,i,a,r),o+=l}}_generateTrill(e,t,s,i,a,r){let n=e.beat.voice.bar.staff.track,o=e.stringTuning+e.trillFret,h=N.toTicks(e.trillSpeed),l=!0,d=t,c=t+s.untilTieOrSlideEnd;for(;d+10<c;)d+h>=c&&(h=c-d),this._handler.addNote(n.index,d,h,l?o:i,a,r),l=!l,d+=h}_generateTremoloPicking(e,t,s,i,a,r){let n=e.beat.voice.bar.staff.track,o=N.toTicks(e.beat.tremoloSpeed),h=t,l=t+s.untilTieOrSlideEnd;for(;h+10<l;)h+o>=l&&(o=l-h),this._handler.addNote(n.index,h,o,i,a,r),h+=o}_getRasgueadoInfo(t,s){if(!t.hasRasgueado)return null;let i=new go,a=B._rasgueadoDurations.get(t.rasgueado).reduce((e,t)=>e+t,0),r=(i.durations=B._rasgueadoDurations.get(t.rasgueado).map(e=>s*e/a),i.brushInfos=new Array(i.durations.length),N.toTicks(16)),n=0,o=0;for(var e of t.notes)e.isTieDestination||(n|=1<<e.string-1,o++);var h=B._rasgueadoDirections.get(t.rasgueado);for(let e=0;e<i.durations.length;e++){var l=i.durations[e]*r/N.QuarterTime,d=new Int32Array(t.voice.bar.staff.tuning.length),c=(i.brushInfos[e]=d,h[e]);0!==c&&this._fillBrushInfo(t,d,4===c||2===c,n,o,l)}return i}_getBrushInfo(s){var i=new Int32Array(s.voice.bar.staff.tuning.length);if(s.brushType){let e=0,t=0;for(var a of s.notes)a.isTieDestination||(e|=1<<a.string-1,t++);this._fillBrushInfo(s,i,4===s.brushType||2===s.brushType,e,t,s.brushDuration)}return i}_fillBrushInfo(i,a,r,n,e,o){if(0<i.notes.length){let t=0,s=o/(e-1)|0;for(let e=0;e<i.voice.bar.staff.tuning.length;e++){var h=r?e:a.length-1-e;0!=(n&1<<h)&&(a[h]=t,t+=s)}}return a}_generateNonTempoAutomation(e,t,s){switch(t.type){case 2:this._addProgramChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,255&(0|t.value)),this._addProgramChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,255&(0|t.value));break;case 4:this._addBankChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,t.value),this._addBankChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,t.value);break;case 3:var i=B._toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,10,i),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,10,i);break;case 1:i=B._toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,7,i),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,7,i)}}prepareSingleBeat(e){let t=-1,s=-1,i=e;for(;i&&(-1===t||-1===s);){for(var a of e.automations)switch(a.type){case 2:s=a.value;break;case 0:t=a.value}i=i.previousBeat}var r,n=e.voice.bar.staff.track,o=e.voice.bar.masterBar,h=(-1===t&&(t=o.score.tempo),e.playbackStart/o.calculateDuration());for(r of o.tempoAutomations){if(!(r.ratioPosition<=h))break;t=r.value}-1===s&&(s=n.playbackInfo.program);var l=n.playbackInfo.volume,o=(this._generateTrack(n),this._handler.addTimeSignature(0,o.timeSignatureNumerator,o.timeSignatureDenominator),this._handler.addTempo(0,t),B._toChannelShort(l));return this._handler.addControlChange(0,0,n.playbackInfo.primaryChannel,7,o),this._handler.addControlChange(0,0,n.playbackInfo.secondaryChannel,7,o),t}generateSingleBeat(e){var t=this.prepareSingleBeat(e);this._generateBeat(e,-e.playbackStart,e.voice.bar,t)}generateSingleNote(e){var t=this.prepareSingleBeat(e.beat);this._generateNote(e,0,e.beat.playbackDuration,t,new Int32Array(e.beat.voice.bar.staff.tuning.length),null)}},bo=(B._defaultDurationDead=30,B._defaultDurationPalmMute=80,B._ornamentKeysUp=[2,2,2,1,1,2,2,2,2,2,1,1],B.ornamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],B._pitchBendRangeInSemitones=16,B._pitchValuePerSemitone=_.DefaultPitchWheel/B._pitchBendRangeInSemitones,B._minBreakpointsPerSemitone=6,B._millisecondsPerBreakpoint=150,B._rasgueadoDirections=new Map([[1,[2,1]],[2,[2,2]],[3,[2,2,1]],[4,[2,2,1]],[5,[1,2,2]],[6,[1,2,2]],[7,[1,2,2]],[8,[1,2,2]],[9,[1,2,2]],[10,[1,2,2]],[11,[2,2,2]],[12,[2,2,2]],[13,[0,2,1]],[14,[2,2,2,1]],[15,[2,2,2,1]],[16,[2,2,2,2]],[17,[2,2,2,2,1]],[18,[2,2,2,2,1]]]),B._rasgueadoDurations=new Map([[1,[N.toTicks(8),N.toTicks(8)]],[2,[N.toTicks(8),N.toTicks(8)]],[3,[N.toTicks(8)/3,N.toTicks(8)/3,N.toTicks(8)/3]],[4,[N.toTicks(16),N.toTicks(16),N.toTicks(8)]],[5,[N.toTicks(8)/3,N.toTicks(8)/3,N.toTicks(8)/3]],[6,[N.toTicks(16)/3,N.toTicks(16)/3,N.toTicks(8)/3]],[7,[N.toTicks(8)/3,N.toTicks(8)/3,N.toTicks(8)/3]],[8,[N.toTicks(16),N.toTicks(16),N.toTicks(8)]],[9,[N.toTicks(8)/3,N.toTicks(8)/3,N.toTicks(8)/3]],[10,[N.toTicks(16),N.toTicks(16),N.toTicks(8)]],[11,[N.toTicks(8)/3,N.toTicks(8)/3,N.toTicks(8)/3]],[12,[N.toTicks(16)/3,N.toTicks(16)/3,N.toTicks(8)/3]],[13,[N.toTicks(16)/3,N.toTicks(16)/3,N.toTicks(8)/3]],[14,[N.toTicks(16)/3,N.toTicks(16)/3,N.toTicks(16)/3,N.toTicks(8)]],[15,[N.toTicks(16)/3,N.toTicks(16)/3,N.toTicks(16)/3,N.toTicks(8)]],[16,[N.toTicks(16),N.toTicks(16),N.toTicks(16),N.toTicks(16)]],[17,[N.toTicks(16)/5,N.toTicks(16)/5,N.toTicks(16)/5,N.toTicks(16)/5,N.toTicks(16)/5]],[18,[N.toTicks(16)/5,N.toTicks(16)/5,N.toTicks(16)/5,N.toTicks(16)/5,N.toTicks(16)/5]]]),B),yo=class{constructor(){this.oldWidth=0,this.newWidth=0,this.settings=null}},zt=class{constructor(e,t){this.width=0,this.height=0,this.x=e,this.y=t}getBoundingBoxTop(){return this.y}doLayout(){}paint(e,t,s){}},Yt=class extends zt{constructor(e=0,t=0){super(e,t),this.beat=null,this.nextGlyph=null,this.previousGlyph=null}},_o=class extends Yt{constructor(e,t,s,i){super(e,t),this.glyphScale=0,this.center=!1,this.offsetX=0,this.offsetY=0,this.glyphScale=s,this.symbol=i}getBoundingBoxTop(){var e=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-e}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(e,t,s){var i;0===this.width&&0===this.height||(i=s.color,this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(e+this.x+this.offsetX,t+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),s.color=i)}},So=class extends Yt{constructor(e,t,s,i){super(e,t),this.glyphScale=0,this.center=!1,this.offsetX=0,this.offsetY=0,this.glyphScale=s,this.symbols=i}getBoundingBoxTop(){let t=0;for(let e=0;e<this.symbols.length;e++){var s=this.renderer.smuflMetrics.glyphTop.get(this.symbols[e]);(0===e||s<t)&&(t=s)}return this.y-this.offsetY-t}doLayout(){this.width=0;for(let e=this.height=0;e<this.symbols.length;e++){var t=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[e])*this.glyphScale,s=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[e])*this.glyphScale;(0===e||t>this.width)&&(this.width=t),(0===e||s>this.height)&&(this.height=s)}}paint(e,t,s){var i;0===this.width&&0===this.height||(i=s.color,this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbols(e+this.x+this.offsetX,t+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),s.color=i)}},vo=class vo extends _o{constructor(e,t,s,i){super(e,t,i?vo.GraceScale:1,vo.getSymbol(s)),this.centerOnStem=!1}paint(e,t,s){this.centerOnStem&&(this.center=!0),super.paint(e,t,s)}static getSymbol(e){switch(e){case-4:return 57505;case-2:return 57504;case 1:return 57506;case 2:return 57507;default:return 57508}}},ko=(vo.GraceScale=.75,vo),wo=class Dp extends _o{constructor(e,t,s,i,a){super(e,t,a?ko.GraceScale:1,Dp.getSymbol(s,i,a))}static getSymbol(e,t,s){if(s&&(e=8),0===t)switch(e){case 8:return 57920;case 16:return 57922;case 32:return 57924;case 64:return 57926;case 128:return 57928;case 256:return 57930;default:return 57920}switch(e){case 8:return 57921;case 16:return 57923;case 32:return 57925;case 64:return 57927;case 128:case 256:return 57929;default:return 57921}}},To=class Ip extends zt{constructor(e,t){super(0,0),this.ties=[],this.minWidth=0,this.beat=e,this.ties=[],this.voiceContainer=t}get onTimeX(){return this.onNotes.x+this.onNotes.centerX}addTie(e){e.renderer=this.renderer,this.ties.push(e)}drawBeamHelperAsFlags(e){return e.hasFlag(!1,void 0)}registerLayoutingInfo(e){let t=this.preNotes.computedWidth+this.onNotes.centerX,s=this.onNotes.computedWidth-this.onNotes.centerX,i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(0!==this.beat.graceType||i&&this.drawBeamHelperAsFlags(i))&&(s+=this.renderer.smuflMetrics.glyphWidths.get(57920)*ko.GraceScale);for(var a of this.ties)s+=a.width;e.addBeatSpring(this.beat,t,s)}applyLayoutingInfo(e){this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,(this.preNotes.container=this).preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,(this.onNotes.container=this).onNotes.doLayout(),this.onNotes.updateBeamingHelper();let e=this.beat.notes.length-1;for(;0<=e;)this.createTies(this.beat.notes[e--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){var e,t;this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest&&1===this.onNotes.beamingHelper.beats.length&&8<=this.beat.duration&&(e=wo.getSymbol(this.beat.duration,this.onNotes.beamingHelper.direction,0!==this.beat.graceType),this.minWidth+=this.renderer.smuflMetrics.glyphWidths.get(e));let s=0;for(t of this.ties)t.width>s&&(s=t.width);this.minWidth+=s,this.width=this.minWidth}scaleToWidth(e){this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return"b"+e.id}paint(e,t,s){if(!this.preNotes.isEmpty||!this.onNotes.isEmpty||0!==this.ties.length){s.beginGroup(Ip.getGroupId(this.beat)),this.preNotes.paint(e+this.x,t+this.y,s),this.onNotes.paint(e+this.x,t+this.y,s);var i=e-this.voiceContainer.x-this.renderer.x,a=t-this.voiceContainer.y-this.renderer.y;for(let e=0,t=this.ties.length;e<t;e++){var r=this.ties[e];r.renderer=this.renderer,r.paint(i,a,s)}s.endGroup()}}buildBoundingsLookup(t,s,e,i){var a=new os;if(a.beat=this.beat,this.beat.isEmpty)a.visualBounds=new hs,a.visualBounds.x=s+this.x,a.visualBounds.y=t.visualBounds.y,a.visualBounds.w=this.width,a.visualBounds.h=t.visualBounds.h,a.realBounds=new hs,a.realBounds.x=s+this.x,a.realBounds.y=t.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=t.realBounds.h,a.onNotesX=s+this.x+this.onNotes.centerX;else{a.visualBounds=new hs,a.visualBounds.x=s+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?a.visualBounds.x=s+this.x:a.visualBounds.x=s+this.x+this.onNotes.x:a.visualBounds.x=s+this.x+this.preNotes.x;let e=0;e=this.onNotes.isEmpty?this.preNotes.isEmpty?s+this.x+this.width:s+this.x+this.preNotes.x+this.preNotes.width:s+this.x+this.onNotes.x+this.onNotes.width,a.visualBounds.w=e-a.visualBounds.x;var r=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(r&&this.drawBeamHelperAsFlags(r)||0!==this.beat.graceType)&&(a.visualBounds.w+=this.renderer.smuflMetrics.glyphWidths.get(57920)*(0!==this.beat.graceType?ko.GraceScale:1)),a.visualBounds.y=t.visualBounds.y,a.visualBounds.h=t.visualBounds.h,a.realBounds=new hs,a.realBounds.x=s+this.x,a.realBounds.y=t.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=t.realBounds.h,a.onNotesX=s+this.x+this.onNotes.x+this.onNotes.centerX}t.addBeat(a),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(a,s+this.x,e+this.y)}},Bo=class{constructor(){this._width=0,this._score=null,this._trackIndexes=null,this.preRender=new g,this.renderFinished=new g,this.partialRenderFinished=new g,this.partialLayoutFinished=new g,this.postRenderFinished=new rs,this.error=new g}get instance(){return this._instance}set instance(e){this._instance=e;var t=this._instanceEventUnregister;if(t)for(var s of t)s();e?((t=[]).push(e.preRender.on(e=>this.preRender.trigger(e))),t.push(e.renderFinished.on(e=>this.renderFinished.trigger(e))),t.push(e.partialRenderFinished.on(e=>this.partialRenderFinished.trigger(e))),t.push(e.partialLayoutFinished.on(e=>this.partialLayoutFinished.trigger(e))),t.push(e.postRenderFinished.on(()=>this.postRenderFinished.trigger())),t.push(e.error.on(e=>this.error.trigger(e))),this._instanceEventUnregister=t,this._settings&&e.updateSettings(this._settings),e.width=this._width,null!==this._score&&e.renderScore(this._score,this._trackIndexes)):this._instanceEventUnregister=void 0}get boundsLookup(){return this._instance?this._instance.boundsLookup:null}get width(){return this._instance?this._instance.width:0}set width(e){this._width=e,this._instance&&(this._instance.width=e)}render(){this._instance?.render()}resizeRender(){this._instance?.resizeRender()}renderScore(e,t){this._score=e,this._trackIndexes=t,this._instance?.renderScore(e,t)}renderResult(e){this._instance?.renderResult(e)}updateSettings(e){this._settings=e,this._instance?.updateSettings(e)}destroy(){this._instance?.destroy(),this._instance=void 0}},xo=class{constructor(e){this.activeBeats=e}},Po=class{constructor(){this._masterVolume=1,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=1,this._isLooping=!1,this._midiEventsPlayedFilter=[],this.finished=new rs,this.soundFontLoaded=new rs,this.soundFontLoadFailed=new g,this.midiLoadFailed=new g,this.midiEventsPlayed=new g,this.ready=new rs(()=>this.isReady),this.readyForPlayback=new rs(()=>this.isReadyForPlayback),this.midiLoaded=new g(()=>this._instance?.loadedMidiInfo??null),this.stateChanged=new g(()=>new fa(this.state,!1)),this.positionChanged=new g(()=>this.currentPosition),this.playbackRangeChanged=new g(()=>{var e=this.playbackRange;return e?new Ir(e):null})}get instance(){return this._instance}set instance(e){this._instance=e;var t=this._instanceEventUnregister;if(t)for(var s of t)s();e?((t=[]).push(e.ready.on(()=>this.ready.trigger())),t.push(e.readyForPlayback.on(()=>this.readyForPlayback.trigger())),t.push(e.finished.on(()=>this.finished.trigger())),t.push(e.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),t.push(e.soundFontLoadFailed.on(e=>this.soundFontLoadFailed.trigger(e))),t.push(e.midiLoaded.on(e=>{this.midiLoaded.trigger(e)})),t.push(e.midiLoadFailed.on(e=>this.midiLoadFailed.trigger(e))),t.push(e.stateChanged.on(e=>this.stateChanged.trigger(e))),t.push(e.positionChanged.on(e=>{this.positionChanged.trigger(e)})),t.push(e.midiEventsPlayed.on(e=>this.midiEventsPlayed.trigger(e))),t.push(e.playbackRangeChanged.on(e=>this.playbackRangeChanged.trigger(e))),this._instanceEventUnregister=t,this.isReady?(e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter,this.ready.trigger()):t.push(e.ready.on(()=>{e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter}))):this._instanceEventUnregister=void 0}get output(){return this._instance.output}get isReady(){return!!this._instance&&this._instance.isReady}get isReadyForPlayback(){return!!this._instance&&this._instance.isReadyForPlayback}get state(){return this._instance?this._instance.state:0}get logLevel(){return M.logLevel}set logLevel(e){M.logLevel=e,this._instance&&(this._instance.logLevel=e)}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,_.MinVolume),this._masterVolume=e,this._instance&&(this._instance.masterVolume=e)}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,_.MinVolume),this._metronomeVolume=e,this._instance&&(this._instance.metronomeVolume=e)}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._instance&&(this._instance.playbackSpeed=e)}get loadedMidiInfo(){return this._instance?this._instance.loadedMidiInfo:void 0}get currentPosition(){return this._instance?this._instance.currentPosition:new ba(0,0,0,0,!1,120,120)}get tickPosition(){return this._instance?this._instance.tickPosition:0}set tickPosition(e){this._instance&&(this._instance.tickPosition=e)}get timePosition(){return this._instance?this._instance.timePosition:0}set timePosition(e){this._instance&&(this._instance.timePosition=e)}get playbackRange(){return this._instance?this._instance.playbackRange:null}set playbackRange(e){this._instance&&(this._instance.playbackRange=e)}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._instance&&(this._instance.isLooping=e)}get countInVolume(){return this._countInVolume}set countInVolume(e){this._countInVolume=e,this._instance&&(this._instance.countInVolume=e)}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._instance&&(this._instance.midiEventsPlayedFilter=e)}destroy(){this._instance&&(this._instance.destroy(),this._instance=void 0)}play(){return!!this._instance&&this._instance.play()}pause(){this._instance&&this._instance.pause()}playPause(){this._instance&&this._instance.playPause()}stop(){this._instance&&this._instance.stop()}playOneTimeMidiFile(e){this._instance&&this._instance.playOneTimeMidiFile(e)}loadSoundFont(e,t){this._instance&&this._instance.loadSoundFont(e,t)}resetSoundFonts(){this._instance&&this._instance.resetSoundFonts()}loadMidiFile(e){this._instance&&this._instance.loadMidiFile(e)}loadBackingTrack(e){this._instance&&this._instance.loadBackingTrack(e)}updateSyncPoints(e){this._instance&&this._instance.updateSyncPoints(e)}applyTranspositionPitches(e){this._instance&&this._instance.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this._instance&&this._instance.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this._instance&&this._instance.setChannelMute(e,t)}resetChannelStates(){this._instance&&this._instance.resetChannelStates()}setChannelSolo(e,t){this._instance&&this._instance.setChannelSolo(e,t)}setChannelVolume(e,t){this._instance&&this._instance.setChannelVolume(e,t)}},No=class{constructor(){this._midiEventQueue=new Lr,this.masterVolume=1,this.metronomeVolume=0,this.outSampleRate=44100,this.currentTempo=120,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.activeVoiceCount=0}noteOffAll(e){}resetSoft(){}resetPresets(){}loadPresets(e,t,s,i){}setupMetronomeChannel(e){}synthesizeSilent(e){this.fakeSynthesize()}_processMidiMessage(e){}dispatchEvent(e){this._midiEventQueue.enqueue(e)}synthesize(e,t,s){return this.fakeSynthesize()}fakeSynthesize(){for(var e=[];!this._midiEventQueue.isEmpty;){var t=this._midiEventQueue.dequeue();t.isMetronome&&0<this.metronomeVolume||t.event&&this._processMidiMessage(t.event),e.push(t)}return e}applyTranspositionPitches(e){}setChannelTranspositionPitch(e,t){}channelSetMute(e,t){}channelSetSolo(e,t){}resetChannelStates(){}channelSetMixVolume(e,t){}hasSamplesForProgram(e){return!0}hasSamplesForPercussion(e){return!0}},Mo=class extends Or{constructor(t,e){super(t,new No,e),this.synthesizer.output=t,(this._backingTrackOutput=t).timeUpdate.on(e=>{e=this.sequencer.mainTimePositionFromBackingTrack(e,t.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(e),this.synthesizer.fakeSynthesize(),this.updateTimePosition(e,!1),this.checkForFinish()})}updateMasterVolume(e){super.updateMasterVolume(e),this._backingTrackOutput.masterVolume=e}updatePlaybackSpeed(e){super.updatePlaybackSpeed(e),this._backingTrackOutput.playbackRate=e}onSampleRequest(){}loadMidiFile(e){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(e)}updateTimePosition(e,t){super.updateTimePosition(e,t),t&&this._backingTrackOutput.seekTo(this.sequencer.mainTimePositionToBackingTrack(e,this._backingTrackOutput.backingTrackDuration))}loadBackingTrack(e){e=e.backingTrack;e&&(this._backingTrackOutput.loadBackingTrack(e),this.timePosition=0)}updateSyncPoints(e){this.sequencer.mainUpdateSyncPoints(e),this.tickPosition=this.tickPosition}},Eo=class{constructor(){this.sampleRate=44100,this._seekPosition=0,this.ready=new rs,this.samplesPlayed=new g,this.timeUpdate=new g,this.sampleRequest=new rs}get handler(){return this._handler}set handler(e){e&&0!==this._seekPosition&&(e.seekTo(this._seekPosition),this._seekPosition=0),this._handler=e}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(e){var t=this.handler;t&&(t.playbackRate=e)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(e){var t=this.handler;t&&(t.masterVolume=e)}seekTo(e){var t=this.handler;t?t.seekTo(e):this._seekPosition=e}loadBackingTrack(e){}open(e){this.ready.trigger()}updatePosition(e){this.timeUpdate.trigger(e)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(e){}resetSamples(){}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}},Lo=class extends Mo{get handler(){return this.output.handler}set handler(e){this.output.handler=e}constructor(e){super(new Eo,e)}},Co=class{constructor(){this.startTick=0,this.endTick=0}},Fo=class{constructor(e){this.bounds=null,this.beat=e}},Do=class{constructor(e,t){this._startTime=0,this._trackIndexes=null,this._trackIndexLookup=null,this._isDestroyed=!1,this._score=null,this._tracks=[],this._actualPlayerMode=0,this._tickCache=null,this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._currentBeat=null,this._currentBeatBounds=null,this._isInitialBeatCursorUpdate=!0,this._previousStateForCursor=0,this._previousCursorCache=null,this._lastScroll=0,this._isBeatMouseDown=!1,this._isNoteMouseDown=!1,this._selectionStart=null,this._selectionEnd=null,this.beatMouseDown=new g,this.beatMouseMove=new g,this.beatMouseUp=new g,this.noteMouseDown=new g,this.noteMouseMove=new g,this.noteMouseUp=new g,this.resize=new g,this.renderStarted=new g,this.renderFinished=new g,this.postRenderFinished=new rs,this.error=new g,this.midiLoad=new g,this.settingsUpdated=new rs,this.uiFacade=e,this.container=e.rootContainer,this.activeBeatsChanged=new g(()=>1===this._player.state&&this._currentBeat?new xo(this._currentBeat.beatLookup.highlightedBeats.map(e=>e.beat)):null),this.playedBeatChanged=new g(()=>1===this._player.state&&this._currentBeat?this._currentBeat.beat:null),this.scoreLoaded=new g(()=>this._score||null),this.midiLoaded=new g(()=>this._player.loadedMidiInfo??null),e.initialize(this,t),M.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),E.printEnvironmentInfo(!1),this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this._renderer=new Bo,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&E.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this._renderer.instance=this.uiFacade.createWorkerRenderer():this._renderer.instance=new ps(this.settings),this.container.resize.on(E.throttle(()=>{this._isDestroyed||this.container.width!==this._renderer.width&&this.triggerResize()},e.resizeThrottle));t=new yo;t.oldWidth=this._renderer.width,t.newWidth=0|this.container.width,t.settings=this.settings,this._onResize(t),this._renderer.preRender.on(this._onRenderStarted.bind(this)),this._renderer.renderFinished.on(e=>{this._onRenderFinished(e)}),this._renderer.postRenderFinished.on(()=>{var e=Date.now()-this._startTime;M.debug("rendering",`Rendering completed in ${e}ms`),this._onPostRenderFinished()}),this._renderer.preRender.on(e=>{this._startTime=Date.now()}),this._renderer.partialLayoutFinished.on(e=>this._appendRenderResult(e,!1)),this._renderer.partialRenderFinished.on(this._updateRenderResult.bind(this)),this._renderer.renderFinished.on(e=>{this._appendRenderResult(e,!0)}),this._renderer.error.on(this.onError.bind(this)),this._setupPlayerWrapper(),0!==this.settings.player.playerMode&&this._setupOrDestroyPlayer(),this._setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}get actualPlayerMode(){return this._actualPlayerMode}get renderer(){return this._renderer}get score(){return this._score}get tracks(){return this._tracks}_setupPlayerWrapper(){let s=new Po;(this._player=s).ready.on(()=>{this.loadMidiForScore()}),s.readyForPlayback.on(()=>{if(this._onPlayerReady(),this.tracks)for(var e of this.tracks){var t=e.playbackInfo.volume/16;s.setChannelVolume(e.playbackInfo.primaryChannel,t),s.setChannelVolume(e.playbackInfo.secondaryChannel,t)}}),s.soundFontLoaded.on(this._onSoundFontLoaded.bind(this)),s.soundFontLoadFailed.on(e=>{this.onError(e)}),s.midiLoaded.on(this._onMidiLoaded.bind(this)),s.midiLoadFailed.on(e=>{this.onError(e)}),s.stateChanged.on(this._onPlayerStateChanged.bind(this)),s.positionChanged.on(this._onPlayerPositionChanged.bind(this)),s.midiEventsPlayed.on(this._onMidiEventsPlayed.bind(this)),s.playbackRangeChanged.on(this._onPlaybackRangeChanged.bind(this)),s.finished.on(this._onPlayerFinished.bind(this))}destroy(){this._isDestroyed=!0,this._player.destroy(),this.uiFacade.destroy(),this._renderer.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();var e=this.score;e&&F.applyPitchOffsets(this.settings,e),this._updateRenderer(),this._renderer.updateSettings(this.settings),this._setupOrDestroyPlayer(),this._onSettingsUpdated()}_updateRenderer(){var e=this._renderer;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&E.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?e.instance instanceof ps&&(e.destroy(),e.instance=this.uiFacade.createWorkerRenderer()):e.instance instanceof ps||(e.destroy(),e.instance=new ps(this.settings))}load(e,t){try{return this.uiFacade.load(e,e=>{this.renderScore(e,t)},e=>{this.onError(e)})}catch(e){return this.onError(e),!1}}renderScore(e,t){var s=[];if(t)if(0===t.length)0<e.tracks.length&&s.push(e.tracks[0]);else if(1===t.length&&-1===t[0])for(var i of e.tracks)s.push(i);else for(var a of t)0<=a&&a<=e.tracks.length&&s.push(e.tracks[a]);else 0<e.tracks.length&&s.push(e.tracks[0]);this._internalRenderTracks(e,s)}renderTracks(e){if(0<e.length){var t,s=e[0].score;for(t of e)if(t.score!==s)return void this.onError(new b(0,"All rendered tracks must belong to the same score."));this._internalRenderTracks(s,e)}}_internalRenderTracks(e,t){if(F.applyPitchOffsets(this.settings,e),e!==this.score){this._score=e,this._tracks=t,this._tickCache=null,this._trackIndexes=[];for(var s of t)this._trackIndexes.push(s.index);this._trackIndexLookup=new Set(this._trackIndexes),this._onScoreLoaded(e),this.loadMidiForScore()}else{this._tracks=t;var i,a=F.computeFirstDisplayedBarIndex(e,this.settings),e=F.computeLastDisplayedBarIndex(e,this.settings,a);this._tickCache&&(this._tickCache.multiBarRestInfo=F.buildMultiBarRestInfo(this.tracks,a,e)),this._trackIndexes=[];for(i of t)this._trackIndexes.push(i.index);this._trackIndexLookup=new Set(this._trackIndexes)}this.render()}triggerResize(){var e;this.container.isVisible?((e=new yo).oldWidth=this._renderer.width,e.newWidth=this.container.width,e.settings=this.settings,this._onResize(e),this._renderer.updateSettings(this.settings),this._renderer.width=this.container.width,this._renderer.resizeRender()):(M.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{M.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()}))}_appendRenderResult(e,t){t&&(this.canvasElement.width=e.totalWidth,this.canvasElement.height=e.totalHeight,this._cursorWrapper)&&(this._cursorWrapper.width=e.totalWidth,this._cursorWrapper.height=e.totalHeight),(0<e.width||0<e.height)&&this.uiFacade.beginAppendRenderResults(e),t&&this.uiFacade.beginAppendRenderResults(null)}_updateRenderResult(e){e&&e.renderResult&&this.uiFacade.beginUpdateRenderResults(e)}tex(e,t){try{var s=new Ns,i=(s.logErrors=!0,s.initFromString(e,this.settings),s.readScore());this.renderScore(i,t)}catch(e){this.onError(e)}}loadSoundFont(e,t=!1){return this.uiFacade.loadSoundFont(e,t)}resetSoundFonts(){this._player.resetSoundFonts()}render(){this.uiFacade.canRender?(this._renderer.width=this.container.width,this._renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render())}get tickCache(){return this._tickCache}get boundsLookup(){return this._renderer.boundsLookup}get player(){return this._player.instance?this._player:null}get isReadyForPlayback(){return this._player.isReadyForPlayback}get playerState(){return this._player.state}get masterVolume(){return this._player.masterVolume}set masterVolume(e){this._player.masterVolume=e}get metronomeVolume(){return this._player.metronomeVolume}set metronomeVolume(e){this._player.metronomeVolume=e}get countInVolume(){return this._player.countInVolume}set countInVolume(e){this._player.countInVolume=e}get midiEventsPlayedFilter(){return this._player.midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._player.midiEventsPlayedFilter=e}get tickPosition(){return this._player.tickPosition}set tickPosition(e){this._player.tickPosition=e}get timePosition(){return this._player.timePosition}set timePosition(e){this._player.timePosition=e}get endTick(){return this._player.currentPosition.endTick}get endTime(){return this._player.currentPosition.endTime}get playbackRange(){return this._player.playbackRange}set playbackRange(e){this._player.playbackRange=e,this._updateSelectionCursor(e)}get playbackSpeed(){return this._player.playbackSpeed}set playbackSpeed(e){this._player.playbackSpeed=e}get isLooping(){return this._player.isLooping}set isLooping(e){this._player.isLooping=e}_destroyPlayer(){this._player.destroy(),this._previousTick=0,this._destroyCursors()}_setupOrDestroyPlayer(){let e=this.settings.player.playerMode;if(1===e){var t=this.score;if(!t)return!1;e=t?.backingTrack?.rawAudioFile?3:2}let s=null;if(e===this._actualPlayerMode)this._updateCursors();else{switch(this._destroyPlayer(),this._updateCursors(),e){case 0:s=null;break;case 2:s=this.uiFacade.createWorkerPlayer();break;case 3:s=this.uiFacade.createBackingTrackPlayer();break;case 4:s=new Lo(this.settings.player.bufferTimeInMilliseconds)}this._actualPlayerMode=e,s&&(this._player.instance=s)}return!1}loadMidiForScore(){var e,t,s,i,a;this.score&&(e=this.score,M.debug("AlphaTab","Generating Midi"),t=new Ji,s=new so(t),s=new bo(e,this.settings,s),a=F.computeFirstDisplayedBarIndex(e,this.settings),i=F.computeLastDisplayedBarIndex(e,this.settings,a),s.tickLookup.multiBarRestInfo=F.buildMultiBarRestInfo(this.tracks,a,i),s.applyTranspositionPitches=!1,s.generate(),this._tickCache=s.tickLookup,this._onMidiLoad(t),(a=this._player).loadMidiFile(t),a.loadBackingTrack(e),a.updateSyncPoints(s.syncPoints),a.applyTranspositionPitches(s.transpositionPitches))}updateSyncPoints(){var e;this.score&&(e=this.score,this._player.updateSyncPoints(bo.generateSyncPoints(e)))}changeTrackVolume(e,t){for(var s of e)this._player.setChannelVolume(s.playbackInfo.primaryChannel,t),this._player.setChannelVolume(s.playbackInfo.secondaryChannel,t)}changeTrackSolo(e,t){for(var s of e)this._player.setChannelSolo(s.playbackInfo.primaryChannel,t),this._player.setChannelSolo(s.playbackInfo.secondaryChannel,t)}changeTrackMute(e,t){for(var s of e)this._player.setChannelMute(s.playbackInfo.primaryChannel,t),this._player.setChannelMute(s.playbackInfo.secondaryChannel,t)}changeTrackTranspositionPitch(e,t){for(var s of e)this._player.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,t),this._player.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,t)}play(){return this._player.play()}pause(){this._player.pause()}playPause(){this._player.playPause()}stop(){this._player.stop()}playBeat(e){var t=new Ji,s=new so(t);new bo(e.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(e),this._player.playOneTimeMidiFile(t)}playNote(e){var t=new Ji,s=new so(t);new bo(e.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(e),this._player.playOneTimeMidiFile(t)}_destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null)}_updateCursors(){var e,t=this._hasCursor;t&&!this._cursorWrapper?((e=this.uiFacade.createCursors())&&(this._cursorWrapper=e.cursorWrapper,this._barCursor=e.barCursor,this._beatCursor=e.beatCursor,this._selectionWrapper=e.selectionWrapper,this._isInitialBeatCursorUpdate=!0),null!==this._currentBeat&&this._cursorUpdateBeat(this._currentBeat,!1,10<this._previousTick,1,!0)):!t&&this._cursorWrapper&&this._destroyCursors()}_cursorUpdateTick(e,t,s,i=!1,a=!1){this._previousTick=e;var r,n=this._tickCache;n&&null!=(r=this._trackIndexLookup)&&0<r.size&&(n=n.findBeat(r,e,this._currentBeat))&&this._cursorUpdateBeat(n,t,i,s,a||0===this.playerState)}_cursorUpdateBeat(s,i,a,r,e=!1){let n=s.beat,o=s.nextBeat?.beat??null,h=s.duration,l=s.beatLookup.highlightedBeats;if(n){let t=this._renderer.boundsLookup;if(t){var d=this._currentBeat,c=this._previousCursorCache,u=this._previousStateForCursor;if(e||n!==d?.beat||t!==c||u!==this._player.state||d?.start!==s.start){let e=t.findBeat(n);e&&(this._currentBeat=s,this._previousCursorCache=t,this._previousStateForCursor=this._player.state,this.uiFacade.beginInvoke(()=>{this._internalCursorUpdateBeat(n,o,h,i,l,t,e,a,s.cursorMode,r)}))}}}}scrollToCursor(){var e=this._currentBeatBounds;e&&this._internalScrollToCursor(e.barBounds.masterBarBounds)}_internalScrollToCursor(e){var t=this.uiFacade.getScrollContainer(),s=E.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,i=this.settings.player.scrollMode;if(s){var a=e.realBounds.y+this.settings.player.scrollOffsetY;if(a!==this._lastScroll)switch(this._lastScroll=a,i){case 1:var r=this.uiFacade.getOffset(t,this.container),n=this.uiFacade.getOffset(null,t).h,o=e.realBounds.h/2;this.uiFacade.scrollToY(t,r.y+a-n/2+o,this.settings.player.scrollSpeed);break;case 2:r=t.scrollTop+this.uiFacade.getOffset(null,t).h;(e.visualBounds.y+e.visualBounds.h>=r||e.visualBounds.y<t.scrollTop)&&(n=e.realBounds.y+this.settings.player.scrollOffsetY,this.uiFacade.scrollToY(t,n,this.settings.player.scrollSpeed))}}else{s=e.visualBounds.x;if(s!==this._lastScroll)switch(this._lastScroll=s,i){case 1:var h=this.uiFacade.getOffset(null,t).w,h=(this._currentBeatBounds?this._currentBeatBounds.onNotesX:e.realBounds.x)-h/2+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,h,this.settings.player.scrollSpeed);break;case 2:h=t.scrollLeft+this.uiFacade.getOffset(null,t).w;(e.visualBounds.x+e.visualBounds.w>=h||e.visualBounds.x<t.scrollLeft)&&(h=e.realBounds.x+this.settings.player.scrollOffsetX,this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,h,this.settings.player.scrollSpeed))}}}_internalCursorUpdateBeat(e,t,s,i,a,r,n,o,h,l){let d=this._barCursor,c=this._beatCursor,u=n.barBounds.masterBarBounds,p=u.visualBounds,m=this._currentBeatBounds,g=(this._currentBeatBounds=n,d&&d.setBounds(p.x,p.y,p.w,p.h),1===this._player.state&&!i),f=u.visualBounds.x+u.visualBounds.w;t&&1===h&&(r=r.findBeat(t))&&r.barBounds.masterBarBounds.staffSystemBounds===u.staffSystemBounds&&(f=r.onNotesX);let b=n.onNotesX,y=(c?(this.settings.player.enableAnimatedBeatCursor&&(t=f-n.onNotesX,r=this._previousTick-this._currentBeat.start,r=0<this._currentBeat.tickDuration?r/this._currentBeat.tickDuration:0,b=n.onNotesX+t*r,s-=s*r,g)?((!m||this._isInitialBeatCursorUpdate||p.y!==m.barBounds.masterBarBounds.visualBounds.y||b<m.onNotesX||u.index>m.barBounds.masterBarBounds.index+1)&&(c.transitionToX(0,b),c.setBounds(b,p.y,1,p.h)),this.uiFacade.beginInvoke(()=>{var e=1===h?2:1,t=b+(f-b)*e;c.transitionToX(s/l*e,t)})):(c.transitionToX(0,b),c.setBounds(b,p.y,1,p.h)),this._isInitialBeatCursorUpdate=!1):this._isInitialBeatCursorUpdate=!0,this.uiFacade.removeHighlights(),!1);if(g){if(this.settings.player.enableElementHighlighting)for(var _ of a){_=To.getGroupId(_.beat);this.uiFacade.highlightElements(_,e.voice.bar.index)}o=!i,y=!0}o&&!this._isBeatMouseDown&&0!==this.settings.player.scrollMode&&this._internalScrollToCursor(u),y&&(this._onPlayedBeatChanged(e),this._onActiveBeatsChanged(new xo(a.map(e=>e.beat))))}_onPlayedBeatChanged(e){this._isDestroyed||(this.playedBeatChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",e))}_onActiveBeatsChanged(e){this._isDestroyed||(this.activeBeatsChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",e))}get _hasCursor(){return 0!==this.settings.player.playerMode&&this.settings.player.enableCursor}_onBeatMouseDown(e,t){this._isDestroyed||(this._hasCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new Fo(t),this._selectionEnd=null),this._isBeatMouseDown=!0,this.beatMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseDown",t,e))}_onNoteMouseDown(e,t){this._isDestroyed||(this._isNoteMouseDown=!0,this.noteMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseDown",t,e))}_onBeatMouseMove(e,t){this._isDestroyed||(!this.settings.player.enableUserInteraction||this._selectionEnd&&this._selectionEnd.beat===t||(this._selectionEnd=new Fo(t),this._cursorSelectRange(this._selectionStart,this._selectionEnd)),this.beatMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseMove",t,e))}_onNoteMouseMove(e,t){this._isDestroyed||(this.noteMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseMove",t,e))}_onBeatMouseUp(e,t){var s,i,a;this._isDestroyed||(this._hasCursor&&this.settings.player.enableUserInteraction&&(this._selectionEnd&&(i=this._tickCache?.getBeatStart(this._selectionStart.beat)??this._selectionStart.beat.absolutePlaybackStart,(this._tickCache?.getBeatStart(this._selectionEnd.beat)??this._selectionEnd.beat.absolutePlaybackStart)<i)&&(i=this._selectionStart,this._selectionStart=this._selectionEnd,this._selectionEnd=i),this._selectionStart)&&this._tickCache&&(s=(i=this._tickCache).getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar),this._currentBeat=null,0===this._player.state&&this._cursorUpdateTick(this._tickCache.getBeatStart(this._selectionStart.beat),!1,1),this.tickPosition=s+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat?(i=i.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),(a=new Co).startTick=s+this._selectionStart.beat.playbackStart,a.endTick=i+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=a):(this._selectionStart=null,this.playbackRange=null,this._cursorSelectRange(this._selectionStart,this._selectionEnd))),this.beatMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseUp",t,e),this._isBeatMouseDown=!1)}_onNoteMouseUp(e,t){this._isDestroyed||(this.noteMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseUp",t,e),this._isNoteMouseDown=!1)}_updateSelectionCursor(e){var t;this._tickCache&&(e?(t=this._tickCache.findBeat(this._trackIndexLookup,e.startTick),e=this._tickCache.findBeat(this._trackIndexLookup,e.endTick),t&&e&&(t=new Fo(t.beat),e=new Fo(e.beat),this._cursorSelectRange(t,e))):this._cursorSelectRange(null,null))}_setupClickHandling(){this.canvasElement.mouseDown.on(e=>{var t,s,i;e.isLeftMouseButton&&(this.settings.player.enableUserInteraction&&e.preventDefault(),t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null)&&(this._onBeatMouseDown(e,i),this.settings.core.includeNoteBounds)&&((i=this._renderer.boundsLookup?.getNoteAtPos(i,t,s))&&this._onNoteMouseDown(e,i))}),this.canvasElement.mouseMove.on(e=>{var t,s,i;this._isBeatMouseDown&&(t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null)&&(this._onBeatMouseMove(e,i),this._isNoteMouseDown)&&((i=this._renderer.boundsLookup?.getNoteAtPos(i,t,s))&&this._onNoteMouseMove(e,i))}),this.canvasElement.mouseUp.on(e=>{var t,s,i;this._isBeatMouseDown&&(this.settings.player.enableUserInteraction&&e.preventDefault(),t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null,this._onBeatMouseUp(e,i),this._isNoteMouseDown)&&(i?(i=this._renderer.boundsLookup?.getNoteAtPos(i,t,s)??null,this._onNoteMouseUp(e,i)):this._onNoteMouseUp(e,null))}),this._renderer.postRenderFinished.on(()=>{this._selectionStart&&this._hasCursor&&this.settings.player.enableUserInteraction&&this._cursorSelectRange(this._selectionStart,this._selectionEnd)})}_cursorSelectRange(s,i){var a=this._renderer.boundsLookup;if(a){var r=this._selectionWrapper;if(r&&(r.clear(),s)&&i&&s.beat!==i.beat){s.bounds||(s.bounds=a.findBeat(s.beat)),i.bounds||(i.bounds=a.findBeat(i.beat));var n=this._tickCache?.getBeatStart(s.beat)??s.beat.absolutePlaybackStart;(this._tickCache?.getBeatStart(i.beat)??i.beat.absolutePlaybackStart)<n&&(n=s,s=i,i=n);let e=s.bounds.realBounds.x,t=i.bounds.realBounds.x+i.bounds.realBounds.w;if(i.beat.index===i.beat.voice.beats.length-1&&(t=i.bounds.barBounds.masterBarBounds.realBounds.x+i.bounds.barBounds.masterBarBounds.realBounds.w),s.bounds.barBounds.masterBarBounds.staffSystemBounds!==i.bounds.barBounds.masterBarBounds.staffSystemBounds){var o=s.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,h=s.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+s.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,n=this.uiFacade.createSelectionElement(),n=(n.setBounds(e,s.bounds.barBounds.masterBarBounds.visualBounds.y,h-e,s.bounds.barBounds.masterBarBounds.visualBounds.h),r.appendChild(n),s.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1),l=i.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let e=n;e<l;e++){var d=a.staffSystems[e],c=this.uiFacade.createSelectionElement();c.setBounds(o,d.visualBounds.y,h-o,d.visualBounds.h),r.appendChild(c)}n=this.uiFacade.createSelectionElement();n.setBounds(o,i.bounds.barBounds.masterBarBounds.visualBounds.y,t-o,i.bounds.barBounds.masterBarBounds.visualBounds.h),r.appendChild(n)}else{i=this.uiFacade.createSelectionElement();i.setBounds(e,s.bounds.barBounds.masterBarBounds.visualBounds.y,t-e,s.bounds.barBounds.masterBarBounds.visualBounds.h),r.appendChild(i)}}}}_onScoreLoaded(e){this._isDestroyed||(this.scoreLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"scoreLoaded",e),this._setupOrDestroyPlayer())||this.loadMidiForScore()}_onResize(e){this._isDestroyed||(this.resize.trigger(e),this.uiFacade.triggerEvent(this.container,"resize",e))}_onRenderStarted(e){this._isDestroyed||(this.renderStarted.trigger(e),this.uiFacade.triggerEvent(this.container,"renderStarted",e))}_onRenderFinished(e){this._isDestroyed||(this.renderFinished.trigger(e),this.uiFacade.triggerEvent(this.container,"renderFinished",e))}_onPostRenderFinished(){this._isDestroyed||(this._currentBeat=null,this._cursorUpdateTick(this._previousTick,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}onError(e){this._isDestroyed||(M.error("API","An unexpected error occurred",e),this.error.trigger(e),this.uiFacade.triggerEvent(this.container,"error",e))}get playerReady(){return this._player.readyForPlayback}_onPlayerReady(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this._player.finished}_onPlayerFinished(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this._player.soundFontLoaded}_onSoundFontLoaded(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}_onMidiLoad(e){this._isDestroyed||(this.midiLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"midiLoad",e))}_onMidiLoaded(e){this._isDestroyed||(this.midiLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",e))}get playerStateChanged(){return this._player.stateChanged}_onPlayerStateChanged(e){var t,s;this._isDestroyed||(e.stopped||0!==e.state||(t=this._currentBeat,s=this._tickCache,t&&s&&(this._player.tickPosition=s.getBeatStart(t.beat))),this.uiFacade.triggerEvent(this.container,"playerStateChanged",e))}get playerPositionChanged(){return this._player.positionChanged}_onPlayerPositionChanged(t){this._isDestroyed||(this._previousTick=t.currentTick,this.uiFacade.beginInvoke(()=>{var e=t.modifiedTempo/t.originalTempo;this._cursorUpdateTick(t.currentTick,!1,e,!1,t.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",t))}get midiEventsPlayed(){return this._player.midiEventsPlayed}_onMidiEventsPlayed(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",e)}get playbackRangeChanged(){return this._player.playbackRangeChanged}_onPlaybackRangeChanged(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",e)}_onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return this._player.output.enumerateOutputDevices()}async setOutputDevice(e){await this._player.output.setOutputDevice(e)}async getOutputDevice(){return this._player.output.getOutputDevice()}async exportAudio(e){if(!this.score)throw new b(0,"No song loaded");let t;t=2===this._actualPlayerMode?this.uiFacade.createWorkerAudioExporter(this._player.instance):this.uiFacade.createWorkerAudioExporter(null);var s,i,a,r,n,o,h=this.score,l=new Ji,d=new so(l),h=new bo(h,this.settings,d),c=(h.applyTranspositionPitches=!1,h.generate(),new Ar);c.soundFonts=e.soundFonts,c.sampleRate=e.sampleRate,c.useSyncPoints=e.useSyncPoints,c.masterVolume=e.masterVolume,c.metronomeVolume=e.metronomeVolume,c.playbackRange=e.playbackRange;for([s,i]of e.trackVolume)s<this.score.tracks.length&&(a=this.score.tracks[s],c.trackVolume.set(a.playbackInfo.primaryChannel,i),c.trackVolume.set(a.playbackInfo.secondaryChannel,i));for([r,n]of e.trackTranspositionPitches)r<this.score.tracks.length&&(o=this.score.tracks[r],c.trackTranspositionPitches.set(o.playbackInfo.primaryChannel,n),c.trackTranspositionPitches.set(o.playbackInfo.secondaryChannel,n));return await t.initialize(c,l,h.syncPoints,h.transpositionPitches),t}},Io=class extends b{constructor(e,t){super(0,e),this.xhr=t}},Ao=class Ap{static loadAlphaTex(e,t){var s=new Ns;return s.logErrors=!0,s.initFromString(e,t??new Sn),s.readScore()}static loadScoreAsync(e,a,r,n){let o=new XMLHttpRequest;o.open("GET",e,!0,null,null),o.responseType="arraybuffer",o.onreadystatechange=()=>{if(o.readyState===XMLHttpRequest.DONE){var e=o.response;if(200===o.status||0===o.status&&e)try{var t=o.response,s=new Uint8Array(t),i=Ap.loadScoreFromBytes(s,n);a(i)}catch(e){r(e)}else 0===o.status?r(new Io(`You are offline!!
 Please Check Your Network.`,o)):404===o.status?r(new Io("Requested URL not found.",o)):500===o.status?r(new Io("Internel Server Error.",o)):"parsererror"===o.statusText?r(new Io(`Error.
Parsing JSON Request failed.`,o)):"timeout"===o.statusText?r(new Io("Request Time out.",o)):r(new Io("Unknow Error: "+o.responseText,o))}},o.send()}static loadScoreFromBytes(e,t){t=t||new Sn;var s,i=E.buildImporters();M.debug("ScoreLoader",`Loading score from ${e.length} bytes using ${i.length} importers`);let a=null,r=Bs.fromBuffer(e);for(s of i){r.reset();try{M.debug("ScoreLoader","Importing using importer "+s.name),s.init(r,t),a=s.readScore(),M.debug("ScoreLoader","Score imported using "+s.name);break}catch(e){if(!(e instanceof Ts))throw M.error("ScoreLoader","Score import failed due to unexpected error: ",e),e;M.debug("ScoreLoader",s.name+" does not support the file")}}if(a)return a;throw new Ts("No compatible importer found for file")}},Ro=class{get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(e){e=e.element,e=e.getBoundingClientRect().left+e.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-e}getY(e){e=e.element,e=e.getBoundingClientRect().top+e.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-e}preventDefault(){this.mouseEvent.preventDefault()}constructor(e){this.mouseEvent=e}},Oo=class Oo{constructor(e){this._resizeListeners=0,this.lastBounds=new hs,this.element=e,this.mouseDown={on:t=>{let e=e=>{t(new Ro(e))};return this.element.addEventListener("mousedown",e,!0),()=>{this.element.removeEventListener("mousedown",e,!0)}},off:e=>{}},this.mouseUp={on:t=>{let e=e=>{t(new Ro(e))};return this.element.addEventListener("mouseup",e,!0),()=>{this.element.removeEventListener("mouseup",e,!0)}},off:e=>{}},this.mouseMove={on:t=>{let e=e=>{t(new Ro(e))};return this.element.addEventListener("mousemove",e,!0),()=>{this.element.removeEventListener("mousemove",e,!0)}},off:e=>{}};let t=this;this.resize={on:function(e){return 0===t._resizeListeners&&Oo._resizeObserver.value.observe(t.element),t.element.addEventListener("resize",e,!0),t._resizeListeners++,()=>this.off(e)},off:e=>{this.element.removeEventListener("resize",e,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,Oo._resizeObserver.value.unobserve(this.element))}}}get width(){return this.element.offsetWidth}set width(e){this.element.style.width=e+"px"}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(e){this.element.scrollLeft=e}get scrollTop(){return this.element.scrollTop}set scrollTop(e){this.element.scrollTop=e}get height(){return this.element.offsetHeight}set height(e){this.element.style.height=0<=e?e+"px":"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}stopAnimation(){this.element.style.transition="none"}transitionToX(e,t){this.element.style.transition=`transform ${e}ms linear`,this.setBounds(t,Number.NaN,Number.NaN,Number.NaN)}setBounds(e,t,s,i){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${e}px, ${t}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=s,this.lastBounds.h=i}appendChild(e){this.element.appendChild(e.element)}clear(){this.element.innerHTML=""}},Vo=(Oo._resizeObserver=new be(()=>new ResizeObserver(e=>{for(var t of e){var s=new CustomEvent("resize",{detail:t});t.target.dispatchEvent(s)}})),Oo),Wo=class{constructor(e){this._isStarted=!1,this.isFontLoaded=!1,this.fontLoaded=new g,this._originalFamilies=e,this._families=e}checkForFontAvailability(){if(E.isRunningInWorker)return void(this.isFontLoaded=!1);if(this._isStarted)return;this._isStarted=!0;let e=0,t=window.setInterval(()=>{M.warning("Rendering",`Could not load font '${this._families[0]}' within ${5*(e+1)} seconds`,null),1<this._families.length?(this._families.shift(),e=0):e++},5e3),s=(M.debug("Font","Start checking for font availablility: "+this._families.join(", ")),e=>{1<this._families.length?(M.debug("Font",`[${this._families[0]}] Loading Failed, switching to `+this._families[1],e),this._families.shift(),window.setTimeout(()=>{a()},0)):(M.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,e),window.clearInterval(t))}),i=e=>{M.debug("Font",`[${e}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._families[0])},a=async()=>{for(var e of this._families)if(await this._isFontAvailable(e,!1))return void i(e);try{await document.fonts.load("1em "+this._families[0])}catch(e){s(e)}return M.debug("Font",`[${this._families[0]}] Font API signaled loaded`),await this._isFontAvailable(this._families[0],!0)?i(this._families[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{a()})}_isFontAvailable(i,e){return new Promise(t=>{let s="1em "+i;if(document.fonts.check(s))t(!0);else if(e){M.debug("Font",`Font ${i} not available, creating test element to trigger load`);let e=document.createElement("div");e.style.font=s,e.style.opacity="0",e.style.position="absolute",e.style.top="0",e.style.left="0",e.innerText=`Trigger ${i} load`,document.body.appendChild(e),setTimeout(()=>{document.body.removeChild(e),document.fonts.check(s)?t(!0):t(!1)},200)}else t(!1)})}},Ho=class extends Hi{constructor(){super(...arguments),this._audioNode=null,this._bufferCount=0,this._requestedBufferCount=0,this._outputBuffer=new Float32Array(0)}open(e){super.open(e),this._bufferCount=Math.floor(e*this.sampleRate/1e3/Hi.BufferSize),this._circularBuffer=new Di(Hi.BufferSize*this._bufferCount),this.onReady()}play(){super.play();var e=this.context;this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this._generateSound.bind(this),this._circularBuffer.clear(),this._requestBuffers(),this.source=e.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this._audioNode,0,0),this.source.start(0),this._audioNode.connect(e.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(e){this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}_requestBuffers(){var t=this._bufferCount/2|0;if(this._circularBuffer.count+this._requestedBufferCount*Hi.BufferSize<t*Hi.BufferSize){for(let e=0;e<t;e++)this.onSampleRequest();this._requestedBufferCount+=t}}_generateSound(e){let t=e.outputBuffer.getChannelData(0),s=e.outputBuffer.getChannelData(1),i=t.length+s.length,a=this._outputBuffer,r=(a.length!==i&&(a=new Float32Array(i),this._outputBuffer=a),this._circularBuffer.read(a,0,Math.min(a.length,this._circularBuffer.count))),n=0,o=Math.min(t.length,r);for(let e=0;e<o;e++)t[e]=a[n++],s[e]=a[n++];if(r<t.length)for(let e=r;e<t.length;e++)t[e]=0,s[e]=0;this.onSamplesPlayed(r/_.AudioChannels),this._requestBuffers()}},Go=class{constructor(e,t){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=0,this._masterVolume=0,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._midiEventsPlayedFilter=[],this._currentPosition=new ba(0,0,0,0,!1,120,120),this.ready=new rs,this.readyForPlayback=new rs,this.finished=new rs,this.soundFontLoaded=new rs,this.soundFontLoadFailed=new g,this.midiLoaded=new g,this.midiLoadFailed=new g,this.stateChanged=new g,this.positionChanged=new g,this.midiEventsPlayed=new g,this.playbackRangeChanged=new g,this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=0,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._output=e,this._output.ready.on(this._onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(t.player.bufferTimeInMilliseconds);try{this._synth=E.createWebWorker(t)}catch(e){M.error("AlphaSynth","Failed to create WebWorker: "+e)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:t.core.logLevel,bufferTimeInMilliseconds:t.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}get output(){return this._output}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return M.logLevel}get worker(){return this._synth}set logLevel(e){M.logLevel=e,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:e})}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,_.MinVolume),this._masterVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:e})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,_.MinVolume),this._metronomeVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:e})}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,_.MinVolume),this._countInVolume=e,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:e})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:E.prepareForPostMessage(e)})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){e=F.clamp(e,_.MinPlaybackSpeed,_.MaxPlaybackSpeed),this._playbackSpeed=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:e})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._currentPosition.currentTick}set tickPosition(e){this._currentPosition=new ba(this._currentPosition.currentTime,this._currentPosition.endTime,e=e<0?0:e,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:e})}get timePosition(){return this._currentPosition.currentTime}set timePosition(e){this._currentPosition=new ba(e=e<0?0:e,this._currentPosition.endTime,this._currentPosition.currentTick,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:e})}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:e})}get playbackRange(){return this._playbackRange}set playbackRange(e){e&&(e.startTick<0&&(e.startTick=0),e.endTick<0)&&(e.endTick=0),this._playbackRange=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:E.prepareForPostMessage(e)})}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:qn.midiFileToJsObject(E.prepareForPostMessage(e))})}loadSoundFont(e,t){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:E.prepareForPostMessage(e),append:t})}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:qn.midiFileToJsObject(E.prepareForPostMessage(e))})}applyTranspositionPitches(e){this._synth.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(E.prepareForPostMessage(e).entries()))})}setChannelTranspositionPitch(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:e,semitones:t})}setChannelMute(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:e,mute:t})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:e,solo:t})}setChannelVolume(e,t){t=Math.max(t,_.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:e,volume:t})}handleWorkerMessage(e){var t=e.data;switch(t.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this._checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this._checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._currentPosition=new ba(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.positionChanged.trigger(this._currentPosition);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Dr(t.events.map(qn.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=t.state,this.stateChanged.trigger(new fa(t.state,t.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=t.playbackRange,this.playbackRangeChanged.trigger(new Ir(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(t.error);break;case"alphaSynth.midiLoaded":this._checkReadyForPlayback(),this._loadedMidiInfo=new ba(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo);break;case"alphaSynth.midiLoadFailed":this._checkReadyForPlayback(),this.midiLoadFailed.trigger(t.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(t.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples()}}_checkReady(){this.isReady&&this.ready.trigger()}_checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(e){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:e})}_onOutputReady(){this._outputIsReady=!0,this._checkReady()}loadBackingTrack(e){}updateSyncPoints(e){}},zo=class{constructor(e,t){this._width=0,this.boundsLookup=null,this.preRender=new g,this.partialRenderFinished=new g,this.partialLayoutFinished=new g,this.renderFinished=new g,this.postRenderFinished=new rs,this.error=new g,this._api=e;try{this._worker=E.createWebWorker(t)}catch(e){return void M.error("Rendering","Failed to create WebWorker: "+e)}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this._serializeSettingsForWorker(t)}),this._worker.addEventListener("message",this._handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(e){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this._serializeSettingsForWorker(e)})}_serializeSettingsForWorker(e){e=qn.settingsToJsObject(E.prepareForPostMessage(e));return e.delete("player"),e}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(e){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:e})}get width(){return this._width}set width(e){this._width=e,this._worker.postMessage({cmd:"alphaTab.setWidth",width:e})}_handleWorkerMessage(e){var t=e.data;switch(t.cmd){case"alphaTab.preRender":this.preRender.trigger(t.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(t.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(t.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(t.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=us.fromJson(t.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(t.error)}}renderScore(e,t){e=null==e?null:qn.scoreToJsObject(E.prepareForPostMessage(e));this._worker.postMessage({cmd:"alphaTab.renderScore",score:e,trackIndexes:E.prepareForPostMessage(t),fontSizes:Zn.fontSizeLookupTables})}},Uo=class{constructor(e,t,s,i){this.cursorWrapper=e,this.barCursor=t,this.beatCursor=s,this.selectionWrapper=i}},Yo=class extends Vo{constructor(e,t,s){super(e),this._xscale=t,this._yscale=s}get width(){return this.element.offsetWidth/this._xscale}set width(e){this.element.style.width=e*this._xscale+"px"}get height(){return this.element.offsetHeight/this._yscale}set height(e){this.element.style.height=0<=e?e*this._yscale+"px":"100%"}setBounds(e,t,s,i){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s/=this._xscale,Number.isNaN(i)?i=this.lastBounds.h:i/=this._yscale,this.element.style.transform=`translate(${e}px, ${t}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=s,this.lastBounds.h=i}},Xo=class{constructor(){this.sampleRate=44100,this._updateInterval=0,this.ready=new rs,this.samplesPlayed=new g,this.timeUpdate=new g,this.sampleRequest=new rs}get backingTrackDuration(){var e=this.audioElement.duration??0;return Number.isFinite(e)?1e3*e:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(e){this.audioElement.playbackRate=e}get masterVolume(){return this.audioElement.volume}set masterVolume(e){this.audioElement.volume=e}seekTo(e){this.audioElement.currentTime=e/1e3}loadBackingTrack(e){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);var e=new Blob([e.rawAudioFile]),t=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(e),this.audioElement.playbackRate=t}open(e){var t=document.createElement("audio");t.style.display="none",document.body.appendChild(t),t.addEventListener("seeked",()=>{this._updatePosition()}),t.addEventListener("timeupdate",()=>{this._updatePosition()}),this.audioElement=t,this.ready.trigger()}_updatePosition(){var e=1e3*this.audioElement.currentTime;this.timeUpdate.trigger(e)}play(){this.audioElement.play(),this._updateInterval=window.setInterval(()=>{this._updatePosition()},50)}destroy(){var e=this.audioElement;e&&document.body.removeChild(e)}pause(){this.audioElement.pause(),window.clearInterval(this._updateInterval)}addSamples(e){}resetSamples(){}activate(){}async enumerateOutputDevices(){return Vi.enumerateOutputDevices()}async setOutputDevice(e){await Vi.checkSinkIdSupport()&&(e?await this.audioElement.setSinkId(e.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await Vi.checkSinkIdSupport())return null;let t=this.audioElement.sinkId;var e;return"string"!=typeof t||""===t||"default"===t?null:Vi.findKnownDevice(t)||(e=await this.enumerateOutputDevices()).find(e=>e.deviceId===t)||(M.warning("WebAudio","Could not find output device in device list",t,e),null)}},Jo=class Jo{constructor(e,t){this._promise=null,this._exporterId=Jo._nextExporterId++,this._worker=e,this._ownsWorker=t}async initialize(e,t,s,i){let a=this.handleWorkerMessage.bind(this);this._worker.worker.addEventListener("message",a,!1),this._unsubscribe=()=>{this._worker.worker.removeEventListener("message",a,!1)},this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this._exporterId,options:E.prepareForPostMessage(e),midi:qn.midiFileToJsObject(E.prepareForPostMessage(t)),syncPoints:E.prepareForPostMessage(s),transpositionPitches:E.prepareForPostMessage(i)}),await this._promise.promise}handleWorkerMessage(e){var t=e.data;if(t.exporterId===this._exporterId)switch(t.cmd){case"alphaSynth.exporter.initialized":this._promise?.resolve(null),this._promise=null;break;case"alphaSynth.exporter.error":this._promise?.reject(t.error),this._promise=null;break;case"alphaSynth.exporter.rendered":this._promise?.resolve(t.chunk),this._promise=null;break;case"alphaSynth.destroyed":this._promise?.reject(new b(0,"Worker was destroyed")),this._promise=null}}async render(e){if(this._promise)throw new b(0,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this._exporterId,milliseconds:e}),this._promise.promise}destroy(){this._worker.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this._exporterId}),this._unsubscribe(),this._ownsWorker&&this._worker.destroy()}[Symbol.dispose](){this.destroy()}},qo=(Jo._nextExporterId=1,Jo),jo=class jo{constructor(e){if(this._fontCheckers=new Map,this._contents=null,this._file=null,this._totalResultCount=0,this._initialTrackIndexes=null,this._barToElementLookup=new Map,this._resultIdToElementLookup=new Map,this.rootContainerBecameVisible=new rs,this.canRenderChanged=new rs,this._highlightedElements=[],this._scrollContainer=null,0!==E.webPlatform&&2!==E.webPlatform)throw new b(0,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");e.classList.add("alphaTab"),this.rootContainer=new Vo(e),this.areWorkersSupported="Worker"in window,this._intersectionObserver=new IntersectionObserver(this._onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(e)}get resizeThrottle(){return 10}get canRender(){return this._areAllFontsLoaded()}_areAllFontsLoaded(){let e=!1;for(var t of this._fontCheckers.values())t.isFontLoaded||(e=!0);return!e&&(M.debug("Font","All fonts loaded: "+this._fontCheckers.size),!0)}_onFontLoaded(e){Zn.generateFontLookup(e),this._areAllFontsLoaded()&&this.canRenderChanged.trigger()}_onElementVisibilityChanged(e){for(var t of e){var s,i=t.target;i===this.rootContainer.element?t.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element)):"layoutResultId"in i&&this._api.settings.core.enableLazyLoading&&(s=i,t.isIntersecting?s.renderedResultId!==s.layoutResultId?this._resultIdToElementLookup.has(s.layoutResultId)?1!==s.resultState&&(s.resultState=1,this._api.renderer.renderResult(s.layoutResultId)):i.replaceChildren():3===s.resultState&&(i.replaceChildren(...s.renderedResult),s.resultState=2):2===s.resultState&&(s.resultState=3,s.replaceChildren()))}}createWorkerRenderer(){return new zo(this._api,this._api.settings)}initialize(e,t){this._api=e;let s;s=t instanceof Sn?t:qn.jsObjectToSettings(t);t=this._getDataAttributes(),yn.fromJson(s,t),1===s.notation.notationMode&&s.setSongBookModeSettings(),e.settings=s,this._setupFontCheckers(s),this._initialTrackIndexes=this.parseTracks(s.core.tracks),this._contents="",t=e.container;s.core.tex&&(this._contents=t.element.innerHTML,t.element.innerHTML=""),this._createStyleElements(s),this._file=s.core.file}_setupFontCheckers(e){this._registerFontChecker(e.display.resources.copyrightFont),this._registerFontChecker(e.display.resources.effectFont),this._registerFontChecker(e.display.resources.graceFont),this._registerFontChecker(e.display.resources.markerFont),this._registerFontChecker(e.display.resources.tablatureFont),this._registerFontChecker(e.display.resources.titleFont),this._registerFontChecker(e.display.resources.wordsFont),this._registerFontChecker(e.display.resources.barNumberFont),this._registerFontChecker(e.display.resources.fretboardNumberFont),this._registerFontChecker(e.display.resources.subTitleFont)}_registerFontChecker(e){var t;this._fontCheckers.has(e.families.join(", "))||(t=new Wo(e.families),this._fontCheckers.set(e.families.join(", "),t),t.fontLoaded.on(this._onFontLoaded.bind(this)),t.checkForFontAvailability())}destroy(){this.rootContainer.element.innerHTML="";var e=this._webFont,t=this.rootContainer.element.ownerDocument,s=e.elements.get(t);s&&(s.usages--,s.usages<=0)&&(s.element.remove(),e.elements.delete(t)),0===e.elements.size&&jo._registeredWebFonts.delete(e.hash)}createCanvasElement(){var e=this.rootContainer.element.ownerDocument.createElement("div");return e.classList.add("at-surface","at"+this._webFont.fontSuffix),e.style.fontSize="0",e.style.overflow="hidden",e.style.lineHeight="0",e.style.position="relative",new Vo(e)}triggerEvent(e,t,s=null,i){var a,e=e.element,r=(t="alphaTab."+t,e.ownerDocument.createEvent("CustomEvent")),i=i?i.mouseEvent:null;r.initCustomEvent(t,!1,!1,s),i&&(r.originalEvent=i),e.dispatchEvent(r),window&&"jQuery"in window&&(r=window.jQuery,(a=[]).push(s),i&&a.push(i),r(e).trigger(t,a))}load(e,t,s){var i;return e instanceof qe?(t(e),!0):e instanceof ArrayBuffer?(i=new Uint8Array(e),t(Ao.loadScoreFromBytes(i,this._api.settings)),!0):e instanceof Uint8Array?(t(Ao.loadScoreFromBytes(e,this._api.settings)),!0):"string"==typeof e&&(Ao.loadScoreAsync(e,t,s,this._api.settings),!0)}loadSoundFont(e,t){return!(!this._api.player||(e instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(e),t),0):e instanceof Uint8Array?(this._api.player.loadSoundFont(e,t),0):"string"!=typeof e||(this._api.loadSoundFontFromUrl(e,t),0)))}initialRender(){this._api.renderer.preRender.on(e=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});var e=()=>{this._api.renderer.width=0|this.rootContainer.width,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null):this._file&&Ao.loadScoreAsync(this._file,e=>{this._api.renderScore(e,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null},e=>{this._api.onError(e)},this._api.settings)};this.rootContainer.isVisible?e():this.rootContainerBecameVisible.on(e)}_createStyleElements(e){var t,s,i,a=this._api.container.element.ownerDocument,r=(jo.createSharedStyleElement(a),e.core.smuflFontSources??Rc.buildDefaultSmuflFontSources(e.core.fontDirectory)),n=jo._cyrb53(r.values()),o=jo._registeredWebFonts;o.has(n)?((t=o.get(n)).checker.fontLoaded.on(this._onFontLoaded.bind(this)),this._createStyleElement(t,a),this._webFont=t):(r=`
            @font-face {
                font-display: block;
                font-family: '${s="alphaTab"+(t=0===o.size?"":String(o.size))}';
                src: ${Array.from(r.entries()).map(e=>`url(${JSON.stringify(e[1])}) format('${jo._cssFormat(e[0])}')`).join(",")};
                font-weight: normal;
                font-style: normal;
            }
            .at-surface.at${t} .at {
                font-family: '${s}';
                speak: none;
                font-style: normal;
                font-weight: normal;
                font-variant: normal;
                text-transform: none;
                line-height: 1;
                line-height: 1;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                font-size: ${e.display.resources.engravingSettings.musicFontSize}px;
                overflow: visible !important;
            }`,(i=new Wo([s])).fontLoaded.on(this._onFontLoaded.bind(this)),this._fontCheckers.set(s,i),i.checkForFontAvailability(),e.display.resources.smuflFontFamilyName=s,e={hash:n,elements:new Map,fontSuffix:t,checker:i,cssSource:r},this._createStyleElement(e,a),o.set(n,e),this._webFont=e)}_createStyleElement(e,t){var s;e.elements.has(t)?e.elements.get(t).usages++:((s=t.createElement("style")).id="alphaTabStyle"+e.fontSuffix,s.innerHTML=e.cssSource,t.getElementsByTagName("head").item(0).appendChild(s),e.elements.set(t,{element:s,usages:1}))}static _cssFormat(e){switch(e){case 0:return"embedded-opentype";case 1:return"woff";case 2:return"woff2";case 3:return"opentype";case 4:return"truetype";case 5:return"svg"}}static _cyrb53(e,t=0){let s=3735928559^t,i=1103547991^t;for(var a of e)for(let e=0;e<a.length;e++){var r=a.charCodeAt(e);s=Math.imul(s^r,2654435761),i=Math.imul(i^r,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),4294967296*(2097151&(i^=Math.imul(s^s>>>13,3266489909)))+(s>>>0)}static createSharedStyleElement(e){var t=e.getElementById("alphaTabStyle");t||((t=e.createElement("style")).id="alphaTabStyleShared",t.innerHTML=`
                .at-surface * {
                    cursor: default;
                    vertical-align: top;
                    overflow: visible;
                }
                .at-surface-svg text {
                    dominant-baseline: alphabetic;
                    white-space:pre;
                }`,e.getElementsByTagName("head").item(0).appendChild(t))}parseTracks(e){if(!e)return[];var i=[];if("string"==typeof e)try{if("all"===e)return[-1];e=JSON.parse(e)}catch{e=[0]}if("number"==typeof e)i.push(e);else if("length"in e){var t=e.length,a=e;for(let s=0;s<t;s++){let e=a[s],t=0;(0<=(t="number"==typeof e?e:"index"in e?e.index:Number.parseInt(e.toString(),10))||-1===t)&&i.push(t)}}else"index"in e&&i.push(e.index);return i}_getDataAttributes(){var i=new Map,t=this._api.container.element;if(t.dataset)for(var s of Object.keys(t.dataset)){let e=t.dataset[s];try{e=JSON.parse(e)}catch{""===e&&(e=null)}i.set(s,e)}else for(let e=0;e<t.attributes.length;e++){var a=t.attributes.item(e),r=a.nodeName;if(r.startsWith("data-")){let t=r.substr(5).split("-"),s=t[0];for(let e=1;e<t.length;e++)s+=t[e].substr(0,1).toUpperCase()+t[e].substr(1);let e=a.nodeValue;try{e=JSON.parse(e)}catch{""===e&&(e=null)}i.set(s,e)}}return i}beginUpdateRenderResults(e){var t,s;this._resultIdToElementLookup.has(e.id)&&(t=this._resultIdToElementLookup.get(e.id),"string"==typeof(s=e.renderResult)?t.innerHTML=s:"nodeType"in s&&t.replaceChildren(s),t.resultState=2,t.renderedResultId=e.id,t.renderedResult=Array.from(t.children))}beginAppendRenderResults(s){var e=this._api.canvasElement.element;if(s){let t;this._totalResultCount<e.childElementCount?t=e.childNodes.item(this._totalResultCount):(t=document.createElement("div"),e.appendChild(t)),t.style.zIndex="1",t.style.position="absolute",t.style.left=s.x+"px",t.style.top=s.y+"px",t.style.width=s.width+"px",t.style.height=s.height+"px",t.style.display="inline-block",t.layoutResultId=s.id,t.resultState=0,t.renderedResultId=void 0,t.renderedResult=void 0,this._resultIdToElementLookup.set(s.id,t);for(let e=s.firstMasterBarIndex;e<=s.lastMasterBarIndex;e++)0<=e&&this._barToElementLookup.set(e,t);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(t),this._intersectionObserver.observe(t)),this._totalResultCount++}else for(;e.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(e.lastChild),e.removeChild(e.lastElementChild)}createWorkerPlayer(){let e=null,t="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&0===this._api.settings.player.outputMode?(M.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),e=new Go(new Ui(this._api.settings),this._api.settings)):t&&(M.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),e=new Go(new Ho,this._api.settings)),e?e.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):M.error("Player","Player requires webworkers and web audio api, browser unsupported",null),e}createWorkerAudioExporter(e){var t=null===e||!(e instanceof Go);return t&&(e=this.createWorkerPlayer()),new qo(e,t)}beginInvoke(e){window.requestAnimationFrame(()=>{e()})}highlightElements(e,t){t=this._barToElementLookup.get(t);if(t){var s=t.getElementsByClassName(e);for(let e=0;e<s.length;e++)s.item(e).classList.add("at-highlight"),this._highlightedElements.push(s.item(e))}}removeHighlights(){var e=this._highlightedElements;if(e){for(var t of e)t.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){var e=this._api.container.element,t=e.querySelector(".at-cursors");e.removeChild(t)}createCursors(){var e=this._api.container.element,t=document.createElement("div"),s=(t.classList.add("at-cursors"),document.createElement("div")),i=(s.classList.add("at-selection"),this.createScalingElement()),a=this.createScalingElement(),r=i.element,n=(r.classList.add("at-cursor-bar"),a.element);return n.classList.add("at-cursor-beat"),e.style.position="relative",e.style.textAlign="left",t.style.position="absolute",t.style.zIndex="1000",t.style.display="inline",t.style.pointerEvents="none",s.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),n.style.position="absolute",n.style.transition="all 0s linear",n.style.left="0",n.style.top="0",n.style.willChange="transform",a.width=3,a.height=1,a.setBounds(0,0,1,1),e.insertBefore(t,e.firstChild),t.appendChild(s),t.appendChild(r),t.appendChild(n),new Uo(new Vo(t),i,a,new Vo(s))}getOffset(e,t){let s=t.element,i=s.getBoundingClientRect(),a=i.top+s.ownerDocument.defaultView.pageYOffset,r=i.left+s.ownerDocument.defaultView.pageXOffset;e&&"html"!==(n=(t=e.element).nodeName.toLowerCase())&&"body"!==n&&(n=this.getOffset(null,e),a=a+t.scrollTop-n.y,r=r+t.scrollLeft-n.x);var n,e=new hs;return e.x=r,e.y=a,e.w=i.width,e.h=i.height,e}getScrollContainer(){if(!this._scrollContainer){let e="string"==typeof this._api.settings.player.scrollElement?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement,t=e.nodeName.toLowerCase();"html"!==t&&"body"!==t||(e="scrollingElement"in document?document.scrollingElement:-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement),this._scrollContainer=new Vo(e)}return this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){var e=document.createElement("div"),e=(e.style.position="absolute",new Yo(e,100,100));return e.width=1,e.height=1,e.setBounds(0,0,1,1),e}scrollToY(e,t,s){this._internalScrollToY(e.element,t,s)}scrollToX(e,t,s){this._internalScrollToX(e.element,t,s)}_internalScrollToY(n,e,o){if(this._api.settings.player.nativeBrowserSmoothScroll)n.scrollTo({top:e,behavior:"smooth"});else{let s=n.scrollTop,i=e-s,a=0,r=e=>{var e=e-(a=0===a?e:a),t=Math.min(e/o,1);n.scrollTop=s+i*t|0,e<o&&window.requestAnimationFrame(r)};window.requestAnimationFrame(r)}}_internalScrollToX(n,e,o){if(this._api.settings.player.nativeBrowserSmoothScroll)n.scrollTo({left:e,behavior:"smooth"});else{let s=n.scrollLeft,i=e-s,a=0,r=e=>{var e=e-(a=0===a?e:a),t=Math.min(e/o,1);n.scrollLeft=s+i*t|0,e<o&&window.requestAnimationFrame(r)};window.requestAnimationFrame(r)}}createBackingTrackPlayer(){return new Mo(new Xo,this._api.settings.player.bufferTimeInMilliseconds)}},$o=(jo._registeredWebFonts=new Map,jo),Ko=class{constructor(e,t){this.loaded=e,this.total=t}},Qo=class Rp extends Do{constructor(e,t){super(new $o(e),t),this.soundFontLoad=new g}tex(e,t){var s=this.uiFacade;super.tex(e,s.parseTracks(t))}print(e,t=null){let s=window.open("","","width=0,height=0"),i=s.document.createElement("div");e?i.style.width=e:1===this.settings.display.layoutMode?i.style.width="297mm":i.style.width="210mm",s.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <style>
            .at-surface {
                width: auto !important;
                height: auto !important;
            }
            .at-surface > div {
                position: relative!important;
                left: auto !important;
                top: auto !important;
                break-inside: avoid;
            }
            </style>
          </head>
          <body></body>
        </html>
        `);var e=this.score,e=(e&&(e.artist&&e.title?s.document.title=e.title+" - "+e.artist:e.title&&(s.document.title=""+e.title)),s.document.body.appendChild(i),typeof window.screenLeft<"u"?window.screenLeft:window.left),a=typeof window.screenTop<"u"?window.screenTop:window.top,r="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,n="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,o=i.offsetWidth+50,h=window.innerHeight,r=(r/2|0)-(o/2|0)+e,e=(n/2|0)-(h/2|0)+a,n=(s.resizeTo(o,h),s.moveTo(r,e),s.focus(),qn.jsObjectToSettings(qn.settingsToJsObject(this.settings)));n.core.enableLazyLoading=!1,n.core.useWorkers=!0,n.core.file=null,n.core.tracks=null,n.player.enableCursor=!1,n.player.playerMode=0,n.player.enableElementHighlighting=!1,n.player.enableUserInteraction=!1,n.player.soundFont=null,n.display.scale=.8,n.display.stretchForce=.8,yn.fromJson(n,t);let l=new Rp(i,n);s.onunload=()=>{l.destroy()},l.renderer.postRenderFinished.on(()=>{s.print()}),l.renderTracks(this.tracks)}downloadMidi(e=0){var t,s;this.score&&((s=new Ji).format=e,e=new so(s,!0),new bo(this.score,this.settings,e).generate(),e=s.toBinary(),s=this.score.title?this.score.title+".mid":"File.mid",(t=document.createElement("a")).download=s,s=new Blob([e],{type:"audio/midi"}),e=URL.createObjectURL(s),t.href=e,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t))}changeTrackMute(e,t){e=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(e,t)}changeTrackSolo(e,t){e=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(e,t)}changeTrackVolume(e,t){e=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(e,t)}_trackIndexesToTracks(e){if(!this.score)return[];var t=[];if(1===e.length&&-1===e[0])for(var s of this.score.tracks)t.push(s);else for(var i of e)0<=i&&i<this.score.tracks.length&&t.push(this.score.tracks[i]);return t}loadSoundFontFromUrl(e,i){let t=this.player;if(t){M.debug("AlphaSynth","Start loading Soundfont from url "+e);let s=new XMLHttpRequest;s.open("GET",e,!0,null,null),s.responseType="arraybuffer",s.onload=e=>{var t=new Uint8Array(s.response);this.loadSoundFont(t,i)},s.onerror=e=>{M.error("AlphaSynth","Loading failed: "+e.message),t.soundFontLoadFailed.trigger(new Io(e.message,s))},s.onprogress=e=>{M.debug("AlphaSynth",`Soundfont downloading: ${e.loaded}/${e.total} bytes`);e=new Ko(e.loaded,e.total);this.soundFontLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"soundFontLoad",e)},s.send()}}},Zo=class{constructor(){this._initListeners=[]}exec(e,t,s){if("string"!=typeof t&&(s=[t],t="init"),95===t.charCodeAt(0)||"exec"===t)return null;var i,e=new jQuery(e),a=e.data("alphaTab");if("destroy"===t&&!a)return null;if("init"===t||a)return(i=this[t])?(e=[e,a].concat(s),i.apply(this,e)):(M.error("Api",`Method '${t}' does not exist on jQuery.alphaTab`),null);throw new Error("alphaTab not initialized")}init(e,t,s){if(!t){t=new Qo(e[0],s),e.data("alphaTab",t);for(var i of this._initListeners)i(e,t,s)}}destroy(e,t){e.removeData("alphaTab"),t.destroy()}print(e,t,s,i){t.print(s,i)}load(e,t,s,i){return t.load(s,i)}render(e,t){t.render()}renderScore(e,t,s,i){t.renderScore(s,i)}renderTracks(e,t,s){t.renderTracks(s)}invalidate(e,t){t.render()}tex(e,t,s,i){t.tex(s,i)}muteTrack(e,t,s,i){t.changeTrackMute(s,i)}soloTrack(e,t,s,i){t.changeTrackSolo(s,i)}trackVolume(e,t,s,i){t.changeTrackVolume(s,i)}loadSoundFont(e,t,s,i){t.loadSoundFont(s,i)}resetSoundFonts(e,t){t.resetSoundFonts()}pause(e,t){t.pause()}play(e,t){return t.play()}playPause(e,t){t.playPause()}stop(e,t){t.stop()}api(e,t){return t}player(e,t){return t.player}isReadyForPlayback(e,t){return t.isReadyForPlayback}playerState(e,t){return t.playerState}masterVolume(e,t,s){return"number"==typeof s&&(t.masterVolume=s),t.masterVolume}metronomeVolume(e,t,s){return"number"==typeof s&&(t.metronomeVolume=s),t.metronomeVolume}countInVolume(e,t,s){return"number"==typeof s&&(t.countInVolume=s),t.countInVolume}midiEventsPlayedFilter(e,t,s){return Array.isArray(s)&&(t.midiEventsPlayedFilter=s),t.midiEventsPlayedFilter}playbackSpeed(e,t,s){return"number"==typeof s&&(t.playbackSpeed=s),t.playbackSpeed}tickPosition(e,t,s){return"number"==typeof s&&(t.tickPosition=s),t.tickPosition}timePosition(e,t,s){return"number"==typeof s&&(t.timePosition=s),t.timePosition}loop(e,t,s){return"boolean"==typeof s&&(t.isLooping=s),t.isLooping}renderer(e,t){return t.renderer}score(e,t){return t.score}settings(e,t){return t.settings}tracks(e,t){return t.tracks}_oninit(e){this._initListeners.push(e)}static restore(e){new jQuery(e).empty().removeData("alphaTab")}},eh=class eh{constructor(){this._color=new Ut(0,0,0,0),this._lineWidth=0,this._textStyle=null,this._scale=1,this._textStyles=new Map,this._font=new A("Arial",10,0),this._musicTextStyle=null,this.textAlign=0,this.textBaseline=0,this._canvas=new eh._alphaSkia.AlphaSkiaCanvas,this.color=new Ut(0,0,0,255)}static enable(e,t){eh._alphaSkia=t,eh.initializeMusicFont(eh._alphaSkia.AlphaSkiaTypeface.register(e))}static initializeMusicFont(e){eh._defaultMusicTextStyle=new eh._alphaSkia.AlphaSkiaTextStyle([e.familyName],e.weight,e.isItalic)}static registerFont(e,t){e=eh._alphaSkia.AlphaSkiaTypeface.register(e.buffer);return t=t||A.withFamilyList([e.familyName],12,e.isItalic?1:0,400<e.weight?1:0)}get font(){return this._font}set font(e){var t;this._font!==e&&(this._font=e,t=this._textStyleKey(e),this._textStyles.has(t)?this._textStyle=this._textStyles.get(t):(e=new eh._alphaSkia.AlphaSkiaTextStyle(e.families,1===e.weight?700:400,e.isItalic),this._textStyles.set(t,e),this._textStyle=e))}_textStyleKey(e){return[...e.families,e.weight.toString(),e.isItalic?"italic":"upright"].join("_")}destroy(){this._canvas[Symbol.dispose]();for(var e of this._textStyles.values())e[Symbol.dispose]()}onRenderFinished(){return null}beginRender(e,t){this._scale=this.settings.display.scale,this._canvas.beginRender(e,t,E.highDpiFactor);e=this.settings.display.resources.smuflFontFamilyName;e&&e!==eh._defaultMusicTextStyle.familyNames[0]?this._textStyles.has(e)?this._musicTextStyle=this._textStyles.get(e):(this._musicTextStyle=new eh._alphaSkia.AlphaSkiaTextStyle([e],eh._defaultMusicTextStyle.weight,eh._defaultMusicTextStyle.isItalic),this._textStyles.set(e,this._musicTextStyle)):this._musicTextStyle=eh._defaultMusicTextStyle}endRender(){return this._canvas.endRender()}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._canvas.color=eh._alphaSkia.AlphaSkiaCanvas.rgbaToColor(e.r,e.g,e.b,e.a))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._canvas.lineWidth=e}fillRect(e,t,s,i){0<s&&this._canvas.fillRect(e*this._scale,t*this._scale,s*this._scale,i*this._scale)}strokeRect(e,t,s,i){var a=this.lineWidth%2==0?0:.5;this._canvas.strokeRect(e*this._scale+a,t*this._scale+a,s*this._scale,i*this._scale)}beginPath(){this._canvas.beginPath()}closePath(){this._canvas.closePath()}moveTo(e,t){this._canvas.moveTo(e*this._scale,t*this._scale)}lineTo(e,t){this._canvas.lineTo(e*this._scale,t*this._scale)}quadraticCurveTo(e,t,s,i){this._canvas.quadraticCurveTo(e*this._scale,t*this._scale,s*this._scale,i*this._scale)}bezierCurveTo(e,t,s,i,a,r){this._canvas.bezierCurveTo(e*this._scale,t*this._scale,s*this._scale,i*this._scale,a*this._scale,r*this._scale)}fillCircle(e,t,s){this._canvas.fillCircle(e*this._scale,t*this._scale,s*this._scale)}strokeCircle(e,t,s){this._canvas.strokeCircle(e*this._scale,t*this._scale,s*this._scale)}fill(){this._canvas.fill()}stroke(){this._canvas.stroke()}beginGroup(e){}endGroup(){}fillText(s,i,a){if(0!==s.length){let e=eh._alphaSkia.AlphaSkiaTextAlign.Left;switch(this.textAlign){case 0:e=eh._alphaSkia.AlphaSkiaTextAlign.Left;break;case 1:e=eh._alphaSkia.AlphaSkiaTextAlign.Center;break;case 2:e=eh._alphaSkia.AlphaSkiaTextAlign.Right}let t=eh._alphaSkia.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case 0:t=eh._alphaSkia.AlphaSkiaTextBaseline.Top;break;case 1:t=eh._alphaSkia.AlphaSkiaTextBaseline.Middle;break;case 2:t=eh._alphaSkia.AlphaSkiaTextBaseline.Bottom;break;case 3:t=eh._alphaSkia.AlphaSkiaTextBaseline.Alphabetic}this._canvas.fillText(s,this._textStyle,this._font.size*this._scale,i*this._scale,a*this._scale,e,t)}}measureText(e){var t=[];try{var s=z(t,this._canvas.measureText(e,this._textStyle,this._font.size,eh._alphaSkia.AlphaSkiaTextAlign.Left,eh._alphaSkia.AlphaSkiaTextBaseline.Alphabetic)),[i,a]=this._getTextWidthAndHeight(s,e);return new ze(i,a)}catch(e){var r=e,n=!0}finally{U(t,r,n)}}_getTextWidthAndHeight(t,e){let s=t.width;if(0<e.length&&s<1)for(let e=0;e<5&&!(1<(s=t.width));e++);return[s,t.actualBoundingBoxAscent+t.actualBoundingBoxDescent]}fillMusicFontSymbol(e,t,s,i,a){-1!==i&&this._fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),a)}fillMusicFontSymbols(e,t,s,i,a){let r="";for(var n of i)-1!==n&&(r+=String.fromCharCode(n));this._fillMusicFontSymbolText(e,t,s,r,a)}_fillMusicFontSymbolText(e,t,s,i,a){this._canvas.fillText(i,this._musicTextStyle,this.settings.display.resources.engravingSettings.musicFontSize*this._scale*s,e*this._scale,t*this._scale,a?eh._alphaSkia.AlphaSkiaTextAlign.Center:eh._alphaSkia.AlphaSkiaTextAlign.Left,eh._alphaSkia.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(e,t,s){this._canvas.beginRotate(e*this._scale,t*this._scale,s)}endRotate(){this._canvas.endRotate()}},th=(eh._defaultMusicTextStyle=null,eh),sh=class Op{constructor(){this.buffer="",this._currentPath="",this._currentPathIsEmpty=!0,this.scale=1,this.color=new Ut(255,255,255,255),this.lineWidth=1,this.font=new A("Arial",10,0),this.textAlign=0,this.textBaseline=0}destroy(){}beginRender(e,t){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|e}px" height="${0|t}px" class="at-surface-svg">
`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=0}beginGroup(e){this.buffer+=`<g class="${e}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(e,t,s,i){0<s&&(this.buffer+=`<rect x="${e*this.scale}" y="${t*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />
`)}strokeRect(e,t,s,i){var a=this.lineWidth*this.scale%2==0?0:.5;this.buffer+=`<rect x="${e*this.scale+a}" y="${t*this.scale+a}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=` fill="transparent" />
`}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(e,t){this._currentPath+=` M${e*this.scale},`+t*this.scale}lineTo(e,t){this._currentPathIsEmpty=!1,this._currentPath+=` L${e*this.scale},`+t*this.scale}quadraticCurveTo(e,t,s,i){this._currentPathIsEmpty=!1,this._currentPath+=` Q${e*this.scale},${t*this.scale},${s*this.scale},`+i*this.scale}bezierCurveTo(e,t,s,i,a,r){this._currentPathIsEmpty=!1,this._currentPath+=` C${e*this.scale},${t*this.scale},${s*this.scale},${i*this.scale},${a*this.scale},`+r*this.scale}fillCircle(e,t,s){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,s*=this.scale,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.fill()}strokeCircle(e,t,s){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,s*=this.scale,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let e=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;1===this.lineWidth&&1===this.scale||(e+=` stroke-width="${this.lineWidth*this.scale}"`),e+=' style="fill: none" />',this.buffer+=e}this._currentPath="",this._currentPathIsEmpty=!0}fillText(t,s,i){if(""!==t){let e=`<text x="${s*this.scale}" y="${i*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(e+=` fill="${this.color.rgba}"`),0!==this.textAlign&&(e+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),e+=`>${Op._escapeText(t)}</text>`,this.buffer+=e}}static _escapeText(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(e){switch(e){case 0:return"start";case 1:return"middle";case 2:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case 0:return"dominant-baseline: hanging";case 2:return"dominant-baseline: ideographic";case 3:return"";case 1:return"dominant-baseline: middle";default:return""}}measureText(e){return e?Zn.measureString(e,this.font.families,this.font.size,this.font.style,this.font.weight):new ze(0,0)}onRenderFinished(){return null}beginRotate(e,t,s){this.buffer+=`<g transform="translate(${e*this.scale} ,${t*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}},ih=class extends sh{fillMusicFontSymbol(e,t,s,i,a){-1!==i&&this._fillMusicFontSymbolText(e,t,s,`&#${i};`,a)}fillMusicFontSymbols(e,t,s,i,a){let r="";for(var n of i)-1!==n&&(r+=`&#${n};`);this._fillMusicFontSymbolText(e,t,s,r,a)}_fillMusicFontSymbolText(e,t,s,i,a){e*=this.scale,t*=this.scale,this.buffer+=`<g transform="translate(${e} ${t})" class="at" ><text`;e=this.scale*s;this.buffer+=1!=e?` style="font-size: ${100*e}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),a&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(1)}"`),this.buffer+=`>${i}</text></g>`}},m=class{constructor(){this.isInsideBracket=!0,this.isRelevantForBoundsLookup=!0,this.hideOnMultiTrack=!1,this.hideOnPercussionTrack=!1}canCreate(e,t){return!this.hideOnPercussionTrack||!t.isPercussion}},ah=class extends zt{constructor(){super(...arguments),this.glyphs=null}get isEmpty(){return!this.glyphs||0===this.glyphs.length}getBoundingBoxTop(){let e=0,t=this.glyphs;if(t)for(var s of t){s=s.getBoundingBoxTop();s<e&&(e=s)}return e}doLayout(){if(this.glyphs&&0!==this.glyphs.length){let s=0,i=0;for(let e=0,t=this.glyphs.length;e<t;e++){var a=this.glyphs[e];a.renderer=this.renderer,a.doLayout(),s=Math.max(s,a.width),i=Math.max(i,a.y+a.height)}this.width=s,this.height=i}else this.width=0}addGlyph(e){this.glyphs||(this.glyphs=[]),this.renderer&&(e.renderer=this.renderer),this.glyphs.push(e)}paint(e,t,s){var i=this.glyphs;if(i&&0!==i.length)for(var a of i)a.paint(e+this.x,t+this.y,s)}},rh=class extends ah{constructor(){super(0,0),this.gap=0,this.glyphs=[]}doLayout(){}addGlyph(e){e.x=this.width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width+this.gap,super.addGlyph(e)}},I=class Vp{static score(e,t,s,i=!1){if(s.style||i)return i=Vp._scoreDefaultColor(e.settings.display.resources,t),new nh(e,t,s.style,i)}static scoreColor(e,t,s){e=Vp._scoreDefaultColor(e,t);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??e}static _scoreDefaultColor(e,t){return e.mainGlyphColor}static bar(t,s,i,e=!1){if(i.style||e){let e=t.settings.display.resources.mainGlyphColor;switch(s){case 0:case 1:case 2:case 3:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:break;case 8:case 9:case 10:case 11:e=t.settings.display.resources.barSeparatorColor;break;case 4:case 6:case 7:case 5:e=t.settings.display.resources.barNumberColor;break;case 20:case 21:case 22:case 23:e=t.settings.display.resources.staffLineColor}return new nh(t,s,i.style,e)}}static voice(e,t,s,i=!1){if(s.style||i)return i=0===s.index?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor,new nh(e,t,s.style,i)}static trackColor(e,t,s){e=Vp._trackDefaultColor(e,t);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??e}static _trackDefaultColor(e,t){let s=e.mainGlyphColor;switch(t){case 0:case 2:case 3:break;case 1:s=e.barSeparatorColor}return s}static track(e,t,s,i=!1){if(s.style||i)return i=Vp._trackDefaultColor(e.settings.display.resources,t),new nh(e,t,s.style,i)}static beatColor(e,t,s){e=Vp._beatDefaultColor(e,t,s);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??e}static _beatDefaultColor(e,t,s){return 0===s.voice.index?e.mainGlyphColor:e.secondaryGlyphColor}static beat(e,t,s,i=!1){if(s.style||i)return i=Vp._beatDefaultColor(e.settings.display.resources,t,s),new nh(e,t,s.style,i)}static noteColor(e,t,s){e=Vp._noteDefaultColor(e,t,s);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??e}static _noteDefaultColor(e,t,s){return 0===s.beat.voice.index?e.mainGlyphColor:e.secondaryGlyphColor}static note(e,t,s,i=!1){if(s.style||i)return i=0===s.beat.voice.index?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor,new nh(e,t,s.style,i)}},nh=class{constructor(e,t,s,i){this._canvas=e,s&&s.colors.has(t)?(this._previousColor=e.color,e.color=s.colors.get(t)??i):s||(this._previousColor=e.color,e.color=i)}[Symbol.dispose](){this._previousColor&&(this._canvas.color=this._previousColor)}},oh=class extends ah{constructor(e,t,s){super(e,t),this.voice=s,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){e=this.renderer.layoutingInfo.spaceToForce(e);this._scaleToForce(e)}_scaleToForce(e){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e);var s=this.renderer.layoutingInfo.buildOnTimePositions(e),i=this.beatGlyphs;for(let e=0,t=i.length;e<t;e++){var a,r,n,o=i[e];0===o.beat.graceType?o.x=s.get(o.beat.absoluteDisplayStart)-o.onTimeX:(n=o.beat.graceGroup.beats[0].absoluteDisplayStart,r=o.beat.graceGroup.id,o.beat.graceGroup.isComplete&&s.has(n)?(o.x=s.get(n)-o.onTimeX,n=this.renderer.layoutingInfo.allGraceRods.get(r),a=(a=o.beat.graceGroup.beats[o.beat.graceGroup.beats.length-1].nextBeat)?this.renderer.layoutingInfo.getPreBeatSize(a):0,o.x-=a,o.x-=n[o.beat.graceIndex].postSpringWidth,o.x+=n[o.beat.graceIndex].graceBeatWidth,a=n[o.beat.graceGroup.beats.length-1],o.x-=a.graceBeatWidth):(a=(n=this.renderer.layoutingInfo.incompleteGraceRods.get(r))[o.beat.graceIndex].postSpringWidth-n[o.beat.graceIndex].preSpringWidth,0<e?0===o.beat.graceIndex?o.x=i[e-1].x+i[e-1].width:o.x=i[e-1].x+n[o.beat.graceIndex-1].postSpringWidth-n[o.beat.graceIndex-1].preSpringWidth-a:o.x=-a)),0<e&&(r=o.x-i[e-1].x,i[e-1].scaleToWidth(r)),e===t-1&&(n=this.width-i[i.length-1].x,o.scaleToWidth(n))}}registerLayoutingInfo(e){var t;for(t of this.beatGlyphs)t.registerLayoutingInfo(e)}applyLayoutingInfo(e){var t;for(t of this.beatGlyphs)t.applyLayoutingInfo(e);this._scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){var t=e;e.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(t),this.width=e.x+e.width,t.beat.hasTuplet&&t.beat.tupletGroup.beats[0].id===t.beat.id&&this.tupletGroups.push(t.beat.tupletGroup)}doLayout(){}paint(s,i,a){var e=[];try{z(e,I.voice(a,0,this.voice,!0));for(let e=0,t=this.beatGlyphs.length;e<t;e++)this.beatGlyphs[e].paint(s+this.x,i+this.y,a)}catch(e){var t=e,r=!0}finally{U(e,t,r)}}},hh=(oh.KeySizeBeat="Beat",class{constructor(){this.staffId="",this.up=0,this.down=0}}),lh=class{constructor(){this.startBeat=null,this.startX=0,this.startY=0,this.endBeat=null,this.endX=0,this.endY=0}calcY(e){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(e-this.startX)+this.startY}},dh=class Wp{constructor(e,t){this._beatLineXPositions=new Map,this._firstNonRestBeat=null,this._lastNonRestBeat=null,this.voice=null,this.beats=[],this.shortestDuration=-4,this.hasTuplet=!1,this.slashBeats=[],this.lowestNoteInHelper=null,this._lowestNoteCompareValueInHelper=-1,this.highestNoteInHelper=null,this._highestNoteCompareValueInHelper=-1,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.graceType=0,this.minRestLine=null,this.beatOfMinRestLine=null,this.maxRestLine=null,this.beatOfMaxRestLine=null,this.direction=0,this.drawingInfos=new Map,this._staff=e,this._renderer=t,this.beats=[]}get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasLine(e,t){return e&&this._beatHasLine(t)||!e&&1===this.beats.length&&this._beatHasLine(t)}_beatHasLine(e){return 1<Math.abs(e.duration)}hasFlag(e,t){return e&&this._beatHasFlag(t)||!e&&1===this.beats.length&&this._beatHasFlag(this.beats[0])}_beatHasFlag(e){return!e.deadSlapped&&!e.isRest&&(4<e.duration||0!==e.graceType)}getBeatLineX(e,t){return t=t??this.direction,this.hasBeatLineX(e)?0===t?this._beatLineXPositions.get(e.index).up:this._beatLineXPositions.get(e.index).down:0}hasBeatLineX(e){return this._beatLineXPositions.has(e.index)}registerBeatLineX(e,t,s,i){var a,r=this._getOrCreateBeatPositions(t);r.staffId=e,r.up=s,r.down=i;for(a of this.drawingInfos.values())a.startBeat===t?a.startX=this.getBeatLineX(t):a.endBeat===t&&(a.endX=this.getBeatLineX(t))}_getOrCreateBeatPositions(e){return this._beatLineXPositions.has(e.index)||this._beatLineXPositions.set(e.index,new hh),this._beatLineXPositions.get(e.index)}finish(){this.direction=this._calculateDirection(),this._renderer.completeBeamingHelper(this)}_calculateDirection(){var e,t;return this.voice?null!==this.preferredBeamDirection?this.preferredBeamDirection:0<this.voice.index?this._invert(1):!this.voice.bar.isMultiVoice&&0===this.beats[0].graceType&&this.highestNoteInHelper&&this.lowestNoteInHelper?(e=this._renderer.getNoteY(this.highestNoteInHelper,2),t=this._renderer.getNoteY(this.lowestNoteInHelper,2),this._invert(this._renderer.middleYPosition<(e+t)/2?0:1)):this._invert(0):0}static computeLineHeightsForRest(e){switch(e){case-4:case-2:return[2,2];case 1:return[0,1];case 2:return[1,0];case 4:return[3,3];case 8:return[2,2];case 16:return[2,4];case 32:return[4,4];case 64:return[4,6];case 128:return[6,6];case 256:return[6,8]}return[0,0]}applyRest(e,t){var s,i,a;this._lastNonRestBeat&&e.index>=this._lastNonRestBeat.index||this._firstNonRestBeat&&e.index<=this._firstNonRestBeat.index||(s=t=t,t-=(i=Wp.computeLineHeightsForRest(e.duration))[0],s+=i[1],i=this.minRestLine,a=this.maxRestLine,(null===i||t<i)&&(this.minRestLine=t,this.beatOfMinRestLine=e),(null===a||a<s)&&(this.maxRestLine=s,this.beatOfMaxRestLine=e))}_invert(e){return this.invertBeamDirection?1===e?0:1:e}checkBeat(e){e.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=e.voice);let t=!1;if(0===this.beats.length)t=!0;else switch(this.beats[this.beats.length-1].beamingMode){case 0:case 3:t=Wp._canJoin(this.beats[this.beats.length-1],e);break;case 1:t=!1;break;case 2:t=!0}return t&&(null==this.preferredBeamDirection&&null!==e.preferredBeamDirection&&(this.preferredBeamDirection=e.preferredBeamDirection),e.hasTuplet&&(this.hasTuplet=!0),e.isTremolo&&(!this.tremoloDuration||this.tremoloDuration<e.tremoloSpeed)&&(this.tremoloDuration=e.tremoloSpeed),0!==e.graceType&&(this.graceType=e.graceType),e.isRest?this.beats.push(e):(this.beats.push(e),this._checkNote(e.minNote),this._checkNote(e.maxNote),this.shortestDuration<e.duration&&(this.shortestDuration=e.duration),this._firstNonRestBeat||(this._firstNonRestBeat=e),this._lastNonRestBeat=e),e.slashed)&&this.slashBeats.push(e),t}_checkNote(s){if(s){let e,t;this.voice&&s.isPercussion?(e=-Pi.getPercussionLine(this.voice.bar,Pi.getNoteValue(s)),t=e):(e=Pi.getNoteValue(s),t=e,0!==s.harmonicType&&1!==s.harmonicType&&(t=s.realValue-this._staff.displayTranspositionPitch)),(!this.lowestNoteInHelper||e<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=s,this._lowestNoteCompareValueInHelper=e),(!this.highestNoteInHelper||t>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=s,this._highestNoteCompareValueInHelper=t)}}static _canJoin(e,t){if(!e||!t||e.graceType!==t.graceType||3===e.graceType||3===t.graceType||e.deadSlapped||t.deadSlapped)return!1;if(0!==e.graceType&&0!==t.graceType)return!0;var s=e.voice.bar;if(s!==t.voice.bar)return!1;var i=e.playbackStart,a=t.playbackStart;if(!Wp._canJoinDuration(e.duration)||!Wp._canJoinDuration(t.duration))return i===a;if(e.tupletGroup!==t.tupletGroup)return!1;if(e.hasTuplet&&t.hasTuplet&&e.tupletGroup===t.tupletGroup&&e.tupletGroup.isFull)return!0;let r=N.QuarterTime;return 8===s.masterBar.timeSignatureDenominator&&s.masterBar.timeSignatureNumerator%3==0&&(r+=N.QuarterTime/2|0),((r+i)/r|0)==((r+a)/r|0)}static _canJoinDuration(e){switch(e){case 1:case 2:case 4:return!1;default:return!0}}static isFullBarJoin(e,t,s){return 0<F.getIndex(e.duration)-2-s&&0<F.getIndex(t.duration)-2-s}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(e,t){return!this._beatLineXPositions.has(t.index)||this._beatLineXPositions.get(t.index).staffId===e||!this._beatLineXPositions.get(t.index).staffId}},ch=class{constructor(e,t){this.topY=0,this.bottomY=0,this.topY=e,this.bottomY=t}},uh=class{constructor(e){this.topY=-1e3,this.bottomY=-1e3,this.slots=[],this.beat=e}addSlot(e,t){var s;this.slots.push(new ch(e,t)),-1e3===this.topY?(this.topY=e,this.bottomY=t):(s=Math.min(e,t),e=Math.max(e,t),s<this.topY&&(this.topY=s),e>this.bottomY&&(this.bottomY=e))}},ph=class{constructor(){this.reservedLayoutAreasByDisplayTime=new Map,this.restDurationsByDisplayTime=new Map}getBeatMinMaxY(){let e=-1e3,t=-1e3;for(var s of this.reservedLayoutAreasByDisplayTime.values())-1e3===e?(e=s.topY,t=s.bottomY):(e>s.topY&&(e=s.topY),t<s.bottomY&&(t=s.bottomY));return-1e3===e?[0,0]:[e,t]}reserveBeatSlot(e,t,s){t!==s&&(this.reservedLayoutAreasByDisplayTime.has(e.displayStart)||this.reservedLayoutAreasByDisplayTime.set(e.displayStart,new uh(e)),this.reservedLayoutAreasByDisplayTime.get(e.displayStart).addSlot(t,s),e.isRest)&&this.registerRest(e)}registerRest(e){this.restDurationsByDisplayTime.has(e.displayStart)||this.restDurationsByDisplayTime.set(e.displayStart,new Map),this.restDurationsByDisplayTime.get(e.displayStart).has(e.playbackDuration)||this.restDurationsByDisplayTime.get(e.displayStart).set(e.playbackDuration,e.id)}applyRestCollisionOffset(n,o,h){if(0<n.voice.index&&this.reservedLayoutAreasByDisplayTime.has(n.playbackStart)){let e=dh.computeLineHeightsForRest(n.duration).map(e=>e*h),t=o-e[0],s=o+e[1],i=t,a=this.reservedLayoutAreasByDisplayTime.get(n.playbackStart),r=!1;for(var l of a.slots)if(t>=l.topY&&t<=l.bottomY||s>=l.topY&&s<=l.bottomY){r=!0;break}var d;if(r)return o=(i=1===n.voice.index?a.topY-e[1]-e[0]:a.bottomY)+e[0]+e[1],n=2*h,d=Math.ceil(Math.abs(i-t)/n),a.addSlot(i,o),i<t?d*-n:d*n}return 0}},mh=class{constructor(e){this.beamHelpers=[],this.beamHelperLookup=[],this.preferredBeamDirection=null,this._renderer=e,this.collisionHelper=new ph}initialize(){let i=this._renderer,a=this._renderer.bar,r=null,n=null;for(let e=0,t=a.voices.length;e<t;e++){var o=a.voices[e];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let s=0,e=o.beats.length;s<e;s++){let e=o.beats[s],t;0!==e.graceType?t=n:(t=r,n=null),t&&t.checkBeat(e)||(t&&t.finish(),(t=new dh(a.staff,i)).preferredBeamDirection=this.preferredBeamDirection,t.checkBeat(e),0!==e.graceType?n=t:r=t,this.beamHelpers[o.index].push(t)),this.beamHelperLookup[o.index].set(e.index,t)}r&&r.finish(),n&&n.finish(),r=null,n=null}}getBeamingHelperForBeat(e){return this.beamHelperLookup[e.voice.index].get(e.index)}},gh=class extends Yt{constructor(e,t,s){super(e,t),this._textRow=0,this._fretRow=0,this._firstFretSpacing=0,this._chord=s}doLayout(){super.doLayout();var e=2*this.renderer.resources.effectFont.size*.4,t=(this._textRow=.72*e,this._fretRow=.5*e,1<this._chord.firstFret?this._firstFretSpacing=.8*e:this._firstFretSpacing=0,.8*e);this.height=this._textRow+.5*e+4*e+.5*e,this.width=this._firstFretSpacing+(this._chord.strings.length-1)*t+e}paint(e,t,s){var i=s.color,a=s.font,r=s.textAlign,n=s.textBaseline,o=s.lineWidth,h=this.renderer.resources,l=2*h.effectFont.size*.4,d=.8*l,c=new Ut(200,119,118),u=new Ut(0,0,0,255),p=l/20,m=.62*l-.95,g=.31*l,f=.2*l,b=(e+=this.x,t+=this.y,(this._chord.strings.length-1)*d),y=e-b/2,_=t+this._textRow+.5*l;this._chord.showName&&(s.textAlign=1,s.textBaseline=1,s.font=A.withFamilyList(["Arial","sans-serif"],1.7*l/3*2.5,h.effectFont.style,1),s.color=c,s.fillText(this._chord.name,e,t+.72*l/2)),1<this._chord.firstFret&&(s.textAlign=1,s.textBaseline=1,s.font=A.withFamilyList(h.effectFont.families,.8*l/3*2.5+5,h.effectFont.style,h.effectFont.weight),s.color=u,s.fillText(this._chord.firstFret.toString(),y-this._firstFretSpacing/2-2.5,_+.6*l)),s.color=u,s.lineWidth=p;for(let e=0;e<this._chord.strings.length;e++){var S=y+e*d;s.beginPath(),s.moveTo(S,_),s.lineTo(S,_+4*l),s.stroke()}for(let e=0;e<5;e++){var v=_+e*l;s.beginPath(),s.moveTo(y,v),s.lineTo(y+b,v),s.stroke()}s.lineWidth=.1*l;for(let e=0;e<this._chord.strings.length;e++){var k,w=y+(this._chord.strings.length-1-e)*d;-1===this._chord.strings[e]&&(k=_-.2*l,s.beginPath(),s.moveTo(w-f,k-f),s.lineTo(w+f,k+f),s.stroke(),s.beginPath(),s.moveTo(w-f,k+f),s.lineTo(w+f,k-f),s.stroke())}var T,B=new Map;for(T of this._chord.barreFrets)B.set(T-this._chord.firstFret,[-1,-1]);var x,P,N,M=[];for(let e=0;e<this._chord.strings.length;e++){var E,L,C=this._chord.strings[e];0<C&&(L=C-(this._chord.firstFret-1),E=this._chord.strings.length-1-e,M.push({x:y+E*d,y:_+(L-1)*l+.5*l}),E=C-this._chord.firstFret,B.has(E))&&((-1===(L=B.get(E))[0]||e<L[0])&&(L[0]=e),-1===L[1]||e>L[1])&&(L[1]=e)}s.lineWidth=m,s.beginPath();for([x,P]of B){var F=_+(x+1-1)*l+.5*l,D=P[0],I=P[1];-1!==D&&-1!==I&&(D=y+(this._chord.strings.length-1-D)*d,I=y+(this._chord.strings.length-1-I)*d,s.beginPath(),s.moveTo(D,F),s.lineTo(I,F),s.stroke())}s.color=u;for(N of M)s.fillCircle(N.x,N.y,g);s.color=i,s.font=a,s.textAlign=r,s.textBaseline=n,s.lineWidth=o}},fh=(gh._frets=5,class extends ah{constructor(e,t,s=1){super(e,t),this._glyphWidth=0,this.glyphs=[],this._align=s}doLayout(){let e=this.renderer.smuflMetrics.rowContainerGap,t=this._glyphWidth-e,s=0;switch(this._align){case 0:s=0;break;case 1:s=(this.width-t)/2;break;case 2:s=this.width-t}for(var i of this.glyphs)i.x=s,s+=i.width+e}addGlyphToRow(e){this.glyphs.push(e),this._glyphWidth+=e.width+this.renderer.smuflMetrics.rowContainerGap,e.height>this.height&&(this.height=e.height)}}),jt=class extends ah{constructor(e,t,s=1){super(e,t),this._rows=[],this.height=0,this.glyphs=[],this._align=s}doLayout(){let e=0,t=0,s=this.renderer.smuflMetrics.rowContainerGap,i=(this._rows=[],new fh(e,t,this._align));i.renderer=this.renderer,i.width=this.width;for(var a of this.glyphs){var r=e+a.width+s;r<this.width?(i.addGlyphToRow(a),e=Math.ceil(r)):(i.isEmpty||(i.doLayout(),this._rows.push(i),t+=i.height+s),e=0,(i=new fh(e,t,this._align)).renderer=this.renderer,i.width=this.width,i.addGlyphToRow(a),e+=Math.ceil(a.width+s))}i.isEmpty||(i.doLayout(),this._rows.push(i),t+=Math.ceil(i.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=t}paint(e,t,s){for(var i of this._rows)i.paint(e+this.x,t+this.y,s)}},bh=class extends jt{addChord(e){0<e.strings.length&&((e=new gh(0,0,e)).renderer=this.renderer,e.doLayout(),this.glyphs.push(e))}paint(e,t,s){if(0<this.glyphs.length){var i=[];try{z(i,I.score(s,10,this.renderer.scoreRenderer.score));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{U(i,a,r)}}}},yh=class extends Yt{constructor(e,t,s,i,a=0,r=null,n){super(e,t),this._lineHeights=null,this._lines=s.split(`
`),this.font=i,this.textAlign=a,this.textBaseline=r,this.colorOverride=n}doLayout(){super.doLayout(),this._lineHeights=[];var e,t=this.renderer.scoreRenderer.canvas;for(e of this._lines){t.font=this.font;var s=t.measureText(e),i=s.height;this._lineHeights.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(t,e,s){var i=s.color,a=(s.color=this.colorOverride??i,s.font=this.font,s.textAlign),r=s.textBaseline;s.textAlign=this.textAlign,null!==this.textBaseline&&(s.textBaseline=this.textBaseline);let n=e+this.y;for(let e=0;e<this._lines.length;e++)s.fillText(this._lines[e],t+this.x,n),n+=this._lineHeights[e];s.textAlign=a,s.textBaseline=r,s.color=i}},_h=class{constructor(e,t,s){this._sharedLayoutData=new Map,this.barRenderers=[],this.x=0,this.y=0,this.height=0,this.index=0,this.staffIndex=0,this.isFirstInSystem=!1,this.trackIndex=0,this.staveTop=0,this.topSpacing=0,this.bottomSpacing=0,this.staveBottom=0,this._factory=s,this.trackIndex=e,this.modelStaff=t}get staffId(){return this._factory.staffId}get contentTop(){return this.y+this.staveTop+this.topSpacing+this.topOverflow}get contentBottom(){return this.y+this.topSpacing+this.topOverflow+this.staveBottom}getSharedLayoutData(e,t){return this._sharedLayoutData.has(e)?this._sharedLayoutData.get(e):t}setSharedLayoutData(e,t){this._sharedLayoutData.set(e,t)}get isInsideBracket(){return this._factory.isInsideBracket}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(e){this.staveTop=e}registerStaffBottom(e){this.staveBottom=e}addBarRenderer(e){e.staff=this,e.index=this.barRenderers.length,e.reLayout(),this.barRenderers.push(e),this.system.layout.registerBarRenderer(this.staffId,e)}addBar(e,t,s){var i=this._factory.create(this.system.layout.renderer,e),s=(i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=t,i.doLayout(),i.registerLayoutingInfo(),i.barDisplayWidth);0<s&&2===this.system.layout.systemsLayoutMode&&(i.width=s),this.barRenderers.push(i),e&&this.system.layout.registerBarRenderer(this.staffId,i)}revertLastBar(){var e,t=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staffId,t);for(e of this.barRenderers)e.applyLayoutingInfo();return t}scaleToWidth(e){this._sharedLayoutData=new Map;let t=this.topOverflow,s=0;switch(this.system.layout.systemsLayoutMode){case 0:var i,a=(e-this.system.computedWidth)/this.barRenderers.length;for(i of this.barRenderers){i.x=s,i.y=this.topSpacing+t;var r=i.computedWidth+a;i.scaleToWidth(r),s+=i.width}break;case 1:e-=this.system.accoladeWidth;var n,o=this.system.totalBarDisplayScale;for(n of this.barRenderers){n.x=s,n.y=this.topSpacing+t;var h=n.barDisplayScale*e/o;n.scaleToWidth(h),s+=n.width}break;case 2:for(var l of this.barRenderers){l.x=s,l.y=this.topSpacing+t;var d=l.barDisplayWidth;0<d?l.scaleToWidth(d):l.scaleToWidth(l.computedWidth),s+=l.width}}}get topOverflow(){let s=0;for(let e=0,t=this.barRenderers.length;e<t;e++){var i=this.barRenderers[e];i.topOverflow>s&&(s=i.topOverflow)}return s}get bottomOverflow(){let s=0;for(let e=0,t=this.barRenderers.length;e<t;e++){var i=this.barRenderers[e];i.bottomOverflow>s&&(s=i.bottomOverflow)}return s}calculateHeightForAccolade(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=0<this.barRenderers.length?this.barRenderers[0].height:0,0<this.height&&(this.height+=Math.ceil(this.topSpacing+this.topOverflow+this.bottomOverflow+this.bottomSpacing))}finalizeStaff(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=0;let t=!1,s=this.topOverflow;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].y=this.topSpacing+s,this.height=Math.max(this.height,this.barRenderers[e].height),this.barRenderers[e].finalizeRenderer()&&(t=!0);if(t){s=this.topOverflow;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].y=this.topSpacing+s;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].finalizeRenderer()}0<this.height&&(this.height+=this.topSpacing+s+this.bottomOverflow+this.bottomSpacing),this.height=Math.ceil(this.height)}paint(s,i,a,r,n){if(0!==this.height&&0!==n)for(let e=r,t=Math.min(r+n,this.barRenderers.length);e<t;e++)this.barRenderers[e].paint(s+this.x,i+this.y,a)}},Sh=class{constructor(){this.timePosition=0,this.longestDuration=0,this.smallestDuration=0,this.force=0,this.springConstant=0,this.preBeatWidth=0,this.graceBeatWidth=0,this.postSpringWidth=0,this.allDurations=new Set}get springWidth(){return this.preSpringWidth+this.postSpringWidth}get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}},vh=class vh{constructor(){this._timeSortedSprings=[],this._minTime=-1,this._onTimePositionsForce=0,this._onTimePositions=new Map,this._incompleteGraceRodsWidth=0,this._minDuration=vh._defaultMinDuration,this.version=0,this.preBeatSize=0,this.postBeatSize=0,this.minStretchForce=0,this.totalSpringConstant=0,this.incompleteGraceRods=new Map,this.allGraceRods=new Map,this.springs=new Map,this.height=0}_updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e)}getPreBeatSize(e){var t;return 0!==e.graceType?(t=e.graceGroup.id,this.allGraceRods.get(t)[e.graceIndex].preBeatWidth):this.springs.has(t=e.absoluteDisplayStart)?this.springs.get(t).preBeatWidth:0}getPostBeatSize(e){var t;return 0!==e.graceType?(t=e.graceGroup.id,this.allGraceRods.get(t)[e.graceIndex].postSpringWidth):this.springs.has(t=e.absoluteDisplayStart)?this.springs.get(t).postSpringWidth:0}addSpring(s,i,a,r,n){this.version++;let o;if(this.springs.has(s))(o=this.springs.get(s)).postSpringWidth<n&&(o.postSpringWidth=n),o.graceBeatWidth<a&&(o.graceBeatWidth=a),o.preBeatWidth<r&&(o.preBeatWidth=r),i<o.smallestDuration&&(o.smallestDuration=i),i>o.longestDuration&&(o.longestDuration=i),o.allDurations.add(i);else{if((o=new Sh).timePosition=s,o.allDurations.add(i),0<this._timeSortedSprings.length){let e=i,t=this._timeSortedSprings[this._timeSortedSprings.length-1];for(var h of t.allDurations)t.timePosition+h>=s&&h<e&&(e=h);i<this._minDuration&&(this._minDuration=i)}o.longestDuration=i,o.postSpringWidth=n,o.graceBeatWidth=a,o.preBeatWidth=r,this.springs.set(s,o);let e=this._timeSortedSprings,t=e.length-1;for(;0<t&&e[t].timePosition>s;)t--;this._timeSortedSprings.splice(t+1,0,o)}return(-1===this._minTime||this._minTime>s)&&(this._minTime=s),o}addBeatSpring(t,s,i){var a=t.absoluteDisplayStart;if(0!==t.graceType){var e=t.graceGroup.id,r=(this.allGraceRods.has(e)||this.allGraceRods.set(e,new Array(t.graceGroup.beats.length)),t.graceGroup.isComplete||this.incompleteGraceRods.has(e)||this.incompleteGraceRods.set(e,new Array(t.graceGroup.beats.length)),this.allGraceRods.get(e)[t.graceIndex]);r?(r.postSpringWidth<i&&(r.postSpringWidth=i),r.preBeatWidth<s&&(r.preBeatWidth=s)):((r=new Sh).timePosition=a,r.postSpringWidth=i,r.preBeatWidth=s,t.graceGroup.isComplete||(this.incompleteGraceRods.get(e)[t.graceIndex]=r),this.allGraceRods.get(e)[t.graceIndex]=r)}else{let e=0;if(t.graceGroup&&this.allGraceRods.has(t.graceGroup.id))for(var n of this.allGraceRods.get(t.graceGroup.id))e+=n.springWidth;this.addSpring(a,t.displayDuration,e,s,i)}}finish(){for(var[e,t]of this.allGraceRods){let e=0;for(var s of t)e+=s.preBeatWidth,s.graceBeatWidth=e,e+=s.postSpringWidth}this._incompleteGraceRodsWidth=0;for(var i of this.incompleteGraceRods.values())for(var a of i)this._incompleteGraceRodsWidth+=a.preBeatWidth+a.postSpringWidth;this._calculateSpringConstants(),this.version++}_calculateSpringConstants(){let i=0,a=this._timeSortedSprings;if(0===a.length)this.totalSpringConstant=-1,this.minStretchForce=-1;else{for(let s=0;s<a.length;s++){let e=a[s],t=0;var r;t=s===a.length-1?e.longestDuration:(r=a[s+1],Math.abs(r.timePosition-e.timePosition)),e.springConstant=this._calculateSpringConstant(e,t),i+=1/e.springConstant}this.totalSpringConstant=1/i;for(let s=this.minStretchForce=0;s<a.length;s++){let e=a[s],t=0;t=s===a.length-1?e.postSpringWidth:(n=a[s+1],e.postSpringWidth+n.preSpringWidth),0===s&&(t+=e.preSpringWidth);var n=t*e.springConstant;this._updateMinStretchForce(n)}}}paint(e,t,s){}_calculateSpringConstant(e,t){t<=0&&(t=N.toTicks(256)),0===e.smallestDuration&&(e.smallestDuration=t);var e=e.smallestDuration,s=this._minDuration,i=vh._defaultMinDurationWidth;return e/t*(1/((1+.85*Math.log2(t/s))*i))}spaceToForce(e){return-1!==this.totalSpringConstant?(0<this._timeSortedSprings.length&&(e-=this._timeSortedSprings[0].preSpringWidth),e-=this._incompleteGraceRodsWidth,Math.max(e,0)*this.totalSpringConstant):-1}calculateVoiceWidth(e){let t=0;return-1!==this.totalSpringConstant&&(t=this._calculateWidth(e,this.totalSpringConstant)),0<this._timeSortedSprings.length&&(t+=this._timeSortedSprings[0].preSpringWidth),t+=this._incompleteGraceRodsWidth}_calculateWidth(e,t){return e/t}buildOnTimePositions(s){if(-1===this.totalSpringConstant)return new Map;if(F.isAlmostEqualTo(this._onTimePositionsForce,s)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=s;var i=new Map,a=(this._onTimePositions=i,this._timeSortedSprings);if(0!==a.length){let t=a[0].preSpringWidth;for(let e=0;e<a.length;e++)i.set(a[e].timePosition,t),t+=this._calculateWidth(s,a[e].springConstant)}return i}},kh=(vh._defaultMinDuration=30,vh._defaultMinDurationWidth=7,vh),wh=class{constructor(){this.width=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.additionalMultiBarRestIndexes=null,this.renderers=[]}get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}},Th=class{constructor(e,t){this.staves=[],this.stavesRelevantForBoundsLookup=[],this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.bracket=null,this.staffSystem=e,this.track=t}addStaff(e){this.staves.push(e),e.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(e)}},Bh=class Hp extends class{constructor(){this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.drawAsBrace=!1,this.braceScale=1,this.width=0,this.index=0}finalizeBracket(e){var t,s;this.firstStaffInBracket===this.lastStaffInBracket?this.width=0:(t=e.glyphHeights.get(57344),s=e.glyphWidths.get(57344),this.drawAsBrace?this.width=s:this.width=e.bracketThickness,this.drawAsBrace&&this.firstStaffInBracket&&this.lastStaffInBracket&&(e=this.firstStaffInBracket.contentTop,e=(this.lastStaffInBracket.contentBottom-e)/t,this.braceScale=e,this.width=s*this.braceScale))}}{constructor(e){super(),this.track=e,this.drawAsBrace=Hp.isTrackDrawAsBrace(e)}includesStaff(e){return e.modelStaff.track===this.track}static isTrackDrawAsBrace(e){return 1<e.staves.filter(e=>e.showStandardNotation).length}},xh=class extends Bh{includesStaff(e){return e.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===e.modelStaff.track.playbackInfo.program}},Ph=class{constructor(e){this._allStaves=[],this._firstStaffInBrackets=null,this._lastStaffInBrackets=null,this._accoladeSpacingCalculated=!1,this._brackets=[],this._hasSystemSeparator=!1,this.x=0,this.y=0,this.index=0,this.accoladeWidth=0,this.isFull=!1,this.width=0,this.computedWidth=0,this.totalBarDisplayScale=0,this.isLast=!1,this.masterBarsRenderers=[],this.staves=[],this.layout=e,this.topPadding=e.renderer.settings.display.systemPaddingTop,this.bottomPadding=e.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(e,s){if(0===e.length)return null;this.masterBarsRenderers.push(s);let i=s.layoutingInfo.preBeatSize=0;for(let e=0,t=this.staves.length;e<t;e++){var a=this.staves[e];for(let e=0,t=a.staves.length;e<t;e++){var r=a.staves[e],n=s.renderers[i++];r.addBarRenderer(n)}}return this._calculateAccoladeSpacing(e),this._updateWidthFromLastBar(),s}addBars(e,i,a){var r=new wh,n=(r.additionalMultiBarRestIndexes=a,r.layoutingInfo=new kh,r.masterBar=e[0].score.masterBars[i],this.masterBarsRenderers.push(r),r.layoutingInfo);for(let s of this.staves)for(let t of s.staves){var o=s.track.staves[t.modelStaff.index].bars[i],h=null==a?null:a.map(e=>s.track.staves[t.modelStaff.index].bars[e]),o=(t.addBar(o,n,h),t.barRenderers[t.barRenderers.length-1]);r.renderers.push(o),o.isLinkedToPrevious&&(r.isLinkedToPrevious=!0),o.canWrap||(r.canWrap=!1)}return this._calculateAccoladeSpacing(e),n.finish(),r.width=this._updateWidthFromLastBar(),r}revertLastBar(){if(1<this.masterBarsRenderers.length){var e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let s=0,i=0;for(let e=0,t=this._allStaves.length;e<t;e++){var a=this._allStaves[e].revertLastBar(),r=a.computedWidth,r=(r>s&&(s=r),a.barDisplayScale);r>i&&(i=r)}return this.width-=s,this.computedWidth-=s,this.totalBarDisplayScale-=i,e}return null}_updateWidthFromLastBar(){let s=0,i=0;for(let e=0,t=this._allStaves.length;e<t;e++){var a=this._allStaves[e],a=a.barRenderers[a.barRenderers.length-1],a=(a.applyLayoutingInfo(),a.computedWidth>s&&(s=a.computedWidth),a.barDisplayScale);a>i&&(i=a)}return this.width+=s,this.computedWidth+=s,this.totalBarDisplayScale+=i,s}_calculateAccoladeSpacing(r){var n=this.layout.renderer.settings;if(!this._accoladeSpacingCalculated){this._accoladeSpacingCalculated=!0,this.accoladeWidth=0;var s,i,o=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(9)){let e=1===this.layout.renderer.tracks.length?o.singleTrackTrackNamePolicy:o.multiTrackTrackNamePolicy,t=0===this.index?o.firstSystemTrackNameMode:o.otherSystemsTrackNameMode,s=0===this.index?o.firstSystemTrackNameOrientation:o.otherSystemsTrackNameOrientation,i=!1;switch(e){case 0:break;case 1:i=0===this.index;break;case 2:i=!0}let a=!1;if(i){var h,l=this.layout.renderer.canvas,o=n.display.resources.effectFont;l.font=o;for(h of r){let e="";switch(t){case 0:e=h.name;break;case 1:e=h.shortName}if(0<e.length){a=!0;var d=l.measureText(e);switch(s){case 0:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,d.width));break;case 1:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,d.height))}}}a&&(this.accoladeWidth+=n.display.systemLabelPaddingLeft,this.accoladeWidth+=n.display.systemLabelPaddingRight)}}let e=0;for(s of this._allStaves)s.y=e,s.calculateHeightForAccolade(),e+=s.height;let t=0;for(i of this._brackets)i.finalizeBracket(n.display.resources.engravingSettings),t=Math.max(t,i.width);this.accoladeWidth+=t,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}_getStaffTrackGroup(s){for(let e=0,t=this.staves.length;e<t;e++){var i=this.staves[e];if(i.track===s)return i}return null}addStaff(t,s){let i=this._getStaffTrackGroup(t);if(i||(i=new Th(this,t),this.staves.push(i)),s.staffTrackGroup=i,s.system=this,s.index=this._allStaves.length,this._allStaves.push(s),i.addStaff(s),s.isInsideBracket){this._firstStaffInBrackets||((this._firstStaffInBrackets=s).isFirstInSystem=!0),i.firstStaffInBracket||(i.firstStaffInBracket=s),this._lastStaffInBrackets=s,i.lastStaffInBracket=s;let e=this._brackets.find(e=>e.includesStaff(s));if(!e)switch(t.score.stylesheet.bracketExtendMode){case 0:break;case 1:(e=new Bh(t)).index=this._brackets.length,this._brackets.push(e);break;case 2:(e=new xh(t)).index=this._brackets.length,this._brackets.push(e)}e&&(e.firstStaffInBracket||(e.firstStaffInBracket=s),e.lastStaffInBracket=s,i.bracket=e)}}get height(){return 0===this._allStaves.length?0:Math.ceil(this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height+this.topPadding+this.bottomPadding)}scaleToWidth(s){for(let e=0,t=this._allStaves.length;e<t;e++)this._allStaves[e].scaleToWidth(s);this.width=s}paint(e,t,s){if(this.paintPartial(e+this.x,t+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this._hasSystemSeparator){var i=[];try{z(i,I.track(s,2,this._allStaves[0].modelStaff.track));var a=this.layout.renderer.settings.display.resources.engravingSettings,r=Math.min(0,a.glyphBottom.get(57351)??0);Ue.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+this.height+r,1,57351,!1),Ue.fillMusicFontSymbolSafe(s,e+this.x+this.width-a.glyphWidths.get(57351),t+this.y+this.height+r,1,57351,!1)}catch(e){var n=e,o=!0}finally{U(i,n,o)}}}paintPartial(r,n,o,s,i){for(let e=0,t=this._allStaves.length;e<t;e++)this._allStaves[e].paint(r,n,o,s,i);var t=this.layout.renderer.settings.display.resources;if(0<this.staves.length&&0===s){o.color=t.barSeparatorColor;var e,a,h,l,d,c,u,p=this.layout.renderer.settings,m=this.layout.renderer.settings.notation.isNotationElementVisible(9);if(o.font=t.effectFont,m){let e=this.layout.renderer.score.stylesheet,t=1===this.layout.renderer.tracks.length?e.singleTrackTrackNamePolicy:e.multiTrackTrackNamePolicy,s=0===this.index?e.firstSystemTrackNameMode:e.otherSystemsTrackNameMode,i=0===this.index?e.firstSystemTrackNameOrientation:e.otherSystemsTrackNameOrientation,a=!1;switch(t){case 0:break;case 1:a=0===this.index;break;case 2:a=!0}if(a){var g,m=o.textBaseline,f=o.textAlign;for(g of this.staves)if(g.firstStaffInBracket&&g.lastStaffInBracket){var b=[];try{var y=n+g.firstStaffInBracket.contentTop,_=n+g.lastStaffInBracket.contentBottom;let e="";switch(s){case 0:e=g.track.name;break;case 1:e=g.track.shortName}z(b,I.track(o,0,g.track));if(0<e.length){var S=r+g.firstStaffInBracket.x-p.display.accoladeBarPaddingRight-(g.bracket?.width??0)-p.display.systemLabelPaddingRight;switch(i){case 0:o.textBaseline=1,o.textAlign=2,o.fillText(e,S,(y+_)/2);break;case 1:o.textBaseline=2,o.textAlign=1,o.beginRotate(S,(y+_)/2,-90.1),o.fillText(e,0,0),o.endRotate()}}}catch(e){var v=e,k=!0}finally{U(b,v,k)}}o.textBaseline=m,o.textAlign=f}}if(0<this._allStaves.length){let e=null;for(var w of this._allStaves)if(w.isInsideBracket){if(null!==e){var T=[];try{var B=e.contentBottom,x=w.contentTop,P=r+e.x,N=e.barRenderers[0],M=(z(T,I.bar(o,N.staffLineBarSubElement,N.bar)),Math.ceil(x-B));o.fillRect(P,n+B,t.engravingSettings.thinBarlineThickness,M)}catch(e){var E=e,L=!0}finally{U(T,E,L)}}e=w}}for(e of this._brackets)e.firstStaffInBracket&&e.lastStaffInBracket&&(a=r+e.firstStaffInBracket.x,h=e.width,l=p.display.accoladeBarPaddingRight,d=n+e.firstStaffInBracket.contentTop,c=n+e.lastStaffInBracket.contentBottom,e.drawAsBrace?Ue.fillMusicFontSymbolSafe(o,a-l-h,c,e.braceScale,57344):e.firstStaffInBracket!==e.lastStaffInBracket&&(d-=u=h/2,c+=2*u,o.fillRect(a-l-h,d,h,Math.ceil(c-d)),Ue.fillMusicFontSymbolSafe(o,u=a-l-h,d,1,57347),Ue.fillMusicFontSymbolSafe(o,u,Math.floor(c),1,57348)))}}finalizeSystem(){var e,t,s,i=this.layout.renderer.settings;0===this.index&&(this.topPadding=i.display.firstSystemPaddingTop),this.isLast?this.bottomPadding=i.display.lastSystemPaddingBottom:this.layout.renderer.score.stylesheet.useSystemSignSeparator&&1<this.layout.renderer.tracks.length&&(e=i.display.resources.engravingSettings.glyphHeights.get(57351),this.bottomPadding=Math.max(this.bottomPadding,e),this._hasSystemSeparator=!0);let a=0;for(t of this._allStaves)t.x=this.accoladeWidth,t.y=a,t.finalizeStaff(),a+=t.height;for(s of this._brackets)s.finalizeBracket(i.display.resources.engravingSettings)}buildBoundingsLookup(e,t){if(!this.layout.renderer.boundsLookup.isFinished){var s=this._firstStaffInBrackets,i=this._lastStaffInBrackets;if(s&&i){t+=this.topPadding;var a=this._allStaves[this._allStaves.length-1],r=t+this.y+s.y,i=t+this.y+i.y+i.height,n=t+this.y+this._allStaves[0].y,o=t+this.y+a.y+a.height,h=t+this.y+s.y+s.topSpacing+s.topOverflow+(0<s.barRenderers.length?s.barRenderers[0].topPadding:0),l=i-r,d=t+this.y+a.y+a.height-a.bottomSpacing-a.bottomOverflow-(0<a.barRenderers.length?a.barRenderers[0].bottomPadding:0)-h,c=o-n,u=this.x+s.x,i=new cs,p=(i.visualBounds=new hs,i.visualBounds.x=e+this.x,i.visualBounds.y=t+this.y,i.visualBounds.w=this.width,i.visualBounds.h=this.height-this.topPadding-this.bottomPadding,i.realBounds=new hs,i.realBounds.x=e+this.x,i.realBounds.y=t+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(i),new Map);for(let e=0;e<this.staves.length;e++)for(var m of this.staves[e].stavesRelevantForBoundsLookup)for(var g of m.barRenderers){let e;p.has(g.bar.masterBar.index)?e=p.get(g.bar.masterBar.index):((e=new ls).index=g.bar.masterBar.index,e.isFirstOfLine=g.isFirstOfLine,e.realBounds=new hs,e.realBounds.x=u+g.x,e.realBounds.y=n,e.realBounds.w=g.width,e.realBounds.h=c,e.visualBounds=new hs,e.visualBounds.x=u+g.x,e.visualBounds.y=r,e.visualBounds.w=g.width,e.visualBounds.h=l,e.lineAlignedBounds=new hs,e.lineAlignedBounds.x=u+g.x,e.lineAlignedBounds.y=h,e.lineAlignedBounds.w=g.width,e.lineAlignedBounds.h=d,this.layout.renderer.boundsLookup.addMasterBar(e),p.set(e.index,e)),g.buildBoundingsLookup(e,u,t+this.y+m.y)}}}}getBarX(e){return this._firstStaffInBrackets&&0!==this.layout.renderer.tracks.length?(e=this.layout.renderer.tracks[0].staves[0].bars[e],this.layout.getRendererForBar(this._firstStaffInBrackets.staffId,e).x):0}},Nh=class extends jt{constructor(e,t){super(e,t,0)}},Mh=class extends ah{constructor(e,t,s,i){super(e,t),this._tuning=s,this._trackLabel=i,this.glyphs=[]}doLayout(){if(!(0<this.glyphs.length)){this._createGlyphs(this._tuning);for(var e of this.glyphs)e.renderer=this.renderer,e.doLayout()}}paint(e,t,s){var i=s.color;this.colorOverride&&(s.color=this.colorOverride),super.paint(e,t,s),s.color=i}_createGlyphs(n){var e,o=this.renderer.resources,h=((this.height=0)<this._trackLabel.length&&((e=new yh(0,this.height,this._trackLabel,o.effectFont,0)).renderer=this.renderer,e.doLayout(),this.height+=e.height,this.addGlyph(e)),0<n.name.length&&((e=new yh(0,this.height,n.name,o.effectFont,0)).renderer=this.renderer,e.doLayout(),this.height+=e.height,this.addGlyph(e)),this.renderer.smuflMetrics.tuningGlyphCircleNumberScale),l=this.renderer.smuflMetrics.glyphHeights.get(59443)*h,d=(this.renderer.scoreRenderer.canvas.font=o.effectFont,(l+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*o.engravingSettings.tuningGlyphStringColumnScale);if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(n.name).width,2*d)),!n.isStandard){let s=0|Math.ceil(n.tunings.length/2),i=0,a=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding,r=a;for(let e=0,t=n.tunings.length;e<t;e++){var c=59443+(e+1),c=(this.addGlyph(new _o(i,r+l,h,c))," = "+qt.getTextForTuning(n.tunings[e],!1)),c=(this.addGlyph(new yh(i+l,r+l/2,c,o.effectFont,0,1)),r+=l+this.renderer.smuflMetrics.tuningGlyphStringRowPadding);this.height<c&&(this.height=c),e===s-1&&(r=a,i+=d)}}}},Eh=class{constructor(e,t){this.args=e,this.renderCallback=t}},Lh=class Lh{constructor(e){this._barRendererLookup=new Map,this.pagePadding=null,this.width=0,this.height=0,this.multiBarRestInfo=null,this.headerGlyphs=new Map,this.footerGlyphs=new Map,this.chordDiagrams=null,this.tuningGlyph=null,this.systemsLayoutMode=0,this._lazyPartials=new Map,this.firstBarIndex=0,this.lastBarIndex=0,this.renderer=e}get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}resize(){this._lazyPartials.clear(),this.doResize()}layoutAndRender(){this._lazyPartials.clear();var e=this.renderer.score;this.firstBarIndex=F.computeFirstDisplayedBarIndex(e,this.renderer.settings),this.lastBarIndex=F.computeLastDisplayedBarIndex(e,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=F.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(e=>e/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this._createScoreInfoGlyphs(),this.doLayoutAndRender()}registerPartial(e,t){var s;0!==e.height&&(s=this.renderer.settings.display.scale,e.x*=s,e.y*=s,e.width*=s,e.height*=s,e.totalWidth*=s,e.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this._lazyPartials.set(e.id,new Eh(e,t)),this.renderer.partialLayoutFinished.trigger(e)):(this.renderer.partialLayoutFinished.trigger(e),this._internalRenderLazyPartial(e,t)))}_internalRenderLazyPartial(e,t){var s=this.renderer.canvas;s.beginRender(e.width,e.height),t(s),e.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(e)}renderLazyPartial(e){this._lazyPartials.has(e)&&(e=this._lazyPartials.get(e),this._internalRenderLazyPartial(e.args,e.renderCallback))}_createHeaderFooterGlyph(e,t,s,i){switch(s){case 6:if(t.words!==t.music)return;break;case 4:case 5:if(t.words===t.music)return;break;case 9:if(this.footerGlyphs.has(8))break;return}let a=e.display.resources,r=e.notation,n=(t.style&&t.style.headerAndFooter.has(s)?t.style.headerAndFooter:Je.defaultHeaderAndFooter).get(s),o=void 0===n.isVisible||n.isVisible;return(o=void 0!==i?r.isNotationElementVisible(i):o)&&(e=n.buildText(t))?new yh(0,0,e,a.getFontForElement(s),n.textAlign,void 0,I.scoreColor(a,s,t)):void 0}_createScoreInfoGlyphs(){M.debug("ScoreLayout","Creating score info glyphs");var e,t,s,i,a=this.renderer.settings,r=this.renderer.score,n=(this.headerGlyphs=new Map,this.footerGlyphs=new Map,new Vh(this.renderer,this.renderer.tracks[0].staves[0].bars[0]));for([e,t]of Lh.headerElements.value){var o=this._createHeaderFooterGlyph(a,r,e,t);o&&(o.renderer=n,o.doLayout(),this.headerGlyphs.set(e,o))}for([s,i]of Lh.footerElements.value){var h=this._createHeaderFooterGlyph(a,r,s,i);h&&(h.renderer=n,h.doLayout(),this.footerGlyphs.set(s,h))}var l=a.notation,d=a.display.resources;if(l.isNotationElementVisible(8)){var c,u,p=[];for(c of this.renderer.tracks)for(var m of c.staves){let e=!m.isPercussion&&m.isStringed&&0<m.tuning.length&&m.showTablature;if(e=r.stylesheet.perTrackDisplayTuning&&r.stylesheet.perTrackDisplayTuning.has(c.index)&&!1===r.stylesheet.perTrackDisplayTuning.get(c.index)?!1:e){p.push(m);break}}if(0<p.length&&r.stylesheet.globalDisplayTuning){this.tuningGlyph=new Nh(0,0),this.tuningGlyph.renderer=n;for(var g of p)0<g.stringTuning.tunings.length&&(u=1<p.length?g.track.name:"",(u=new Mh(0,0,g.stringTuning,u)).colorOverride=I.trackColor(d,3,g.track),u.renderer=n,u.doLayout(),this.tuningGlyph.addGlyph(u))}else this.tuningGlyph=null}if(l.isNotationElementVisible(10)){this.chordDiagrams=new bh(0,0),this.chordDiagrams.renderer=n;var f,b=new Set;for(f of this.renderer.tracks)if(r.stylesheet.globalDisplayChordDiagramsOnTop&&(null==r.stylesheet.perTrackChordDiagramsOnTop||!r.stylesheet.perTrackChordDiagramsOnTop.has(f.index)||r.stylesheet.perTrackChordDiagramsOnTop.get(f.index)))for(var y of f.staves){y=y.chords;if(y)for(var[,_]of y)b.has(_.uniqueId)||_.showDiagram&&(b.add(_.uniqueId),this.chordDiagrams.addChord(_))}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}createEmptyStaffSystem(){var s=new Ph(this);for(let t=0;t<this.renderer.tracks.length;t++){var i=this.renderer.tracks[t];for(let e=0;e<i.staves.length;e++){var a,r=i.staves[e];for(a of E.staveProfiles.get(this.renderer.settings.display.staveProfile))a.canCreate(i,r)&&s.addStaff(i,new _h(t,r,a))}}return s}registerBarRenderer(e,t){if(this._barRendererLookup.has(e)||this._barRendererLookup.set(e,new Map),this._barRendererLookup.get(e).set(t.bar.id,t),t.additionalMultiRestBars)for(var s of t.additionalMultiRestBars)this._barRendererLookup.get(e).set(s.id,t)}unregisterBarRenderer(e,t){if(this._barRendererLookup.has(e)){var s=this._barRendererLookup.get(e);if(s.delete(t.bar.id),t.additionalMultiRestBars)for(var i of t.additionalMultiRestBars)s.delete(i.id)}}getRendererForBar(e,t){t=t.id;return this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).has(t)?this._barRendererLookup.get(e).get(t):null}layoutAndRenderBottomScoreInfo(e){e=Math.round(e);var t,s,i,a=new is;a.x=0,a.y=e;let r=0,n=this.renderer.settings.display.resources,o=[],h=0;for([t,s]of Lh.footerElements.value)this.footerGlyphs.has(t)&&((i=this.footerGlyphs.get(t)).y=r,this.alignScoreInfoGlyph(i),r+=i.height,o.push(i),h=Math.max(h,Math.round(i.x+i.width)));return r=Math.round(r),0<o.length&&(a.width=h,a.height=r,a.totalWidth=this.scaledWidth,a.totalHeight=e+a.height,this.registerPartial(a,e=>{e.color=n.scoreInfoColor,e.textAlign=0,e.textBaseline=0;for(var t of o)t.paint(0,0,e)})),e+r}alignScoreInfoGlyph(e){if(E.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(e.textAlign){case 0:e.x=this.pagePadding[0];break;case 1:e.x=this.scaledWidth/2;break;case 2:e.x=this.scaledWidth-this.pagePadding[2]}else e.x=this.firstBarX,e.textAlign=0}layoutAndRenderAnnotation(e){let t=this.renderer.settings.display.resources,s=A.withFamilyList(t.copyrightFont.families,12,0,1),i=new Vh(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),a=new yh(0,0,"-Chris-",s,1,void 0,t.mainGlyphColor);a.renderer=i,a.doLayout(),this.alignScoreInfoGlyph(a);var r=new is;return r.width=a.x+a.width,r.x=0,r.height=12,r.y=e,r.totalWidth=this.scaledWidth,r.totalHeight=e+12,r.firstMasterBarIndex=-1,r.lastMasterBarIndex=-1,this.registerPartial(r,e=>{e.color=t.mainGlyphColor,e.font=s,e.textAlign=0,e.textBaseline=0,a.paint(0,0,e)}),e+12}},Ch=(Lh.headerElements=new be(()=>new Map([[0,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,void 0]])),Lh.footerElements=new be(()=>new Map([[8,7],[9,void 0]])),Lh),Fh=class extends ah{constructor(){super(0,0),this._effectGlyphs=[],this._normalGlyphs=[],this.computedWidth=0}doLayout(){let s=0;if(this.glyphs)for(let e=0,t=this.glyphs.length;e<t;e++){var i=this.glyphs[e];i.x=s,i.renderer=this.renderer,i.doLayout(),s+=i.width}this.width=s,this.computedWidth=s}noteLoop(t){for(let e=this.container.beat.notes.length-1;0<=e;e--)t(this.container.beat.notes[e])}addEffect(e){super.addGlyph(e),this._effectGlyphs.push(e)}addNormal(e){super.addGlyph(e),this._normalGlyphs.push(e)}get effectElement(){}paint(e,t,s){this._paintEffects(e,t,s),this._paintNormal(e,t,s)}_paintNormal(e,t,s){for(var i of this._normalGlyphs)i.paint(e+this.x,t+this.y,s)}_paintEffects(e,t,s){var i=[];try{var a;z(i,this.effectElement?I.beat(s,this.effectElement,this.container.beat):void 0);for(a of this._effectGlyphs)a.paint(e+this.x,t+this.y,s)}catch(e){var r=e,n=!0}finally{U(i,r,n)}}},Dh=class extends Fh{constructor(){super(...arguments),this.centerX=0}updateBeamingHelper(){}buildBoundingsLookup(e,t,s){}getNoteX(e,t){return 0}getNoteY(e,t){return 0}getHighestNoteY(){return 0}getLowestNoteY(){return 0}},Ih=class Gp extends zt{constructor(e,t,s,i,a=1){super(e,t),this._scale=0,this._symbols=[],this._symbols=Gp.getSymbols(s),this._scale=a,this._baseline=i}static getSymbols(e){for(var t=[];0<e;){var s=e%10;t.unshift(Gp.getSymbol(s)),e=e/10|0}return t}static getSymbol(e){switch(e){case 0:return 57472;case 1:return 57473;case 2:return 57474;case 3:return 57475;case 4:return 57476;case 5:return 57477;case 6:return 57478;case 7:return 57479;case 8:return 57480;case 9:return 57481;default:return-1}}doLayout(){let e=0;for(var t of this._symbols)e+=this.renderer.smuflMetrics.glyphWidths.get(t);this.width=e}paint(e,t,s){switch(this._baseline){case 0:t+=this.renderer.smuflMetrics.glyphBottom.get(this._symbols[0]);break;case 2:t+=this.renderer.smuflMetrics.glyphTop.get(this._symbols[0])}s.fillMusicFontSymbols(e+this.x,t+this.y,this._scale,this._symbols)}},Ah=class Ah extends zt{constructor(){super(0,0),this._numberGlyph=[]}doLayout(){this.width=Ah._restSymbols.reduce((e,t)=>e+this.renderer.smuflMetrics.glyphWidths.get(t),0),this.renderer.registerOverflowTop(this.renderer.getLineHeight(1));var e=this.renderer.additionalMultiRestBars.length+1;this._numberGlyph=Ih.getSymbols(e)}paint(e,t,s){s.fillMusicFontSymbols(e+this.x,t+this.y+this.renderer.height/2,1,Ah._restSymbols);var i=this.renderer.getLineY(-1.5);s.fillMusicFontSymbols(e+this.x+this.width/2,t+this.y+i|0,1,this._numberGlyph,!0)}},Rh=(Ah._restSymbols=[58607,58608,58608,58608,58609],Ah),Oh=class zp extends To{constructor(e){super(zp._getOrCreatePlaceholderBeat(e),e),this.preNotes=new Fh,this.onNotes=new Dh}doLayout(){this.renderer.showMultiBarRest&&this.onNotes.addNormal(new Rh),super.doLayout()}static _getOrCreatePlaceholderBeat(e){var t;return 1<e.voice.beats.length?e.voice.beats[0]:((t=new wt).voice=e.voice,t)}},Vh=class{constructor(e,t){this._preBeatGlyphs=new rh,this._voiceContainers=new Map,this._postBeatGlyphs=new rh,this._ties=[],this.additionalMultiRestBars=null,this.x=0,this.y=0,this.width=0,this.computedWidth=0,this.height=0,this.index=0,this.topOverflow=0,this.bottomOverflow=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.wasFirstOfLine=!1,this._appliedLayoutingInfo=0,this.isFinalized=!1,this.topPadding=0,this.bottomPadding=0,this.scoreRenderer=e,(this.bar=t)&&(this.helpers=new mh(this))}get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}get showMultiBarRest(){return!1}registerTies(e){this._ties.push(...e)}get middleYPosition(){return 0}registerOverflowTop(e){return(e=Math.ceil(e))>this.topOverflow&&(this.topOverflow=e,!0)}registerOverflowBottom(e){return(e=Math.ceil(e))>this.bottomOverflow&&(this.bottomOverflow=e,!0)}scaleToWidth(e){var t,s=e-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(t of this._voiceContainers.values())t.scaleToWidth(s);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+s,this.width=e}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}get barDisplayScale(){return(1<this.staff.system.staves.length?this.bar.masterBar:this.bar).displayScale}get barDisplayWidth(){return(1<this.staff.system.staves.length?this.bar.masterBar:this.bar).displayWidth}get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){var e,t=this.layoutingInfo,s=this._preBeatGlyphs.width;t.preBeatSize<s&&(t.preBeatSize=s);let i=0;for(e of this._voiceContainers.values()){e.registerLayoutingInfo(t);var a=e.x+e.width;i<a&&(i=a)}s=this._postBeatGlyphs.width;t.postBeatSize<s&&(t.postBeatSize=s)}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let e=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(var t of this._voiceContainers.values()){t.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,t.applyLayoutingInfo(this.layoutingInfo);t=t.x+t.width;e<t&&(e=t)}this._postBeatGlyphs.x=Math.floor(e),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.computedWidth=this.width;var s=this.barDisplayWidth;return 0<s&&2===this.scoreRenderer.layout.systemsLayoutMode&&(this.width=s,this.computedWidth=s),!0}finalizeRenderer(){let e=!(this.isFinalized=!0),t=this.y-this.staff.topSpacing,s=this.y+this.height+this.staff.bottomSpacing;for(var i of this._ties){var a;i.doLayout(),0<i.height&&(0<(a=i.y+i.height-s)&&this.registerOverflowBottom(a)&&(e=!0),(a=i.y-t)<0)&&this.registerOverflowTop(-1*a)&&(e=!0)}return e}doLayout(){if(this.bar){this.helpers.initialize(),this._ties=[],this._preBeatGlyphs=new rh,(this._preBeatGlyphs.renderer=this)._voiceContainers.clear(),this._postBeatGlyphs=new rh,this._postBeatGlyphs.renderer=this;for(let e=0;e<this.bar.voices.length;e++){var t=this.bar.voices[e];this.hasVoiceContainer(t)&&((t=new oh(0,0,t)).renderer=this)._voiceContainers.set(this.bar.voices[e].index,t)}var e;3===this.bar.simileMark&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.additionalMultiRestBars?(a=new Oh(this.getVoiceContainer(this.bar.voices[0])),this.addBeatGlyph(a)):this.createBeatGlyphs(),this.createPostBeatGlyphs(),this.updateSizes();for(e of this.helpers.beamHelpers)for(var s of e)s.finish();this.computedWidth=this.width;var i=this.height,a=this._preBeatGlyphs.glyphs;if(a)for(var r of a){var n=r.getBoundingBoxTop(),n=(n<0&&this.registerOverflowTop(-1*n),n+r.height);i<n&&this.registerOverflowBottom(n-i)}a=this._postBeatGlyphs.glyphs;if(a)for(var o of a){var h=o.getBoundingBoxTop(),h=(h<0&&this.registerOverflowTop(-1*h),h+o.height);i<h&&this.registerOverflowBottom(h-i)}}}hasVoiceContainer(e){return!(!this.additionalMultiRestBars&&0!==e.index&&e.isEmpty)}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);let e=this._voiceContainers,t=this.beatGlyphsStart,s=t;for(var i of e.values()){i.x=t,i.doLayout();i=i.x+i.width;s<i&&(s=i)}this._postBeatGlyphs.x=Math.floor(s),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height)}addPreBeatGlyph(e){(e.renderer=this)._preBeatGlyphs.addGlyph(e)}addBeatGlyph(e){e.renderer=this,e.preNotes.renderer=this,e.onNotes.renderer=this,e.onNotes.beamingHelper=this.helpers.beamHelperLookup[e.beat.voice.index].get(e.beat.index),this.getVoiceContainer(e.beat.voice).addGlyph(e)}getVoiceContainer(e){return this._voiceContainers.has(e.index)?this._voiceContainers.get(e.index):void 0}getBeatContainer(e){return this.getVoiceContainer(e.voice)?.beatGlyphs?.[e.index]}getPreNotesGlyphForBeat(e){return this.getBeatContainer(e)?.preNotes}getOnNotesGlyphForBeat(e){return this.getBeatContainer(e)?.onNotes}paint(e,t,s){this.paintBackground(e,t,s),s.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(e+this.x,t+this.y,s);for(var i of this._voiceContainers.values())i.paint(e+this.x,t+this.y,s);s.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(e+this.x,t+this.y,s)}paintBackground(e,t,s){this.layoutingInfo.paint(e+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,t+this.y+this.height,s)}buildBoundingsLookup(e,s,i){var t,a,r=new ns;r.bar=this.bar,r.visualBounds=new hs,r.visualBounds.x=s+this.x,r.visualBounds.y=i+this.y+this.topPadding,r.visualBounds.w=this.width,r.visualBounds.h=this.height-this.topPadding-this.bottomPadding,r.realBounds=new hs,r.realBounds.x=s+this.x,r.realBounds.y=i+this.y,r.realBounds.w=this.width,r.realBounds.h=this.height,e.addBar(r);for([t,a]of this._voiceContainers){var n=this.bar.isEmpty&&0===t;if(!a.voice.isEmpty||n)for(let e=0,t=a.beatGlyphs.length;e<t;e++)a.beatGlyphs[e].buildBoundingsLookup(r,s+this.x+a.x,i+this.y+a.y,n)}}addPostBeatGlyph(e){this._postBeatGlyphs.addGlyph(e)}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(var e of this.bar.voices)this.hasVoiceContainer(e)&&this.createVoiceGlyphs(e)}createVoiceGlyphs(e){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(e,t=0){var s=this.getBeatContainer(e);if(s)switch(t){case 0:return s.voiceContainer.x+s.x;case 1:return s.voiceContainer.x+s.x+s.onNotes.x;case 2:return s.voiceContainer.x+s.x+s.onTimeX;case 3:var i=s.onNotes.beamingHelper?s.onNotes.beamingHelper.getBeatLineX(e):s.onNotes.x+s.onNotes.width/2;return s.voiceContainer.x+i;case 4:return s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.width;case 5:return s.voiceContainer.x+s.x+s.width}return 0}getRatioPositionX(e){var t=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],1);return t+(this.postBeatGlyphsStart-t)*e}getNoteX(e,t){var s=this.getBeatContainer(e.beat);return s?s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.getNoteX(e,t):0}getNoteY(e,t){var s=this.getOnNotesGlyphForBeat(e.beat);return s?s.getNoteY(e,t):Number.NaN}reLayout(){(this.wasFirstOfLine&&!this.isFirstOfLine||!this.wasFirstOfLine&&this.isFirstOfLine)&&this.recreatePreBeatGlyphs(),this.updateSizes(),this.registerLayoutingInfo()}recreatePreBeatGlyphs(){this._preBeatGlyphs=new rh,(this._preBeatGlyphs.renderer=this).createPreBeatGlyphs()}paintSimileMark(e,t,s){var i=[];try{z(i,I.voice(s,0,this.bar.voices[0],!0));switch(this.bar.simileMark){case 1:s.beginGroup(To.getGroupId(this.bar.voices[0].beats[0])),Ue.fillMusicFontSymbolSafe(s,e+this.x+this.width/2,t+this.y+this.height/2,1,58624,!0),s.endGroup();break;case 3:s.beginGroup(To.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(To.getGroupId(this.bar.previousBar.voices[0].beats[0])),Ue.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+this.height/2,1,58625,!0),s.endGroup(),s.endGroup()}}catch(e){var a=e,r=!0}finally{U(i,a,r)}}completeBeamingHelper(e){}getBeatDirection(e){return this.helpers.getBeamingHelperForBeat(e).direction}},Wh=class extends zt{constructor(e,t){super(0,0),this._uniqueEffectGlyphs=[],this._effectGlyphs=[],this.isEmpty=!0,this.previousBand=null,this.isLinkedToPrevious=!1,this.firstBeat=null,this.lastBeat=null,this.height=0,this.originalHeight=0,this.slot=null,this.voice=e,this.info=t}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(e){if(e.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,e)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,this.firstBeat&&!e.isBefore(this.firstBeat)||(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case 2:case 4:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}e=this._createOrResizeGlyph(this.info.sizingMode,e);e.height>this.height&&(this.height=e.height,this.originalHeight=e.height)}}resetHeight(){this.height=this.originalHeight}_createOrResizeGlyph(e,t){let s;switch(e){case 5:return(s=this.info.createNewGlyph(this.renderer,t)).renderer=this.renderer,s.beat=t,s.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,s),this._uniqueEffectGlyphs[t.voice.index].push(s),s;case 0:case 1:case 2:return(s=this.info.createNewGlyph(this.renderer,t)).renderer=this.renderer,s.beat=t,s.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,s),this._uniqueEffectGlyphs[t.voice.index].push(s),s;case 3:case 4:var i=3===e?1:2;if(0<t.index||0<this.renderer.index){var a=t.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,a)){let e=null;0<t.index&&this._effectGlyphs[t.voice.index].has(a.index)?e=this._effectGlyphs[t.voice.index].get(a.index):0<this.renderer.index&&(r=this.renderer.previousRenderer.getBand(a.voice,this.info.effectId))&&(r=r._effectGlyphs[a.voice.index]).has(a.index)&&(e=r.get(a.index));var r=this._createOrResizeGlyph(i,t);return e&&this.info.canExpand(a,t)&&((e.nextGlyph=r).previousGlyph=e,this.isLinkedToPrevious=!0),r}}return this._createOrResizeGlyph(i,t);default:return this._createOrResizeGlyph(1,t)}}paint(s,i,a){super.paint(s,i,a);for(let e=0,t=this._uniqueEffectGlyphs.length;e<t;e++){var r=this._uniqueEffectGlyphs[e];for(let e=0,t=r.length;e<t;e++){var n=[];try{var o=r[e];z(n,I.beat(a,0,o.beat,!1));o.paint(s+this.x,i+this.y,a)}catch(e){var h=e,l=!0}finally{U(n,h,l)}}}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(var t of this._effectGlyphs[e].keys())this._alignGlyph(this.info.sizingMode,this.renderer.bar.voices[e].beats[t])}_alignGlyph(e,t){var s=this._effectGlyphs[t.voice.index].get(t.index),i=this.renderer.getBeatContainer(t);switch(e){case 0:var a=this.renderer.layoutingInfo.getPreBeatSize(t);s.x=this.renderer.beatGlyphsStart+i.x-a;break;case 1:case 3:s.x=this.renderer.beatGlyphsStart+i.x;break;case 2:case 4:s.x=this.renderer.beatGlyphsStart+i.x,i.beat.isLastOfVoice?s.width=this.renderer.width-s.x:(a=this.renderer.layoutingInfo.getPostBeatSize(t),s.width=a);break;case 5:s.width=this.renderer.width}}},Hh=class{constructor(){this.uniqueEffectId=null,this.y=0,this.height=0,this.firstBeat=null,this.lastBeat=null}},Gh=class{constructor(){this.bands=[],this.shared=new Hh}update(e){e.info.canShareBand||(this.shared.uniqueEffectId=e.info.effectId),(e.slot=this).bands.push(e),e.height>this.shared.height&&(this.shared.height=e.height),this.shared.firstBeat&&!e.firstBeat.isBefore(this.shared.firstBeat)||(this.shared.firstBeat=e.firstBeat),this.shared.lastBeat&&!e.lastBeat.isAfter(this.shared.lastBeat)||(this.shared.lastBeat=e.lastBeat)}canBeUsed(e){return(!this.shared.uniqueEffectId&&e.info.canShareBand||e.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(e.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}},zh=class{constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(e){if(this._effectSlot.has(e.info.effectId)){var t=this._effectSlot.get(e.info.effectId);if(t.canBeUsed(e))return t}for(var s of this.slots)if(s.canBeUsed(e))return s;t=new Gh;return this.slots.push(t),t}register(e){var t=this.getOrCreateSlot(e);t.update(e),this._effectSlot.set(e.info.effectId,t)}},Uh=class extends Vh{constructor(e,t,s){super(e,t),this._bands=[],this._bandLookup=new Map,this.sizingInfo=null,this._infos=s}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this._updateHeight(),super.updateSizes()}finalizeRenderer(){let e=super.finalizeRenderer();return e=this._updateHeight()?!0:e}_updateHeight(){if(!this.sizingInfo)return!1;let e=0;for(var t of this.sizingInfo.slots){t.shared.y=e;for(var s of t.bands)s.y=e,s.height=t.shared.height;e+=t.shared.height+this.settings.display.effectBandPaddingBottom}return(e=Math.ceil(e))!==this.height&&(this.height=e,!0)}applyLayoutingInfo(){var e,t,s=!super.applyLayoutingInfo();0<this.index?(e=this.previousRenderer,this.sizingInfo=e.sizingInfo):this.sizingInfo=new zh;for(t of this._bands)t.resetHeight(),t.alignGlyphs(),t.isEmpty||this.sizingInfo.register(t);return this._updateHeight(),s}scaleToWidth(e){super.scaleToWidth(e);for(var t of this._bands)t.alignGlyphs()}createBeatGlyphs(){this._bands=[],this._bandLookup=new Map;for(var e of this.bar.voices)if(this.hasVoiceContainer(e))for(var t of this._infos){var s=new Wh(e,t);s.renderer=this,s.doLayout(),this._bands.push(s),this._bandLookup.set(e.index+"."+t.effectId,s)}super.createBeatGlyphs();for(var i of this._bands)i.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(e){for(var t of e.beats){var s,i=new To(t,this.getVoiceContainer(e));i.preNotes=new Fh,i.onNotes=new Dh,this.addBeatGlyph(i);for(s of this._bands)s.createGlyph(t)}}paint(e,t,s){this.paintBackground(e,t,s);for(var i of this._bands)s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isEmpty||i.paint(e+this.x,t+this.y,s)}getBand(e,t){e=e.index+"."+t;return this._bandLookup.has(e)?this._bandLookup.get(e):null}},Yh=class extends m{get staffId(){return this._staffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(e,t,s=null){super(),this.infos=t,this._staffId=e,this.isInsideBracket=!1,this.isRelevantForBoundsLookup=!1,this.shouldShow=s}canCreate(e,t){var s=this.shouldShow;return super.canCreate(e,t)&&(!s||s(e,t))}create(t,e){return new Uh(t,e,this.infos.filter(e=>t.settings.notation.isNotationElementVisible(e.notationElement)))}},Xh=class extends Yt{constructor(e,t,s,i,a,r){super(e,t),this._endingsString="",this._endings=F.getAlternateEndingsList(s),this._openLine=i,this._closeLine=a,this._indent=r}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+2*this.renderer.smuflMetrics.alternateEndingsPadding;let s="";for(let e=0,t=this._endings.length;e<t;e++)s=s+(this._endings[e]+1)+". ";this._endingsString=s}paint(e,t,s){let i=this._closeLine?this.width-s.lineWidth:this.width;var a,r;6===this.renderer.bar.getActualBarLineRight()&&(i-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),e=(0|e)+s.lineWidth/2,t=(0|t)+s.lineWidth/2,this._indent&&(e+=this.renderer.smuflMetrics.alternateEndingsPadding,i-=this.renderer.smuflMetrics.alternateEndingsPadding),this._openLine?(s.moveTo(e+this.x,t+this.y+this.height),s.lineTo(e+this.x,t+this.y)):s.moveTo(e+this.x,t+this.y),s.lineTo(e+this.x+i,t+this.y),this._closeLine&&s.lineTo(e+this.x+i,t+this.y+this.height),s.stroke(),this._openLine&&(a=s.textBaseline,s.textBaseline=0,r=this.renderer.resources,s.font=r.wordsFont,s.fillText(this._endingsString,e+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,t+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),s.textBaseline=a)}},o=class{get effectId(){return this.notationElement.toString()}},Jh=class extends o{get notationElement(){return 14}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return 5}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&0!==t.voice.bar.masterBar.alternateEndings}createNewGlyph(e,t){let s=t.voice.bar.masterBar,i=null===s.previousMasterBar||s.alternateEndings!==s.previousMasterBar.alternateEndings,a=s.isRepeatEnd||null===s.nextMasterBar||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(e=>e.index>=s.index)||(a=!1);t=null!==s.previousMasterBar&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&0<s.previousMasterBar.alternateEndings;return new Xh(0,0,s.alternateEndings,i,a,t)}canExpand(e,t){return!0}},es=class extends Yt{constructor(e){super(),this.forceGroupedRendering=!1,this.endOnBarLine=!1,this.endPosition=e}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(t,s,i){if(!this.isLinkedWithPrevious)if(this.isLinkedWithNext||this.forceGroupedRendering){let e;if(!this.isLinkedWithNext&&this.forceGroupedRendering)e=this;else for(e=this.nextGlyph;e.isLinkedWithNext;)e=e.nextGlyph;var a=e.renderer,r=e.beat,n=this.endPosition,o=t-this.renderer.x,a=this.calculateEndX(a,r,o,n);this.paintGrouped(t,s,a,i)}else this.paintNonGrouped(t,s,i)}calculateEndX(e,t,s,i){return t?s+e.x+e.getBeatX(t,i):s+e.x+this.x+this.width}paintNonGrouped(e,t,s){var i=e-this.renderer.x,i=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(e,t,i,s)}},qh=class extends es{constructor(e,t=!0){super(1),this._labelWidth=0,this._label=e,this._dashed=t}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=5,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.effectFont;var e=this.renderer.scoreRenderer.canvas.measureText(this._label);this.height=e.height,this._labelWidth=e.width}paintNonGrouped(e,t,s){var i=this.renderer.resources,i=(s.font=i.effectFont,s.textBaseline);s.textBaseline=1,s.fillText(this._label,e+this.x-this._labelWidth/2,t+this.y+this.height/2),s.textBaseline=i}paintGrouped(t,e,s,i){this.paintNonGrouped(t,e,i);var a=this.renderer.smuflMetrics.lineRangedGlyphDashGap,r=this.renderer.smuflMetrics.lineRangedGlyphDashSize,n=this.renderer.smuflMetrics.pedalLineThickness,t=t+this.x+this._labelWidth/2+a/2,o=e+this.y+this.height/2-n/2;if(this._dashed){if(t<s){let e=t;for(;e<s;){var h=Math.min(e+r,s);i.fillRect(e,o,h-e,n),e+=r+a}i.fillRect(s,o-r/2+n/2,n,r)}}else i.fillRect(t,o,s-t,n),i.fillRect(s-n,o,n,r/2)}},jh=class jh extends o{get notationElement(){return 23}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isBarre}get sizingMode(){return 3}createNewGlyph(e,t){let s="";switch(t.barreShape){case 0:case 1:break;case 2:s+="1/2"}return s+="B "+jh.toRoman(t.barreFret),new qh(s,!1)}static toRoman(e){let t="";if(0<e)for(var[s,i]of jh._romanLetters){var a=Math.floor(e/i);e-=a*i,t+=s.repeat(a)}return t}canExpand(e,t){return e.barreFret===t.barreFret&&e.barreShape===t.barreShape}},$h=(jh._romanLetters=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]),jh),Kh=class extends Yt{constructor(e){super(0,0),this._text="",this._textWidth=0,this._textHeight=0,this._timer=e}doLayout(){var e=this._timer/6e4|0,t=(this._timer-6e4*e)/1e3|0,e=(this._text=e+":"+t.toString().padStart(2,"0"),this.renderer.scoreRenderer.canvas),t=(e.font=this.renderer.resources.timerFont,e.measureText(this._text));this._textHeight=e.font.size+2*this.renderer.smuflMetrics.beatTimerPadding,this._textWidth=t.width+2*this.renderer.smuflMetrics.beatTimerPadding,this.height=this._textHeight+2*this.renderer.smuflMetrics.beatTimerPadding}paint(e,t,s){var i=this._textWidth/2|0,i=(s.strokeRect(e+this.x-i,t+this.y+this.renderer.smuflMetrics.beatTimerPadding,this._textWidth,this._textHeight),s.font),a=s.textBaseline,r=s.textAlign;s.font=this.renderer.resources.timerFont,s.textBaseline=1,s.textAlign=1,s.fillText(this._text,e+this.x,t+this.y+this.height/2),s.font=i,s.textBaseline=a,s.textAlign=r}},Qh=class extends o{get notationElement(){return 49}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return t.showTimer}createNewGlyph(e,t){return new Kh(t.timer??0)}canExpand(e,t){return!0}},Zh=class extends o{get notationElement(){return 15}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0===t.index&&0===t.voice.bar.index&&0!==t.voice.bar.staff.capo}createNewGlyph(e,t){return new yh(0,0,` ${t.voice.bar.staff.capo}`,e.resources.effectFont,0)}canExpand(e,t){return!1}},el=class extends o{get notationElement(){return 16}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return t.hasChord}createNewGlyph(e,t){return e.settings.notation.showChordDiagramsOnBeats?new gh(0,0,t.chord):new yh(0,0,t.chord.name,e.resources.effectFont,1)}canExpand(e,t){return!1}},tl=class extends es{constructor(e,t,s){super(5),this._crescendo=0,this._crescendo=s,this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58686)}paintGrouped(e,t,s,i){var e=e+this.x,a=this.height,r=this.renderer.smuflMetrics.glyphWidths.get(57508)/2,r=(i.beginPath(),1===this._crescendo?(i.moveTo(s-=r,t+this.y),i.lineTo(e,t+this.y+a/2),i.lineTo(s,t+this.y+a)):(s-=r,i.moveTo(e,t+this.y),i.lineTo(s,t+this.y+a/2),i.lineTo(e,t+this.y+a)),i.lineWidth);i.lineWidth=this.renderer.smuflMetrics.hairpinThickness,i.stroke(),i.lineWidth=r}},sl=class extends o{get notationElement(){return 17}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 4}shouldCreateGlyph(e,t){return 0!==t.crescendo}createNewGlyph(e,t){return new tl(0,0,t.crescendo)}canExpand(e,t){return e.crescendo===t.crescendo}},il=class extends zt{constructor(e){super(0,0),this._scale=1,this._symbols=e}doLayout(){this.height=0;var e,t=this.renderer.smuflMetrics.directionsScale;this._scale=t;for(e of this._symbols){var s=this.renderer.smuflMetrics.glyphHeights.get(e)*t;s>this.height&&(this.height=s)}}paint(e,t,s){s.fillMusicFontSymbols(e+this.x,t+this.y+this.height,this._scale,this._symbols,!0)}},al=class extends zt{constructor(e){super(0,0),this._text=e}doLayout(){var e=this.renderer.scoreRenderer.canvas;e.font=this.renderer.resources.directionsFont,this.height=e.measureText(this._text).height}paint(e,t,s){var i=s.font,a=s.textBaseline,r=s.textAlign;s.font=this.renderer.resources.directionsFont,s.textBaseline=1,s.textAlign=2,s.fillText(this._text,e+this.x,t+this.y+this.height/2),s.font=i,s.textBaseline=a,s.textAlign=r}},rl=class extends Yt{constructor(e,t,s){super(e,t),this._barBeginGlyphs=[],this._barEndGlyphs=[],this._directions=s}doLayout(){var e=this._directions,e=(e.has(2)&&this._barBeginGlyphs.push(new il([57415,57415])),e.has(1)&&this._barBeginGlyphs.push(new il([57415])),e.has(4)&&this._barBeginGlyphs.push(new il([57416,57416])),e.has(3)&&this._barBeginGlyphs.push(new il([57416])),e.has(0)&&this._barEndGlyphs.push(new al("Fine")),e.has(18)&&this._barEndGlyphs.push(new al("To Double Coda")),e.has(17)&&this._barEndGlyphs.push(new al("To Coda")),e.has(13)&&this._barEndGlyphs.push(new al("D.S.S.")),e.has(14)&&this._barEndGlyphs.push(new al("D.S.S. al Coda")),e.has(15)&&this._barEndGlyphs.push(new al("D.S.S. al Double Coda")),e.has(16)&&this._barEndGlyphs.push(new al("D.S.S. al Fine")),e.has(9)&&this._barEndGlyphs.push(new al("D.S.")),e.has(10)&&this._barEndGlyphs.push(new al("D.S. al Coda")),e.has(11)&&this._barEndGlyphs.push(new al("D.S. al Double Coda")),e.has(12)&&this._barEndGlyphs.push(new al("D.S. al Fine")),e.has(5)&&this._barEndGlyphs.push(new al("D.C.")),e.has(6)&&this._barEndGlyphs.push(new al("D.C. al Coda")),e.has(7)&&this._barEndGlyphs.push(new al("D.C. al Double Coda")),e.has(8)&&this._barEndGlyphs.push(new al("D.C. al Fine")),this._doSideLayout(this._barBeginGlyphs)),t=this._doSideLayout(this._barEndGlyphs);this.height=Math.max(e,t)}_doSideLayout(e){let t=0,s=this.renderer.settings.display.effectBandPaddingBottom;for(var i of e)i.y=t,i.renderer=this.renderer,i.doLayout(),t+=i.height+s;return t}paint(e,t,s){for(var i of this._barBeginGlyphs)i.paint(e+this.x,t+this.y,s);for(var a of this._barEndGlyphs)a.paint(e+this.x+this.width,t+this.y,s)}},nl=class extends o{get notationElement(){return 48}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return 5}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&null!==t.voice.bar.masterBar.directions&&0<t.voice.bar.masterBar.directions.size}createNewGlyph(e,t){return new rl(0,0,t.voice.bar.masterBar.directions)}canExpand(e,t){return!0}},ol=class Up extends _o{constructor(e,t,s){super(e,t,1,Up._getSymbol(s))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(58658);var e=this.renderer.smuflMetrics.glyphTop.get(58658);this.offsetY=e}static _getSymbol(e){switch(e){case 0:return 58666;case 1:return 58667;case 2:return 58656;case 3:return 58668;case 4:return 58669;case 5:return-1;case 6:return 58671;case 7:return 58672;case 8:return 58665;case 9:case 10:return 58664;case 11:return 58673;case 12:return 58674;case 13:return 58675;case 14:return 58678;case 15:return 58679;case 16:return 58680;case 17:return 58676;case 18:return 58684;case 19:return 58685;case 20:return 58681;case 21:return 58683;case 22:return 58677;case 23:return 58662;case 24:return 58670;case 25:return 58682;default:return-1}}},hl=class extends o{get notationElement(){return 18}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return this._internalShouldCreateGlyph(t)}_internalShouldCreateGlyph(e){if(e.voice.bar.staff.track.score.stylesheet.hideDynamics||e.isEmpty||e.voice.isEmpty||e.isRest)return!1;let t=this._getPreviousDynamicsBeat(e),s=0===e.voice.index&&!t||e.dynamics!==t?.dynamics;if(s&&0<e.voice.index)for(var i of e.voice.bar.voices)i.index<e.voice.index&&(i=i.getBeatAtPlaybackStart(e.playbackStart))&&e.dynamics===i.dynamics&&this._internalShouldCreateGlyph(i)&&(s=!1);return s}_getPreviousDynamicsBeat(e){let t=e.previousBeat;for(;null!=t;){if(!t.isRest)return t;t=t.previousBeat}return null}createNewGlyph(e,t){return new ol(0,0,t.dynamics)}canExpand(e,t){return!0}},ll=class Yp extends _o{constructor(e){super(0,0,1,Yp._getSymbol(e)),this.center=!0}static _getSymbol(e){switch(e){case 1:return 59459;case 2:return 59460;case 3:return 59461}return-1}paint(e,t,s){super.paint(e,t+this.height,s)}},dl=class extends o{get notationElement(){return 19}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0!==t.fade}createNewGlyph(e,t){return new ll(t.fade)}canExpand(e,t){return!0}},cl=class Xp extends _o{constructor(e,t,s){super(e,t,1,Xp._getSymbol(s))}static _getSymbol(e){switch(e){case 0:return 58564;case 1:return 58560;case 2:return 58566;default:return-1}}paint(e,t,s){super.paint(e-this.width/2,t+this.height,s)}},ul=class extends o{get notationElement(){return 20}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0===t.voice.index&&!!t.fermata}createNewGlyph(e,t){return new cl(0,0,t.fermata.type)}canExpand(e,t){return!0}},pl=class{constructor(e,t){this.line=0,this.line=e,this.symbols=t}},ml=class Jp extends ah{constructor(){super(0,0),this._infos=new Map}get isEmpty(){return 0===this._infos.size}addFingers(e){var t=this.renderer.settings;0!==t.notation.fingeringMode&&1!==t.notation.fingeringMode||(-1!==(t=Jp.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.leftHandFinger,!0))&&this._addFinger(e,t),-1!==(t=Jp.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.rightHandFinger,!1))&&this._addFinger(e,t))}static fingerToMusicFontSymbol(e,t,s,i){if(1===e.notation.fingeringMode||3===e.notation.fingeringMode||Wt.isPiano(t.voice.bar.staff.track.playbackInfo.program))switch(s){case-2:case-1:return-1;case 0:return 60689;case 1:return 60690;case 2:return 60691;case 3:return 60692;case 4:return 60693;default:return-1}if(i)switch(s){case-2:return-1;case-1:return 60688;case 0:return 60696;case 1:return 60689;case 2:return 60690;case 3:return 60691;case 4:return 60692;default:return-1}switch(s){case-2:case-1:return-1;case 0:return 60695;case 1:return 60697;case 2:return 60698;case 3:return 60699;case 4:return 60700;default:return-1}}_addFinger(e,t){var s=this.renderer,i=s.getNoteLine(e);this._infos.has(i)?this._infos.get(i).symbols.push(t):((t=new pl(i,[t])).color=I.noteColor(s.resources,3,e),this._infos.set(i,t))}doLayout(){var e,t,s,i=this.renderer;for([e,t]of this._infos){var a=new So(0,0,1,t.symbols);a.colorOverride=t.color,a.renderer=i,a.y=i.getScoreY(t.line),a.doLayout(),a.offsetY=a.height/2,this.addGlyph(a),this.width=Math.max(this.width,a.width)}for(s of this.glyphs){var r=s;r.x=this.width/2,r.center=!0}}},gl=class extends o{get notationElement(){return 21}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return!(0!==t.voice.index||t.isRest||2!==e.notation.fingeringMode&&3!==e.notation.fingeringMode||1!==t.notes.length)&&t.notes[0].isFingering}createNewGlyph(e,t){let s=-2,i=!1,a=t.notes[0];-2!==a.leftHandFinger?(s=a.leftHandFinger,i=!0):-2!==a.rightHandFinger&&(s=a.rightHandFinger);t=ml.fingerToMusicFontSymbol(e.settings,t,s,i),t=new _o(0,0,1,t);return t.center=!0,t.renderer=e,t.doLayout(),t.offsetY=e.smuflMetrics.glyphTop.get(t.symbol),t}canExpand(e,t){return!0}},fl=class extends o{get notationElement(){return 34}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 0}shouldCreateGlyph(e,t){var s=t.voice.bar.masterBar;return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&s.isFreeTime&&(0===s.index||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(e,t){return new yh(0,0,"Free time",e.resources.effectFont,0)}canExpand(e,t){return!0}},bl=class extends _o{constructor(e,t,s=!1){super(e,t,ko.GraceScale,59458),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}},yl=class extends o{constructor(e,t){super(),this._type=e,this._shouldCreate=t}get notationElement(){return 43}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){var s=this._shouldCreate;return t.golpe===this._type&&(!s||s(e,t))}createNewGlyph(e,t){return new bl(0,0,!0)}canExpand(e,t){return!1}},x=class extends o{constructor(){super(...arguments),this.lastCreateInfo=null}shouldCreateGlyph(e,s){this.lastCreateInfo=[];for(let e=0,t=s.notes.length;e<t;e++){var i=s.notes[e];this.shouldCreateGlyphForNote(i)&&this.lastCreateInfo.push(i)}return 0<this.lastCreateInfo.length}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,t){return!0}},_l=class qp extends x{constructor(e){switch(super(),this._beat=null,this._harmonicType=e){case 0:this._effectId="harmonics-none";break;case 1:this._effectId="harmonics-natural";break;case 2:this._effectId="harmonics-artificial";break;case 3:this._effectId="harmonics-pinch";break;case 4:this._effectId="harmonics-tap";break;case 5:this._effectId="harmonics-semi";break;case 6:this._effectId="harmonics-feedback";break;default:this._effectId=""}}get effectId(){return this._effectId}get notationElement(){return 22}shouldCreateGlyphForNote(e){return!(!e.isHarmonic||e.harmonicType!==this._harmonicType||(e.beat!==this._beat&&(this._beat=e.beat),0))}get sizingMode(){return 3}createNewGlyph(e,t){return new qh(qp.harmonicToString(this._harmonicType))}static harmonicToString(e){switch(e){case 1:return"N.H.";case 2:return"A.H.";case 3:return"P.H.";case 4:return"T.H.";case 5:return"S.H.";case 6:return"Fdbk."}return""}},Sl=class extends _o{constructor(){super(0,0,1,59456),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}},vl=class extends x{get notationElement(){return 32}get sizingMode(){return 1}shouldCreateGlyphForNote(e){return e.isLeftHandTapped}createNewGlyph(e,t){return new Sl}},kl=class extends o{get notationElement(){return 23}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isLetRing}get sizingMode(){return 3}createNewGlyph(e,t){return new qh("LetRing")}canExpand(e,t){return!0}},wl=class extends Yt{constructor(e,t,s,i,a=1){super(e,t),this._lines=s,this.font=i,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(t,s,i){i.font=this.font;var a,r,n,e=i.textAlign;i.textAlign=this.textAlign;for(let e=0;e<this._lines.length;e++)this._lines[e]&&(a=this._lines[e],r=s+this.y+e*this.font.size+3,n=t+this.x,i.fillText(a,n,r));i.textAlign=e}},Tl=class extends o{get notationElement(){return 24}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return!!t.lyrics}createNewGlyph(e,t){return new wl(0,0,t.lyrics,e.resources.wordsFont,1)}canExpand(e,t){return!0}},Bl=class extends o{get notationElement(){return 25}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return 0}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.isSectionStart}createNewGlyph(e,t){return new yh(0,0,t.voice.bar.masterBar.section.marker?`[${t.voice.bar.masterBar.section.marker}] `+t.voice.bar.masterBar.section.text:t.voice.bar.masterBar.section.text,e.resources.markerFont,0)}canExpand(e,t){return!0}},xl=class jp extends _o{constructor(e){super(0,0,1,jp._getSymbol(e)),this.center=!0}static _getSymbol(e){switch(e){case 1:return 58728;case 2:return 58727;case 3:return 58732;case 4:return 58733}return-1}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58733),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(58733)}},Pl=class extends o{get notationElement(){return 46}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return t.notes.some(e=>0!==e.ornament)}createNewGlyph(e,t){return new xl(t.notes.find(e=>0!==e.ornament).ornament)}canExpand(e,t){return!1}},Nl=class extends es{constructor(e,t){super(4),this._ottava=e,this._aboveStaff=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58645)}paintNonGrouped(e,t,s){this._paintOttava(e,t,s)}_paintOttava(e,t,s){let i=0;switch(this._ottava){case 0:i=this.renderer.smuflMetrics.glyphWidths.get(58645),Ue.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,58645,!1);break;case 1:i=this.renderer.smuflMetrics.glyphWidths.get(58641),Ue.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,58641,!1);break;case 3:i=this.renderer.smuflMetrics.glyphWidths.get(58652),Ue.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,58652,!1);break;case 4:i=+(this.renderer.smuflMetrics.glyphWidths.get(58644)+this.renderer.smuflMetrics.glyphWidths.get(60565)+this.renderer.smuflMetrics.glyphWidths.get(60563)),Ue.fillMusicFontSymbolsSafe(s,e+this.x-i/2,t+this.y+this.height,1,[58644,60565,60563],!1)}return i/2}paintGrouped(t,e,s,i){var a=this._paintOttava(t,e,i),r=this.renderer.smuflMetrics.lineRangedGlyphDashGap,t=t+this.x+a+r,n=e+this.y,a=.5*this.height,o=(n+=this._aboveStaff?0:this.height,this.renderer.smuflMetrics.lineRangedGlyphDashSize),e=i.lineWidth;if(i.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,t<s){let e=t;for(;e<s;)i.beginPath(),i.moveTo(e,0|n),i.lineTo(Math.min(e+o,s),0|n),e+=o+r,i.stroke();i.beginPath(),this._aboveStaff?(i.moveTo(s,n),i.lineTo(s,n+a)):(i.moveTo(s,n),i.lineTo(s,n-a)),i.stroke()}i.lineWidth=e}},Ml=class extends o{get effectId(){return"ottavia-"+(this._aboveStaff?"above":"below")}get notationElement(){return 26}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 3}constructor(e){super(),this._aboveStaff=e}shouldCreateGlyph(e,t){switch(t.ottava){case 0:case 1:return this._aboveStaff;case 3:case 4:return!this._aboveStaff}return!1}createNewGlyph(e,t){return new Nl(t.ottava,this._aboveStaff)}canExpand(e,t){return e.ottava===t.ottava}},El=class extends x{get notationElement(){return 27}shouldCreateGlyphForNote(e){return e.isPalmMute}get sizingMode(){return 3}createNewGlyph(e,t){return new qh("P.M.")}},Ll=class extends x{get notationElement(){return 28}shouldCreateGlyphForNote(e){return 5===e.slideOutType||6===e.slideOutType}get sizingMode(){return 3}createNewGlyph(e,t){return new qh("P.S.")}},Cl=class $p extends _o{constructor(e,t,s){super(e,t,ko.GraceScale,$p._getSymbol(s)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static _getSymbol(e){switch(e){case 1:return 58898;case 2:return 58896;default:return-1}}},Fl=class extends o{get notationElement(){return 29}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0!==t.pickStroke}createNewGlyph(e,t){return new Cl(0,0,t.pickStroke)}canExpand(e,t){return!0}},Dl=class extends o{get notationElement(){return 47}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.hasRasgueado}get sizingMode(){return 3}createNewGlyph(e,t){return new qh("rasg.")}canExpand(e,t){return!0}},Ke=class extends es{constructor(e,t,s,i=!1){super(5),this._symbol=-1,this._repeatOffsetX=0,this._symbolOffsetY=0,this._type=s,this.x=e,this.y=t,this._partialWaves=i}doLayout(){switch(super.doLayout(),this._type){case 1:this._symbol=this.slightVibratoGlyph;break;case 2:this._symbol=this.wideVibratoGlyph}this._repeatOffsetX=this.renderer.smuflMetrics.repeatOffsetX.get(this._symbol),this._symbolOffsetY=this.renderer.smuflMetrics.glyphTop.get(this._symbol),this.height=this.renderer.smuflMetrics.glyphHeights.get(this._symbol)}paintGrouped(e,t,s,i){let a=e+this.x,r=s-a,n=this._repeatOffsetX,o=r/n;(o=this._partialWaves?o:Math.floor(o))<1&&(o=1);var h=[];for(let e=0;e<o;e++)h.push(this._symbol);i.fillMusicFontSymbols(e+this.x,t+this.y+this._symbolOffsetY,1,h,!1)}},Il=class extends Ke{get slightVibratoGlyph(){return 60082}get wideVibratoGlyph(){return 60083}},Al=class extends Ke{get slightVibratoGlyph(){return 60090}get wideVibratoGlyph(){return 60091}},Rl=class extends o{get notationElement(){return 30}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 4}shouldCreateGlyph(e,t){return 1===t.vibrato}createNewGlyph(e,t){return new Al(0,0,1)}canExpand(e,t){return!0}},Ol=class extends x{get notationElement(){return 31}shouldCreateGlyphForNote(e){let t=1===e.vibrato||e.isTieDestination&&1===e.tieOrigin.vibrato;return t=this._hideOnTiedBend&&t&&e.isTieDestination&&e.tieOrigin.hasBend?!1:t}get sizingMode(){return 4}createNewGlyph(e,t){return new Il(0,0,1)}constructor(e){super(),this._hideOnTiedBend=e}},Vl=class extends Yt{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58960)}paint(a,e,r){let t=this.renderer,n=e+this.y,o=this.height,h=t.bar.sustainPedals,l=this.renderer.smuflMetrics.glyphWidths.get(58960),d=this.renderer.smuflMetrics.glyphWidths.get(58965),c=0;for(;c<h.length;){let i=h[c];for(;null!=i;){let t=a+this.renderer.getRatioPositionX(i.ratioPosition),s=0;if(0===i.pedalType?(Ue.fillMusicFontSymbolSafe(r,t,n+o,1,58960,!0),s=l/2+this.renderer.smuflMetrics.sustainPedalLinePadding):2===i.pedalType&&(Ue.fillMusicFontSymbolSafe(r,t,n+o,1,58965,!0),s=d/2+this.renderer.smuflMetrics.sustainPedalLinePadding),i.nextPedalMarker)if(i.nextPedalMarker.bar===i.bar){let e=a+this.renderer.getRatioPositionX(i.nextPedalMarker.ratioPosition);switch(i.nextPedalMarker.pedalType){case 0:e-=l/2;break;case 1:break;case 2:e-=d/2}var u=t+s;e>u&&r.fillRect(u,n+o-this.renderer.smuflMetrics.pedalLineThickness,e-u,this.renderer.smuflMetrics.pedalLineThickness)}else{var u=a+this.x+this.width,p=t+s;r.fillRect(p,n+o-this.renderer.smuflMetrics.pedalLineThickness,u-p,this.renderer.smuflMetrics.pedalLineThickness)}var m;0===c&&i.previousPedalMarker&&(p=a+this.x,m=t-s,r.fillRect(p,n+o-this.renderer.smuflMetrics.pedalLineThickness,m-p,this.renderer.smuflMetrics.pedalLineThickness)),c++,null!=i.nextPedalMarker&&i.nextPedalMarker.bar!==i.bar?(i=null,c=h.length):i=i.nextPedalMarker}}}},Wl=class extends o{get notationElement(){return 42}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 5}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&0<t.voice.bar.sustainPedals.length}createNewGlyph(e,t){return new Vl}canExpand(e,t){return!0}},Hl=class extends o{get notationElement(){return 32}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return t.slap||t.pop||t.tap}createNewGlyph(e,t){e=e.resources;return t.slap?new yh(0,0,"S",e.effectFont,1):t.pop?new yh(0,0,"P",e.effectFont,1):new yh(0,0,"T",e.effectFont,1)}canExpand(e,t){return!0}},Gl=class extends Yt{constructor(e){super(0,0),this._tempoAutomations=e}doLayout(){super.doLayout();var e=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(60581)*e.engravingSettings.tempoNoteScale}paint(s,i,a){for(var r of this._tempoAutomations){let e=s+this.renderer.getRatioPositionX(r.ratioPosition),t=this.renderer.resources;a.font=t.markerFont;var n,o,h=i+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(60581)*t.engravingSettings.tempoNoteScale,l=a.textBaseline;a.textBaseline=3,r.text?(n=r.text+" ",o=a.measureText(n),a.fillText(n,e,h),e+=o.width):e-=t.engravingSettings.glyphWidths.get(60581)/2,Ue.fillMusicFontSymbolSafe(a,e,h,t.engravingSettings.tempoNoteScale,60581),e+=this.renderer.smuflMetrics.glyphWidths.get(60581)*t.engravingSettings.tempoNoteScale,a.fillText(" = "+r.value.toString(),e,h),a.textBaseline=l,e+=a.measureText(" = "+r.value.toString()).width}}},zl=class extends o{get notationElement(){return 33}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return 0}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.tempoAutomations.some(e=>e.isVisible)}createNewGlyph(e,t){return new Gl(t.voice.bar.masterBar.tempoAutomations.filter(e=>e.isVisible))}canExpand(e,t){return!0}},Ul=class extends o{get notationElement(){return 34}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return!!t.text}createNewGlyph(e,t){return new yh(0,0,t.text,e.resources.effectFont,0)}canExpand(e,t){return!0}},Yl=class extends es{constructor(e,t){super(5),this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58726)}paintGrouped(e,t,s,i){var a=this.renderer.smuflMetrics.glyphWidths.get(58726),r=e+this.x+a,n=this.renderer.smuflMetrics.repeatOffsetX.get(60068),o=Math.ceil((s-r)/n),h=[58726];for(let e=0;e<o;e++)h.push(60068);i.fillMusicFontSymbols(e+this.x-a/2,t+this.y+this.height,1,h,!1)}},Xl=class extends x{get notationElement(){return 35}shouldCreateGlyphForNote(e){return e.isTrill}get sizingMode(){return 4}createNewGlyph(e,t){return new Yl(0,0)}},Jl=class extends Yt{constructor(e){super(0,0),this._tupletHeight=0,this._tupletPadding=0,this._tripletFeel=e}doLayout(){super.doLayout();var e=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(60581)*e,this._tupletHeight=this.renderer.smuflMetrics.glyphHeights.get(59523)*e,this._tupletPadding=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this._tupletHeight}paint(e,t,s){e+=this.x,t+=this.y;let i=0,a=0;switch(this._tripletFeel){case 0:i=0,a=0;break;case 2:i=0,a=2;break;case 1:i=1,a=3;break;case 4:i=0,a=4;break;case 3:i=1,a=5;break;case 6:i=0,a=6;break;case 5:i=1,a=7}var r=this.renderer.smuflMetrics.tempoNoteScale,r=t+this.renderer.smuflMetrics.glyphTop.get(60581)*r,t=t+this.height,n=s.textBaseline;s.textBaseline=2,s.font=this.renderer.resources.effectFont,s.fillText("(",e,t),e+=s.measureText("( ").width,e=this._drawGroup(e,r+this._tupletHeight,s,i),s.fillText(" = ",e,t),e+=s.measureText(" = ").width,e=this._drawGroup(e,r+this._tupletHeight,s,a),s.fillText(" )",e,t),s.textBaseline=n}_drawGroup(e,t,s,i){let a=this.renderer.smuflMetrics.tempoNoteScale,r=[],n=[],o=[],h=-1;switch(i){case 0:o.push(1),r=[60581],n=[60581];break;case 1:o.push(1),o.push(1),r=[60581],n=[60581];break;case 2:r=[60581],n=[60583],h=59523;break;case 3:o.push(1),o.push(2),r=[60581],n=[60581],h=59523;break;case 4:o.push(1),o.push(2),r=[60581,32,60599],n=[60581];break;case 5:o.push(1),o.push(1),o.push(2),r=[60581,32,60599],n=[60581];break;case 6:o.push(1),o.push(0),r=[60581],n=[60581,32,60599];break;case 7:o.push(1),o.push(1),o.push(0),r=[60581],n=[60581,32,60599]}let l=this.renderer.smuflMetrics.glyphWidths.get(60581)*a,d=e+l-this.renderer.smuflMetrics.stemThickness*a,c=d+2*l+this.renderer.smuflMetrics.stemThickness*a,u=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,p=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,m=this.renderer.smuflMetrics.brokenBeamWidth*a,g=t-this.renderer.smuflMetrics.glyphHeights.get(60581)*a+u;var f,b,y,_,S;-1!==h&&(i=(e+c)/2,f=g-this._tupletHeight-this._tupletPadding,b=this.renderer.smuflMetrics.glyphTop.get(h)*a,y=this.renderer.smuflMetrics.glyphWidths.get(h)*a,Ue.fillMusicFontSymbolSafe(s,i,f+b,a,h,!0),b=i-y/2-this._tupletPadding,i=i+y/2+this._tupletPadding,y=this._tupletHeight/2,_=s.lineWidth,s.beginPath(),s.moveTo(e,f+y+y),s.lineTo(e,f+y),s.lineTo(b,f+y),s.moveTo(i,f+y),s.lineTo(c,f+y),s.lineTo(c,f+y+y),s.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*a,s.stroke(),s.lineWidth=_),s.fillMusicFontSymbols(e,t,a,r,!1),s.fillMusicFontSymbols(e=e+l+l,t,a,n,!1),e+=l,60599!==n[n.length-1]&&60583!==n[0]||(e+=l);for(S of o){switch(S){case 0:s.fillRect(d,g,m,u);break;case 1:s.fillRect(d,g,c-d,u);break;case 2:s.fillRect(c-m,g,m,u)}g+=u+p}return e}},ql=class extends o{get notationElement(){return 36}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return 0}shouldCreateGlyph(e,t){return 0===t.index&&(0===t.voice.bar.masterBar.index&&0!==t.voice.bar.masterBar.tripletFeel||0<t.voice.bar.masterBar.index&&t.voice.bar.masterBar.tripletFeel!==t.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(e,t){return new Jl(t.voice.bar.masterBar.tripletFeel)}canExpand(e,t){return!0}},jl=class Kp extends _o{constructor(e){super(0,0,1,Kp._getSymbol(e)),this.center=!0}static _getSymbol(e){switch(e){case 1:return 59453;case 2:return 59455}return-1}paint(e,t,s){super.paint(e,t+this.height,s)}},$l=class extends o{get notationElement(){return 44}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0!==t.wahPedal}createNewGlyph(e,t){return new jl(t.wahPedal)}canExpand(e,t){return!1}},Kl=class extends o{get notationElement(){return 37}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 3}shouldCreateGlyph(e,t){return t.hasWhammyBar}createNewGlyph(e,t){return new qh("w/bar")}canExpand(e,t){return!0}},Ql=class extends o{get notationElement(){return 38}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 4}shouldCreateGlyph(e,t){return 2===t.vibrato}createNewGlyph(e,t){return new Al(0,0,2)}canExpand(e,t){return!0}},Zl=class extends x{get notationElement(){return 39}shouldCreateGlyphForNote(e){return 2===e.vibrato||e.isTieDestination&&2===e.tieOrigin.vibrato}get sizingMode(){return 4}createNewGlyph(e,t){return new Il(0,0,2)}},ed=class{constructor(){this.x=0,this.width=0,this.masterBars=[]}},td=class extends Ch{constructor(){super(...arguments),this._system=null}get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let e=this.pagePadding[0];return this._system&&(e+=this._system.accoladeWidth),e}doResize(){}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case 0:this.systemsLayoutMode=0;break;case 1:this.systemsLayoutMode=2}var e=this.renderer.score,t=this.renderer.settings.display.startBar;t--;let r=t=Math.min(e.masterBars.length-1,Math.max(0,t)),s=this.renderer.settings.display.barCount,i=(s=t+(s=s<=0?e.masterBars.length:s)-1,s=Math.min(e.masterBars.length-1,Math.max(0,s)),this._system=this.createEmptyStaffSystem(),this._system.isLast=!0,this._system.x=this.pagePadding[0],this._system.y=this.pagePadding[1],this.renderer.settings.display.barCountPerPartial),n=[],a=new ed,o=0;for(;r<=s;){var h,l=this.multiBarRestInfo,l=null!==l&&l.has(r)?l.get(r):null,l=this._system.addBars(this.renderer.tracks,r,l);0===a.masterBars.length&&l.isLinkedToPrevious&&0<n.length?((h=n[n.length-1]).masterBars.push(e.masterBars[r]),h.width+=l.width,o+=l.width,a.x+=o):(a.masterBars.push(e.masterBars[r]),a.width+=l.width,a.masterBars.length>=i&&(0===n.length&&(a.width+=this._system.accoladeWidth+this.pagePadding[0]),o+=a.width,n.push(a),M.debug(this.name,`Finished partial from bar ${a.masterBars[0].index} to `+a.masterBars[a.masterBars.length-1].index,null),(a=new ed).x=o)),r++}0<a.masterBars.length&&(0===n.length&&(a.width+=this._system.accoladeWidth+this.pagePadding[0]),n.push(a),M.debug(this.name,`Finished partial from bar ${a.masterBars[0].index} to `+a.masterBars[a.masterBars.length-1].index,null)),this._finalizeStaffSystem(),this.height=Math.floor(this._system.y+this._system.height),this.width=this._system.x+this._system.width+this.pagePadding[2];let d=r=0;for(let t=0;t<n.length;t++){let s=n[t],e=new is,i=(e.x=d,e.y=0,e.totalWidth=this.width,e.totalHeight=this.height,e.width=s.width,e.height=this.height,e.firstMasterBarIndex=s.masterBars[0].index,e.lastMasterBarIndex=s.masterBars[s.masterBars.length-1].index,d+=s.width,r),a=t;this._system.buildBoundingsLookup(0,0),this.registerPartial(e,e=>{let t=this._system.getBarX(s.masterBars[0].index)+this._system.accoladeWidth;0===a&&(t-=this._system.x+this._system.accoladeWidth),e.color=this.renderer.settings.display.resources.mainGlyphColor,e.textAlign=0,M.debug(this.name,`Rendering partial from bar ${s.masterBars[0].index} to `+s.masterBars[s.masterBars.length-1].index,null),this._system.paintPartial(-t,this._system.y,e,i,s.masterBars.length)}),r+=s.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3],this.height*=this.renderer.settings.display.scale}_finalizeStaffSystem(){this._system.scaleToWidth(this._system.width),this._system.finalizeSystem()}},sd=class extends Ch{constructor(){super(...arguments),this._systems=[],this._allMasterBarRenderers=[],this._barsFromPreviousSystem=[]}get name(){return"PageView"}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case 0:this.systemsLayoutMode=0;break;case 1:this.systemsLayoutMode=1}var e=this.pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],e=this._layoutAndRenderScoreInfo(e,-1),e=this._layoutAndRenderTunings(e,-1),e=this._layoutAndRenderChordDiagrams(e,-1),e=this._layoutAndRenderScore(e),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}get supportsResize(){return!0}get firstBarX(){let e=this.pagePadding[0];return 0<this._systems.length&&(e+=this._systems[0].accoladeWidth),e}doResize(){var e=this.pagePadding[1],t=(this.width=this.renderer.width,this.height),e=this._layoutAndRenderScoreInfo(e,t);e=this._layoutAndRenderTunings(e,t),e=this._layoutAndRenderChordDiagrams(e,t),e=this._resizeAndRenderScore(e,t),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}_layoutAndRenderTunings(e,t=-1){if(!this.tuningGlyph)return e;let s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();var i=Math.round(this.tuningGlyph.height),a=new is;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=i,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+a.height:t,this.registerPartial(a,e=>{e.color=s.scoreInfoColor,e.textAlign=1,this.tuningGlyph.paint(0,0,e)}),e+i}_layoutAndRenderChordDiagrams(e,t=-1){if(!this.chordDiagrams)return e;let s=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();var i=Math.round(this.chordDiagrams.height),a=new is;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=i,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+i:t,this.registerPartial(a,e=>{e.color=s.scoreInfoColor,e.textAlign=1,this.chordDiagrams.paint(0,0,e)}),e+i}_layoutAndRenderScoreInfo(e,t=-1){M.debug(this.name,"Layouting score info");var s,i,a=new is;a.x=0,a.y=e;let r=0,n=this.renderer.settings.display.resources,o=[];for([s,i]of Ch.headerElements.value)if(this.headerGlyphs.has(s)){var h=this.headerGlyphs.get(s);h.y=r,this.alignScoreInfoGlyph(h);let e=h.font.size;4===s&&this.headerGlyphs.has(5)&&this.headerGlyphs.get(5).textAlign!==h.textAlign&&(e=0),r+=e,o.push(h)}return 0<o.length&&(r=Math.floor(r+17),a.width=this.scaledWidth,a.height=r,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+a.height:t,this.registerPartial(a,e=>{e.color=n.scoreInfoColor,e.textAlign=1;for(var t of o)t.paint(0,0,e)})),e+r}_resizeAndRenderScore(a,r){if(0<this.renderer.settings.display.barsPerRow||1===this.systemsLayoutMode)for(let e=0;e<this._systems.length;e++){var t=this._systems[e];this._fitSystem(t),a+=this._paintSystem(t,r)}else{this._systems=[];let t=0,s=this._maxWidth,i=this.createEmptyStaffSystem();for(i.index=this._systems.length,i.x=this.pagePadding[0],i.y=a;t<this._allMasterBarRenderers.length;){let e=this._allMasterBarRenderers[t];if(i.width+e.width<=s||0===i.masterBarsRenderers.length)i.addMasterBarRenderers(this.renderer.tracks,e),t++;else{for(;e&&!e.canWrap&&1<i.masterBarsRenderers.length;)e=i.revertLastBar(),t--;i.isFull=!0,i.isLast=this.lastBarIndex===i.lastBarIndex,this._systems.push(i),this._fitSystem(i),a+=this._paintSystem(i,r),(i=this.createEmptyStaffSystem()).index=this._systems.length,i.x=this.pagePadding[0],i.y=a}}i.isLast=this.lastBarIndex===i.lastBarIndex,this._fitSystem(i),a+=this._paintSystem(i,r)}return a}_layoutAndRenderScore(e){let t=this.firstBarIndex,s=this.lastBarIndex;for(this._systems=[];t<=s;){var i=this._createStaffSystem(t,s);this._systems.push(i),i.x=this.pagePadding[0],i.y=e,t=i.lastBarIndex+1,this._fitSystem(i),M.debug(this.name,`Rendering partial from bar ${i.firstBarIndex} to `+i.lastBarIndex,null),e+=this._paintSystem(i,e)}return e}_paintSystem(t,e){let s=Math.floor(t.height),i=new is;return i.x=0,i.y=t.y,i.totalWidth=this.scaledWidth,i.totalHeight=e,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=t.firstBarIndex,i.lastMasterBarIndex=t.lastBarIndex,t.buildBoundingsLookup(0,0),this.registerPartial(i,e=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=0,t.paint(0,-(i.y/this.renderer.settings.display.scale),e)}),s}_fitSystem(e){e.isFull||e.width>this._maxWidth||this.renderer.settings.display.justifyLastSystem?e.scaleToWidth(this._maxWidth):e.scaleToWidth(e.width),e.finalizeSystem()}_getBarsPerSystem(s){let i=this.renderer.settings.display.barsPerRow;if(1===this.systemsLayoutMode){let e,t;t=(1<this.renderer.tracks.length?(e=this.renderer.score.defaultSystemsLayout,this.renderer.score):(e=this.renderer.tracks[0].defaultSystemsLayout,this.renderer.tracks[0])).systemsLayout,i=s<t.length?t[s]:e}return i}_createStaffSystem(e,t){var i=this.createEmptyStaffSystem();i.index=this._systems.length;let a=this._getBarsPerSystem(i.index),r=this._maxWidth,s=t+1,n=e;for(;n<s;){if(0<this._barsFromPreviousSystem.length)for(var o of this._barsFromPreviousSystem)i.addMasterBarRenderers(this.renderer.tracks,o),n=o.lastMasterBarIndex;else{var h=this.multiBarRestInfo,h=null!==h&&h.has(n)?h.get(n):null,h=i.addBars(this.renderer.tracks,n,h);this._allMasterBarRenderers.push(h),n=h.lastMasterBarIndex}let e=!(this._barsFromPreviousSystem=[]);if(e=-1===a&&i.width>=r&&0!==i.masterBarsRenderers.length||i.masterBarsRenderers.length===a+1?!0:e){let e=i.revertLastBar();if(e)for(this._barsFromPreviousSystem.push(e);e&&!e.canWrap&&1<i.masterBarsRenderers.length;)(e=i.revertLastBar())&&this._barsFromPreviousSystem.push(e);return i.isFull=!0,i.isLast=!1,this._barsFromPreviousSystem.reverse(),i}let t=!1,s=!0;for(var l of this.renderer.tracks)l.lineBreaks&&l.lineBreaks.has(n+1)?t=!0:s=!1;if(t&&s)return i.isFull=!0,i.isLast=!1,i;i.x=0,n++}return i.isLast=t===i.lastBarIndex,i}get _maxWidth(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}},id=class extends zt{constructor(e,t,s){super(e,t),this.width=s}},k=class extends zt{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}},ad=class extends k{constructor(e,t,s){super(e,t),this._isRepeat=s}doLayout(){this.width=this._isRepeat?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paint(e,t,s){s.fillRect(e+this.x,t+this.y,this.renderer.smuflMetrics.thinBarlineThickness,this.height)}},rd=class extends k{paint(e,t,s){let i=this.renderer.smuflMetrics.thinBarlineThickness/2,a=this.renderer.getLineHeight(1),r=t+this.y+.5*a+i,n=t+this.y+this.height;for(;r<n;)s.fillCircle(e+this.x,r,i),r+=a}},nd=class extends k{paint(e,t,s){var i=this.renderer.smuflMetrics.dashedBarlineDashLength,a=e+this.x-this.width/2,e=Math.ceil(this.height/2/i),r=t+this.y+this.height,n=this.renderer.smuflMetrics.dashedBarlineGapLength,o=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),e<1)s.moveTo(a,t+this.y),s.lineTo(a,r);else{let e=t+this.y;for(;e<r;){s.moveTo(a,e);var h=Math.min(r-e,i);s.lineTo(a,e+h),e+=i+n}}s.stroke(),s.lineWidth=o}},od=class extends k{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paint(e,t,s){s.fillRect(e+this.x,t+this.y,this.width,this.height)}},hd=class extends k{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(57412)}paint(e,t,s){var i=this.renderer,a=i.heightLineCount%2==0?1:.5,t=t+this.y+this.height/2,a=i.getLineHeight(a),i=i.smuflMetrics.glyphTop.get(57412)-i.smuflMetrics.glyphHeights.get(57412)/2;Ue.fillMusicFontSymbolSafe(s,e+this.x,t+i-a,1,57412),Ue.fillMusicFontSymbolSafe(s,e+this.x,t+i+a,1,57412)}},ld=class extends k{paint(e,t,s){var i,a,r,n=this.renderer;n.drawnLineCount-1<=2||(i=n.smuflMetrics.staffLineThickness/2,a=n.getLineY((r=(n.drawnLineCount-1)/2)-1)-i,r=n.getLineY(1+r)+i,s.fillRect(e+this.x,t+a,n.smuflMetrics.thinBarlineThickness,r-a))}},dd=class extends k{paint(e,t,s){var i=this.renderer.getLineHeight(1);s.fillRect(e+this.x,t+this.y+(-i/2+1),1,i)}},cd=class extends rh{constructor(e){super(),this._isRight=e}doLayout(){let e=this.renderer.bar,t=e.masterBar,s=this._isRight?e.getActualBarLineRight():e.getActualBarLineLeft(0===this.renderer.index),i=this._isRight&&t.isRepeatEnd||!this._isRight&&t.isRepeatStart,a=0;if(!this._isRight){var r=this.renderer.previousRenderer;if(r&&r.staff===this.renderer.staff&&s===(a=r.bar.getActualBarLineRight()))return}switch(this._isRight&&t.isRepeatEnd&&(this.addGlyph(new hd(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),s){case 1:this.addGlyph(new nd(0,0));break;case 2:this.addGlyph(new rd(0,0));break;case 3:6!==a&&4!==a&&this.addGlyph(new od(0,0));break;case 4:6!==a&&3!==a&&this.addGlyph(new od(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new od(0,0));break;case 5:6!==a&&3!==a&&4!==a&&this.addGlyph(new od(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new ad(0,0,i));break;case 6:5!==a&&9!==a&&7!==a&&this.addGlyph(new ad(0,0,i)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new od(0,0));break;case 7:5!==a&&9!==a&&this.addGlyph(new ad(0,0,i)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new ad(0,0,i));break;case 8:break;case 9:5!==a&&7!==a&&this.addGlyph(new ad(0,0,i));break;case 10:this.addGlyph(new ld(0,0));break;case 11:this.addGlyph(new dd(0,0))}this._isRight||t.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new hd(0,0)));var n,r=this.renderer,o=r.smuflMetrics.staffLineThickness,h=this.y+r.topPadding-o,l=this.y+this.renderer.height-this.renderer.bottomPadding-h;for(n of this.glyphs)n.y=h,n.height=l}paint(e,t,s){var i=[];try{var a=this.renderer;z(i,I.bar(s,a.barLineBarSubElement,this.renderer.bar,!0));super.paint(e,t,s)}catch(e){var r=e,n=!0}finally{U(i,r,n)}}},ud=class extends zt{constructor(e,t,s){super(e,t),this._count=0,this._count=0,this._count=s}doLayout(){this.width=0}paint(e,t,s){var i=[];try{z(i,I.bar(s,this.renderer.repeatsBarSubElement,this.renderer.bar));var a=this.renderer.resources,r=s.textAlign,n=(s.font=a.barNumberFont,s.textAlign=2,"x"+this._count),o=s.measureText(n).width/1.5;s.fillText(n,e+this.x-o,t+this.y),s.textAlign=r}catch(e){var h=e,l=!0}finally{U(i,h,l)}}},pd=class extends zt{constructor(e,t,s){super(e,t),this._number=s+"  "}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number).width}paint(e,t,s){var i,a,r=[];try{this.renderer.staff.isFirstInSystem&&(z(r,I.bar(s,this.renderer.barNumberBarSubElement,this.renderer.bar,!0)),i=this.renderer.resources,a=s.textBaseline,s.textBaseline=0,s.font=i.barNumberFont,s.fillText(this._number,e+this.x,t+this.y),s.textBaseline=a)}catch(e){var n=e,o=!0}finally{U(r,n,o)}}},fs=class Qp extends Vh{constructor(){super(...arguments),this.firstLineY=0,this._startSpacing=!1,this.tupletSize=0}get lineOffset(){return this.lineSpacing}get tupletOffset(){return.5*this.smuflMetrics.oneStaffSpace}get topGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}get bottomGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){var e=this.lineOffset*(this.heightLineCount-1),t=(this.drawnLineCount-1)*this.lineOffset,s=this.smuflMetrics.staffLineThickness/2;this.firstLineY=(this.topPadding+(e-t)/2|0)-s}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(59520),super.doLayout()}getLineY(e){return this.firstLineY+this.getLineHeight(e)}getLineHeight(e){return this.lineOffset*e}paintBackground(e,t,s){super.paintBackground(e,t,s),this.paintStaffLines(e,t,s),this.paintSimileMark(e,t,s)}paintStaffLines(i,a,r){var e=[];try{z(e,I.bar(r,this.staffLineBarSubElement,this.bar,!0));var t,n=[];for(let e=0,t=this.drawnLineCount;e<t;e++)n.push([]);this.additionalMultiRestBars||this.collectSpaces(n);for(t of n)t.sort((e,t)=>e[0]>t[0]?1:e[0]<t[0]?-1:0);var o=this.width,h=this.smuflMetrics.staffLineThickness/2;for(let s=0;s<this.drawnLineCount;s++){let e=this.getLineY(s)-h,t=0;for(var l of n[s])r.fillRect(i+this.x+t,a+this.y+e,l[0]-t,this.smuflMetrics.staffLineThickness),t=l[0]+l[1];r.fillRect(i+this.x+t,a+this.y+e,o-t,this.smuflMetrics.staffLineThickness)}}catch(e){var s=e,d=!0}finally{U(e,s,d)}}collectSpaces(e){}createStartSpacing(){var e;this._startSpacing||(e=0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft,this.addPreBeatGlyph(new id(0,0,e)),this._startSpacing=!0)}paintTuplets(e,t,s,i,a=!1){for(var r of this.bar.voices)if(this.hasVoiceContainer(r)){var n;for(n of this.getVoiceContainer(r).tupletGroups)this._paintTupletHelper(e+this.beatGlyphsStart,t,s,n,i,a)}}getTupletBeamDirection(e){return this.getBeamDirection(e)}_paintTupletHelper(m,g,f,b,e,y){var t=[];try{let u=this.resources;var s=f.textAlign,i=f.textBaseline;f.color=0===b.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,f.textAlign=1,f.textBaseline=1;let p;var a,r=b.beats[0].tupletNumerator,n=b.beats[0].tupletDenominator,_=(2===r&&3===n?p=[59522]:3===r&&2===n?p=[59523]:4===r&&6===n?p=[59524]:5===r&&4===n?p=[59525]:6===r&&4===n?p=[59526]:7===r&&4===n?p=[59527]:9===r&&8===n?p=[59529]:10===r&&8===n?p=[59521,59520]:11===r&&8===n?p=[59521,59521]:12===r&&8===n?p=[59521,59522]:13===r&&8===n?p=[59521,59523]:(p=[],a=59520,10<r?(p.push(a+Math.floor(r/10)),p.push(r-10+a)):p.push(a+r),p.push(59530),10<n?(p.push(a+Math.floor(n/10)),p.push(n-10+a)):p.push(a+n)),this.tupletOffset),S=this.tupletSize,o=(z(t,I.beat(f,e,b.beats[0])),f.lineWidth);if(f.lineWidth=this.smuflMetrics.tupletBracketThickness,1!==b.beats.length&&b.isFull){let e=b.beats[0],t=b.beats[b.beats.length-1],s=null,i=null;for(let e=0;e<b.beats.length;e++)if(!b.beats[e].isRest){s=b.beats[e];break}for(let e=b.beats.length-1;0<=e;e--)if(!b.beats[e].isRest){i=b.beats[e];break}let a=!1,r=(s||(s=e,a=!0),i=i||t,this.getBeatX(e,1)-this.beatGlyphsStart),n=this.getBeatX(t,4)-this.beatGlyphsStart,o=this.helpers.beamHelperLookup[b.voice.index].get(s.index),h=this.helpers.beamHelperLookup[b.voice.index].get(i.index),l=this.getTupletBeamDirection(o),d=this.calculateBeamYWithDirection(o,r,l),c=this.calculateBeamYWithDirection(h,n,l);a&&(d=Math.max(d,c),c=d);var v=_+.5*S,k=(1===l?(d+=v,c+=v):(d-=v,c-=v),p.reduce((e,t)=>e+u.engravingSettings.glyphWidths.get(t),0)),w=.5*u.engravingSettings.oneStaffSpace,T=(r+n)/2,B=T-k/2-w,x=T+k/2+w,P=(c-d)/(n-r),N=d-P*r,M=P*B+N,E=P*T+N,L=P*x+N,C=1===l?d-.5*S:d+.5*S,F=1===l?c-.5*S:c+.5*S,D=f.lineWidth%2==0?0:.5;m+=D,g+=D,r<B&&(f.beginPath(),f.moveTo(m+this.x+r,g+this.y+C),y?f.quadraticCurveTo(m+this.x+(B+r)/2,g+this.y+M,m+this.x+B,g+this.y+M):(f.lineTo(m+this.x+r,g+this.y+d),f.lineTo(m+this.x+B,g+this.y+M)),f.moveTo(m+this.x+x,g+this.y+L),y?f.quadraticCurveTo(m+this.x+(n+x)/2,g+this.y+L,m+this.x+n,g+this.y+F):(f.lineTo(m+this.x+n,g+this.y+c),f.lineTo(m+this.x+n,g+this.y+F)),f.stroke()),f.fillMusicFontSymbols(m+this.x+T,g+this.y+E+.5*S,1,p,!0)}else for(var h of b.beats){var l=this.helpers.beamHelperLookup[b.voice.index].get(h.index);if(l){let e=this.getTupletBeamDirection(l),t=l.getBeatLineX(h),s=this.calculateBeamYWithDirection(l,t,e);1===e?s+=_+S:s-=_+S,f.fillMusicFontSymbols(m+this.x+t,g+this.y+s,1,p,!0)}}f.textAlign=s,f.textBaseline=i,f.lineWidth=o}catch(e){var d=e,c=!0}finally{U(t,d,c)}}paintBeams(e,t,s,i,a){for(var r of this.helpers.beamHelpers)for(var n of r)this._paintBeamHelper(e+this.beatGlyphsStart,t,s,n,i,a)}drawBeamHelperAsFlags(e){return 1===e.beats.length}_paintBeamHelper(e,t,s,i,a,r){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,this.drawBeamHelperAsFlags(i)?this.paintFlag(e,t,s,i,a):this.paintBar(e,t,s,i,r)}shouldPaintFlag(e,t){return!(3===e.graceType||e.deadSlapped||!t.hasBeatLineX(e)||0!==e.graceType&&1===this.settings.notation.notationMode||1===e.duration||-2===e.duration||-4===e.duration)}paintFlag(s,i,a,r,n){for(var o of r.beats){var h=[];try{if(this.shouldPaintFlag(o,r)){var l=0!==o.graceType,d=r.getBeatLineX(o),c=this.getBeamDirection(r),u=i+this.y+this.getFlagTopY(o,c),p=i+this.y+this.getFlagBottomY(o,c);let t=0;if(t=1===c?p:u,r.hasLine(!0,o)){this.paintBeamingStem(o,i+this.y,s+this.x+d,u,p,a);var m;z(h,I.beat(a,n,o));let e=0;r.hasFlag(!0,o)&&((m=new wo(s+this.x+d,t,o.duration,c,l)).renderer=this,m.doLayout(),m.paint(0,0,a),e=m.width/2),2===o.graceType&&(1===c?Ue.fillMusicFontSymbolSafe(a,s+this.x+d+e/2,(u+p-this.smuflMetrics.glyphHeights.get(58725))/2,ko.GraceScale,58725,!0):Ue.fillMusicFontSymbolSafe(a,s+this.x+d+e/2,(u+p+this.smuflMetrics.glyphHeights.get(58724))/2,ko.GraceScale,58724,!0))}}}catch(e){var t=e,g=!0}finally{U(h,t,g)}}}getFlagStemSize(e,t=!1){let s=0;switch(e){case-4:case 2:case 4:case 8:case 16:case 32:case 64:case 128:case 256:s=this.smuflMetrics.standardStemLength+this.smuflMetrics.stemFlagOffsets.get(e);break;default:s=t?this.smuflMetrics.standardStemLength:0}return s}recreatePreBeatGlyphs(){this._startSpacing=!1,super.recreatePreBeatGlyphs()}calculateBeamY(e,t){return this.calculateBeamYWithDirection(e,t,this.getBeamDirection(e))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new cd(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new pd(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs();var e=this.lastBar;this.addPostBeatGlyph(new cd(!0)),e.masterBar.isRepeatEnd&&2<e.masterBar.repeatCount&&this.addPostBeatGlyph(new ud(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))}paintBar(o,t,h,l,s){let i=this.getBeamDirection(l),a=0!==l.graceType?ko.GraceScale:1,d=(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*a,c=this.smuflMetrics.beamThickness*a;1===i&&(d=-d,c=-c);for(let n=0,e=l.beats.length;n<e;n++){var r=[];try{var u=l.beats[n];if(l.hasBeatLineX(u)&&!u.deadSlapped){var p=l.getBeatLineX(u),m=t+this.y+this.getBarLineStart(u,i),g=t+this.y+this.calculateBeamY(l,p)|0,f=(m<g?this.paintBeamingStem(u,t+this.y,o+this.x+p,m,g,h):this.paintBeamingStem(u,t+this.y,o+this.x+p,g,m,h),z(r,I.beat(h,s,u)),this.smuflMetrics.brokenBeamWidth*a),b=F.getIndex(u.duration)-2,y=t+this.y;for(let r=0;r<b;r++){let e=0,t=0,s=0,i=0,a=y+r*d;if(n<l.beats.length-1){var _=dh.isFullBarJoin(u,l.beats[n+1],r);if(r===b-1&&_&&3===u.beamingMode)e=p,t=e+f,s=a+this.calculateBeamY(l,e),i=a+this.calculateBeamY(l,t),Qp.paintSingleBar(h,o+this.x+e,s,o+this.x+t,i,c),t=l.getBeatLineX(l.beats[n+1]),e=t-f,s=a+this.calculateBeamY(l,e),i=a+this.calculateBeamY(l,t);else{if(_)e=p,t=l.getBeatLineX(l.beats[n+1]);else{if(0!==n&&dh.isFullBarJoin(l.beats[n-1],u,r))continue;e=p,t=e+f}s=a+this.calculateBeamY(l,e),i=a+this.calculateBeamY(l,t),0===r&&(s|=0,i|=0)}Qp.paintSingleBar(h,o+this.x+e,s,o+this.x+t,i,c)}else 0<n&&!dh.isFullBarJoin(u,l.beats[n-1],r)&&(e=p-f,t=t=p,s=a+this.calculateBeamY(l,e),i=a+this.calculateBeamY(l,t),Qp.paintSingleBar(h,o+this.x+e,s,o+this.x+t,i,c))}}}catch(e){var S=e,v=!0}finally{U(r,S,v)}}var e,n,k;2===l.graceType&&(e=l.getBeatLineX(l.beats[0]),n=this.smuflMetrics.glyphWidths.get(57920)*ko.GraceScale,k=t+this.y+this.calculateBeamY(l,e)|0,k+=c+d,Ue.fillMusicFontSymbolSafe(h,o+this.x+e+n/2,k,ko.GraceScale,1===i?58725:58724,!0))}static paintSingleBar(e,t,s,i,a,r){e.beginPath(),e.moveTo(t,s),e.lineTo(i,a),e.lineTo(i,a+r),e.lineTo(t,s+r),e.closePath(),e.fill()}},md=class Zp extends zt{constructor(e,t,s){super(0,0),this.yOffset=0,this.startNoteRenderer=null,this.endNoteRenderer=null,this.tieDirection=0,this._startX=0,this._startY=0,this._endX=0,this._endY=0,this._tieHeight=0,this._shouldDraw=!1,this.startBeat=e,this.endBeat=t,this.forEnd=s}doLayout(){var e,t;this.width=0,this.endBeat?(e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),this.startNoteRenderer=e,t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar),this.endNoteRenderer=t,this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this._shouldDraw=!1,this.tieDirection=e?this.getBeamDirection(this.startBeat,e):this.getBeamDirection(this.endBeat,t),!this.forEnd&&e?(e!==t?(this._startX=e.x+this.getStartX(),this._startY=e.y+this.getStartY()+this.yOffset,t&&e.staff===t.staff?(this._endX=t.x+this.getEndX(),this._endY=t.y+this.getEndY()+this.yOffset):(this._endX=e.x+e.width,this._endY=this._startY)):(this._startX=e.x+this.getStartX(),this._endX=t.x+this.getEndX(),this._startY=e.y+this.getStartY()+this.yOffset,this._endY=t.y+this.getEndY()+this.yOffset),this._shouldDraw=!0):e&&e.staff===t.staff||(this._startX=t.x,this._endX=t.x+this.getEndX(),this._startY=t.y+this.getEndY()+this.yOffset,this._endY=this._startY,this._shouldDraw=!0),this._shouldDraw&&(this.y=Math.min(this._startY,this._endY),this.shouldDrawBendSlur()?this._tieHeight=0:(this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY),e=Zp.calculateActualTieHeight(1,this._startX,this._startY,this._endX,this._endY,1===this.tieDirection,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness),this.height=e.h,0===this.tieDirection&&0<(t=this.y-e.y)&&(this.y-=t)))):this._shouldDraw=!1}paint(e,t,s){this._shouldDraw&&(this.shouldDrawBendSlur()?Zp.drawBendSlur(s,e+this._startX,t+this._startY,e+this._endX,t+this._endY,1===this.tieDirection,1,this.renderer.smuflMetrics.tieHeight):Zp.paintTie(s,1,e+this._startX,t+this._startY,e+this._endX,t+this._endY,1===this.tieDirection,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness))}shouldDrawBendSlur(){return!1}getTieHeight(e,t,s,i){return this.renderer.smuflMetrics.tieHeight}getBeamDirection(e,t){return 1}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(e,t,s,i,a,r,n,o){e=Zp._computeBezierControlPoints(e,t,s,i,a,r,n,o);if(e.length<8)return(r=new hs).x=t,r.y=s,r.w=0,r.h=0,r;s=e[1];var n=e[2],o=e[3],r=(a=e[7],((t=e[0])-n)/(t-2*n+(i=e[6]))),e=Zp._calculateExtrema(t,s,n,o,i,a,r),r=0<e.length?Math.min(t,i,e[0]):Math.min(t,i),e=0<e.length?Math.max(t,i,e[0]):Math.max(t,i),h=(s-o)/(s-2*o+a),t=Zp._calculateExtrema(t,s,n,o,i,a,h),n=0<t.length?Math.min(s,a,t[1]):Math.min(s,a),o=0<t.length?Math.max(s,a,t[1]):Math.max(s,a),i=new hs;return i.x=r,i.y=n,i.w=e-r,i.h=o-n,i}static _calculateExtrema(e,t,s,i,a,r,n){return n<=0||1<=n?[]:[(e=e+(s-e)*n)+(s+(a-s)*n-e)*n,(a=t+(i-t)*n)+(i+(r-i)*n-a)*n]}static _computeBezierControlPoints(e,t,s,i,a,r,n,o){var h,l,d,c,u,p;return t===i&&s===a||isNaN(n)||isNaN(o)||isNaN(e)?[]:(i<t&&(p=t,t=i,i=p,p=s,s=a,a=p),n*=e,o*=e,r&&(n*=-1,o*=-1),1<=e&&(o*=1.2),p=a-s,r=i-t,d=h=t+.75*(e=Math.sqrt(r*r+p*p)),c=e=t+.25*e,u=o=(l=n=s-n)-o,p=Math.atan2(p,r),[e,n]=Zp._rotate(e,n,t,s,p),[h,l]=Zp._rotate(h,l,t,s,p),[d,o]=Zp._rotate(d,o,t,s,p),[c,u]=Zp._rotate(c,u,t,s,p),[t,s,e,n,h,l,i,a,d,o,c,u,t,s])}static _rotate(e,t,s,i,a){e-=s,t-=i;return[s+(e*Math.cos(a)-t*Math.sin(a)),i+(e*Math.sin(a)+t*Math.cos(a))]}static paintTie(e,t,s,i,a,r,n,o,h){t=Zp._computeBezierControlPoints(t,s,i,a,r,n,o,h);t.length<14||t.some(e=>isNaN(e))||(e.beginPath(),e.moveTo(t[0],t[1]),e.bezierCurveTo(t[2],t[3],t[4],t[5],t[6],t[7]),e.bezierCurveTo(t[8],t[9],t[10],t[11],t[12],t[13]),e.closePath(),e.fill())}static drawBendSlur(i,a,r,n,o,h,l,d,c){let u=o-r,p=n-a,m=Math.sqrt(u*u+p*p);if(!(m<1e-4)){h?u*=-1:p*=-1,u/=m,p/=m;let e=(n+a)/2,t=(o+r)/2,s=d*l;n-a<20&&(s/=2);d=e+s*u,l=t+s*p;i.beginPath(),i.moveTo(a,r),i.lineTo(d,l),i.lineTo(n,o),i.stroke(),c&&(a=i.measureText(c).width,r=h?0:-i.font.size,i.fillText(c,d-a/2,l+r))}}},gd=class extends md{constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return 0}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,1)}getEndY(){return this.getStartY()}getStartX(){return this._isLeftHandTap?this.getEndX()-this.startNoteRenderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,1)}getEndX(){return this._isLeftHandTap?this.endNoteRenderer.getNoteX(this.endNote,0):this.endNoteRenderer.getNoteX(this.endNote,1)}},fd=class em extends md{constructor(e,t,s=!1){super(e.beat,t.beat,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,t,s,i){return this._isLeftHandTap?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(e,t,s,i)}getBeamDirection(e,t){return this._isLeftHandTap?0:em.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(e){return 3<e.string?0:1}getStartY(){return this._isLeftHandTap?this.startNoteRenderer.getNoteY(this.startNote,2):0===this.tieDirection?this.startNoteRenderer.getNoteY(this.startNote,1):this.startNoteRenderer.getNoteY(this.startNote,3)}getEndY(){return this.getStartY()}getStartX(){var e;return this._isLeftHandTap?(e=this.renderer.smuflMetrics.leftHandTabTieWidth||0,this.getEndX()-e):this.startNoteRenderer.getNoteX(this.startNote,1)}getEndX(){return this._isLeftHandTap?this.endNoteRenderer.getNoteX(this.endNote,0):this.endNoteRenderer.getNoteX(this.endNote,1)}},bd=class extends fd{constructor(e,t,s,i=!1){super(e,t,i),this._direction=0,this._forSlide=s}getTieHeight(e,t,s,i){return Math.log(s-e+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,t,s,i){if(this._forSlide!==s||this.forEnd!==i||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id)return!1;switch(this._direction){case 0:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case 1:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,s){var i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),i=this.getBeamDirection(this.startBeat,i),i=`numbered.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.`+i,a=this.renderer;a.staff.getSharedLayoutData(i,!1)||(a.staff.setSharedLayoutData(i,!0),super.paint(e,t,s))}},yd=class extends To{constructor(){super(...arguments),this._effectSlurs=[]}createTies(t){if(t.isVisible){if(t.isTieOrigin&&t.tieDestination.isVisible&&(r=new gd(t,t.tieDestination,!1),this.addTie(r)),t.isTieDestination&&(r=new gd(t.tieOrigin,t,!0),this.addTie(r)),t.isLeftHandTapped&&!t.isHammerPullDestination&&(r=new gd(t,t,!1),this.addTie(r)),t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;var s,i=2===t.slideOutType;for(s of this._effectSlurs)if(s.tryExpand(t,t.effectSlurDestination,i,!1)){e=!0;break}e||(r=new bd(t,t.effectSlurDestination,i,!1),this._effectSlurs.push(r),this.addTie(r))}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;var a,r,n=2===t.effectSlurOrigin.slideOutType;for(a of this._effectSlurs)if(a.tryExpand(t.effectSlurOrigin,t,n,!0)){e=!0;break}e||(r=new bd(t.effectSlurOrigin,t,n,!0),this._effectSlurs.push(r),this.addTie(r))}}}},_d=class extends zt{constructor(e,t,s,i,a){super(e,t),this._isGrace=i,this._number=s,this._beat=a}paint(e,t,s){var i=[];try{z(i,this._beat.isRest?I.beat(s,21,this._beat):0<this._beat.notes.length?I.note(s,8,this._beat.notes[0]):void 0);var a=this.renderer.resources;s.font=this._isGrace?a.numberedNotationGraceFont:a.numberedNotationFont,s.textBaseline=1,s.textAlign=0,s.fillText(this._number.toString(),e+this.x,t+this.y)}catch(e){var r=e,n=!0}finally{U(i,r,n)}}doLayout(){var e=this.renderer.resources,e=this._isGrace?e.numberedNotationGraceFont:e.numberedNotationFont,t=this.renderer.scoreRenderer.canvas,e=(t.font=e,t.measureText(""+this._number));this.height=e.height,this.width=e.width,this._isGrace&&(this.x+=3,this.y-=10)}},Sd=class{constructor(){this.x=0,this.y=-3e3,this.width=0}},vd=class extends ah{constructor(){super(0,0)}doLayout(){if(this.glyphs&&0!==this.glyphs.length){this.glyphs.sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:0);var s=[];s.push(new Sd);for(let t=0,e=this.glyphs.length;t<e;t++){var i=this.glyphs[t];i.renderer=this.renderer,i.doLayout();let e=0;for(;s[e].y>i.y;)++e===s.length&&s.push(new Sd);s[i.x=e].y=i.y+i.height,s[e].width<i.width&&(s[e].width=i.width)}this.width=0;var e,t=this.renderer.smuflMetrics.accidentalPadding;for(e of s)this.width+=e.width+t,e.x=this.width;for(let e=0,t=this.glyphs.length;e<t;e++){var a=this.glyphs[e],r=s[a.x];a.x=this.width-r.x}}else this.width=0}},kd=class tm extends _o{constructor(e,t,s,i){super(e,t,i,tm.getMusicSymbol(s))}static getMusicSymbol(e){switch(e){case 1:return 57953;case 2:return 57954;case 3:return 57952;case 4:return 57970;case 5:return 57972;case 6:return 57968;case 7:return 57955;case 8:return 57956}return-1}},wd=class extends _o{constructor(e,t){super(e,t,1,57831)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}},Td=class extends zt{constructor(e,t,s){super(e,t),this._beat=s}doLayout(){this.width=this.renderer.smuflMetrics.numberedDashGlyphWidth+this.renderer.smuflMetrics.numberedDashGlyphPadding,this.height=this.renderer.smuflMetrics.numberedBarRendererBarSize}paint(e,t,s){var i=[];try{z(i,I.beat(s,19,this._beat));var a,r=this.renderer.smuflMetrics.numberedDashGlyphPadding,n=0!==this._beat.graceType,o=n?3:0,h=n?-14:0;n?(0,a=Math.ceil(t+this.y-this.height)+h,s.fillRect(e+this.x+o,a,this.width-r,1),s.fillRect(e+this.x+o,a+1+1,this.width-r,1)):s.fillRect(e+this.x+o,Math.ceil(t+this.y-this.height)+h,this.width-r,this.height)}catch(e){var l=e,d=!0}finally{U(i,l,d)}}},Bd=class extends zt{constructor(){super(0,0)}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(57603)}paint(e,t,s){var i=this.renderer,a=i.getLineHeight(i.heightLineCount-1),i=i.getLineY(0)+i.getLineHeight(i.drawnLineCount-1)/2-a/2,r=s.lineWidth;s.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,s.moveTo(e+this.x,t+i),s.lineTo(e+this.x+this.width,t+i+a),s.moveTo(e+this.x,t+i+a),s.lineTo(e+this.x+this.width,t+i),s.stroke(),s.lineWidth=r}},xd=class extends Fh{constructor(){super(...arguments),this.isNaturalizeAccidental=!1,this.accidental=0}get effectElement(){return 20}doLayout(){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){var s,i,a=new vd;if(a.renderer=this.renderer,0<this.container.beat.notes.length){let e=this.container.beat.notes[0],t=0;e.isDead||(i=this.renderer.bar.keySignatureType,s=this.renderer.bar.keySignature+7,i=(1===i?Pd.minorKeySignatureOneValues:Pd.majorKeySignatureOneValues)[s],i=e.displayValue-i,F.accidentalNotes[i<0?(i%12+12)%12:i%12]&&!this.container.preNotes.isNaturalizeAccidental&&(t=s<7?3:2)),0!==t&&(this.accidental=t,i=this.renderer,s=I.noteColor(i.resources,9,e),(i=new kd(0,i.getLineY(0),t,0!==e.beat.graceType?ko.GraceScale*ko.GraceScale:ko.GraceScale)).colorOverride=s,i.renderer=this.renderer,a.addGlyph(i),this.addNormal(a),this.addNormal(new id(0,0,this.renderer.smuflMetrics.preNoteEffectPadding)))}}super.doLayout()}},Pd=class Pd extends Dh{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.octaveDots=0}get effectElement(){return 20}getNoteX(e,t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let e=s.x;switch(t){case 0:break;case 1:e+=s.width/2;break;case 2:e+=s.width}return e}return 0}buildBoundingsLookup(e,t,s){var i;this.noteHeads&&0<this.container.beat.notes.length&&((i=new ds).note=this.container.beat.notes[0],i.noteHeadBounds=new hs,i.noteHeadBounds.x=t+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i))}getLowestNoteY(){return this._internalGetNoteY(2)}getHighestNoteY(){return this._internalGetNoteY(2)}getNoteY(e,t){return this._internalGetNoteY(t)}_internalGetNoteY(t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let e=this.y+s.y;switch(t){case 1:case 0:e-=s.height/2;break;case 2:break;case 3:case 4:e+=s.height/2}return e}return 0}updateBeamingHelper(){if(this.beamingHelper){let e=null,t=this.container.x+this.x,s=0;s=(this.noteHeads?(e=this.noteHeads,t+=e.x,e):this.deadSlapped?(e=this.deadSlapped,t+=e.x,e):this).width,this.beamingHelper.registerBeatLineX("numbered",this.container.beat,t,t+s)}}doLayout(){var a=this.renderer,e=(a.shortestDuration<this.container.beat.duration&&(a.shortestDuration=this.container.beat.duration),a.getLineY(a.getNoteLine()));if(!this.container.beat.isEmpty){let t="0";if(0<this.container.beat.notes.length){var r=this.renderer.bar.keySignatureType,n=this.renderer.bar.keySignature,o=n+7,r=(1===r?Pd.minorKeySignatureOneValues:Pd.majorKeySignatureOneValues)[o],h=this.container.beat.notes[0];if(h.isDead)t="X";else{var h=h.displayValue-r,r=h<0?(h%12+12)%12:h%12,h=h<0?-((Math.abs(h)%12==0?Math.abs(h):Math.abs(h)+12)/12|0):h/12|0;this.octaveDots=h,a.registerOctave(h);let e=(F.keySignatureIsSharp(n)||F.keySignatureIsNatural(n)?Pi.flatNoteSteps:Pi.sharpNoteSteps)[r]+1;F.accidentalNotes[r]&&!this.container.preNotes.isNaturalizeAccidental&&(o<7?e++:e--),t=e.toString()}}if(this.container.beat.deadSlapped?((h=new Bd).renderer=this.renderer,h.doLayout(),this.deadSlapped=h,this.addEffect(h)):(n=0!==this.container.beat.graceType,r=new _d(0,e,t,n,this.container.beat),this.noteHeads=r,this.addNormal(r)),0<this.container.beat.dots&&4<=this.container.beat.duration)for(let e=0;e<this.container.beat.dots;e++){var l=new wd(0,a.getLineY(0));l.renderer=this.renderer,this.addEffect(l)}let s=0;switch(this.container.beat.duration){case-4:s=16;break;case-2:s=8;break;case 1:s=4;break;case 2:s=2}let i=s;for(let e=0;e<this.container.beat.dots;e++)i=i/2|0,s+=i;for(let e=0;e<s-1;e++){var d=new Td(0,a.getLineY(0),this.container.beat);d.renderer=this.renderer,this.addNormal(d)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}},Nd=(Pd.majorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61],Pd.minorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73],Pd),Md=class extends zt{constructor(e){super(0,0),this._isOpen=e}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(e,t,s){var i=s.color;this.colorOverride&&(s.color=this.colorOverride),this._isOpen?md.paintTie(s,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,t+this.y+this.height,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,t+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):md.paintTie(s,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,t+this.y,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,t+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),s.color=i}},ys=class extends ah{constructor(e,t,s,i,a,r){super(e,t),this._numerator=0,this._denominator=0,this.barSubElement=16,this._numerator=s,this._denominator=i,this._isCommon=a,this._isFreeTime=r}paint(e,t,s){var i=[];try{z(i,I.bar(s,this.barSubElement,this.renderer.bar));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{U(i,a,r)}}doLayout(){var e;if(this._isCommon&&2===this._numerator&&2===this._denominator?(a=new _o(0,0,this.commonScale,57483),this.addGlyph(a),super.doLayout()):this._isCommon&&4===this._numerator&&4===this._denominator?(a=new _o(0,0,this.commonScale,57482),this.addGlyph(a),super.doLayout()):(a=new Ih(0,0,this._numerator,0,this.numberScale),e=new Ih(0,0,this._denominator,2,this.numberScale),this.addGlyph(a),this.addGlyph(e),super.doLayout(),s=this.width,a.x=(s-a.width)/2,e.x=(s-e.width)/2,this.width=Math.max(a.x+a.width,e.x+e.width)),this._isFreeTime){var t,s=2*this.renderer.smuflMetrics.oneStaffSpace,i=new Md(!0);i.renderer=this.renderer,i.y=-s,i.height=2*s,i.doLayout();for(t of this.glyphs)t.x+=i.width;this.width+=i.width,this.addGlyph(i);var a=new Md(!1);a.renderer=this.renderer,a.x=this.width,a.y=-s,a.height=2*s,a.doLayout(),this.addGlyph(a),this.width+=a.width}}},Ed=class extends ys{get commonScale(){return 1}get numberScale(){return 1}},Ld=class extends zt{constructor(e,t,s,i){super(e,t),this._text="",this._accidental=0,this._accidentalOffset=0,this._keySignature=s,this._keySignatureType=i}doLayout(){super.doLayout();let e="",t=0;switch(this._keySignatureType){case 0:switch(this._keySignature){case-7:e="  C",t=3;break;case-6:e="  G",t=3;break;case-5:e="  D",t=3;break;case-4:e="  A",t=3;break;case-3:e="  E",t=3;break;case-2:e="  B",t=3;break;case-1:e="F";break;case 0:e="C",t=0;break;case 1:e="G",t=0;break;case 2:e="D",t=0;break;case 3:e="A",t=0;break;case 4:e="E",t=0;break;case 5:e="B",t=0;break;case 6:e="  F",t=2;break;case 7:e="  C",t=2}break;case 1:switch(this._keySignature){case-7:e="  a",t=3;break;case-6:e="  e",t=3;break;case-5:e="  b",t=3;break;case-4:e="f",t=0;break;case-3:e="c",t=0;break;case-2:e="g",t=0;break;case-1:e="d";break;case 0:e="a",t=0;break;case 1:e="e",t=0;break;case 2:e="b",t=0;break;case 3:e="  f",t=2;break;case 4:e="  c",t=2;break;case 5:e="  g",t=2;break;case 6:e="  d",t=2;break;case 7:e="  a",t=2}}this._text="1 = "+e,this._accidental=t;var s=this.renderer.scoreRenderer.canvas,i=this.renderer.resources;s.font=i.numberedNotationFont,this._accidentalOffset=s.measureText("1 = ").width,this.width=s.measureText("1 = "+e).width}paint(e,t,s){var i=[];try{z(i,I.bar(s,15,this.renderer.bar));var a=this.renderer.resources;s.font=a.numberedNotationFont,s.textBaseline=1,s.fillText(this._text,e+this.x,t+this.y),0!==this._accidental&&Ue.fillMusicFontSymbolSafe(s,e+this.x+this._accidentalOffset,t+this.y,1,kd.getMusicSymbol(this._accidental),!1)}catch(e){var r=e,n=!0}finally{U(i,r,n)}}},Cd=class extends fs{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.shortestDuration=-4,this.lowestOctave=null,this.highestOctave=null,this._isOnlyNumbered=!t.staff.showSlash&&!t.staff.showTablature&&!t.staff.showStandardNotation}get dotSpacing(){return 2*this.smuflMetrics.glyphHeights.get(57831)}registerOctave(e){null===this.lowestOctave?(this.lowestOctave=e,this.highestOctave=e):(e<this.lowestOctave&&(this.lowestOctave=e),e>this.highestOctave&&(this.highestOctave=e))}get repeatsBarSubElement(){return 3}get barNumberBarSubElement(){return 7}get barLineBarSubElement(){return 11}get staffLineBarSubElement(){return 23}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,19,19),this.paintTuplets(e,t,s,22,!0)}doLayout(){super.doLayout();let e=!1;for(var t of this.bar.voices)if(this.hasVoiceContainer(t)&&0<this.getVoiceContainer(t).tupletGroups.length){e=!0;break}if(e&&this.registerOverflowTop(this.tupletSize),!this.bar.isEmpty){var r=F.getIndex(this.shortestDuration)-2,n=this.dotSpacing;if(0<r){let e=this.smuflMetrics.numberedBarRendererBarSpacing,t=this.smuflMetrics.numberedBarRendererBarSize,s=(r-1)*e+t,i=0,a=this.lowestOctave;null!==a&&(i=Math.abs(a)*n+this.smuflMetrics.glyphHeights.get(57831)),this.registerOverflowBottom(s+i)}var r=this.highestOctave;null!==r&&(r=Math.abs(r)*n+this.smuflMetrics.glyphHeights.get(57831),this.registerOverflowTop(r))}}paintFlag(e,t,s,i,a){this.paintBar(e,t,s,i,a)}paintBar(n,i,o,h,a){if(0!==h.beats.length){var l=this.resources;for(let r=0,e=h.beats.length;r<e;r++){var d=[];try{var c,u,p,m=h.beats[r],g=(z(d,I.beat(o,a,m)),this.smuflMetrics.numberedBarRendererBarSpacing),f=this.smuflMetrics.numberedBarRendererBarSize,b=F.getIndex(m.duration)-2,y=i+this.y,_=this.getBeatX(m,0)-this.beatGlyphsStart,S=this.calculateBeamY(h,_),v=0!==m.graceType,k=v?3:0,w=v?-14:0;for(let a=0;a<b;a++){let e=0,t=0,s,i=y+a*g;t=r===h.beats.length-1?(e=_,Math.max(1+_,this.getBeatX(m,4)-this.beatGlyphsStart)):(e=_,Math.max(1+_,this.getBeatX(h.beats[r+1],0)-this.beatGlyphsStart)),s=i+S,v?(0,c=t-e,u=n+this.x+e+k,p=s+w,o.fillRect(u,p,c,1),o.fillRect(u,p+1+1,c,1)):o.fillRect(n+this.x+e+k,s+w,t-e,f)}var T=this.getBeatContainer(m).onNotes,B=T instanceof Nd?T.octaveDots:0,x=this.dotSpacing;let t=0,s=0;0<B?(t=y+this.getLineY(0)-l.numberedNotationFont.size,s=-1*x):B<0&&(t=y+S+b*(g+f),s=x);var P=this.getBeatX(m,2)-this.beatGlyphsStart,B=Math.abs(B);for(let e=0;e<B;e++)Ue.fillMusicFontSymbolSafe(o,n+this.x+P,t,1,57831,!0),t+=s}catch(e){var t=e,s=!0}finally{U(d,t,s)}}}}getNoteLine(){return 0}get tupletOffset(){return super.tupletOffset+1.5*this.resources.numberedNotationFont.size}getFlagTopY(e,t){return this.getLineY(0)-this.resources.numberedNotationFont.size}getFlagBottomY(e,t){return this.getLineY(0)-this.resources.numberedNotationFont.size}getBeamDirection(e){return 1}getTupletBeamDirection(e){return 0}getNoteY(e,t){let s=super.getNoteY(e,t);return s=Number.isNaN(s)?this.getLineY(0):s}calculateBeamYWithDirection(e,t,s){var i=this.resources.numberedNotationFont;return this.getLineY(0)+i.size-11}getBarLineStart(e,t){var s=this.smuflMetrics.glyphHeights.get(57508);return this.getLineY(0)-s/2}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine,(0===this.index||this.bar.masterBar.isRepeatStart&&this._isOnlyNumbered)&&this.addPreBeatGlyph(new cd(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new pd(0,this.getLineHeight(-.25),this.bar.index+1))}createLinePreBeatGlyphs(){this.bar.previousBar&&this.bar.keySignature===this.bar.previousBar.keySignature||(this.createStartSpacing(),this._createKeySignatureGlyphs()),this._isOnlyNumbered&&(!this.bar.previousBar||(this.bar.previousBar,this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator)||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createKeySignatureGlyphs(){this.addPreBeatGlyph(new Ld(0,this.getLineY(0),this.bar.keySignature,this.bar.keySignatureType))}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new id(0,0,this.smuflMetrics.oneStaffSpace));var e=this.bar.masterBar,e=new Ed(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));e.barSubElement=19,this.addPreBeatGlyph(e)}createPostBeatGlyphs(){this._isOnlyNumbered&&super.createPostBeatGlyphs()}createVoiceGlyphs(e){for(var t of e.beats){t=new yd(t,this.getVoiceContainer(e));t.preNotes=new(0===e.index?xd:Fh),t.onNotes=new(0===e.index?Nd:Dh),this.addBeatGlyph(t)}}paintBeamingStem(e,t,s,i,a,r){}},Fd=(Cd.StaffId="numbered",class extends m{get staffId(){return Cd.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new Cd(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showNumbered}}),Dd=class sm extends _o{constructor(e,t,s,i){super(e,t,1,sm._getSymbol(s,i)),this._clef=s,this._clefOttava=i}doLayout(){this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(57424),this.offsetX=this.width/2}static _getSymbol(e,t){switch(e){case 0:return 57449;case 1:case 2:return 3===t?57437:57436;case 3:switch(t){case 0:return 57446;case 1:return 57445;case 3:return 57444;case 4:return 57443;default:return 57442}case 4:switch(t){case 0:return 57428;case 1:return 57427;case 3:return 57426;case 4:return 57425;default:return 57424}default:return-1}}paint(s,i,a){var r=[];try{z(r,I.bar(a,12,this.renderer.bar));switch(super.paint(s,i,a),this._clef){case 1:case 2:if(3===this._clefOttava)return;break;case 3:case 4:return}let e,t=!1;switch(this._clefOttava){case 0:e=57470,t=!0;break;case 1:e=57469,t=!0;break;case 3:e=57469;break;case 4:e=57470;break;default:return}var n=this.width/2,o=t?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(e);Ue.fillMusicFontSymbolSafe(a,s+this.x+n,i+this.y-o,1,e,!0)}catch(e){var t=e,h=!0}finally{U(r,t,h)}}},Id=class im extends Yt{constructor(e,t,s){super(e,t),this._note=s}static _getSymbol(e,t){switch(e){case 0:return-1;case 1:return t?58528:58529;case 2:return t?58540:58541;case 3:return t?58532:58533;default:return-1}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(58528),this.height=this.renderer.smuflMetrics.glyphHeights.get(58528)}paint(e,t,s){var i=this.renderer.getBeatDirection(this._note.beat),a=im._getSymbol(this._note.accentuated,1===i),i=0===i?t+this.y:t+this.y+this.height;Ue.fillMusicFontSymbolSafe(s,e+this.x,i,1,a,!0)}},Ad=class extends _o{constructor(e,t,s){super(e,t,s?ko.GraceScale:1,57514)}},Rd=class am extends _o{constructor(e,t,s,i){super(e,t,i?ko.GraceScale:1,am._getSymbol(s))}static _getSymbol(e){switch(e){case-4:case-2:case 1:case 2:return 57566;default:return 57564}}},Od=class{constructor(e,t,s){this.line=0,this.line=e,this.isGhost=t,this.color=s}},Vd=class extends zt{constructor(e){super(0,0),this._infos=[],this._glyphs=[],this.isEmpty=!0,this._isOpen=e}addParenthesis(e){var t=this.renderer,s=t.getNoteLine(e),i=e.isGhost||this._isTiedBend(e)&&t.settings.notation.isNotationElementVisible(11),t=I.noteColor(t.resources,0,e);this._add(new Od(s,i,t))}addParenthesisOnLine(e,t){e=new Od(e,t,void 0);this._add(e)}_add(e){this._infos.push(e),e.isGhost&&(this.isEmpty=!1)}_isTiedBend(e){return!!e.isTieDestination&&(!!e.tieOrigin.hasBend||this._isTiedBend(e.tieOrigin))}doLayout(){var s,i=this.renderer;this._infos.sort((e,t)=>e.line-t.line);let a=null,r=i.getScoreHeight(1);for(let e=0,t=this._infos.length;e<t;e++)this._infos[e].isGhost?a?(s=i.getScoreY(this._infos[e].line)+r,a.height=s-a.y):((s=new Md(this._isOpen)).colorOverride=this._infos[e].color,s.renderer=this.renderer,s.y=i.getScoreY(this._infos[e].line)-r,s.height=2*r,s.doLayout(),this._glyphs.push(s),a=s):a=null;this.width=0<this._glyphs.length?this._glyphs[0].width:0}paint(e,t,s){super.paint(e,t,s);for(var i of this._glyphs)i.paint(e+this.x,t+this.y,s)}},Wd=class{constructor(e,t){this.steps=0,this.glyph=e,this.steps=t}},Ss=class extends zt{constructor(){super(0,0),this._infos=[],this.minNote=null,this.maxNote=null,this.upLineX=0,this.downLineX=0,this.noteStartX=0}getLowestNoteY(){return this.maxNote?this.renderer.getScoreY(this.maxNote.steps):0}getHighestNoteY(){return this.minNote?this.renderer.getScoreY(this.minNote.steps):0}add(e,t){e=new Wd(e,t);this._infos.push(e),(!this.minNote||this.minNote.steps>e.steps)&&(this.minNote=e),(!this.maxNote||this.maxNote.steps<e.steps)&&(this.maxNote=e)}doLayout(){this._infos.sort((e,t)=>t.steps-e.steps);let s=0,i=0,a=!0,r=0,n=!1,e=this.direction,o=this.renderer.smuflMetrics,h=this.scale,l=new Map;for(let e=0,t=this._infos.length;e<t;e++){var d,c,u=this._infos[e].glyph;u.renderer=this.renderer,u.doLayout(),!(0<e&&Math.abs(r-this._infos[e].steps)<=1)||a?(a=!1,l.set(e,!1)):(n=!0,a=!0,l.set(e,!0)),o.stemUp.has(u.symbol)?(d=o.stemUp.get(u.symbol).x*h)>s&&(s=d):(d=o.glyphWidths.get(u.symbol)*h)>s&&(s=d),o.stemDown.has(u.symbol)&&(u=o.stemDown.get(u.symbol).x*h)>i&&(c=u-i,i=u,s+=c),r=this._infos[e].steps}let p=n||0===e?s:i,m=0;for(let e=0,t=this._infos.length;e<t;e++){var g=this._infos[e].glyph;l.get(e)?g.x=p:(g.x=i,o.stemDown.has(g.symbol)&&(g.x-=o.stemDown.get(g.symbol).x*h)),g.x+=this.noteStartX,m=Math.max(m,g.x+g.width),g instanceof ko&&g.centerOnStem&&(g.x=p)}n?(this.upLineX=p,this.downLineX=p):(this.upLineX=s,this.downLineX=i),this.width=m}paint(e,t,s){var i;e+=this.x,t+=this.y,this._paintLedgerLines(e,t,s);for(i of this._infos)i.glyph.renderer=this.renderer,i.glyph.paint(e,t,s)}_paintLedgerLines(t,s,i){var a=[];try{if(this.minNote){var r=this.renderer,n=(z(a,I.bar(i,20,r.bar,!0)),this.scale),o=this.renderer.smuflMetrics.legerLineExtension*n,h=this.width-this.noteStartX+2*o,l=r.getLineHeight(1),d=r.getLineY(-1),c=r.getLineY(r.drawnLineCount),u=r.getLineY(this.minNote.steps/2),p=r.getLineY(this.maxNote.steps/2),m=this.renderer.smuflMetrics.legerLineThickness*n/2;let e=d;for(;e>=u;)i.fillRect(t-o+this.noteStartX,s+e-m,h,this.renderer.smuflMetrics.legerLineThickness*n),e-=l;for(e=c;e<=p;)i.fillRect(t-o+this.noteStartX,s+e-m,h,this.renderer.smuflMetrics.legerLineThickness*n),e+=l}}catch(e){var g=e,f=!0}finally{U(a,g,f)}}},Hd=class rm extends _o{constructor(e,t,s){super(e,t,1,rm._getSymbol(s))}static _getSymbol(e){switch(e){case 32:return 57890;case 16:return 57889;case 8:return 57888;default:return-1}}},Gd=class extends Ss{constructor(){super(...arguments),this._noteGlyphLookup=new Map,this._notes=[],this._deadSlapped=null,this._tremoloPicking=null,this.aboveBeatEffects=new Map,this.belowBeatEffects=new Map}get direction(){return this.beamingHelper.direction}get scale(){return 0!==this.beat.graceType?ko.GraceScale:1}getNoteX(s,i){if(this._noteGlyphLookup.has(s.id)){let e=this._noteGlyphLookup.get(s.id),t=this.x+e.x;switch(i){case 0:break;case 1:t+=e.width/2;break;case 2:t+=e.width}return t}return 0}getNoteY(e,t){return this._noteGlyphLookup.has(e.id)?(e=this._noteGlyphLookup.get(e.id),this._internalGetNoteY(e,t)):0}_internalGetNoteY(e,t){let s=this.y+e.y,i=0!==this.beat.graceType?ko.GraceScale:1;switch(t){case 0:s=(s-=(this.renderer.smuflMetrics.stemUp.has(e.symbol)?this.renderer.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*i)-this.renderer.smuflMetrics.standardStemLength*i;var a=this.renderer.centerStaffStemY(this.beamingHelper);return Math.min(a,s);case 1:s-=e.height/2;break;case 2:break;case 3:s+=e.height/2;break;case 4:s=(s-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*i)+this.renderer.smuflMetrics.standardStemLength*i;a=this.renderer.centerStaffStemY(this.beamingHelper);return Math.max(a,s);case 5:s-=(this.renderer.smuflMetrics.stemUp.has(e.symbol)?this.renderer.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*i;break;case 6:s-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*i}return s}addMainNoteGlyph(e,t,s){super.add(e,s),this._noteGlyphLookup.set(t.id,e),this._notes.push(t)}addEffectNoteGlyph(e,t){super.add(e,t)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.upLineX,e+this.x+this.downLineX)}doLayout(){super.doLayout();var e,t,s=this.renderer;this.beat.deadSlapped&&(this._deadSlapped=new Bd,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),this.width=this._deadSlapped.width);let i=0,a=0,r=this.renderer.smuflMetrics.onNoteEffectPadding,n=(i=this.beat.deadSlapped?(a=s.getScoreY(0),s.getScoreY(s.heightLineCount)):0===this.direction?(a=this._internalGetNoteY(this.maxNote.glyph,3)+r,this._internalGetNoteY(this.minNote.glyph,0)-r):(a=this._internalGetNoteY(this.maxNote.glyph,4)+r,this._internalGetNoteY(this.minNote.glyph,1)-r),null),o=null;for(e of this.aboveBeatEffects.values())e.renderer=this.renderer,e.doLayout(),i-=e.height,e.y=i,(null===n||n>i)&&(n=i),(null===o||o<i)&&(o=i),i-=r;for(t of this.belowBeatEffects.values())t.renderer=this.renderer,t.doLayout(),t.y=a,(null===n||n>a)&&(n=a),(null===o||o<a)&&(o=a),a+=t.height+r;if(null!==n&&s.registerBeatEffectOverflows(n,o??0),this.beat.isTremolo&&!this.beat.deadSlapped){let e=this.direction,t=0;t=0===e?(this._internalGetNoteY(this.minNote.glyph,0)+this._internalGetNoteY(this.minNote.glyph,5))/2:(this._internalGetNoteY(this.maxNote.glyph,6)+this._internalGetNoteY(this.maxNote.glyph,4))/2;let s=0===e?this.upLineX:this.downLineX,i=this.beat.tremoloSpeed;this.beat.duration<2&&(s=this.width/2),this._tremoloPicking=new Hd(s,t,i),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}buildBoundingsLookup(e,t,s){for(var i of this._notes){var a,r;this._noteGlyphLookup.has(i.id)&&(a=this._noteGlyphLookup.get(i.id),(r=new ds).note=i,r.noteHeadBounds=new hs,r.noteHeadBounds.x=t+this.x+a.x,r.noteHeadBounds.y=s+this.y+a.y-a.height/2,r.noteHeadBounds.w=a.width,r.noteHeadBounds.h=a.height,e.addNote(r))}}paint(e,t,s){this._paintEffects(e,t,s),super.paint(e,t,s)}_paintEffects(e,t,s){var i=[];try{var a,r;z(i,I.beat(s,5,this.beat));for(a of this.aboveBeatEffects.values())a.paint(e+this.x+this.width/2,t+this.y,s);for(r of this.belowBeatEffects.values())r.paint(e+this.x+this.width/2,t+this.y,s);this._tremoloPicking&&this._tremoloPicking.paint(e,t,s),this._deadSlapped&&this._deadSlapped.paint(e,t,s)}catch(e){var n=e,o=!0}finally{U(i,n,o)}}},zd=class nm extends _o{constructor(e,t,s){super(e,t,1,nm.getSymbol(s))}static getSymbol(e){switch(e){case-4:return 58593;case-2:return 58594;case 1:return 58595;case 2:return 58596;case 4:return 58597;case 8:return 58598;case 16:return 58599;case 32:return 58600;case 64:return 58601;case 128:return 58602;case 256:return 58603;default:return-1}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){this.internalPaint(e,t,s,6)}internalPaint(e,t,s,i){var a=[];try{z(a,I.beat(s,i,this.beat));super.paint(e,t,s)}catch(e){var r=e,n=!0}finally{U(a,r,n)}}},Ud=class extends Ss{constructor(e,t=!1){super(),this._showParenthesis=!1,this._noteValueLookup=new Map,this._accidentals=new vd,this._preNoteParenthesis=null,this._postNoteParenthesis=null,this.isEmpty=!0,this.noteHeadOffset=0,this._beat=e,(this._showParenthesis=t)&&(this._preNoteParenthesis=new Vd(!0),this._postNoteParenthesis=new Vd(!1))}get scale(){return ko.GraceScale}get direction(){return 0}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,t,s){var i=this.renderer,a=new ko(0,0,4,!0),t=i.accidentalHelper.applyAccidentalForValue(this._beat,e,t,!0),r=i.accidentalHelper.getNoteLineForValue(e,!1);a.y=i.getScoreY(r),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(r,!0),this._postNoteParenthesis.addParenthesisOnLine(r,!0)),0!==t&&((i=new kd(0,a.y,t,ko.GraceScale)).renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(i)),this._noteValueLookup.set(e,a),this.add(a,r),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this._accidentals.isEmpty||(e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(e,t,s){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,t+this.y,s),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,t+this.y,s),this._postNoteParenthesis.paint(e+this.x,t+this.y,s)),super.paint(e,t,s)}},a=class extends zt{constructor(){super(...arguments),this.bendNoteHeads=[]}drawBendSlur(e,t,s,i,a,r,n,o){md.drawBendSlur(e,t,s,i,a,r,n,this.renderer.smuflMetrics.tieHeight,o)}doLayout(){super.doLayout(),this.width=0;for(var e of this.bendNoteHeads)e.doLayout(),this.width+=e.width}getTieDirection(e,t){return 0===t.getBeatDirection(e)?1:0}},Yd=class extends a{constructor(e){super(0,0),this._endGlyph=null,this._beat=e}doLayout(){var e=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case 0:case 1:case 4:return;case 2:case 6:var t,s=new Ud(this._beat,!1),i=((this._endGlyph=s).renderer=this.renderer,this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1]);for(t of this._beat.notes)t.isTieOrigin||s.addGlyph(this._getBendNoteValue(t,i),i.value%2!=0,void 0);s.doLayout(),this.bendNoteHeads.push(s);break;case 3:if(1===e){var a=this.renderer.resources;this.renderer.simpleWhammyOverflow=a.tablatureFont.size+this.renderer.smuflMetrics.songBookWhammyDipHeight}else{var r=new Ud(this._beat,!1);if(r.renderer=this.renderer,0===this.renderer.settings.notation.notationMode){var n,o=this._beat.whammyBarPoints[1];for(n of this._beat.notes)r.addGlyph(this._getBendNoteValue(n,this._beat.whammyBarPoints[1]),o.value%2!=0,void 0)}r.doLayout(),this.bendNoteHeads.push(r);var h=new Ud(this._beat,!1);if(h.renderer=this.renderer,this._endGlyph=h,0===this.renderer.settings.notation.notationMode){var l,d=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(l of this._beat.notes)h.addGlyph(this._getBendNoteValue(l,d),d.value%2!=0,void 0)}h.doLayout(),this.bendNoteHeads.push(h)}}super.doLayout()}paint(h,l,d){var e=[];try{var c=this._beat;switch(c.whammyBarType){case 0:case 1:return}var u=this.renderer.settings.notation.notationMode,p=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,c.voice.bar),m=(z(e,I.beat(d,5,c)),h+p.x+p.getBeatX(c,2)),g=this.getTieDirection(c,p);let o=1===this._beat.notes.length?g:0;var t=d.textAlign,f=this.renderer.smuflMetrics.glyphHeights.get(57508);for(let n=0;n<c.notes.length;n++){var b=[];try{var y=c.notes[n];z(b,I.note(d,3,y));let e=l+p.y,t=(1===(o=0<n&&n>=(this._beat.notes.length/2|0)?1:o)?e+=p.getNoteY(y,3):e+=p.getNoteY(y,1),h+p.x);c.isLastOfVoice?t+=p.postBeatGlyphsStart:t+=p.getBeatX(c,5),this._endGlyph&&(t-=this._endGlyph.upLineX);var _=1===c.whammyStyle&&0===n?"grad.":"";let s=null,i=(y.isTieOrigin&&((s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,y.tieDestination.beat.voice.bar))&&s.staff===p.staff?t=h+s.x+s.getBeatX(y.tieDestination.beat,2):s=null),f*ko.GraceScale*.5);0===o&&(i=-i);var S,v,k,w,T,B,x,P,N,M,E=0<c.whammyBarPoints.length?this._getBendNoteValue(y,c.whammyBarPoints[c.whammyBarPoints.length-1]):0;let a=0,r=!1;switch(0<this.bendNoteHeads.length&&this.bendNoteHeads[0].containsNoteValue(E)?(a=this.bendNoteHeads[0].getNoteValueY(E)+i,r=!0):s&&(y.isTieOrigin&&y.tieDestination.beat.hasWhammyBar||y.beat.isContinuedWhammy)?(a=l+s.y+s.getNoteY(y.tieDestination,1),r=!0,1===o&&(a+=f)):y.isTieOrigin&&(a=s?l+s.y+s.getNoteY(y.tieDestination,1):e,1===o)&&(a+=f),c.whammyBarType){case 4:y.isTieOrigin&&md.paintTie(d,1,m,e,t,a,1===g,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case 2:0===n&&(this.bendNoteHeads[0].x=t-this.bendNoteHeads[0].noteHeadOffset,S=this.bendNoteHeads[0].y,this.bendNoteHeads[0].y=l+p.y,this.bendNoteHeads[0].paint(0,0,d),this.bendNoteHeads[0].containsNoteValue(E))&&(a=(a-=S)+this.bendNoteHeads[0].y),r?this.drawBendSlur(d,m,e,t,a,1===o,1,_):y.isTieOrigin&&md.paintTie(d,1,m,e,t,a,1===g,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case 3:1===u?(0===n&&(w=((v=h+p.x+p.getBeatX(this._beat,1))+(k=h+p.x+p.getBeatX(this._beat,4)))/2,T=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString(),d.font=this.renderer.resources.tablatureFont,d.fillText(T,w,l+this.y),x=(B=l+this.y+d.font.size)+this.renderer.smuflMetrics.songBookWhammyDipHeight,this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(d.moveTo(v,x),d.lineTo(w,B),d.lineTo(k,x)):(d.moveTo(v,B),d.lineTo(w,x),d.lineTo(k,B)),d.stroke()),y.isTieOrigin&&md.paintTie(d,1,m,e,t,a,1===g,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness)):(P=(m+t)/2,this.bendNoteHeads[0].x=P-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=l+p.y,this.bendNoteHeads[0].paint(0,0,d),N=this._getBendNoteValue(y,c.whammyBarPoints[1]),M=this.bendNoteHeads[0].getNoteValueY(N)+i,this.drawBendSlur(d,m,e,P,M,1===o,1,_),this.bendNoteHeads[1].x=t-this.bendNoteHeads[1].noteHeadOffset,this.bendNoteHeads[1].y=l+p.y,this.bendNoteHeads[1].paint(0,0,d),a=this.bendNoteHeads[1].getNoteValueY(E)+i,this.drawBendSlur(d,P,M,t,a,1===o,1,_));break;case 6:case 5:var L=h+p.x+p.getBeatX(y.beat,0),C=(L+=p.getPreNotesGlyphForBeat(y.beat).prebendNoteHeadOffset,l+p.y+p.getScoreY(p.accidentalHelper.getNoteLineForValue(y.displayValue-(y.beat.whammyBarPoints[0].value/2|0),!1))+i);this.drawBendSlur(d,L,C,m,e,1===o,1,_),0<this.bendNoteHeads.length&&(this.bendNoteHeads[0].x=t-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=l+p.y,this.bendNoteHeads[0].paint(0,0,d),this.drawBendSlur(d,m,e,t,a,1===o,1,_))}}catch(e){var s=e,i=!0}finally{U(b,s,i)}}d.textAlign=t}catch(e){var a=e,r=!0}finally{U(e,a,r)}}_getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}},Xd=class extends _o{constructor(e,t,s,i,a){super(e,t,a?ko.GraceScale:1,s.getSymbol(i)),this._isGrace=a,this._articulation=s}paint(e,t,s){var i=s.color,a=(this.colorOverride&&(s.color=this.colorOverride),this._isGrace?1:0);Ue.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+a,this.glyphScale,this.symbol,!1),-1!==this._articulation.techniqueSymbol&&1===this._articulation.techniqueSymbolPlacement&&Ue.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+a,this.glyphScale,this._articulation.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),0===this.width&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(57508)),0===this.height&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(57508))}},Jd=class extends _o{constructor(e,t){super(e,t,ko.GraceScale,58530),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}},qd=class extends _o{constructor(e,t){super(e,t,.5,59177),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}},jd=class extends Yt{constructor(){super(...arguments),this._strings=new Set}addString(e){this._strings.add(e)}doLayout(){var e=this.renderer.smuflMetrics.glyphWidths.get(59443)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(e+this.renderer.smuflMetrics.stringNumberCirclePadding)*this._strings.size,this.width=e}paint(e,t,s){let i=this.renderer.bar.staff.tuning.length,a=0,r=this.renderer.smuflMetrics.glyphWidths.get(59443)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(var n of this._strings){n=i-n;Ue.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+r+a,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,59444+n,!0),a+=r+this.renderer.smuflMetrics.stringNumberCirclePadding}}},$d=class om extends _o{constructor(e,t,s,i,a){super(e,t,i?ko.GraceScale:1,om.getSymbol(s)),this.beatEffects=new Map,this.noteHeadElement=6,this.effectElement=18,this._symbol=om.getSymbol(s),this.beat=a}paint(e,t,s){var i=[];try{z(i,0===this.beat.notes.length?void 0:I.note(s,this.noteHeadElement,this.beat.notes[0]));super.paint(e,t,s),this._paintEffects(e,t,s)}catch(e){var a=e,r=!0}finally{U(i,a,r)}}_paintEffects(e,t,s){var i=[];try{var a;z(i,I.beat(s,this.effectElement,this.beat));for(a of this.beatEffects.values())a.paint(e+this.x,t+this.y,s)}catch(e){var r=e,n=!0}finally{U(i,r,n)}}doLayout(){super.doLayout();let e=this.renderer.smuflMetrics.onNoteEffectPadding,t=this.renderer.smuflMetrics.glyphHeights.get(this._symbol);for(var s of this.beatEffects.values())s.y+=t,s.x+=this.width/2,s.renderer=this.renderer,s.doLayout(),t+=s.height+e}static getSymbol(e){switch(e){case-4:case-2:case 1:return 57602;case 2:return 57603;default:return 57601}}updateBeamingHelper(e){var t,s;this.beamingHelper&&(s=this._symbol,t=this.renderer.smuflMetrics.stemUp.has(s)?this.renderer.smuflMetrics.stemUp.get(s).x:0,s=this.renderer.smuflMetrics.stemDown.has(s)?this.renderer.smuflMetrics.stemDown.get(s).x:0,this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+t,e+this.x+s))}},Kd=class extends Dh{constructor(){super(...arguments),this._collisionOffset=-1e3,this._skipPaint=!1,this.noteHeads=null,this.restGlyph=null}get effectElement(){return 5}getNoteX(e,t){return this.noteHeads?this.noteHeads.getNoteX(e,t):0}buildBoundingsLookup(e,t,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(e,t+this.x,s+this.y)}getLowestNoteY(){return this.noteHeads?this.noteHeads.getLowestNoteY():0}getHighestNoteY(){return this.noteHeads?this.noteHeads.getHighestNoteY():0}getNoteY(e,t){return this.noteHeads?this.noteHeads.getNoteY(e,t):0}updateBeamingHelper(){var e;this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.restGlyph&&(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice)&&-1e3===this._collisionOffset&&(this._collisionOffset=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset,(e=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime).has(this.container.beat.playbackStart))&&e.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&e.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}paint(e,t,s){this._skipPaint||super.paint(e,t,s)}doLayout(){var s=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let t=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);1===this.container.beat.duration&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(t-=2);var e=new zd(0,s.getScoreY(t),this.container.beat.duration);if((this.restGlyph=e).beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.addNormal(e),this.renderer.bar.isMultiVoice&&(0===this.container.beat.voice.index?(r=dh.computeLineHeightsForRest(this.container.beat.duration),a=e.y-s.getScoreHeight(r[0]),e=e.y+s.getScoreHeight(r[1]),this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,a,e)):this.renderer.helpers.collisionHelper.registerRest(this.container.beat)),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,t),0<this.container.beat.dots)for(let e=0;e<this.container.beat.dots;e++){var i=new ah(0,0);i.renderer=this.renderer,this._createBeatDot(t,i),this.addEffect(i)}}else{var t,a,r=new Gd,n=((this.noteHeads=r).beat=this.container.beat,r.beamingHelper=this.beamingHelper,new Vd(!1));n.renderer=this.renderer;for(t of this.container.beat.notes)!t.isVisible||t.beat.slashed&&0!==t.index||(this._createNoteGlyph(t),n.addParenthesis(t));if(this.addNormal(r),n.isEmpty||this.addEffect(n),this.container.beat.hasWhammyBar&&((a=new Yd(this.container.beat)).renderer=this.renderer,a.doLayout(),this.container.ties.push(a)),0<this.container.beat.dots)for(let e=0;e<this.container.beat.dots;e++){var o,h=new ah(0,0);h.renderer=this.renderer;for(o of this.container.beat.notes)this._createBeatDot(s.getNoteLine(o),h).colorOverride=I.noteColor(s.resources,3,o);this.addEffect(h)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads&&(this.centerX=this.noteHeads.x+this.noteHeads.width/2)}_createBeatDot(e,t){var s=this.renderer,s=new wd(0,s.getScoreY(e));return t.addGlyph(s),s}_createNoteHeadGlyph(e){var t,s=0!==this.container.beat.graceType,i=e.style;if(void 0!==i?.noteHead)return(t=new ko(0,0,e.beat.duration,s)).symbol=i.noteHead,i.noteHeadCenterOnStem&&(t.centerOnStem=!0),t;if(e.beat.voice.bar.staff.isPercussion){i=rt.getArticulation(e);if(i)return new Xd(0,0,i,e.beat.duration,s);M.warning("Rendering","No articulation found for percussion instrument "+e.percussionArticulation)}return e.beat.slashed?new $d(0,0,e.beat.duration,s,e.beat):e.isDead?new Ad(0,0,s):3===e.beat.graceType?new ko(0,0,4,!0):new(1===e.harmonicType?Rd:ko)(0,0,e.beat.duration,s)}_createNoteGlyph(t){if(3!==t.beat.graceType||t.hasBend){var s,i=this.renderer,a=this._createNoteHeadGlyph(t);a.colorOverride=I.noteColor(i.resources,1,t);let e;e=t.beat.slashed?i.heightLineCount-1:i.getNoteLine(t),a.y=i.getScoreY(e),this.noteHeads.addMainNoteGlyph(a,t,e),t.beat.slashed||0===t.harmonicType||1===t.harmonicType||(r=t.displayValue+t.harmonicPitch,(s=new Rd(0,0,t.beat.duration,0!==this.container.beat.graceType)).colorOverride=a.colorOverride,e=i.accidentalHelper.getNoteLineForValue(r,!1),s.y=i.getScoreY(e),this.noteHeads.addEffectNoteGlyph(s,e));var a=this.noteHeads.belowBeatEffects,r=this.noteHeads.aboveBeatEffects,n=0===this.beamingHelper.direction?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(t.isStaccato&&!a.has("Staccato")&&n.set("Staccato",new Jd(0,0)),1!==t.accentuated||a.has("Accent")||n.set("Accent",new Id(0,0,t)),2!==t.accentuated||a.has("HAccent")||n.set("HAccent",new Id(0,0,t)),3!==t.accentuated||a.has("Tenuto")||n.set("Tenuto",new Id(0,0,t)),t.showStringNumber&&t.isStringed){let e;r.has("StringNumber")?e=r.get("StringNumber"):(e=new jd(0,0),r.set("StringNumber",e)),e.addString(t.string)}if(t.isPercussion){i=rt.getArticulation(t);if(i&&1!==i.techniqueSymbolPlacement){let e;switch(i.techniqueSymbolPlacement){case 0:e=this.noteHeads.aboveBeatEffects;break;case 2:e=this.noteHeads.belowBeatEffects;break;case 3:e=n;break;default:return}switch(i.techniqueSymbol){case 59177:e.set("PictEdgeOfCymbal",new qd(0,0));break;case 58530:e.set("ArticStaccatoAbove",new Jd(0,0));break;case 58898:e.set("StringsUpBow",new Cl(0,0,1));break;case 58896:e.set("StringsDownBow",new Cl(0,0,2));break;case 59458:e.set("GuitarGolpe",new bl(0,0,!0))}}}}}},Qd=class extends zt{constructor(e){super(0,0),this._beat=e}doLayout(){var e;3===this._beat.brushType||4===this._beat.brushType?((e=new Il(0,0,1,!0)).renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e,this.width=e.height):this.width=0}paint(s,i,a){if(3===this._beat.brushType||4===this._beat.brushType){let e=!0;for(var t of this._beat.notes)if(!t.isDeadVisual){e=!1;break}var r=this.renderer,n=r.lineOffset,o=i+this.y+(r.getNoteY(this._beat.maxNote,3)-n)-5,i=i+this.y+r.getNoteY(this._beat.minNote,1)+n-5,h=s+this.x+this.width/2+(e?8:0),r=this.renderer.smuflMetrics.glyphWidths.get(60284);this._noteVibratoGlyph;if(3===this._beat.brushType){var l=o+r,n=i-r,d=Math.floor(Math.abs(n-l)/5);a.beginPath(),a.moveTo(h,l);let t=l;for(let e=1;e<=d;e++){var c=l+5*e;e%2==1?a.quadraticCurveTo(h-3,c-2.5,h,c):a.quadraticCurveTo(h+3,c-2.5,h,c),t=c}t<n&&(s=n-t,a.quadraticCurveTo(d%2==1?h+3:h-3,t+s/2,h,n)),a.stroke(),a.beginPath(),a.moveTo(h,i),a.lineTo(h+r/2,i-r),a.lineTo(h-r/2,i-r),a.closePath(),a.fill(),a.beginPath(),a.moveTo(h,i-r),a.lineTo(h,i),a.stroke()}else if(4===this._beat.brushType){var u=o+r,p=Math.floor(Math.abs(i-u)/5);a.beginPath(),a.moveTo(h,u);for(let e=1;e<=p;e++){var m=u+5*e;e%2==1?a.quadraticCurveTo(h+3,m-2.5,h,m):a.quadraticCurveTo(h-3,m-2.5,h,m)}a.stroke(),a.beginPath(),a.moveTo(h,o),a.lineTo(h+r/2,o+r),a.lineTo(h-r/2,o+r),a.closePath(),a.fill(),a.beginPath(),a.moveTo(h,o),a.lineTo(h,o+r),a.stroke()}}}},Zd=class extends Fh{constructor(){super(...arguments),this._prebends=null,this.accidentals=null}get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}get effectElement(){return 5}doLayout(){if(!this.container.beat.isRest){var t,s=new vd,i=(s.renderer=this.renderer,new ml),a=(i.renderer=this.renderer,new Vd(!0)),r=(a.renderer=this.renderer,new Ud(this.container.beat,!0));(this._prebends=r).renderer=this.renderer;let e=!1;for(t of this.container.beat.notes){var n=I.noteColor(this.renderer.resources,3,t);if(t.isVisible){if(t.hasBend)switch(t.bendType){case 7:case 6:case 8:r.addGlyph(t.displayValue-(t.bendPoints[0].value/2|0),!1,n)}else if(t.beat.hasWhammyBar)switch(t.beat.whammyBarType){case 6:case 5:this._prebends.addGlyph(t.displayValue-(t.beat.whammyBarPoints[0].value/2|0),!1,n)}switch(this._createAccidentalGlyph(t,s),a.addParenthesis(t),i.addFingers(t),t.slideInType){case 1:case 2:e=!0}}}e&&this.addNormal(new id(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(0!==this.container.beat.graceType?ko.GraceScale:1))),r.isEmpty||(this.addEffect(r),this.addNormal(new id(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?ko.GraceScale:1)))),0!==this.container.beat.brushType&&(this.addEffect(new Qd(this.container.beat)),this.addNormal(new id(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?ko.GraceScale:1)))),i.isEmpty||(this.isEmpty||this.addNormal(new id(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?ko.GraceScale:1))),this.addEffect(i),this.addNormal(new id(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?ko.GraceScale:1)))),a.isEmpty||this.addEffect(a),s.isEmpty||(this.accidentals=s,this.isEmpty||this.addNormal(new id(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?ko.GraceScale:1))),this.addNormal(s),this.addNormal(new id(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?ko.GraceScale:1))))}super.doLayout()}_createAccidentalGlyph(e,t){var s,i=this.renderer,a=i.accidentalHelper.applyAccidental(e),r=i.getNoteLine(e),n=0!==this.container.beat.graceType,o=I.noteColor(i.resources,2,e),h=n?ko.GraceScale:1;0!==a&&((s=new kd(0,i.getScoreY(r),a,h)).colorOverride=o,s.renderer=this.renderer,t.addGlyph(s)),0!==e.harmonicType&&1!==e.harmonicType&&(s=e.displayValue+e.harmonicPitch,a=i.accidentalHelper.applyAccidentalForValue(e.beat,s,n,!1),r=i.accidentalHelper.getNoteLineForValue(s,!1),(e=new kd(0,i.getScoreY(r),a,h)).colorOverride=o,e.renderer=this.renderer,t.addGlyph(e))}},ec=class extends a{constructor(e){super(0,0),this._notes=[],this._endNoteGlyph=null,this._middleNoteGlyph=null,this._beat=e}addBends(s){if(this._notes.push(s),!s.isTieOrigin){var i=I.noteColor(this.renderer.resources,3,s);switch(s.bendType){case 2:case 8:case 7:{let e=this._endNoteGlyph;e||((e=new Ud(s.beat,!1)).renderer=this.renderer,this._endNoteGlyph=e,this.bendNoteHeads.push(e));var a=s.bendPoints[s.bendPoints.length-1];e.addGlyph(this._getBendNoteValue(s,a),a.value%2!=0,i)}break;case 3:if(!s.isTieOrigin){let e=this._endNoteGlyph;e||((e=new Ud(s.beat,!1)).renderer=this.renderer,this._endNoteGlyph=e,this.bendNoteHeads.push(e));a=s.bendPoints[s.bendPoints.length-1];e.addGlyph(this._getBendNoteValue(s,a),a.value%2!=0,i)}break;case 4:{let e=this._middleNoteGlyph;e||(e=new Ud(s.beat,!1),(this._middleNoteGlyph=e).renderer=this.renderer,this.bendNoteHeads.push(e));a=s.bendPoints[1];e.addGlyph(this._getBendNoteValue(s,s.bendPoints[1]),a.value%2!=0,i);let t=this._endNoteGlyph;t||((t=new Ud(s.beat,!1)).renderer=this.renderer,this._endNoteGlyph=t,this.bendNoteHeads.push(t));a=s.bendPoints[s.bendPoints.length-1];t.addGlyph(this._getBendNoteValue(s,a),a.value%2!=0,i)}}}}paint(a,r,n){let o=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._beat.voice.bar),h=a+o.x+o.getBeatX(this._beat,2),l=a+o.x;this._beat.isLastOfVoice?l+=o.postBeatGlyphsStart:l+=o.getBeatX(this._beat.nextBeat,0),this._endNoteGlyph&&(l-=this._endNoteGlyph.upLineX);var d=(h+l)/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=d-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=r+o.y,this._middleNoteGlyph.paint(0,0,n)),this._endNoteGlyph&&(this._endNoteGlyph.x=l-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=r+o.y,this._endNoteGlyph.paint(0,0,n)),this._notes.sort((e,t)=>t.displayValue-e.displayValue);let e=3===this._beat.graceType?this._beat.nextBeat:this._beat,c=1===this._notes.length?this.getTieDirection(e,o):0,u=this.renderer.smuflMetrics.glyphHeights.get(57508);for(let e=0;e<this._notes.length;e++){var t=[];try{var p=this._notes[e];z(t,I.note(n,3,p));0<e&&e>=(this._notes.length/2|0)&&(c=1);let s=r+o.y+o.getNoteY(p,1),i=u*ko.GraceScale*.5;1===c&&(s+=u);var m=1===p.bendStyle?"grad.":"";if(p.isTieOrigin){var g=p.tieDestination,f=g?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,g.beat.voice.bar):null;if(f&&f.staff===o.staff){let e=a+f.x+f.getBeatX(g.beat,2),t=r+f.y+f.getNoteY(g,1);1===c&&(t+=u),5===p.bendType||6===p.bendType?md.paintTie(n,1,h,s,e,t,1===c,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(n,h,s,e,t,1===c,1,m)}else{var b=a+o.x+o.width,y=p.tieDestination.realValue,_=(o.accidentalHelper.applyAccidentalForValue(p.beat,y,!1,!0),r+o.y+o.getScoreY(o.accidentalHelper.getNoteLineForValue(y,!1)));5===p.bendType||6===p.bendType?md.paintTie(n,1,h,s,b,_,1===c,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(n,h,s,b,_,1===c,1,m)}switch(p.bendType){case 6:case 7:case 8:var S=a+o.x+o.getBeatX(p.beat,0),v=(S+=o.getPreNotesGlyphForBeat(p.beat).prebendNoteHeadOffset,r+o.y+o.getScoreY(o.accidentalHelper.getNoteLineForValue(p.displayValue-(p.bendPoints[0].value/2|0),!1))+i);this.drawBendSlur(n,S,v,h,s,1===c,1)}}else{0===c&&(i=-i);let e=0,t=0;switch(p.bendType){case 2:e=this._getBendNoteValue(p,p.bendPoints[p.bendPoints.length-1]),t=this._endNoteGlyph.getNoteValueY(e)+i,this.drawBendSlur(n,h,s,l,t,1===c,1,m);break;case 4:var k=this._getBendNoteValue(p,p.bendPoints[1]),w=this._middleNoteGlyph.getNoteValueY(k)+i;this.drawBendSlur(n,h,s,d,w,1===c,1,m),e=this._getBendNoteValue(p,p.bendPoints[p.bendPoints.length-1]),t=this._endNoteGlyph.getNoteValueY(e)+i,this.drawBendSlur(n,d,w,l,t,1===c,1,m);break;case 3:0<this.bendNoteHeads.length&&(e=this._getBendNoteValue(p,p.bendPoints[p.bendPoints.length-1]),t=this.bendNoteHeads[0].getNoteValueY(e)+i,this.drawBendSlur(n,h,s,l,t,1===c,1,m));break;case 6:case 7:case 8:var T=a+o.x+o.getBeatX(p.beat,0),B=(T+=o.getPreNotesGlyphForBeat(p.beat).prebendNoteHeadOffset,r+o.y+o.getScoreY(o.accidentalHelper.getNoteLineForValue(p.displayValue-(p.bendPoints[0].value/2|0),!1))+i);this.drawBendSlur(n,T,B,h,s,1===c,1),0<this.bendNoteHeads.length&&(e=this._getBendNoteValue(p,p.bendPoints[p.bendPoints.length-1]),t=this.bendNoteHeads[0].getNoteValueY(e)+i,this.drawBendSlur(n,h,s,l,t,1===c,1,m))}}}catch(e){var s=e,i=!0}finally{U(t,s,i)}}}_getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}},tc=class extends md{constructor(e,t,s=!1){super(e,t,s)}doLayout(){super.doLayout()}getBeamDirection(e,t){return!e.isRest&&0===t.getBeatDirection(e)?1:0}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):0===this.tieDirection?this.startNoteRenderer.getNoteY(this.startBeat.maxNote,1):this.startNoteRenderer.getNoteY(this.startBeat.minNote,3)}getEndY(){var e,t=this.endNoteRenderer;return this.endBeat.isRest?0===this.tieDirection?t.getScoreY(9):t.getScoreY(0):this.startNoteRenderer.getBeatDirection(this.startBeat)!==(e=t.getBeatDirection(this.endBeat))&&0===this.startBeat.graceType?e===this.tieDirection?0===this.tieDirection?t.getNoteY(this.endBeat.maxNote,0):t.getNoteY(this.endBeat.minNote,4):0===this.tieDirection?t.getNoteY(this.endBeat.maxNote,4):t.getNoteY(this.endBeat.minNote,0):0===this.tieDirection?t.getNoteY(this.endBeat.maxNote,1):t.getNoteY(this.endBeat.minNote,3)}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,2)}getEndX(){var e=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,1<this.endBeat.duration&&e===this.tieDirection?3:2)}},sc=class extends zt{constructor(e,t,s,i){super(0,0),this._outType=t,this._inType=e,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this._paintSlideIn(e,t,s),this._drawSlideOut(e,t,s)}_paintSlideIn(e,t,s){let i=this.renderer,a=i.smuflMetrics.simpleSlideWidth,r=e+i.x+i.getNoteX(this._startNote,0)-i.smuflMetrics.preNoteEffectPadding,n=t+i.y+i.getNoteY(this._startNote,2),o=r-a,h=t+i.y;switch(this._inType){case 1:h+=i.getNoteY(this._startNote,3);break;case 2:h+=i.getNoteY(this._startNote,1);break;default:return}e=this._getAccidentalsWidth(i,this._startNote.beat);this._paintSlideLine(s,!1,o-=e,r-=e,h,n)}_getAccidentalsWidth(e,t){e=e.getPreNotesGlyphForBeat(t);return e&&e.accidentals?e.accidentals.width:0}_drawSlideOut(e,t,s){let i=this.renderer,a=i.smuflMetrics.simpleSlideWidth,r=i.smuflMetrics.postNoteEffectPadding,n=0,o=0,h=0,l=0,d=!1;switch(this._outType){case 1:case 2:var c;n=e+i.x+i.getBeatX(this._startNote.beat,4)+r,o=t+i.y+i.getNoteY(this._startNote,2),l=this._startNote.slideTarget?(c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar))&&c.staff===i.staff?(h=e+c.x+c.getBeatX(this._startNote.slideTarget.beat,0)-r,t+c.y+c.getNoteY(this._startNote.slideTarget,2)):(h=e+i.x+i.width,this._startNote.slideTarget.realValue>this._startNote.realValue?t+i.y+i.getNoteY(this._startNote,1):t+i.y+i.getNoteY(this._startNote,3)):(h=e+i.x+this._parent.x,o);break;case 3:n=e+i.x+i.getNoteX(this._startNote,2)+r,o=t+i.y+i.getNoteY(this._startNote,2),h=n+a,l=t+i.y+i.getNoteY(this._startNote,1);break;case 4:n=e+i.x+i.getNoteX(this._startNote,2)+r,o=t+i.y+i.getNoteY(this._startNote,2),h=n+a,l=t+i.y+i.getNoteY(this._startNote,3);break;case 6:n=e+i.x+i.getNoteX(this._startNote,2)+2*r,o=t+i.y+i.getNoteY(this._startNote,2),l=t+i.y+i.getNoteY(this._startNote,1),h=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,0)),d=!0;break;case 5:n=e+i.x+i.getNoteX(this._startNote,2)+2*r,o=t+i.y+i.getNoteY(this._startNote,2),l=t+i.y+i.getNoteY(this._startNote,3),h=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,0)),d=!0;break;default:return}this._paintSlideLine(s,d,n,h,o,l)}_paintSlideLine(e,t,s,i,a,r){var n,o,h;t?((t=new Il(0,0,1)).renderer=this.renderer,t.doLayout(),a-=t.height/2,h=i-s,n=(r-=t.height/2)-a,o=Math.sqrt(Math.pow(n,2)+Math.pow(h,2)),t.width=h,h=Math.asin(n/o)*(180/Math.PI),e.beginRotate(s,a,h),t.paint(0,0,e),e.endRotate()):(e.beginPath(),e.moveTo(s,a),e.lineTo(i,r),e.stroke())}},ic=class extends tc{constructor(e,t,s=!1){super(e.beat,t.beat,s),this._startNote=e,this._endNote=t}getTieHeight(e,t,s,i){return Math.log2(s-e+1)*this.renderer.settings.notation.slurHeight/2}getStartY(){return this._isStartCentered()?0===this.tieDirection?this.startNoteRenderer.getNoteY(this._startNote,1):this.startNoteRenderer.getNoteY(this._startNote,3):this.startNoteRenderer.getNoteY(this._startNote,2)}getEndY(){return this._isEndCentered()?this._isEndOnStem()?0===this.tieDirection?this.endNoteRenderer.getNoteY(this._endNote,0):this.endNoteRenderer.getNoteY(this._endNote,4):0===this.tieDirection?this.endNoteRenderer.getNoteY(this._endNote,1):this.endNoteRenderer.getNoteY(this._endNote,3):this.endNoteRenderer.getNoteY(this._endNote,2)}_isStartCentered(){return this._startNote===this._startNote.beat.maxNote&&0===this.tieDirection||this._startNote===this._startNote.beat.minNote&&1===this.tieDirection}_isEndCentered(){return 0===this._startNote.beat.graceType&&(this._endNote===this._endNote.beat.maxNote&&0===this.tieDirection||this._endNote===this._endNote.beat.minNote&&1===this.tieDirection)}_isEndOnStem(){var e=this.endNoteRenderer;return this.startNoteRenderer.getBeatDirection(this.startBeat)!==e.getBeatDirection(this.endBeat)&&0===this.startBeat.graceType}getStartX(){return this._isStartCentered()?this.startNoteRenderer.getBeatX(this._startNote.beat,2):this.startNoteRenderer.getNoteX(this._startNote,2)}getEndX(){return this._isEndCentered()?this._isEndOnStem()?this.endNoteRenderer.getBeatX(this._endNote.beat,3):this.endNoteRenderer.getNoteX(this._endNote,1):this.endNoteRenderer.getBeatX(this._endNote.beat,0)}},ac=class extends md{constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return 0===t.getBeatDirection(e)?1:0}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):0===this.tieDirection?this.startNoteRenderer.getNoteY(this.startNote,1):this.startNoteRenderer.getNoteY(this.startNote,3)}getEndY(){var e=this.endNoteRenderer;return this.endBeat.isRest?0===this.tieDirection?e.getScoreY(9):e.getScoreY(0):0===this.tieDirection?e.getNoteY(this.endNote,1):e.getNoteY(this.endNote,3)}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,4)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,0)}},rc=class extends To{constructor(){super(...arguments),this._bend=null,this._effectSlur=null,this._effectEndSlur=null}doLayout(){this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){var t,s;if(e.isVisible)if(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&3!==e.beat.graceType&&e.tieDestination&&e.tieDestination.isVisible&&(s=new ac(e,e.tieDestination,!1),this.addTie(s)),!e.isTieDestination||e.tieOrigin.hasBend||e.beat.hasWhammyBar||(s=new ac(e.tieOrigin,e,!0),this.addTie(s)),0===e.slideInType&&0===e.slideOutType||(s=new sc(e.slideInType,e.slideOutType,e,this),this.addTie(s)),e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible&&(s=new ic(e,e.slurDestination,!1),this.addTie(s)),e.isSlurDestination&&(s=new ic(e.slurOrigin,e,!0),this.addTie(s)),!this._effectSlur&&e.isEffectSlurOrigin&&e.effectSlurDestination&&(s=new ic(e,e.effectSlurDestination,!1),this._effectSlur=s,this.addTie(s)),!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin&&(t=0===(s=this.onNotes.beamingHelper.direction)?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,s=0===s?e.beat.minNote:e.beat.maxNote,t=new ic(t,s,!0),this._effectEndSlur=t,this.addTie(t)),e.hasBend&&(this._bend||(s=new ec(e.beat),(this._bend=s).renderer=this.renderer,this.addTie(s)),this._bend.addBends(e)),this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let e=this.beat.nextBeat;for(;e.nextBeat&&e.nextBeat.isLegatoDestination;)e=e.nextBeat;this.addTie(new tc(this.beat,e,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let e=this.beat.previousBeat;for(;e.previousBeat&&e.previousBeat.isLegatoOrigin;)e=e.previousBeat;this.addTie(new tc(e,this.beat,!0))}}},nc=class extends rh{paint(e,t,s){var i=[];try{z(i,I.bar(s,14,this.renderer.bar));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{U(i,a,r)}}},oc=class oc extends fs{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.beatEffectsMinY=null,this.beatEffectsMaxY=null,this.accidentalHelper=new Pi(this)}get repeatsBarSubElement(){return 0}get barNumberBarSubElement(){return 4}get barLineBarSubElement(){return 8}get staffLineBarSubElement(){return 20}get showMultiBarRest(){return!0}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}registerBeatEffectOverflows(e,t){var s=this.beatEffectsMinY,s=((null==s||e<s)&&(this.beatEffectsMinY=e),this.beatEffectsMaxY);(null==s||s<t)&&(this.beatEffectsMaxY=t)}getScoreY(e){return super.getLineY(e/2)}getScoreHeight(e){return super.getLineHeight(e/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){var e,t,r=this.getScoreY(-2),n=this.getScoreY(2*this.heightLineCount),o=this.simpleWhammyOverflow,h=this.beatEffectsMinY,h=(null!==h&&0<(h=r-h)&&this.registerOverflowTop(h),this.beatEffectsMaxY);null!==h&&0<(h=h-n)&&this.registerOverflowBottom(h),this.registerOverflowTop(o);let s=this.getScoreHeight(1),i=0,a=0;for(e of this.helpers.beamHelpers)for(var l of e)if(l.isRestBeamHelper)l.minRestLine&&(t=this.getScoreY(l.maxRestLine)-s)<i&&(i=t),l.maxRestLine&&(t=this.getScoreY(l.maxRestLine)+s)<i&&(i=t);else if(1===l.beats.length)if(2<=l.beats[0].duration)if(0===l.direction){let e=this.getFlagTopY(l.beats[0],l.direction);l.hasTuplet&&(e-=this.tupletSize+this.tupletOffset),e<i&&(i=e);var d=this.getFlagBottomY(l.beats[0],l.direction)+s;d>a&&(a=d)}else{let e=this.getFlagBottomY(l.beats[0],l.direction);l.hasTuplet&&(e+=this.tupletSize+this.tupletOffset),e>a&&(a=e);d=this.getFlagTopY(l.beats[0],l.direction)-s;d<i&&(i=d)}else{var c=this.getBeatContainer(l.beats[0]);if(c){let e=c.onNotes.getHighestNoteY()-s,t=c.onNotes.getLowestNoteY()+s;0===l.direction?l.hasTuplet&&(e-=this.tupletSize+this.tupletOffset):l.hasTuplet&&(t+=this.tupletSize+this.tupletOffset),t>a&&(a=t),e<i&&(i=e)}}else{this._ensureDrawingInfo(l,l.direction);c=l.drawingInfos.get(l.direction);if(0===l.direction){let e=Math.min(c.startY,c.endY);l.hasTuplet&&(e-=this.tupletSize+this.tupletOffset),e<i&&(i=e);var u=this.getBarLineStart(l.beatOfLowestNote,l.direction)+s;u>a&&(a=u)}else{let e=Math.max(c.startY,c.endY);l.hasTuplet&&(e+=this.tupletSize+this.tupletOffset),e>a&&(a=e);u=this.getBarLineStart(l.beatOfHighestNote,l.direction)-s;u<i&&(i=u)}}i<r&&this.registerOverflowTop(Math.abs(i)+o),a>n&&this.registerOverflowBottom(Math.abs(a)-n)}}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,2,3),this.paintTuplets(e,t,s,4)}_getSlashFlagY(){var e=(this.heightLineCount-1)/2;return this.getLineY(e)}getFlagTopY(i,a){if(i.slashed){let e=this._getSlashFlagY(),t=$d.getSymbol(i.duration),s=0!==i.graceType?ko.GraceScale:1;return 1===a?e-=this.smuflMetrics.stemDown.has(t)?this.smuflMetrics.stemDown.get(t).topY*s:0:e=(e-=this.smuflMetrics.stemUp.has(t)?this.smuflMetrics.stemUp.get(t).bottomY*s:0)-(this.smuflMetrics.standardStemLength+s),e}var e=this.accidentalHelper.getMinLineNote(i);if(e)return this.getBeatContainer(i).onNotes.getNoteY(e,0===a?0:6);let t=this.getScoreY(this.accidentalHelper.getMinLine(i));return 0===a&&(e=0!==i.graceType?ko.GraceScale:1,t-=this.smuflMetrics.standardStemLength*e),t}getFlagBottomY(i,a){if(i.slashed){let e=this._getSlashFlagY(),t=$d.getSymbol(i.duration),s=0!==i.graceType?ko.GraceScale:1;return 1===a?e=(e-=this.smuflMetrics.stemDown.has(t)?this.smuflMetrics.stemDown.get(t).topY*s:0)+(this.smuflMetrics.standardStemLength+s):e-=this.smuflMetrics.stemUp.has(t)?this.smuflMetrics.stemUp.get(t).bottomY*s:0,e}var e=this.accidentalHelper.getMaxLineNote(i);if(e)return this.getBeatContainer(i).onNotes.getNoteY(e,0===a?5:4);let t=this.getScoreY(this.accidentalHelper.getMaxLine(i));return 1===a&&(e=0!==i.graceType?ko.GraceScale:1,t+=this.smuflMetrics.standardStemLength*e),t}getBeamDirection(e){return e.direction}centerStaffStemY(e){return this.bar.staff.standardNotationLineCount===$t.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):0===e.direction?this.getScoreY(2*this.bar.staff.standardNotationLineCount):this.getScoreY(0)}getStemBottomY(e){throw new Error("Method not implemented.")}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(e,t){if(e.beat.slashed)return i=(this.heightLineCount-1)/2,this.getLineY(i);let s=super.getNoteY(e,t);if(Number.isNaN(s)){var i=Pi.computeLineWithoutAccidentals(this.bar,e),i=(s=this.getScoreY(i),0===e.beat.graceType?1:ko.GraceScale),a=this.smuflMetrics.standardStemLength*i,r=this.smuflMetrics.glyphHeights.get(ko.getSymbol(e.beat.duration))*i;switch(t){case 0:s-=a;break;case 1:s-=r/2;break;case 2:break;case 3:s+=r/2;break;case 4:s+=a}}return s}applyLayoutingInfo(){var e,t,s,i=super.applyLayoutingInfo();return i&&this.bar.isMultiVoice&&(e=this.getScoreY(-2),t=this.getScoreY(2*this.heightLineCount),(s=this.helpers.collisionHelper.getBeatMinMaxY())[0]<e&&this.registerOverflowTop(Math.abs(s[0])),t<s[1])&&this.registerOverflowBottom(Math.abs(s[1])-t),i}calculateBeamYWithDirection(e,t,s){return 0===e.beats.length?0===s?this.getFlagTopY(e.beats[0],s):this.getFlagBottomY(e.beats[0],s):(this._ensureDrawingInfo(e,s),e.drawingInfos.get(s).calcY(t))}_ensureDrawingInfo(i,a){if(!i.drawingInfos.has(a)){let e=0!==i.graceType?ko.GraceScale:1,t=F.getIndex(i.shortestDuration)-2,s=this.smuflMetrics.standardStemLength*e;i.tremoloDuration&&(n=(this.smuflMetrics.beamThickness+this.smuflMetrics.beamSpacing)*e,8<i.shortestDuration?8===i.tremoloDuration?s+=n:s+=1.5*n:32===i.tremoloDuration&&(s+=1.5*n));var r=new lh,n=(i.drawingInfos.set(a,r),i.beats[0]),o=i.beats[i.beats.length-1],h=i.isRestBeamHelper,n=(r.startBeat=n,r.startX=i.getBeatLineX(n),r.startY=h?0===a?this.getScoreY(i.minRestLine):this.getScoreY(i.maxRestLine):0===a?this.getFlagTopY(n,a):this.getFlagBottomY(n,a),r.endBeat=o,r.endX=i.getBeatLineX(o),r.endY=h?0===a?this.getScoreY(i.minRestLine):this.getScoreY(i.maxRestLine):0===a?this.getFlagTopY(o,a):this.getFlagBottomY(o,a),this.smuflMetrics.oneStaffSpace);if(1===a&&r.startY>r.endY&&r.startY-r.endY>n&&(r.endY=r.startY-n),1===a&&r.endY>r.startY&&r.endY-r.startY>n&&(r.startY=r.endY-n),0===a&&r.startY<r.endY&&r.endY-r.startY>n&&(r.endY=r.startY+n),0===a&&r.endY<r.startY&&r.startY-r.endY>n&&(r.startY=r.endY+n),1<i.beats.length)if(0===a?(o=this.getScoreY(this.accidentalHelper.getMinLine(i.beatOfHighestNote))-s,0<(n=r.calcY(i.getBeatLineX(i.beatOfHighestNote))-o)&&(r.startY-=n,r.endY-=n)):0<(o=this.getScoreY(this.accidentalHelper.getMaxLine(i.beatOfLowestNote))+s-r.calcY(i.getBeatLineX(i.beatOfLowestNote)))&&(r.startY+=o,r.endY+=o),null===i.minRestLine&&null===i.maxRestLine||(n=0!==i.graceType?ko.GraceScale:1,o=t*(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*n,o+=this.smuflMetrics.beamSpacing,0===a&&null!==i.minRestLine?(n=this.getScoreY(i.minRestLine)-o,0<(n=r.calcY(i.getBeatLineX(i.beatOfMinRestLine))-n)&&(r.startY-=n,r.endY-=n)):1===a&&null!==i.maxRestLine&&0<(n=this.getScoreY(i.maxRestLine)+o-r.calcY(i.getBeatLineX(i.beatOfMaxRestLine)))&&(r.startY+=n,r.endY+=n)),0<i.slashBeats.length)for(var l of i.slashBeats){var d=r.calcY(i.getBeatLineX(l)),l=(0===i.direction?this.getFlagTopY(l,i.direction):this.getFlagBottomY(l,i.direction))-d;0<l&&(r.startY+=l,r.endY+=l)}2<t&&!h&&(o=this.smuflMetrics.beamSpacing*e,h=t*(n=this.smuflMetrics.beamThickness*e)+(t-1)*o,0===a?(a=r.startY+2*n+o-h,0<(a=r.startY-a)&&(r.startY-=a,r.endY-=a)):0<(a=r.startY-2*n+o+h-r.startY)&&(r.startY+=a,r.endY+=a))}}getBarLineStart(e,t){return e.slashed?1===t?this.getFlagTopY(e,t):this.getFlagBottomY(e,t):0===t?(t=this.accidentalHelper.getMaxLineNote(e))?this.getBeatContainer(e).onNotes.getNoteY(t,5):this.getScoreY(this.accidentalHelper.getMaxLine(e)):(t=this.accidentalHelper.getMinLineNote(e))?this.getBeatContainer(e).onNotes.getNoteY(t,6):this.getScoreY(this.accidentalHelper.getMinLine(e))}createLinePreBeatGlyphs(){let t=!1;if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let e=0;switch(this.bar.clef){case 0:e=this.bar.staff.standardNotationLineCount-1;break;case 3:e=2;break;case 1:e=4;break;case 2:e=2;break;case 4:e=6}this.createStartSpacing(),this.addPreBeatGlyph(new Dd(0,this.getScoreY(e),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new id(0,0,this.smuflMetrics.preBeatGlyphSpacing)),t=!0}(t||0===this.index&&0!==this.bar.keySignature||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this._createKeySignatureGlyphs()),(!this.bar.previousBar||(this.bar.previousBar,this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator)||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createKeySignatureGlyphs(){let t=0,s=this.bar.keySignature,e=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case 0:t=0;break;case 4:t=1;break;case 3:t=3;break;case 1:t=2;break;case 2:t=0}var i,a=new nc,r=(a.gap=this.smuflMetrics.accidentalPadding,a.renderer=this,new Map),n=[];if(F.keySignatureIsSharp(s))for(let e=0;e<Math.abs(s);e++){var o=oc._sharpKsSteps[e]+t;n.push(new kd(0,this.getScoreY(o),2,1)),r.set(o,!0)}else for(let e=0;e<Math.abs(s);e++){var h=oc._flatKsSteps[e]+t;n.push(new kd(0,this.getScoreY(h),3,1)),r.set(h,!0)}if(0===this.bar.keySignature){var l=Math.abs(e),d=F.keySignatureIsSharp(e)?oc._sharpKsSteps:oc._flatKsSteps;for(let e=0;e<l;e++){var c=d[e]+t;r.has(c)||a.addGlyph(new kd(0,this.getScoreY(d[e]+t),1,1))}}for(i of n)a.addGlyph(i);this.addPreBeatGlyph(a),a.isEmpty||this.addPreBeatGlyph(new id(0,0,this.smuflMetrics.preBeatGlyphSpacing))}_createTimeSignatureGlyphs(){var e=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new Ed(0,this.getScoreY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new id(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(e){for(var t of e.beats){t=new rc(t,this.getVoiceContainer(e));t.preNotes=new Zd,t.onNotes=new Kd,this.addBeatGlyph(t)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}completeBeamingHelper(i){if(this.bar.isMultiVoice&&i.highestNoteInHelper&&i.lowestNoteInHelper){let e=0,t=0,s=0;i.hasTuplet&&(s+=2*this.resources.effectFont.size),t=0===i.direction?(e=this.getNoteY(i.highestNoteInHelper,0)-s,this.getNoteY(i.lowestNoteInHelper,3)):(e=this.getNoteY(i.highestNoteInHelper,1),this.getNoteY(i.lowestNoteInHelper,4)+s);for(var a of i.beats)this.helpers.collisionHelper.reserveBeatSlot(a,e,t)}}paintBeamingStem(e,t,s,i,a,r){var n=[];try{z(n,I.beat(r,1,e));r.fillRect(s,i,this.smuflMetrics.stemThickness,a-i)}catch(e){var o=e,h=!0}finally{U(n,o,h)}}},hc=(oc.StaffId="score",oc._sharpKsSteps=[-1,2,-2,1,4,0,3],oc._flatKsSteps=[3,0,4,1,5,2,6],oc),lc=class extends m{get staffId(){return hc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new hc(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showStandardNotation}},dc=class extends md{constructor(e,t,s=!1){super(e.beat,t.beat,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,t,s,i){return this._isLeftHandTap?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(e,t,s,i)}getBeamDirection(e,t){return 1}static getBeamDirectionForNote(e){return 1}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,2)}getEndY(){return this.getStartY()}getStartX(){return this._isLeftHandTap?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,2)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,0)}},cc=class extends To{constructor(){super(...arguments),this._tiedNoteTie=null}createTies(e){var t;e.isVisible&&(!this._tiedNoteTie&&e.isTieOrigin&&e.tieDestination.isVisible&&(t=new dc(e,e.tieDestination,!1),this._tiedNoteTie=t,this.addTie(t)),!this._tiedNoteTie)&&e.isTieDestination&&(t=new dc(e.tieOrigin,e,!0),this._tiedNoteTie=t,this.addTie(t))}},uc=class extends zd{updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){super.internalPaint(e,t,s,17)}},pc=class extends Dh{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.restGlyph=null}get effectElement(){return 18}getNoteX(e,t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let e=s.x;switch(t){case 0:break;case 1:e+=s.width/2;break;case 2:e+=s.width}return e}return 0}buildBoundingsLookup(e,t,s){var i;this.noteHeads&&0<this.container.beat.notes.length&&((i=new ds).note=this.container.beat.notes[0],i.noteHeadBounds=new hs,i.noteHeadBounds.x=t+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i))}getLowestNoteY(){return this.noteHeads?this.noteHeads.y:0}getHighestNoteY(){return this.noteHeads?this.noteHeads.y:0}getNoteY(e,t){let s=null,i=-1;if(this.noteHeads?(s=this.noteHeads,i=$d.getSymbol(e.beat.duration)):this.deadSlapped&&(s=this.deadSlapped),s){let e=this.y+s.y;switch(t){case 1:case 0:e-=s.height/2;break;case 2:break;case 3:case 4:e+=s.height/2;break;case 5:e-=this.renderer.smuflMetrics.stemUp.has(i)?this.renderer.smuflMetrics.stemUp.get(i).bottomY:0;break;case 6:e-=this.renderer.smuflMetrics.stemDown.has(i)?this.renderer.smuflMetrics.stemDown.get(i).topY:0}return e}return 0}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.deadSlapped?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.deadSlapped.x+this.width,this.container.x+this.x+this.deadSlapped.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){var e,t=this.renderer,s=t.getNoteLine(),s=t.getLineY(s);if(this.container.beat.deadSlapped?((e=new Bd).renderer=this.renderer,e.doLayout(),this.deadSlapped=e,this.addEffect(e)):this.container.beat.isEmpty||(this.container.beat.isRest?(e=new uc(0,s,this.container.beat.duration),(this.restGlyph=e).beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.addNormal(e),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)):(e=0!==this.container.beat.graceType,s=new $d(0,s,this.container.beat.duration,e,this.container.beat),(this.noteHeads=s).beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s))),0<this.container.beat.dots)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new wd(0,t.getLineY(t.getNoteLine())-t.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}},mc=class extends fs{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this._isOnlySlash=!t.staff.showTablature&&!t.staff.showStandardNotation,this.helpers.preferredBeamDirection=0}get repeatsBarSubElement(){return 2}get barNumberBarSubElement(){return 6}get barLineBarSubElement(){return 10}get staffLineBarSubElement(){return 22}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,14,15),this.paintTuplets(e,t,s,16)}doLayout(){super.doLayout();let e=!1;for(var t of this.bar.voices)if(this.hasVoiceContainer(t)&&0<this.getVoiceContainer(t).tupletGroups.length){e=!0;break}e&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(e,t){let s=this.smuflMetrics.glyphHeights.get(57603),i=this.getLineY(0)-s/2;return 0===t&&(i-=this.getFlagStemSize(e.duration,!0)),i}getFlagBottomY(e,t){let s=this.smuflMetrics.glyphHeights.get(57603),i=this.getLineY(0)-s/2;return 1===t&&(i+=this.getFlagStemSize(e.duration,!0)),i}getBeamDirection(e){return 0}getNoteY(e,t){let s=super.getNoteY(e,t);return s=Number.isNaN(s)?this.getLineY(0):s}calculateBeamYWithDirection(e,t,s){return this.getLineY(0)-this.getFlagStemSize(e.shortestDuration)}getBarLineStart(e,t){var s=this.smuflMetrics.glyphHeights.get(57603);return this.getLineY(0)-s/2}createLinePreBeatGlyphs(){this._isOnlySlash&&(!this.bar.previousBar||(this.bar.previousBar,this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator)||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new id(0,0,this.smuflMetrics.oneStaffSpace));var e=this.bar.masterBar,e=new Ed(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));e.barSubElement=18,this.addPreBeatGlyph(e)}createVoiceGlyphs(e){for(var t of e.beats){t=new cc(t,this.getVoiceContainer(e));t.preNotes=new Fh,t.onNotes=new(0===e.index?pc:Dh),this.addBeatGlyph(t)}}paintBeamingStem(e,t,s,i,a,r){var n=[];try{z(n,I.beat(r,13,e));var o=r.lineWidth;r.lineWidth=this.smuflMetrics.stemThickness,r.beginPath(),r.moveTo(s,i),r.lineTo(s,a),r.stroke(),r.lineWidth=o}catch(e){var h=e,l=!0}finally{U(n,h,l)}}},gc=(mc.StaffId="slash",class extends m{get staffId(){return mc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new mc(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showSlash}}),fc=class extends w{constructor(e=0,t=0){super(e,t),this.lineValue=0,this.lineValue=t}},bc=class hm extends zt{constructor(){super(0,0),this._notes=[],this._renderPoints=new Map,this._preBendMinValue=-1,this._bendMiddleMinValue=-1,this._bendEndMinValue=-1,this._bendEndContinuedMinValue=-1,this._releaseMinValue=-1,this._releaseContinuedMinValue=-1,this._maxBendValue=-1}addBends(e){this._notes.push(e);var t=this._createRenderingPoints(e);this._renderPoints.set(e.id,t),(-1===this._maxBendValue||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let s=0;switch(e.bendType){case 2:s=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(-1===this._bendEndMinValue||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case 3:s=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):0<s&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case 4:s=t[1].value,(-1===this._bendMiddleMinValue||s<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=s),s=t[2].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):0<s&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case 6:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s);break;case 7:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(-1===this._bendEndMinValue||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case 8:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):0<s&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s)}}doLayout(){super.doLayout();var e,t=this._maxBendValue*this.renderer.smuflMetrics.tabBendPerValueHeight;this.renderer.registerOverflowTop(t);let s=0;for(e of this._notes){var i=this._renderPoints.get(e.id);switch(e.bendType){case 2:i[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case 3:0<=(s=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)&&(i[1].lineValue=s);break;case 4:i[1].lineValue=this._bendMiddleMinValue,0<=(s=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)&&(i[2].lineValue=s);break;case 6:i[0].lineValue=this._preBendMinValue;break;case 7:i[0].lineValue=this._preBendMinValue,i[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case 8:i[0].lineValue=this._preBendMinValue,0<=(s=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)&&(i[1].lineValue=s)}}this.width=0,this._notes.sort((e,t)=>e.isStringed?e.string-t.string:e.realValue-t.realValue)}_createRenderingPoints(e){var t=[];switch(e.bendType){case 1:for(var s of e.bendPoints)t.push(new fc(s.offset,s.value));break;case 4:t.push(new fc(0,e.bendPoints[0].value)),t.push(new fc(w.MaxPosition/2|0,e.bendPoints[1].value)),t.push(new fc(w.MaxPosition,e.bendPoints[3].value));break;case 2:case 5:case 6:case 7:case 8:case 3:t.push(new fc(0,e.bendPoints[0].value)),t.push(new fc(w.MaxPosition,e.bendPoints[1].value))}return t}paint(u,p,m){var g,f=m.color;1<this._notes.length&&(m.color=this.renderer.resources.secondaryGlyphColor);for(g of this._notes){let s=this._renderPoints.get(g.id),e=this.renderer,t=g,i=!1,a=null,r=!1,n=1===g.bendStyle?"grad.":"",o=null;for(;t.isTieOrigin;){var b=t.tieDestination;if(!(a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,b.beat.voice.bar))||e.staff!==a.staff)break;if(t=b,i=!0,t.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||0!==t.vibrato){r=!0;break}}o=t.beat,a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,o.voice.bar),o.isLastOfVoice&&!t.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(o=null);let h=0,l=0,d=p+e.y,c=this.renderer.smuflMetrics.glyphWidths.get(60284);h=u+e.x,0<s[0].value||g.isContinuedBend?h+=e.getBeatX(g.beat,2):h+=e.getNoteX(g,2),l=!o||o.isLastOfVoice&&!r?u+a.x+a.postBeatGlyphsStart:r||!o.nextBeat?u+a.x+a.getBeatX(o,2):5===g.bendType?u+a.x+a.getBeatX(o.nextBeat,1):u+a.x+a.getBeatX(o.nextBeat,0),i||(l-=c);var y,_,S=(l-h)/w.MaxPosition;m.beginPath();for(let e=0,t=s.length-1;e<t;e++){var v=s[e],k=s[e+1];0!==e||0===v.value||g.isTieDestination||this._paintBend(g,new fc(0,0),v,h,d,S,n,m),6!==g.bendType?(0===e&&(h+=this.renderer.smuflMetrics.postNoteEffectPadding),this._paintBend(g,v,k,h,d,S,n,m)):g.isTieOrigin&&g.tieDestination.hasBend&&((k=new fc(w.MaxPosition,v.value)).lineValue=v.lineValue,this._paintBend(g,v,k,h,d,S,n,m))}0!==t.vibrato&&(_=l-u+c-a.x,y=d-p-this.renderer.smuflMetrics.tabBendPerValueHeight*s[s.length-1].lineValue,(_=new Il(_,y,t.vibrato)).beat=t.beat,_.renderer=a,_.doLayout(),_.paint(u+a.x,p,m)),m.color=f}}_paintBend(i,a,r,e,n,o,h,l){let t=this.renderer,d=this.renderer.resources,s=t.lineOffset/2,c=e+o*a.offset,u=this.renderer.smuflMetrics.tabBendPerValueHeight,p=n-u*a.lineValue,m=(0===a.value?r.offset===a.offset?p+=t.getNoteY(i.beat.maxStringNote,1)-s/2:p+=t.getNoteY(i,2):p+=s,e+o*r.offset),g=n-u*r.lineValue,f=(g+=0===r.lineValue?t.getNoteY(i,2):s,0),b=this.renderer.smuflMetrics.glyphWidths.get(60284)??0;if(!(isNaN(b)||isNaN(c)||isNaN(m)||isNaN(p)||isNaN(g))){r.value>a.value?(g+b>p&&(g=p-b),l.beginPath(),l.moveTo(m,g),l.lineTo(m-.5*b,g+b),l.lineTo(m+.5*b,g+b),l.closePath(),l.fill(),f=b):r.value!==a.value&&(g<p&&(g=p+b),l.beginPath(),l.moveTo(m,g),l.lineTo(m-.5*b,g-b),l.lineTo(m+.5*b,g-b),l.closePath(),l.fill(),f=-b);e=l.lineWidth;if(l.lineWidth=this.renderer.smuflMetrics.arrowShaftThickness,l.beginPath(),a.value===r.value){if(0<a.lineValue){let e=m,t=this.renderer.smuflMetrics.tabBendDashSize,s=c+t;if((e-c)/(2*t)<1)l.moveTo(e,p),l.lineTo(c,p);else for(;e>s;)l.moveTo(e,p),l.lineTo(e-t,p),e-=2*t;l.stroke()}}else c<m?(l.moveTo(c,p),l.bezierCurveTo((c+m)/2,p,m,p,m,g+f)):(l.moveTo(c,p),l.lineTo(m,g)),l.stroke();if(h&&a.offset<r.offset){l.font=d.graceFont;let e=l.measureText(h),t=0,s=0;s=p>g?(o=Math.abs(p-g),t=o>e.height?p-o/2:p,(c+m-e.width)/2):(t=p,m-e.width),l.fillText(h,s,t)}if(0!==r.value&&a.value!==r.value){let e=r.value,t=r.value>a.value,s="";if(4===(e=Math.abs(e))?(s="full",e-=4):(4<=e||e<=-4)&&(i=e/4|0,s+=i,e-=4*i),0<e&&(s+=hm.getFractionSign(e)),""!==s){let e=g=n-u*r.value;t||(e=p+ +Math.abs(g-p)/3),l.font=d.tablatureFont;o=l.measureText(s),h=e-o.height/1.5;l.fillText(s,m-o.width/2,h-d.engravingSettings.tabBendLabelPadding)}}l.lineWidth=e}}static getFractionSign(e){switch(e){case 1:return"";case 2:return"";case 3:return"";default:return e+"/ 4"}}},yc=class extends zt{constructor(e,t,s,i){super(0,0),this._inType=e,this._outType=t,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this._paintSlideIn(e,t,s),this._paintSlideOut(e,t,s)}_paintSlideIn(e,t,s){let i=this.renderer,a=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight,n=0,o=0,h=0,l=0,d=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this._inType){case 1:h=e+i.x+i.getNoteX(this._startNote,0)-d,l=t+i.y+i.getNoteY(this._startNote,2)-r,n=h-a,o=t+i.y+i.getNoteY(this._startNote,2)+r;break;case 2:h=e+i.x+i.getNoteX(this._startNote,0)-d,l=t+i.y+i.getNoteY(this._startNote,2)+r,n=h-a,o=t+i.y+i.getNoteY(this._startNote,2)-r;break;default:return}this._paintSlideLine(s,!1,n,h,o,l)}_paintSlideOut(e,t,s){let i=this.renderer,a=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight,n=0,o=0,h=0,l=0,d=!1,c=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this._outType){case 1:case 2:var u;n=e+i.x+i.getBeatX(this._startNote.beat,4)+c,o=t+i.y+i.getNoteY(this._startNote,2),this._startNote.slideTarget?(u=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar),l=u&&u.staff===i.staff?(h=e+u.x+u.getBeatX(this._startNote.slideTarget.beat,1)-c,t+u.y+u.getNoteY(this._startNote.slideTarget,2)):(h=e+i.x+i.width,o),this._startNote.slideTarget.fret>this._startNote.fret?(o+=r,l-=r):(o-=r,l+=r)):(h=e+i.x+this._parent.x,l=o);break;case 3:n=e+i.x+i.getNoteX(this._startNote,2)+c,o=t+i.y+i.getNoteY(this._startNote,2)+r,h=n+a,l=t+i.y+i.getNoteY(this._startNote,2)-r;break;case 4:n=e+i.x+i.getNoteX(this._startNote,2)+c,o=t+i.y+i.getNoteY(this._startNote,2)-r,h=n+a,l=t+i.y+i.getNoteY(this._startNote,2)+r;break;case 5:n=e+i.x+i.getNoteX(this._startNote,2)+2*c,o=t+i.y+i.getNoteY(this._startNote,2),h=e+i.x+i.width,l=o+3*r,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,0)),d=!0;break;case 6:n=e+i.x+i.getNoteX(this._startNote,2)+2*c,o=t+i.y+i.getNoteY(this._startNote,2),h=e+i.x+i.width,l=o-3*r,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,0)),d=!0;break;default:return}this._paintSlideLine(s,d,n,h,o,l)}_paintSlideLine(e,t,s,i,a,r){var n,o,h;t?((t=new Il(0,0,1)).renderer=this.renderer,t.doLayout(),a-=t.height/2,h=i-s,n=(r-=t.height/2)-a,o=Math.sqrt(Math.pow(n,2)+Math.pow(h,2)),t.width=h,h=Math.asin(n/o)*(180/Math.PI),e.beginRotate(s,a,h),t.paint(0,0,e),e.endRotate()):(e.beginPath(),e.moveTo(s,a),e.lineTo(i,r),e.stroke())}},_c=class extends fd{constructor(e,t,s,i=!1){super(e,t,i),this._direction=fd.getBeamDirectionForNote(e),this._forSlide=s}getTieHeight(e,t,s,i){s=Math.max(0,s-e);return Math.log(s+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,t,s,i){if(this._forSlide!==s||this.forEnd!==i||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id||this._direction!==fd.getBeamDirectionForNote(e))return!1;switch(this._direction){case 0:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case 1:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,s){var i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),i=this.getBeamDirection(this.startBeat,i),i=`tab.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.`+i,a=this.renderer;a.staff.getSharedLayoutData(i,!1)||(a.staff.setSharedLayoutData(i,!0),super.paint(e,t,s))}},Sc=class extends To{constructor(){super(...arguments),this._bend=null,this._effectSlurs=[]}drawBeamHelperAsFlags(e){return e.hasFlag(this.renderer.drawBeamHelperAsFlags(e),this.beat)}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(t){if(t.isVisible){var s,i=this.renderer;if(t.isTieOrigin&&i.showTiedNotes&&t.tieDestination.isVisible&&(s=new fd(t,t.tieDestination,!1),this.addTie(s)),t.isTieDestination&&i.showTiedNotes&&(s=new fd(t.tieOrigin,t,!0),this.addTie(s)),t.isLeftHandTapped&&!t.isHammerPullDestination&&(i=new fd(t,t,!1),this.addTie(i)),t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(var a of this._effectSlurs)if(a.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}e||(s=new _c(t,t.effectSlurDestination,!1,!1),this._effectSlurs.push(s),this.addTie(s))}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(var r of this._effectSlurs)if(r.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}e||(i=new _c(t.effectSlurOrigin,t,!1,!0),this._effectSlurs.push(i),this.addTie(i))}0===t.slideInType&&0===t.slideOutType||(s=new yc(t.slideInType,t.slideOutType,t,this),this.addTie(s)),t.hasBend&&(this._bend||(i=new bc,(this._bend=i).renderer=this.renderer,this.addTie(i)),this._bend.addBends(t))}}},vc=class extends zt{constructor(e,t,s){super(e,t),this._noteString=null,this._trillNoteString=null,this._trillNoteStringWidth=0,this.isEmpty=!1,this.noteStringWidth=0,this._note=s}doLayout(){let s=this._note,i=s.fret-s.beat.voice.bar.staff.transpositionPitch;if(1===s.harmonicType&&0!==s.harmonicValue&&(i=s.harmonicValue-s.beat.voice.bar.staff.transpositionPitch),s.isTieDestination)0===s.beat.index&&0===this.renderer.settings.notation.notationMode||(2===s.bendType||4===s.bendType)&&this.renderer.settings.notation.isNotationElementVisible(12)?this._noteString=`(${(s.tieOrigin.fret-s.beat.voice.bar.staff.transpositionPitch).toString()})`:this._noteString="";else{let e=!0;var t,a=s.beat;for(t of a.notes)if(!t.isDeadVisual){e=!1;break}var a=1<=a.brushType&&a.brushType<=4;e&&a?this._noteString="":(a=s.isDead||s.isDeadVisual&&!(e&&a),this._noteString=a?"X":i.toString(),s.isGhost&&(this._noteString=`(${this._noteString})`),1===s.harmonicType&&(0<=(a=this._noteString.indexOf("."))&&(this._noteString=this._noteString.substr(0,a+2)),this._noteString=`<${this._noteString}>`))}if(s.isTrill)this._trillNoteString=`(${(s.trillFret-s.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(F.isAlmostEqualTo(s.harmonicValue,0))this._trillNoteString="";else switch(s.harmonicType){case 2:case 3:case 4:case 5:case 6:let e=(i+s.harmonicValue).toString(),t=e.indexOf(".");0<=t&&(e=e.substr(0,t+2)),this._trillNoteString=`<${e}>`;break;default:this._trillNoteString=""}this.isEmpty=!this._noteString,this.isEmpty||(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont,a=!!this._trillNoteString,this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString+(a?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,a&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString).width,this.width+=this._trillNoteStringWidth))}paint(t,s,i){var a=[];try{if(!this.isEmpty){var r=this.noteStringWidth+this._trillNoteStringWidth;let e=t+this.x+(this.width-r)/2;0!==this._note.beat.graceType&&(e+=2),this.paintTrill(e,s,i);z(a,I.note(i,4,this._note));i.fillText(this._noteString,e,s+this.y)}}catch(e){var n=e,o=!0}finally{U(a,n,o)}}paintTrill(e,t,s){var i=[];try{z(i,I.note(s,4,this._note));var a=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this._trillNoteString,e+this.noteStringWidth,t+this.y),this.renderer.scoreRenderer.canvas.font=a}catch(e){var r=e,n=!0}finally{U(i,r,n)}}buildBoundingsLookup(e,t,s){var i=new ds;i.note=this._note,i.noteHeadBounds=new hs,i.noteHeadBounds.x=t+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}},kc=class extends zt{constructor(e,t,s){super(e,t),this._notes=[],this._deadSlapped=null,this.maxStringNote=null,this.minStringNote=null,this.beatEffects=new Map,this.notesPerString=new Map,this.noteStringWidth=0,this._isGrace=s}buildBoundingsLookup(e,t,s){for(var i of this._notes)i.buildBoundingsLookup(e,t+this.x,s+this.y)}getNoteX(s,i){if(this.notesPerString.has(s.string)){let e=this.notesPerString.get(s.string),t=this.x+e.x;switch(i){case 0:break;case 1:t+=e.noteStringWidth/2;break;case 2:t+=e.width}return t}return 0}getLowestNoteY(){return this.maxStringNote?this.getNoteY(this.maxStringNote,2):0}getHighestNoteY(){return this.minStringNote?this.getNoteY(this.minStringNote,2):0}getNoteY(s,i){if(this.notesPerString.has(s.string)){let e=this.notesPerString.get(s.string),t=this.y+e.y;switch(i){case 1:case 0:t-=e.height/2;break;case 2:break;case 3:case 4:t+=e.height/2}return t}return 0}doLayout(){let a=0;if(this.beat.deadSlapped)this._deadSlapped=new Bd,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),a=this._deadSlapped.width,this.noteStringWidth=a;else{let s=0;for(let e=0,t=this._notes.length;e<t;e++){var r=this._notes[e];r.renderer=this.renderer,r.doLayout(),r.width>a&&(a=r.width),r.noteStringWidth>s&&(s=r.noteStringWidth)}this.noteStringWidth=s;let e=this.renderer.resources.tablatureFont.size,t=this.getNoteY(this.minStringNote,2)+e/2,i=this.renderer.smuflMetrics.onNoteEffectPadding;for(var n of this.beatEffects.values())n.y+=t,n.x+=this.width/2,n.renderer=this.renderer,t+=n.height+i,n.doLayout()}this.width=a}addNoteGlyph(e,t){this._notes.push(e),this.notesPerString.set(t.string,e),(!this.minStringNote||t.string<this.minStringNote.string)&&(this.minStringNote=t),(!this.maxStringNote||t.string>this.maxStringNote.string)&&(this.maxStringNote=t)}paint(e,t,s){if(e+=this.x,t+=this.y,this.beat.deadSlapped)this._deadSlapped?.paint(e,t,s);else{var i=[];try{var a,r=this.renderer.resources,n=s.textBaseline,o=(s.textBaseline=1,s.font=this._isGrace?r.graceFont:r.tablatureFont,this._notes),h=this.width;for(a of o)a.renderer=this.renderer,a.width=h,a.paint(e,t,s);s.textBaseline=n;var l;z(i,I.beat(s,11,this.beat));for(l of this.beatEffects.values())l.paint(e,t,s)}catch(e){var d=e,c=!0}finally{U(i,d,c)}}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}},wc=class extends _o{constructor(e,t,s,i){super(e,t,1,zd.getSymbol(i)),this._isVisibleRest=s}doLayout(){super.doLayout()}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){if(this._isVisibleRest){var i=[];try{z(i,I.beat(s,12,this.beat));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{U(i,a,r)}}}},Tc=class Tc extends zt{constructor(e){super(0,0),this._isSimpleDip=!1,this._beat=e,this._renderPoints=this._createRenderingPoints(e)}_createRenderingPoints(e){if(1===e.whammyBarType)return e.whammyBarPoints;var t=[];switch(e.whammyBarType){case 2:case 4:case 6:case 5:t.push(new w(0,e.whammyBarPoints[0].value)),t.push(new w(w.MaxPosition,e.whammyBarPoints[1].value));break;case 3:t.push(new w(0,e.whammyBarPoints[0].value)),t.push(new w(w.MaxPosition/2|0,e.whammyBarPoints[1].value)),t.push(new w(w.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value))}return t}doLayout(){super.doLayout(),this._isSimpleDip=1===this.renderer.settings.notation.notationMode&&3===this._beat.whammyBarType;let e=null,t=null,s=this._beat;for(;s&&s.hasWhammyBar;)(!e||e.value>s.minWhammyPoint.value)&&(e=s.minWhammyPoint),(!t||t.value<s.maxWhammyPoint.value)&&(t=s.maxWhammyPoint),s=s.nextBeat;let i=0<t.value?Math.abs(this._getOffset(t.value)):0,a=((0<i||0!==this._beat.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(13))&&(i+=this.renderer.resources.tablatureFont.size+this.renderer.smuflMetrics.tabWhammyTextPadding),e.value<0?Math.abs(this._getOffset(e.value)):0),r=this.renderer.staff.getSharedLayoutData(Tc._topOffsetSharedDataKey,-1),n=r,o=(i>r&&(this.renderer.staff.setSharedLayoutData(Tc._topOffsetSharedDataKey,i),n=i),this.renderer.staff.getSharedLayoutData(Tc._bottomOffsetSharedDataKey,-1)),h=o;o<a&&(this.renderer.staff.setSharedLayoutData(Tc._bottomOffsetSharedDataKey,a),h=o),this.height=i+a,this.renderer.registerOverflowTop(n+h)}_getOffset(e){if(0===e)return 0;let t=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(e)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return t=e<0?-t:t}paint(a,o,h){var r=[];try{z(r,I.beat(h,5,this._beat));var l=this.renderer;let e=this._beat.nextBeat,t=null,s=0,n=(e&&(!(t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,e.voice.bar))||t.staff!==l.staff||t!==l&&!e.hasWhammyBar?(e=null,t=null):s=!e.hasWhammyBar||1===l.settings.notation.notationMode&&3===e.whammyBarType?0:2),0),i=0;i=this._isSimpleDip?(n=a+l.x+l.getBeatX(this._beat,1),a+l.x+l.getBeatX(this._beat,4)):(n=a+l.x+l.getBeatX(this._beat,2),t?a+t.x+t.getBeatX(e,s):a+l.x+l.postBeatGlyphsStart);var d=h.textAlign,c=h.textBaseline;if(h.textAlign=1,h.textBaseline=3,2<=this._renderPoints.length){var u=(i-n)/w.MaxPosition;h.beginPath();let e=this.renderer.staff.getSharedLayoutData(Tc._topOffsetSharedDataKey,0),a=o+e,r=1===this._beat.whammyStyle?"grad.":"";for(let i=0,e=this._renderPoints.length-1;i<e;i++){let e=this._renderPoints[i],t=this._renderPoints[i+1],s=0===i;0!==i||0===e.value||this._beat.isContinuedWhammy||(this._paintWhammy(!1,new w(0,0),e,n,a,u,h),s=!1),this._paintWhammy(s,e,t,n,a,u,h,r),r=""}h.stroke()}h.textAlign=d,h.textBaseline=c}catch(e){var t=e,s=!0}finally{U(r,t,s)}}_paintWhammy(s,i,a,r,n,o,h,e){var l=r+o*i.offset,r=r+o*a.offset,d=n-this._getOffset(i.value),o=n-this._getOffset(a.value);if(i.offset===a.offset){var c=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(o-d)/(2*c)<1)h.moveTo(l,d),h.lineTo(r,o);else{let e=Math.max(d,o),t=Math.min(d,o);for(;e>t;)h.moveTo(l,t),h.lineTo(l,t+c),t+=2*c}h.stroke()}else if(i.value===a.value){var u=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(r-l)/(2*u)<1)h.moveTo(l,d),h.lineTo(r,o);else{let e=Math.max(l,r),t=Math.min(l,r);for(;e>t;)h.moveTo(e,d),h.lineTo(e-u,d),e-=2*u}h.stroke()}else h.moveTo(l,d),h.lineTo(r,o);n=this.renderer.smuflMetrics.tabWhammyTextPadding;s&&!this._beat.isContinuedWhammy&&!this._isSimpleDip&&(this.renderer.settings.notation.isNotationElementVisible(13)&&h.fillText("0",l,d-n),e)&&h.fillText(e,l,d-n);let p=Math.abs(a.value);if((0!==p||this.renderer.settings.notation.isNotationElementVisible(13)&&!this._isSimpleDip)&&i.value!==a.value){let e="";a.value<0&&(e+="-"),4<=p?(s=p/4|0,e+=s,p-=4*s):0===p&&(e+="0"),0<p&&(e+=bc.getFractionSign(p));let t=0;t=this._isSimpleDip||i.offset===a.offset?Math.min(d,o):o,h.fillText(e,r,t-n)}}},Bc=(Tc._topOffsetSharedDataKey="tab.whammy.topoffset",Tc._bottomOffsetSharedDataKey="tab.whammy.bottomffset",Tc),xc=class extends Dh{constructor(){super(...arguments),this.slash=null,this.noteNumbers=null,this.restGlyph=null}get effectElement(){return 11}getNoteX(e,t){return this.noteNumbers?this.noteNumbers.getNoteX(e,t):0}getNoteY(e,t){return this.noteNumbers?this.noteNumbers.getNoteY(e,t):0}getLowestNoteY(){return this.noteNumbers?this.noteNumbers.getLowestNoteY():0}getHighestNoteY(){return this.noteNumbers?this.noteNumbers.getHighestNoteY():0}buildBoundingsLookup(e,t,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(e,t+this.x,s+this.y)}doLayout(){var s=this.renderer,i=[];if(this.container.beat.isRest){var a=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),t=s.getTabY(a),a=new wc(0,t,s.showRests,this.container.beat.duration);if((this.restGlyph=a).beat=this.container.beat,a.beamingHelper=this.beamingHelper,this.addNormal(a),0<this.container.beat.dots&&s.showRests)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new wd(0,t))}else{let e=this.renderer.settings.notation.smallGraceTabNotes&&0!==this.container.beat.graceType,t;if(this.container.beat.slashed&&!this.container.beat.notes.some(e=>e.isTieDestination)){var a=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),a=s.getLineY(a),a=new $d(0,a,this.container.beat.duration,e,this.container.beat);a.noteHeadElement=4,a.effectElement=11,(this.slash=a).beat=this.container.beat,a.beamingHelper=this.beamingHelper,this.addNormal(a),t=a.beatEffects}else{var r,a=new kc(0,0,e);(this.noteNumbers=a).beat=this.container.beat,a.beamingHelper=this.beamingHelper;for(r of this.container.beat.notes)r.isVisible&&this._createNoteGlyph(r);this.addNormal(a),t=a.beatEffects}if(this.container.beat.hasWhammyBar&&((a=new Bc(this.container.beat)).renderer=this.renderer,a.doLayout(),this.container.ties.push(a)),this.container.beat.isTremolo&&!t.has("tremolo")&&(a=this.container.beat.tremoloSpeed,(a=new Hd(0,0,a)).offsetY=this.renderer.smuflMetrics.glyphTop.get(a.symbol),t.set("tremolo",a),i.push(a)),0<this.container.beat.dots&&0!==s.rhythmMode)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new wd(0,s.lineOffset*s.bar.staff.tuning.length+s.settings.notation.rhythmHeight))}if(!this.isEmpty){let s=0;for(let e=0,t=this.glyphs.length;e<t;e++){var n=this.glyphs[e];n.x=s,n.renderer=this.renderer,n.doLayout(),s+=n.width}this.width=s,this.computedWidth=s,this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2);for(var e of i)e.x=this.centerX}}updateBeamingHelper(){this.noteNumbers?this.noteNumbers.updateBeamingHelper(this.container.x+this.x):this.restGlyph?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}_createNoteGlyph(e){var t=this.renderer,s=new vc(0,0,e),i=e.beat.voice.bar.staff.tuning.length-e.string,t=(s.y=t.getTabY(i),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,e),s.y-s.height/2),i=t+s.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,t,i)}},Pc=class extends zt{constructor(e){super(0,0),this._beat=e}doLayout(){var e;this.width=this.renderer.smuflMetrics.glyphWidths.get(60284),3===this._beat.brushType?((e=new Il(0,0,1,!0)).renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e):4===this._beat.brushType&&((e=new Il(0,0,1,!0)).renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e)}paint(e,s,i){let t=this.renderer,a=s+this.x+t.getNoteY(this._beat.maxStringNote,1)-4,r=s+this.y+t.getNoteY(this._beat.minStringNote,3)-4,n=!0;for(var o of this._beat.notes)if(!o.isDeadVisual){n=!1;break}var h=e+this.x+this.width/2+(n?8:0),s=this.renderer.smuflMetrics.glyphWidths.get(60284);if(0!==this._beat.brushType){if(1===this._beat.brushType||2===this._beat.brushType)i.beginPath(),i.moveTo(h,a),i.lineTo(h,10+r),i.stroke();else if(3===this._beat.brushType){var l,d=a,e=r-s+10,c=Math.floor(Math.abs(e-d)/5);i.beginPath(),i.moveTo(h,d);let t=d;for(let e=1;e<=c;e++){var u=d+5*e;e%2==1?i.quadraticCurveTo(h-3,u-2.5,h,u):i.quadraticCurveTo(h+3,u-2.5,h,u),t=u}t<e&&(l=e-t,i.quadraticCurveTo(c%2==1?h+3:h-3,t+l/2,h,e)),i.stroke()}else if(4===this._beat.brushType){var p=a+s,m=Math.floor(Math.abs(10+r-p)/5);i.beginPath(),i.moveTo(h,p);for(let e=1;e<=m;e++){var g=p+5*e;e%2==1?i.quadraticCurveTo(h+3,g-2.5,h,g):i.quadraticCurveTo(h-3,g-2.5,h,g)}i.stroke()}1===this._beat.brushType||3===this._beat.brushType?(i.beginPath(),i.moveTo(h+s/2,10+r-s),i.lineTo(h,10+r),i.lineTo(h-s/2,10+r-s),i.stroke(),i.beginPath(),i.moveTo(h,10+r),i.lineTo(h,10+r-s)):(i.beginPath(),i.moveTo(h+s/2,a+s),i.lineTo(h,a),i.lineTo(h-s/2,a+s),i.stroke(),i.beginPath(),i.moveTo(h,a),i.lineTo(h,a+s)),i.stroke()}}},Nc=class extends Fh{doLayout(){0===this.container.beat.brushType||this.container.beat.isRest||(this.addEffect(new Pc(this.container.beat)),this.addNormal(new id(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return 11}},Mc=class extends _o{constructor(e,t){super(e,t,1,57453)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?57454:57453,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(57424),this.offsetX=this.width/2}},Ec=class extends ys{doLayout(){this.barSubElement=17,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?ko.GraceScale:1}},Lc=class extends fs{constructor(e,t){super(e,t),this._hasTuplets=!1,this.showTimeSignature=!1,this.showRests=!1,this.showTiedNotes=!1,this._showMultiBarRest=!1,t.staff.showStandardNotation||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this._showMultiBarRest=!0)}get showMultiBarRest(){return this._showMultiBarRest}get repeatsBarSubElement(){return 1}get barNumberBarSubElement(){return 5}get barLineBarSubElement(){return 9}get staffLineBarSubElement(){return 21}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let e=this.settings.notation.rhythmMode;return e=3===e?this.bar.staff.showStandardNotation?0:2:e}getTabY(e){return super.getLineY(e)}getTabHeight(e){return super.getLineHeight(e)}collectSpaces(e){var t,s=this.smuflMetrics.staffLineThickness;for(t of this.bar.voices)if(this.hasVoiceContainer(t)){var i,a=this.getVoiceContainer(t);for(i of a.beatGlyphs){var r=i.onNotes,n=r.noteNumbers;if(n)for(var[o,h]of n.notesPerString)h.isEmpty||e[this.bar.staff.tuning.length-o].push(new Float32Array([a.x+i.x+r.x+n.x-s,n.width+2*s]))}}}adjustSizes(){if(0!==this.rhythmMode){let e=1;for(var t of this.helpers.beamHelpers)for(var s of t)s.tremoloDuration&&(!e||e<s.tremoloDuration)&&(e=s.tremoloDuration);switch(e){case 8:this.height+=this.smuflMetrics.glyphHeights.get(57888);break;case 16:this.height+=this.smuflMetrics.glyphHeights.get(57889);break;case 32:this.height+=this.smuflMetrics.glyphHeights.get(57890)}this.height+=this.settings.notation.rhythmHeight,this.bottomPadding+=this.settings.notation.rhythmHeight}}doLayout(){if(super.doLayout(),0!==this.rhythmMode){this._hasTuplets=!1;for(var e of this.bar.voices)if(this.hasVoiceContainer(e)&&0<this.getVoiceContainer(e).tupletGroups.length){this._hasTuplets=!0;break}this._hasTuplets&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){var e;this.isFirstOfLine&&(e=(this.bar.staff.tuning.length-1)/2,this.createStartSpacing(),this.addPreBeatGlyph(new Mc(0,this.getTabY(e)))),this.showTimeSignature&&(!this.bar.previousBar||(this.bar.previousBar,this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator)||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new id(0,0,this.smuflMetrics.oneStaffSpace));var e=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new Ec(0,this.getTabY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){if(this.additionalMultiRestBars){var t=new Oh(this.getVoiceContainer(e));this.addBeatGlyph(t)}else for(var s of e.beats){s=new Sc(s,this.getVoiceContainer(e));s.preNotes=new Nc,s.onNotes=new xc,this.addBeatGlyph(s)}}paint(e,t,s){super.paint(e,t,s),0!==this.rhythmMode&&(this.paintBeams(e,t,s,8,9),this.paintTuplets(e,t,s,10))}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||1===this.rhythmMode}getFlagTopY(e,t){var s=this.getOnNotesGlyphForBeat(e);return s.noteNumbers&&2!==e.duration?s.noteNumbers.getNoteY(s.noteNumbers.minStringNote,3)+this.smuflMetrics.staffLineThickness:this.height-this.settings.notation.rhythmHeight-this.tupletSize}getFlagBottomY(e,t){return this.getFlagAndBarPos()}getFlagStemSize(e,t=0){return 0}getBarLineStart(e,t){return this.getFlagTopY(e,t)}getBeamDirection(e){return 1}getFlagAndBarPos(){return this.height-(this._hasTuplets?this.tupletSize/2:0)}calculateBeamYWithDirection(e,t,s){return this.getFlagAndBarPos()}shouldPaintFlag(e,t){return!(!super.shouldPaintFlag(e,t)||0!==e.graceType)&&this.drawBeamHelperAsFlags(t)}paintBeamingStem(e,i,a,r,n,o){var h=[];try{var l;n<r&&(l=n,n=r,r=l),z(h,I.beat(o,7,e));let t=[],s=(this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(t=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice()).sort((e,t)=>e.topY-t.topY),n);for(;s>r;){let e=r+8;if(!(0<t.length&&t[t.length-1].bottomY>e)){o.fillRect(a,e,this.smuflMetrics.stemThickness,s-e);break}var d=t.pop();e=i+d.bottomY,o.fillRect(a,e,this.smuflMetrics.stemThickness,s-e),s=i+d.topY}}catch(e){var t=e,s=!0}finally{U(h,t,s)}}},Cc=(Lc.StaffId="tab",class extends m{constructor(){super(),this.showTimeSignature=null,this.showRests=null,this.showTiedNotes=null,this.hideOnPercussionTrack=!0}get staffId(){return Lc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}canCreate(e,t){return t.showTablature&&0<t.tuning.length&&super.canCreate(e,t)}create(e,t){e=new Lc(e,t);return null!==this.showRests&&(e.showRests=this.showRests),null!==this.showTimeSignature&&(e.showTimeSignature=this.showTimeSignature),null!==this.showTiedNotes&&(e.showTiedNotes=this.showTiedNotes),e}}),Fc={},Dc=class{constructor(e,t){this.vertical=e,this.createLayout=t}},Ic=class{constructor(e,t){this.supportsWorkers=e,this.createCanvas=t}},P=class P{static get globalThis(){if(void 0===P._globalThis){try{P._globalThis=globalThis}catch{}"u"<typeof P._globalThis&&(P._globalThis=self),"u"<typeof P._globalThis&&(P._globalThis=global),"u"<typeof P._globalThis&&(P._globalThis=window),"u"<typeof P._globalThis&&(P._globalThis=Function("return this")())}return P._globalThis}static get isRunningInWorker(){return"WorkerGlobalScope"in P.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in P.globalThis}static throttle(e,t){let s=0;return()=>{P.globalThis.clearTimeout(s),s=P.globalThis.setTimeout(e,t)}}static _detectScriptFile(){var e;if(!P.isRunningInWorker&&P.globalThis.ALPHATAB_ROOT)return e=P.globalThis.ALPHATAB_ROOT,e=P.ensureFullUrl(e),P._appendScriptName(e);try{var t=Fc.url;if(t&&-1===t.indexOf("file://"))return t}catch{}return"document"in P.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(s){if(!s)return"";if(s.startsWith("http")||s.startsWith("https")||s.startsWith("file"))return s;{let e="",t=P.globalThis.location;var i;return e=e+t.protocol?.toString()+"//",t.hostname&&(e+=t.hostname?.toString()),t.port&&(e=(e+=":")+t.port?.toString()),s.startsWith("/")||0<(i=t.pathname.split("/").slice(0,-1).join("/")).length&&(i.startsWith("/")||(e+="/"),e+=i?.toString()),s.startsWith("/")||(e+="/"),e+=s?.toString()}}static _appendScriptName(e){return e&&!e.endsWith(".js")&&(e.endsWith("/")||(e+="/"),e+="alphaTab.js"),e}static _detectFontDirectory(){if(!P.isRunningInWorker&&P.globalThis.ALPHATAB_FONT)return P.ensureFullUrl(P.globalThis.ALPHATAB_FONT);var e=P.scriptFile;if(e){var t=e.lastIndexOf("/");if(0<=t)return e.substr(0,t)+"/font/"}return null}static _registerJQueryPlugin(){if(!P.isRunningInWorker&&P.globalThis&&"jQuery"in P.globalThis){let e=P.globalThis.jQuery,a=new Zo;e.fn.alphaTab=function(s){let i=Array.prototype.slice.call(arguments,1);return 1===this.length?a.exec(this[0],s,i):this.each((e,t)=>{a.exec(t,s,i)})},e.alphaTab={restore:Zo.restore},e.fn.alphaTab.fn=a}}static getRenderEngineFactory(e){return e&&P.renderEngines.has(e)?P.renderEngines.get(e):P.renderEngines.get("default")}static getLayoutEngineFactory(e){return e&&P.layoutEngines.has(e)?P.layoutEngines.get(e):P.layoutEngines.get(0)}static buildImporters(){return[new ai,new Ti,new yi,new Fi,new si,new Ns]}static _createDefaultRenderEngines(){var e=new Map;return e.set("svg",new Ic(!0,()=>new ih)),e.set("default",e.get("svg")),e.set("skia",new Ic(!1,()=>new th)),P._createPlatformSpecificRenderEngines(e),e}static enableAlphaSkia(e,t){th.enable(e,t)}static registerAlphaSkiaCustomFont(e){return th.registerFont(e)}static _createPlatformSpecificRenderEngines(e){e.set("html5",new Ic(!1,()=>new to))}static _createDefaultRenderers(){return[new Yh(P._staffIdBeforeSlashAlways,[new zl,new ql,new Bl,new nl,new Jh,new fl,new Ul,new Qh,new el]),new gc,new Yh(P._staffIdBeforeScoreAlways,[new ul,new $h,new Pl,new Dl,new $l]),new Yh(P._staffIdBeforeScoreHideable,[new Kl,new Xl,new Ml(!0),new Ql,new Rl,new Zl,new Ol(!1),new vl,new yl(2)],(e,t)=>t.showStandardNotation),new lc,new Yh(P._staffIdBeforeNumberedAlways,[new sl,new Ml(!1),new hl,new yl(1,(e,t)=>t.voice.bar.staff.showStandardNotation),new Wl]),new Fd,new Yh(P._staffIdBeforeTabAlways,[new Tl]),new Yh(P._staffIdBeforeTabHideable,[new Xl,new Ql,new Rl,new Zl,new Ol(!0),new Hl,new dl,new _l(1),new _l(2),new _l(3),new _l(4),new _l(5),new _l(6),new kl,new Zh,new gl,new El,new Fl,new Ll,new vl,new yl(2,(e,t)=>!t.voice.bar.staff.showStandardNotation)],(e,t)=>t.showTablature),new Cc,new Yh(P._staffIdBeforeEndAlways,[new yl(1,(e,t)=>!t.voice.bar.staff.showStandardNotation)])]}static _createDefaultStaveProfiles(){var e=new Map,t=P._createDefaultRenderers();e.set(0,t),e.set(1,t);let s=new Set([P._staffIdBeforeSlashAlways,P._staffIdBeforeScoreAlways,P._staffIdBeforeNumberedAlways,P._staffIdBeforeTabAlways,hc.StaffId,P._staffIdBeforeEndAlways]),i=(e.set(2,t.filter(e=>s.has(e.staffId))),new Set([P._staffIdBeforeSlashAlways,P._staffIdBeforeScoreAlways,P._staffIdBeforeNumberedAlways,P._staffIdBeforeTabAlways,Lc.StaffId,P._staffIdBeforeEndAlways]));return e.set(3,P._createDefaultRenderers().filter(e=>{var t;return e instanceof Cc&&((t=e).showTimeSignature=!0,t.showRests=!0,t.showTiedNotes=!0),i.has(e.staffId)})),e.set(4,P._createDefaultRenderers().filter(e=>{var t;return e instanceof Cc&&((t=e).showTimeSignature=!1,t.showRests=!1,t.showTiedNotes=!1),i.has(e.staffId)})),e}static _createDefaultLayoutEngines(){var e=new Map;return e.set(0,new Dc(!0,e=>new sd(e))),e.set(1,new Dc(!1,e=>new td(e))),e}static initializeMain(e,t){P.isRunningInWorker||P.isRunningInAudioWorklet||(0!==P.webPlatform&&2!==P.webPlatform||(P._registerJQueryPlugin(),P.highDpiFactor=window.devicePixelRatio),P.createWebWorker=e,P.createAudioWorklet=t)}static get alphaTabWorker(){return P.globalThis.Worker}static get alphaTabUrl(){return P.globalThis.URL}static initializeWorker(){if(!P.isRunningInWorker)throw new b(0,"Not running in worker, cannot run worker initialization");eo.init(),jn.init(),P.createWebWorker=e=>{throw new b(0,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!P.isRunningInAudioWorklet)throw new b(0,"Not running in audio worklet, cannot run worklet initialization");zi.init()}static _detectWebPack(){try{if("function"==typeof __webpack_require__)return!0}catch{}return!1}static _detectVite(){try{if("string"==typeof __BASE__)return!0}catch{}return!1}static _detectWebPlatform(){if(!(typeof P.globalThis.Window<"u"&&P.globalThis instanceof P.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call(typeof process<"u"?process:0))return 1}catch{}try{var e=Fc.url;if(e&&"string"==typeof e&&!e.startsWith("file://"))return 2}catch{}return 0}static printEnvironmentInfo(e=!0){e=e?e=>{M.log.debug("VersionInfo",e)}:e=>{M.debug("VersionInfo",e)};J.print(e),e("High DPI: "+P.highDpiFactor),P._printPlatformInfo(e)}static _printPlatformInfo(e){e("Platform: "+$n[P.webPlatform]),e("WebPack: "+P.isWebPackBundled),e("Vite: "+P.isViteBundled),1!==P.webPlatform&&(e("Browser: "+navigator.userAgent),e(`Window Size: ${window.outerWidth}x`+window.outerHeight),e(`Screen Size: ${window.screen.width}x`+window.screen.height))}static prepareForPostMessage(e){if(e&&"object"==typeof e){var t=e.__v_raw;if(t)return P.prepareForPostMessage(t)}return e}static quoteJsonString(e){return JSON.stringify(e)}},E=(P._staffIdBeforeSlashAlways="before-slash-always",P._staffIdBeforeScoreAlways="before-score-always",P._staffIdBeforeScoreHideable="before-score-hideable",P._staffIdBeforeNumberedAlways="before-numbered-always",P._staffIdBeforeTabAlways="before-tab-always",P._staffIdBeforeTabHideable="before-tab-hideable",P._staffIdBeforeEndAlways="before-end-always",P.highDpiFactor=1,P._globalThis=void 0,P.webPlatform=P._detectWebPlatform(),P.isWebPackBundled=P._detectWebPack(),P.isViteBundled=P._detectVite(),P.scriptFile=P._detectScriptFile(),P.fontDirectory=P._detectFontDirectory(),P.renderEngines=P._createDefaultRenderEngines(),P.layoutEngines=P._createDefaultLayoutEngines(),P.staveProfiles=P._createDefaultStaveProfiles(),P),Ac=((Fs=Ac||{})[Fs.EmbeddedOpenType=0]="EmbeddedOpenType",Fs[Fs.Woff=1]="Woff",Fs[Fs.Woff2=2]="Woff2",Fs[Fs.OpenType=3]="OpenType",Fs[Fs.TrueType=4]="TrueType",Fs[Fs.Svg=5]="Svg",Fs),Rc=class{constructor(){this.scriptFile=null,this.fontDirectory=null,this.smuflFontSources=null,this.file=null,this.tex=!1,this.tracks=null,this.enableLazyLoading=!0,this.engine="default",this.logLevel=2,this.useWorkers=!0,this.includeNoteBounds=!1,this.scriptFile=E.scriptFile,this.fontDirectory=E.fontDirectory}static buildDefaultSmuflFontSources(e){var t=new Map,e=e??"";return t.set(2,e+"Bravura.woff2"),t.set(1,e+"Bravura.woff"),t.set(3,e+"Bravura.otf"),t}},Oc={},Vc=(G(Oc,{AlphaTexErrorWithDiagnostics:()=>xs,AlphaTexImporter:()=>Ns,ScoreImporter:()=>ws,ScoreLoader:()=>Ao,UnsupportedFormatError:()=>Ts,alphaTex:()=>Vc}),{}),Wc=(G(Vc,{AlphaTexAccidentalMode:()=>Ct,AlphaTexDiagnosticBag:()=>Et,AlphaTexDiagnosticCode:()=>Mt,AlphaTexDiagnosticsSeverity:()=>Nt,AlphaTexLexer:()=>vs,AlphaTexNodeType:()=>Rt,AlphaTexParser:()=>ks,AlphaTexStaffNoteKind:()=>Ft}),{}),Hc=(G(Wc,{ByteBuffer:()=>Bs,IOHelper:()=>f}),{}),Gc=(G(Hc,{AlphaTexExporter:()=>Yc,Gp7Exporter:()=>hu,ScoreExporter:()=>Gc}),class{init(e,t){this.data=e,this.settings=t}export(e,t=null){var s=Bs.withCapacity(1024);return this.init(s,t??new Sn),this.writeScore(e),s.toArray()}}),zc=class{constructor(){this.tex="",this.isStartOfLine=!0,this.indentString="",this.currentIndent=0}indent(){0<this.indentString.length&&this.currentIndent++}outdent(){0<this.indentString.length&&this.currentIndent--}_preWrite(){if(this.isStartOfLine&&0<this.indentString.length)for(let e=0;e<this.currentIndent;e++)this.tex+=this.indentString;this.isStartOfLine=!1}write(e){this._preWrite(),this.tex+=e,this.isStartOfLine=!1}writeString(e){this._preWrite(),this.tex+=E.quoteJsonString(e)}writeLine(e){this._preWrite(),void 0!==e&&(this.tex+=e),0<this.indentString.length?this.tex+=`
`:this.tex.endsWith(" ")||(this.tex+=" "),this.isStartOfLine=!0}},Uc=class{constructor(e){this._comments=!1,this._trackIndex=0,this._staffIndex=0,this._voiceIndex=0;var t=new zc;this._comments=e.exporter.comments,t.indentString=0<e.exporter.indent?" ".repeat(e.exporter.indent):"",this._writer=t}get tex(){return this._writer.tex}writeScoreNode(e){this._writeComments(e.leadingComments);for(var t of e.bars)this._writeBar(t);this._writeComments(e.trailingComments)}_writeBar(e){this._writeComments(e.leadingComments),this._writeMetaDataList(e.metaData),this._writer.indent();for(var t of e.beats)this._writeBeat(t);this._writer.outdent(),this._writeComments(e.trailingComments),this._writeToken(e.pipe,!0)}_writeBeat(e){this._writeComments(e.leadingComments),e.durationChange&&this._writeDurationChange(e.durationChange),e.rest?this._writeValue(e.rest):e.notes&&this._writeNotes(e.notes),this._writeToken(e.durationDot,!1),this._writeValue(e.durationValue),this._writeToken(e.beatMultiplier,!1),this._writeValue(e.beatMultiplierValue),e.beatEffects&&this._writeProperties(e.beatEffects,!1),this._writeComments(e.trailingComments),this._writer.writeLine()}_writeNotes(e){this._writeComments(e.leadingComments),this._writeToken(e.openParenthesis,!1);let t=!0;for(var s of e.notes)t||this._writer.write(" "),this._writeNote(s),t=!1;this._writeToken(e.closeParenthesis,!1),this._writeComments(e.trailingComments)}_writeNote(e){this._writeComments(e.leadingComments),this._writeValue(e.noteValue),this._writeToken(e.noteStringDot,!1),this._writeValue(e.noteString),e.noteEffects&&this._writeProperties(e.noteEffects,!1),this._writeComments(e.trailingComments)}_writeDurationChange(e){this._writeComments(e.leadingComments),this._writeToken(e.colon,!1),this._writeValue(e.value),e.properties&&(this._writer.write(" "),this._writeProperties(e.properties,!1)),this._writeComments(e.trailingComments),this._writer.write(" ")}_writeMetaDataList(e){for(var t of e)this._writeMetaData(t)}_writeMetaData(e){switch(e.tag.tag.text){case"track":0<this._trackIndex&&this._writer.outdent();break;case"staff":0<this._staffIndex&&this._writer.outdent();break;case"voice":0<this._voiceIndex&&this._writer.outdent()}this._writeComments(e.leadingComments),this._writeToken(e.tag.prefix,!1),this._writeValue(e.tag.tag);let t=!0;switch(e.propertiesBeforeValues?(e.properties&&(this._writer.write(" "),this._writeProperties(e.properties,!1)),e.values&&(this._writer.write(" "),this._writeValues(e.values))):(e.values&&(this._writer.write(" "),this._writeValues(e.values)),e.properties&&(this._writer.write(" "),this._writeProperties(e.properties,!0),t=!1)),e.trailingComments&&(this._writer.write(" "),this._writeComments(e.trailingComments)),e.tag.tag.text){case"track":this._trackIndex++,this._staffIndex=0,this._voiceIndex=0,this._writer.indent();break;case"staff":this._staffIndex++,this._voiceIndex=0,this._writer.indent();break;case"voice":this._voiceIndex++,this._writer.indent()}t&&this._writer.writeLine()}_writeProperties(e,t){this._writeComments(e.leadingComments),this._writeToken(e.openBrace,t),t&&this._writer.indent();let s=!0;for(var i of e.properties)s||t||this._writer.write(" "),this._writeProperty(i),s=!1,t&&this._writer.writeLine();t&&this._writer.outdent(),this._writeToken(e.closeBrace,t),this._writeComments(e.trailingComments)}_writeProperty(e){this._writeComments(e.leadingComments),this._writeValue(e.property),e.values&&(this._writer.write(" "),this._writeValues(e.values)),this._writeComments(e.trailingComments)}_writeValues(e){this._writeComments(e.leadingComments),this._writeToken(e.openParenthesis,!1);let t=!0;for(var s of e.values)t||this._writer.write(" "),this._writeValue(s),t=!1;this._writeToken(e.closeParenthesis,!1),this._writeComments(e.trailingComments)}_writeValue(e){if(e){switch(this._writeComments(e.leadingComments),e.nodeType){case 10:this._writer.write(e.text);break;case 13:this._writeValues(e);break;case 16:this._writer.write(e.value.toString());break;case 17:this._writer.writeString(e.text)}this._writeComments(e.trailingComments)}}_writeToken(e,t){if(e){switch(this._writeComments(e.leadingComments),e.nodeType){case 0:this._writer.write(".");break;case 1:this._writer.write("\\");break;case 2:this._writer.write("\\\\");break;case 3:this._writer.write("|");break;case 4:this._writer.write("{");break;case 5:this._writer.write("}");break;case 6:this._writer.write("(");break;case 7:this._writer.write(")");break;case 8:this._writer.write(":");break;case 9:this._writer.write("*")}this._writeComments(e.trailingComments),t&&this._writer.writeLine()}}_writeComments(e){if(this._comments&&e)for(var t of e){let e=t.text;e.startsWith(" ")||(e=" "+e),t.multiLine?(e.endsWith(" ")||(e+=" "),this._writer.write(`/*${e}*/`)):this._writer.writeLine("//"+e)}}},Yc=class extends Gc{constructor(){super(...arguments),this._handler=gs.instance}get name(){return"alphaTex"}exportToString(e,t=null){return this.settings=t??new Sn,this.scoreToAlphaTexString(e)}writeScore(e){e=f.stringToBytes(this.scoreToAlphaTexString(e));this.data.write(e,0,e.length)}scoreToAlphaTexString(e){var t=new Uc(this.settings);return t.writeScoreNode(this._score(e)),t.tex}_score(e){var t,s={nodeType:18,bars:[]};for(t of e.tracks)this._track(s,t);return 0===s.bars.length?s.bars.push({nodeType:19,metaData:this._handler.buildScoreMetaDataNodes(e),beats:[]}):s.bars[0].metaData=this._handler.buildScoreMetaDataNodes(e).concat(s.bars[0].metaData),s.bars.push({nodeType:19,metaData:this._handler.buildSyncPointNodes(e),beats:[]}),s}_track(e,t){for(var s of t.staves)this._staff(e,s)}_staff(t,s){var i=Math.max(...s.filledVoices)+1;if(0===s.bars.length){var e={nodeType:19,metaData:this._handler.buildBarMetaDataNodes(s,void 0,0,!1),beats:[],pipe:void 0};t.bars.push(e)}else for(let e=0;e<i;e++)this._voice(t,e,s,1<i)}_voice(e,t,s,i){for(var a of s.bars)this._bar(e,a,t,i)}_bar(e,t,s,i){var a={nodeType:19,metaData:this._handler.buildBarMetaDataNodes(t.staff,t,s,i),beats:[],pipe:void 0};if(t.isEmpty)a.trailingComments=[{multiLine:!1,text:`Bar ${t.index+1} / Voice ${s+1} no contents`}];else{var i=t.voices[s];if(i.isEmpty)a.trailingComments=[{multiLine:!1,text:`Bar ${t.index+1} / Voice ${s+1} no contents`}];else{for(var r of i.beats)a.beats.push(this._beat(r));0<a.beats.length&&((i=a.beats[0]).leadingComments??(i.leadingComments=[]),a.beats[0].leadingComments.unshift({multiLine:!1,text:`Bar ${t.index+1} / Voice ${s+1} contents`}))}}t.index<t.staff.bars.length-1&&(a.pipe={nodeType:3}),e.bars.push(a)}_beat(e){var t={nodeType:20,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0};return e.isRest?t.rest={nodeType:10,text:"r"}:t.notes=this._notes(e.notes),t.durationDot={nodeType:0},t.durationValue={nodeType:16,value:e.duration},t.beatEffects=this._beatEffects(e),t}_beatEffects(e){e=this._handler.buildBeatEffects(e);return 0<e.length?{nodeType:14,openBrace:{nodeType:4},properties:e,closeBrace:{nodeType:5}}:void 0}_notes(e){var t,s={nodeType:22,openParenthesis:void 0,notes:[],closeParenthesis:void 0};(0===e.length||1<e.length)&&(s.openParenthesis={nodeType:6},s.closeParenthesis={nodeType:7});for(t of e)s.notes.push(this._note(t));return s}_note(e){var t={nodeType:23,noteValue:{nodeType:10,text:""}};if(e.isPercussion)t.noteValue={nodeType:17,text:rt.getArticulationName(e)};else if(e.isPiano)t.noteValue={nodeType:10,text:qt.getTextForTuning(e.realValueWithoutHarmonic,!0)};else{if(!e.isStringed)throw new Error("What kind of note");t.noteValue={nodeType:16,value:e.fret},t.noteStringDot={nodeType:0};var s=e.beat.voice.bar.staff.tuning.length-e.string+1;t.noteString={nodeType:16,value:s}}return t.noteEffects=this._noteEffects(e),t}_noteEffects(e){e=this._handler.buildNoteEffects(e);return 0<e.length?{nodeType:14,openBrace:{nodeType:4},properties:e,closeBrace:{nodeType:5}}:void 0}},y=class{constructor(e,t,s=null){this.icon=10,this.icon=e,this.instrumentSetName=t,s?this.instrumentSetType=s:((e=t.split(" "))[0]=e[0].substr(0,1).toLowerCase()+e[0].substr(1),this.instrumentSetType=e.join(""))}},Xc=class Xc{constructor(){this._rhythmIdLookup=new Map}writeXml(e){var t=new Gs;return this._rhythmIdLookup=new Map,this._writeDom(t,e),t.toFormattedString("",!0)}_writeDom(e,t){var s,e=e.addElement("GPIF"),i=(e.addElement("GPVersion").innerText="8.1.3",e.addElement("GPRevision")),i=(i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007",e.addElement("Encoding")),a=(i.addElement("EncodingDescription").innerText="GP8",new Os),r=(a.nodeType=6,a.value=`Written by alphaTab ${J.version} (${J.commit})`,i.addChild(a),this._writeScoreNode(e,t),this._writeMasterTrackNode(e,t),this._writeBackingTrackNode(e,t),this._writeAudioTracksNode(e,t),this._writeTracksNode(e,t),this._writeMasterBarsNode(e,t),this._writeAssets(e,t),e.addElement("Bars")),n=e.addElement("Voices"),o=e.addElement("Beats"),h=e.addElement("Notes"),l=e.addElement("Rhythms");for(s of t.tracks)for(var d of s.staves)for(var c of d.bars){this._writeBarNode(r,c);for(var u of c.voices){this._writeVoiceNode(n,u);for(var p of u.beats){this._writeBeatNode(o,p,l);for(var m of p.notes)this._writeNoteNode(h,m)}}}}_writeAssets(e,t){t.backingTrack?.rawAudioFile&&((t=e.addElement("Assets").addElement("Asset")).attributes.set("id",this._backingTrackAssetId),this.backingTrackAssetFileName="Content/Assets/backing-track",t.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName))}_writeBackingTrackNode(e,t){t.backingTrack?.rawAudioFile&&(t=e.addElement("BackingTrack"),this._backingTrackAssetId="0",t.addElement("IconId").innerText="21",t.addElement("Color").innerText="0 0 0",t.addElement("Name").setCData("Audio Track"),t.addElement("ShortName").setCData("a.track"),t.addElement("PlaybackState").innerText="Default",t.addElement("Enabled").innerText="true",t.addElement("Source").innerText="Local",t.addElement("AssetId").innerText="0",(e=t.addElement("ChannelStrip")).addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",e.addElement("YouTubeVideoUrl").innerText="",e.addElement("Filter").innerText="6",e.addElement("FramesPerPixel").innerText="400",e=void 0!==this._backingTrackFramePadding?this._backingTrackFramePadding:0,t.addElement("FramePadding").innerText=""+e,t.addElement("Semitones").innerText="0",t.addElement("Cents").innerText="0")}_writeNoteNode(e,t){var s=e.addElement("Note");s.attributes.set("id",t.id.toString()),this._writeNoteProperties(s,t),t.isGhost&&(s.addElement("AntiAccent").innerText="normal"),t.isLetRing&&s.addElement("LetRing"),t.isTrill&&(s.addElement("Trill").innerText=t.trillValue.toString());let i=0;switch(t.isStaccato&&(i|=1),t.accentuated){case 1:i|=8;break;case 2:i|=4;break;case 3:i|=16}switch(0<i&&(s.addElement("Accent").innerText=i.toString()),(t.isTieOrigin||t.isTieDestination)&&((e=s.addElement("Tie")).attributes.set("origin",t.isTieOrigin?"true":"false"),e.attributes.set("destination",t.isTieDestination?"true":"false")),t.vibrato){case 1:s.addElement("Vibrato").innerText="Slight";break;case 2:s.addElement("Vibrato").innerText="Wide"}if(t.isFingering){switch(t.leftHandFinger){case 0:s.addElement("LeftFingering").innerText="P";break;case 1:s.addElement("LeftFingering").innerText="I";break;case 2:s.addElement("LeftFingering").innerText="M";break;case 3:s.addElement("LeftFingering").innerText="A";break;case 4:s.addElement("LeftFingering").innerText="C"}switch(t.rightHandFinger){case 0:s.addElement("RightFingering").innerText="P";break;case 1:s.addElement("RightFingering").innerText="I";break;case 2:s.addElement("RightFingering").innerText="M";break;case 3:s.addElement("RightFingering").innerText="A";break;case 4:s.addElement("RightFingering").innerText="C"}}s.addElement("InstrumentArticulation").innerText=0<=t.percussionArticulation?t.percussionArticulation.toString():"0",0!==t.ornament&&(s.addElement("Ornament").innerText=nt[t.ornament])}_writeNoteProperties(e,t){var s=e.addElement("Properties");if(this._writeConcertPitch(s,t),this._writeTransposedPitch(s,t),t.isStringed&&(this._writeSimplePropertyNode(s,"String","String",(t.string-1).toString()),this._writeSimplePropertyNode(s,"Fret","Fret",t.fret.toString()),this._writeSimplePropertyNode(s,"Midi","Number",t.realValue.toString()),t.showStringNumber)&&this._writeSimplePropertyNode(s,"ShowStringNumber","Enable",null),t.isPiano&&(this._writeSimplePropertyNode(s,"Octave","Number",t.octave.toString()),this._writeSimplePropertyNode(s,"Tone","Step",t.tone.toString()),this._writeSimplePropertyNode(s,"Midi","Number",t.realValue.toString())),t.beat.tap&&this._writeSimplePropertyNode(s,"Tapped","Enable",null),0!==t.harmonicType){switch(t.harmonicType){case 1:this._writeSimplePropertyNode(s,"HarmonicType","HType","Natural");break;case 2:this._writeSimplePropertyNode(s,"HarmonicType","HType","Artificial");break;case 3:this._writeSimplePropertyNode(s,"HarmonicType","HType","Pinch");break;case 4:this._writeSimplePropertyNode(s,"HarmonicType","HType","Tap");break;case 5:this._writeSimplePropertyNode(s,"HarmonicType","HType","Semi");break;case 6:this._writeSimplePropertyNode(s,"HarmonicType","HType","Feedback")}0!==t.harmonicValue&&this._writeSimplePropertyNode(s,"HarmonicFret","HFret",t.harmonicValue.toString())}t.isDead&&this._writeSimplePropertyNode(s,"Muted","Enable",null),t.isPalmMute&&this._writeSimplePropertyNode(s,"PalmMuted","Enable",null),t.hasBend&&this._writeBend(s,t),t.isHammerPullOrigin&&this._writeSimplePropertyNode(s,"HopoOrigin","Enable",null),t.isHammerPullDestination&&this._writeSimplePropertyNode(s,"HopoDestination","Enable",null),t.isLeftHandTapped&&this._writeSimplePropertyNode(s,"LeftHandTapped","Enable",null);let i=0;switch(t.slideInType){case 2:i|=32;break;case 1:i|=16}switch(t.slideOutType){case 1:i|=1;break;case 2:i|=2;break;case 4:i|=4;break;case 3:i|=8;break;case 5:i|=64;break;case 6:i|=128}0<i&&this._writeSimplePropertyNode(s,"Slide","Flags",i.toString())}_writeTransposedPitch(e,t){t.isPercussion?this._writePitch(e,"ConcertPitch","C","-1",""):this._writePitchForValue(e,"TransposedPitch",t.displayValueWithoutBend,t.accidentalMode,t.beat.voice.bar.keySignature)}_writeConcertPitch(e,t){t.isPercussion?this._writePitch(e,"ConcertPitch","C","-1",""):this._writePitchForValue(e,"ConcertPitch",t.realValueWithoutHarmonic,t.accidentalMode,t.beat.voice.bar.keySignature)}_writePitchForValue(e,t,s,i,a){let r=0,n=0,o="",h="",l=()=>{switch(r=s%12,n=s/12|0,o=Xc._defaultSteps[r],F.computeAccidental(a,0,s,!1)){case 0:case 1:h="";break;case 2:h="#";break;case 3:h="b";break;case 7:h="x";break;case 8:h="bb"}};switch(l(),i){case 0:break;case 1:case 2:h="";break;case 3:h="#";break;case 4:"#"===h&&(s-=2,l()),h="x";break;case 5:"#"===h&&(s+=1,l()),h="b";break;case 6:"#"===h&&(s+=2,l()),h="bb"}this._writePitch(e,t,o,n.toString(),h)}_writePitch(e,t,s,i,a){e=e.addElement("Property"),e.attributes.set("name",t),t=e.addElement("Pitch");t.addElement("Step").innerText=s,t.addElement("Accidental").innerText=a,t.addElement("Octave").innerText=i}_writeBend(e,t){t.hasBend&&t.bendPoints.length<=4&&this._writeStandardBend(e,t.bendPoints)}_writeStandardBend(e,t){this._writeSimplePropertyNode(e,"Bended","Enable",null);let s=t[0],i=t[t.length-1],a,r;switch(t.length){case 4:a=t[1],r=t[2];break;case 3:a=t[1],r=t[1];break;default:a=new w((s.offset+i.offset)/2,(s.value+i.value)/2),r=a}this._writeSimplePropertyNode(e,"BendDestinationOffset","Float",this._toBendOffset(i.offset).toString()),this._writeSimplePropertyNode(e,"BendDestinationValue","Float",this._toBendValue(i.value).toString()),this._writeSimplePropertyNode(e,"BendMiddleOffset1","Float",this._toBendOffset(a.offset).toString()),this._writeSimplePropertyNode(e,"BendMiddleOffset2","Float",this._toBendOffset(r.offset).toString()),this._writeSimplePropertyNode(e,"BendMiddleValue","Float",this._toBendValue(a.value).toString()),this._writeSimplePropertyNode(e,"BendOriginOffset","Float",this._toBendOffset(s.offset).toString()),this._writeSimplePropertyNode(e,"BendOriginValue","Float",this._toBendValue(s.value).toString())}_toBendValue(e){return 25*e}_toBendOffset(e){return e/w.MaxPosition*100}_writeBeatNode(e,t,s){var i=e.addElement("Beat");if(i.attributes.set("id",t.id.toString()),i.addElement("Dynamic").innerText=q[t.dynamics],0!==t.fade&&(i.addElement("Fadding").innerText=gt[t.fade]),t.isTremolo)switch(t.tremoloSpeed){case 8:i.addElement("Tremolo").innerText="1/2";break;case 16:i.addElement("Tremolo").innerText="1/4";break;case 32:i.addElement("Tremolo").innerText="1/8"}switch(t.hasChord&&i.addElement("Chord").setCData(t.chordId),0!==t.crescendo&&(i.addElement("Hairpin").innerText=te[t.crescendo]),t.brushType){case 3:i.addElement("Arpeggio").innerText="Up";break;case 4:i.addElement("Arpeggio").innerText="Down"}switch(t.text&&i.addElement("FreeText").setCData(t.text),t.graceType){case 1:case 2:i.addElement("GraceNotes").innerText=ie[t.graceType]}if(2!==t.ottava&&(i.addElement("Ottavia").innerText=he[t.ottava].substr(1)),t.hasWhammyBar&&this._writeWhammyNode(i,t),(t.isLegatoOrigin||t.isLegatoDestination)&&((e=i.addElement("Legato")).attributes.set("origin",t.isLegatoOrigin?"true":"false"),e.attributes.set("destination",t.isLegatoDestination?"true":"false")),this._writeRhythm(i,t,s),null!==t.preferredBeamDirection)switch(t.preferredBeamDirection){case 0:i.addElement("TransposedPitchStemOrientation").innerText="Upward",i.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case 1:i.addElement("TransposedPitchStemOrientation").innerText="Downward",i.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}i.addElement("ConcertPitchStemOrientation").innerText="Undefined",t.slashed&&i.addElement("Slashed"),t.deadSlapped&&i.addElement("DeadSlapped"),0<t.notes.length&&(i.addElement("Notes").innerText=t.notes.map(e=>e.id).join(" ")),0!==t.golpe&&(i.addElement("Golpe").innerText=mt[t.golpe]),0!==t.wahPedal&&(i.addElement("Wah").innerText=ft[t.wahPedal]),t.showTimer&&(i.addElement("Timer").innerText=(t.timer??0).toString()),this._writeBeatProperties(i,t),this._writeBeatXProperties(i,t),t.lyrics&&0<t.lyrics.length&&this._writeBeatLyrics(i,t.lyrics)}_writeBeatLyrics(e,t){var s,i=e.addElement("Lyrics");for(s of t)i.addElement("Line").setCData(s)}_writeBeatXProperties(e,t){var s=e.addElement("XProperties");switch(0<t.brushDuration&&this._writeSimpleXPropertyNode(s,"687935489","Int",t.brushDuration.toString()),t.beamingMode){case 1:this._writeSimpleXPropertyNode(s,"1124204546","Int","2");break;case 2:this._writeSimpleXPropertyNode(s,"1124204546","Int","1");break;case 3:this._writeSimpleXPropertyNode(s,"1124204552","Int","1")}}_writeBeatProperties(e,t){var s=e.addElement("Properties");switch(t.brushType){case 1:this._writeSimplePropertyNode(s,"Brush","Direction","Up");break;case 2:this._writeSimplePropertyNode(s,"Brush","Direction","Down")}switch(t.pickStroke){case 1:this._writeSimplePropertyNode(s,"PickStroke","Direction","Up");break;case 2:this._writeSimplePropertyNode(s,"PickStroke","Direction","Down")}switch(t.slap&&this._writeSimplePropertyNode(s,"Slapped","Enable",null),t.pop&&this._writeSimplePropertyNode(s,"Popped","Enable",null),t.vibrato){case 2:this._writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Wide");break;case 1:this._writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Slight")}if(t.isBarre)switch(this._writeSimplePropertyNode(s,"BarreFret","Fret",t.barreFret.toString()),t.barreShape){case 1:this._writeSimplePropertyNode(s,"BarreString","String","0");break;case 2:this._writeSimplePropertyNode(s,"BarreString","String","1")}if(0!==t.rasgueado){let e="";switch(t.rasgueado){case 1:e="ii_1";break;case 2:e="mi_1";break;case 3:e="mii_1";break;case 4:e="mii_2";break;case 5:e="pmp_1";break;case 6:e="pmp_2";break;case 7:e="pei_1";break;case 8:e="pei_2";break;case 9:e="pai_1";break;case 10:e="pai_2";break;case 11:e="ami_1";break;case 12:e="ami_2";break;case 13:e="ppp_1";break;case 14:e="amii_1";break;case 15:e="amip_1";break;case 16:e="eami_1";break;case 17:e="eamii_1";break;case 18:e="peami_1"}this._writeSimplePropertyNode(s,"Rasgueado","Rasgueado",e)}}_writeRhythm(e,t,s){let i=t.duration+`_${t.dots}_${t.tupletNumerator}_${t.tupletDenominator}';`,a;if(this._rhythmIdLookup.has(i))a=this._rhythmIdLookup.get(i);else{a=this._rhythmIdLookup.size.toString(),this._rhythmIdLookup.set(i,a);var r,s=s.addElement("Rhythm");s.attributes.set("id",a),t.hasTuplet&&((r=s.addElement("PrimaryTuplet")).attributes.set("num",t.tupletNumerator.toString()),r.attributes.set("den",t.tupletDenominator.toString())),0<t.dots&&s.addElement("AugmentationDot").attributes.set("count",t.dots.toString());let e="Quarter";switch(t.duration){case-4:e="Long";break;case-2:e="DoubleWhole";break;case 1:e="Whole";break;case 2:e="Half";break;case 4:e="Quarter";break;case 8:e="Eighth";break;case 16:e="16th";break;case 32:e="32nd";break;case 64:e="64th";break;case 128:e="128th";break;case 256:e="256th"}s.addElement("NoteValue").innerText=e}e.addElement("Rhythm").attributes.set("ref",a)}_writeWhammyNode(e,t){t.hasWhammyBar&&t.whammyBarPoints.length<=4&&this._writeStandardWhammy(e,t.whammyBarPoints)}_writeStandardWhammy(e,t){let s=e.addElement("Whammy"),i=t[0],a=t[t.length-1],r,n;switch(t.length){case 4:r=t[1],n=t[2];break;case 3:r=t[1],n=t[1];break;default:r=new w((i.offset+a.offset)/2,(i.value+a.value)/2),n=r}s.attributes.set("destinationOffset",this._toBendOffset(a.offset).toString()),s.attributes.set("destinationValue",this._toBendValue(a.value).toString()),s.attributes.set("middleOffset1",this._toBendOffset(r.offset).toString()),s.attributes.set("middleOffset2",this._toBendOffset(n.offset).toString()),s.attributes.set("middleValue",this._toBendValue(r.value).toString()),s.attributes.set("originOffset",this._toBendOffset(i.offset).toString()),s.attributes.set("originValue",this._toBendValue(i.value).toString())}_writeScoreNode(e,t){e=e.addElement("Score");e.addElement("Title").setCData(t.title),e.addElement("SubTitle").setCData(t.subTitle),e.addElement("Artist").setCData(t.artist),e.addElement("Album").setCData(t.album),e.addElement("Words").setCData(t.words),e.addElement("Music").setCData(t.music),e.addElement("WordsAndMusic").setCData(t.words===t.music?t.words:""),e.addElement("Copyright").setCData(t.copyright),e.addElement("Tabber").setCData(t.tab),e.addElement("Instructions").setCData(t.instructions),e.addElement("Notices").setCData(t.notices),e.addElement("FirstPageHeader").setCData(""),e.addElement("FirstPageFooter").setCData(""),e.addElement("PageHeader").setCData(""),e.addElement("PageFooter").setCData(""),e.addElement("ScoreSystemsDefaultLayout").setCData(t.defaultSystemsLayout.toString()),e.addElement("ScoreSystemsLayout").setCData(t.systemsLayout.join(" ")),e.addElement("ScoreZoomPolicy").innerText="Value",e.addElement("ScoreZoom").innerText="1",e.addElement("MultiVoice").innerText="1>"}_writeMasterTrackNode(e,t){var s,e=e.addElement("MasterTrack"),i=(e.addElement("Tracks").innerText=t.tracks.map(e=>e.index).join(" "),e.addElement("Automations")),e=(0<t.masterBars.length&&t.masterBars[0].isAnacrusis&&e.addElement("Anacrusis"),0===t.masterBars[0].tempoAutomations.length&&((e=i.addElement("Automation")).addElement("Type").innerText="Tempo",e.addElement("Linear").innerText="false",e.addElement("Bar").innerText="0",e.addElement("Position").innerText="0",e.addElement("Visible").innerText="true",e.addElement("Value").innerText=t.tempo+" 2",t.tempoLabel)&&(e.addElement("Text").innerText=t.tempoLabel),t.masterBars[0].syncPoints?t.masterBars[0].syncPoints.find(e=>0===e.ratioPosition&&0===e.syncPointValue.barOccurence):void 0),a=e?e.syncPointValue.millisecondOffset:0,r=(this._backingTrackFramePadding=a/1e3*Xc._sampleRate*-1|0,new be(()=>bo.buildModifiedTempoLookup(t)));for(s of t.masterBars){for(var n of s.tempoAutomations){var o=i.addElement("Automation");o.addElement("Type").innerText="Tempo",o.addElement("Linear").innerText=n.isLinear?"true":"false",o.addElement("Bar").innerText=s.index.toString(),o.addElement("Position").innerText=n.ratioPosition.toString(),o.addElement("Visible").innerText=n.isVisible?"true":"false",o.addElement("Value").innerText=n.value+" 2",n.text&&(o.addElement("Text").innerText=n.text)}if(s.syncPoints)for(var h of s.syncPoints){var l=i.addElement("Automation"),l=(l.addElement("Type").innerText="SyncPoint",l.addElement("Linear").innerText="false",l.addElement("Bar").innerText=s.index.toString(),l.addElement("Position").innerText=h.ratioPosition.toString(),l.addElement("Visible").innerText=h.isVisible?"true":"false",l.addElement("Value")),h=(l.addElement("BarIndex").innerText=s.index.toString(),l.addElement("BarOccurrence").innerText=h.syncPointValue.barOccurence.toString(),l.addElement("ModifiedTempo").innerText=r.value.get(h).syncBpm.toString(),l.addElement("OriginalTempo").innerText=t.tempo.toString(),(h.syncPointValue.millisecondOffset-a)/1e3*Xc._sampleRate),h=Math.floor(h+.5);l.addElement("FrameOffset").innerText=h.toString()}}}_writeAudioTracksNode(e,t){e.addElement("AudioTracks")}_writeTracksNode(e,t){var s,i=e.addElement("Tracks");for(s of t.tracks)this._writeTrackNode(i,s)}_writeTrackNode(e,t){e=e.addElement("Track");e.attributes.set("id",t.index.toString()),e.addElement("Name").setCData(t.name),e.addElement("ShortName").setCData(t.shortName),e.addElement("Color").innerText=`${t.color.r} ${t.color.g} `+t.color.b,e.addElement("SystemsDefautLayout").innerText=t.defaultSystemsLayout.toString(),e.addElement("SystemsLayout").innerText=t.systemsLayout.join(" "),e.addElement("AutoBrush"),e.addElement("PalmMute").innerText="0",e.addElement("PlayingStyle").innerText=Wt.isGuitar(t.playbackInfo.program)?"StringedPick":"Default",e.addElement("UseOneChannelPerString"),e.addElement("IconId").innerText=Xc._getIconId(t.playbackInfo).toString(),this._writeInstrumentSetNode(e,t),this._writeTransposeNode(e,t),this._writeRseNode(e,t),e.addElement("ForcedSound").innerText="-1",this._writeMidiConnectionNode(e,t),t.playbackInfo.isSolo?e.addElement("PlaybackState").innerText="Solo":t.playbackInfo.isMute?e.addElement("PlaybackState").innerText="Mute":e.addElement("PlaybackState").innerText="Default",e.addElement("AudioEngineState").innerText="MIDI",this._writeLyricsNode(e,t),this._writeStavesNode(e,t),this._writeSoundsAndAutomations(e,t)}static _getIconId(e){return 9===e.primaryChannel?Xc._drumKitProgramInfo.icon:Xc._midiProgramInfoLookup.has(e.program)?Xc._midiProgramInfoLookup.get(e.program).icon:1}_writeSoundAndAutomation(e,t,s,i,a,r,n,o,h=0){e=e.addElement("Sound"),e.addElement("Name").setCData(s),e.addElement("Label").setCData(s),e.addElement("Path").setCData(i),e.addElement("Role").setCData(a),e=e.addElement("MIDI"),o=Wt.bankToLsbMsb(o),e.addElement("LSB").innerText=o[0].toString(),e.addElement("MSB").innerText=o[1].toString(),e.addElement("Program").innerText=n.toString(),o=t.addElement("Automation");o.addElement("Type").innerText="Sound",o.addElement("Linear").innerText="false",o.addElement("Bar").innerText=r.toString(),o.addElement("Position").innerText=h.toString(),o.addElement("Visible").innerText="true",o.addElement("Value").setCData(i+`;${s};`+a)}_writeSoundsAndAutomations(e,a){var t,r=e.addElement("Sounds"),n=e.addElement("Automations");if(0<a.staves.length&&0<a.staves[0].bars.length){let e=`Track_${a.index}_Initial`,t="Midi/"+a.playbackInfo.program,s=!1,i=a.playbackInfo.bank;for(var o of a.staves)for(var h of o.bars)for(var l of h.voices)for(var d of l.beats){var c,u=d.getAutomation(2),p=0===h.index&&0===d.index,m=d.getAutomation(4);m&&(i=m.value),u&&(m=p?e:"ProgramChange_"+d.id,d=p?t:"Midi/"+u.value,c=p?"Factory":"User",p||s||(this._writeSoundAndAutomation(r,n,e,t,"Factory",a.staves[0].bars[0].index,a.playbackInfo.program,a.playbackInfo.bank),s=!0),this._writeSoundAndAutomation(r,n,m,d,c,h.index,u.value,i,u.ratioPosition),p)&&(s=!0)}}for(t of a.staves)for(var s of t.bars)for(var i of s.sustainPedals)if(1!==i.pedalType){var g=n.addElement("Automation");switch(g.addElement("Type").innerText="SustainPedal",g.addElement("Linear").innerText="false",g.addElement("Bar").innerText=s.index.toString(),g.addElement("Position").innerText=i.ratioPosition.toString(),g.addElement("Visible").innerText="true",i.pedalType){case 0:g.addElement("Value").innerText="0 1";break;case 2:g.addElement("Value").innerText="0 3"}}}_writeMidiConnectionNode(e,t){e=e.addElement("MidiConnection");e.addElement("Port").innerText=t.playbackInfo.port.toString(),e.addElement("PrimaryChannel").innerText=t.playbackInfo.primaryChannel.toString(),e.addElement("SecondaryChannel").innerText=t.playbackInfo.secondaryChannel.toString(),e.addElement("ForeOneChannelPerString").innerText="false"}_writeRseNode(e,t){e=e.addElement("RSE").addElement("ChannelStrip");e.attributes.set("version","E56"),e.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${t.playbackInfo.balance/16} ${t.playbackInfo.volume/16} 0.5 0.5 0.5`}_writeStavesNode(e,t){var s,i=e.addElement("Staves");for(s of t.staves)this._writeStaffNode(i,s)}_writeStaffNode(e,t){e=e.addElement("Staff").addElement("Properties");if(this._writeSimplePropertyNode(e,"CapoFret","Fret",t.capo.toString()),this._writeSimplePropertyNode(e,"FretCount","Fret","24"),0<t.tuning.length){var s=e.addElement("Property");switch(s.attributes.set("name","Tuning"),s.addElement("Pitches").innerText=t.tuning.slice().reverse().join(" "),s.addElement("Label").setCData(t.tuningName),s.addElement("LabelVisible").innerText=t.tuningName?"true":"false",s.addElement("Flat"),t.tuning.length){case 3:s.addElement("Instrument").innerText="Shamisen";break;case 4:105===t.track.playbackInfo.program?s.addElement("Instrument").innerText="Banjo":42===t.track.playbackInfo.program?s.addElement("Instrument").innerText="Cello":43===t.track.playbackInfo.program?s.addElement("Instrument").innerText="Contrabass":40===t.track.playbackInfo.program?s.addElement("Instrument").innerText="Violin":41===t.track.playbackInfo.program?s.addElement("Instrument").innerText="Viola":s.addElement("Instrument").innerText="Bass";break;case 5:105===t.track.playbackInfo.program?s.addElement("Instrument").innerText="Banjo":s.addElement("Instrument").innerText="Bass";break;case 6:105===t.track.playbackInfo.program?s.addElement("Instrument").innerText="Banjo":t.track.playbackInfo.program<=39?s.addElement("Instrument").innerText="Bass":s.addElement("Instrument").innerText="Guitar";break;case 7:t.track.playbackInfo.program<=39?s.addElement("Instrument").innerText="Bass":s.addElement("Instrument").innerText="Guitar";break;default:s.addElement("Instrument").innerText="Guitar"}}this._writeSimplePropertyNode(e,"PartialCapoFret","Fret","0"),this._writeSimplePropertyNode(e,"PartialCapoStringFlags","Bitset",t.tuning.map(e=>"0").join("")),this._writeSimplePropertyNode(e,"TuningFlat","Enable",null),this._writeDiagramCollection(e,t,"DiagramCollection"),this._writeDiagramCollection(e,t,"DiagramWorkingSet")}_writeDiagramCollection(e,t,s){var e=e.addElement("Property"),i=(e.attributes.set("name",s),e.addElement("Items")),s=t.chords;if(s)for(var[a,r]of s){var n=i.addElement("Item"),o=(n.attributes.set("id",a),n.attributes.set("name",r.name),n.addElement("Diagram")),h=(o.attributes.set("stringCount",r.strings.length.toString()),o.attributes.set("fretCount","5"),o.attributes.set("baseFret",(r.firstFret-1).toString()),o.attributes.set("barStates",r.strings.map(e=>"1").join(" ")),[]),l=new Map;for(let e=0;e<r.strings.length;e++){var d,c,u=r.strings[e];-1!==u&&(d=o.addElement("Fret"),c=r.strings.length-1-e,d.attributes.set("string",c.toString()),d.attributes.set("fret",(u-r.firstFret+1).toString()),l.has(u)||(l.set(u,[]),h.push(u)),l.get(u).push(c))}h.sort();var p=o.addElement("Fingering");if(0<r.barreFrets.length){var m,g=[4,3,2,1];for(m of h){var f=l.get(m);if(1<f.length&&0<=r.barreFrets.indexOf(m)){var b,y=0<g.length?g.pop():1;for(b of f){var _=p.addElement("Position");switch(y){case 4:_.attributes.set("finger","Pinky");break;case 3:_.attributes.set("finger","Ring");break;case 2:_.attributes.set("finger","Middle");break;case 1:_.attributes.set("finger","Index")}_.attributes.set("fret",(m-r.firstFret+1).toString()),_.attributes.set("string",b.toString())}}}}a=o.addElement("Property"),n=(a.attributes.set("name","ShowName"),a.attributes.set("type","bool"),a.attributes.set("value",r.showName?"true":"false"),o.addElement("Property")),a=(n.attributes.set("name","ShowDiagram"),n.attributes.set("type","bool"),n.attributes.set("value",r.showDiagram?"true":"false"),o.addElement("Property")),n=(a.attributes.set("name","ShowFingering"),a.attributes.set("type","bool"),a.attributes.set("value",r.showFingering?"true":"false"),o.addElement("Chord")),a=n.addElement("KeyNote"),a=(a.attributes.set("step","C"),a.attributes.set("accidental","Natural"),n.addElement("BassNote")),a=(a.attributes.set("step","C"),a.attributes.set("accidental","Natural"),n.addElement("Degree")),a=(a.attributes.set("interval","Third"),a.attributes.set("alteration","Major"),a.attributes.set("omitted","false"),n.addElement("Degree"));a.attributes.set("interval","Fifth"),a.attributes.set("alteration","Perfect"),a.attributes.set("omitted","false")}}_writeSimplePropertyNode(e,t,s,i){e=e.addElement("Property"),e.attributes.set("name",t),t=e.addElement(s);return null!==i&&(t.innerText=i),e}_writeSimpleXPropertyNode(e,t,s,i){e=e.addElement("XProperty"),e.attributes.set("id",t),t=e.addElement(s);return null!==i&&(t.innerText=i),e}_writeLyricsNode(e,t){var s,i=e.addElement("Lyrics"),a=(i.attributes.set("dispatched","true"),[]);for(s of t.staves[0].bars)for(var r of s.voices)if(!r.isEmpty)for(var n of r.beats)if(n.lyrics)for(let e=0;e<n.lyrics.length;e++){for(;e>=a.length;){var o=new Xt;o.startBar=s.index,o.text="[Empty]",a.push(o)}var h=a[e];h.text="[Empty]"===h.text?n.lyrics[e]:h.text+" "+n.lyrics[e].split(" ").join("+")}for(let e=0;e<a.length;e++){var l=i.addElement("Line");l.addElement("Text").setCData(a[e].text),l.addElement("Offset").innerText=a[e].startBar.toString()}}_writeTransposeNode(e,t){var e=e.addElement("Transpose"),s=Math.floor(t.staves[0].displayTranspositionPitch/12),t=t.staves[0].displayTranspositionPitch-12*s;e.addElement("Chromatic").innerText=t.toString(),e.addElement("Octave").innerText=s.toString()}_writeInstrumentSetNode(e,t){var e=e.addElement("InstrumentSet"),n=t.staves[0];if(e.addElement("LineCount").innerText=n.standardNotationLineCount.toString(),0<t.percussionArticulations.length||n.isPercussion){var o,h,n=0<t.percussionArticulations.length?t.percussionArticulations:Array.from(rt.instrumentArticulations.values());e.addElement("Name").innerText=Xc._drumKitProgramInfo.instrumentSetName,e.addElement("Type").innerText=Xc._drumKitProgramInfo.instrumentSetType;let s="",i=new Os,a=new Map,r=e.addElement("Elements");for(o of n){{let e=r.addElement("Element"),t=o.elementType;a.has(t)?(h=a.get(t),t+=" "+h,a.set(t,h+1)):a.set(t,1),s=t,e.addElement("Name").innerText=t,e.addElement("Type").innerText=o.elementType,i=e.addElement("Articulations")}var l=i.addElement("Articulation");switch(l.addElement("Name").innerText=s+" "+i.childNodes.length,l.addElement("StaffLine").innerText=o.staffLine.toString(),l.addElement("Noteheads").innerText=[this._mapMusicSymbol(o.noteHeadDefault),this._mapMusicSymbol(o.noteHeadHalf),this._mapMusicSymbol(o.noteHeadWhole)].join(" "),o.techniqueSymbolPlacement){case 2:l.addElement("TechniquePlacement").innerText="below";break;case 3:l.addElement("TechniquePlacement").innerText="outside";break;case 1:l.addElement("TechniquePlacement").innerText="inside";break;case 0:l.addElement("TechniquePlacement").innerText="above"}l.addElement("TechniqueSymbol").innerText=this._mapMusicSymbol(o.techniqueSymbol),l.addElement("InputMidiNumbers").innerText="",l.addElement("OutputMidiNumber").innerText=o.outputMidiNumber.toString()}}else{n=Xc._midiProgramInfoLookup.has(t.playbackInfo.program)?Xc._midiProgramInfoLookup.get(t.playbackInfo.program):Xc._midiProgramInfoLookup.get(0),t=(e.addElement("Name").innerText=n.instrumentSetName,e.addElement("Type").innerText=n.instrumentSetType,e.addElement("Elements").addElement("Element")),n=(t.addElement("Pitched").innerText="Pitched",t.addElement("Type").innerText="pitched",t.addElement("SoundbankName").innerText="",t.addElement("Articulations").addElement("Articulation"));n.addElement("Name").innerText="",n.addElement("StaffLine").innerText="0",n.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",n.addElement("TechniquePlacement").innerText="outside",n.addElement("TechniqueSymbol").innerText="",n.addElement("InputMidiNumbers").innerText="",n.addElement("OutputRSESound").innerText="",n.addElement("OutputMidiNumber").innerText="0"}}_mapMusicSymbol(e){return-1===e?"":(e=Qe[e]).substring(0,1).toLowerCase()+e.substring(1)}_writeMasterBarsNode(e,t){var s,i=e.addElement("MasterBars");for(s of t.masterBars)this._writeMasterBarNode(i,s)}_writeMasterBarNode(i,a){var e,i=i.addElement("MasterBar"),t=i.addElement("Key"),s=a.score.tracks[0].staves[0].bars[a.index].keySignature,r=a.score.tracks[0].staves[0].bars[a.index].keySignatureType,n=F.flooredDivision(a.score.tracks[0].staves[0].displayTranspositionPitch,12),s=F.transposeKey(s,-n),o=(t.addElement("AccidentalCount").innerText=s.toString(),t.addElement("Mode").innerText=Ee[r],t.addElement("Sharps").innerText="Sharps",i.addElement("Time").innerText=a.timeSignatureNumerator+"/"+a.timeSignatureDenominator,a.isFreeTime&&i.addElement("FreeTime"),[]);for(e of a.score.tracks)for(var h of e.staves)o.push(h.bars[a.index].id.toString());if(i.addElement("Bars").innerText=o.join(" "),a.isDoubleBar&&i.addElement("DoubleBar"),a.isSectionStart&&((n=i.addElement("Section")).addElement("Letter").setCData(a.section.marker),n.addElement("Text").setCData(a.section.text)),(a.isRepeatStart||a.isRepeatEnd)&&((s=i.addElement("Repeat")).attributes.set("start",a.isRepeatStart?"true":"false"),s.attributes.set("end",a.isRepeatEnd?"true":"false"),a.isRepeatEnd)&&s.attributes.set("count",a.repeatCount.toString()),0<a.alternateEndings){let e=a.alternateEndings,t=[],s=0;for(;0<e;)1==(e>>s&1)&&(t.push(s+1),e&=~(1<<s)),s++;i.addElement("AlternateEndings").innerText=t.join(" ")}if(0!==a.tripletFeel&&(i.addElement("TripletFeel").innerText=je[a.tripletFeel]),a.directions&&0<a.directions.size){var l,d=i.addElement("Directions");for(l of a.directions)switch(l){case 0:d.addElement("Target").innerText="Fine";break;case 1:d.addElement("Target").innerText="Segno";break;case 2:d.addElement("Target").innerText="SegnoSegno";break;case 3:d.addElement("Target").innerText="Coda";break;case 4:d.addElement("Target").innerText="DoubleCoda";break;case 5:d.addElement("Jump").innerText="DaCapo";break;case 6:d.addElement("Jump").innerText="DaCapoAlCoda";break;case 7:d.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case 8:d.addElement("Jump").innerText="DaCapoAlFine";break;case 9:d.addElement("Jump").innerText="DaSegno";break;case 10:d.addElement("Jump").innerText="DaSegnoAlCoda";break;case 11:d.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case 12:d.addElement("Jump").innerText="DaSegnoAlFine";break;case 13:d.addElement("Jump").innerText="DaSegnoSegno";break;case 14:d.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case 15:d.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case 16:d.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case 17:d.addElement("Jump").innerText="DaCoda";break;case 18:d.addElement("Jump").innerText="DaDoubleCoda"}}this._writeFermatas(i,a)}_writeFermatas(e,t){var s=t.fermata?.size??0;if(0!==s&&0<s){var i,a,r=e.addElement("Fermatas");for([i,a]of t.fermata)this._writeFermata(r,i,a)}}_writeFermata(e,t,s){let i=-1,a=1;if(0<t)for(;a<10&&(i=t/N.QuarterTime*a)!==Math.floor(i);)i=-1,a++;else i=0,a=1;-1!==i&&((e=e.addElement("Fermata")).addElement("Type").innerText=It[s.type],e.addElement("Length").innerText=s.length.toString(),e.addElement("Offset").innerText=i+"/"+a)}_writeBarNode(e,t){e=e.addElement("Bar");e.attributes.set("id",t.id.toString()),e.addElement("Voices").innerText=t.voices.map(e=>e.isEmpty?"-1":e.id.toString()).join(" "),e.addElement("Clef").innerText=Pe[t.clef],2!==t.clefOttava&&(e.addElement("Ottavia").innerText=he[t.clefOttava].substr(1)),0!==t.simileMark&&(e.addElement("SimileMark").innerText=Ne[t.simileMark])}_writeVoiceNode(e,t){t.isEmpty||((e=e.addElement("Voice")).attributes.set("id",t.id.toString()),e.addElement("Beats").innerText=t.beats.map(e=>e.id).join(" "))}},Jc=(Xc._sampleRate=44100,Xc._midiProgramInfoLookup=new Map([[0,new y(10,"Acoustic Piano")],[1,new y(10,"Acoustic Piano")],[2,new y(10,"Electric Piano")],[3,new y(10,"Acoustic Piano")],[4,new y(10,"Electric Piano")],[5,new y(10,"Electric Piano")],[6,new y(10,"Harpsichord")],[7,new y(10,"Harpsichord")],[8,new y(17,"Celesta")],[9,new y(17,"Vibraphone")],[10,new y(17,"Vibraphone")],[11,new y(17,"Vibraphone")],[12,new y(17,"Xylophone")],[13,new y(17,"Xylophone")],[14,new y(17,"Vibraphone")],[15,new y(8,"Banjo")],[16,new y(10,"Electric Organ")],[17,new y(10,"Electric Organ")],[18,new y(10,"Electric Organ")],[19,new y(10,"Electric Organ")],[20,new y(10,"Electric Organ")],[21,new y(10,"Electric Organ")],[22,new y(15,"Recorder")],[23,new y(10,"Electric Organ")],[24,new y(23,"Nylon Guitar")],[25,new y(1,"Steel Guitar")],[26,new y(1,"Electric Guitar")],[27,new y(4,"Electric Guitar")],[28,new y(4,"Electric Guitar")],[29,new y(4,"Electric Guitar")],[30,new y(1,"Electric Guitar")],[31,new y(1,"Electric Guitar")],[32,new y(5,"Acoustic Bass")],[33,new y(5,"Electric Bass")],[34,new y(5,"Electric Bass")],[35,new y(5,"Acoustic Bass")],[36,new y(5,"Electric Bass")],[37,new y(5,"Electric Bass")],[38,new y(12,"Synth Bass")],[39,new y(12,"Synth Bass")],[40,new y(11,"Violin")],[41,new y(11,"Viola")],[42,new y(11,"Cello")],[43,new y(11,"Contrabass")],[44,new y(11,"Violin")],[45,new y(11,"Violin")],[46,new y(10,"Harp")],[47,new y(20,"Timpani")],[48,new y(11,"Violin")],[49,new y(11,"Violin")],[50,new y(11,"Violin")],[51,new y(11,"Violin")],[52,new y(16,"Voice")],[53,new y(16,"Voice")],[54,new y(16,"Voice")],[55,new y(12,"Pad Synthesizer")],[56,new y(13,"Trumpet")],[57,new y(13,"Trombone")],[58,new y(13,"Tuba")],[59,new y(13,"Trumpet")],[60,new y(13,"French Horn")],[61,new y(13,"Trumpet")],[62,new y(13,"Trumpet")],[63,new y(13,"Trumpet")],[64,new y(14,"Saxophone")],[65,new y(14,"Saxophone")],[66,new y(14,"Saxophone")],[67,new y(14,"Saxophone")],[68,new y(14,"Oboe")],[69,new y(14,"English Horn")],[70,new y(14,"Bassoon")],[71,new y(14,"Clarinet")],[72,new y(14,"Piccolo")],[73,new y(15,"Flute")],[74,new y(15,"Recorder")],[75,new y(15,"Flute")],[76,new y(15,"Recorder")],[77,new y(15,"Flute")],[78,new y(15,"Recorder")],[79,new y(15,"Flute")],[80,new y(12,"Lead Synthesizer")],[81,new y(12,"Lead Synthesizer")],[82,new y(12,"Lead Synthesizer")],[83,new y(12,"Lead Synthesizer")],[84,new y(12,"Lead Synthesizer")],[85,new y(12,"Lead Synthesizer")],[86,new y(12,"Lead Synthesizer")],[87,new y(12,"Lead Synthesizer")],[88,new y(12,"Pad Synthesizer")],[89,new y(12,"Pad Synthesizer")],[90,new y(12,"Pad Synthesizer")],[91,new y(12,"Pad Synthesizer")],[92,new y(12,"Pad Synthesizer")],[93,new y(12,"Pad Synthesizer")],[94,new y(12,"Pad Synthesizer")],[95,new y(12,"Pad Synthesizer")],[96,new y(21,"Pad Synthesizer")],[97,new y(21,"Pad Synthesizer")],[98,new y(21,"Pad Synthesizer")],[99,new y(21,"Pad Synthesizer")],[100,new y(21,"Lead Synthesizer")],[101,new y(21,"Lead Synthesizer")],[102,new y(21,"Lead Synthesizer")],[103,new y(21,"Trumpet")],[104,new y(4,"Banjo")],[105,new y(8,"Banjo")],[106,new y(7,"Ukulele")],[107,new y(8,"Banjo")],[108,new y(17,"Xylophone")],[109,new y(14,"Bassoon")],[110,new y(11,"Violin")],[111,new y(15,"Flute")],[112,new y(17,"Xylophone")],[113,new y(19,"Celesta")],[114,new y(17,"Vibraphone")],[115,new y(19,"Xylophone")],[116,new y(20,"Xylophone")],[117,new y(20,"Xylophone")],[118,new y(20,"Xylophone")],[119,new y(19,"Celesta")],[120,new y(21,"Steel Guitar")],[121,new y(21,"Recorder")],[122,new y(21,"Recorder")],[123,new y(21,"Recorder")],[124,new y(21,"Recorder")],[125,new y(21,"Recorder")],[126,new y(21,"Recorder")],[127,new y(21,"Timpani")]]),Xc._drumKitProgramInfo=new y(18,"Drums","drumKit"),Xc._defaultSteps=["C","C","D","D","E","F","F","G","G","A","A","B"],Xc),qc=class qc{constructor(){this._checkValue=qc._crcInit,this.reset()}static _buildCrc32Lookup(){var s=new Uint32Array(256);for(let e=0;e<s.length;e++){let t=e;for(let e=0;e<8;e++)t=1==(1&t)?t>>>1^3988292384:t>>>1;s[e]=t}return s}get value(){return~this._checkValue}update(t,s,i){for(let e=0;e<i;e++)this._checkValue=qc._crc32Lookup[255&(this._checkValue^t[s+e])]^this._checkValue>>>8}reset(){this._checkValue=qc._crcInit}},jc=(qc._crc32Lookup=qc._buildCrc32Lookup(),qc._crcInit=4294967295,qc),$c=class{},Kc=($c.maxWbits=15,$c.wsize=1<<$c.maxWbits,$c.wmask=$c.wsize-1,$c.minMatch=3,$c.maxMatch=258,$c.defaultMemLevel=8,$c.pendingBufSize=1<<$c.defaultMemLevel+8,$c.hashBits=$c.defaultMemLevel+7,$c.hashSize=1<<$c.hashBits,$c.hashShift=($c.hashBits+$c.minMatch-1)/$c.minMatch,$c.hashMask=$c.hashSize-1,$c.minLookahead=$c.maxMatch+$c.minMatch+1,$c.maxDist=$c.wsize-$c.minLookahead,$c),Qc=class Qc{constructor(e,t,s,i){this.length=null,this.numCodes=0,this._codes=null,this._huffman=e,this.minNumCodes=s,this._maxLength=i,this.freqs=new Int16Array(t),this._bitLengthCounts=new Int32Array(i)}reset(){for(let e=0;e<this.freqs.length;e++)this.freqs[e]=0;this._codes=null,this.length=null}buildTree(){let e=this.freqs.length,r=new Int32Array(e),n=0,s=0;for(let t=0;t<e;t++){var i=this.freqs[t];if(0!==i){let e=n++;for(;0<e;){var a=Math.floor((e-1)/2);if(!(this.freqs[r[a]]>i))break;r[e]=r[a],e=a}r[e]=t,s=t}}for(;n<2;){var t=s<2?++s:0;r[n++]=t}this.numCodes=Math.max(s+1,this.minNumCodes);let o=n,h=new Int32Array(4*n-2),l=new Int32Array(2*n-1),d=o;for(let e=0;e<n;e++){var c=r[e];h[2*e]=c,h[2*e+1]=-1,l[e]=this.freqs[c]<<8,r[e]=e}do{let e=r[0],t=r[--n],s=0,i=1;for(;i<n;)i+1<n&&l[r[i]]>l[r[i+1]]&&i++,r[s]=r[i],i=2*(s=i)+1;let a=l[t];for(;0<(i=s)&&(s=Math.floor((i-1)/2),l[r[s]]>a);)r[i]=r[s];r[i]=t;var u=r[0],p=(t=d++,h[2*t]=e,h[2*t+1]=u,Math.min(255&l[e],255&l[u]));for(a=l[e]+l[u]-p+1,l[t]=a,s=0,i=1;i<n;)i+1<n&&l[r[i]]>l[r[i+1]]&&i++,r[s]=r[i],i=2*(s=i)+1;for(;0<(i=s)&&(s=Math.floor((i-1)/2),l[r[s]]>a);)r[i]=r[s];r[i]=t}while(1<n);this._buildLength(h)}_buildLength(i){this.length=new Uint8Array(this.freqs.length);let e=Math.floor(i.length/2),t=Math.floor((e+1)/2),a=0;for(let e=0;e<this._maxLength;e++)this._bitLengthCounts[e]=0;var s=new Int32Array(e);s[e-1]=0;for(let t=e-1;0<=t;t--)if(-1!==i[2*t+1]){let e=s[t]+1;e>this._maxLength&&(e=this._maxLength,a++),s[i[2*t]]=e,s[i[2*t+1]]=e}else{var r=s[t];this._bitLengthCounts[r-1]++,this.length[i[2*t]]=s[t]}if(0!==a){let e=this._maxLength-1;do{for(;0===this._bitLengthCounts[--e];);for(;this._bitLengthCounts[e]--,this._bitLengthCounts[++e]++,0<(a-=1<<this._maxLength-1-e)&&e<this._maxLength-1;);}while(0<a);this._bitLengthCounts[this._maxLength-1]+=a,this._bitLengthCounts[this._maxLength-2]-=a;let s=2*t;for(let t=this._maxLength;0!==t;t--){let e=this._bitLengthCounts[t-1];for(;0<e;){var n=2*i[s++];-1===i[1+n]&&(this.length[i[n]]=t,e--)}}}}getEncodedLength(){let t=0;for(let e=0;e<this.freqs.length;e++)t+=this.freqs[e]*this.length[e];return t}calcBLFreq(e){let t,s,i,a=-1,r=0;for(;r<this.numCodes;){i=1;var n=this.length[r];for(0===n?(t=138,s=3):(t=6,s=3,a!==n&&(e.freqs[n]++,i=0)),a=n,r++;r<this.numCodes&&a===this.length[r]&&(r++,!(++i>=t)););i<s?e.freqs[a]+=i:0!==a?e.freqs[Qc._repeat3To6]++:i<=10?e.freqs[Qc._repeat3To10]++:e.freqs[Qc._repeat11To138]++}}setStaticCodes(e,t){this._codes=e,this.length=t}buildCodes(){let t=new Int32Array(this._maxLength),s=0;this._codes=new Int16Array(this.freqs.length);for(let e=0;e<this._maxLength;e++)t[e]=s,s+=this._bitLengthCounts[e]<<15-e;for(let e=0;e<this.numCodes;e++){var i=this.length[e];0<i&&(this._codes[e]=eu.bitReverse(t[i-1]),t[i-1]+=1<<16-i)}}writeTree(e){let t,s,i,a=-1,r=0;for(;r<this.numCodes;){i=1;var n=this.length[r];for(0===n?(t=138,s=3):(t=6,s=3,a!==n&&(e.writeSymbol(n),i=0)),a=n,r++;r<this.numCodes&&a===this.length[r]&&(r++,!(++i>=t)););if(i<s)for(;0<i--;)e.writeSymbol(a);else 0!==a?(e.writeSymbol(Qc._repeat3To6),this._huffman.pending.writeBits(i-3,2)):i<=10?(e.writeSymbol(Qc._repeat3To10),this._huffman.pending.writeBits(i-3,3)):(e.writeSymbol(Qc._repeat11To138),this._huffman.pending.writeBits(i-11,7))}}writeSymbol(e){this._huffman.pending.writeBits(65535&this._codes[e],this.length[e])}},Zc=(Qc._repeat3To6=16,Qc._repeat3To10=17,Qc._repeat11To138=18,Qc),L=class L{constructor(e){this._lastLit=0,this._extraBits=0,this.pending=e,this._literalTree=new Zc(this,L._literalNum,257,15),this._distTree=new Zc(this,L._distNum,1,15),this._blTree=new Zc(this,L._bitLenNum,4,7),this._dBuf=new Int16Array(L._bufSize),this._lBuf=new Uint8Array(L._bufSize)}static staticInit(){let e=0;for(;e<144;)L._staticLCodes[e]=L.bitReverse(48+e<<8),L._staticLLength[e++]=8;for(;e<256;)L._staticLCodes[e]=L.bitReverse(256+e<<7),L._staticLLength[e++]=9;for(;e<280;)L._staticLCodes[e]=L.bitReverse(-256+e<<9),L._staticLLength[e++]=7;for(;e<L._literalNum;)L._staticLCodes[e]=L.bitReverse(-88+e<<8),L._staticLLength[e++]=8;for(e=0;e<L._distNum;e++)L._staticDCodes[e]=L.bitReverse(e<<11),L._staticDLength[e]=5}static bitReverse(e){return L._bit4Reverse[15&e]<<12|L._bit4Reverse[e>>4&15]<<8|L._bit4Reverse[e>>8&15]<<4|L._bit4Reverse[e>>12]}isFull(){return this._lastLit>=L._bufSize}reset(){this._lastLit=0,this._extraBits=0,this._literalTree.reset(),this._distTree.reset(),this._blTree.reset()}flushStoredBlock(e,t,s,i){this.pending.writeBits((L.storedBlock<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(e,t,s),this.reset()}flushBlock(e,t,s,i){this._literalTree.freqs[L._eofSymbol]++,this._literalTree.buildTree(),this._distTree.buildTree(),this._literalTree.calcBLFreq(this._blTree),this._distTree.calcBLFreq(this._blTree),this._blTree.buildTree();let a=4;for(let e=18;e>a;e--)0<this._blTree.length[L._blOrder[e]]&&(a=e+1);let r=14+3*a+this._blTree.getEncodedLength()+this._literalTree.getEncodedLength()+this._distTree.getEncodedLength()+this._extraBits,n=this._extraBits;for(let e=0;e<L._literalNum;e++)n+=this._literalTree.freqs[e]*L._staticLLength[e];for(let e=0;e<L._distNum;e++)n+=this._distTree.freqs[e]*L._staticDLength[e];r>=n&&(r=n),0<=t&&s+4<r>>3?this.flushStoredBlock(e,t,s,i):(r===n?(this.pending.writeBits((L.staticTrees<<1)+(i?1:0),3),this._literalTree.setStaticCodes(L._staticLCodes,L._staticLLength),this._distTree.setStaticCodes(L._staticDCodes,L._staticDLength)):(this.pending.writeBits((L.dynTrees<<1)+(i?1:0),3),this.sendAllTrees(a)),this.compressBlock(),this.reset())}sendAllTrees(t){this._blTree.buildCodes(),this._literalTree.buildCodes(),this._distTree.buildCodes(),this.pending.writeBits(this._literalTree.numCodes-257,5),this.pending.writeBits(this._distTree.numCodes-1,5),this.pending.writeBits(t-4,4);for(let e=0;e<t;e++)this.pending.writeBits(this._blTree.length[L._blOrder[e]],3);this._literalTree.writeTree(this._blTree),this._distTree.writeTree(this._blTree)}compressBlock(){for(let e=0;e<this._lastLit;e++){var t,s,i=255&this._lBuf[e],a=this._dBuf[e];0!=a--?(t=L._lCode(i),this._literalTree.writeSymbol(t),0<(t=Math.floor((t-261)/4))&&t<=5&&this.pending.writeBits(i&(1<<t)-1,t),s=L._dCode(a),this._distTree.writeSymbol(s),0<(t=Math.floor(s/2)-1)&&this.pending.writeBits(a&(1<<t)-1,t)):this._literalTree.writeSymbol(i)}this._literalTree.writeSymbol(L._eofSymbol)}tallyDist(e,t){this._dBuf[this._lastLit]=e,this._lBuf[this._lastLit++]=t-3;t=L._lCode(t-3),this._literalTree.freqs[t]++,265<=t&&t<285&&(this._extraBits+=Math.floor((t-261)/4)),t=L._dCode(e-1);return this._distTree.freqs[t]++,4<=t&&(this._extraBits+=Math.floor(t/2)-1),this.isFull()}tallyLit(e){return this._dBuf[this._lastLit]=0,this._lBuf[this._lastLit++]=e,this._literalTree.freqs[e]++,this.isFull()}static _lCode(e){if(255===e)return 285;let t=257;for(;8<=e;)t+=4,e>>=1;return t+e}static _dCode(e){let t=0;for(;4<=e;)t+=2,e>>=1;return t+e}},eu=(L._bufSize=1<<Kc.defaultMemLevel+6,L._literalNum=286,L.storedBlock=0,L.staticTrees=1,L.dynTrees=2,L._distNum=30,L._staticLCodes=new Int16Array(L._literalNum),L._staticLLength=new Uint8Array(L._literalNum),L._staticDCodes=new Int16Array(L._distNum),L._staticDLength=new Uint8Array(L._distNum),L._blOrder=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],L._bit4Reverse=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]),L._bitLenNum=19,L._eofSymbol=256,L),tu=(eu.staticInit(),class tu{constructor(e){this._maxChain=128,this._niceLength=128,this._goodLength=8,this._insertHashIndex=0,this._lookahead=0,this._inputBuf=null,this._inputOff=0,this._inputEnd=0,this._prevAvailable=!1,this._matchStart=0,this._matchLen=0,this._pending=e,this._huffman=new eu(e),this.inputCrc=new jc,this._window=new Uint8Array(2*Kc.wsize),this._head=new Int16Array(Kc.hashSize),this._prev=new Int16Array(Kc.wsize),this._blockStart=1,this._strstart=1}reset(){this._huffman.reset(),this.inputCrc.reset(),this._blockStart=1,this._strstart=1,this._lookahead=0,this._prevAvailable=!1,this._matchLen=Kc.minMatch-1;for(let e=0;e<Kc.hashSize;e++)this._head[e]=0;for(let e=0;e<Kc.wsize;e++)this._prev[e]=0}_updateHash(){this._insertHashIndex=this._window[this._strstart]<<Kc.hashShift^this._window[this._strstart+1]}needsInput(){return this._inputEnd===this._inputOff}setInput(e,t,s){s=t+s;this._inputBuf=e,this._inputOff=t,this._inputEnd=s}deflate(e,t){let s;do{this.fillWindow();var i=e&&this._inputOff===this._inputEnd;s=this._deflateSlow(i,t)}while(this._pending.isFlushed&&s);return s}_deflateSlow(e,s){if(this._lookahead<Kc.minLookahead&&!e)return!1;for(;this._lookahead>=Kc.minLookahead||e;){if(0===this._lookahead)return this._prevAvailable&&this._huffman.tallyLit(255&this._window[this._strstart-1]),this._prevAvailable=!1,this._huffman.flushBlock(this._window,this._blockStart,this._strstart-this._blockStart,s),this._blockStart=this._strstart,!1;this._strstart>=2*Kc.wsize-Kc.minLookahead&&this._slideWindow();let e=this._matchStart,t=this._matchLen;if(this._lookahead>=Kc.minMatch&&0!==(i=this._insertString())&&this._strstart-i<=Kc.maxDist&&this._findLongestMatch(i)&&this._matchLen===Kc.minMatch&&this._strstart-this._matchStart>tu._tooFar&&(this._matchLen=Kc.minMatch-1),t>=Kc.minMatch&&this._matchLen<=t){for(this._huffman.tallyDist(this._strstart-1-e,t),t-=2;this._strstart++,this._lookahead--,this._lookahead>=Kc.minMatch&&this._insertString(),0<--t;);this._strstart++,this._lookahead--,this._prevAvailable=!1,this._matchLen=Kc.minMatch-1}else this._prevAvailable&&this._huffman.tallyLit(255&this._window[this._strstart-1]),this._prevAvailable=!0,this._strstart++,this._lookahead--;if(this._huffman.isFull()){let e=this._strstart-this._blockStart;this._prevAvailable&&e--;var i=s&&0===this._lookahead&&!this._prevAvailable;return this._huffman.flushBlock(this._window,this._blockStart,e,i),this._blockStart+=e,!i}}return!0}_findLongestMatch(e){let t,s=this._strstart,i=s+Math.min(Kc.maxMatch,this._lookahead)-1,a=Math.max(s-Kc.maxDist,0),r=this._window,n=this._prev,o=this._maxChain,h=Math.min(this._niceLength,this._lookahead);if(this._matchLen=Math.max(this._matchLen,Kc.minMatch-1),s+this._matchLen>i)return!1;let l=r[s+this._matchLen-1],d=r[s+this._matchLen];this._matchLen>=this._goodLength&&(o>>=2);do{if(t=e,s=this._strstart,r[t+this._matchLen]===d&&r[t+this._matchLen-1]===l&&r[t]===r[s]&&r[++t]===r[++s]){switch((i-s)%8){case 1:r[++s],r[++t];break;case 2:r[++s]===r[++t]&&(r[++s],r[++t]);break;case 3:r[++s]===r[++t]&&r[++s]===r[++t]&&(r[++s],r[++t]);break;case 4:r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&(r[++s],r[++t]);break;case 5:r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&(r[++s],r[++t]);break;case 6:r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&(r[++s],r[++t]);break;case 7:r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&(r[++s],r[++t])}if(r[s]===r[t])do{if(s===i){++s,++t;break}}while(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]);if(s-this._strstart>this._matchLen){if(this._matchStart=e,this._matchLen=s-this._strstart,this._matchLen>=h)break;l=r[s-1],d=r[s]}e=65535&n[e&Kc.wmask]}}while(a<e&&0!=--o);return this._matchLen>=Kc.minMatch}_insertString(){var e=(this._insertHashIndex<<Kc.hashShift^this._window[this._strstart+(Kc.minMatch-1)])&Kc.hashMask,t=this._head[e];return this._prev[this._strstart&Kc.wmask]=t,this._head[e]=this._strstart,this._insertHashIndex=e,65535&t}fillWindow(){if(this._strstart>=Kc.wsize+Kc.maxDist&&this._slideWindow(),this._lookahead<Kc.minLookahead&&this._inputOff<this._inputEnd){let e=2*Kc.wsize-this._lookahead-this._strstart;e>this._inputEnd-this._inputOff&&(e=this._inputEnd-this._inputOff),this._window.set(this._inputBuf.subarray(this._inputOff,this._inputOff+e),this._strstart+this._lookahead),this.inputCrc.update(this._inputBuf,this._inputOff,e),this._inputOff+=e,this._lookahead+=e}this._lookahead>=Kc.minMatch&&this._updateHash()}_slideWindow(){this._window.set(this._window.subarray(Kc.wsize,Kc.wsize+Kc.wsize),0),this._matchStart-=Kc.wsize,this._strstart-=Kc.wsize,this._blockStart-=Kc.wsize;for(let e=0;e<Kc.hashSize;++e){var t=65535&this._head[e];this._head[e]=Kc.wsize<=t?t-Kc.wsize:0}for(let e=0;e<Kc.wsize;e++){var s=65535&this._prev[e];this._prev[e]=Kc.wsize<=s?s-Kc.wsize:0}}}),su=(tu._tooFar=4096,tu),iu=class{constructor(e){this._start=0,this._end=0,this._bits=0,this.bitCount=0,this._buffer=new Uint8Array(e)}get isFlushed(){return 0===this._end}reset(){this._start=0,this._end=0,this.bitCount=0}writeShortMSB(e){this._buffer[this._end++]=e>>8&255,this._buffer[this._end++]=255&e}writeShort(e){this._buffer[this._end++]=e,this._buffer[this._end++]=e>>8}writeBlock(e,t,s){this._buffer.set(e.subarray(t,t+s),this._end),this._end+=s}flush(e,t,s){return 8<=this.bitCount&&(this._buffer[this._end++]=255&this._bits,this._bits>>=8,this.bitCount-=8),s>this._end-this._start?(s=this._end-this._start,e.set(this._buffer.subarray(this._start,this._start+s),t),this._start=0,this._end=0):(e.set(this._buffer.subarray(this._start,this._start+s),t),this._start+=s),s}writeBits(e,t){this._bits|=e<<this.bitCount,this.bitCount+=t,16<=this.bitCount&&(this._buffer[this._end++]=255&this._bits,this._buffer[this._end++]=this._bits>>8&255,this._bits>>=16,this.bitCount-=16)}alignToByte(){0<this.bitCount&&(this._buffer[this._end++]=255&this._bits,8<this.bitCount)&&(this._buffer[this._end++]=this._bits>>8&255),this._bits=0,this.bitCount=0}},au=class au{constructor(){this._state=0,this._pending=new iu(Kc.pendingBufSize),this._engine=new su(this._pending),this.reset()}get inputCrc(){return this._engine.inputCrc.value}get isNeedingInput(){return this._engine.needsInput()}get isFinished(){return this._state===au._finishedState&&this._pending.isFlushed}reset(){this._state=au._busyState,this._pending.reset(),this._engine.reset()}setInput(e,t,s){this._engine.setInput(e,t,s)}deflate(e,t,s){for(var i=s;;){var a=this._pending.flush(e,t,s);if(t+=a,0===(s-=a)||this._state===au._finishedState)break;if(!this._engine.deflate(0!=(this._state&au._isFlushing),0!=(this._state&au.isFinishing)))switch(this._state){case au._busyState:return i-s;case au._flushingState:let e=8+(7&-this._pending.bitCount);for(;0<e;)this._pending.writeBits(2,10),e-=10;this._state=au._busyState;break;case au._finishingState:this._pending.alignToByte(),this._state=au._finishedState}}return i-s}finish(){this._state|=au._isFlushing|au.isFinishing}},ru=(au._isFlushing=4,au.isFinishing=8,au._busyState=16,au._flushingState=20,au._finishingState=28,au._finishedState=30,au),nu=class{constructor(e,t,s,i,a){this.entry=e,this.crc32=t,this.localHeaderOffset=s,this.compressionMode=i,this.compressedSize=a}},ou=class{constructor(e){this._centralDirectoryHeaders=[],this._deflater=new ru,this._data=e}writeEntry(e){var t=As.CompressionMethodDeflate,s=Bs.empty(),i=this._compress(s,e.data,t),a=s.toArray(),s=new nu(e,i,this._data.bytesWritten,t,s.length),s=(this._centralDirectoryHeaders.push(s),f.writeInt32LE(this._data,As.LocalFileHeaderSignature),f.writeUInt16LE(this._data,10),f.writeUInt16LE(this._data,2048),f.writeUInt16LE(this._data,t),f.writeInt16LE(this._data,0),f.writeInt16LE(this._data,0),f.writeInt32LE(this._data,i),f.writeInt32LE(this._data,a.length),f.writeInt32LE(this._data,e.data.length),f.writeInt16LE(this._data,e.fullName.length),f.writeInt16LE(this._data,0),f.stringToBytes(e.fullName));this._data.write(s,0,s.length),this._data.write(a,0,a.length)}_compress(e,t,s){if(s!==As.CompressionMethodDeflate)return(s=new jc).update(t,0,t.length),e.write(t,0,t.length),s.value;var i=new Uint8Array(512);for(this._deflater.reset(),this._deflater.setInput(t,0,t.length);!this._deflater.isNeedingInput;){var a=this._deflater.deflate(i,0,i.length);if(a<=0)break;e.write(i,0,a)}for(this._deflater.finish();!this._deflater.isFinished;){var r=this._deflater.deflate(i,0,i.length);if(r<=0)break;e.write(i,0,r)}return this._deflater.inputCrc}end(){var e,t=this._data.bytesWritten;for(e of this._centralDirectoryHeaders)this._writeCentralDirectoryHeader(e);var s=this._data.bytesWritten;this._writeEndOfCentralDirectoryRecord(t,s)}_writeEndOfCentralDirectoryRecord(e,t){f.writeInt32LE(this._data,As.EndOfCentralDirSignature),f.writeInt16LE(this._data,0),f.writeInt16LE(this._data,0),f.writeInt16LE(this._data,this._centralDirectoryHeaders.length),f.writeInt16LE(this._data,this._centralDirectoryHeaders.length),f.writeInt32LE(this._data,t-e),f.writeInt32LE(this._data,e),f.writeInt16LE(this._data,0)}_writeCentralDirectoryHeader(e){f.writeInt32LE(this._data,As.CentralFileHeaderSignature),f.writeUInt16LE(this._data,10),f.writeUInt16LE(this._data,10),f.writeUInt16LE(this._data,2048),f.writeUInt16LE(this._data,e.compressionMode),f.writeInt16LE(this._data,0),f.writeInt16LE(this._data,0),f.writeInt32LE(this._data,e.crc32),f.writeInt32LE(this._data,e.compressedSize),f.writeInt32LE(this._data,e.entry.data.length),f.writeInt16LE(this._data,e.entry.fullName.length),f.writeInt16LE(this._data,0),f.writeInt16LE(this._data,0),f.writeInt16LE(this._data,0),f.writeInt16LE(this._data,0),f.writeInt32LE(this._data,0),f.writeInt32LE(this._data,e.localHeaderOffset);e=f.stringToBytes(e.entry.fullName);this._data.write(e,0,e.length)}},hu=class extends Gc{get name(){return"Guitar Pro 7-8"}writeScore(e){M.debug(this.name,"Writing data entries");var t=new Jc,s=t.writeXml(e),i=oi.writeForScore(e),a=mi.writeForScore(e),r=bi.writeForScore(e),n=(M.debug(this.name,"Writing ZIP entries"),new ou(this.data));n.writeEntry(new As("VERSION",f.stringToBytes("7.0"))),n.writeEntry(new As("Content/",new Uint8Array(0))),n.writeEntry(new As("Content/BinaryStylesheet",i)),n.writeEntry(new As("Content/PartConfiguration",a)),n.writeEntry(new As("Content/LayoutConfiguration",r)),n.writeEntry(new As("Content/score.gpif",f.stringToBytes(s))),t.backingTrackAssetFileName&&n.writeEntry(new As(t.backingTrackAssetFileName,e.backingTrack.rawAudioFile)),n.end()}},lu={},du=(G(lu,{AlphaSynthMidiFileHandler:()=>so,AlphaTabMetronomeEvent:()=>Zi,AlphaTabRestEvent:()=>ea,AlphaTabSysExEvent:()=>Qi,AlphaTabSystemExclusiveEvents:()=>yu,BeatTickLookup:()=>no,BeatTickLookupItem:()=>ro,ControlChangeEvent:()=>aa,ControllerType:()=>Cr,DeprecatedMidiEvent:()=>du,EndOfTrackEvent:()=>la,MasterBarTickLookup:()=>ho,MasterBarTickLookupTempoChange:()=>oo,MetaDataEvent:()=>pu,MetaEvent:()=>uu,MetaEventType:()=>cu,MetaNumberEvent:()=>mu,Midi20PerNotePitchBendEvent:()=>gu,MidiEvent:()=>ji,MidiEventType:()=>qi,MidiFile:()=>Ji,MidiFileFormat:()=>Yi,MidiFileGenerator:()=>bo,MidiTickLookup:()=>uo,MidiTickLookupFindBeatResult:()=>co,MidiTickLookupFindBeatResultCursorMode:()=>lo,MidiTrack:()=>Xi,NoteBendEvent:()=>ha,NoteEvent:()=>ta,NoteOffEvent:()=>ia,NoteOnEvent:()=>sa,PitchBendEvent:()=>oa,ProgramChangeEvent:()=>ra,SystemCommonEvent:()=>bu,SystemCommonType:()=>fu,SystemExclusiveEvent:()=>_u,TempoChangeEvent:()=>na,TimeSignatureEvent:()=>$i}),class extends ji{constructor(){super(0,0,47)}writeTo(e){throw new b(0,"Deprecated event, serialization not supported")}}),cu=((S=cu||{})[S.SequenceNumber=0]="SequenceNumber",S[S.TextEvent=1]="TextEvent",S[S.CopyrightNotice=2]="CopyrightNotice",S[S.SequenceOrTrackName=3]="SequenceOrTrackName",S[S.InstrumentName=4]="InstrumentName",S[S.LyricText=5]="LyricText",S[S.MarkerText=6]="MarkerText",S[S.CuePoint=7]="CuePoint",S[S.PatchName=8]="PatchName",S[S.PortName=9]="PortName",S[S.MidiChannel=32]="MidiChannel",S[S.MidiPort=33]="MidiPort",S[S.EndOfTrack=47]="EndOfTrack",S[S.Tempo=81]="Tempo",S[S.SmpteOffset=84]="SmpteOffset",S[S.TimeSignature=88]="TimeSignature",S[S.KeySignature=89]="KeySignature",S[S.SequencerSpecific=127]="SequencerSpecific",S),uu=class extends du{get metaStatus(){return 47}},pu=class extends uu{constructor(){super(...arguments),this.data=new Uint8Array}},mu=class extends uu{constructor(){super(...arguments),this.value=0}},gu=class extends du{constructor(){super(...arguments),this.noteKey=0,this.pitch=0}},fu=((n=fu||{})[n.SystemExclusive=240]="SystemExclusive",n[n.MtcQuarterFrame=241]="MtcQuarterFrame",n[n.SongPosition=242]="SongPosition",n[n.SongSelect=243]="SongSelect",n[n.TuneRequest=246]="TuneRequest",n[n.SystemExclusive2=247]="SystemExclusive2",n),bu=class extends du{},yu=((ii=yu||{})[ii.MetronomeTick=0]="MetronomeTick",ii[ii.Rest=1]="Rest",ii),_u=class extends bu{constructor(){super(...arguments),this.data=new Uint8Array}get isMetronome(){return!1}get metronomeNumerator(){return-1}get metronomeDurationInTicks(){return-1}get metronomeDurationInMilliseconds(){return-1}get isRest(){return!1}get manufacturerId(){return 0}},Su=(_u.AlphaTabManufacturerId=125,{}),vu=(G(Su,{AccentuationType:()=>ae,AccidentalType:()=>Ze,Automation:()=>K,AutomationType:()=>j,BackingTrack:()=>hi,Bar:()=>Ae,BarLineStyle:()=>Ie,BarStyle:()=>De,BarSubElement:()=>Fe,BarreShape:()=>bt,Beat:()=>wt,BeatBeamingMode:()=>_t,BeatStyle:()=>vt,BeatSubElement:()=>St,BendPoint:()=>w,BendStyle:()=>Q,BendType:()=>Z,BracketExtendMode:()=>Se,BrushType:()=>ee,Chord:()=>Ht,Clef:()=>Pe,Color:()=>Ut,CrescendoType:()=>te,Direction:()=>Dt,Duration:()=>se,DynamicValue:()=>q,ElementStyle:()=>xe,FadeType:()=>gt,Fermata:()=>At,FermataType:()=>It,Fingers:()=>re,Font:()=>A,FontStyle:()=>zr,FontWeight:()=>Ur,GolpeType:()=>mt,GraceGroup:()=>Re,GraceType:()=>ie,HarmonicType:()=>ne,HeaderFooterStyle:()=>Xe,InstrumentArticulation:()=>h,JsonConverter:()=>qn,KeySignature:()=>Me,KeySignatureType:()=>Ee,Lyrics:()=>Xt,MasterBar:()=>$e,MusicFontSymbol:()=>Qe,Note:()=>dt,NoteAccidentalMode:()=>oe,NoteOrnament:()=>nt,NoteStyle:()=>lt,NoteSubElement:()=>ht,Ottavia:()=>he,PickStroke:()=>it,PlaybackInformation:()=>Kt,Rasgueado:()=>yt,RenderStylesheet:()=>Te,RepeatGroup:()=>Be,Score:()=>qe,ScoreStyle:()=>Je,ScoreSubElement:()=>Ye,Section:()=>Jt,SimileMark:()=>Ne,SlideInType:()=>le,SlideOutType:()=>de,Staff:()=>$t,SustainPedalMarker:()=>Ce,SustainPedalMarkerType:()=>Le,SyncPointData:()=>$,TechniqueSymbolPlacement:()=>at,Track:()=>ts,TrackNameMode:()=>ke,TrackNameOrientation:()=>we,TrackNamePolicy:()=>ve,TrackStyle:()=>Zt,TrackSubElement:()=>Qt,TripletFeel:()=>je,Tuning:()=>qt,TupletGroup:()=>ut,VibratoType:()=>ce,Voice:()=>We,VoiceStyle:()=>Ve,VoiceSubElement:()=>Oe,WahPedal:()=>ft,WhammyType:()=>pt}),{}),ku=(G(vu,{CssFontSvgCanvas:()=>ih,Cursors:()=>Uo,FontSizeDefinition:()=>Kn,FontSizes:()=>Zn,MeasuredText:()=>ze,SvgCanvas:()=>sh,TextAlign:()=>He,TextBaseline:()=>Ge}),{}),wu=(G(ku,{ActiveBeatsChangedEventArgs:()=>xo,AlphaSynth:()=>Vr,AlphaSynthAudioWorkletOutput:()=>Ui,AlphaSynthBase:()=>Or,AlphaSynthScriptProcessorOutput:()=>Ho,AlphaSynthWebAudioOutputBase:()=>Hi,AlphaSynthWebWorkerApi:()=>Go,AudioExportChunk:()=>Rr,AudioExportOptions:()=>Ar,BackingTrackSyncPoint:()=>ca,CircularSampleBuffer:()=>Di,MidiEventsPlayedEventArgs:()=>Dr,PlaybackRange:()=>Co,PlaybackRangeChangedEventArgs:()=>Ir,PlayerState:()=>ga,PlayerStateChangedEventArgs:()=>fa,PositionChangedEventArgs:()=>ba}),{}),Tu={};return E.isRunningInWorker?E.initializeWorker():E.isRunningInAudioWorklet?E.initializeAudioWorklet():E.initializeMain(s=>{if(1===E.webPlatform)throw new b(0,"Workers not yet supported in Node.js");if(2===E.webPlatform||E.isWebPackBundled||E.isViteBundled){M.debug("AlphaTab","Creating webworker");try{return new E.alphaTabWorker(new E.alphaTabUrl("./alphaTab.worker.ts",Tu.url),{type:"module"})}catch(e){M.debug("AlphaTab","ESM webworker construction with direct URL failed",e)}let t="";try{t=new E.alphaTabUrl("./alphaTab.worker.ts",Tu.url);var e="import "+JSON.stringify(t),i=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(i),{type:"module"})}catch(e){M.debug("AlphaTab","ESM webworker construction with blob import failed",t,e)}try{if(!s.core.scriptFile)throw new Error("Could not detect alphaTab script file");t=s.core.scriptFile;var a="import "+JSON.stringify(s.core.scriptFile),r=new Blob([a],{type:"application/javascript"});return new Worker(URL.createObjectURL(r),{type:"module"})}catch(e){M.debug("AlphaTab","ESM webworker construction with blob import failed",s.core.scriptFile,e)}}if(!s.core.scriptFile)throw new b(0,"Could not detect alphaTab script file, cannot initialize renderer");try{M.debug("AlphaTab","Creating Blob worker");var t=`importScripts('${s.core.scriptFile}')`,n=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(n))}catch{return M.warning("Rendering","Could not create inline worker, fallback to normal worker"),new Worker(s.core.scriptFile)}},(e,t)=>{if(1===E.webPlatform)throw new b(0,"Audio Worklets not yet supported in Node.js");return 2===E.webPlatform||E.isWebPackBundled||E.isViteBundled?(M.debug("AlphaTab","Creating Module worklet"),e.audioWorklet.addModule(new E.alphaTabUrl("./alphaTab.worklet.ts",Tu.url))):(M.debug("AlphaTab","Creating Script worklet"),e.audioWorklet.addModule(t.core.scriptFile))}),D=Y,((t,s,i,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let e of O(s))V.call(t,e)||e===i||C(t,e,{get:()=>s[e],enumerable:!(a=R(s,e))||a.enumerable});return t})(C({},"__esModule",{value:!0}),D)})();