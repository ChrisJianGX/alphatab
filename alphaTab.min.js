"use strict";var alphaTab=(()=>{var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),r=e=>{throw TypeError(e)},n=(t,s)=>{for(var i in s)e(t,i,{get:s[i],enumerable:!0})},o=(e,t,s)=>{var i,n;null!=t?("object"!=typeof t&&"function"!=typeof t&&r("Object expected"),s&&(i=t[a("asyncDispose")]),void 0===i&&(i=t[a("dispose")],s&&(n=i)),"function"!=typeof i&&r("Object not disposable"),n&&(i=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.push([s,i,t])):s&&e.push([s]);return t},l=(e,t,s)=>{var i="function"==typeof SuppressedError?SuppressedError:function(e,t,s,i){return(i=Error(s)).name="SuppressedError",i.error=e,i.suppressed=t,i},a=e=>t=s?new i(e,t,"An error was suppressed during disposal"):(s=!0,e),r=i=>{for(;i=e.pop();)try{var n=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(n).then(r,e=>(a(e),r()))}catch(e){a(e)}if(s)throw t};return r()},h={};n(h,{AlphaTabApi:()=>_l,AlphaTabApiBase:()=>tl,AlphaTabError:()=>u,AlphaTabErrorType:()=>c,ConsoleLogger:()=>ee,CoreSettings:()=>_u,DisplaySettings:()=>bn,EngravingSettings:()=>un,EngravingStemInfo:()=>dn,Environment:()=>bu,ExporterSettings:()=>Rn,FileLoadError:()=>sl,FingeringMode:()=>X,FontFileFormat:()=>yu,FormatError:()=>Xt,ImporterSettings:()=>yn,LayoutMode:()=>hs,LogLevel:()=>Q,Logger:()=>re,NotationElement:()=>J,NotationMode:()=>$,NotationSettings:()=>j,PlayerMode:()=>Tn,PlayerOutputMode:()=>wn,PlayerSettings:()=>Bn,ProgressEventArgs:()=>yl,RenderEngineFactory:()=>gu,RenderingResources:()=>mn,ResizeEventArgs:()=>Ro,ScrollMode:()=>_n,Settings:()=>On,SlidePlaybackSettings:()=>kn,StaveProfile:()=>gn,SystemsLayoutMode:()=>fn,TabRhythmMode:()=>Y,VibratoPlaybackSettings:()=>Sn,WebPlatform:()=>go,exporter:()=>Tu,importer:()=>Su,io:()=>wu,json:()=>hp,meta:()=>g,midi:()=>$u,model:()=>rp,platform:()=>np,rendering:()=>os,synth:()=>op});typeof Symbol.dispose>"u"&&(Symbol.dispose=Symbol("Symbol.dispose")),typeof window<"u"&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=class{constructor(e){this._targets=new Set,this._callback=e,window.addEventListener("resize",this._onWindowResize.bind(this),!1)}observe(e){this._targets.add(e)}unobserve(e){this._targets.delete(e)}disconnect(){this._targets.clear()}_onWindowResize(){let e=[];for(let t of this._targets)e.push({target:t,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(e,this)}}),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=class{constructor(e){this._elements=[],this._timer=null,this._callback=e,window.addEventListener("resize",()=>this._check,!0),document.addEventListener("scroll",()=>this._check,!0)}_check(){this._timer||(this._timer=setTimeout(()=>{this._doCheck(),this._timer=null},100))}observe(e){this._elements.indexOf(e)>=0||(this._elements.push(e),this._check())}unobserve(e){this._elements=this._elements.filter(t=>t!==e)}_doCheck(){let e=[];for(let t of this._elements){let s=t.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&e.push({target:t,isIntersecting:!0})}e.length&&this._callback(e,this)}}),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...e){this.innerHTML="",this.append(...e)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)});var d,c=((d=c||{})[d.General=0]="General",d[d.Format=1]="Format",d[d.AlphaTex=2]="AlphaTex",d),u=class extends Error{constructor(e,t="",s){super(t??"",{cause:s}),this.type=e}},p=class e{static print(t){t("alphaTab "+e.version),t("commit: "+e.commit),t("build date: "+e.date)}};p.version="1.7.0",p.date="2025-11-24T00:38:00.000Z",p.commit="dev";var m,g=p,f=((m=f||{})[m.PPP=0]="PPP",m[m.PP=1]="PP",m[m.P=2]="P",m[m.MP=3]="MP",m[m.MF=4]="MF",m[m.F=5]="F",m[m.FF=6]="FF",m[m.FFF=7]="FFF",m[m.PPPP=8]="PPPP",m[m.PPPPP=9]="PPPPP",m[m.PPPPPP=10]="PPPPPP",m[m.FFFF=11]="FFFF",m[m.FFFFF=12]="FFFFF",m[m.FFFFFF=13]="FFFFFF",m[m.SF=14]="SF",m[m.SFP=15]="SFP",m[m.SFPP=16]="SFPP",m[m.FP=17]="FP",m[m.RF=18]="RF",m[m.RFZ=19]="RFZ",m[m.SFZ=20]="SFZ",m[m.SFFZ=21]="SFFZ",m[m.FZ=22]="FZ",m[m.N=23]="N",m[m.PF=24]="PF",m[m.SFZP=25]="SFZP",m),b=class e{static ticksToMillis(t,s){return t*(6e4/(s*e.QuarterTime))|0}static millisToTicks(t,s){return t/(6e4/(s*e.QuarterTime))|0}static toTicks(t){return e.valueToTicks(t)}static valueToTicks(t){let s=t;return s<0&&(s=1/-s),e.QuarterTime*(4/s)|0}static applyDot(e,t){return t?e+3*(e/4|0):e+(e/2|0)}static applyTuplet(e,t,s){return e*s/t|0}static removeTuplet(e,t,s){return e*t/s|0}static dynamicToVelocity(t,s=0){let i=1;switch(t){case 0:i=e._minVelocity+0*e.VelocityIncrement;break;case 1:i=e._minVelocity+1*e.VelocityIncrement;break;case 2:i=e._minVelocity+2*e.VelocityIncrement;break;case 3:i=e._minVelocity+3*e.VelocityIncrement;break;case 4:i=e._minVelocity+4*e.VelocityIncrement;break;case 5:case 17:case 18:case 19:case 21:i=e._minVelocity+5*e.VelocityIncrement;break;case 6:case 14:case 15:case 25:case 16:case 20:case 22:i=e._minVelocity+6*e.VelocityIncrement;break;case 7:i=e._minVelocity+7*e.VelocityIncrement;break;case 8:i=10;break;case 9:i=5;break;case 10:i=3;break;case 11:i=e._minVelocity+8*e.VelocityIncrement;break;case 12:i=e._minVelocity+9*e.VelocityIncrement;break;case 13:i=e._minVelocity+10*e.VelocityIncrement;break;case 23:i=1;break;case 24:i=e._minVelocity+(4.5*e.VelocityIncrement|0)}return i+=s*e.VelocityIncrement,Math.min(Math.max(i,1),127)}};b.QuarterTime=960,b._minVelocity=15,b.VelocityIncrement=16;var y,_=b,S=((y=S||{})[y.Tempo=0]="Tempo",y[y.Volume=1]="Volume",y[y.Instrument=2]="Instrument",y[y.Balance=3]="Balance",y[y.SyncPoint=4]="SyncPoint",y[y.Bank=4]="Bank",y),k=class{constructor(){this.barOccurence=0,this.millisecondOffset=0}},w=class e{constructor(){this.isLinear=!1,this.type=0,this.value=0,this.ratioPosition=0,this.text="",this.isVisible=!0}static buildTempoAutomation(t,s,i,a,r=!0){(a<1||a>5)&&(a=2);let n=new Float32Array([1,.5,1,1.5,2,3]),o=new e;return o.type=0,o.isLinear=t,o.ratioPosition=s,o.value=i*n[a],o.isVisible=r,o}static buildInstrumentAutomation(t,s,i){let a=new e;return a.type=2,a.isLinear=t,a.ratioPosition=s,a.value=i,a}},T=class{constructor(e=0,t=0){this.offset=e,this.value=t}};T.MaxPosition=60,T.MaxValue=12;var B,x,v,P,N,M,E,L=(e=>(e[e.Default=0]="Default",e[e.Gradual=1]="Gradual",e[e.Fast=2]="Fast",e))(L||{}),C=((B=C||{})[B.None=0]="None",B[B.Custom=1]="Custom",B[B.Bend=2]="Bend",B[B.Release=3]="Release",B[B.BendRelease=4]="BendRelease",B[B.Hold=5]="Hold",B[B.Prebend=6]="Prebend",B[B.PrebendBend=7]="PrebendBend",B[B.PrebendRelease=8]="PrebendRelease",B),F=((x=F||{})[x.None=0]="None",x[x.BrushUp=1]="BrushUp",x[x.BrushDown=2]="BrushDown",x[x.ArpeggioUp=3]="ArpeggioUp",x[x.ArpeggioDown=4]="ArpeggioDown",x),D=(e=>(e[e.None=0]="None",e[e.Crescendo=1]="Crescendo",e[e.Decrescendo=2]="Decrescendo",e))(D||{}),I=((v=I||{})[v.QuadrupleWhole=-4]="QuadrupleWhole",v[v.DoubleWhole=-2]="DoubleWhole",v[v.Whole=1]="Whole",v[v.Half=2]="Half",v[v.Quarter=4]="Quarter",v[v.Eighth=8]="Eighth",v[v.Sixteenth=16]="Sixteenth",v[v.ThirtySecond=32]="ThirtySecond",v[v.SixtyFourth=64]="SixtyFourth",v[v.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",v[v.TwoHundredFiftySixth=256]="TwoHundredFiftySixth",v),A=((P=A||{})[P.None=0]="None",P[P.OnBeat=1]="OnBeat",P[P.BeforeBeat=2]="BeforeBeat",P[P.BendGrace=3]="BendGrace",P),R=(e=>(e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Heavy=2]="Heavy",e[e.Tenuto=3]="Tenuto",e))(R||{}),O=((N=O||{})[N.Unknown=-2]="Unknown",N[N.NoOrDead=-1]="NoOrDead",N[N.Thumb=0]="Thumb",N[N.IndexFinger=1]="IndexFinger",N[N.MiddleFinger=2]="MiddleFinger",N[N.AnnularFinger=3]="AnnularFinger",N[N.LittleFinger=4]="LittleFinger",N),V=(e=>(e[e.None=0]="None",e[e.Natural=1]="Natural",e[e.Artificial=2]="Artificial",e[e.Pinch=3]="Pinch",e[e.Tap=4]="Tap",e[e.Semi=5]="Semi",e[e.Feedback=6]="Feedback",e))(V||{}),W=(e=>(e[e.Default=0]="Default",e[e.ForceNone=1]="ForceNone",e[e.ForceNatural=2]="ForceNatural",e[e.ForceSharp=3]="ForceSharp",e[e.ForceDoubleSharp=4]="ForceDoubleSharp",e[e.ForceFlat=5]="ForceFlat",e[e.ForceDoubleFlat=6]="ForceDoubleFlat",e))(W||{}),H=(e=>(e[e._15ma=0]="_15ma",e[e._8va=1]="_8va",e[e.Regular=2]="Regular",e[e._8vb=3]="_8vb",e[e._15mb=4]="_15mb",e))(H||{}),G=(e=>(e[e.None=0]="None",e[e.IntoFromBelow=1]="IntoFromBelow",e[e.IntoFromAbove=2]="IntoFromAbove",e))(G||{}),z=(e=>(e[e.None=0]="None",e[e.Shift=1]="Shift",e[e.Legato=2]="Legato",e[e.OutUp=3]="OutUp",e[e.OutDown=4]="OutDown",e[e.PickSlideDown=5]="PickSlideDown",e[e.PickSlideUp=6]="PickSlideUp",e))(z||{}),U=(e=>(e[e.None=0]="None",e[e.Slight=1]="Slight",e[e.Wide=2]="Wide",e))(U||{}),Y=(e=>(e[e.Hidden=0]="Hidden",e[e.ShowWithBeams=1]="ShowWithBeams",e[e.ShowWithBars=2]="ShowWithBars",e[e.Automatic=3]="Automatic",e))(Y||{}),X=(e=>(e[e.ScoreDefault=0]="ScoreDefault",e[e.ScoreForcePiano=1]="ScoreForcePiano",e[e.SingleNoteEffectBand=2]="SingleNoteEffectBand",e[e.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",e))(X||{}),$=((E=$||{})[E.GuitarPro=0]="GuitarPro",E[E.SongBook=1]="SongBook",E),J=((M=J||{})[M.ScoreTitle=0]="ScoreTitle",M[M.ScoreSubTitle=1]="ScoreSubTitle",M[M.ScoreArtist=2]="ScoreArtist",M[M.ScoreAlbum=3]="ScoreAlbum",M[M.ScoreWords=4]="ScoreWords",M[M.ScoreMusic=5]="ScoreMusic",M[M.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",M[M.ScoreCopyright=7]="ScoreCopyright",M[M.GuitarTuning=8]="GuitarTuning",M[M.TrackNames=9]="TrackNames",M[M.ChordDiagrams=10]="ChordDiagrams",M[M.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",M[M.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",M[M.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",M[M.EffectAlternateEndings=14]="EffectAlternateEndings",M[M.EffectCapo=15]="EffectCapo",M[M.EffectChordNames=16]="EffectChordNames",M[M.EffectCrescendo=17]="EffectCrescendo",M[M.EffectDynamics=18]="EffectDynamics",M[M.EffectFadeIn=19]="EffectFadeIn",M[M.EffectFermata=20]="EffectFermata",M[M.EffectFingering=21]="EffectFingering",M[M.EffectHarmonics=22]="EffectHarmonics",M[M.EffectLetRing=23]="EffectLetRing",M[M.EffectLyrics=24]="EffectLyrics",M[M.EffectMarker=25]="EffectMarker",M[M.EffectOttavia=26]="EffectOttavia",M[M.EffectPalmMute=27]="EffectPalmMute",M[M.EffectPickSlide=28]="EffectPickSlide",M[M.EffectPickStroke=29]="EffectPickStroke",M[M.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",M[M.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",M[M.EffectTap=32]="EffectTap",M[M.EffectTempo=33]="EffectTempo",M[M.EffectText=34]="EffectText",M[M.EffectTrill=35]="EffectTrill",M[M.EffectTripletFeel=36]="EffectTripletFeel",M[M.EffectWhammyBar=37]="EffectWhammyBar",M[M.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",M[M.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",M[M.EffectLeftHandTap=40]="EffectLeftHandTap",M[M.EffectFreeTime=41]="EffectFreeTime",M[M.EffectSustainPedal=42]="EffectSustainPedal",M[M.EffectGolpe=43]="EffectGolpe",M[M.EffectWahPedal=44]="EffectWahPedal",M[M.EffectBeatBarre=45]="EffectBeatBarre",M[M.EffectNoteOrnament=46]="EffectNoteOrnament",M[M.EffectRasgueado=47]="EffectRasgueado",M[M.EffectDirections=48]="EffectDirections",M[M.EffectBeatTimer=49]="EffectBeatTimer",M),q=class e{constructor(){this.notationMode=0,this.fingeringMode=0,this.showChordDiagramsOnBeats=!0,this.elements=new Map,this.rhythmMode=3,this.rhythmHeight=15,this.transpositionPitches=[],this.displayTranspositionPitches=[],this.smallGraceTabNotes=!0,this.extendBendArrowsOnTiedNotes=!0,this.extendLineEffectsToBeatEnd=!1,this.slurHeight=5}isNotationElementVisible(t){return this.elements.has(t)?this.elements.get(t):!e.defaultElements.has(t)||e.defaultElements.get(t)}};q.defaultElements=new Map([[13,!1]]);var j=q,K=class{constructor(e){this._value=void 0,this._factory=e}get hasValue(){return void 0!==this._value}get value(){return void 0===this._value&&(this._value=this._factory()),this._value}reset(){this._value=void 0}},Q=(e=>(e[e.None=0]="None",e[e.Debug=1]="Debug",e[e.Info=2]="Info",e[e.Warning=3]="Warning",e[e.Error=4]="Error",e))(Q||{}),Z=class e{static _format(e,t){return`[AlphaTab][${e}] ${t}`}debug(t,s,...i){console.debug(e._format(t,s),...i)}warning(t,s,...i){console.warn(e._format(t,s),...i)}info(t,s,...i){console.info(e._format(t,s),...i)}error(t,s,...i){console.error(e._format(t,s),...i)}};Z.logLevel=2;var ee=Z,te=class e{static _shouldLog(t){return 0!==e.logLevel&&t>=e.logLevel}static debug(t,s,...i){e._shouldLog(1)&&e.log.debug(t,s,...i)}static warning(t,s,...i){e._shouldLog(3)&&e.log.warning(t,s,...i)}static info(t,s,...i){e._shouldLog(2)&&e.log.info(t,s,...i)}static error(t,s,...i){e._shouldLog(4)&&e.log.error(t,s,...i)}};te.logLevel=2,te.log=new ee;var se,ie,ae,re=te,ne=(e=>(e[e.NoBrackets=0]="NoBrackets",e[e.GroupStaves=1]="GroupStaves",e[e.GroupSimilarInstruments=2]="GroupSimilarInstruments",e))(ne||{}),oe=(e=>(e[e.Hidden=0]="Hidden",e[e.FirstSystem=1]="FirstSystem",e[e.AllSystems=2]="AllSystems",e))(oe||{}),le=(e=>(e[e.FullName=0]="FullName",e[e.ShortName=1]="ShortName",e))(le||{}),he=(e=>(e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e))(he||{}),de=class{constructor(){this.hideDynamics=!1,this.bracketExtendMode=1,this.useSystemSignSeparator=!1,this.globalDisplayTuning=!0,this.perTrackDisplayTuning=null,this.globalDisplayChordDiagramsOnTop=!0,this.perTrackChordDiagramsOnTop=null,this.singleTrackTrackNamePolicy=1,this.multiTrackTrackNamePolicy=1,this.firstSystemTrackNameMode=1,this.otherSystemsTrackNameMode=1,this.firstSystemTrackNameOrientation=1,this.otherSystemsTrackNameOrientation=1,this.multiTrackMultiBarRest=!1,this.perTrackMultiBarRest=null}},ce=class{constructor(){this.masterBars=[],this.opening=null,this.closings=[],this.isClosed=!1}get openings(){let e=this.opening;return e?[e]:[]}get isOpened(){return!0===this.opening?.isRepeatStart}addMasterBar(e){null===this.opening&&(this.opening=e),this.masterBars.push(e),e.repeatGroup=this,e.isRepeatEnd&&(this.closings.push(e),this.isClosed=!0)}},ue=class{constructor(){this.colors=new Map}},pe=(e=>(e[e.Neutral=0]="Neutral",e[e.C3=1]="C3",e[e.C4=2]="C4",e[e.F4=3]="F4",e[e.G2=4]="G2",e))(pe||{}),me=(e=>(e[e.None=0]="None",e[e.Simple=1]="Simple",e[e.FirstOfDouble=2]="FirstOfDouble",e[e.SecondOfDouble=3]="SecondOfDouble",e))(me||{}),ge=((se=ge||{})[se.Cb=-7]="Cb",se[se.Gb=-6]="Gb",se[se.Db=-5]="Db",se[se.Ab=-4]="Ab",se[se.Eb=-3]="Eb",se[se.Bb=-2]="Bb",se[se.F=-1]="F",se[se.C=0]="C",se[se.G=1]="G",se[se.D=2]="D",se[se.A=3]="A",se[se.E=4]="E",se[se.B=5]="B",se[se.FSharp=6]="FSharp",se[se.CSharp=7]="CSharp",se),fe=(e=>(e[e.Major=0]="Major",e[e.Minor=1]="Minor",e))(fe||{}),be=(e=>(e[e.Down=0]="Down",e[e.Hold=1]="Hold",e[e.Up=2]="Up",e))(be||{}),ye=class{constructor(){this.ratioPosition=0,this.pedalType=0,this.nextPedalMarker=null,this.previousPedalMarker=null}},_e=((ae=_e||{})[ae.StandardNotationRepeats=0]="StandardNotationRepeats",ae[ae.GuitarTabsRepeats=1]="GuitarTabsRepeats",ae[ae.SlashRepeats=2]="SlashRepeats",ae[ae.NumberedRepeats=3]="NumberedRepeats",ae[ae.StandardNotationBarNumber=4]="StandardNotationBarNumber",ae[ae.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",ae[ae.SlashBarNumber=6]="SlashBarNumber",ae[ae.NumberedBarNumber=7]="NumberedBarNumber",ae[ae.StandardNotationBarLines=8]="StandardNotationBarLines",ae[ae.GuitarTabsBarLines=9]="GuitarTabsBarLines",ae[ae.SlashBarLines=10]="SlashBarLines",ae[ae.NumberedBarLines=11]="NumberedBarLines",ae[ae.StandardNotationClef=12]="StandardNotationClef",ae[ae.GuitarTabsClef=13]="GuitarTabsClef",ae[ae.StandardNotationKeySignature=14]="StandardNotationKeySignature",ae[ae.NumberedKeySignature=15]="NumberedKeySignature",ae[ae.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",ae[ae.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",ae[ae.SlashTimeSignature=18]="SlashTimeSignature",ae[ae.NumberedTimeSignature=19]="NumberedTimeSignature",ae[ae.StandardNotationStaffLine=20]="StandardNotationStaffLine",ae[ae.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",ae[ae.SlashStaffLine=22]="SlashStaffLine",ae[ae.NumberedStaffLine=23]="NumberedStaffLine",ae),Se=class extends ue{},ke=((ie=ke||{})[ie.Automatic=0]="Automatic",ie[ie.Dashed=1]="Dashed",ie[ie.Dotted=2]="Dotted",ie[ie.Heavy=3]="Heavy",ie[ie.HeavyHeavy=4]="HeavyHeavy",ie[ie.HeavyLight=5]="HeavyLight",ie[ie.LightHeavy=6]="LightHeavy",ie[ie.LightLight=7]="LightLight",ie[ie.None=8]="None",ie[ie.Regular=9]="Regular",ie[ie.Short=10]="Short",ie[ie.Tick=11]="Tick",ie),we=class e{constructor(){this.id=e._globalBarId++,this.index=0,this.nextBar=null,this.previousBar=null,this.clef=4,this.clefOttava=2,this.voices=[],this.simileMark=0,this._filledVoices=new Set([0]),this.displayScale=1,this.displayWidth=-1,this.sustainPedals=[],this._isEmpty=!0,this._isRestOnly=!0,this.barLineLeft=0,this.barLineRight=0,this.keySignature=0,this.keySignatureType=0}static resetIds(){e._globalBarId=0}get isMultiVoice(){return this._filledVoices.size>1}get filledVoices(){return this._filledVoices}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){return this._isEmpty}get hasChanges(){return 0===this.index||this.keySignature!==this.previousBar.keySignature||this.keySignatureType!==this.previousBar.keySignatureType||this.clef!==this.previousBar.clef||this.clefOttava!==this.previousBar.clefOttava||(0!==this.simileMark||this.sustainPedals.length>0||0!==this.barLineLeft||0!==this.barLineRight)}get isRestOnly(){return this._isRestOnly}getActualBarLineLeft(t){return e._actualBarLine(this,!1,t)}getActualBarLineRight(){return e._actualBarLine(this,!0,!1)}static _automaticToActualType(e,t,s){let i;return i=t?e.isRepeatEnd?6:e.nextMasterBar?e.isFreeTime?1:e.isDoubleBar?7:9:6:e.isRepeatStart?5:s?9:8,i}static _actualBarLine(t,s,i){let a,r=t.masterBar,n=s?t.barLineRight:t.barLineLeft;return a=0===n?e._automaticToActualType(r,s,i):n,a}addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(e,t=null){this._filledVoices.clear(),this._filledVoices.add(0),this._isEmpty=!0,this._isRestOnly=!0;for(let s=0,i=this.voices.length;s<i;s++){let i=this.voices[s];i.finish(e,t),i.isEmpty||(this._isEmpty=!1,this._filledVoices.add(s)),i.isRestOnly||(this._isRestOnly=!1)}let s=this.sustainPedals;if(s.length>0){let e=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(e=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1],2===e.pedalType&&(e=null));let t=null!==e&&2!==e.pedalType;for(let i of s){if(e&&2!==e.pedalType){if(e.bar===this&&i.ratioPosition<=e.ratioPosition)continue;e.nextPedalMarker=i,i.previousPedalMarker=e}t&&0===i.pedalType&&(i.pedalType=1),i.bar=this,this.sustainPedals.push(i),e=i}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){let e=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(2!==e.pedalType){let t=new ye;t.ratioPosition=0,t.bar=this,t.pedalType=1,this.sustainPedals.push(t),e.nextPedalMarker=t,t.previousPedalMarker=e}}}calculateDuration(){let e=0;for(let t of this.voices){let s=t.calculateDuration();s>e&&(e=s)}return e}};we._globalBarId=0;var Te,Be=we,xe=class{constructor(){this.beats=[],this.id="empty",this.isComplete=!1}addBeat(e){e.graceIndex=this.beats.length,e.graceGroup=this,this.beats.push(e)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}},ve=((Te=ve||{})[Te.Glyphs=0]="Glyphs",Te),Pe=class extends ue{},Ne=class e{constructor(){this._isEmpty=!0,this._isRestOnly=!0,this.id=e._globalVoiceId++,this.index=0,this.beats=[]}static resetIds(){e._globalVoiceId=0}get isEmpty(){return this._isEmpty}forceNonEmpty(){this._isEmpty=!1}get isRestOnly(){return this._isRestOnly}insertBeat(e,t){t.nextBeat=e.nextBeat,t.nextBeat&&(t.nextBeat.previousBeat=t),t.previousBeat=e,t.voice=this,e.nextBeat=t,this.beats.splice(e.index+1,0,t)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this._isEmpty=!1),e.isRest||(this._isRestOnly=!1)}_chain(e,t=null){if(this.bar){if(e.index<this.beats.length-1)e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e;else if(e.isLastOfVoice&&e.voice.bar.nextBar){let t=this.bar.nextBar.voices[this.index];t.beats.length>0&&(e.nextBeat=t.beats[0]),e.nextBeat.previousBeat=e}e.chain(t)}}addGraceBeat(e){if(0===this.beats.length)return void this.addBeat(e);let t=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(t),this._isEmpty=!1,this._isRestOnly=!1}getBeatAtPlaybackStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(e,t=null){this._isEmpty=!0,this._isRestOnly=!0,this._beatLookup=new Map;let s=null;for(let e=0;e<this.beats.length;e++){let i=this.beats[e];i.index=e,this._chain(i,t),0===i.graceType?(i.graceGroup=s,s&&(s.isComplete=!0),s=null):(s||(s=new xe),s.addBeat(i)),i.isEmpty||(this._isEmpty=!1),i.isRest||(this._isRestOnly=!1)}let i=0,a=0;for(let s=0;s<this.beats.length;s++){let r=this.beats[s];if(r.index=s,r.finish(e,t),0===r.graceType){if(r.graceGroup){let e=r.graceGroup.beats[0],t=r.graceGroup.beats[r.graceGroup.beats.length-1];if(3!==e.graceType){let s=t.playbackStart+t.playbackDuration-e.playbackStart;switch(e.graceType){case 2:e.previousBeat?(e.previousBeat.playbackDuration-=s,a=e.previousBeat.voice===this?e.previousBeat.playbackStart+e.previousBeat.playbackDuration:-s):a=-s;for(let e of r.graceGroup.beats)this._beatLookup.delete(e.playbackStart),e.playbackStart=a,this._beatLookup.set(e.playbackStart,r),a+=e.playbackDuration;break;case 1:r.playbackDuration-=s,a=t.voice===this?t.playbackStart+t.playbackDuration:-s}}}r.displayStart=i,r.playbackStart=a,this._beatLookup.set(r.playbackStart,r)}else r.displayStart=i,r.playbackStart=a;r.fermata?this.bar.masterBar.addFermata(r.playbackStart,r.fermata):r.fermata=this.bar.masterBar.getFermata(r),r.finishTuplet(),r.graceGroup&&r.graceGroup.finish(),i+=r.displayDuration,a+=r.playbackDuration}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;let e=this.beats[this.beats.length-1],t=this.beats[0];return e.playbackStart+e.playbackDuration-t.playbackStart}};Ne._globalVoiceId=0;var Me=Ne,Ee=(e=>(e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right",e))(Ee||{}),Le=(e=>(e[e.Top=0]="Top",e[e.Middle=1]="Middle",e[e.Bottom=2]="Bottom",e[e.Alphabetic=3]="Alphabetic",e))(Le||{}),Ce=class{constructor(e,t){this.width=e,this.height=t}},Fe=class{static fillMusicFontSymbolSafe(e,t,s,i,a,r){e.settings.display.resources.engravingSettings.hasSymbol(a)&&e.fillMusicFontSymbol(t,s,i,a,r)}static fillMusicFontSymbolsSafe(e,t,s,i,a,r){let n=a.filter(t=>e.settings.display.resources.engravingSettings.hasSymbol(t));0!==n.length&&e.fillMusicFontSymbols(t,s,i,n,r)}},De=(e=>(e[e.Title=0]="Title",e[e.SubTitle=1]="SubTitle",e[e.Artist=2]="Artist",e[e.Album=3]="Album",e[e.Words=4]="Words",e[e.Music=5]="Music",e[e.WordsAndMusic=6]="WordsAndMusic",e[e.Transcriber=7]="Transcriber",e[e.Copyright=8]="Copyright",e[e.CopyrightSecondLine=9]="CopyrightSecondLine",e[e.ChordDiagramList=10]="ChordDiagramList",e))(De||{}),Ie=class e{constructor(e="",t=void 0,s=0){this.template=e,this.isVisible=t,this.textAlign=s}static equals(e,t){return!((void 0===e.isVisible||e.isVisible)!==(void 0===t.isVisible||t.isVisible)||e.template!==t.template||e.textAlign!==t.textAlign)}buildText(t){let s=!1,i=!1,a=this.template.replace(e._placeholderPattern,(e,a)=>{i=!0;let r="";switch(a){case"TITLE":r=t.title;break;case"SUBTITLE":r=t.subTitle;break;case"ARTIST":r=t.artist;break;case"ALBUM":r=t.album;break;case"WORDS":case"WORDSMUSIC":r=t.words;break;case"MUSIC":r=t.music;break;case"TABBER":r=t.tab;break;case"COPYRIGHT":r=t.copyright;break;default:r=""}return r&&(s=!0),r});return i&&!s?"":a}};Ie._placeholderPattern=/%([^%]+)%/g;var Ae=Ie,Re=class extends ue{constructor(){super(...arguments),this.headerAndFooter=new Map}};Re.defaultHeaderAndFooter=new Map([[0,new Ae("%TITLE%",void 0,1)],[1,new Ae("%SUBTITLE%",void 0,1)],[2,new Ae("%ARTIST%",void 0,1)],[3,new Ae("%ALBUM%",void 0,1)],[4,new Ae("Words by %WORDS%",void 0,0)],[5,new Ae("Music by %MUSIC%",void 0,2)],[6,new Ae("Words & Music by %MUSIC%",void 0,2)],[7,new Ae("Tabbed by %TABBER%",!1,2)],[8,new Ae("%COPYRIGHT%",void 0,1)],[9,new Ae("All Rights Reserved - International Copyright Secured",!0,1)]]);var Oe=class{constructor(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0,this.album="",this.artist="",this.copyright="",this.instructions="",this.music="",this.notices="",this.subTitle="",this.title="",this.words="",this.tab="",this.masterBars=[],this.tracks=[],this.defaultSystemsLayout=3,this.systemsLayout=[],this.stylesheet=new de}static resetIds(){Be.resetIds(),wt.resetIds(),Me.resetIds(),nt.resetIds()}get tempo(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].value:120}get tempoLabel(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].text:""}rebuildRepeatGroups(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0;for(let e of this.masterBars)this._addMasterBarToRepeatGroups(e)}addMasterBar(e){e.score=this,e.index=this.masterBars.length,0!==this.masterBars.length&&(e.previousMasterBar=this.masterBars[this.masterBars.length-1],e.previousMasterBar.nextMasterBar=e,e.start=e.previousMasterBar.start+(e.previousMasterBar.isAnacrusis?0:e.previousMasterBar.calculateDuration())),this._addMasterBarToRepeatGroups(e),this.masterBars.push(e)}_addMasterBarToRepeatGroups(e){e.isRepeatStart?(this._currentRepeatGroup?.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new ce,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new ce,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(e),e.isRepeatEnd&&this._properlyOpenedRepeatGroups>1&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=this._openedRepeatGroups.length>0?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(e){e.score=this,e.index=this.tracks.length,this.tracks.push(e)}finish(e){let t=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(e,t)}applyFlatSyncPoints(e){for(let e of this.masterBars)e.syncPoints=void 0;for(let t of e){let e=new w;e.ratioPosition=Math.min(1,Math.max(0,t.barPosition)),e.type=4,e.syncPointValue=new k,e.syncPointValue.millisecondOffset=t.millisecondOffset,e.syncPointValue.barOccurence=t.barOccurence,t.barIndex<this.masterBars.length&&this.masterBars[t.barIndex].addSyncPoint(e)}for(let e of this.masterBars)e.syncPoints&&e.syncPoints.sort((e,t)=>{let s=e.syncPointValue.barOccurence-t.syncPointValue.barOccurence;return 0!==s?s:e.ratioPosition-t.ratioPosition})}exportFlatSyncPoints(){let e=[];for(let t of this.masterBars){let s=t.syncPoints;if(s)for(let i of s)e.push({barIndex:t.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return e}},Ve=(e=>(e[e.NoTripletFeel=0]="NoTripletFeel",e[e.Triplet16th=1]="Triplet16th",e[e.Triplet8th=2]="Triplet8th",e[e.Dotted16th=3]="Dotted16th",e[e.Dotted8th=4]="Dotted8th",e[e.Scottish16th=5]="Scottish16th",e[e.Scottish8th=6]="Scottish8th",e))(Ve||{}),We=class{constructor(){this.alternateEndings=0,this.nextMasterBar=null,this.previousMasterBar=null,this.index=0,this.isDoubleBar=!1,this.isRepeatStart=!1,this.repeatCount=0,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.timeSignatureCommon=!1,this.isFreeTime=!1,this.tripletFeel=0,this.section=null,this.tempoAutomations=[],this.fermata=null,this.start=0,this.isAnacrusis=!1,this.displayScale=1,this.displayWidth=-1,this.directions=null}get hasChanges(){return 0!==this.index&&(this.timeSignatureCommon!==this.previousMasterBar.timeSignatureCommon||this.timeSignatureNumerator!==this.previousMasterBar.timeSignatureNumerator||this.timeSignatureDenominator!==this.previousMasterBar.timeSignatureDenominator||this.tripletFeel!==this.previousMasterBar.tripletFeel||(0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||null!==this.fermata&&this.fermata.size>0||null!==this.directions&&this.directions.size>0||this.isAnacrusis))}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(e){this.score.tracks[0].staves[0].bars[this.index].keySignature=e}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(e){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=e}get isRepeatEnd(){return this.repeatCount>0}get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}calculateDuration(e=!0){if(this.isAnacrusis&&e){let e=0;for(let t of this.score.tracks)for(let s of t.staves){let t=this.index<s.bars.length?s.bars[this.index].calculateDuration():0;t>e&&(e=t)}return e}return this.timeSignatureNumerator*_.valueToTicks(this.timeSignatureDenominator)}addFermata(e,t){let s=this.fermata;null===s&&(s=new Map,this.fermata=s),s.set(e,t)}addDirection(e){null==this.directions&&(this.directions=new Set),this.directions.add(e)}getFermata(e){let t=this.fermata;return null===t?null:t.has(e.playbackStart)?t.get(e.playbackStart):0===e.index&&t.has(0)?t.get(0):null}addSyncPoint(e){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(e)}};We.MaxAlternateEndings=8;var He=class{};He.DefaultChannelCount=17,He.MetronomeChannel=He.DefaultChannelCount-1,He.MetronomeKey=33,He.AudioChannels=2,He.MinVolume=0,He.MinProgram=0,He.MaxProgram=127,He.MinPlaybackSpeed=.125,He.MaxPlaybackSpeed=8,He.PercussionChannel=9,He.PercussionBank=128,He.MaxPitchWheel=16384,He.MaxPitchWheel20=4294967296,He.DefaultPitchWheel=He.MaxPitchWheel/2,He.MicroBufferCount=32,He.MicroBufferSize=64;var Ge,ze=He,Ue=((Ge=Ue||{})[Ge.None=-1]="None",Ge[Ge.Space=32]="Space",Ge[Ge.Brace=57344]="Brace",Ge[Ge.BracketTop=57347]="BracketTop",Ge[Ge.BracketBottom=57348]="BracketBottom",Ge[Ge.SystemDivider=57351]="SystemDivider",Ge[Ge.GClef=57424]="GClef",Ge[Ge.GClef15mb=57425]="GClef15mb",Ge[Ge.GClef8vb=57426]="GClef8vb",Ge[Ge.GClef8va=57427]="GClef8va",Ge[Ge.GClef15ma=57428]="GClef15ma",Ge[Ge.CClef=57436]="CClef",Ge[Ge.CClef8vb=57437]="CClef8vb",Ge[Ge.FClef=57442]="FClef",Ge[Ge.FClef15mb=57443]="FClef15mb",Ge[Ge.FClef8vb=57444]="FClef8vb",Ge[Ge.FClef8va=57445]="FClef8va",Ge[Ge.FClef15ma=57446]="FClef15ma",Ge[Ge.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",Ge[Ge.SixStringTabClef=57453]="SixStringTabClef",Ge[Ge.FourStringTabClef=57454]="FourStringTabClef",Ge[Ge.Clef8=57469]="Clef8",Ge[Ge.Clef15=57470]="Clef15",Ge[Ge.TimeSig0=57472]="TimeSig0",Ge[Ge.TimeSig1=57473]="TimeSig1",Ge[Ge.TimeSig2=57474]="TimeSig2",Ge[Ge.TimeSig3=57475]="TimeSig3",Ge[Ge.TimeSig4=57476]="TimeSig4",Ge[Ge.TimeSig5=57477]="TimeSig5",Ge[Ge.TimeSig6=57478]="TimeSig6",Ge[Ge.TimeSig7=57479]="TimeSig7",Ge[Ge.TimeSig8=57480]="TimeSig8",Ge[Ge.TimeSig9=57481]="TimeSig9",Ge[Ge.TimeSigCommon=57482]="TimeSigCommon",Ge[Ge.TimeSigCutCommon=57483]="TimeSigCutCommon",Ge[Ge.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",Ge[Ge.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",Ge[Ge.NoteheadWhole=57506]="NoteheadWhole",Ge[Ge.NoteheadHalf=57507]="NoteheadHalf",Ge[Ge.NoteheadBlack=57508]="NoteheadBlack",Ge[Ge.NoteheadNull=57509]="NoteheadNull",Ge[Ge.NoteheadXOrnate=57514]="NoteheadXOrnate",Ge[Ge.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",Ge[Ge.NoteheadPlusWhole=57517]="NoteheadPlusWhole",Ge[Ge.NoteheadPlusHalf=57518]="NoteheadPlusHalf",Ge[Ge.NoteheadPlusBlack=57519]="NoteheadPlusBlack",Ge[Ge.NoteheadSquareWhite=57528]="NoteheadSquareWhite",Ge[Ge.NoteheadSquareBlack=57529]="NoteheadSquareBlack",Ge[Ge.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",Ge[Ge.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",Ge[Ge.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",Ge[Ge.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",Ge[Ge.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",Ge[Ge.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",Ge[Ge.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",Ge[Ge.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",Ge[Ge.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",Ge[Ge.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",Ge[Ge.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",Ge[Ge.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",Ge[Ge.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",Ge[Ge.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",Ge[Ge.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",Ge[Ge.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",Ge[Ge.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",Ge[Ge.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",Ge[Ge.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",Ge[Ge.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",Ge[Ge.NoteheadCircleX=57523]="NoteheadCircleX",Ge[Ge.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",Ge[Ge.NoteheadXWhole=57511]="NoteheadXWhole",Ge[Ge.NoteheadXHalf=57512]="NoteheadXHalf",Ge[Ge.NoteheadXBlack=57513]="NoteheadXBlack",Ge[Ge.NoteheadParenthesis=57550]="NoteheadParenthesis",Ge[Ge.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",Ge[Ge.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",Ge[Ge.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",Ge[Ge.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",Ge[Ge.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",Ge[Ge.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",Ge[Ge.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",Ge[Ge.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",Ge[Ge.NoteheadCircledBlack=57572]="NoteheadCircledBlack",Ge[Ge.NoteheadCircledHalf=57573]="NoteheadCircledHalf",Ge[Ge.NoteheadCircledWhole=57574]="NoteheadCircledWhole",Ge[Ge.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",Ge[Ge.NoteheadCircleSlash=57591]="NoteheadCircleSlash",Ge[Ge.NoteheadHeavyX=57592]="NoteheadHeavyX",Ge[Ge.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",Ge[Ge.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",Ge[Ge.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",Ge[Ge.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",Ge[Ge.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",Ge[Ge.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",Ge[Ge.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",Ge[Ge.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",Ge[Ge.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",Ge[Ge.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",Ge[Ge.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",Ge[Ge.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",Ge[Ge.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",Ge[Ge.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",Ge[Ge.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",Ge[Ge.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",Ge[Ge.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",Ge[Ge.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",Ge[Ge.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",Ge[Ge.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",Ge[Ge.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",Ge[Ge.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",Ge[Ge.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",Ge[Ge.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",Ge[Ge.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",Ge[Ge.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",Ge[Ge.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",Ge[Ge.NoteQuarterUp=57813]="NoteQuarterUp",Ge[Ge.Note8thUp=57815]="Note8thUp",Ge[Ge.MetNoteQuarterUp=60581]="MetNoteQuarterUp",Ge[Ge.MetNote8thUp=60583]="MetNote8thUp",Ge[Ge.MetAugmentationDot=60599]="MetAugmentationDot",Ge[Ge.ArrowheadBlackUp=60280]="ArrowheadBlackUp",Ge[Ge.ArrowheadBlackDown=60284]="ArrowheadBlackDown",Ge[Ge.AugmentationDot=57831]="AugmentationDot",Ge[Ge.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",Ge[Ge.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",Ge[Ge.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",Ge[Ge.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",Ge[Ge.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",Ge[Ge.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",Ge[Ge.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",Ge[Ge.TextAugmentationDot=57852]="TextAugmentationDot",Ge[Ge.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",Ge[Ge.TextTuplet3LongStem=57858]="TextTuplet3LongStem",Ge[Ge.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",Ge[Ge.Tremolo3=57890]="Tremolo3",Ge[Ge.Tremolo2=57889]="Tremolo2",Ge[Ge.Tremolo1=57888]="Tremolo1",Ge[Ge.Flag8thUp=57920]="Flag8thUp",Ge[Ge.Flag8thDown=57921]="Flag8thDown",Ge[Ge.Flag16thUp=57922]="Flag16thUp",Ge[Ge.Flag16thDown=57923]="Flag16thDown",Ge[Ge.Flag32ndUp=57924]="Flag32ndUp",Ge[Ge.Flag32ndDown=57925]="Flag32ndDown",Ge[Ge.Flag64thUp=57926]="Flag64thUp",Ge[Ge.Flag64thDown=57927]="Flag64thDown",Ge[Ge.Flag128thUp=57928]="Flag128thUp",Ge[Ge.Flag128thDown=57929]="Flag128thDown",Ge[Ge.Flag256thUp=57930]="Flag256thUp",Ge[Ge.Flag256thDown=57931]="Flag256thDown",Ge[Ge.AccidentalFlat=57952]="AccidentalFlat",Ge[Ge.AccidentalNatural=57953]="AccidentalNatural",Ge[Ge.AccidentalSharp=57954]="AccidentalSharp",Ge[Ge.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",Ge[Ge.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",Ge[Ge.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",Ge[Ge.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",Ge[Ge.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",Ge[Ge.RepeatDot=57412]="RepeatDot",Ge[Ge.Segno=57415]="Segno",Ge[Ge.Coda=57416]="Coda",Ge[Ge.ArticAccentAbove=58528]="ArticAccentAbove",Ge[Ge.ArticAccentBelow=58529]="ArticAccentBelow",Ge[Ge.ArticStaccatoAbove=58530]="ArticStaccatoAbove",Ge[Ge.ArticStaccatoBelow=58531]="ArticStaccatoBelow",Ge[Ge.ArticTenutoAbove=58532]="ArticTenutoAbove",Ge[Ge.ArticTenutoBelow=58533]="ArticTenutoBelow",Ge[Ge.ArticMarcatoAbove=58540]="ArticMarcatoAbove",Ge[Ge.ArticMarcatoBelow=58541]="ArticMarcatoBelow",Ge[Ge.FermataAbove=58560]="FermataAbove",Ge[Ge.FermataShortAbove=58564]="FermataShortAbove",Ge[Ge.FermataLongAbove=58566]="FermataLongAbove",Ge[Ge.RestLonga=58593]="RestLonga",Ge[Ge.RestDoubleWhole=58594]="RestDoubleWhole",Ge[Ge.RestWhole=58595]="RestWhole",Ge[Ge.RestHalf=58596]="RestHalf",Ge[Ge.RestQuarter=58597]="RestQuarter",Ge[Ge.Rest8th=58598]="Rest8th",Ge[Ge.Rest16th=58599]="Rest16th",Ge[Ge.Rest32nd=58600]="Rest32nd",Ge[Ge.Rest64th=58601]="Rest64th",Ge[Ge.Rest128th=58602]="Rest128th",Ge[Ge.Rest256th=58603]="Rest256th",Ge[Ge.RestHBarLeft=58607]="RestHBarLeft",Ge[Ge.RestHBarMiddle=58608]="RestHBarMiddle",Ge[Ge.RestHBarRight=58609]="RestHBarRight",Ge[Ge.Repeat1Bar=58624]="Repeat1Bar",Ge[Ge.Repeat2Bars=58625]="Repeat2Bars",Ge[Ge.Ottava=58640]="Ottava",Ge[Ge.OttavaAlta=58641]="OttavaAlta",Ge[Ge.OttavaBassaVb=58652]="OttavaBassaVb",Ge[Ge.Quindicesima=58644]="Quindicesima",Ge[Ge.QuindicesimaAlta=58645]="QuindicesimaAlta",Ge[Ge.DynamicPPPPPP=58663]="DynamicPPPPPP",Ge[Ge.DynamicPPPPP=58664]="DynamicPPPPP",Ge[Ge.DynamicPPPP=58665]="DynamicPPPP",Ge[Ge.DynamicPPP=58666]="DynamicPPP",Ge[Ge.DynamicPP=58667]="DynamicPP",Ge[Ge.DynamicPiano=58656]="DynamicPiano",Ge[Ge.DynamicMP=58668]="DynamicMP",Ge[Ge.DynamicMF=58669]="DynamicMF",Ge[Ge.DynamicPF=58670]="DynamicPF",Ge[Ge.DynamicForte=58658]="DynamicForte",Ge[Ge.DynamicFF=58671]="DynamicFF",Ge[Ge.DynamicFFF=58672]="DynamicFFF",Ge[Ge.DynamicFFFF=58673]="DynamicFFFF",Ge[Ge.DynamicFFFFF=58674]="DynamicFFFFF",Ge[Ge.DynamicFFFFFF=58675]="DynamicFFFFFF",Ge[Ge.DynamicFortePiano=58676]="DynamicFortePiano",Ge[Ge.DynamicNiente=58662]="DynamicNiente",Ge[Ge.DynamicSforzando1=58678]="DynamicSforzando1",Ge[Ge.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",Ge[Ge.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",Ge[Ge.DynamicSforzato=58681]="DynamicSforzato",Ge[Ge.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",Ge[Ge.DynamicSforzatoFF=58683]="DynamicSforzatoFF",Ge[Ge.DynamicRinforzando1=58684]="DynamicRinforzando1",Ge[Ge.DynamicRinforzando2=58685]="DynamicRinforzando2",Ge[Ge.DynamicForzando=58677]="DynamicForzando",Ge[Ge.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",Ge[Ge.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",Ge[Ge.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",Ge[Ge.OrnamentTrill=58726]="OrnamentTrill",Ge[Ge.OrnamentTurn=58727]="OrnamentTurn",Ge[Ge.OrnamentTurnInverted=58728]="OrnamentTurnInverted",Ge[Ge.OrnamentShortTrill=58732]="OrnamentShortTrill",Ge[Ge.OrnamentMordent=58733]="OrnamentMordent",Ge[Ge.StringsDownBow=58896]="StringsDownBow",Ge[Ge.StringsUpBow=58898]="StringsUpBow",Ge[Ge.KeyboardPedalPed=58960]="KeyboardPedalPed",Ge[Ge.KeyboardPedalUp=58965]="KeyboardPedalUp",Ge[Ge.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",Ge[Ge.GuitarString0=59443]="GuitarString0",Ge[Ge.GuitarString1=59444]="GuitarString1",Ge[Ge.GuitarString2=59445]="GuitarString2",Ge[Ge.GuitarString3=59446]="GuitarString3",Ge[Ge.GuitarString4=59447]="GuitarString4",Ge[Ge.GuitarString5=59448]="GuitarString5",Ge[Ge.GuitarString6=59449]="GuitarString6",Ge[Ge.GuitarString7=59450]="GuitarString7",Ge[Ge.GuitarString8=59451]="GuitarString8",Ge[Ge.GuitarString9=59452]="GuitarString9",Ge[Ge.GuitarOpenPedal=59453]="GuitarOpenPedal",Ge[Ge.GuitarClosePedal=59455]="GuitarClosePedal",Ge[Ge.GuitarGolpe=59458]="GuitarGolpe",Ge[Ge.GuitarFadeIn=59459]="GuitarFadeIn",Ge[Ge.GuitarFadeOut=59460]="GuitarFadeOut",Ge[Ge.GuitarVolumeSwell=59461]="GuitarVolumeSwell",Ge[Ge.FretboardFilledCircle=59480]="FretboardFilledCircle",Ge[Ge.FretboardX=59481]="FretboardX",Ge[Ge.FretboardO=59482]="FretboardO",Ge[Ge.Tuplet0=59520]="Tuplet0",Ge[Ge.Tuplet1=59521]="Tuplet1",Ge[Ge.Tuplet2=59522]="Tuplet2",Ge[Ge.Tuplet3=59523]="Tuplet3",Ge[Ge.Tuplet4=59524]="Tuplet4",Ge[Ge.Tuplet5=59525]="Tuplet5",Ge[Ge.Tuplet6=59526]="Tuplet6",Ge[Ge.Tuplet7=59527]="Tuplet7",Ge[Ge.Tuplet8=59528]="Tuplet8",Ge[Ge.Tuplet9=59529]="Tuplet9",Ge[Ge.TupletColon=59530]="TupletColon",Ge[Ge.WiggleTrill=60068]="WiggleTrill",Ge[Ge.GuitarVibratoStroke=60082]="GuitarVibratoStroke",Ge[Ge.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",Ge[Ge.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",Ge[Ge.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",Ge[Ge.WiggleSawtooth=60091]="WiggleSawtooth",Ge[Ge.OctaveBaselineM=60565]="OctaveBaselineM",Ge[Ge.OctaveBaselineB=60563]="OctaveBaselineB",Ge[Ge.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",Ge[Ge.Fingering0=60688]="Fingering0",Ge[Ge.Fingering1=60689]="Fingering1",Ge[Ge.Fingering2=60690]="Fingering2",Ge[Ge.Fingering3=60691]="Fingering3",Ge[Ge.Fingering4=60692]="Fingering4",Ge[Ge.Fingering5=60693]="Fingering5",Ge[Ge.FingeringPLower=60695]="FingeringPLower",Ge[Ge.FingeringTLower=60696]="FingeringTLower",Ge[Ge.FingeringILower=60697]="FingeringILower",Ge[Ge.FingeringMLower=60698]="FingeringMLower",Ge[Ge.FingeringALower=60699]="FingeringALower",Ge[Ge.FingeringCLower=60700]="FingeringCLower",Ge),Ye=(e=>(e[e.None=0]="None",e[e.Natural=1]="Natural",e[e.Sharp=2]="Sharp",e[e.Flat=3]="Flat",e[e.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",e[e.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",e[e.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",e[e.DoubleSharp=7]="DoubleSharp",e[e.DoubleFlat=8]="DoubleFlat",e))(Ye||{}),Xe=class{constructor(){this.note=null,this.tone=new $e,this.octave=0}get realValue(){return 12*this.octave+this.tone.noteValue}},$e=class{constructor(e=0,t=0){this.noteValue=e,this.accidentalMode=t}},Je=class e{static getIndex(e){return 0|Math.log2(Math.abs(e))}static keySignatureIsFlat(e){return e<0}static keySignatureIsNatural(e){return 0===e}static keySignatureIsSharp(e){return e>0}static applyPitchOffsets(e,t){for(let s=0;s<t.tracks.length;s++){if(s<e.notation.displayTranspositionPitches.length)for(let i of t.tracks[s].staves)i.displayTranspositionPitch=-e.notation.displayTranspositionPitches[s];if(s<e.notation.transpositionPitches.length)for(let i of t.tracks[s].staves)i.transpositionPitch=-e.notation.transpositionPitches[s]}}static isTuning(t){return!!e.parseTuning(t)}static parseTuning(t){let s="",i="";for(let a=0;a<t.length;a++){let r=t.charCodeAt(a);if(r>=48&&r<=57){if(!s)return null;i+=String.fromCharCode(r)}else if(0===s.length){if(!e.tuningLetters.has(r))return null;s+=String.fromCharCode(r)}else s+=String.fromCharCode(r)}if(!i||!s)return null;let a=new Xe;a.octave=Number.parseInt(i,10)+1,a.note=s.toLowerCase();let r=e.getToneForText(a.note);return null===r?null:(a.tone=r,a.tone.noteValue<0&&(a.octave--,a.tone.noteValue+=12),a)}static getTuningForText(t){let s=e.parseTuning(t);return s?s.realValue:-1}static getToneForText(t){let s,i,a=t.substring(0,1),r=t.substring(1);switch(a.toLowerCase()){case"c":s=0;break;case"d":s=2;break;case"e":s=4;break;case"f":s=5;break;case"g":s=7;break;case"a":s=9;break;case"b":s=11;break;default:return null}if(!e.accidentalModeMapping.has(r))return null;switch(i=e.parseAccidentalMode(r),i){case 0:case 1:case 2:break;case 3:s++;break;case 4:s+=2;break;case 5:s--;break;case 6:s-=2}return new $e(s,i)}static parseAccidentalMode(t){let s=t.toLowerCase();return e.accidentalModeMapping.has(s)?e.accidentalModeMapping.get(s):0}static newGuid(){return`${Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}`}static isAlmostEqualTo(e,t){return Math.abs(e-t)<1e-5}static toHexString(e,t=0){let s="";do{s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&e))+s,e>>=4}while(e>0);for(;s.length<t;)s=`0${s}`;return s}static getAlternateEndingsList(e){let t=[];for(let s=0;s<We.MaxAlternateEndings;s++)e&1<<s&&t.push(s);return t}static deltaFretToHarmonicValue(e){switch(e){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return e;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(e,t,s){return e<=t?t:e>=s?s:e}static buildMultiBarRestInfo(e,t,s){if(!e)return null;let i=e[0].score.stylesheet;if(!(e.length>1?i.multiTrackMultiBarRest:!0===i.perTrackMultiBarRest?.has(e[0].index)))return null;let a=new Map,r=e[0].score,n=t,o=r.tempo;for(;n<=s;){let i=n,l=null;for(;n<=s;){let s=r.masterBars[n],a=!1;for(let e of s.tempoAutomations)e.value!==o&&(a=!0),o=e.value;if(s.alternateEndings||s.isRepeatStart&&s.index!==i||s.isFreeTime||s.isAnacrusis||null!==s.section||s.index!==i&&a||null!==s.fermata&&s.fermata.size>0||null!==s.directions&&s.directions.size>0||i>t&&s.previousMasterBar&&(s.timeSignatureCommon!==s.previousMasterBar.timeSignatureCommon||s.timeSignatureNumerator!==s.previousMasterBar.timeSignatureNumerator||s.timeSignatureDenominator!==s.previousMasterBar.timeSignatureDenominator||s.tripletFeel!==s.previousMasterBar.tripletFeel))break;let h=!0;for(let t of e){for(let e of t.staves){let t=e.bars[s.index];if(!t.isRestOnly){h=!1;break}if(t.index>0&&(t.keySignature!==t.previousBar.keySignature||t.keySignatureType!==t.previousBar.keySignatureType)){h=!1;break}}if(!h)break}if(!h||(n++,s.index>i&&(null===l?l=[s.index]:l.push(s.index)),s.isRepeatEnd))break}l?a.set(i,l):n++}return a}static computeFirstDisplayedBarIndex(e,t){let s=t.display.startBar;return s--,s=Math.min(e.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(e,t,s){let i=t.display.barCount;return i<0&&(i=e.masterBars.length),i=s+i-1,i=Math.min(e.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(e,t){let s,i=e.style;if(e.style||(i=new Re,e.style=i),i.headerAndFooter.has(t))s=i.headerAndFooter.get(t);else{if(s=new Ae,Re.defaultHeaderAndFooter.has(t)){let e=Re.defaultHeaderAndFooter.get(t);s.template=e.template,s.textAlign=e.textAlign}i.headerAndFooter.set(t,s)}return s}static consolidate(e){if(0===e.masterBars.length){let t=new We;e.addMasterBar(t);let s=new w;s.isLinear=!1,s.type=0,s.value=e.tempo,t.tempoAutomations.push(s);let i=new Be;e.tracks[0].staves[0].addBar(i);let a=new Me;i.addVoice(a);let r=new wt;return r.isEmpty=!0,void a.addBeat(r)}let t=new Set([ze.PercussionChannel]);for(let s of e.tracks){if(1===s.staves.length&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=ze.PercussionChannel,s.playbackInfo.secondaryChannel=ze.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==ze.PercussionChannel)for(;t.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(t.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==ze.PercussionChannel)for(;t.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;t.add(s.playbackInfo.secondaryChannel)}for(let t of s.staves){for(let e of t.bars)for(let t of e.voices)if(t.isEmpty&&0===t.beats.length){let e=new wt;e.isEmpty=!0,t.addBeat(e)}let s=0===t.bars.length?1:t.bars[0].voices.length;for(;t.bars.length<e.masterBars.length;){let e=new Be;t.addBar(e);let i=e.previousBar;i&&(e.clef=i.clef,e.clefOttava=i.clefOttava,e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType);for(let t=0;t<s;t++){let t=new Me;e.addVoice(t);let s=new wt;s.isEmpty=!0,t.addBeat(s)}}}}if(e.masterBars.length>0&&!e.masterBars[0].tempoAutomations.find(e=>0===e.type&&0===e.ratioPosition)){let t=new w;t.isLinear=!1,t.type=0,t.value=e.tempo,t.text=e.tempoLabel,t.isVisible=!1,e.masterBars[0].tempoAutomations.push(t)}}static trimEmptyBarsAtEnd(e){for(;e.masterBars.length>1;){let t=e.masterBars.length-1,s=e.masterBars[t];if(s.hasChanges)return;for(let s of e.tracks)for(let e of s.staves)if(t<e.bars.length){let s=e.bars[t];if(!s.isEmpty||s.hasChanges)return}for(let s of e.tracks)for(let e of s.staves)if(t<e.bars.length){let s=e.bars[t];e.bars.pop(),s.previousBar.nextBar=null}e.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}static getAllMusicFontSymbols(){return 0===e._allMusicFontSymbols.length&&(e._allMusicFontSymbols=Object.values(Ue).filter(e=>"number"==typeof e).map(e=>e)),e._allMusicFontSymbols}static flooredDivision(e,t){return e-t*Math.floor(e/t)}static _translateKeyTransposeTable(e){let t=[];for(let s of e){let e=[];t.push(e);for(let t of s){let s=Number.parseInt(t.charAt(0),10)*("b"===t.charAt(1)?-1:1);e.push(s)}}return t}static transposeKey(t,s){if(0===s)return t;if(s<0){let i=e._keyTransposeTable[-s].indexOf(t);return-1===i?t:i-7}return e._keyTransposeTable[s][t+7]}static computeAccidental(t,s,i,a,r=null){let n=t+7,o=i%12,l=n<7?3:2,h=e._keySignatureLookup[n][o],d=e.accidentalNotes[o],c=0;if(a)switch(c=d?l:1,c){case 1:c=4;break;case 2:c=5;break;case 3:c=6}else{switch(s){case 3:c=2;break;case 4:c=7;break;case 5:c=3;break;case 6:c=8;break;default:d?c=l:h&&(c=1)}0!==c?null!=r?r===c&&(c=0):h&&c===l&&(c=0):null!==r&&(c=1===r?0:1)}return c}static toArticulationId(e){return e.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}};Je.tuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]),Je.reverseAccidentalModeMapping=new Map([[0,"d"],[1,"forcenone"],[2,"forcenatural"],[3,"#"],[4,"x"],[5,"b"],[6,"bb"]]),Je.accidentalModeMapping=new Map([["default",0],["d",0],["",0],["forcenone",1],["-",1],["forcenatural",2],["n",2],["forcesharp",3],["#",3],["forcedoublesharp",4],["##",4],["x",4],["forceflat",5],["b",5],["forcedoubleflat",6],["bb",6]]),Je._allMusicFontSymbols=[],Je.displayTranspositionPitches=new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]]),Je._keyTransposeTable=Je._translateKeyTransposeTable([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]]),Je._keySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],Je.accidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1];var qe=Je,je=(e=>(e[e.None=0]="None",e[e.Up=1]="Up",e[e.Down=2]="Down",e))(je||{}),Ke=(e=>(e[e.Above=0]="Above",e[e.Inside=1]="Inside",e[e.Below=2]="Below",e[e.Outside=3]="Outside",e))(Ke||{}),Qe=class{constructor(e="",t=0,s=0,i=-1,a=-1,r=-1,n=-1,o=1){this.elementType=e,this.outputMidiNumber=s,this.staffLine=t,this.noteHeadDefault=i,this.noteHeadHalf=-1!==a?a:i,this.noteHeadWhole=-1!==r?r:i,this.techniqueSymbol=n,this.techniqueSymbolPlacement=o}getSymbol(e){switch(e){case 1:return this.noteHeadWhole;case 2:return this.noteHeadHalf;default:return this.noteHeadDefault}}},Ze=class e{static articulationFromElementVariation(t,s){return t<e._gp6ElementAndVariationToArticulation.length?(s>=e._gp6ElementAndVariationToArticulation.length&&(s=0),e._gp6ElementAndVariationToArticulation[t][s]):38}static getArticulationName(t){let s=e.getArticulation(t),i=t.percussionArticulation;s&&(i=s.outputMidiNumber);for(let[t,s]of e.instrumentArticulationNames)if(s===i)return t;return"unknown"}static getArticulation(t){let s=t.percussionArticulation;if(s<0)return null;let i=t.beat.voice.bar.staff.track.percussionArticulations;return s<i.length?i[s]:e.getArticulationByInputMidiNumber(s)}static getElementAndVariation(t){let s=e.getArticulation(t);if(!s)return[-1,-1];for(let t=0;t<e._gp6ElementAndVariationToArticulation.length;t++){let i=e._gp6ElementAndVariationToArticulation[t];for(let a=0;a<i.length;a++)if(e.getArticulationByInputMidiNumber(i[a])?.outputMidiNumber===s.outputMidiNumber)return[t,a]}return[-1,-1]}static getArticulationByInputMidiNumber(t){return e.instrumentArticulations.has(t)?e.instrumentArticulations.get(t):null}};Ze._gp6ElementAndVariationToArticulation=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]],Ze.instrumentArticulations=new Map([[38,new Qe("snare",3,38,57508,57507,57506)],[37,new Qe("snare",3,37,57513,57513,57513)],[91,new Qe("snare",3,38,57565,57565,57565)],[42,new Qe("hiHat",-1,42,57513,57513,57513)],[92,new Qe("hiHat",-1,46,57591,57591,57591)],[46,new Qe("hiHat",-1,46,57523,57523,57523)],[44,new Qe("hiHat",9,44,57513,57513,57513)],[35,new Qe("kickDrum",8,35,57508,57507,57506)],[36,new Qe("kickDrum",7,36,57508,57507,57506)],[50,new Qe("tom",1,50,57508,57507,57506)],[48,new Qe("tom",2,48,57508,57507,57506)],[47,new Qe("tom",4,47,57508,57507,57506)],[45,new Qe("tom",5,45,57508,57507,57506)],[43,new Qe("tom",6,43,57508,57507,57506)],[93,new Qe("ride",0,51,57513,57513,57513,59177,2)],[51,new Qe("ride",0,51,57513,57513,57513)],[53,new Qe("ride",0,53,57565,57565,57565)],[94,new Qe("ride",0,51,57513,57513,57513,58530,0)],[55,new Qe("splash",-2,55,57513,57513,57513)],[95,new Qe("splash",-2,55,57513,57513,57513,58530,2)],[52,new Qe("china",-3,52,57593,57593,57593)],[96,new Qe("china",-3,52,57593,57593,57593)],[49,new Qe("crash",-2,49,57592,57592,57592)],[97,new Qe("crash",-2,49,57592,57592,57592,58530,2)],[57,new Qe("crash",-1,57,57592,57592,57592)],[98,new Qe("crash",-1,57,57592,57592,57592,58530,2)],[99,new Qe("cowbell",1,56,57534,57532,57531)],[100,new Qe("cowbell",1,56,57513,57512,57511)],[56,new Qe("cowbell",0,56,57534,57532,57531)],[101,new Qe("cowbell",0,56,57513,57512,57511)],[102,new Qe("cowbell",-1,56,57534,57532,57531)],[103,new Qe("cowbell",-1,56,57513,57512,57511)],[77,new Qe("woodblock",-9,77,57534,57534,57534)],[76,new Qe("woodblock",-10,76,57534,57534,57534)],[60,new Qe("bongo",-4,60,57508,57507,57506)],[104,new Qe("bongo",-5,60,57508,57507,57506,57550,1)],[105,new Qe("bongo",-6,60,57513,57513,57513)],[61,new Qe("bongo",-7,61,57508,57507,57506)],[106,new Qe("bongo",-8,61,57508,57507,57506,57550,1)],[107,new Qe("bongo",-16,61,57513,57513,57513)],[66,new Qe("timbale",10,66,57508,57507,57506)],[65,new Qe("timbale",9,65,57508,57507,57506)],[68,new Qe("agogo",12,68,57508,57507,57506)],[67,new Qe("agogo",11,67,57508,57507,57506)],[64,new Qe("conga",17,64,57508,57507,57506)],[108,new Qe("conga",16,64,57513,57513,57513)],[109,new Qe("conga",15,64,57508,57507,57506,57550,1)],[63,new Qe("conga",14,63,57508,57507,57506)],[110,new Qe("conga",13,63,57513,57513,57513)],[62,new Qe("conga",19,62,57508,57507,57506,57550,1)],[72,new Qe("whistle",-11,72,57508,57507,57506)],[71,new Qe("whistle",-17,71,57508,57507,57506)],[73,new Qe("guiro",38,73,57508,57507,57506)],[74,new Qe("guiro",37,74,57508,57507,57506)],[86,new Qe("surdo",36,86,57508,57507,57506)],[87,new Qe("surdo",35,87,57513,57513,57513,57550,1)],[54,new Qe("tambourine",3,54,57534,57534,57534)],[111,new Qe("tambourine",2,54,57534,57534,57534,58898,2)],[112,new Qe("tambourine",1,54,57534,57534,57534,58896,2)],[113,new Qe("tambourine",-7,54,57513,57513,57513)],[79,new Qe("cuica",30,79,57508,57507,57506)],[78,new Qe("cuica",29,78,57513,57513,57513)],[58,new Qe("vibraslap",28,58,57508,57507,57506)],[81,new Qe("triangle",27,81,57508,57507,57506)],[80,new Qe("triangle",26,80,57513,57513,57513,57550,1)],[114,new Qe("grancassa",25,43,57508,57507,57506)],[115,new Qe("piatti",18,49,57508,57507,57506)],[116,new Qe("piatti",24,49,57513,57513,57513)],[69,new Qe("cabasa",23,69,57508,57507,57506)],[117,new Qe("cabasa",22,69,57508,57507,57506,58898,2)],[85,new Qe("castanets",21,85,57508,57507,57506)],[75,new Qe("claves",20,75,57508,57507,57506)],[70,new Qe("maraca",-12,70,57508,57507,57506)],[118,new Qe("maraca",-13,70,57508,57507,57506,58898,2)],[119,new Qe("maraca",-14,70,57508,57507,57506)],[120,new Qe("maraca",-15,70,57508,57507,57506,58898,2)],[82,new Qe("shaker",-23,54,57508,57507,57506)],[122,new Qe("shaker",-24,54,57508,57507,57506,58898,2)],[84,new Qe("bellTree",-18,53,57508,57507,57506)],[123,new Qe("bellTree",-19,53,57508,57507,57506,58898,2)],[83,new Qe("jingleBell",-20,53,57508,57507,57506)],[124,new Qe("unpitched",-21,62,57509,57509,57509,59458,0)],[125,new Qe("unpitched",-22,62,57509,57509,57509,59458,2)],[39,new Qe("handClap",3,39,57508,57507,57506)],[40,new Qe("snare",3,40,57508,57507,57506)],[31,new Qe("snare",3,40,57552,57552,57552)],[41,new Qe("tom",5,41,57508,57507,57506)],[59,new Qe("ride",2,59,57513,57513,57513,59177,2)],[126,new Qe("ride",2,59,57513,57513,57513)],[127,new Qe("ride",2,59,57565,57565,57565)],[29,new Qe("ride",2,59,57513,57513,57513,58530,0)],[30,new Qe("crash",-3,49,57513,57513,57513)],[33,new Qe("snare",3,37,57513,57513,57513)],[34,new Qe("snare",3,38,57508,57508,57508)]]),Ze.instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Bongo high (hit)",60],["Bongo low (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]);var et=Ze,tt=(e=>(e[e.None=0]="None",e[e.InvertedTurn=1]="InvertedTurn",e[e.Turn=2]="Turn",e[e.UpperMordent=3]="UpperMordent",e[e.LowerMordent=4]="LowerMordent",e))(tt||{}),st=class{constructor(){this.tieDestinationNoteId=-1,this.tieOriginNoteId=-1,this.slurDestinationNoteId=-1,this.slurOriginNoteId=-1,this.hammerPullDestinationNoteId=-1,this.hammerPullOriginNoteId=-1,this.slideTargetNoteId=-1,this.slideOriginNoteId=-1}},it=(e=>(e[e.Effects=0]="Effects",e[e.StandardNotationNoteHead=1]="StandardNotationNoteHead",e[e.StandardNotationAccidentals=2]="StandardNotationAccidentals",e[e.StandardNotationEffects=3]="StandardNotationEffects",e[e.GuitarTabFretNumber=4]="GuitarTabFretNumber",e[e.GuitarTabEffects=5]="GuitarTabEffects",e[e.SlashNoteHead=6]="SlashNoteHead",e[e.SlashEffects=7]="SlashEffects",e[e.NumberedNumber=8]="NumberedNumber",e[e.NumberedAccidentals=9]="NumberedAccidentals",e[e.NumberedEffects=10]="NumberedEffects",e))(it||{}),at=class extends ue{},rt=class e{constructor(){this.id=e.globalNoteId++,this.index=0,this.accentuated=0,this.bendType=0,this.bendStyle=0,this.bendOrigin=null,this.isContinuedBend=!1,this.bendPoints=null,this.maxBendPoint=null,this.fret=-1,this.string=-1,this.showStringNumber=!1,this.octave=-1,this.tone=-1,this.percussionArticulation=-1,this.isVisible=!0,this.isLeftHandTapped=!1,this.isHammerPullOrigin=!1,this.hammerPullOrigin=null,this.hammerPullDestination=null,this.isSlurDestination=!1,this.slurOrigin=null,this.slurDestination=null,this.harmonicType=0,this.harmonicValue=0,this.isGhost=!1,this.isLetRing=!1,this.letRingDestination=null,this.isPalmMute=!1,this.palmMuteDestination=null,this.isDead=!1,this.isDeadVisual=!1,this.isStaccato=!1,this.slideInType=0,this.slideOutType=0,this.slideTarget=null,this.slideOrigin=null,this.vibrato=0,this.tieOrigin=null,this.tieDestination=null,this.isTieDestination=!1,this.leftHandFinger=-2,this.rightHandFinger=-2,this.trillValue=-1,this.trillSpeed=32,this.durationPercent=1,this.accidentalMode=0,this.dynamics=5,this.isEffectSlurOrigin=!1,this.hasEffectSlur=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.ornament=0,this._noteIdBag=null}static resetIds(){e.globalNoteId=0}get hasBend(){return null!==this.bendPoints&&0!==this.bendType}get isStringed(){return this.string>=0}get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?et.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?et.getElementAndVariation(this)[1]:-1}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return 0!==this.harmonicType}get isTieOrigin(){return null!==this.tieDestination}get isFingering(){return-2!==this.leftHandFinger||-2!==this.rightHandFinger}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+e.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,t){return e.tuning.length>0?e.tuning[e.tuning.length-(t-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(e,t){let s=e?this.beat.voice.bar.staff.transpositionPitch:0;if(t){let t=this.calculateRealValue(e,!1);return this.isStringed&&(1===this.harmonicType?t=this.harmonicPitch+this.stringTuning-s:t+=this.harmonicPitch),t}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?12*this.octave+this.tone-s:0}get harmonicPitch(){if(0===this.harmonicType||!this.isStringed)return 0;let e=this.harmonicValue;return qe.isAlmostEqualTo(e,2.4)?36:qe.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:e<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let e=this.realValue;switch(1!==this.harmonicType&&0!==this.harmonicType&&(e-=this.harmonicPitch),this.beat.ottava){case 0:e-=24;break;case 1:e-=12;break;case 2:break;case 3:e+=12;break;case 4:e+=24}switch(this.beat.voice.bar.clefOttava){case 0:e-=24;break;case 1:e-=12;break;case 2:break;case 3:e+=12;break;case 4:e+=24}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(e){let t=this.bendPoints;null===t&&(t=[],this.bendPoints=t),t.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),0===this.bendType&&(this.bendType=1)}finish(t,s=null){let i=new K(()=>e.nextNoteOnSameLine(this)),a=t&&1===t.notation.notationMode;if(this.isTieDestination&&(this.chain(s),a&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(i.value&&i.value.isLetRing?this.letRingDestination=i.value:this.letRingDestination=this,a&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(i.value&&i.value.isPalmMute?this.palmMuteDestination=i.value:this.palmMuteDestination=this),this.isHammerPullOrigin){let t=e.findHammerPullDestination(this);t?(this.hammerPullDestination=t,t.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case 1:case 2:this.slideTarget||(this.slideTarget=i.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=0}let r=null;this.isHammerPullOrigin&&this.hammerPullDestination?r=this.hammerPullDestination:2===this.slideOutType&&this.slideTarget&&(r=this.slideTarget),r&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&0===this.beat.pickStroke?(this.effectSlurOrigin.effectSlurDestination=r,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=r,this.effectSlurDestination.effectSlurOrigin=this));let n=this.bendPoints,o=null!=n&&n.length>0;if(o){let e=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=e}else this.bendType=0;if(o&&1===this.bendType)if(4===n.length){let e=n[0],t=n[1],s=n[2],i=n[3];t.value===s.value?i.value>e.value?t.value>i.value?this.bendType=4:!this.isContinuedBend&&e.value>0?(this.bendType=7,n.splice(2,1),n.splice(1,1)):(this.bendType=2,n.splice(2,1),n.splice(1,1)):i.value<e.value?this.isContinuedBend?(this.bendType=3,n.splice(2,1),n.splice(1,1)):(this.bendType=8,n.splice(2,1),n.splice(1,1)):t.value>e.value?this.bendType=4:e.value>0&&!this.isContinuedBend?(this.bendType=6,n.splice(2,1),n.splice(1,1)):(this.bendType=5,n.splice(2,1),n.splice(1,1)):re.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(2===n.length){let e=n[0],t=n[1];t.value>e.value?!this.isContinuedBend&&e.value>0?this.bendType=7:this.bendType=2:t.value<e.value?this.isContinuedBend?this.bendType=3:this.bendType=8:e.value>0&&!this.isContinuedBend?this.bendType=6:this.bendType=5}this.initialBendValue>0&&(this.accidentalMode=0)}static nextNoteOnSameLine(t){let s=t.beat.nextBeat;for(;s&&s.voice.bar.index<=t.beat.voice.bar.index+e._maxOffsetForSameLineSearch;){if(t.isStringed){let e=s.getNoteOnString(t.string);if(e)return e}else if(t.index<s.notes.length)return s.notes[t.index];s=s.nextBeat}return null}static findHammerPullDestination(t){let s=t.beat.nextBeat;for(;s&&s.voice.bar.index<=t.beat.voice.bar.index+e._maxOffsetForSameLineSearch;){if(!t.isStringed){if(t.index<s.notes.length)return s.notes[t.index];s=s.nextBeat;continue}let e=s.getNoteOnString(t.string);if(e)return e;for(let i=t.string;i>0;i--)if(e=s.getNoteOnString(i),e){if(e.isLeftHandTapped)return e;break}for(let i=t.string;i<=t.beat.voice.bar.staff.tuning.length;i++)if(e=s.getNoteOnString(i),e){if(e.isLeftHandTapped)return e;break}s=s.nextBeat}return null}static findTieOrigin(t){let s=t.beat.previousBeat;for(;s&&s.voice.bar.index>=t.beat.voice.bar.index-e._maxOffsetForSameLineSearch;){if(t.isStringed){let e=s.getNoteOnString(t.string);if(e)return e}else if(-1===t.octave&&-1===t.tone){if(t.index<s.notes.length)return s.notes[t.index]}else{let e=s.getNoteWithRealValue(t.realValue);if(e)return e}s=s.previousBeat}return null}chain(t=null){if(null!==t)if(null!==this._noteIdBag){let s;t.has(e._noteIdLookupKey)?s=t.get(e._noteIdLookupKey):(s=new Map,t.set(e._noteIdLookupKey,s)),(-1!==this._noteIdBag.hammerPullDestinationNoteId||-1!==this._noteIdBag.tieDestinationNoteId||-1!==this._noteIdBag.slurDestinationNoteId||-1!==this._noteIdBag.slideTargetNoteId)&&s.set(this.id,this),-1!==this._noteIdBag.hammerPullOriginNoteId&&(this.hammerPullOrigin=s.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this._noteIdBag.tieOriginNoteId&&(this.tieOrigin=s.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this._noteIdBag.slurOriginNoteId&&(this.slurOrigin=s.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this._noteIdBag.slideOriginNoteId&&(this.slideOrigin=s.get(this._noteIdBag.slideOriginNoteId),this.slideOrigin.slideTarget=this),this._noteIdBag=null}else{if(!this.isTieDestination&&null===this.tieOrigin)return;let t=this.tieOrigin??e.findTieOrigin(this);t?(t.tieDestination=this,this.tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(e){null!==this.tieDestination&&e.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&e.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&e.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&e.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&e.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&e.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&e.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&e.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(e,t){switch(e){case"tiedestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new st),this._noteIdBag.tieDestinationNoteId=t,!0;case"tieoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new st),this._noteIdBag.tieOriginNoteId=t,!0;case"slurdestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new st),this._noteIdBag.slurDestinationNoteId=t,!0;case"sluroriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new st),this._noteIdBag.slurOriginNoteId=t,!0;case"hammerpulloriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new st),this._noteIdBag.hammerPullOriginNoteId=t,!0;case"hammerpulldestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new st),this._noteIdBag.hammerPullDestinationNoteId=t,!0;case"slidetargetnoteid":return null==this._noteIdBag&&(this._noteIdBag=new st),this._noteIdBag.slideTargetNoteId=t,!0;case"slideoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new st),this._noteIdBag.slideOriginNoteId=t,!0}return!1}};rt.globalNoteId=0,rt._maxOffsetForSameLineSearch=3,rt._noteIdLookupKey="NoteIdLookup";var nt=rt,ot=class e{constructor(e){this._isEqualLengthTuplet=!0,this.totalDuration=0,this.beats=[],this.isFull=!1,this.voice=e}check(t){if(0===this.beats.length)return this.beats.push(t),this.totalDuration+=t.playbackDuration,!0;if(0!==t.graceType)return!0;if(t.voice!==this.voice||this.isFull||t.tupletNumerator!==this.beats[0].tupletNumerator||t.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(t.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(t),this.totalDuration+=t.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{let t=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(let s of e._allTicks)if(this.totalDuration===s*t){this.isFull=!0;break}}return!0}};ot._halfTicks=1920,ot._quarterTicks=960,ot._eighthTicks=480,ot._sixteenthTicks=240,ot._thirtySecondTicks=120,ot._sixtyFourthTicks=60,ot._oneHundredTwentyEighthTicks=30,ot._twoHundredFiftySixthTicks=15,ot._allTicks=[ot._halfTicks,ot._quarterTicks,ot._eighthTicks,ot._sixteenthTicks,ot._thirtySecondTicks,ot._sixtyFourthTicks,ot._oneHundredTwentyEighthTicks,ot._twoHundredFiftySixthTicks];var lt,ht,dt=ot,ct=(e=>(e[e.None=0]="None",e[e.Custom=1]="Custom",e[e.Dive=2]="Dive",e[e.Dip=3]="Dip",e[e.Hold=4]="Hold",e[e.Predive=5]="Predive",e[e.PrediveDive=6]="PrediveDive",e))(ct||{}),ut=(e=>(e[e.None=0]="None",e[e.Thumb=1]="Thumb",e[e.Finger=2]="Finger",e))(ut||{}),pt=(e=>(e[e.None=0]="None",e[e.FadeIn=1]="FadeIn",e[e.FadeOut=2]="FadeOut",e[e.VolumeSwell=3]="VolumeSwell",e))(pt||{}),mt=(e=>(e[e.None=0]="None",e[e.Open=1]="Open",e[e.Closed=2]="Closed",e))(mt||{}),gt=(e=>(e[e.None=0]="None",e[e.Full=1]="Full",e[e.Half=2]="Half",e))(gt||{}),ft=((lt=ft||{})[lt.None=0]="None",lt[lt.Ii=1]="Ii",lt[lt.Mi=2]="Mi",lt[lt.MiiTriplet=3]="MiiTriplet",lt[lt.MiiAnapaest=4]="MiiAnapaest",lt[lt.PmpTriplet=5]="PmpTriplet",lt[lt.PmpAnapaest=6]="PmpAnapaest",lt[lt.PeiTriplet=7]="PeiTriplet",lt[lt.PeiAnapaest=8]="PeiAnapaest",lt[lt.PaiTriplet=9]="PaiTriplet",lt[lt.PaiAnapaest=10]="PaiAnapaest",lt[lt.AmiTriplet=11]="AmiTriplet",lt[lt.AmiAnapaest=12]="AmiAnapaest",lt[lt.Ppp=13]="Ppp",lt[lt.Amii=14]="Amii",lt[lt.Amip=15]="Amip",lt[lt.Eami=16]="Eami",lt[lt.Eamii=17]="Eamii",lt[lt.Peami=18]="Peami",lt),bt=(e=>(e[e.Auto=0]="Auto",e[e.ForceSplitToNext=1]="ForceSplitToNext",e[e.ForceMergeWithNext=2]="ForceMergeWithNext",e[e.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext",e))(bt||{}),yt=((ht=yt||{})[ht.Effects=0]="Effects",ht[ht.StandardNotationStem=1]="StandardNotationStem",ht[ht.StandardNotationFlags=2]="StandardNotationFlags",ht[ht.StandardNotationBeams=3]="StandardNotationBeams",ht[ht.StandardNotationTuplet=4]="StandardNotationTuplet",ht[ht.StandardNotationEffects=5]="StandardNotationEffects",ht[ht.StandardNotationRests=6]="StandardNotationRests",ht[ht.GuitarTabStem=7]="GuitarTabStem",ht[ht.GuitarTabFlags=8]="GuitarTabFlags",ht[ht.GuitarTabBeams=9]="GuitarTabBeams",ht[ht.GuitarTabTuplet=10]="GuitarTabTuplet",ht[ht.GuitarTabEffects=11]="GuitarTabEffects",ht[ht.GuitarTabRests=12]="GuitarTabRests",ht[ht.SlashStem=13]="SlashStem",ht[ht.SlashFlags=14]="SlashFlags",ht[ht.SlashBeams=15]="SlashBeams",ht[ht.SlashTuplet=16]="SlashTuplet",ht[ht.SlashRests=17]="SlashRests",ht[ht.SlashEffects=18]="SlashEffects",ht[ht.NumberedDuration=19]="NumberedDuration",ht[ht.NumberedEffects=20]="NumberedEffects",ht[ht.NumberedRests=21]="NumberedRests",ht[ht.NumberedTuplet=22]="NumberedTuplet",ht),_t=class extends ue{},St=class e{constructor(){this.id=e._globalBeatId++,this.index=0,this.previousBeat=null,this.nextBeat=null,this.notes=[],this.noteStringLookup=new Map,this.noteValueLookup=new Map,this.isEmpty=!1,this.whammyStyle=0,this.ottava=2,this.fermata=null,this.isLegatoOrigin=!1,this.minNote=null,this.maxNote=null,this.maxStringNote=null,this.minStringNote=null,this.duration=4,this.isLetRing=!1,this.isPalmMute=!1,this.automations=[],this.dots=0,this.fade=0,this.lyrics=null,this.pop=!1,this.slap=!1,this.tap=!1,this.text=null,this.slashed=!1,this.deadSlapped=!1,this.brushType=0,this.brushDuration=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.tupletGroup=null,this.isContinuedWhammy=!1,this.whammyBarType=0,this.whammyBarPoints=null,this.maxWhammyPoint=null,this.minWhammyPoint=null,this.vibrato=0,this.chordId=null,this.graceType=0,this.graceGroup=null,this.graceIndex=-1,this.pickStroke=0,this.tremoloSpeed=null,this.crescendo=0,this.displayStart=0,this.playbackStart=0,this.displayDuration=0,this.playbackDuration=0,this.golpe=0,this.dynamics=5,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isEffectSlurOrigin=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.beamingMode=0,this.wahPedal=0,this.barreFret=-1,this.barreShape=0,this.rasgueado=0,this.showTimer=!1,this.timer=null}static resetIds(){e._globalBeatId=0}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&1===this.duration}get fadeIn(){return 1===this.fade}set fadeIn(e){this.fade=e?1:0}get hasRasgueado(){return 0!==this.rasgueado}get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}get hasWhammyBar(){return null!==this.whammyBarPoints&&0!==this.whammyBarType}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}get isTremolo(){return!!this.tremoloSpeed}get displayEnd(){return this.displayStart+this.displayDuration}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get isBarre(){return 0!==this.barreShape&&this.barreFret>=0}addWhammyBarPoint(e){let t=this.whammyBarPoints;null===t&&(t=[],this.whammyBarPoints=t),t.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),0===this.whammyBarType&&(this.whammyBarType=1)}removeWhammyBarPoint(e){let t=this.whammyBarPoints;if(null===t||e<0||e>=t.length)return;t.splice(e,1);let s=t[e];if(s===this.maxWhammyPoint){this.maxWhammyPoint=null;for(let e of t)(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e)}if(s===this.minWhammyPoint){this.minWhammyPoint=null;for(let e of t)(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e)}}addNote(e){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e)}removeNote(e){let t=this.notes.indexOf(e);t>=0&&(this.notes.splice(t,1),e.isStringed&&this.noteStringLookup.delete(e.string))}getAutomation(e){for(let t=0,s=this.automations.length;t<s;t++){let s=this.automations[t];if(s.type===e)return s}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}_calculateDuration(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let e=_.toTicks(this.duration);return 2===this.dots?e=_.applyDot(e,!0):1===this.dots&&(e=_.applyDot(e,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(e=_.applyTuplet(e,this.tupletNumerator,this.tupletDenominator)),e}updateDurations(){let e=this._calculateDuration();switch(this.playbackDuration=e,this.graceType){case 2:case 1:switch(this.duration){case 16:this.playbackDuration=_.toTicks(64);break;case 32:this.playbackDuration=_.toTicks(128);break;default:this.playbackDuration=_.toTicks(32)}this.displayDuration=0;break;case 3:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=e;let t=this.previousBeat;t&&3===t.graceType&&(this.playbackDuration=t.playbackDuration)}}finishTuplet(){let e=this.previousBeat,t=e?e.tupletGroup:null;(this.hasTuplet||0!==this.graceType&&t)&&((!e||!t||!t.check(this))&&(t=new dt(this.voice),t.check(this)),this.tupletGroup=t);let s=this.voice.bar.masterBar.calculateDuration(!1),i=[];for(let e of this.automations)0===e.ratioPosition&&(e.ratioPosition=this.playbackStart/s),0!==e.type&&i.push(e);this.automations=i}finish(t,s=null){switch(null===this.getAutomation(2)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push(w.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case 1:case 2:let e=this.graceGroup.beats.length;this.duration=1===e?8:2===e?16:32}0===this.brushType&&(this.brushDuration=0);let i=t?t.notation.notationMode:0,a="grad"===this.text||"grad."===this.text;a&&1===i&&(this.text="");let r=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let n=0,o=!1;for(let e=0,l=this.notes.length;e<l;e++){let l=this.notes[e];if(l.dynamics=this.dynamics,l.finish(t,s),l.isLetRing&&(this.isLetRing=!0),l.isPalmMute&&(this.isPalmMute=!0),1===i&&l.hasBend&&3!==this.graceType){if(!l.isTieOrigin)switch(l.bendType){case 2:case 8:case 7:r=!0}a||1===l.bendStyle?(a=!0,l.bendStyle=1,r=!1):l.bendStyle=2}l.isVisible&&(n++,(!this.minNote||l.realValue<this.minNote.realValue)&&(this.minNote=l),(!this.maxNote||l.realValue>this.maxNote.realValue)&&(this.maxNote=l),(!this.minStringNote||l.string<this.minStringNote.string)&&(this.minStringNote=l),(!this.maxStringNote||l.string>this.maxStringNote.string)&&(this.maxStringNote=l),l.hasEffectSlur&&(o=!0))}if(o&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===n&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&t&&0===t.notation.notationMode&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let e=this.previousBeat;for(;e&&e.isRest;)this.isLetRing||(e.isLetRing=!1),this.isPalmMute||(e.isPalmMute=!1),e=e.previousBeat}let l=this.whammyBarPoints,h=null!==l&&l.length>0;if(h){let e=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=e}else this.whammyBarType=0;if(h&&1===this.whammyBarType)if(1===i&&(this.whammyStyle=a?1:2),4===l.length){let e=l[0],t=l[1],s=l[2],a=l[3];t.value===s.value&&(e.value<t.value&&t.value<a.value||e.value>t.value&&t.value>a.value?(0===e.value||this.isContinuedWhammy?this.whammyBarType=2:this.whammyBarType=6,l.splice(2,1),l.splice(1,1)):e.value>t.value&&t.value<a.value||e.value<t.value&&t.value>a.value?(this.whammyBarType=3,(t.offset===s.offset||1===i)&&l.splice(2,1)):e.value===t.value&&t.value===a.value&&(0===e.value||this.isContinuedWhammy?this.whammyBarType=4:this.whammyBarType=5,l.splice(2,1),l.splice(1,1)))}else if(2===l.length){let e=l[0],t=l[1];e.value<t.value||e.value>t.value?0===e.value||this.isContinuedWhammy?this.whammyBarType=2:this.whammyBarType=6:e.value===t.value&&(0===e.value||this.isContinuedWhammy?this.whammyBarType=4:this.whammyBarType=5)}if(this.updateDurations(),r){let t=Pt.clone(this);t.id=e._globalBeatId++,t.pickStroke=0;for(let e=0,s=t.notes.length;e<s;e++){let s=t.notes[e],i=this.notes[e];if(s.bendType=0,s.maxBendPoint=null,s.bendPoints=null,s.bendStyle=0,s.id=nt.globalNoteId++,i.isTieOrigin&&(s.tieDestination=i.tieDestination,i.tieDestination.tieOrigin=s),i.isTieDestination&&(s.tieOrigin=i.tieOrigin?i.tieOrigin:null,i.tieOrigin.tieDestination=s),i.hasBend&&i.isTieOrigin){let e=nt.findTieOrigin(i);if(e&&e.hasBend){s.bendType=5;let e=i.bendPoints[i.bendPoints.length-1];s.addBendPoint(new T(0,e.value)),s.addBendPoint(new T(T.MaxPosition,e.value))}}s.isTieDestination=!0}this.graceType=3,this.graceGroup=new xe,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,t),t.graceGroup=new xe,t.graceGroup.addBeat(this),t.graceGroup.isComplete=!0,t.graceGroup.finish()}}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}chain(e=null){for(let t of this.notes)this.noteValueLookup.set(t.realValue,t),t.chain(e)}};St._globalBeatId=0;var kt,wt=St,Tt=class{static clone(e){let t=new T;return t.offset=e.offset,t.value=e.value,t}},Bt=class{static clone(e){let t=new nt;if(t.index=e.index,t.accentuated=e.accentuated,t.bendType=e.bendType,t.bendStyle=e.bendStyle,t.isContinuedBend=e.isContinuedBend,e.bendPoints){t.bendPoints=[];for(let s of e.bendPoints)t.addBendPoint(Tt.clone(s))}return t.fret=e.fret,t.string=e.string,t.showStringNumber=e.showStringNumber,t.octave=e.octave,t.tone=e.tone,t.percussionArticulation=e.percussionArticulation,t.isVisible=e.isVisible,t.isLeftHandTapped=e.isLeftHandTapped,t.isHammerPullOrigin=e.isHammerPullOrigin,t.isSlurDestination=e.isSlurDestination,t.harmonicType=e.harmonicType,t.harmonicValue=e.harmonicValue,t.isGhost=e.isGhost,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.isDead=e.isDead,t.isDeadVisual=e.isDeadVisual,t.isStaccato=e.isStaccato,t.slideInType=e.slideInType,t.slideOutType=e.slideOutType,t.vibrato=e.vibrato,t.isTieDestination=e.isTieDestination,t.leftHandFinger=e.leftHandFinger,t.rightHandFinger=e.rightHandFinger,t.trillValue=e.trillValue,t.trillSpeed=e.trillSpeed,t.durationPercent=e.durationPercent,t.accidentalMode=e.accidentalMode,t.dynamics=e.dynamics,t.ornament=e.ornament,t}},xt=class{static clone(e){let t=new k;return t.barOccurence=e.barOccurence,t.millisecondOffset=e.millisecondOffset,t}},vt=class{static clone(e){let t=new w;return t.isLinear=e.isLinear,t.type=e.type,t.value=e.value,t.syncPointValue=e.syncPointValue?xt.clone(e.syncPointValue):void 0,t.ratioPosition=e.ratioPosition,t.text=e.text,t.isVisible=e.isVisible,t}},Pt=class{static clone(e){let t=new wt;t.index=e.index,t.notes=[];for(let s of e.notes)t.addNote(Bt.clone(s));t.isEmpty=e.isEmpty,t.whammyStyle=e.whammyStyle,t.ottava=e.ottava,t.isLegatoOrigin=e.isLegatoOrigin,t.duration=e.duration,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.automations=[];for(let s of e.automations)t.automations.push(vt.clone(s));if(t.dots=e.dots,t.fade=e.fade,t.lyrics=e.lyrics?e.lyrics.slice():null,t.pop=e.pop,t.slap=e.slap,t.tap=e.tap,t.text=e.text,t.slashed=e.slashed,t.deadSlapped=e.deadSlapped,t.brushType=e.brushType,t.brushDuration=e.brushDuration,t.tupletDenominator=e.tupletDenominator,t.tupletNumerator=e.tupletNumerator,t.isContinuedWhammy=e.isContinuedWhammy,t.whammyBarType=e.whammyBarType,e.whammyBarPoints){t.whammyBarPoints=[];for(let s of e.whammyBarPoints)t.addWhammyBarPoint(Tt.clone(s))}return t.vibrato=e.vibrato,t.chordId=e.chordId,t.graceType=e.graceType,t.pickStroke=e.pickStroke,t.tremoloSpeed=e.tremoloSpeed,t.crescendo=e.crescendo,t.displayStart=e.displayStart,t.playbackStart=e.playbackStart,t.displayDuration=e.displayDuration,t.playbackDuration=e.playbackDuration,t.overrideDisplayDuration=e.overrideDisplayDuration,t.golpe=e.golpe,t.dynamics=e.dynamics,t.invertBeamDirection=e.invertBeamDirection,t.preferredBeamDirection=e.preferredBeamDirection,t.isEffectSlurOrigin=e.isEffectSlurOrigin,t.beamingMode=e.beamingMode,t.wahPedal=e.wahPedal,t.barreFret=e.barreFret,t.barreShape=e.barreShape,t.rasgueado=e.rasgueado,t.showTimer=e.showTimer,t.timer=e.timer,t}},Nt=(e=>(e[e.Hint=0]="Hint",e[e.Warning=1]="Warning",e[e.Error=2]="Error",e))(Nt||{}),Mt=((kt=Mt||{})[kt.AT001=1]="AT001",kt[kt.AT002=2]="AT002",kt[kt.AT003=3]="AT003",kt[kt.AT004=4]="AT004",kt[kt.AT005=5]="AT005",kt[kt.AT006=6]="AT006",kt[kt.AT200=200]="AT200",kt[kt.AT201=201]="AT201",kt[kt.AT202=202]="AT202",kt[kt.AT203=203]="AT203",kt[kt.AT204=204]="AT204",kt[kt.AT205=205]="AT205",kt[kt.AT206=206]="AT206",kt[kt.AT207=207]="AT207",kt[kt.AT208=208]="AT208",kt[kt.AT209=209]="AT209",kt[kt.AT210=210]="AT210",kt[kt.AT211=211]="AT211",kt[kt.AT212=212]="AT212",kt[kt.AT213=213]="AT213",kt[kt.AT214=214]="AT214",kt[kt.AT215=215]="AT215",kt[kt.AT216=216]="AT216",kt[kt.AT217=217]="AT217",kt[kt.AT218=218]="AT218",kt[kt.AT300=300]="AT300",kt[kt.AT301=301]="AT301",kt[kt.AT302=302]="AT302",kt[kt.AT303=303]="AT303",kt[kt.AT304=304]="AT304",kt[kt.AT305=305]="AT305",kt[kt.AT306=306]="AT306",kt[kt.AT400=400]="AT400",kt),Et=class{constructor(){this._hasErrors=!1,this.items=[]}get errors(){return this.items.filter(e=>2===e.severity)}get hasErrors(){return this._hasErrors}push(e){this.items.push(e),2===e.severity&&(this._hasErrors=!0)}[Symbol.iterator](){return this.items[Symbol.iterator]()}},Lt=class extends Error{},Ct=(e=>(e[e.Auto=0]="Auto",e[e.Explicit=1]="Explicit",e))(Ct||{}),Ft=(e=>(e[e.Pitched=0]="Pitched",e[e.Fretted=1]="Fretted",e[e.Articulation=2]="Articulation",e))(Ft||{}),Dt=(e=>(e[e.TargetFine=0]="TargetFine",e[e.TargetSegno=1]="TargetSegno",e[e.TargetSegnoSegno=2]="TargetSegnoSegno",e[e.TargetCoda=3]="TargetCoda",e[e.TargetDoubleCoda=4]="TargetDoubleCoda",e[e.JumpDaCapo=5]="JumpDaCapo",e[e.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",e[e.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",e[e.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",e[e.JumpDalSegno=9]="JumpDalSegno",e[e.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",e[e.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",e[e.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",e[e.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",e[e.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",e[e.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",e[e.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",e[e.JumpDaCoda=17]="JumpDaCoda",e[e.JumpDaDoubleCoda=18]="JumpDaDoubleCoda",e))(Dt||{}),It=(e=>(e[e.Short=0]="Short",e[e.Medium=1]="Medium",e[e.Long=2]="Long",e))(It||{}),At=class{constructor(){this.type=0,this.length=0}},Rt=class e{static _toEnum(e,t){return t}static*_basicMappingIterator(t){for(let[s,i]of Object.entries(t).filter(e=>"number"==typeof e[1]))yield[(s.startsWith("_")?s.substring(1):s).toLowerCase(),e._toEnum(t,i)]}static _basic(t,s){let i=new Map(e._basicMappingIterator(t));if(s)for(let e of s)i.set(e[0],e[1]);return i}static _reverse(e){let t=new Map;for(let[s,i]of e)t.has(i)||t.set(i,s);return t}};Rt.whammyTypes=Rt._basic(ct),Rt.whammyTypesReversed=Rt._reverse(Rt.whammyTypes),Rt.bendStyles=Rt._basic(L),Rt.bendStylesReversed=Rt._reverse(Rt.bendStyles),Rt.graceTypes=new Map([["ob",1],["b",3],["bb",2]]),Rt.graceTypesReversed=Rt._reverse(Rt.graceTypes),Rt.fermataTypes=Rt._basic(It),Rt.fermataTypesReversed=Rt._reverse(Rt.fermataTypes),Rt.accidentalModes=Rt._basic(Ct),Rt.accidentalModesReversed=Rt._reverse(Rt.accidentalModes),Rt.barreShapes=Rt._basic(gt),Rt.barreShapesReversed=Rt._reverse(Rt.barreShapes),Rt.ottava=Rt._basic(H),Rt.ottavaReversed=Rt._reverse(Rt.ottava),Rt.rasgueadoPatterns=Rt._basic(ft),Rt.rasgueadoPatternsReversed=Rt._reverse(Rt.rasgueadoPatterns),Rt.dynamics=Rt._basic(f),Rt.dynamicsReversed=Rt._reverse(Rt.dynamics),Rt.bracketExtendModes=Rt._basic(ne),Rt.bracketExtendModesReversed=Rt._reverse(Rt.bracketExtendModes),Rt.trackNamePolicies=Rt._basic(oe),Rt.trackNamePoliciesReversed=Rt._reverse(Rt.trackNamePolicies),Rt.trackNameOrientations=Rt._basic(he),Rt.trackNameOrientationsReversed=Rt._reverse(Rt.trackNameOrientations),Rt.trackNameMode=Rt._basic(le),Rt.trackNameModeReversed=Rt._reverse(Rt.trackNameMode),Rt.textAligns=Rt._basic(Ee),Rt.textAlignsReversed=Rt._reverse(Rt.textAligns),Rt.bendTypes=Rt._basic(C),Rt.bendTypesReversed=Rt._reverse(Rt.bendTypes),Rt.keySignatures=Rt._basic(ge,[["cbmajor",-7],["abminor",-7],["gbmajor",-6],["ebminor",-6],["dbmajor",-5],["bbminor",-5],["abmajor",-4],["fminor",-4],["ebmajor",-3],["cminor",-3],["bbmajor",-2],["gminor",-2],["fmajor",-1],["dminor",-1],["cmajor",0],["aminor",0],["gmajor",1],["eminor",1],["dmajor",2],["bminor",2],["amajor",3],["f#minor",3],["emajor",4],["c#minor",4],["bmajor",5],["g#minor",5],["f#",6],["f#major",6],["d#minor",6],["c#",7],["c#major",7],["a#minor",7]]),Rt.keySignaturesMajorReversed=new Map([[-7,"cb"],[-6,"gb"],[-5,"db"],[-4,"ab"],[-3,"eb"],[-2,"bb"],[-1,"f"],[0,"c"],[1,"g"],[2,"d"],[3,"a"],[4,"e"],[5,"b"],[6,"f#"],[7,"c#"]]),Rt.keySignaturesMinorReversed=new Map([[-7,"abminor"],[-6,"ebminor"],[-5,"bbminor"],[-4,"fminor"],[-3,"cminor"],[-2,"gminor"],[-1,"dminor"],[0,"aminor"],[1,"eminor"],[2,"bminor"],[3,"f#minor"],[4,"c#minor"],[5,"g#minor"],[6,"d#minor"],[7,"a#minor"]]),Rt.keySignatureTypes=new Map([["cb",0],["cbmajor",0],["abminor",1],["gb",0],["gbmajor",0],["ebminor",1],["db",0],["dbmajor",0],["bbminor",1],["ab",0],["abmajor",0],["fminor",1],["eb",0],["ebmajor",0],["cminor",1],["bb",0],["bbmajor",0],["gminor",1],["f",0],["fmajor",0],["dminor",1],["c",0],["cmajor",0],["aminor",1],["g",0],["gmajor",0],["eminor",1],["d",0],["dmajor",0],["bminor",1],["a",0],["amajor",0],["f#minor",1],["e",0],["emajor",0],["c#minor",1],["b",0],["bmajor",0],["g#minor",1],["f#",0],["f#major",0],["d#minor",1],["c#",0],["c#major",0],["a#minor",1]]),Rt.clefs=Rt._basic(pe,[["treble",4],["bass",3],["alto",1],["tenor",2],["n",0]]),Rt.clefsReversed=Rt._reverse(Rt.clefs),Rt.tripletFeels=Rt._basic(Ve,[["no",0],["none",0],["t16",1],["triplet-16th",1],["t8",2],["triplet-8th",2],["d16",3],["dotted-16th",3],["d8",4],["dotted-8th",4],["s16",5],["scottish-16th",5],["s8",6],["scottish-8th",6]]),Rt.tripletFeelsReversed=Rt._reverse(Rt.tripletFeels),Rt.barLines=Rt._basic(ke),Rt.barLinesReversed=Rt._reverse(Rt.barLines),Rt.ottavia=Rt._basic(H),Rt.ottaviaReversed=Rt._reverse(Rt.ottavia),Rt.simileMarks=Rt._basic(me),Rt.simileMarksReversed=Rt._reverse(Rt.simileMarks),Rt.directions=new Map([["fine",0],["segno",1],["segnosegno",2],["coda",3],["doublecoda",4],["dacapo",5],["dacapoalcoda",6],["dacapoaldoublecoda",7],["dacapoalfine",8],["dalsegno",9],["dalsegnoalcoda",10],["dalsegnoaldoublecoda",11],["dalsegnoalfine",12],["dalsegnosegno",13],["dalsegnosegnoalcoda",14],["dalsegnosegnoaldoublecoda",15],["dalsegnosegnoalfine",16],["dacoda",17],["dadoublecoda",18]]),Rt.directionsReversed=Rt._reverse(Rt.directions);var Ot=Rt,Vt=(e=>(e[e.Dot=0]="Dot",e[e.Backslash=1]="Backslash",e[e.DoubleBackslash=2]="DoubleBackslash",e[e.Pipe=3]="Pipe",e[e.LBrace=4]="LBrace",e[e.RBrace=5]="RBrace",e[e.LParen=6]="LParen",e[e.RParen=7]="RParen",e[e.Colon=8]="Colon",e[e.Asterisk=9]="Asterisk",e[e.Ident=10]="Ident",e[e.Tag=11]="Tag",e[e.Meta=12]="Meta",e[e.Values=13]="Values",e[e.Props=14]="Props",e[e.Prop=15]="Prop",e[e.Number=16]="Number",e[e.String=17]="String",e[e.Score=18]="Score",e[e.Bar=19]="Bar",e[e.Beat=20]="Beat",e[e.Duration=21]="Duration",e[e.NoteList=22]="NoteList",e[e.Note=23]="Note",e))(Vt||{}),Wt=class e{static _valueType(e,t,s,i){return{expectedTypes:new Set(e),parseMode:t,allowedValues:s?new Set(s):void 0,reservedIdentifiers:i?new Set(i):void 0}}static _basicList(t){return t.map(t=>e._valueType(t[0],t[1]))}};Wt._scoreInfoValueListTypes=[Wt._valueType([17,10],0),Wt._valueType([17],1),Wt._valueType([17,10],1,Array.from(Ot.textAligns.keys()))],Wt._scoreInfoTemplateValueListTypes=[Wt._valueType([17],0),Wt._valueType([17,10],1,Array.from(Ot.textAligns.keys()))],Wt._numberOnlyValueListTypes=Wt._basicList([[[16],0]]),Wt._textLikeValueListTypes=Wt._basicList([[[17,10],0]]),Wt.chordPropertyValueListTypes=new Map([["firstfret",Wt._numberOnlyValueListTypes],["showdiagram",Wt._basicList([[[17,10,16],1]])],["showfingering",Wt._basicList([[[17,10,16],1]])],["showname",Wt._basicList([[[17,10,16],1]])],["barre",Wt._basicList([[[16],7]])]]),Wt.tuningPropertyValueListTypes=new Map([["hide",void 0],["label",Wt._basicList([[[17],0]])]]),Wt.staffPropertyValueListTypes=new Map([["score",Wt._basicList([[[16],1]])],["tabs",void 0],["slash",void 0],["numbered",void 0]]),Wt.trackPropertyValueListTypes=new Map([["color",Wt._textLikeValueListTypes],["defaultsystemslayout",Wt._numberOnlyValueListTypes],["volume",Wt._numberOnlyValueListTypes],["balance",Wt._numberOnlyValueListTypes],["bank",Wt._numberOnlyValueListTypes],["systemslayout",Wt._basicList([[[16],7]])],["instrument",Wt._basicList([[[10,17,16],0]])],["mute",void 0],["solo",void 0],["multibarrest",void 0]]),Wt.beatPropertyValueListTypes=new Map([["f",void 0],["fo",void 0],["vs",void 0],["v",void 0],["vw",void 0],["s",void 0],["p",void 0],["tt",void 0],["dd",void 0],["d",void 0],["su",void 0],["sd",void 0],["cre",void 0],["dec",void 0],["spd",void 0],["sph",void 0],["spu",void 0],["spe",void 0],["slashed",void 0],["ds",void 0],["glpf",void 0],["glpt",void 0],["waho",void 0],["wahc",void 0],["legatoorigin",void 0],["timer",void 0],["tu",Wt._basicList([[[16],0],[[16],1]])],["txt",Wt._textLikeValueListTypes],["lyrics",Wt._basicList([[[16],1],[[17],0]])],["tb",[Wt._valueType([17,10],1),Wt._valueType([17,10],1),Wt._valueType([16],6)]],["tbe",[Wt._valueType([17,10],1,Array.from(Ot.whammyTypes.keys())),Wt._valueType([17,10],1,Array.from(Ot.bendStyles.keys())),Wt._valueType([16],6)]],["bu",Wt._basicList([[[16],1]])],["bd",Wt._basicList([[[16],1]])],["au",Wt._basicList([[[16],1]])],["ad",Wt._basicList([[[16],1]])],["ch",Wt._textLikeValueListTypes],["gr",[Wt._valueType([17,10],1,Array.from(Ot.graceTypes.keys()))]],["dy",Wt._textLikeValueListTypes],["tempo",[Wt._valueType([16],0),Wt._valueType([17],1),Wt._valueType([10],1,["hide"])]],["volume",Wt._numberOnlyValueListTypes],["balance",Wt._numberOnlyValueListTypes],["tp",Wt._numberOnlyValueListTypes],["barre",[Wt._valueType([16],0),Wt._valueType([17,10],1,Array.from(Ot.barreShapes.keys()))]],["rasg",Wt._textLikeValueListTypes],["ot",Wt._textLikeValueListTypes],["instrument",Wt._basicList([[[10,17,16],0]])],["bank",Wt._numberOnlyValueListTypes],["fermata",[Wt._valueType([17,10],1,Array.from(Ot.fermataTypes.keys())),Wt._valueType([16],3)]],["beam",Wt._textLikeValueListTypes]]),Wt.beatDurationPropertyValueListTypes=new Map([["tu",Wt._basicList([[[16],0],[[16],1]])]]),Wt.notePropertyValueListTypes=new Map([["nh",Wt._basicList([[[16],1]])],["ah",Wt._basicList([[[16],1]])],["th",Wt._basicList([[[16],1]])],["ph",Wt._basicList([[[16],1]])],["sh",Wt._basicList([[[16],1]])],["fh",Wt._basicList([[[16],1]])],["v",void 0],["vw",void 0],["sl",void 0],["ss",void 0],["sib",void 0],["sia",void 0],["sou",void 0],["sod",void 0],["psd",void 0],["psu",void 0],["h",void 0],["lht",void 0],["g",void 0],["ac",void 0],["hac",void 0],["ten",void 0],["pm",void 0],["st",void 0],["lr",void 0],["x",void 0],["-",void 0],["t",void 0],["turn",void 0],["iturn",void 0],["umordent",void 0],["lmordent",void 0],["string",void 0],["hide",void 0],["b",[Wt._valueType([17,10],1),Wt._valueType([17,10],1),Wt._valueType([16],6)]],["be",[Wt._valueType([17,10],1,Array.from(Ot.bendTypes.keys())),Wt._valueType([17,10],1,Array.from(Ot.bendStyles.keys())),Wt._valueType([16],6)]],["tr",Wt._basicList([[[16],0],[[16],1]])],["lf",Wt._basicList([[[16],1]])],["rf",Wt._basicList([[[16],1]])],["acc",Wt._textLikeValueListTypes],["slur",Wt._textLikeValueListTypes]]),Wt.structuralMetaDataValueListTypes=new Map([["track",Wt._basicList([[[17],1],[[17],1]])],["staff",void 0],["voice",void 0]]),Wt.staffMetaDataValueListTypes=new Map([["tuning",[Wt._valueType([10,17],5,["piano","none","voice"]),Wt._valueType([10,17],7)]],["chord",Wt._basicList([[[10,17],0],[[10,17,16],7]])],["capo",Wt._numberOnlyValueListTypes],["instrument",Wt._basicList([[[10,17,16],0]])],["bank",Wt._numberOnlyValueListTypes],["lyrics",Wt._basicList([[[16],1],[[17],0]])],["articulation",Wt._basicList([[[17,10],0],[[16],1]])],["displaytranspose",Wt._numberOnlyValueListTypes],["transpose",Wt._numberOnlyValueListTypes]]),Wt.scoreMetaDataValueListTypes=new Map([["title",Wt._scoreInfoValueListTypes],["subtitle",Wt._scoreInfoValueListTypes],["artist",Wt._scoreInfoValueListTypes],["album",Wt._scoreInfoValueListTypes],["words",Wt._scoreInfoValueListTypes],["music",Wt._scoreInfoValueListTypes],["wordsandmusic",Wt._scoreInfoTemplateValueListTypes],["copyright",Wt._scoreInfoValueListTypes],["copyright2",Wt._scoreInfoTemplateValueListTypes],["instructions",Wt._scoreInfoValueListTypes],["notices",Wt._scoreInfoValueListTypes],["tab",Wt._scoreInfoValueListTypes],["defaultsystemslayout",Wt._numberOnlyValueListTypes],["systemslayout",Wt._basicList([[[16],7]])],["hidedynamics",void 0],["showdynamics",void 0],["usesystemsignseparator",void 0],["multibarrest",void 0],["bracketextendmode",Wt._textLikeValueListTypes],["singletracktracknamepolicy",Wt._textLikeValueListTypes],["multitracktracknamepolicy",Wt._textLikeValueListTypes],["firstsystemtracknamemode",Wt._textLikeValueListTypes],["othersystemstracknamemode",Wt._textLikeValueListTypes],["firstsystemtracknameorientation",Wt._textLikeValueListTypes],["othersystemstracknameorientation",Wt._textLikeValueListTypes]]),Wt.barMetaDataValueListTypes=new Map([["tempo",[Wt._valueType([16],2),Wt._valueType([17],1),Wt._valueType([16],4),Wt._valueType([10],1,["hide"])]],["rc",Wt._numberOnlyValueListTypes],["ae",Wt._basicList([[[16],6]])],["ts",Wt._basicList([[[17,10],5],[[16],0],[[16],0]])],["ks",Wt._textLikeValueListTypes],["clef",Wt._basicList([[[10,17,16],0]])],["section",[Wt._valueType([17,10],0),Wt._valueType([17,10],1,void 0,["x","-","r"])]],["tf",Wt._basicList([[[10,17,16],0]])],["barlineleft",Wt._textLikeValueListTypes],["barlineright",Wt._textLikeValueListTypes],["accidentals",Wt._textLikeValueListTypes],["jump",Wt._textLikeValueListTypes],["ottava",Wt._textLikeValueListTypes],["simile",Wt._textLikeValueListTypes],["width",Wt._numberOnlyValueListTypes],["scale",Wt._basicList([[[16],2]])],["spd",Wt._basicList([[[16],2]])],["spu",Wt._basicList([[[16],2]])],["sph",Wt._basicList([[[16],2]])],["ft",void 0],["ro",void 0],["ac",void 0],["db",void 0],["sync",Wt._basicList([[[16],0],[[16],0],[[16],0],[[16],3]])]]),Wt.metaDataValueListTypes=[Wt.scoreMetaDataValueListTypes,Wt.staffMetaDataValueListTypes,Wt.structuralMetaDataValueListTypes,Wt.barMetaDataValueListTypes];var Ht=Wt,Gt=class e{static ident(e){return{nodeType:10,text:e}}static string(e){return{nodeType:17,text:e}}static number(e){return{nodeType:16,value:e}}static meta(e,t,s){return{nodeType:12,tag:{nodeType:11,prefix:{nodeType:1},tag:{nodeType:10,text:e}},values:t,properties:s,propertiesBeforeValues:!1}}static identMeta(t,s){return e.meta(t,e.identValue(s))}static numberMeta(t,s){return e.meta(t,e.numberValue(s))}static values(e,t=void 0){let s={nodeType:13,values:e.filter(e=>void 0!==e)};if((void 0===t?s.values.length>1:t)&&(s.openParenthesis={nodeType:6},s.closeParenthesis={nodeType:7}),0!==s.values.length)return s}static stringValue(t){return e.values([e.string(t)])}static identValue(t){return e.values([e.ident(t)])}static numberValue(t){return e.values([e.number(t)])}static props(t){let s={nodeType:14,properties:[],openBrace:{nodeType:4},closeBrace:{nodeType:5}};for(let i of t)i&&s.properties.push({nodeType:15,property:e.ident(i[0]),values:i[1]});return s}static prop(t,s,i){t.push({nodeType:15,property:e.ident(s),values:i})}},zt=class e{static getValue(t){return e._values||(e._values=new Map),t=t.toLowerCase().replaceAll(" ",""),e._values.has(t)?e._values.get(t):0}static getName(t){for(let[s,i]of e._values)if(i===t)return s;return t.toString()}static isPiano(e){return e<=7||e>=16&&e<=23}static isGuitar(e){return e>=24&&e<=39||105===e||43===e}static isBass(e){return e>=32&&e<=39}static bankToLsbMsb(e){return[127&e,e>>7&127]}};zt._values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);var Ut=zt,Yt=class{constructor(){this.name="",this.firstFret=1,this.strings=[],this.barreFrets=[],this.showName=!0,this.showDiagram=!0,this.showFingering=!0}get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}},Xt=class extends u{constructor(e){super(1,e)}},$t=class e{constructor(e,t,s,i=255){this.raw=0,this.raw=(255&i)<<24|(255&e)<<16|(255&t)<<8|255&s,this.updateRgba()}updateRgba(){255===this.a?this.rgba=`#${qe.toHexString(this.r,2)}${qe.toHexString(this.g,2)}${qe.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}static random(t=100){return new e(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,t)}static fromJson(t){if(t instanceof e)return t;switch(typeof t){case"number":{let s=new e(0,0,0,0);return s.raw=t,s.updateRgba(),s}case"string":{let s=t;if(s.startsWith("#")){if(4===s.length)return new e(17*Number.parseInt(s[1],16),17*Number.parseInt(s[2],16),17*Number.parseInt(s[3],16));if(5===s.length)return new e(17*Number.parseInt(s[1],16),17*Number.parseInt(s[2],16),17*Number.parseInt(s[3],16),17*Number.parseInt(s[4],16));if(7===s.length)return new e(Number.parseInt(s.substring(1,3),16),Number.parseInt(s.substring(3,5),16),Number.parseInt(s.substring(5,7),16));if(9===s.length)return new e(Number.parseInt(s.substring(1,3),16),Number.parseInt(s.substring(3,5),16),Number.parseInt(s.substring(5,7),16),Number.parseInt(s.substring(7,9),16))}else if(s.startsWith("rgba")||s.startsWith("rgb")){let t=s.indexOf("("),i=s.lastIndexOf(")");if(-1===t||-1===i)throw new Xt("No values specified for rgb/rgba function");let a=s.substring(t+1,i).split(",");if(3===a.length)return new e(Number.parseInt(a[0],10),Number.parseInt(a[1],10),Number.parseInt(a[2],10));if(4===a.length)return new e(Number.parseInt(a[0],10),Number.parseInt(a[1],10),Number.parseInt(a[2],10),255*Number.parseFloat(a[3]))}return null}}throw new Xt("Unsupported format for color")}static toJson(e){return null===e?null:e.raw}};$t.BlackRgb="#000000";var Jt=$t,qt=class e{constructor(){this.startBar=0,this.text=""}finish(e=!1){this.chunks=[],this._parse(this.text,0,this.chunks,e)}_parse(t,s,i,a){if(!t)return;let r=1,n=1,o=!1,l=0;for(;s<t.length;){let i=t.charCodeAt(s);switch(r){case 0:switch(i){case e._charCodeLF:case e._charCodeCR:case e._charCodeTab:break;case e._charCodeSpace:if(!o){r=n;continue}break;default:o=!1,r=n;continue}break;case 1:if(i!==e._charCodeBrackedOpen){l=s,r=2;continue}r=3;break;case 3:i===e._charCodeBrackedClose&&(r=1);break;case 2:switch(i){case e._charCodeDash:r=4;break;case e._charCodeCR:case e._charCodeLF:case e._charCodeSpace:let i=t.substr(l,s-l);this._addChunk(i,a),r=0,n=1}break;case 4:if(i!==e._charCodeDash){let e=t.substr(l,s-l);this._addChunk(e,a),o=!0,r=0,n=1;continue}}s+=1}2===r&&s!==l&&this._addChunk(t.substr(l,s-l),a)}_addChunk(e,t){e=this._prepareChunk(e),(!t||e.length>0&&"-"!==e)&&this.chunks.push(e)}_prepareChunk(e){let t=e.split("+").join(" "),s=t.length;for(;s>0&&"_"===t.charAt(s-1);)s--;return s!==t.length?t.substr(0,s):t}};qt._charCodeLF=10,qt._charCodeTab=9,qt._charCodeCR=13,qt._charCodeSpace=32,qt._charCodeBrackedClose=93,qt._charCodeBrackedOpen=91,qt._charCodeDash=45;var jt=qt,Kt=class{constructor(){this.marker="",this.text=""}},Qt=class e{static getTextForTuning(t,s){let i=e.getTextPartsForTuning(t);return s?i.join(""):i[0]}static getTextPartsForTuning(t,s=-1){let i=t/12|0,a=t%12;return[e.noteNames[a],(i+s).toString()]}static getDefaultTuningFor(t){if(e._defaultTunings.has(t)){let s=e._defaultTunings.get(t);return new e(s.name,s.tunings,s.isStandard)}return null}static getPresetsFor(t){switch(t){case 7:return e._sevenStrings;case 6:return e._sixStrings;case 5:return e._fiveStrings;case 4:return e._fourStrings}return[]}static initialize(){e._defaultTunings.set(7,new e("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),e._sevenStrings.push(e._defaultTunings.get(7)),e._defaultTunings.set(6,new e("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),e._sixStrings.push(e._defaultTunings.get(6)),e._sixStrings.push(new e("Guitar Tune down  step",[63,58,54,49,44,39],!1)),e._sixStrings.push(new e("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),e._sixStrings.push(new e("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),e._sixStrings.push(new e("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),e._sixStrings.push(new e("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),e._sixStrings.push(new e("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),e._sixStrings.push(new e("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),e._sixStrings.push(new e("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),e._sixStrings.push(new e("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),e._sixStrings.push(new e("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),e._sixStrings.push(new e("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),e._sixStrings.push(new e("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),e._sixStrings.push(new e("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),e._sixStrings.push(new e("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),e._sixStrings.push(new e("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),e._sixStrings.push(new e("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),e._sixStrings.push(new e("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),e._sixStrings.push(new e("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),e._sixStrings.push(new e("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),e._sixStrings.push(new e("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),e._sixStrings.push(new e("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),e._sixStrings.push(new e("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),e._sixStrings.push(new e("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),e._sixStrings.push(new e("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),e._sixStrings.push(new e("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),e._sixStrings.push(new e("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),e._sixStrings.push(new e("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),e._sixStrings.push(new e("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),e._sixStrings.push(new e("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),e._sixStrings.push(new e("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),e._defaultTunings.set(5,new e("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),e._fiveStrings.push(e._defaultTunings.get(5)),e._fiveStrings.push(new e("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),e._fiveStrings.push(new e("Banjo Open D Tuning",[62,57,54,50,69],!1)),e._fiveStrings.push(new e("Banjo Open G Tuning",[62,59,55,50,67],!1)),e._fiveStrings.push(new e("Banjo G Minor Tuning",[62,58,55,50,67],!1)),e._fiveStrings.push(new e("Banjo G Modal Tuning",[62,57,55,50,67],!1)),e._defaultTunings.set(4,new e("Bass Standard Tuning",[43,38,33,28],!0)),e._fourStrings.push(e._defaultTunings.get(4)),e._fourStrings.push(new e("Bass Tune down  step",[42,37,32,27],!1)),e._fourStrings.push(new e("Bass Tune down 1 step",[41,36,31,26],!1)),e._fourStrings.push(new e("Bass Tune down 2 step",[39,34,29,24],!1)),e._fourStrings.push(new e("Bass Dropped D Tuning",[43,38,33,26],!1)),e._fourStrings.push(new e("Ukulele C Tuning",[45,40,36,43],!1)),e._fourStrings.push(new e("Ukulele G Tuning",[52,47,43,38],!1)),e._fourStrings.push(new e("Mandolin Standard Tuning",[64,57,50,43],!1)),e._fourStrings.push(new e("Mandolin or Violin Tuning",[76,69,62,55],!1)),e._fourStrings.push(new e("Viola Tuning",[69,62,55,48],!1)),e._fourStrings.push(new e("Cello Tuning",[57,50,43,36],!1))}static findTuning(t){let s=e.getPresetsFor(t.length);for(let i=0,a=s.length;i<a;i++){let a=s[i],r=!0;for(let e=0,s=t.length;e<s;e++)if(t[e]!==a.tunings[e]){r=!1;break}if(r)return new e(a.name,a.tunings,a.isStandard)}return null}constructor(e="",t=null,s=!1){this.isStandard=s,this.name=e,this.tunings=t??[]}reset(){this.isStandard=!1,this.name="",this.tunings=[]}finish(){let t=e.findTuning(this.tunings);t&&(0===this.name.length&&(this.name=t.name),this.isStandard=t.isStandard)}};Qt._sevenStrings=[],Qt._sixStrings=[],Qt._fiveStrings=[],Qt._fourStrings=[],Qt._defaultTunings=new Map,Qt.noteNames=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];var Zt=Qt;Zt.initialize();var es=class e{constructor(){this.index=0,this.bars=[],this.chords=null,this.capo=0,this.transpositionPitch=0,this.displayTranspositionPitch=0,this.stringTuning=new Zt("",[],!1),this.showSlash=!1,this.showNumbered=!1,this.showTablature=!0,this.showStandardNotation=!0,this.isPercussion=!1,this.standardNotationLineCount=e.DefaultStandardNotationLineCount,this._filledVoices=new Set([0])}get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}get filledVoices(){return this._filledVoices}finish(e,t=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1,this.displayTranspositionPitch=0),this.stringTuning.finish();for(let s=0,i=this.bars.length;s<i;s++){this.bars[s].finish(e,t);for(let e of this.bars[s].filledVoices)this._filledVoices.add(e)}}addChord(e,t){t.staff=this;let s=this.chords;null===s&&(s=new Map,this.chords=s),s.set(e,t)}hasChord(e){return this.chords?.has(e)??!1}getChord(e){return this.chords?.get(e)??null}addBar(e){let t=this.bars;e.staff=this,e.index=t.length,t.length>0&&(e.previousBar=t[t.length-1],e.previousBar.nextBar=e),t.push(e)}};es.DefaultStandardNotationLineCount=5;var ts=es,ss=class{constructor(){this.volume=15,this.balance=8,this.port=1,this.program=0,this.bank=0,this.primaryChannel=0,this.secondaryChannel=0,this.isMute=!1,this.isSolo=!1}},is=(e=>(e[e.TrackName=0]="TrackName",e[e.BracesAndBrackets=1]="BracesAndBrackets",e[e.SystemSeparator=2]="SystemSeparator",e[e.StringTuning=3]="StringTuning",e))(is||{}),as=class extends ue{},rs=class e{constructor(){this.index=0,this.staves=[],this.playbackInfo=new ss,this.color=new Jt(200,0,0,255),this.name="",this.isVisibleOnMultiTrack=!0,this.shortName="",this.defaultSystemsLayout=3,this.systemsLayout=[],this.percussionArticulations=[]}get isPercussion(){return this.staves.some(e=>e.isPercussion)}addLineBreaks(e){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(e)}ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new ts)}addStaff(e){e.index=this.staves.length,e.track=this,this.staves.push(e)}finish(t,s=null){this.shortName||(this.shortName=this.name,this.shortName.length>e._shortNameMaxLength&&(this.shortName=this.shortName.substr(0,e._shortNameMaxLength)));for(let e of this.staves)e.finish(t,s),e.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(e){for(let t of e)t.finish();let t=this.staves[0];for(let s=0;s<e.length;s++){let i=e[s];if(i.startBar>=0&&i.startBar<t.bars.length){let a=t.bars[i.startBar].voices[0].beats[0];for(let t=0;t<i.chunks.length&&a;t++){for(;a&&(a.isEmpty||a.isRest);)a=a.nextBeat;a&&(a.lyrics||(a.lyrics=new Array(e.length),a.lyrics.fill("")),a.lyrics[s]=i.chunks[t],a=a.nextBeat)}}}}};rs._shortNameMaxLength=10;var ns=rs,os={};n(os,{BarBounds:()=>us,BeamDirection:()=>Ss,BeatBounds:()=>ps,Bounds:()=>ms,BoundsLookup:()=>ys,MasterBarBounds:()=>gs,NoteBounds:()=>fs,RenderFinishedEventArgs:()=>ls,ScoreRenderer:()=>_s,StaffSystemBounds:()=>bs});var ls=class{constructor(){this.id=qe.newGuid(),this.x=0,this.y=0,this.width=0,this.height=0,this.totalWidth=0,this.totalHeight=0,this.firstMasterBarIndex=-1,this.lastMasterBarIndex=-1,this.renderResult=null}},hs=(e=>(e[e.Page=0]="Page",e[e.Horizontal=1]="Horizontal",e))(hs||{}),ds=class{constructor(e=void 0){this._listeners=[],this._fireOnRegister=e}on(e){return this._listeners.push(e),this._fireOnRegister?.()&&e(),()=>{this.off(e)}}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(){for(let e of this._listeners)e()}},cs=class{constructor(e=void 0){this._listeners=[],this._fireOnRegister=e}on(e){if(this._listeners.push(e),this._fireOnRegister){let t=this._fireOnRegister();null!==t&&e(t)}return()=>{this.off(e)}}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(e){for(let t of this._listeners)t(e)}},us=class{constructor(){this.beats=[]}addBeat(e){e.barBounds=this,this.beats.push(e),this.masterBarBounds.addBeat(e)}findBeatAtPos(e){let t=null;for(let s of this.beats)if(!t||s.realBounds.x<e)t=s;else if(s.realBounds.x>e)break;return t}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.beats.sort((e,t)=>e.realBounds.x-t.realBounds.x);for(let t of this.beats)t.finish(e)}},ps=class{constructor(){this.onNotesX=0,this.notes=null}addNote(e){this.notes||(this.notes=[]),e.beatBounds=this,this.notes.push(e)}findNoteAtPos(e,t){let s=this.notes;if(!s)return null;for(let i of s){let s=i.noteHeadBounds.y+i.noteHeadBounds.h,a=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=e&&i.noteHeadBounds.y<=t&&e<=a&&t<=s)return i.note}return null}finish(e=1){if(this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.onNotesX*=e,this.notes)for(let t of this.notes)t.finish(e)}},ms=class{constructor(){this.x=0,this.y=0,this.w=0,this.h=0}scaleWith(e){this.x*=e,this.y*=e,this.w*=e,this.h*=e}},gs=class{constructor(){this.index=0,this.isFirstOfLine=!1,this.bars=[],this.staffSystemBounds=null}get staveGroupBounds(){return this.staffSystemBounds}addBar(e){e.masterBarBounds=this,this.bars.push(e)}findBeatAtPos(e){let t=null;for(let s of this.bars){let i=s.findBeatAtPos(e);if(i&&(!t||t.realBounds.x<i.realBounds.x)){let s=Math.abs(i.realBounds.x-e);(!t||s<1e7)&&(t=i)}}return t?t.beat:null}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.lineAlignedBounds.scaleWith(e),this.bars.sort((e,t)=>e.realBounds.y<t.realBounds.y?-1:e.realBounds.y>t.realBounds.y?1:e.realBounds.x<t.realBounds.x?-1:e.realBounds.x>t.realBounds.x?1:0);for(let t of this.bars)t.finish(e)}addBeat(e){this.staffSystemBounds.boundsLookup.addBeat(e)}},fs=class{finish(e=1){this.noteHeadBounds.scaleWith(e)}},bs=class{constructor(){this.index=0,this.bars=[]}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e);for(let t of this.bars)t.finish(e)}addBar(e){this.boundsLookup.addMasterBar(e),e.staffSystemBounds=this,this.bars.push(e)}findBarAtPos(e){let t=null;for(let s of this.bars)if(!t||s.realBounds.x<e)t=s;else if(e>s.realBounds.x+s.realBounds.w)break;return t}},ys=class e{constructor(){this._beatLookup=new Map,this._masterBarLookup=new Map,this._currentStaffSystem=null,this.staffSystems=[],this.isFinished=!1}toJson(){let e={},t=[];e.staffSystems=t;for(let e of this.staffSystems){let s={};s.visualBounds=this._boundsToJson(e.visualBounds),s.realBounds=this._boundsToJson(e.realBounds),s.bars=[];for(let t of e.bars){let e={};e.lineAlignedBounds=this._boundsToJson(t.lineAlignedBounds),e.visualBounds=this._boundsToJson(t.visualBounds),e.realBounds=this._boundsToJson(t.realBounds),e.index=t.index,e.bars=[];for(let s of t.bars){let t={};t.visualBounds=this._boundsToJson(s.visualBounds),t.realBounds=this._boundsToJson(s.realBounds),t.beats=[];for(let e of s.beats){let s={};s.visualBounds=this._boundsToJson(e.visualBounds),s.realBounds=this._boundsToJson(e.realBounds),s.onNotesX=e.onNotesX;let i=s;if(i.beatIndex=e.beat.index,i.voiceIndex=e.beat.voice.index,i.barIndex=e.beat.voice.bar.index,i.staffIndex=e.beat.voice.bar.staff.index,i.trackIndex=e.beat.voice.bar.staff.track.index,e.notes){let t=[];s.notes=t;for(let s of e.notes){let e={};e.index=s.note.index,e.noteHeadBounds=this._boundsToJson(s.noteHeadBounds),t.push(e)}}t.beats.push(s)}e.bars.push(t)}s.bars.push(e)}t.push(s)}return e}static fromJson(t,s){let i=new e,a=t.staffSystems;for(let t of a){let a=new bs;a.visualBounds=e._boundsFromJson(t.visualBounds),a.realBounds=e._boundsFromJson(t.realBounds),i.addStaffSystem(a);for(let i of t.bars){let t=new gs;t.index=i.index,t.isFirstOfLine=i.isFirstOfLine,t.lineAlignedBounds=e._boundsFromJson(i.lineAlignedBounds),t.visualBounds=e._boundsFromJson(i.visualBounds),t.realBounds=e._boundsFromJson(i.realBounds),a.addBar(t);for(let a of i.bars){let i=new us;i.visualBounds=e._boundsFromJson(a.visualBounds),i.realBounds=e._boundsFromJson(a.realBounds),t.addBar(i);for(let t of a.beats){let a=new ps;a.visualBounds=e._boundsFromJson(t.visualBounds),a.realBounds=e._boundsFromJson(t.realBounds),a.onNotesX=t.onNotesX;let r=t;if(a.beat=s.tracks[r.trackIndex].staves[r.staffIndex].bars[r.barIndex].voices[r.voiceIndex].beats[r.beatIndex],t.notes){a.notes=[];for(let s of t.notes){let t=new fs,i=s;t.note=a.beat.notes[i.index],t.noteHeadBounds=e._boundsFromJson(s.noteHeadBounds),a.addNote(t)}}i.addBeat(a)}}}}return i}static _boundsFromJson(e){let t=new ms;return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}_boundsToJson(e){let t={};return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}finish(e=1){for(let t of this.staffSystems)t.finish(e);this.isFinished=!0}addStaffSystem(e){e.index=this.staffSystems.length,e.boundsLookup=this,this.staffSystems.push(e),this._currentStaffSystem=e}addMasterBar(e){e.staffSystemBounds?this._masterBarLookup.set(e.index,e):(e.staffSystemBounds=this._currentStaffSystem,this._masterBarLookup.set(e.index,e),this._currentStaffSystem.addBar(e))}addBeat(e){this._beatLookup.has(e.beat.id)||this._beatLookup.set(e.beat.id,[]),this._beatLookup.get(e.beat.id)?.push(e)}findMasterBarByIndex(e){return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findMasterBar(e){let t=e.index;return this._masterBarLookup.has(t)?this._masterBarLookup.get(t):null}findBeat(e){let t=this.findBeats(e);return t?t[0]:null}findBeats(e){let t=e.id;return this._beatLookup.has(t)?this._beatLookup.get(t):null}getBeatAtPos(e,t){let s=0,i=this.staffSystems.length-1,a=-1;for(;s<=i;){let e=(i+s)/2|0,r=this.staffSystems[e];if(t>=r.realBounds.y&&t<=r.realBounds.y+r.realBounds.h){a=e;break}t<r.realBounds.y?i=e-1:s=e+1}if(-1===a)return null;let r=this.staffSystems[a].findBarAtPos(e);return r?r.findBeatAtPos(e):null}getNoteAtPos(e,t,s){let i=this.findBeats(e);if(i)for(let e of i){let i=e.findNoteAtPos(t,s);if(i)return i}return null}},_s=class{constructor(e){this._currentLayoutMode=0,this._currentRenderEngine=null,this._renderedTracks=null,this.canvas=null,this.score=null,this.tracks=null,this.layout=null,this.boundsLookup=null,this.width=0,this.preRender=new cs,this.renderFinished=new cs,this.partialRenderFinished=new cs,this.partialLayoutFinished=new cs,this.postRenderFinished=new ds,this.error=new cs,this.settings=e,this._recreateCanvas(),this._recreateLayout()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}_recreateCanvas(){return this._currentRenderEngine!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=bu.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0)}_recreateLayout(){return(!this.layout||this._currentLayoutMode!==this.settings.display.layoutMode)&&(this.layout=bu.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,!0)}renderScore(e,t){try{this.score=e;let s=null;if(null!=e&&null!=t){if(t){s=[];for(let i of t)i>=0&&i<e.tracks.length&&s.push(e.tracks[i])}else s=e.tracks.slice(0);0===s.length&&e.tracks.length>0&&s.push(e.tracks[0])}this.tracks=s,this.render()}catch(e){this.error.trigger(e)}}renderTracks(e){0===e.length?this.score=null:this.score=e[0].score,this.tracks=e,this.render()}updateSettings(e){this.settings=e}renderResult(e){try{let t=this.layout;t?(re.debug("Rendering",`Request render of lazy partial ${e}`),t.renderLazyPartial(e)):re.warning("Rendering",`Request render of lazy partial ${e} ignored, no layout exists`)}catch(e){this.error.trigger(e)}}render(){if(0!==this.width)if(this.boundsLookup=new ys,this._recreateCanvas(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){re.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let e=0;e<this.tracks.length;e++){let t=this.tracks[e];re.debug("Rendering",`Track ${e}: ${t.name}`)}this.preRender.trigger(!1),this._recreateLayout(),this._layoutAndRender(),re.debug("Rendering","Rendering finished")}else re.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this._onRenderFinished(),this.postRenderFinished.trigger(),re.debug("Rendering","Clearing finished");else re.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null)}resizeRender(){this._recreateLayout()||this._recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(re.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(re.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new ys,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this._onRenderFinished(),this.postRenderFinished.trigger()):re.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),re.debug("Rendering","Resize finished")}_layoutAndRender(){re.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(),this._renderedTracks=this.tracks,this._onRenderFinished(),this.postRenderFinished.trigger()}_onRenderFinished(){this.boundsLookup?.finish(this.settings.display.scale);let e=new ls;e.totalHeight=this.layout.height,e.totalWidth=this.layout.width,e.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(e)}},Ss=(e=>(e[e.Up=0]="Up",e[e.Down=1]="Down",e))(Ss||{}),ks=class e{constructor(){this._allKnownBarMetaDataTags=void 0,this._knownScoreMetaDataTags=void 0,this._knownStructuralMetaDataTags=void 0,this._knownBarMetaDataTags=void 0,this._knownStaffMetaDataTags=void 0,this._knownBeatDurationProperties=void 0,this._knownBeatProperties=void 0,this._knownNoteProperties=void 0}applyScoreMetaData(t,s,i){let a=this._checkValueListTypes(t,[Ht.scoreMetaDataValueListTypes],i,i.tag.tag.text.toLowerCase(),i.values);if(void 0!==a)return a;switch(i.tag.tag.text.toLowerCase()){case"title":return s.title=i.values.values[0].text,this._headerFooterStyle(t,s,0,i),0;case"subtitle":return s.subTitle=i.values.values[0].text,this._headerFooterStyle(t,s,1,i),0;case"artist":return s.artist=i.values.values[0].text,this._headerFooterStyle(t,s,2,i),0;case"album":return s.album=i.values.values[0].text,this._headerFooterStyle(t,s,3,i),0;case"words":return s.words=i.values.values[0].text,this._headerFooterStyle(t,s,4,i),0;case"music":return s.music=i.values.values[0].text,this._headerFooterStyle(t,s,5,i),0;case"copyright":return s.copyright=i.values.values[0].text,this._headerFooterStyle(t,s,8,i),0;case"instructions":return s.instructions=i.values.values[0].text,0;case"notices":return s.notices=i.values.values[0].text,0;case"tab":return s.tab=i.values.values[0].text,this._headerFooterStyle(t,s,7,i),0;case"copyright2":return this._headerFooterStyle(t,s,9,i,0),0;case"wordsandmusic":return this._headerFooterStyle(t,s,6,i,0),0;case"defaultsystemslayout":return s.defaultSystemsLayout=i.values.values[0].value,0;case"systemslayout":for(let e of i.values.values)s.systemsLayout.push(e.value);return 0;case"hidedynamics":return s.stylesheet.hideDynamics=!0,0;case"showdynamics":return s.stylesheet.hideDynamics=!1,0;case"bracketextendmode":let a=e._parseEnumValue(t,i.values,"bracket extend mode",Ot.bracketExtendModes);return void 0===a?1:(s.stylesheet.bracketExtendMode=a,0);case"usesystemsignseparator":return s.stylesheet.useSystemSignSeparator=!0,0;case"multibarrest":return s.stylesheet.multiTrackMultiBarRest=!0,0;case"singletracktracknamepolicy":let r=e._parseEnumValue(t,i.values,"track name policy",Ot.trackNamePolicies);return void 0===r?1:(s.stylesheet.singleTrackTrackNamePolicy=r,0);case"multitracktracknamepolicy":let n=e._parseEnumValue(t,i.values,"track name policy",Ot.trackNamePolicies);return void 0===n?1:(s.stylesheet.multiTrackTrackNamePolicy=n,0);case"firstsystemtracknamemode":let o=e._parseEnumValue(t,i.values,"track name mode",Ot.trackNameMode);return void 0===o?1:(s.stylesheet.firstSystemTrackNameMode=o,0);case"othersystemstracknamemode":let l=e._parseEnumValue(t,i.values,"track name mode",Ot.trackNameMode);return void 0===l?1:(s.stylesheet.otherSystemsTrackNameMode=l,0);case"firstsystemtracknameorientation":let h=e._parseEnumValue(t,i.values,"track name orientation",Ot.trackNameOrientations);return void 0===h?1:(s.stylesheet.firstSystemTrackNameOrientation=h,0);case"othersystemstracknameorientation":let d=e._parseEnumValue(t,i.values,"track name orientation",Ot.trackNameOrientations);return void 0===d?1:(s.stylesheet.otherSystemsTrackNameOrientation=d,0);default:return 2}}_checkValueListTypes(e,t,s,i,a){let r=t.find(e=>e.has(i));if(!r)return 2;let n=r.get(i);if(void 0!==n)return this._validateValueListTypes(e,n,s,a)?void 0:1;a&&e.addSemanticDiagnostic({code:300,message:"Expected no values, but found some. Values are ignored.",start:a.start,end:a.end,severity:1})}applyStaffMetaData(t,s,i){let a=this._checkValueListTypes(t,[Ht.staffMetaDataValueListTypes],i,i.tag.tag.text.toLowerCase(),i.values);if(void 0!==a)return a;switch(i.tag.tag.text.toLowerCase()){case"capo":return s.capo=i.values.values[0].value,0;case"tuning":let a=[],r=!1,n="";for(let e=0;e<i.values.values.length;e++){let o=i.values.values[e],l=o.text;switch(l){case"piano":case"none":case"voice":t.applyStaffNoteKind(s,0),e=i.values.values.length;break;case"hide":r=!0,t.addSemanticDiagnostic({code:305,message:"This value should be rather specified via the properties.",start:o.start,end:o.end,severity:1});break;default:let h=qe.parseTuning(l);if(h)a.push(h.realValue);else if(e===i.values.values.length-1&&a.length>0)n=l,t.addSemanticDiagnostic({code:305,message:"This value should be rather specified via the properties.",start:o.start,end:o.end,severity:1});else{let e=Array.from(qe.tuningLetters).join(","),s=Array.from(qe.accidentalModeMapping.keys()).join(",");t.addSemanticDiagnostic({code:209,message:`Unexpected tuning value '${l}', expected: <note><accidental><octave> where <note>=oneOf(${e}) <accidental>=oneOf(${s}), <octave>=number`,start:o.start,end:o.end,severity:2})}}}return t.state.staffHasExplicitTuning.add(s),t.state.staffTuningApplied.delete(s),s.stringTuning=new Zt,s.stringTuning.tunings=a,s.stringTuning.name=n,this._tuningProperties(t,s,s.stringTuning,i),r&&(s.track.score.stylesheet.perTrackDisplayTuning||(s.track.score.stylesheet.perTrackDisplayTuning=new Map),s.track.score.stylesheet.perTrackDisplayTuning.set(s.track.index,!1)),0;case"instrument":return t.state.staffTuningApplied.delete(s),this._readTrackInstrument(t,s.track,i.values),0;case"bank":return s.track.playbackInfo.bank=i.values.values[0].value,0;case"lyrics":let o=new jt;return o.startBar=0,o.text="",2===i.values.values.length?(o.startBar=i.values.values[0].value,o.text=i.values.values[1].text):o.text=i.values.values[0].text,t.state.lyrics.get(s.track.index).push(o),0;case"chord":let l=new Yt;this._chordProperties(t,l,i),l.name=i.values.values[0].text;for(let e=1;e<i.values.values.length;e++){let s=i.values.values[e];if(16===s.nodeType)l.strings.push(s.value);else if(10===s.nodeType){let e=s.text;"x"===e?l.strings.push(-1):t.addSemanticDiagnostic({code:209,message:`Unexpected chord value '${e}', expected: 'x'`,severity:2,start:s.start,end:s.end})}}return s.addChord(e._getChordId(s,l.name),l),0;case"articulation":let h=t.state.percussionArticulationNames,d=i.values.values[0].text;if("defaults"===d){for(let[e,t]of et.instrumentArticulationNames)h.set(e.toLowerCase(),t),h.set(qe.toArticulationId(e),t);return 0}if(2===i.values.values.length){let e=i.values.values[1].value;if(et.instrumentArticulations.has(e))return h.set(d.toLowerCase(),e),0;{let s=Array.from(et.instrumentArticulations.keys()).map(e=>`${e}`).join(",");return t.addSemanticDiagnostic({code:209,message:`Unexpected articulation value '${e}', expected: ${s}`,start:i.values.values[1].start,end:i.values.values[1].end,severity:2}),1}}return 0;case"accidentals":return e._handleAccidentalMode(t,i.values);case"displaytranspose":return s.displayTranspositionPitch=-1*i.values.values[0].value,t.state.staffHasExplicitDisplayTransposition.add(s),0;case"transpose":return s.transpositionPitch=-1*i.values.values[0].value,0;default:return 2}}applyBarMetaData(t,s,i){let a=this._checkValueListTypes(t,[Ht.barMetaDataValueListTypes],i,i.tag.tag.text.toLowerCase(),i.values);if(void 0!==a)return a;switch(i.tag.tag.text.toLowerCase()){case"sync":let a=this._buildSyncPoint(i);return t.state.syncPoints.push(a),0;case"tempo":let r=0,n=i.values.values[r++].value,o="",l=!0,h=0;for(;r<i.values.values.length;){switch(i.values.values[r].nodeType){case 10:case 17:let e=i.values.values[r].text;"hide"===e?l=!1:o=e;break;case 16:h=i.values.values[r].value}r++}let d=s.masterBar.tempoAutomations.find(e=>e.ratioPosition===h);return d||(d=new w,s.masterBar.tempoAutomations.push(d)),d.isLinear=!1,d.type=0,d.value=n,d.text=o,d.ratioPosition=h,d.isVisible=l,0;case"rc":return s.masterBar.repeatCount=i.values.values[0].value,0;case"ae":for(let e of i.values.values)if(16===e.nodeType){let i=e.value;if(i<1||i>31)return t.addSemanticDiagnostic({code:211,message:"Value is out of valid range. Allowed range: %s, Actual Value: %s",severity:2,start:e.start,end:e.end}),1;s.masterBar.alternateEndings|=1<<i-1}else t.addSemanticDiagnostic({code:202,message:`Unexpected '${Vt[e.nodeType]}' token. Expected one of following: ${Vt[16]}`,severity:2,start:e.start,end:e.end});return 0;case"ts":switch(i.values.values[0].nodeType){case 16:s.masterBar.timeSignatureNumerator=i.values.values[0].value,s.masterBar.timeSignatureDenominator=i.values.values[1].value;break;case 10:case 17:let e=i.values.values[0].text;if("common"!==e.toLowerCase())return t.addSemanticDiagnostic({code:209,message:`Unexpected time signature value '${e}', expected: common or two numbers`,severity:2,start:i.values.values[0].start,end:i.values.values[0].end}),1;s.masterBar.timeSignatureCommon=!0,s.masterBar.timeSignatureNumerator=4,s.masterBar.timeSignatureDenominator=4}return 0;case"ks":let c=e._parseEnumValue(t,i.values,"key signature",Ot.keySignatures);if(void 0===c)return 1;let u=e._parseEnumValue(t,i.values,"key signature type",Ot.keySignatureTypes);return void 0===u?1:(s.keySignature=c,s.keySignatureType=u,0);case"clef":switch(i.values.values[0].nodeType){case 10:case 17:let a=e._parseEnumValue(t,i.values,"clef",Ot.clefs);if(void 0===a)return 1;s.clef=a;break;case 16:let r=i.values.values[0].value;switch(r){case 0:s.clef=0;break;case 43:s.clef=4;break;case 65:s.clef=3;break;case 48:s.clef=1;break;case 60:s.clef=2;break;default:return t.addSemanticDiagnostic({code:209,message:`Unexpected clef value '${r}', expected: ${Array.from(Ot.clefs.keys()).join(",")}`,severity:2,start:i.values.values[0].start,end:i.values.values[0].end}),1}}return 0;case"section":let p=new Kt;return 1===i.values.values.length?p.text=i.values.values[0].text:(p.marker=i.values.values[0].text,p.text=i.values.values[1].text),s.masterBar.section=p,0;case"tf":switch(i.values.values[0].nodeType){case 10:case 17:let a=e._parseEnumValue(t,i.values,"triplet feel",Ot.tripletFeels);if(void 0===a)return 1;s.masterBar.tripletFeel=a;break;case 16:let r=i.values.values[0].value;switch(r){case 0:s.masterBar.tripletFeel=0;break;case 1:s.masterBar.tripletFeel=1;break;case 2:s.masterBar.tripletFeel=2;break;case 3:s.masterBar.tripletFeel=3;break;case 4:s.masterBar.tripletFeel=4;break;case 5:s.masterBar.tripletFeel=5;break;case 6:s.masterBar.tripletFeel=6;break;default:return t.addSemanticDiagnostic({code:209,message:`Unexpected triplet feel value '${r}', expected: ${Array.from(Ot.tripletFeels.keys()).join(",")}`,severity:2,start:i.values.values[0].start,end:i.values.values[0].end}),1}}return 0;case"barlineleft":let m=e._parseEnumValue(t,i.values,"bar line",Ot.barLines);return void 0===m?1:(s.barLineLeft=m,0);case"barlineright":let g=e._parseEnumValue(t,i.values,"bar line",Ot.barLines);return void 0===g?1:(s.barLineRight=g,0);case"accidentals":return e._handleAccidentalMode(t,i.values);case"jump":let f=e._parseEnumValue(t,i.values,"direction",Ot.directions);return void 0===f?1:(s.masterBar.addDirection(f),0);case"ottava":let b=e._parseEnumValue(t,i.values,"clef ottava",Ot.ottavia);return void 0===b?1:(s.clefOttava=b,0);case"simile":let y=e._parseEnumValue(t,i.values,"simile mark",Ot.simileMarks);return void 0===y?1:(s.simileMark=y,0);case"width":return s.masterBar.displayWidth=i.values.values[0].value,s.displayWidth=s.masterBar.displayWidth,0;case"scale":return s.masterBar.displayScale=i.values.values[0].value,s.displayScale=s.masterBar.displayScale,0;case"spd":let _=new ye;return _.pedalType=0,_.ratioPosition=i.values.values[0].value,s.sustainPedals.push(_),0;case"spu":let S=new ye;return S.pedalType=2,S.ratioPosition=i.values.values[0].value,s.sustainPedals.push(S),0;case"sph":let k=new ye;return k.pedalType=1,k.ratioPosition=i.values.values[0].value,s.sustainPedals.push(k),0;case"ft":return s.masterBar.isFreeTime=!0,0;case"ro":return s.masterBar.isRepeatStart=!0,0;case"ac":return s.masterBar.isAnacrusis=!0,0;case"db":return s.masterBar.isDoubleBar=!0,s.barLineRight=7,0;default:return 2}}static _handleAccidentalMode(t,s){let i=e._parseEnumValue(t,s,"accidental mode",Ot.accidentalModes);return void 0===i?1:(t.state.accidentalMode=i,0)}static _getChordId(e,t){return t.toLowerCase()+e.index+e.track.index}_buildSyncPoint(e){let t=e.values.values[0].value,s=e.values.values[1].value,i=e.values.values[2].value,a=0;return e.values.values.length>3&&(a=e.values.values[3].value),{barIndex:t,barOccurence:s,barPosition:a,millisecondOffset:i}}_validateValueListTypes(t,s,i,a){let r=!1,n=0,o=0;if(!a){if(s.some(e=>0===e.parseMode||2===e.parseMode||6===e.parseMode)){let a=e._buildExpectedTypesMessage(s);return t.addSemanticDiagnostic({code:210,message:`Missing value. Expected following values: ${a}`,severity:2,start:i.start,end:i.end}),!1}return!0}if(a.validated)return!0;for(;n<s.length;){let i=s[n],l=o<a.values.length?a.values[o]:void 0;if(l&&i.expectedTypes.has(l.nodeType)&&this._checkRestrictions(i,l))switch(i.parseMode){case 5:n=s.length,o++;break;case 7:case 6:o++;break;default:n++,o++}else if(l)switch(i.parseMode){case 7:case 6:case 1:case 3:case 4:case 5:n++;break;case 0:case 2:r=!0,t.addSemanticDiagnostic({code:209,message:`Unexpected required value '${Vt[l.nodeType]}', expected: ${e._buildExpectedTypesMessage([i])}`,severity:2,start:l.start,end:l.end}),n++,o++}else switch(i.parseMode){case 7:case 6:case 1:case 3:case 4:case 5:n++;break;case 0:case 2:r=!0,t.addSemanticDiagnostic({code:210,message:`Missing values. Expected following values: ${e._buildExpectedTypesMessage([i])}`,severity:2,start:a.end,end:a.end}),n=s.length}}if(o<a.values.length)for(;o<a.values.length;){let i=e._buildExpectedTypesMessage(s),r=a.values[o];t.addSemanticDiagnostic({code:209,message:`Unexpected additional value '${Vt[r.nodeType]}', expected: ${i}`,severity:2,start:r.start,end:r.end}),o++}return!r}_checkRestrictions(e,t){switch(t.nodeType){case 10:let s=t;return e?.allowedValues?e.allowedValues.has(s.text.toLowerCase()):!e?.reservedIdentifiers||!e.reservedIdentifiers.has(s.text.toLowerCase());case 17:let i=t;return!e?.allowedValues||e.allowedValues.has(i.text.toLowerCase());default:return!0}}_headerFooterStyle(t,s,i,a,r=1){let n=a.values.values.length-r;if(n<1)return;let o=qe.getOrCreateHeaderFooterStyle(s,i);void 0===o.isVisible&&(o.isVisible=!0);let l=a.values.values[r].text;if(l?o.template=l:o.isVisible=!1,n<2)return;let h=e._parseEnumValue(t,a.values,"textAlign",Ot.textAligns,r+1);void 0!==h&&(o.textAlign=h)}static _buildExpectedTypesMessage(e){let t=[];for(let s of e){let e=Array.from(s.expectedTypes).map(e=>Vt[e]).join("|");switch(s.parseMode){case 0:case 2:t.push(`required(${e})`);break;case 1:case 3:t.push(`optional(${e})`);break;case 5:t.push(`only(${e})`);break;case 7:t.push(`listOf(${e})`)}}return t.join(",")}_readTrackInstrument(e,t,s){switch(s.values[0].nodeType){case 16:let i=s.values[0].value;i>=0&&i<=127?t.playbackInfo.program=i:e.addSemanticDiagnostic({code:211,message:`Value is out of valid range. Allowed range: 0-127, Actual Value: ${i}`,start:s.values[0].start,end:s.values[0].end,severity:2});break;case 10:case 17:let a=s.values[0].text.toLowerCase();if("percussion"===a){for(let s of t.staves)e.applyStaffNoteKind(s,2);t.playbackInfo.primaryChannel=ze.PercussionChannel,t.playbackInfo.secondaryChannel=ze.PercussionChannel}else t.playbackInfo.program=Ut.getValue(a)}}_chordProperties(t,s,i){if(i.properties)for(let a of i.properties.properties)if(this._checkProperty(t,[Ht.chordPropertyValueListTypes],a))switch(a.property.text.toLowerCase()){case"firstfret":s.firstFret=a.values.values[0].value;break;case"showdiagram":s.showDiagram=e._booleanLikeValue(a.values.values,0);break;case"showfingering":s.showFingering=e._booleanLikeValue(a.values.values,0);break;case"showname":s.showName=e._booleanLikeValue(a.values.values,0);break;case"barre":s.barreFrets=a.values.values.map(e=>e.value)}}_tuningProperties(e,t,s,i){if(i.properties)for(let a of i.properties.properties)if(this._checkProperty(e,[Ht.tuningPropertyValueListTypes],a))switch(a.property.text.toLowerCase()){case"hide":t.track.score.stylesheet.perTrackDisplayTuning||(t.track.score.stylesheet.perTrackDisplayTuning=new Map),t.track.score.stylesheet.perTrackDisplayTuning.set(t.track.index,!1);break;case"label":s.name=a.values.values[0].text}}static _booleanLikeValue(e,t){if(t>=e.length)return!0;let s=e[t];switch(s.nodeType){case 17:case 10:return"false"!==s.text;case 16:return 0!==s.value;default:return!1}}applyStructuralMetaData(e,t){switch(t.tag.tag.text.toLowerCase()){case"staff":let s=e.startNewStaff();return this._staffProperties(e,s,t),1;case"track":let i=e.startNewTrack();return t.values&&t.values.values.length>0&&(i.name=t.values.values[0].text,t.values.values.length>1&&(i.shortName=t.values.values[1].text)),this._trackProperties(e,i,t),0;case"voice":return e.startNewVoice(),2;default:return 4}}_checkProperty(e,t,s){let i=this._checkValueListTypes(e,t,s,s.property.text.toLowerCase(),s.values);if(void 0!==i)switch(i){case 0:case 1:return!1;case 2:let i=t.flatMap(e=>Array.from(e.keys()));return e.addSemanticDiagnostic({code:212,message:`Unrecogized property '${s.property.text}', expected one of ${i}`,severity:2,start:s.start,end:s.end}),!1}return!0}_staffProperties(e,t,s){if(!s.properties)return;let i=!1,a=!1,r=!1,n=!1;for(let o of s.properties.properties)if(this._checkProperty(e,[Ht.staffPropertyValueListTypes],o))switch(o.property.text.toLowerCase()){case"score":i=!0,o.values&&o.values.values.length>0&&(t.standardNotationLineCount=o.values.values[0].value);break;case"tabs":a=!0;break;case"slash":r=!0;break;case"numbered":n=!0}(i||a||r||n)&&(t.showStandardNotation=i,t.showTablature=a,t.showSlash=r,t.showNumbered=n)}_trackProperties(e,t,s){if(s.properties)for(let i of s.properties.properties)if(this._checkProperty(e,[Ht.trackPropertyValueListTypes],i))switch(i.property.text.toLowerCase()){case"color":try{t.color=Jt.fromJson(i.values.values[0].text)}catch{e.addSemanticDiagnostic({code:213,message:"Invalid format for color",severity:2,start:i.values.values[0].start,end:i.values.values[0].end})}break;case"defaultsystemslayout":t.defaultSystemsLayout=i.values.values[0].value;break;case"systemslayout":t.systemsLayout=i.values.values.map(e=>e.value);break;case"volume":t.playbackInfo.volume=i.values.values[0].value;break;case"balance":t.playbackInfo.balance=i.values.values[0].value;break;case"mute":t.playbackInfo.isMute=!0;break;case"solo":t.playbackInfo.isSolo=!0;break;case"multibarrest":t.score.stylesheet.perTrackMultiBarRest||(t.score.stylesheet.perTrackMultiBarRest=new Set),t.score.stylesheet.perTrackMultiBarRest.add(t.index);break;case"instrument":this._readTrackInstrument(e,t,i.values);break;case"bank":t.playbackInfo.bank=i.values.values[0].value}}applyBeatDurationProperty(t,s){let i=this._checkValueListTypes(t,[Ht.beatDurationPropertyValueListTypes],s,s.property.text.toLowerCase(),s.values);if(void 0!==i)return i;if("tu"===s.property.text.toLowerCase()){if(2===s.values.values.length)t.state.currentTupletNumerator=s.values.values[0].value,t.state.currentTupletDenominator=s.values.values[1].value;else{let i=s.values.values[0].value;t.state.currentTupletNumerator=i;let a=e._getTupletDenominator(i);a<0?(t.addSemanticDiagnostic({code:209,message:`Unexpected default tuplet value '${i}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:2,start:s.values.values[0].start,end:s.values.values[0].end}),t.state.currentTupletNumerator=-1,t.state.currentTupletDenominator=-1):t.state.currentTupletDenominator=a}return 0}return 2}static _getTupletDenominator(e){switch(e){case 3:return 2;case 5:case 6:case 7:return 4;case 9:case 10:case 11:case 12:return 8;default:return-1}}get allKnownMetaDataTags(){if(!this._allKnownBarMetaDataTags){this._allKnownBarMetaDataTags=new Set;let e=[Ht.scoreMetaDataValueListTypes.keys(),Ht.structuralMetaDataValueListTypes.keys(),Ht.staffMetaDataValueListTypes.keys(),Ht.barMetaDataValueListTypes.keys()];for(let t of e)for(let e of t)this._allKnownBarMetaDataTags.add(e)}return this._allKnownBarMetaDataTags}get knownScoreMetaDataTags(){return this._knownScoreMetaDataTags||(this._knownScoreMetaDataTags=new Set(Ht.scoreMetaDataValueListTypes.keys())),this._knownScoreMetaDataTags}get knownStructuralMetaDataTags(){return this._knownStructuralMetaDataTags||(this._knownStructuralMetaDataTags=new Set(Ht.structuralMetaDataValueListTypes.keys())),this._knownStructuralMetaDataTags}get knownBarMetaDataTags(){return this._knownBarMetaDataTags||(this._knownBarMetaDataTags=new Set(Ht.barMetaDataValueListTypes.keys())),this._knownBarMetaDataTags}get knownStaffMetaDataTags(){return this._knownStaffMetaDataTags||(this._knownStaffMetaDataTags=new Set(Ht.staffMetaDataValueListTypes.keys())),this._knownStaffMetaDataTags}get knownBeatDurationProperties(){return this._knownBeatDurationProperties||(this._knownBeatDurationProperties=new Set(Ht.beatDurationPropertyValueListTypes.keys())),this._knownBeatDurationProperties}get knownBeatProperties(){return this._knownBeatProperties||(this._knownBeatProperties=new Set(Ht.beatPropertyValueListTypes.keys())),this._knownBeatProperties}get knownNoteProperties(){return this._knownNoteProperties||(this._knownNoteProperties=new Set(Ht.notePropertyValueListTypes.keys())),this._knownNoteProperties}applyBeatProperty(t,s,i){let a=i.property.text.toLowerCase(),r=this._checkValueListTypes(t,[Ht.beatPropertyValueListTypes],i,a,i.values);if(void 0!==r)return r;switch(a){case"f":return s.fade=1,0;case"fo":return s.fade=2,0;case"vs":return s.fade=3,0;case"v":return s.vibrato=1,0;case"vw":return s.vibrato=2,0;case"s":return s.slap=!0,0;case"p":return s.pop=!0,0;case"tt":return s.tap=!0,0;case"txt":return s.text=i.values.values[0].text,0;case"lyrics":let r=0,n="";for(2===i.values.values.length?(r=i.values.values[0].value,n=i.values.values[1].text):n=i.values.values[0].text,s.lyrics||(s.lyrics=[]);s.lyrics.length<=r;)s.lyrics.push("");return s.lyrics[r]=n,0;case"dd":return s.dots=2,0;case"d":return s.dots=1,0;case"su":return s.pickStroke=1,0;case"sd":return s.pickStroke=2,0;case"tu":if(2===i.values.values.length)s.tupletNumerator=i.values.values[0].value,s.tupletDenominator=i.values.values[1].value;else{let a=i.values.values[0].value;s.tupletNumerator=a;let r=e._getTupletDenominator(a);if(r<0)return t.addSemanticDiagnostic({code:209,message:`Unexpected default tuplet value '${a}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:2,start:i.values.values[0].start,end:i.values.values[0].end}),s.tupletNumerator=-1,s.tupletDenominator=-1,1;s.tupletDenominator=r}return 0;case"tb":case"tbe":let o=0;switch(i.values.values[o].nodeType){case 10:case 17:let a=e._parseEnumValue(t,i.values,"whammy type",Ot.whammyTypes,o);if(void 0===a)return 1;s.whammyBarType=a,o++}switch(i.values.values[o].nodeType){case 10:case 17:let a=e._parseEnumValue(t,i.values,"whammy style",Ot.bendStyles,o);if(void 0===a)return 1;s.whammyStyle=a,o++}let l=this._getBendPoints(t,i,o,"tbe"===a);if(l)for(let e of l)s.addWhammyBarPoint(e);return 0;case"bu":return e._applyBrush(s,i,1,.25),0;case"bd":return e._applyBrush(s,i,2,.25),0;case"au":return e._applyBrush(s,i,3,1),0;case"ad":return e._applyBrush(s,i,4,1),0;case"ch":{let a=s.voice.bar.staff,r=i.values.values[0].text,n=e._getChordId(a,r);if(!a.hasChord(n)){let e=new Yt;e.showDiagram=!1,e.name=r,a.addChord(n,e)}return t.state.currentChordId=n,e.applyChordToBeat(s,n,!0),0}case"gr":if(i.values&&i.values.values.length>0){let a=e._parseEnumValue(t,i.values,"whammy style",Ot.graceTypes);if(void 0===a)return 1;s.graceType=a}else s.graceType=2;return 0;case"dy":let h=e._parseEnumValue(t,i.values,"dynamic",Ot.dynamics);return void 0===h?1:(s.dynamics=h,t.state.currentDynamics=h,0);case"cre":return s.crescendo=1,0;case"dec":return s.crescendo=2,0;case"tempo":let d=i.values.values[0].value,c="",u=!0;if(i.values.values.length>2){c=i.values.values[1].text;let e=i.values.values[2].text;if("hide"!==e)return t.addSemanticDiagnostic({code:209,message:`Unexpected third tempo property value '${e}', expected: 'hide'`,severity:2,start:i.values.values[2].start,end:i.values.values[2].end}),1;u=!1}else i.values.values.length>1&&(c=i.values.values[1].text,"hide"===c&&(u=!1,c=""));let p=new w;return p.isLinear=!1,p.type=0,p.value=d,p.text=c,p.isVisible=u,s.automations.push(p),s.voice.bar.masterBar.tempoAutomations.push(p),0;case"volume":let m=new w;return m.isLinear=!0,m.type=1,m.value=i.values.values[0].value,s.automations.push(m),0;case"balance":let g=new w;return g.isLinear=!0,g.type=3,g.value=qe.clamp(i.values.values[0].value,0,16),s.automations.push(g),0;case"tp":if(s.tremoloSpeed=8,i.values&&i.values.values.length>0){let e=i.values.values[0].value;switch(e){case 8:s.tremoloSpeed=8;break;case 16:s.tremoloSpeed=16;break;case 32:s.tremoloSpeed=32;break;default:return t.addSemanticDiagnostic({code:209,message:`Unexpected tremolo speed value '${e}, expected: 8, 16 or 32`,severity:2,start:i.values.values[0].start,end:i.values.values[0].end}),1}}return 0;case"spd":return e._applySustainPedal(t,s,0),0;case"sph":return e._applySustainPedal(t,s,1),0;case"spu":return e._applySustainPedal(t,s,2),0;case"spe":return e._applySustainPedal(t,s,2,!0),0;case"slashed":return s.slashed=!0,0;case"ds":return s.deadSlapped=!0,1===s.notes.length&&s.notes[0].isDead&&s.removeNote(s.notes[0]),0;case"glpf":return s.golpe=2,0;case"glpt":return s.golpe=1,0;case"waho":return s.wahPedal=1,0;case"wahc":return s.wahPedal=2,0;case"barre":if(s.barreFret=i.values.values[0].value,s.barreShape=1,i.values.values.length>1){let a=e._parseEnumValue(t,i.values,"barre shape",Ot.barreShapes,1);if(void 0===a)return 1;s.barreShape=a}return 0;case"rasg":let f=e._parseEnumValue(t,i.values,"rasgueado pattern",Ot.rasgueadoPatterns);return void 0===f?1:(s.rasgueado=f,0);case"ot":let b=e._parseEnumValue(t,i.values,"ottava",Ot.ottava);return void 0===b?1:(s.ottava=b,0);case"legatoorigin":return s.isLegatoOrigin=!0,0;case"instrument":let y=0;switch(i.values.values[0].nodeType){case 10:case 17:y=Ut.getValue(i.values.values[0].text);break;case 16:y=i.values.values[0].value}let _=new w;return _.isLinear=!1,_.type=2,_.value=y,s.automations.push(_),0;case"bank":let S=new w;return S.isLinear=!1,S.type=4,S.value=i.values.values[0].value,s.automations.push(S),0;case"fermata":let k=e._parseEnumValue(t,i.values,"fermata",Ot.fermataTypes);if(void 0===k)return 1;let T=new At;return T.type=k,i.values.values.length>1&&(T.length=i.values.values[1].value),s.fermata=T,0;case"beam":let B=i.values.values[0].text;switch(B.toLowerCase()){case"invert":s.invertBeamDirection=!0;break;case"up":s.preferredBeamDirection=0;break;case"down":s.preferredBeamDirection=1;break;case"auto":s.beamingMode=0;break;case"split":s.beamingMode=1;break;case"merge":s.beamingMode=2;break;case"splitsecondary":s.beamingMode=3;break;default:let e=["invert","up","down","auto","split","merge","splitsecondary"];return t.addSemanticDiagnostic({code:209,message:`Unexpected beam value '${B}', expected: ${e.join(",")}`,severity:2,start:i.values.values[0].start,end:i.values.values[0].end}),1}return 0;case"timer":return s.showTimer=!0,0}return 2}static _applySustainPedal(e,t,s,i=!1){let a=new ye;a.pedalType=s,a.ratioPosition=i?1:.001*t.voice.bar.sustainPedals.length,e.state.sustainPedalToBeat.set(a,t),t.voice.bar.sustainPedals.push(a)}static _applyBrush(e,t,s,i){e.brushType=s,t.values&&t.values.values.length>0?e.brushDuration=t.values.values[0].value:(e.updateDurations(),e.brushDuration=e.playbackDuration*i/e.notes.length)}applyNoteProperty(t,s,i){let a=i.property.text.toLowerCase(),r=this._checkValueListTypes(t,[Ht.notePropertyValueListTypes],i,a,i.values);if(void 0!==r)return r;switch(a){case"b":case"be":let r=0;switch(i.values.values[r].nodeType){case 10:case 17:let a=e._parseEnumValue(t,i.values,"bend type",Ot.bendTypes,r);if(void 0===a)return 1;s.bendType=a,r++}switch(i.values.values[r].nodeType){case 10:case 17:let a=e._parseEnumValue(t,i.values,"bend style",Ot.bendStyles,r);if(void 0===a)return 1;s.bendStyle=a,r++}let n=this._getBendPoints(t,i,r,"be"===a);if(n)for(let e of n)s.addBendPoint(e);return 0;case"nh":return s.harmonicType=1,s.harmonicValue=qe.deltaFretToHarmonicValue(s.fret),0;case"ah":return s.harmonicType=2,s.harmonicValue=e._harmonicValue(i.values,s.harmonicValue),0;case"th":return s.harmonicType=4,s.harmonicValue=e._harmonicValue(i.values,s.harmonicValue),0;case"ph":return s.harmonicType=3,s.harmonicValue=e._harmonicValue(i.values,s.harmonicValue),0;case"sh":return s.harmonicType=5,s.harmonicValue=e._harmonicValue(i.values,s.harmonicValue),0;case"fh":return s.harmonicType=6,s.harmonicValue=e._harmonicValue(i.values,s.harmonicValue),0;case"tr":let o=i.values.values[0].value,l=16;if(i.values.values.length>1){let e=i.values.values[1].value;switch(e){case 16:l=16;break;case 32:l=32;break;case 64:l=64;break;default:return t.addSemanticDiagnostic({code:209,message:`Unexpected trill duration value '${e}', expected: 16, 32 or 64`,severity:2,start:i.values.values[1].start,end:i.values.values[1].end}),1}}return s.trillValue=o+s.stringTuning,s.trillSpeed=l,0;case"v":return s.vibrato=1,0;case"vw":return s.vibrato=2,0;case"sl":return s.slideOutType=2,0;case"ss":return s.slideOutType=1,0;case"sib":return s.slideInType=1,0;case"sia":return s.slideInType=2,0;case"sou":return s.slideOutType=3,0;case"sod":return s.slideOutType=4,0;case"psd":return s.slideOutType=5,0;case"psu":return s.slideOutType=6,0;case"h":return s.isHammerPullOrigin=!0,0;case"lht":return s.isLeftHandTapped=!0,0;case"g":return s.isGhost=!0,0;case"ac":return s.accentuated=1,0;case"hac":return s.accentuated=2,0;case"ten":return s.accentuated=3,0;case"pm":return s.isPalmMute=!0,0;case"st":return s.isStaccato=!0,0;case"lr":return s.isLetRing=!0,0;case"x":return s.isDead=!0,0;case"-":case"t":return s.isTieDestination=!0,0;case"lf":let h=0;if(i.values&&i.values.values.length>0){let s=e._toFinger(t,i.values);if(void 0===s)return 1;h=s}return s.leftHandFinger=h,0;case"rf":let d=0;if(i.values&&i.values.values.length>0){let s=e._toFinger(t,i.values);if(void 0===s)return 1;d=s}return s.rightHandFinger=d,0;case"acc":return s.accidentalMode=qe.parseAccidentalMode(i.values.values[0].text),0;case"turn":return s.ornament=2,0;case"iturn":return s.ornament=1,0;case"umordent":return s.ornament=3,0;case"lmordent":return s.ornament=4,0;case"string":return s.showStringNumber=!0,0;case"hide":return s.isVisible=!1,0;case"slur":let c=i.values.values[0].text;if(t.state.slurs.has(c)){let e=t.state.slurs.get(c);e.slurDestination=s,s.slurOrigin=e,s.isSlurDestination=!0}else t.state.slurs.set(c,s);return 0;default:return this.applyBeatProperty(t,s.beat,i)}return 2}static _toFinger(e,t){let s=t.values[0].value;switch(s){case 1:return 0;case 2:return 1;case 3:return 2;case 4:return 3;case 5:return 4;default:return void e.addSemanticDiagnostic({code:211,message:`Value is out of valid range. Allowed range: 1-5, Actual Value: ${s}`,start:t.values[0].start,end:t.values[0].end,severity:2})}}static _harmonicValue(e,t){return e&&(t=e.values[0].value),t}_getBendPoints(e,t,s,i){let a=t.values.values,r=a.length-s,n=t.values;r>0&&13===a[s].nodeType&&(a=a[s].values,s=0,r=a.length,n=a[s]);let o=i?2:1;if(r%o!==0){let s=Math.ceil(r/o),i=s*o;return void e.addSemanticDiagnostic({code:214,message:`The '${t.property.text}' effect needs ${o} values per item. With ${s} points, ${i} values are needed, only ${r} values found.`,severity:2,start:n.end,end:n.end})}let l=[],h=s;for(;h<a.length;){let e=0,t=0;i?(e=a[h++].value,t=a[h++].value):(e=0,t=a[h++].value),l.push(new T(e,t))}if(l.length>0){if(l.length>60&&l.splice(60,l.length-60),i)l.sort((e,t)=>e.offset-t.offset);else{let e=l.length,t=T.MaxPosition/(e-1)|0,s=0;for(;s<e;)l[s].offset=Math.min(T.MaxPosition,s*t),s++}return l}}static _parseEnumValue(e,t,s,i,a=0){if(a>=t.values.length)return;let r=t.values[a].text;if(i.has(r.toLowerCase()))return i.get(r.toLowerCase());e.addSemanticDiagnostic({code:209,message:`Unexpected ${s} value '${r}', expected: ${Array.from(i.keys()).join(",")}`,severity:2,start:t.values[a].start,end:t.values[a].end})}buildScoreMetaDataNodes(t){let s=[];return e._buildScoreInfoMeta(s,"album",t,t.album,3),e._buildScoreInfoMeta(s,"artist",t,t.artist,2),e._buildScoreInfoMeta(s,"copyright",t,t.copyright,8),e._buildScoreInfoMeta(s,"copyright2",t,void 0,9),e._buildScoreInfoMeta(s,"wordsandmusic",t,void 0,6,!0),e._buildScoreInfoMeta(s,"instructions",t,t.instructions,void 0),e._buildScoreInfoMeta(s,"music",t,t.music,5),e._buildScoreInfoMeta(s,"notices",t,t.notices,void 0),e._buildScoreInfoMeta(s,"subtitle",t,t.subTitle,1),e._buildScoreInfoMeta(s,"title",t,t.title,0),e._buildScoreInfoMeta(s,"words",t,t.words,4),e._buildScoreInfoMeta(s,"tab",t,t.tab,7),t.defaultSystemsLayout!==e._defaultScore.defaultSystemsLayout&&s.push(Gt.numberMeta("defaultSystemsLayout",t.defaultSystemsLayout)),t.systemsLayout.length>0&&s.push(Gt.meta("systemsLayout",Gt.values(t.systemsLayout.map(e=>Gt.number(e))))),e._buildStyleSheetMetaData(s,t.stylesheet),s.length>0&&(s[0].leadingComments=[{text:"Score Metadata",multiLine:!1}]),s}static _buildStyleSheetMetaData(t,s){let i=t.length;s.hideDynamics&&t.push(Gt.meta("hideDynamics")),s.bracketExtendMode!==e._defaultScore.stylesheet.bracketExtendMode&&t.push(Gt.identMeta("bracketExtendMode",Ot.bracketExtendModesReversed.get(s.bracketExtendMode))),s.useSystemSignSeparator&&t.push(Gt.meta("useSystemSignSeparator")),s.multiTrackMultiBarRest&&t.push(Gt.meta("multiBarRest")),s.singleTrackTrackNamePolicy!==e._defaultScore.stylesheet.singleTrackTrackNamePolicy&&t.push(Gt.identMeta("singleTrackTrackNamePolicy",Ot.trackNamePoliciesReversed.get(s.singleTrackTrackNamePolicy))),s.multiTrackTrackNamePolicy!==e._defaultScore.stylesheet.multiTrackTrackNamePolicy&&t.push(Gt.identMeta("multiTrackTrackNamePolicy",Ot.trackNamePoliciesReversed.get(s.multiTrackTrackNamePolicy))),s.firstSystemTrackNameMode!==e._defaultScore.stylesheet.firstSystemTrackNameMode&&t.push(Gt.identMeta("firstSystemTrackNameMode",Ot.trackNameModeReversed.get(s.firstSystemTrackNameMode))),s.otherSystemsTrackNameMode!==e._defaultScore.stylesheet.otherSystemsTrackNameMode&&t.push(Gt.identMeta("otherSystemsTrackNameMode",Ot.trackNameModeReversed.get(s.otherSystemsTrackNameMode))),s.firstSystemTrackNameOrientation!==e._defaultScore.stylesheet.firstSystemTrackNameOrientation&&t.push(Gt.identMeta("firstSystemTrackNameOrientation",Ot.trackNameOrientationsReversed.get(s.firstSystemTrackNameOrientation))),s.otherSystemsTrackNameOrientation!==e._defaultScore.stylesheet.otherSystemsTrackNameOrientation&&t.push(Gt.identMeta("otherSystemsTrackNameOrientation",Ot.trackNameOrientationsReversed.get(s.otherSystemsTrackNameOrientation))),i<t.length&&(t[i].leadingComments=[{multiLine:!1,text:"Score Stylesheet"}])}static _buildScoreInfoMeta(e,t,s,i,a,r=!1){if(void 0!==i&&0===i.length&&!r)return;let n=[];if(void 0!==i&&n.push(Gt.string(i)),void 0!==a){let e=s.style&&s.style.headerAndFooter.has(a)?s.style.headerAndFooter.get(a):void 0,t=Re.defaultHeaderAndFooter.has(a)?Re.defaultHeaderAndFooter.get(a):void 0;e&&(!t||!Ae.equals(t,e))&&(n.push(Gt.string(!1===e.isVisible?"":e.template)),n.push(Gt.ident(Ot.textAlignsReversed.get(e.textAlign))))}void 0===i&&0===n.length||void 0!==i&&0===i.length&&1===n.length||e.push(Gt.meta(t,Gt.values(n)))}buildSyncPointNodes(e){let t=[],s=e.exportFlatSyncPoints();for(let e of s)t.push(Gt.meta("sync",Gt.values([Gt.number(e.barIndex),Gt.number(e.barOccurence),Gt.number(e.millisecondOffset),e.barPosition>0?Gt.number(e.barPosition):void 0])));return t}buildBarMetaDataNodes(t,s,i,a){let r=[];if(e._buildStructuralMetaDataNodes(s,t,r,a,i),!s)return r;0===i&&0===t.index&&0===t.track.index&&e._buildMasterBarMetaDataNodes(r,s.masterBar);let n=r.length;0===i&&0===s.index&&0===t.index&&0===t.track.index&&r.push(Gt.identMeta("accidentals","auto")),(0===s.index||s.clef!==s.previousBar?.clef)&&r.push(Gt.identMeta("clef",Ot.clefsReversed.get(s.clef))),(0===s.index&&2!==s.clefOttava||s.clefOttava!==s.previousBar?.clefOttava)&&r.push(Gt.identMeta("ottava",Ot.ottavaReversed.get(s.clefOttava))),(0===s.index&&0!==s.simileMark||s.simileMark!==s.previousBar?.simileMark)&&r.push(Gt.identMeta("simile",Ot.simileMarksReversed.get(s.simileMark))),1!==s.displayScale&&r.push(Gt.numberMeta("scale",s.displayScale)),s.displayWidth>0&&r.push(Gt.numberMeta("width",s.displayWidth));for(let e of s.sustainPedals){let t="";switch(e.pedalType){case 0:t="spd";break;case 1:t="sph";break;case 2:t="spu"}t&&r.push(Gt.numberMeta(t,e.ratioPosition))}if(0!==s.barLineLeft&&r.push(Gt.identMeta("barLineLeft",Ot.barLinesReversed.get(s.barLineLeft))),0!==s.barLineRight&&r.push(Gt.identMeta("barLineRight",Ot.barLinesReversed.get(s.barLineRight))),0===s.index||s.keySignature!==s.previousBar.keySignature||s.keySignatureType!==s.previousBar.keySignatureType){let e="";e=1===s.keySignatureType?Ot.keySignaturesMinorReversed.get(s.keySignature):Ot.keySignaturesMajorReversed.get(s.keySignature),r.push(Gt.identMeta("ks",e))}return n<r.length&&(r[n].leadingComments=[{multiLine:!1,text:`Bar ${s.index+1} Metadata`}]),r}static _buildStaffMetaDataNodes(t,s){let i=t.length;if(0!==s.capo&&t.push(Gt.numberMeta("capo",s.capo)),s.isPercussion)t.push(Gt.identMeta("articulation","defaults"));else if(s.isStringed){let e=Gt.meta("tuning",Gt.values(s.stringTuning.tunings.map(e=>Gt.ident(Zt.getTextForTuning(e,!0)))));t.push(e),s.track.score.stylesheet.perTrackDisplayTuning&&s.track.score.stylesheet.perTrackDisplayTuning.has(s.track.index)&&(e.properties=Gt.props([["hide",void 0]])),s.stringTuning.name.length>0&&(e.properties??(e.properties=Gt.props([])),Gt.prop(e.properties.properties,"label",Gt.stringValue(s.stringTuning.name)))}0!==s.transpositionPitch&&t.push(Gt.numberMeta("transpose",-s.transpositionPitch));let a=qe.displayTranspositionPitches.has(s.track.playbackInfo.program)?qe.displayTranspositionPitches.get(s.track.playbackInfo.program):0;if(s.displayTranspositionPitch!==a&&t.push(Gt.numberMeta("displaytranspose",-s.displayTranspositionPitch)),null!=s.chords)for(let[i,a]of s.chords)t.push(e._buildChordNode(a));i<t.length&&(t[i].leadingComments=[{multiLine:!1,text:`Staff ${s.index+1} Metadata`}])}static _buildChordNode(e){let t=Gt.meta("chord",Gt.stringValue(e.name),Gt.props([e.firstFret>=0?["firstfret",Gt.numberValue(e.firstFret)]:void 0,["showdiagram",Gt.identValue(e.showDiagram?"true":"false")],["showfingering",Gt.identValue(e.showFingering?"true":"false")],["showname",Gt.identValue(e.showName?"true":"false")],e.barreFrets.length>0?["barre",Gt.values(e.barreFrets.map(e=>Gt.number(e)))]:void 0]));t.propertiesBeforeValues=!0;for(let s=0;s<e.staff.tuning.length;s++)s<e.strings.length&&e.strings[s]>=0?t.values.values.push(Gt.number(e.strings[s])):t.values.values.push(Gt.ident("x"));return t}static _buildMasterBarMetaDataNodes(e,t){let s=e.length;if(0!==t.alternateEndings&&e.push(Gt.meta("ae",Gt.values(qe.getAlternateEndingsList(t.alternateEndings).map(e=>Gt.number(e+1))))),t.isRepeatStart&&e.push(Gt.meta("ro")),t.isRepeatEnd&&e.push(Gt.numberMeta("rc",t.repeatCount)),(0===t.index||t.timeSignatureCommon!==t.previousMasterBar?.timeSignatureCommon||t.timeSignatureNumerator!==t.previousMasterBar.timeSignatureNumerator||t.timeSignatureDenominator!==t.previousMasterBar.timeSignatureDenominator)&&(t.timeSignatureCommon?e.push(Gt.identMeta("ts","common")):e.push(Gt.meta("ts",Gt.values([Gt.number(t.timeSignatureNumerator),Gt.number(t.timeSignatureDenominator)])))),(t.index>0&&t.tripletFeel!==t.previousMasterBar?.tripletFeel||0===t.index&&0!==t.tripletFeel)&&e.push(Gt.identMeta("tf",Ot.tripletFeelsReversed.get(t.tripletFeel))),t.isFreeTime&&e.push(Gt.meta("ft")),null!=t.section&&e.push(Gt.meta("section",Gt.values([Gt.string(t.section.marker),Gt.string(t.section.text)]))),t.isAnacrusis&&e.push(Gt.meta("ac")),1!==t.displayScale&&e.push(Gt.numberMeta("scale",t.displayScale)),t.displayWidth>0&&e.push(Gt.numberMeta("width",t.displayWidth)),t.directions)for(let s of t.directions)e.push(Gt.identMeta("jump",Ot.directionsReversed.get(s)));for(let s of t.tempoAutomations){let t=Gt.meta("tempo",Gt.values([Gt.number(s.value),s.text?Gt.string(s.text):void 0,s.ratioPosition>0?Gt.number(s.ratioPosition):void 0,s.isVisible?void 0:Gt.ident("hide")]));1===t.values.values.length&&(t.values.openParenthesis=void 0,t.values.closeParenthesis=void 0),e.push(t)}s<e.length&&(e[s].leadingComments=[{multiLine:!1,text:`Masterbar ${t.index+1} Metadata`}])}static _buildStructuralMetaDataNodes(t,s,i,a,r){if((void 0===t||0===t.index)&&(0===r&&(0===s.index&&i.push(e._buildNewTrackNode(s.track)),i.push(e._buildNewStaffNode(s)),e._buildStaffMetaDataNodes(i,s)),a)){let e=Gt.meta("voice");e.trailingComments=[{multiLine:!0,text:`Voice ${r+1}`}],i.push(e)}}static _buildNewStaffNode(e){let t=Gt.meta("staff",void 0,Gt.props([e.showStandardNotation?["score",Gt.values([e.standardNotationLineCount!==ts.DefaultStandardNotationLineCount?Gt.number(e.standardNotationLineCount):void 0])]:void 0,e.showTablature?["tabs",void 0]:void 0,e.showSlash?["slash",void 0]:void 0,e.showNumbered?["numbered",void 0]:void 0]));return t.properties&&t.properties.properties.length>0&&(t.properties.properties[0].leadingComments=[{multiLine:!1,text:"Staff Properties"}]),t}static _buildNewTrackNode(t){let s=Gt.meta("track",Gt.values([Gt.string(t.name),t.shortName.length>0?Gt.string(t.shortName):void 0]),Gt.props([t.color.rgba!==e._defaultTrack.color.rgba?["color",Gt.stringValue(t.color.rgba)]:void 0,t.defaultSystemsLayout!==e._defaultTrack.defaultSystemsLayout?["defaultSystemsLayout",Gt.numberValue(t.defaultSystemsLayout)]:void 0,t.systemsLayout.length?["systemsLayout",Gt.values(t.systemsLayout.map(e=>Gt.number(e)))]:void 0,["volume",Gt.numberValue(t.playbackInfo.volume)],["balance",Gt.numberValue(t.playbackInfo.balance)],t.playbackInfo.isMute?["mute",void 0]:void 0,t.playbackInfo.isSolo?["solo",void 0]:void 0,t.score.stylesheet.perTrackMultiBarRest&&t.score.stylesheet.perTrackMultiBarRest.has(t.index)?["multiBarRest",void 0]:void 0,["instrument",Gt.identValue(t.isPercussion?"percussion":Ut.getName(t.playbackInfo.program))],t.playbackInfo.bank>0?["bank",Gt.numberValue(t.playbackInfo.bank)]:void 0]));return s.properties&&s.properties.properties.length>0&&(s.properties.properties[0].leadingComments=[{multiLine:!1,text:"Track Properties"}]),s}buildNoteEffects(e){let t=[];if(e.hasBend){let s=Gt.values([Gt.ident(Ot.bendTypesReversed.get(e.bendType)),0!==e.bendStyle?Gt.ident(Ot.bendStylesReversed.get(e.bendStyle)):void 0],!0);for(let t of e.bendPoints)s.values.push(Gt.number(t.offset)),s.values.push(Gt.number(t.value));Gt.prop(t,"be",s)}let s="";switch(e.harmonicType){case 1:Gt.prop(t,"nh");break;case 2:s="ah";break;case 3:s="ph";break;case 4:s="th";break;case 5:s="sh";break;case 6:s="fh"}switch(s&&Gt.prop(t,s,Gt.numberValue(e.harmonicValue)),e.showStringNumber&&Gt.prop(t,"string"),e.isTrill&&Gt.prop(t,"tr",Gt.values([Gt.number(e.trillFret),Gt.number(e.trillSpeed)])),e.vibrato){case 1:Gt.prop(t,"v");break;case 2:Gt.prop(t,"vw")}switch(e.slideInType){case 1:Gt.prop(t,"sib");break;case 2:Gt.prop(t,"sia")}switch(e.slideOutType){case 1:Gt.prop(t,"ss");break;case 2:Gt.prop(t,"sl");break;case 3:Gt.prop(t,"sou");break;case 4:Gt.prop(t,"sod");break;case 5:Gt.prop(t,"psd");break;case 6:Gt.prop(t,"psu")}switch(e.isHammerPullOrigin&&Gt.prop(t,"h"),e.isLeftHandTapped&&Gt.prop(t,"lht"),e.isGhost&&Gt.prop(t,"g"),e.accentuated){case 1:Gt.prop(t,"ac");break;case 2:Gt.prop(t,"hac");break;case 3:Gt.prop(t,"ten")}if(e.isPalmMute&&Gt.prop(t,"pm"),e.isStaccato&&Gt.prop(t,"st"),e.isLetRing&&Gt.prop(t,"lr"),e.isDead&&Gt.prop(t,"x"),e.isTieDestination&&Gt.prop(t,"t"),e.leftHandFinger>=0&&Gt.prop(t,"lf",Gt.numberValue(e.leftHandFinger+1)),e.rightHandFinger>=0&&Gt.prop(t,"rf",Gt.numberValue(e.rightHandFinger+1)),e.isVisible||Gt.prop(t,"hide"),e.isSlurOrigin){let s=`s${e.id}`;Gt.prop(t,"slur",Gt.identValue(s))}if(e.isSlurDestination){let s=`s${e.slurOrigin.id}`;Gt.prop(t,"slur",Gt.identValue(s))}switch(0!==e.accidentalMode&&Gt.prop(t,"acc",Gt.identValue(qe.reverseAccidentalModeMapping.get(e.accidentalMode))),e.ornament){case 1:Gt.prop(t,"iturn");break;case 2:Gt.prop(t,"turn");break;case 3:Gt.prop(t,"umordent");break;case 4:Gt.prop(t,"lmordent")}return t}buildBeatEffects(e){let t=[];switch(e.fade){case 1:Gt.prop(t,"f");break;case 2:Gt.prop(t,"fo");break;case 3:Gt.prop(t,"vs")}if(1===e.vibrato?Gt.prop(t,"v"):2===e.vibrato&&Gt.prop(t,"vw"),e.slap&&Gt.prop(t,"s"),e.pop&&Gt.prop(t,"p"),e.tap&&Gt.prop(t,"tt"),e.dots>=2?Gt.prop(t,"dd"):e.dots>0&&Gt.prop(t,"d"),1===e.pickStroke?Gt.prop(t,"su"):2===e.pickStroke&&Gt.prop(t,"sd"),e.hasTuplet&&Gt.prop(t,"tu",Gt.values([Gt.number(e.tupletNumerator),Gt.number(e.tupletDenominator)])),e.hasWhammyBar){let s=Gt.values([Gt.ident(Ot.whammyTypesReversed.get(e.whammyBarType)),Gt.ident(Ot.bendStylesReversed.get(e.whammyStyle))],!0);for(let t of e.whammyBarPoints)s.values.push(Gt.number(t.offset)),s.values.push(Gt.number(t.value));Gt.prop(t,"tbe",s)}let s="";switch(e.brushType){case 1:s="bu";break;case 2:s="bd";break;case 3:s="au";break;case 4:s="ad"}if(s&&Gt.prop(t,s,Gt.numberValue(e.brushDuration)),null!=e.chord&&Gt.prop(t,"ch",Gt.stringValue(e.chord.name)),2!==e.ottava&&Gt.prop(t,"ot",Gt.identValue(Ot.ottavaReversed.get(e.ottava))),e.hasRasgueado&&Gt.prop(t,"rasg",Gt.identValue(Ot.rasgueadoPatternsReversed.get(e.rasgueado))),null!=e.text&&Gt.prop(t,"txt",Gt.stringValue(e.text)),null!=e.lyrics&&e.lyrics.length>0)if(e.lyrics.length>1)for(let s=0;s<e.lyrics.length;s++)Gt.prop(t,"lyrics",Gt.values([Gt.number(s),Gt.string(e.lyrics[s])]));else Gt.prop(t,"lyrics",Gt.stringValue(e.lyrics[0]));switch(0!==e.graceType&&Gt.prop(t,"gr",2===e.graceType?void 0:Gt.identValue(Ot.graceTypesReversed.get(e.graceType))),e.isTremolo&&Gt.prop(t,"tp",Gt.numberValue(e.tremoloSpeed)),e.crescendo){case 1:Gt.prop(t,"cre");break;case 2:Gt.prop(t,"dec")}(0===e.voice.bar.index&&0===e.index||e.dynamics!==e.previousBeat?.dynamics)&&Gt.prop(t,"dy",Gt.identValue(Ot.dynamicsReversed.get(e.dynamics))),null!=e.fermata&&Gt.prop(t,"fermata",Gt.values([Gt.ident(Ot.fermataTypesReversed.get(e.fermata.type)),Gt.number(e.fermata.length)])),e.isLegatoOrigin&&Gt.prop(t,"legatoorigin");for(let s of e.automations)switch(s.type){case 0:Gt.prop(t,"tempo",Gt.values([Gt.number(s.value),0===s.text.length?void 0:Gt.string(s.text)]));break;case 1:Gt.prop(t,"volume",Gt.numberValue(s.value));break;case 2:e.voice.bar.staff.isPercussion||Gt.prop(t,"instrument",Gt.identValue(Ut.getName(s.value)));break;case 3:Gt.prop(t,"balance",Gt.numberValue(s.value))}switch(e.wahPedal){case 1:Gt.prop(t,"waho");break;case 2:Gt.prop(t,"wahc")}switch(e.isBarre&&Gt.prop(t,"barre",Gt.values([Gt.number(e.barreFret),Gt.ident(Ot.barreShapesReversed.get(e.barreShape))])),e.slashed&&Gt.prop(t,"slashed"),e.deadSlapped&&Gt.prop(t,"ds"),e.golpe){case 1:Gt.prop(t,"glpt");break;case 2:Gt.prop(t,"glpf")}e.invertBeamDirection?Gt.prop(t,"beam",Gt.identValue("invert")):null!==e.preferredBeamDirection&&Gt.prop(t,"beam",Gt.identValue(Ss[e.preferredBeamDirection]));let i="";switch(e.beamingMode){case 1:i="split";break;case 2:i="merge";break;case 3:i="splitsecondary"}return i&&Gt.prop(t,"beam",Gt.identValue(i)),e.showTimer&&Gt.prop(t,"timer"),t}static applyChordToBeat(e,t,s){let i=e.voice.bar.staff,a=i.tuning.length;s&&(e.chordId=t);let r=i.getChord(t);if(r)for(let t of e.notes){let e=a-t.string;e>=0&&e<r.strings.length&&r.strings[e]===t.fret&&(t.isDeadVisual=!0)}}};ks.instance=new ks,ks._defaultScore=new Oe,ks._defaultTrack=new ns;var ws=ks,Ts=class e{readMetaDataValues(e,t){let s=t.tag.text.toLowerCase();for(let t of Ht.metaDataValueListTypes)if(t.has(s)){let i=t.get(s);return i?this._readTypedValueList(e,i):void 0}throw e.addParserDiagnostic({code:204,message:`Unrecognized metadata '${t.tag.text}'.`,severity:2,start:t.start,end:t.end}),new Lt}readMetaDataPropertyValues(e,t,s){switch(t.tag.text.toLowerCase()){case"track":return this._readPropertyValues(e,[Ht.trackPropertyValueListTypes],s);case"chord":return this._readPropertyValues(e,[Ht.chordPropertyValueListTypes],s);case"tuning":return this._readPropertyValues(e,[Ht.tuningPropertyValueListTypes],s);case"staff":return this._readPropertyValues(e,[Ht.staffPropertyValueListTypes],s);default:return}}readBeatPropertyValues(e,t){return this._readPropertyValues(e,[Ht.beatPropertyValueListTypes],t)}readDurationChangePropertyValues(e,t){return this._readPropertyValues(e,[Ht.beatDurationPropertyValueListTypes],t)}readNotePropertyValues(e,t){return this._readPropertyValues(e,[Ht.notePropertyValueListTypes,Ht.beatPropertyValueListTypes],t)}_readPropertyValues(e,t,s){let i=s.property.text.toLowerCase(),a=new Set([10,5]);for(let s of t)if(s.has(i)){let t=s.get(i);return t?this._readTypedValueList(e,t,a):void 0}throw e.addParserDiagnostic({code:205,message:`Unrecognized property '${s.property.text}'.`,severity:2,start:s.property.start,end:s.property.end}),new Lt}_readTypedValueList(t,s,i){let a=[],r=t.lexer.peekToken()?.start,n=!1,o=void 0!==i,l=0;for(;l<s.length;){let i=s[l],r=t.lexer.peekToken();if(4===i.parseMode){o=!1;break}if(r&&(i.expectedTypes.has(r.nodeType)||e._isValueListMatch(r,i))&&this._handleTypeValueListItem(t,a,r,i))switch(i.parseMode){case 5:l=s.length;break;case 7:break;default:l++}else switch(i.parseMode){case 7:case 1:case 3:case 5:case 6:l++;break;case 0:case 2:t.unexpectedToken(r,Array.from(i.expectedTypes),!0),n=!0}}if(n)throw new Lt;if(o){let e=t.lexer.peekToken();for(;e&&!i.has(e.nodeType);)e=this._handleTypeValueListItem(t,a,e,void 0)?t.lexer.peekToken():void 0}if(0===a.length)return;let h=Gt.values(a,!1);return h.start=r,h.end=t.lexer.previousTokenEndLocation(),h.validated=!0,h}_handleTypeValueListItem(e,t,s,i){switch(s.nodeType){case 10:let a=s;if(i?.allowedValues){if(!i.allowedValues.has(a.text.toLowerCase()))return!1;t.push(a),e.lexer.advance()}else if(i?.reservedIdentifiers){if(i.reservedIdentifiers.has(a.text.toLowerCase()))return!1;t.push(a),e.lexer.advance()}else t.push(a),e.lexer.advance();return!0;case 17:let r=s;return i?.allowedValues?i.allowedValues.has(r.text.toLowerCase())&&(t.push(r),e.lexer.advance()):(t.push(r),e.lexer.advance()),!0;case 16:switch(i?.parseMode??1){case 2:case 3:t.push(e.lexer.extendToFloat(s)),e.lexer.advance();break;default:t.push(s),e.lexer.advance()}return!0;case 6:let n=e.valueList();if(n)for(let e of n.values)t.push(e);return!0}return!1}static _isValueListMatch(e,t){return 6===e.nodeType&&(t.expectedTypes.has(13)||7===t.parseMode||6===t.parseMode)}};Ts.instance=new Ts;var Bs=Ts,xs=class e{static float64ToBytes(t){return e._dataView.setFloat64(0,t,!0),e._conversionByteArray}static bytesToInt64LE(t){e._conversionByteArray.set(t,0);let s=e._dataView.getBigInt64(0,!0);return s<=Number.MAX_SAFE_INTEGER&&s>=Number.MIN_SAFE_INTEGER?Number(s):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(t){return e._conversionByteArray.set(t,0),e._dataView.getFloat64(0,!0)}static bytesToFloat32LE(t){return e._conversionByteArray.set(t,0),e._dataView.getFloat32(0,!0)}static float32BEToBytes(t){return e._dataView.setFloat32(0,t,!1),e._conversionByteArray.slice(0,4)}static uint16ToInt16(t){return e._dataView.setUint16(0,t,!0),e._dataView.getInt16(0,!0)}static int16ToUint32(t){return e._dataView.setInt16(0,t,!0),e._dataView.getUint32(0,!0)}static int32ToUint16(t){return e._dataView.setInt32(0,t,!0),e._dataView.getUint16(0,!0)}static int32ToInt16(t){return e._dataView.setInt32(0,t,!0),e._dataView.getInt16(0,!0)}static int32ToUint32(t){return e._dataView.setInt32(0,t,!0),e._dataView.getUint32(0,!0)}static uint8ToInt8(t){return e._dataView.setUint8(0,t),e._dataView.getInt8(0)}};xs._conversionBuffer=new ArrayBuffer(8),xs._conversionByteArray=new Uint8Array(xs._conversionBuffer),xs._dataView=new DataView(xs._conversionBuffer);var vs=xs,Ps=class e{static readInt32BE(e){return e.readByte()<<24|e.readByte()<<16|e.readByte()<<8|e.readByte()}static readFloat32BE(e){let t=new Uint8Array(4);return e.read(t,0,t.length),t.reverse(),vs.bytesToFloat32LE(t)}static readFloat64BE(e){let t=new Uint8Array(8);return e.read(t,0,t.length),t.reverse(),vs.bytesToFloat64LE(t)}static readInt32LE(e){let t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static readInt64LE(e){let t=new Uint8Array(8);return e.read(t,0,t.length),vs.bytesToInt64LE(t)}static readUInt32LE(e){let t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static decodeUInt32LE(e,t){let s=e[t],i=e[t+1],a=e[t+2];return e[t+3]<<24|a<<16|i<<8|s}static readUInt16LE(e){let t=e.readByte(),s=e.readByte();return vs.int32ToUint16(s<<8|t)}static readInt16LE(e){let t=e.readByte(),s=e.readByte();return vs.int32ToInt16(s<<8|t)}static readUInt32BE(e){let t=e.readByte(),s=e.readByte(),i=e.readByte(),a=e.readByte();return vs.int32ToUint32(t<<24|s<<16|i<<8|a)}static readUInt16BE(e){let t=e.readByte(),s=e.readByte();return vs.int32ToInt16(t<<8|s)}static readInt16BE(e){let t=e.readByte(),s=e.readByte();return vs.int32ToInt16(t<<8|s)}static readByteArray(e,t){let s=new Uint8Array(t);return e.read(s,0,t),s}static read8BitChars(t,s){let i=new Uint8Array(s);return t.read(i,0,i.length),e.toString(i,"utf-8")}static read8BitString(e){let t="",s=e.readByte();for(;0!==s;)t+=String.fromCharCode(s),s=e.readByte();return t}static read8BitStringLength(e,t){let s="",i=-1;for(let a=0;a<t;a++){let t=e.readByte();0===t&&-1===i&&(i=a),s+=String.fromCharCode(t)}let a=s;return i>=0?a.substr(0,i):a}static readSInt8(e){let t=e.readByte();return-256*((255&t)>>7)+(255&t)}static readInt24(e,t){let s=e[t]|e[t+1]<<8|e[t+2]<<16;return!(8388608&~s)&&(s|=255<<24),s}static readInt16(e,t){return vs.int32ToInt16(e[t]|e[t+1]<<8)}static toString(t,s){let i=e._detectEncoding(t);return i&&(s=i),s||(s="utf-8"),new TextDecoder(s).decode(t.buffer)}static _detectEncoding(e){return e.length>2&&254===e[0]&&255===e[1]?"utf-16be":e.length>2&&255===e[0]&&254===e[1]?"utf-16le":e.length>4&&0===e[0]&&0===e[1]&&254===e[2]&&255===e[3]?"utf-32be":e.length>4&&255===e[0]&&254===e[1]&&0===e[2]&&0===e[3]?"utf-32le":null}static stringToBytes(e){return(new TextEncoder).encode(e)}static writeInt32BE(e,t){e.writeByte(t>>24&255),e.writeByte(t>>16&255),e.writeByte(t>>8&255),e.writeByte(255&t)}static writeInt32LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255),e.writeByte(t>>16&255),e.writeByte(t>>24&255)}static writeUInt16LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255)}static writeInt16LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255)}static writeInt16BE(e,t){e.writeByte(t>>8&255),e.writeByte(255&t)}static writeFloat32BE(e,t){let s=vs.float32BEToBytes(t);e.write(s,0,s.length)}static*iterateCodepoints(t){let s=0;for(;s<t.length;){let i=t.charCodeAt(s);e.isLeadingSurrogate(i)&&s+1<t.length&&(s++,i=1024*(i-55296)+(t.charCodeAt(s)-56320)+65536),s++,yield i}}static isLeadingSurrogate(e){return e>=55296&&e<=56319}static isTrailingSurrogate(e){return e>=56320&&e<=57343}},Ns=class e{constructor(t){this._codepoint=e._eof,this._offset=0,this._line=1,this._col=1,this._fatalError=!1,this._tokenStart={line:0,col:0,offset:0},this.lexerDiagnostics=new Et,this._codepoints=[...Ps.iterateCodepoints(t)],this._offset=0,this._line=1,this._col=1,this._codepoint=this._codepoints.length>0?this._codepoints[0]:e._eof}peekToken(){if(this._fatalError)return;let e=this._peekedToken;return e||(e=this._readToken(),this._peekedToken=e,e)}extendToFloat(t){if(46!==this._codepoint||this._offset+1>=this._codepoints.length||!e._isDigit(this._codepoints[this._offset+1]))return t;let s=this._offset+2;for(;s<this._codepoints.length&&e._isDigit(this._codepoints[s]);)s++;if(s<this._codepoints.length&&e._isIdentifierCharacter(this._codepoints[s]))return t;let i=s-this._offset-1;return this._offset+=i,this._col+=i,this._nextCodepoint(),t.end=this._currentLexerLocation(),t.value=Number.parseFloat(String.fromCodePoint(...this._codepoints.slice(t.start.offset,t.end.offset))),t}advance(){this._previousToken=this._peekedToken,this._peekedToken=void 0}_nextCodepoint(){let t=this._codepoints,s=this._offset;if(s<t.length-1){++s;let e=t[s];return this._codepoint=e,10===e?(this._trailingCommentNode=void 0,++this._line,this._col=1):++this._col,this._offset=s,e}return this._codepoint!==e._eof&&(this._codepoint=e._eof,++this._col,this._offset=t.length),e._eof}previousTokenEndLocation(){return this._previousToken?.end??this._currentLexerLocation()}currentTokenLocation(){return this._peekedToken?.start??this._currentLexerLocation()}_currentLexerLocation(){return{line:this._line,col:this._col,offset:this._offset}}_readToken(){for(this._leadingComments=void 0;this._codepoint!==e._eof;)if(this._tokenStart=this._currentLexerLocation(),e._terminalTokens.has(this._codepoint)){let t=e._terminalTokens.get(this._codepoint)(this);if(t)return this._trailingCommentNode=t,t}else{if(e._isIdentifierCharacter(this._codepoint)){let e=this._numberOrIdentifier();return this._trailingCommentNode=e,e}this._codepoint=this._nextCodepoint()}}_comment(){this._codepoint=this._nextCodepoint(),47===this._codepoint?this._singleLineComment():42===this._codepoint?this._multiLineComment():(this.lexerDiagnostics.push({code:1,message:`Unexpected character at comment start, expected '//' or '/*' but found '/${String.fromCodePoint(this._codepoint)}'`,severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),this._fatalError=!0)}_metaCommand(){let t,s,i=this._currentLexerLocation();this._codepoint=this._nextCodepoint(),92===this._codepoint?(this._codepoint=this._nextCodepoint(),s=this._currentLexerLocation(),t={nodeType:2,start:i,end:s}):(s=this._currentLexerLocation(),t={nodeType:1,start:i,end:s});let a="";for(;e._isIdentifierCharacter(this._codepoint);)a+=String.fromCodePoint(this._codepoint),this._codepoint=this._nextCodepoint();if(0!==a.length)return{nodeType:11,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),prefix:t,tag:{nodeType:10,text:a,start:s,end:this._currentLexerLocation()}};this.lexerDiagnostics.push({code:2,message:"Missing identifier after meta data start",severity:2,start:this._tokenStart,end:this._currentLexerLocation()})}_token(e){return e.leadingComments=this._leadingComments,e.start=this._tokenStart,e.end=this._currentLexerLocation(),this._codepoint=this._nextCodepoint(),e}_string(){let t=this._codepoint;this._codepoint=this._nextCodepoint();let s="",i=-1;for(;this._codepoint!==t&&this._codepoint!==e._eof;){let a=-1;if(92===this._codepoint)if(this._codepoint=this._nextCodepoint(),92===this._codepoint)a=92;else if(this._codepoint===t)a=t;else if(82===this._codepoint||114===this._codepoint)a=13;else if(78===this._codepoint||110===this._codepoint)a=10;else if(84===this._codepoint||116===this._codepoint)a=9;else{if(117!==this._codepoint)return this.lexerDiagnostics.push({code:5,message:`Unsupported escape sequence. Expected '\\n', '\\r', '\\t', or '\\uXXXX' but found '\\${String.fromCodePoint(this._codepoint)}'.`,severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),void(this._fatalError=!0);{let t="";for(let s=0;s<4;s++){if(this._codepoint=this._nextCodepoint(),this._codepoint===e._eof)return this.lexerDiagnostics.push({code:3,message:"Unexpected end of file. Need 4 hex characters on a \\uXXXX escape sequence",severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),void(this._fatalError=!0);t+=String.fromCodePoint(this._codepoint)}if(a=Number.parseInt(t,16),Number.isNaN(a))return this.lexerDiagnostics.push({code:4,message:"Invalid unicode value. Need 4 hex characters on a \\uXXXX escape sequence.",severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),void(this._fatalError=!0)}}else a=this._codepoint;Ps.isLeadingSurrogate(i)&&Ps.isTrailingSurrogate(a)?(a=1024*(i-55296)+(a-56320)+65536,s+=String.fromCodePoint(a)):Ps.isLeadingSurrogate(a)||(Ps.isLeadingSurrogate(i)&&(s+=String.fromCodePoint(i)),a>0&&(s+=String.fromCodePoint(a))),i=a,this._codepoint=this._nextCodepoint()}if(this._codepoint===e._eof)return this.lexerDiagnostics.push({code:6,message:"Unexpected end of file. String not closed.",severity:2,start:this._tokenStart,end:this._currentLexerLocation()}),void(this._fatalError=!0);let a={nodeType:17,text:s,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation()};return this._codepoint=this._nextCodepoint(),a}_multiLineComment(){let t=this._trailingCommentNode,s={start:this._tokenStart,end:this._currentLexerLocation(),text:"",multiLine:!0};for(;this._codepoint!==e._eof;)if(42===this._codepoint){if(this._codepoint=this._nextCodepoint(),47===this._codepoint){this._codepoint=this._nextCodepoint();break}s.text+=`*${String.fromCodePoint(this._codepoint)}`,s.end.line=this._line,s.end.col=this._col,s.end.offset=this._offset}else this._codepoint=this._nextCodepoint(),s.text+=String.fromCodePoint(this._codepoint),s.end.line=this._line,s.end.col=this._col,s.end.offset=this._offset;t?(t.trailingComments??(t.trailingComments=[]),t.trailingComments.push(s)):(this._leadingComments??(this._leadingComments=[]),this._leadingComments.push(s))}_numberOrIdentifier(){let t="",s=!0,i=this._codepoint;45===i&&(t+=String.fromCodePoint(i),i=this._nextCodepoint(),e._isDigit(i)||(s=!1));let a=!0;do{s?e._isDigit(i)?(t+=String.fromCodePoint(i),i=this._nextCodepoint(),a=!0):e._isIdentifierCharacter(i)?(s=!1,t+=String.fromCodePoint(i),i=this._nextCodepoint(),a=!0):a=!1:e._isIdentifierCharacter(i)?(t+=String.fromCodePoint(i),i=this._nextCodepoint(),a=!0):a=!1}while(a);return s?{nodeType:16,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),value:Number.parseInt(t,10)}:{nodeType:10,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),text:t}}_singleLineComment(){let t=this._trailingCommentNode,s={start:this._tokenStart,end:this._currentLexerLocation(),text:"",multiLine:!1},i=this._codepoint;for(;i!==e._eof&&(i=this._nextCodepoint(),10!==i&&i!==e._eof);)s.text+=String.fromCodePoint(i),s.end.line=this._line,s.end.col=this._col,s.end.offset=this._offset;t?(t.trailingComments??(t.trailingComments=[]),t.trailingComments.push(s)):(this._leadingComments??(this._leadingComments=[]),this._leadingComments.push(s))}_whitespace(){let t=this._codepoint;for(;e._isWhiteSpace(t);)10===t&&(this._trailingCommentNode=void 0),t=this._nextCodepoint()}static _isDigit(e){return e>=48&&e<=57}static _buildNonIdentifierChars(){let t=new Set;for(let s of e._terminalTokens.keys())t.add(s);return t.delete(45),t.add(e._eof),t}static _isIdentifierCharacter(t){return!e._nonIdentifierChars.has(t)}static _isWhiteSpace(e){return 32===e||10===e||13===e||9===e||11===e}};Ns._eof=0,Ns._terminalTokens=new Map([[47,e=>e._comment()],[34,e=>e._string()],[39,e=>e._string()],[45,e=>e._numberOrIdentifier()],[46,e=>e._token({nodeType:0})],[58,e=>e._token({nodeType:8})],[40,e=>e._token({nodeType:6})],[41,e=>e._token({nodeType:7})],[123,e=>e._token({nodeType:4})],[125,e=>e._token({nodeType:5})],[124,e=>e._token({nodeType:3})],[42,e=>e._token({nodeType:9})],[92,e=>e._metaCommand()],[9,e=>e._whitespace()],[10,e=>e._whitespace()],[11,e=>e._whitespace()],[13,e=>e._whitespace()],[32,e=>e._whitespace()]]),Ns._nonIdentifierChars=Ns._buildNonIdentifierChars();var Ms=Ns,Es=class{constructor(e){this._metaDataReader=Bs.instance,this.parserDiagnostics=new Et,this.lexer=new Ms(e)}get lexerDiagnostics(){return this.lexer.lexerDiagnostics}addParserDiagnostic(e){this.parserDiagnostics.push(e)}unexpectedToken(e,t,s){if(e?this.addParserDiagnostic({code:202,message:`Unexpected '${Vt[e.nodeType]}' token. Expected one of following: ${t.map(e=>Vt[e]).join(",")}`,severity:2,start:e.start,end:e.end}):this.addParserDiagnostic({code:203,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation(),severity:2,message:"Unexpected end of file."}),s)throw new Lt}read(){return this._score(),this._scoreNode}_score(){this._scoreNode={nodeType:18,bars:[],start:this.lexer.currentTokenLocation()};try{this._bars()}catch(e){if(!(e instanceof Lt))throw e}finally{this._scoreNode.end=this.lexer.previousTokenEndLocation()}}_bars(){let e=this.lexer.peekToken();for(;e;)this._bar(),e=this.lexer.peekToken()}_bar(){let e={nodeType:19,metaData:[],beats:[],pipe:void 0,start:this.lexer.currentTokenLocation()};try{this._barMetaData(e),this._barBeats(e);let t=this.lexer.peekToken();3===t?.nodeType&&(e.pipe=t,this.lexer.advance()),(e.metaData.length>0||e.beats.length>0||e.pipe)&&(e.end=this.lexer.previousTokenEndLocation(),this._scoreNode.bars.push(e))}finally{e.end=this.lexer.previousTokenEndLocation()}}_barMetaData(e){let t=this.lexer.peekToken();for(;t&&(11===t.nodeType||0===t.nodeType);)0===t.nodeType?(this.lexer.advance(),this.addParserDiagnostic({code:400,message:"The dots separating score metadata, score contents and the sync points can be removed.",severity:0,start:t.start,end:t.end})):e.metaData.push(this._metaData()),t=this.lexer.peekToken()}_barBeats(e){let t=this.lexer.peekToken();for(;t&&3!==t.nodeType&&0!==t.nodeType&&11!==t.nodeType;){let s=this._beat();s&&e.beats.push(s),t=this.lexer.peekToken()}}_beat(){let e={nodeType:20,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0,beatMultiplier:void 0,beatMultiplierValue:void 0,start:this.lexer.peekToken()?.start};try{if(e.durationChange=this._beatDurationChange(),this._beatContent(e),!e.notes&&!e.rest)return e;this._beatDuration(e),this._beatMultiplier(e),e.beatEffects=this._properties(e=>this._metaDataReader.readBeatPropertyValues(this,e)),void 0!==e.beatMultiplierValue&&e.beatEffects?.openBrace&&this.addParserDiagnostic({code:304,message:"The beat multiplier should be specified after the beat effects.",severity:1,start:e.beatMultiplier.start,end:e.beatMultiplierValue.end}),this._beatMultiplier(e)}finally{e.end=this.lexer.previousTokenEndLocation()}return e}_beatDuration(e){let t=this.lexer.peekToken();if(0!==t?.nodeType)return;e.durationDot=t,this.lexer.advance();let s=this.lexer.peekToken();if(16===s?.nodeType)return e.durationValue=s,void this.lexer.advance();11!==s?.nodeType?s&&this.unexpectedToken(s,[16],!0):e.durationDot=void 0}_beatDurationChange(){let e=this.lexer.peekToken();if(8!==e?.nodeType)return;this.lexer.advance();let t={nodeType:21,colon:e,value:void 0,properties:void 0,start:e.start};try{let s=this.lexer.peekToken();if(!s||16!==s.nodeType)return void this.addParserDiagnostic({code:201,message:"Missing duration value after ':'.",severity:2,start:e.start,end:e.end});this.lexer.advance(),t.value=s,t.properties=this._properties(e=>this._metaDataReader.readDurationChangePropertyValues(this,e))}finally{t.end=this.lexer.previousTokenEndLocation()}return t}_beatContent(e){let t=this.lexer.peekToken();if(t)if(10===t.nodeType&&"r"===t.text)e.rest=t,this.lexer.advance();else if(6===t.nodeType)e.notes=this._noteList(t);else{let s=this._note(t);s&&(e.notes={nodeType:22,openParenthesis:void 0,notes:[s],closeParenthesis:void 0,start:s.start,end:s.end})}}_beatMultiplier(e){let t=this.lexer.peekToken();if(!t||9!==t.nodeType)return;this.lexer.advance(),e.beatMultiplier=t;let s=this.lexer.peekToken();s&&16===s.nodeType?(e.beatMultiplierValue=s,this.lexer.advance()):this.addParserDiagnostic({code:200,message:"Missing beat multiplier value after '*'.",severity:2,start:e.beatMultiplier.start,end:e.beatMultiplier.end})}_noteList(e){let t={nodeType:22,openParenthesis:void 0,notes:[],closeParenthesis:void 0,start:this.lexer.currentTokenLocation()};try{t.openParenthesis=e,this.lexer.advance();let s=this.lexer.peekToken();for(;s&&7!==s.nodeType;){let e=this._note(s);if(!e)break;t.notes.push(e),s=this.lexer.peekToken()}let i=this.lexer.peekToken();7===i?.nodeType?(t.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:206,message:"Unexpected end of file. Group not closed.",severity:2,start:i?.start??this.lexer.currentTokenLocation(),end:i?.end??this.lexer.currentTokenLocation()})}finally{t.end=this.lexer.previousTokenEndLocation()}return t}_note(e){let t={nodeType:23,noteValue:{nodeType:10,text:""},start:e.start};try{let s=!1;switch(e.nodeType){case 16:t.noteValue=e,this.lexer.advance(),s=!0;break;case 17:case 10:switch(t.noteValue=e,this.lexer.advance(),t.noteValue.text){case"x":case"-":s=!0}break;default:return void this.unexpectedToken(e,[16,17,10],!0)}if(s){let e=this.lexer.peekToken();if(0===e?.nodeType){let s=e;this.lexer.advance();let i=this.lexer.peekToken();if(!i)return void this.unexpectedToken(i,[16],!0);if(11===i.nodeType)return t;if(16!==i.nodeType)return void this.unexpectedToken(i,[16],!0);t.noteStringDot=s,t.noteString=i,this.lexer.advance()}}t.noteEffects=this._properties(e=>this._metaDataReader.readNotePropertyValues(this,e))}finally{t.end=this.lexer.previousTokenEndLocation()}return t}_metaData(){let e=this.lexer.peekToken();if(!e||11!==e.nodeType)return;let t={nodeType:12,tag:e,start:e.start,properties:void 0,propertiesBeforeValues:!1};this.lexer.advance();try{4===this.lexer.peekToken()?.nodeType?(t.propertiesBeforeValues=!0,t.properties=this._properties(e=>this._metaDataReader.readMetaDataPropertyValues(this,t.tag,e)),t.values=this.valueList(),t.values||(t.values=this._metaDataReader.readMetaDataValues(this,t.tag),t.values&&t.values.values.length>1&&(this.addParserDiagnostic({code:301,message:"Metadata values should be wrapped into parenthesis.",severity:1,start:t.values?.start??t.start,end:t.values?.end??t.end}),this.addParserDiagnostic({code:302,message:"Metadata values should be placed before metadata properties.",severity:1,start:t.values?.start??t.start,end:t.values?.end??t.end})))):(t.values=this.valueList(),t.values||(t.values=this._metaDataReader.readMetaDataValues(this,t.tag),t.values&&t.values.values.length>1&&this.addParserDiagnostic({code:301,message:"Metadata values should be wrapped into parenthesis.",severity:1,start:t.values?.start??t.start,end:t.values?.end??t.end})),t.properties=this._properties(e=>this._metaDataReader.readMetaDataPropertyValues(this,t.tag,e)))}finally{t.end=this.lexer.previousTokenEndLocation()}return t}_properties(e){let t=this.lexer.peekToken();if(!t||4!==t.nodeType)return;let s={nodeType:14,openBrace:t,properties:[],closeBrace:void 0,start:t.start};this.lexer.advance();try{let t=this.lexer.peekToken();for(;10===t?.nodeType;)s.properties.push(this._property(t,e)),t=this.lexer.peekToken();let i=this.lexer.peekToken();5===i?.nodeType?(s.closeBrace=i,this.lexer.advance()):this.addParserDiagnostic({code:206,message:"Unexpected end of file. Group not closed.",severity:2,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}_property(e,t){let s={nodeType:15,property:e,values:void 0};this.lexer.advance(),s.start=s.property.start;try{s.values=this.valueList(),s.values||(s.values=t(s),s.values&&s.values.values.length>1&&this.addParserDiagnostic({code:303,message:"Property values should be wrapped into parenthesis.",severity:1,start:s.values.start,end:s.values.end}))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}valueList(){let e=this.lexer.peekToken();if(6!==e?.nodeType)return;let t={nodeType:13,openParenthesis:e,values:[],closeParenthesis:void 0,start:e.start};this.lexer.advance();try{let e=this.lexer.peekToken();for(;e&&7!==e?.nodeType;){switch(e.nodeType){case 10:case 17:t.values.push(e),this.lexer.advance();break;case 16:t.values.push(this.lexer.extendToFloat(e)),this.lexer.advance();break;default:this.unexpectedToken(e,[10,17,16],!1),this.lexer.advance()}e=this.lexer.peekToken()}let s=this.lexer.peekToken();7===s?.nodeType?(t.closeParenthesis=s,this.lexer.advance()):this.addParserDiagnostic({code:206,message:"Unexpected end of file. Group not closed.",severity:2,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{t.end=this.lexer.previousTokenEndLocation()}return t}},Ls=class{init(e,t){this.data=e,this.settings=t,Oe.resetIds()}},Cs=class extends u{constructor(e=null,t){super(1,e??"Unsupported format",t)}},Fs=class e{constructor(){this.length=0,this.position=0}get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return e.withCapacity(0)}static withCapacity(t){let s=new e;return s._buffer=new Uint8Array(t),s}static fromBuffer(t){let s=new e;return s._buffer=t,s.length=t.length,s}static fromString(t){let s=Ps.stringToBytes(t);return e.fromBuffer(s)}reset(){this.position=0}skip(e){this.position+=e}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(e,t,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(e.set(this._buffer.subarray(this.position,this.position+i),t),this.position+=i,i)}writeByte(e){let t=this.position+1;this._ensureCapacity(t),this._buffer[this.position]=255&e,t>this.length&&(this.length=t),this.position=t}write(e,t,s){let i=this.position+s;this._ensureCapacity(i);let a=Math.min(s,e.length-t);this._buffer.set(e.subarray(t,t+a),this.position),i>this.length&&(this.length=i),this.position=i}_ensureCapacity(e){if(e>this._buffer.length){let t=e;t<256&&(t=256),t<2*this._buffer.length&&(t=2*this._buffer.length);let s=new Uint8Array(t);this.length>0&&s.set(this._buffer.subarray(0,0+this.length),0),this._buffer=s}}readAll(){return this.toArray()}toArray(){let e=new Uint8Array(this.length);return e.set(this._buffer.subarray(0,0+this.length),0),e}copyTo(e){e.write(this._buffer,0,this.length)}},Ds=class e extends u{*iterateDiagnostics(){if(this.lexerDiagnostics)for(let e of this.lexerDiagnostics.items)yield e;if(this.parserDiagnostics)for(let e of this.parserDiagnostics.items)yield e;if(this.semanticDiagnostics)for(let e of this.semanticDiagnostics.items)yield e}constructor(e,t,s,i){super(2,e),this.lexerDiagnostics=t,this.parserDiagnostics=s,this.semanticDiagnostics=i}toString(){return[this.message,"lexer diagnostics:",e._diagnosticsToString(this.lexerDiagnostics,"  "),"parser diagnostics:",e._diagnosticsToString(this.parserDiagnostics,"  "),"semantic diagnostics:",e._diagnosticsToString(this.semanticDiagnostics,"  ")].join("\n")}static _diagnosticsToString(t,s){return t?t.items.map(t=>`${s}${Nt[t.severity]} AT${t.code.toString().padStart(3,"0")}${e._locationToString(t)}: ${t.message}`).join("\n"):`${s}none`}static _locationToString(e){let t="";return e.start&&(t+=`(${e.start.line},${e.start.col})`),e.end&&(t.length>0&&(t+="->"),t+=`(${e.end.line},${e.end.col})`),t}},Is=class{constructor(){this.trackChannel=0,this.barIndex=0,this.voiceIndex=0,this.ignoredInitialVoice=!1,this.ignoredInitialStaff=!1,this.ignoredInitialTrack=!1,this.currentDuration=4,this.articulationValueToIndex=new Map,this.hasAnyProperData=!1,this.percussionArticulationNames=new Map,this.slurs=new Map,this.lyrics=new Map,this.sustainPedalToBeat=new Map,this.staffTuningApplied=new Set,this.staffNoteKind=new Map,this.staffHasExplicitTuning=new Set,this.staffHasExplicitDisplayTransposition=new Set,this.staffDisplayTranspositionApplied=new Set,this.staffInitialClef=new Map,this.syncPoints=[],this.currentDynamics=5,this.accidentalMode=1,this.currentTupletNumerator=-1,this.currentTupletDenominator=-1,this.currentChordId=null}},As=class extends Ls{constructor(){super(...arguments),this._handler=ws.instance,this._state=new Is,this.logErrors=!1,this.semanticDiagnostics=new Et}get state(){return this._state}get name(){return"AlphaTex"}get lexerDiagnostics(){return this._parser.lexerDiagnostics}get parserDiagnostics(){return this._parser.parserDiagnostics}addSemanticDiagnostic(e){this.semanticDiagnostics.push(e)}initFromString(e,t){this.data=Fs.empty(),this._parser=new Es(e),this.settings=t,Oe.resetIds()}readScore(){let e;this._state=new Is,this._createDefaultScore(),this.data.length>0&&(this._parser=new Es(Ps.toString(this.data.readAll(),this.settings.importer.encoding)));try{e=this._parser.read()}catch(e){throw this.logErrors&&re.error("AlphaTex",`Error while parsing alphaTex: ${e.toString()}`),new Cs("Error parsing alphaTex, check inner error for details",e)}if(this._parser.parserDiagnostics.hasErrors||this._parser.lexer.lexerDiagnostics.hasErrors){let e=new Ds("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&re.error("AlphaTex",`Error while parsing alphaTex: ${e.toString()}`),new Cs("Error parsing alphaTex, check diagnostics on inner error for details",e)}if(0===e.bars.length)throw new Cs("No alphaTex data found");if(this._bars(e),this.semanticDiagnostics.hasErrors){if(this._state.hasAnyProperData){let e=new Ds("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&re.error("AlphaTex",`Error while parsing alphaTex: ${e.toString()}`),e}throw new Cs("No alphaTex data found")}qe.consolidate(this._state.score),this._state.score.finish(this.settings),qe.trimEmptyBarsAtEnd(this._state.score),this._state.score.rebuildRepeatGroups(),this._state.score.applyFlatSyncPoints(this._state.syncPoints);for(let[e,t]of this._state.lyrics)this._state.score.tracks[e].applyLyrics(t);for(let[e,t]of this._state.sustainPedalToBeat)if(e.ratioPosition<1){let s=t.voice.bar.masterBar.calculateDuration();e.ratioPosition=t.playbackStart/s}return this._state.score}_createDefaultScore(){this._state.score=new Oe,this._newTrack()}_newTrack(){this._state.currentTrack=new ns,this._state.currentTrack.ensureStaveCount(1),this._state.currentTrack.playbackInfo.program=25,this._state.currentTrack.playbackInfo.primaryChannel=this._state.trackChannel++,this._state.currentTrack.playbackInfo.secondaryChannel=this._state.trackChannel++;let e=this._state.currentTrack.staves[0];e.displayTranspositionPitch=0,e.stringTuning=Zt.getDefaultTuningFor(6),this._state.articulationValueToIndex.clear(),this._beginStaff(e),this._state.score.addTrack(this._state.currentTrack),this._state.lyrics.set(this._state.currentTrack.index,[]),this._state.currentDynamics=5,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1}_beginStaff(e){this._state.currentStaff&&(this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff)),this._state.currentStaff=e,this._state.currentChordId=null,this._state.slurs.clear(),this._state.barIndex=0,this._state.voiceIndex=0}_bars(e){if(e.bars.length>0)for(let t of e.bars)this._bar(t);else this._newBar(this._state.currentStaff),this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff)}_bar(e){this._state.currentChordId=null;let t=this._barMeta(e);this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff),0===t.index&&this._state.staffInitialClef.has(this._state.currentStaff)&&(t.clef=this._state.staffInitialClef.get(this._state.currentStaff));let s=t.voices[this._state.voiceIndex];for(let t of e.beats)this._beat(s,t);if(0===s.beats.length){let e=new wt;e.isEmpty=!0,s.addBeat(e)}}_beat(e,t){if(t.durationChange&&this._beatDuration(t.durationChange),!t.notes&&!t.rest)return;let s=new wt;if(e.addBeat(s),t.notes)for(let e of t.notes.notes)this._note(s,e);else t.rest;t.durationValue&&(this._state.currentDuration=this._parseDuration(t.durationValue)),s.duration=this._state.currentDuration,s.dynamics=this._state.currentDynamics,-1!==this._state.currentTupletNumerator&&!s.hasTuplet&&(s.tupletNumerator=this._state.currentTupletNumerator,s.tupletDenominator=this._state.currentTupletDenominator);let i=1;void 0!==t.beatMultiplierValue&&(i=t.beatMultiplierValue.value),t.beatEffects&&this._beatEffects(s,t.beatEffects),!s.chordId&&this._state.currentChordId&&ws.applyChordToBeat(s,this._state.currentChordId,!1);for(let t=0;t<i-1;t++)e.addBeat(Pt.clone(s))}_beatEffects(e,t){for(let s of t.properties)switch(this._handler.applyBeatProperty(this,e,s)){case 0:case 1:this._state.hasAnyProperData=!0;break;case 2:let e=Array.from(this._handler.knownBeatProperties).join(",");this.addSemanticDiagnostic({code:212,message:`Unrecogized property '${s.property.text}', expected one of ${e}`,severity:2,start:s.start,end:s.end})}}_beatDuration(e){if(e.value&&(this._state.currentDuration=this._parseDuration(e.value)),this._state.currentTupletNumerator=-1,this._state.currentTupletDenominator=-1,e.properties)for(let t of e.properties.properties)switch(this._handler.applyBeatDurationProperty(this,t)){case 0:case 1:this._state.hasAnyProperData=!0;break;case 2:let e=Array.from(this._handler.knownBeatDurationProperties).join(",");this.addSemanticDiagnostic({code:212,message:`Unrecogized property '${t.property.text}', expected one of ${e}`,severity:2,start:t.start,end:t.end})}}_parseDuration(e){switch(e.value){case-4:return-4;case-2:return-2;case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:return 256;default:return this.addSemanticDiagnostic({code:209,message:`Unexpected duration value '${e.value}', expected: -4, -2, 1, 2, 4, 8, 16, 32, 64, 128 or 256`,severity:2,start:e.start,end:e.end}),this._state.currentDuration}}_note(e,t){let s,i=!1,a=!1,r=-1,n=-1,o=-1,l=0,h=t.noteValue,d=this._state.staffNoteKind.has(this._state.currentStaff)?this._state.staffNoteKind.get(this._state.currentStaff):void 0;switch(h.nodeType){case 16:r=h.value,s=void 0!==t.noteString?1:2;break;case 17:case 10:let e=h.text;if(i="x"===e,a="-"===e,a||i)r=0,s=void 0;else{let t=qe.parseTuning(e);if(t)s=0,n=t.octave,o=t.tone.noteValue,1===this._state.accidentalMode&&(l=t.tone.accidentalMode);else{s=2;let t=e.toLowerCase(),i=this._state.percussionArticulationNames;if(void 0===d&&0===i.size)for(let[e,t]of et.instrumentArticulationNames)i.set(e.toLowerCase(),t),i.set(qe.toArticulationId(e),t);if(!i.has(t))return this.addSemanticDiagnostic({code:209,message:`Unexpected percussion articulation value '${t}', expected: oneOf(${Array.from(this._state.percussionArticulationNames.keys()).join(",")}).`,severity:2,start:h.start,end:h.end}),void(r=Array.from(et.instrumentArticulationNames.values())[0]);r=i.get(t)}}}void 0!==s?void 0===d?(d=s,this.applyStaffNoteKind(this._state.currentStaff,d)):d!==s&&this.addSemanticDiagnostic({code:218,message:`Wrong note kind '${Ft[s]}' for staff with note kind ''${Ft[d]}'. Do not mix incompatible staves and notes.`,severity:2}):void 0!==d&&(s=d);let c=new nt;if(c.isDead=i,(i||a)&&(c.fret=r),c.isTieDestination=a,void 0!==s&&s===d)switch(s){case 0:c.octave=n,c.tone=o,c.accidentalMode=l;break;case 1:if(!t.noteString)return void this.addSemanticDiagnostic({code:207,message:"Missing string for fretted note.",severity:2,start:h.end,end:h.end});let e=t.noteString.value;if(e<1||e>this._state.currentStaff.tuning.length)return void this.addSemanticDiagnostic({code:208,message:`Note string is out of range. Available range: 1-${this._state.currentStaff.tuning.length}`,severity:2,start:h.end,end:h.end});c.string=this._state.currentStaff.tuning.length-(e-1),a||(c.fret=r);break;case 2:let s=0;if(this._state.articulationValueToIndex.has(r))s=this._state.articulationValueToIndex.get(r);else{s=this._state.currentTrack.percussionArticulations.length;let e=et.getArticulationByInputMidiNumber(r);if(null===e)return void this.addSemanticDiagnostic({code:209,message:`Unexpected articulation value '${r}', expected: oneOf(${Array.from(et.instrumentArticulations.keys()).join(",")}).`,severity:2,start:h.end,end:h.end});this._state.currentTrack.percussionArticulations.push(e),this._state.articulationValueToIndex.set(r,s)}c.percussionArticulation=s}e.addNote(c),this._state.hasAnyProperData=!0,t.noteEffects&&this._noteEffects(c,t.noteEffects)}getStaffNoteKind(e){return this._state.staffNoteKind.has(e)?this._state.staffNoteKind.get(e):void 0}applyStaffNoteKind(e,t){switch(this._state.staffNoteKind.set(e,t),t){case 0:e.isPercussion=!1,e.stringTuning.reset(),this._state.staffHasExplicitDisplayTransposition.has(e)||(e.displayTranspositionPitch=0);break;case 1:e.isPercussion=!1,this._detectTuningForStaff(e),this._handleTransposition(e);break;case 2:e.isPercussion=!0,e.stringTuning.reset(),this._state.staffHasExplicitDisplayTransposition.has(e)||(e.displayTranspositionPitch=0)}}_noteEffects(e,t){for(let s of t.properties){let t=this._handler.applyNoteProperty(this,e,s);switch(2===t&&(t=this._handler.applyBeatProperty(this,e.beat,s)),t){case 0:case 1:break;case 2:let e=Array.from(this._handler.knownNoteProperties).concat(Array.from(this._handler.knownBeatProperties)).join(",");this.addSemanticDiagnostic({code:212,message:`Unrecogized property '${s.property.text}', expected one of ${e}`,severity:2,start:s.start,end:s.end})}}}_handleTransposition(e){if(!this._state.staffDisplayTranspositionApplied.has(e)&&!this._state.staffHasExplicitDisplayTransposition.has(e)){let t=e.track.playbackInfo.program;qe.displayTranspositionPitches.has(t)?e.displayTranspositionPitch=qe.displayTranspositionPitches.get(t):this._state.currentStaff.displayTranspositionPitch=0,this._state.staffDisplayTranspositionApplied.add(e)}}_detectTuningForStaff(e){let t=e.track.playbackInfo.program;!this._state.staffTuningApplied.has(e)&&!this._state.staffHasExplicitTuning.has(e)&&(e.stringTuning.reset(),15===t||t>=24&&t<=31?e.stringTuning.tunings=Zt.getDefaultTuningFor(6).tunings:t>=32&&t<=39?(e.stringTuning.tunings=[43,38,33,28],this._state.staffInitialClef.set(e,3)):40===t||44===t||45===t||48===t||49===t||50===t||51===t?e.stringTuning.tunings=[52,57,50,43]:41===t?e.stringTuning.tunings=[57,50,43,36]:42===t?e.stringTuning.tunings=[45,38,31,24]:43===t?e.stringTuning.tunings=[43,38,33,28]:105===t?e.stringTuning.tunings=[50,47,43,38,55]:106===t?e.stringTuning.tunings=[57,52,45]:107===t?e.stringTuning.tunings=[52,45,38,31]:110===t?e.stringTuning.tunings=[64,57,50,43]:this._state.staffNoteKind.has(e)&&1===this._state.staffNoteKind.get(e)&&(e.stringTuning=Zt.getDefaultTuningFor(6)),this._state.staffTuningApplied.add(e))}_barMeta(e){let t=this._state.score.masterBars.length>0?void 0:[],s=this._state.currentStaff,i=!1,a=!1,r=!1,n=()=>{t&&(t=void 0,s=this._state.currentStaff,i=!1,a=!1,r=!1)},o=new K(()=>{let e=this._newBar(this._state.currentStaff);if(t){for(let s of t)this._handler.applyBarMetaData(this,e,s);n()}return e});for(let l of e.metaData){let e=l.tag.tag.text.toLowerCase();if(this._handler.knownStructuralMetaDataTags.has(e)){switch(this._state.hasAnyProperData=!0,this._handler.applyStructuralMetaData(this,l)){case 0:a||i?r=!0:(i=!0,s=this._state.currentStaff),o.reset();break;case 1:a?r=!0:(a=!0,s=this._state.currentStaff),o.reset()}if(t&&r){if(0!==s.bars.length)throw new u(2,"Unexpected internal error, didn't expect a filled staff after multiple \\track and/or \\staff tags. Please report this problem providing the input alphaTex.");{let e=new Be;s.addBar(e);let i=new Me;if(e.addVoice(i),s.bars.length>this._state.score.masterBars.length){let e=new We;this._state.score.addMasterBar(e)}for(let s of t)this._handler.applyBarMetaData(this,e,s);n()}}}else if(this._handler.knownScoreMetaDataTags.has(l.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,this._handler.applyScoreMetaData(this,this._state.score,l);else if(this._handler.knownStaffMetaDataTags.has(l.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,this._handler.applyStaffMetaData(this,this._state.currentStaff,l),this.addSemanticDiagnostic({code:306,message:"This staff metadata tag should be specified as staff property.",severity:1,start:l.start,end:l.end});else if(this._handler.knownBarMetaDataTags.has(l.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,t?t.push(l):this._handler.applyBarMetaData(this,o.value,l);else{let e=Array.from(this._handler.allKnownMetaDataTags).join(",");this.addSemanticDiagnostic({code:204,message:`Unrecognized metadata '${l.tag.tag.text}', expected one of: ${e}`,severity:2,start:l.tag.start,end:l.tag.end})}}return o.value}_newBar(e){if(this._state.barIndex<e.bars.length){let t=e.bars[this._state.barIndex];return this._state.barIndex++,t}let t=0===e.bars.length?1:e.bars[0].voices.length,s=new Be;e.addBar(s),s.previousBar&&(s.clef=s.previousBar.clef,s.clefOttava=s.previousBar.clefOttava,s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType),this._state.barIndex++,s.index>0&&(s.clef=s.previousBar.clef);for(let e=0;e<t;e++){let e=new Me;s.addVoice(e)}if(this._state.currentStaff.bars.length>this._state.score.masterBars.length){let e=new We;this._state.score.addMasterBar(e),e.index>0&&(e.timeSignatureDenominator=e.previousMasterBar.timeSignatureDenominator,e.timeSignatureNumerator=e.previousMasterBar.timeSignatureNumerator,e.tripletFeel=e.previousMasterBar.tripletFeel)}return s}startNewStaff(){if(this._state.ignoredInitialVoice=!1,this._state.ignoredInitialStaff||this._state.currentTrack.staves[0].bars.length>0){let e=this._state.currentStaff.isPercussion;this._state.currentTrack.ensureStaveCount(this._state.currentTrack.staves.length+1);let t=this._state.currentTrack.staves[this._state.currentTrack.staves.length-1];this._beginStaff(t),e&&this.applyPercussionStaff(this._state.currentStaff),this._state.currentDynamics=5}else this._state.ignoredInitialStaff=!0;return this._state.currentStaff}applyPercussionStaff(e){e.isPercussion=!0,e.showTablature=!1,e.track.playbackInfo.program=0}startNewTrack(){return this._state.ignoredInitialVoice=!1,this._state.ignoredInitialStaff=!1,this._state.ignoredInitialTrack||this._state.score.masterBars.length>0?this._newTrack():this._state.ignoredInitialTrack=!0,this._state.currentTrack}startNewVoice(){if(0!==this._state.voiceIndex||0!==this._state.currentStaff.bars.length&&(1!==this._state.currentStaff.bars.length||!this._state.currentStaff.bars[0].isEmpty||this._state.ignoredInitialVoice)){for(let e of this._state.currentStaff.bars){let t=new Me;e.addVoice(t)}this._state.voiceIndex++,this._state.barIndex=0,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1}else this._state.ignoredInitialVoice=!0}},Rs=class{},Os=class extends Rs{constructor(e){super(),this.n=e}},Vs=class extends Rs{constructor(e,t){super(),this.left=e,this.right=t}},Ws=class extends Rs{constructor(e,t){super(),this.n=e,this.table=t}},Hs=class e{static make(t,s,i,a){let r=[],n=[];if(a>32)throw new Xt("Invalid huffman");for(let e=0;e<a;e++)r.push(0),n.push(0);for(let e=0;e<i;e++){let i=t[e+s];if(i>=a)throw new Xt("Invalid huffman");r[i]++}let o=0;for(let e=1;e<a-1;e++)o=o+r[e]<<1,n[e]=o;let l=new Map;for(let e=0;e<i;e++){let i=t[e+s];if(0!==i){let t=n[i-1];n[i-1]=t+1,l.set(t<<5|i,e)}}return e._treeCompress(new Vs(e._treeMake(l,a,0,1),e._treeMake(l,a,1,1)))}static _treeMake(t,s,i,a){if(a>s)throw new Xt("Invalid huffman");let r=i<<5|a;return t.has(r)?new Os(t.get(r)):(i<<=1,a+=1,new Vs(e._treeMake(t,s,i,a),e._treeMake(t,s,1|i,a)))}static _treeCompress(t){let s=e._treeDepth(t);if(0===s)return t;if(1===s){if(t instanceof Vs)return new Vs(e._treeCompress(t.left),e._treeCompress(t.right));throw new Xt("assert")}let i=1<<s,a=[];for(let e=0;e<i;e++)a.push(new Os(-1));return e._treeWalk(a,0,0,s,t),new Ws(s,a)}static _treeWalk(t,s,i,a,r){r instanceof Vs&&a>0?(e._treeWalk(t,s,i+1,a-1,r.left),e._treeWalk(t,s|1<<i,i+1,a-1,r.right)):t[s]=e._treeCompress(r)}static _treeDepth(t){if(t instanceof Os)return 0;if(t instanceof Ws)throw new Xt("assert");if(t instanceof Vs){let s=e._treeDepth(t.left),i=e._treeDepth(t.right);return 1+(s<i?s:i)}return 0}},Gs=class e{constructor(){this.buffer=new Uint8Array(e._bufferSize),this.pos=0}slide(){let t=new Uint8Array(e._bufferSize);this.pos-=e._size,t.set(this.buffer.subarray(e._size,e._size+this.pos),0),this.buffer=t}addBytes(t,s,i){this.pos+i>e._bufferSize&&this.slide(),this.buffer.set(t.subarray(s,s+i),this.pos),this.pos+=i}addByte(t){this.pos===e._bufferSize&&this.slide(),this.buffer[this.pos]=t,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}};Gs._size=32768,Gs._bufferSize=65536;var zs=Gs,Us=class e{constructor(t){this._nbits=0,this._bits=0,this._state=1,this._isFinal=!1,this._huffman=e._fixedHuffman,this._huffdist=null,this._len=0,this._dist=0,this._needed=0,this._output=null,this._outpos=0,this._lengths=[],this._window=new zs,this._input=t;for(let e=0;e<19;e++)this._lengths.push(-1)}static _buildFixedHuffman(){let e=[];for(let t=0;t<288;t++)e.push(t<=143?8:t<=255?9:t<=279?7:8);return Hs.make(e,0,288,10)}readBytes(e,t,s){if(this._needed=s,this._outpos=t,this._output=e,s>0)for(;this._inflateLoop(););return s-this._needed}_inflateLoop(){switch(this._state){case 0:let t=this._input.readByte();if(8!=(15&t))throw new Xt("Invalid data");let s=this._input.readByte(),i=!!(32&s);if(((t<<8)+s)%31!=0)throw new Xt("Invalid data");if(i)throw new Xt("Unsupported dictionary");return this._state=1,!0;case 4:return this._state=7,!0;case 7:return!1;case 1:switch(this._isFinal=this._getBit(),this._getBits(2)){case 0:if(this._len=Ps.readUInt16LE(this._input),Ps.readUInt16LE(this._input)!==65535-this._len)throw new Xt("Invalid data");this._state=3;let t=this._inflateLoop();return this._resetBits(),t;case 1:return this._huffman=e._fixedHuffman,this._huffdist=null,this._state=2,!0;case 2:let s=this._getBits(5)+257,i=this._getBits(5)+1,a=this._getBits(4)+4;for(let t=0;t<a;t++)this._lengths[e._codeLengthsPos[t]]=this._getBits(3);for(let t=a;t<19;t++)this._lengths[e._codeLengthsPos[t]]=0;this._huffman=Hs.make(this._lengths,0,19,8);let r=[];for(let e=0;e<s+i;e++)r.push(0);return this._inflateLengths(r,s+i),this._huffdist=Hs.make(r,s,i,16),this._huffman=Hs.make(r,0,s,16),this._state=2,!0;default:throw new Xt("Invalid data")}case 3:{let e=this._len<this._needed?this._len:this._needed,t=Ps.readByteArray(this._input,e);return this._len-=e,this._addBytes(t,0,e),0===this._len&&(this._state=this._isFinal?4:1),this._needed>0}case 6:{let e=this._len<this._needed?this._len:this._needed;return this._addDistOne(e),this._len-=e,0===this._len&&(this._state=2),this._needed>0}case 5:for(;this._len>0&&this._needed>0;){let e=this._len<this._dist?this._len:this._dist,t=this._needed<e?this._needed:e;this._addDist(this._dist,t),this._len-=t}return 0===this._len&&(this._state=2),this._needed>0;case 2:let a=this._applyHuffman(this._huffman);if(a<256)return this._addByte(a),this._needed>0;if(256===a)return this._state=this._isFinal?4:1,!0;a=a-257&255;let r=e._lenExtraBitsTbl[a];if(-1===r)throw new Xt("Invalid data");this._len=e._lenBaseValTbl[a]+this._getBits(r);let n=this._huffdist,o=n?this._applyHuffman(n):this._getRevBits(5);if(r=e._distExtraBitsTbl[o],-1===r)throw new Xt("Invalid data");if(this._dist=e._distBaseValTbl[o]+this._getBits(r),this._dist>this._window.available())throw new Xt("Invalid data");return this._state=1===this._dist?6:5,!0}return!1}_addDistOne(e){let t=this._window.getLastChar();for(let s=0;s<e;s++)this._addByte(t)}_addByte(e){this._window.addByte(e),this._output[this._outpos]=e,this._needed--,this._outpos++}_addDist(e,t){this._addBytes(this._window.buffer,this._window.pos-e,t)}_getBit(){0===this._nbits&&(this._nbits=8,this._bits=this._input.readByte());let e=!(1&~this._bits);return this._nbits--,this._bits=this._bits>>1,e}_getBits(e){for(;this._nbits<e;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;let t=this._bits&(1<<e)-1;return this._nbits-=e,this._bits=this._bits>>e,t}_getRevBits(e){return 0===e?0:this._getBit()?1<<e-1|this._getRevBits(e-1):this._getRevBits(e-1)}_resetBits(){this._bits=0,this._nbits=0}_addBytes(e,t,s){this._window.addBytes(e,t,s),this._output.set(e.subarray(t,t+s),this._outpos),this._needed-=s,this._outpos+=s}_inflateLengths(e,t){let s=0,i=0;for(;s<t;){let a=this._applyHuffman(this._huffman);switch(a){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=a,e[s]=a,s++;break;case 16:let r=s+3+this._getBits(2);if(r>t)throw new Xt("Invalid data");for(;s<r;)e[s]=i,s++;break;case 17:if(s+=3+this._getBits(3),s>t)throw new Xt("Invalid data");break;case 18:if(s+=11+this._getBits(7),s>t)throw new Xt("Invalid data");break;default:throw new Xt("Invalid data")}}}_applyHuffman(e){if(e instanceof Os)return e.n;if(e instanceof Vs)return this._applyHuffman(this._getBit()?e.right:e.left);if(e instanceof Ws)return this._applyHuffman(e.table[this._getBits(e.n)]);throw new Xt("Invalid data")}};Us._lenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1],Us._lenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],Us._distExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1],Us._distBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],Us._codeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Us._fixedHuffman=Us._buildFixedHuffman();var Ys=Us,Xs=class{constructor(e,t){this.fullName=e;let s=e.lastIndexOf("/");this.fileName=-1===s||s===e.length-1?this.fullName:e.substr(s+1),this.data=t}};Xs.OptionalDataDescriptorSignature=134695760,Xs.CompressionMethodDeflate=8,Xs.LocalFileHeaderSignature=67324752,Xs.CentralFileHeaderSignature=33639248,Xs.EndOfCentralDirSignature=101010256;var $s=class{constructor(e){this._readable=e}read(){let e=[];for(;;){let t=this._readEntry();if(!t)break;e.push(t)}return e}_readEntry(){let e=this._readable;if(Ps.readInt32LE(e)!==Xs.LocalFileHeaderSignature)return null;Ps.readUInt16LE(e);let t=Ps.readUInt16LE(e),s=Ps.readUInt16LE(e),i=0!==s;if(i&&s!==Xs.CompressionMethodDeflate)return null;Ps.readInt16LE(this._readable),Ps.readInt16LE(this._readable),Ps.readInt32LE(e),Ps.readInt32LE(e);let a,r=Ps.readInt32LE(e),n=Ps.readInt16LE(e),o=Ps.readInt16LE(e),l=Ps.toString(Ps.readByteArray(e,n),"utf-8");if(e.skip(o),i){let e=Fs.empty(),t=new Ys(this._readable),s=new Uint8Array(65536);for(;;){let i=t.readBytes(s,0,s.length);if(e.write(s,0,i),i<s.length)break}a=e.toArray()}else a=Ps.readByteArray(this._readable,r);return!!(8&t)&&(Ps.readInt32LE(this._readable)===Xs.OptionalDataDescriptorSignature&&Ps.readInt32LE(this._readable),Ps.readInt32LE(this._readable),Ps.readInt32LE(this._readable)),new Xs(l,a)}},Js=class e{constructor(){this.nodeType=0,this.localName=null,this.value=null,this.childNodes=[],this.attributes=new Map,this.firstChild=null,this.firstElement=null}*childElements(){for(let e of this.childNodes)1===e.nodeType&&(yield e)}addChild(e){this.childNodes.push(e),this.firstChild=e,(1===e.nodeType||3===e.nodeType)&&(this.firstElement=e)}getAttribute(e,t=""){return this.attributes.has(e)?this.attributes.get(e):t}getElementsByTagName(e,t=!1){let s=[];return this._searchElementsByTagName(this.childNodes,s,e,t),s}_searchElementsByTagName(e,t,s,i=!1){for(let a of e)a&&1===a.nodeType&&a.localName===s&&t.push(a),i&&this._searchElementsByTagName(a.childNodes,t,s,!0)}findChildElement(e){for(let t of this.childNodes)if(t&&1===t.nodeType&&t.localName===e)return t;return null}addElement(t){let s=new e;return s.nodeType=1,s.localName=t,this.addChild(s),s}get innerText(){if(1===this.nodeType||4===this.nodeType){if(this.firstElement&&3===this.firstElement.nodeType)return this.firstElement.innerText;let e="";for(let t of this.childNodes)e+=t.innerText?.toString();return e.trim()}return this.value??""}set innerText(t){let s=new e;s.nodeType=2,s.value=t,this.childNodes=[s]}setCData(t){let s=new e;s.nodeType=3,s.value=t,this.childNodes=[s]}},qs=class extends u{constructor(e,t,s){super(1,e),this.pos=0,this.xml=t,this.pos=s}},js=class e{static parse(t,s,i){let a=t.charCodeAt(s),r=1,n=1,o=0,l="",h=1,d=null,c=null,u=0,p=0;for(;s<t.length;){switch(a=t.charCodeAt(s),r){case 0:switch(a){case e.CharCodeLF:case e.CharCodeCR:case e.CharCodeTab:case e.CharCodeSpace:break;default:r=n;continue}break;case 1:if(a!==e.CharCodeLowerThan){o=s,r=13;continue}r=0,n=2;break;case 13:if(a===e.CharCodeLowerThan){l+=t.substr(o,s-o);let e=new Js;e.nodeType=2,e.value=l,l="",i.addChild(e),r=0,n=2}else a===e.CharCodeAmp&&(l+=t.substr(o,s-o),r=18,h=13,o=s+1);break;case 17:if(a===e.CharCodeBrackedClose&&t.charCodeAt(s+1)===e.CharCodeBrackedClose&&t.charCodeAt(s+2)===e.CharCodeGreaterThan){let e=new Js;e.nodeType=3,e.value=t.substr(o,s-o),i.addChild(e),s+=2,r=1}break;case 2:switch(a){case e.CharCodeExclamation:if(t.charCodeAt(s+1)===e.CharCodeBrackedOpen){if(s+=2,"CDATA["!==t.substr(s,6).toUpperCase())throw new qs("Expected <![CDATA[",t,s);r=17,o=(s+=5)+1}else if(t.charCodeAt(s+1)===e.CharCodeUpperD||t.charCodeAt(s+1)===e.CharCodeLowerD){if("OCTYPE"!==t.substr(s+2,6).toUpperCase())throw new qs("Expected <!DOCTYPE",t,s);r=16,o=(s+=8)+1}else{if(t.charCodeAt(s+1)!==e.CharCodeMinus||t.charCodeAt(s+2)!==e.CharCodeMinus)throw new qs("Expected \x3c!--",t,s);r=15,o=(s+=2)+1}break;case e.CharCodeQuestion:r=14,o=s;break;case e.CharCodeSlash:if(!i)throw new qs("Expected node name",t,s);o=s+1,r=0,n=10;break;default:r=3,o=s;continue}break;case 3:if(!e._isValidChar(a)){if(s===o)throw new qs("Expected node name",t,s);d=new Js,d.nodeType=1,d.localName=t.substr(o,s-o),i.addChild(d),r=0,n=4;continue}break;case 4:switch(a){case e.CharCodeSlash:r=11;break;case e.CharCodeGreaterThan:r=9;break;default:r=5,o=s;continue}break;case 5:if(!e._isValidChar(a)){if(o===s)throw new qs("Expected attribute name",t,s);if(c=t.substr(o,s-o),d.attributes.has(c))throw new qs(`Duplicate attribute [${c}]`,t,s);r=0,n=6;continue}break;case 6:if(a!==e.CharCodeEquals)throw new qs("Expected =",t,s);r=0,n=7;break;case 7:switch(a){case e.CharCodeDoubleQuote:case e.CharCodeSingleQuote:l="",r=8,o=s+1,p=a}break;case 8:if(a===e.CharCodeAmp)l+=t.substr(o,s-o),r=18,h=8,o=s+1;else if(a===p){l+=t.substr(o,s-o);let e=l;l="",d.attributes.set(c,e),r=0,n=4}break;case 9:o=s=e.parse(t,s,d),r=1;break;case 11:if(a!==e.CharCodeGreaterThan)throw new qs("Expected >",t,s);r=1;break;case 12:if(a===e.CharCodeGreaterThan)return s;throw new qs("Expected >",t,s);case 10:if(!e._isValidChar(a)){if(o===s)throw new qs("Expected node name",t,s);if(t.substr(o,s-o)!==i.localName)throw new qs(`Expected </${i.localName}>`,t,s);r=0,n=12;continue}break;case 15:a===e.CharCodeMinus&&t.charCodeAt(s+1)===e.CharCodeMinus&&t.charCodeAt(s+2)===e.CharCodeGreaterThan&&(s+=2,r=1);break;case 16:if(a===e.CharCodeBrackedOpen)u++;else if(a===e.CharCodeBrackedClose)u--;else if(a===e.CharCodeGreaterThan&&0===u){let e=new Js;e.nodeType=5,e.value=t.substr(o,s-o),i.addChild(e),r=1}break;case 14:a===e.CharCodeQuestion&&t.charCodeAt(s+1)===e.CharCodeGreaterThan&&(s++,r=1);break;case 18:if(a===e.CharCodeSemi){let i=t.substr(o,s-o);if(i.charCodeAt(0)===e.CharCodeSharp){let t=i.charCodeAt(1)===e.CharCodeLowerX?Number.parseInt(`0${i.substr(1,i.length-1)}`,10):Number.parseInt(i.substr(1,i.length-1),10);l+=String.fromCharCode(t)}else e._escapes.has(i)?l+=e._escapes.get(i):l+=`&${i};`?.toString();o=s+1,r=h}else!e._isValidChar(a)&&a!==e.CharCodeSharp&&(l+="&",l+=t.substr(o,s-o),o=--s+1,r=h)}s++}if(1===r&&(o=s,r=13),13===r){if(s!==o){l+=t.substr(o,s-o);let e=new Js;e.nodeType=2,e.value=l,i.addChild(e)}return s}if(18===r&&13===h){l+="&",l+=t.substr(o,s-o);let e=new Js;return e.nodeType=2,e.value=l,i.addChild(e),s}throw new qs("Unexpected end",t,s)}static _isValidChar(t){return t>=e.CharCodeLowerA&&t<=e.CharCodeLowerZ||t>=e.CharCodeUpperA&&t<=e.CharCodeUpperZ||t>=e.CharCode0&&t<=e.CharCode9||t===e.CharCodeColon||t===e.CharCodeDot||t===e.CharCodeUnderscore||t===e.CharCodeMinus}};js.CharCodeLF=10,js.CharCodeTab=9,js.CharCodeCR=13,js.CharCodeSpace=32,js.CharCodeLowerThan=60,js.CharCodeAmp=38,js.CharCodeBrackedClose=93,js.CharCodeBrackedOpen=91,js.CharCodeGreaterThan=62,js.CharCodeExclamation=33,js.CharCodeUpperD=68,js.CharCodeLowerD=100,js.CharCodeMinus=45,js.CharCodeQuestion=63,js.CharCodeSlash=47,js.CharCodeEquals=61,js.CharCodeDoubleQuote=34,js.CharCodeSingleQuote=39,js.CharCodeSharp=35,js.CharCodeLowerX=120,js.CharCodeLowerA=97,js.CharCodeLowerZ=122,js.CharCodeUpperA=65,js.CharCodeUpperZ=90,js.CharCode0=48,js.CharCode9=57,js.CharCodeColon=58,js.CharCodeDot=46,js.CharCodeUnderscore=95,js.CharCodeSemi=59,js._escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);var Ks=js,Qs=class e{constructor(e,t){this._result=[],this._indention=e,this._xmlHeader=t,this._currentIndention="",this._isStartOfLine=!0}writeNode(e){switch(e.nodeType){case 0:break;case 1:this._result.length>0&&this._writeLine(),this._write(`<${e.localName}`);for(let[t,s]of e.attributes)this._write(` ${t}="`),this._writeAttributeValue(s),this._write('"');if(0===e.childNodes.length)this._write("/>");else{if(this._write(">"),1!==e.childNodes.length||e.firstElement){this._indent();for(let t of e.childNodes)(1===t.nodeType||6===t.nodeType)&&this.writeNode(t);this._unindend(),this._writeLine()}else this.writeNode(e.childNodes[0]);this._write(`</${e.localName}>`)}break;case 2:e.value&&this._write(e.value);break;case 3:null!==e.value&&this._write(`<![CDATA[${e.value}]]>`);break;case 4:this._xmlHeader&&this._write('<?xml version="1.0" encoding="utf-8"?>');for(let t of e.childNodes)this.writeNode(t);break;case 5:this._write(`<!DOCTYPE ${e.value}>`);break;case 6:this._write(`\x3c!-- ${e.value} --\x3e`)}}_unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}_indent(){this._currentIndention+=this._indention}_writeAttributeValue(e){for(let t=0;t<e.length;t++){let s=e.charAt(t);switch(s){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(s)}}}static write(t,s,i){let a=new e(s,i);return a.writeNode(t),a.toString()}_write(e){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(e),this._isStartOfLine=!1}_writeLine(e=null){e&&this._write(e),this._indention.length>0&&!this._isStartOfLine&&(this._result.push("\n"),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}},Zs=class extends Js{constructor(){super(),this.nodeType=4}parse(e){Ks.parse(e,0,this)}toString(){return this.toFormattedString()}toFormattedString(e="",t=!1){return Qs.write(this,e,t)}},ei=class{constructor(){this.noteRange=1,this.x=0,this.y=0}},ti=class extends ei{constructor(){super(...arguments),this.align=0,this.frame=0,this.text="",this.fontFace="",this.weight=0,this.height=0}},si=class extends ei{constructor(){super(...arguments),this.chord=new Yt}},ii=class extends ei{},ai=class extends ei{},ri=class extends ei{constructor(){super(...arguments),this.number=0}},ni=class extends ei{constructor(){super(...arguments),this.decrescendo=!1}},oi=class extends ei{constructor(){super(...arguments),this.allNumbers=!1,this.firstNumber=0,this.lastNumber=0}},li=class extends ei{constructor(){super(...arguments),this.octave=1}},hi=class extends ei{},di=class{constructor(){this.defaultClef=4,this.description="",this.percussion=!1,this.instrument=0,this.volume=0,this.transpose=0,this.index=0}},ci=class{constructor(){this.from=0,this.to=0,this.curly=!1}},ui=class{constructor(){this.currentBarIndex=-1,this.currentBarComplete=!0,this.currentBarDuration=0,this.currentPosition=0,this.voiceStemDir=null,this.repeatCount=0,this.repeatEnd=null}},pi=class e{constructor(){this._trackChannel=0,this._beamingMode=0,this._isFirstSystem=!0,this._initialTempo=-1,this._staffLookup=new Map,this._brackets=[],this._staffLayoutLookup=new Map,this._staffLayouts=[],this._timeSignature=new We,this._voiceStates=new Map}parseXml(e,t){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;let s=new Zs;try{s.parse(e)}catch(e){throw new Cs("Could not parse XML",e)}this._parseDom(s),this._consolidate(),this.score.finish(t)}_consolidate(){qe.consolidate(this.score),e._applyEffectRange(this._slurs,(e,t)=>{t.isLegatoOrigin=!0}),e._applyEffectRange(this._crescendo,(e,t)=>{t.crescendo=e.decrescendo?2:1})}static _applyEffectRange(e,t){for(let[s,i]of e){let e=i.noteRange,a=s;for(let s=0;s<e;s++)if(t(i,a),a.index+1<a.voice.beats.length)a=a.voice.beats[a.index+1];else{if(!(a.voice.bar.index+1<a.voice.bar.staff.bars.length))break;a=a.voice.bar.staff.bars[a.voice.bar.index+1].voices[a.voice.index].beats[0]}}}_parseDom(e){let t=e.firstElement;if(!t)throw new Cs("No valid XML");if("score"!==t.localName)throw new Cs('Root node of XML was not "score"');this.score=new Oe;for(let e of t.childElements())switch(e.localName){case"info":this._parseInfo(e);break;case"layout":this._parseLayout(e);break;case"gallery":this._parseGallery(e);break;case"pageObjects":this._parsePageObjects(e);break;case"systems":this._parseSystems(e)}}_parseLayout(e){for(let t of e.childElements())switch(t.localName){case"staves":this._parseLayoutStaves(t);break;case"brackets":this._parseBrackets(t)}let t=this._brackets.filter(e=>!!e.curly);t.sort((e,t)=>e.from-t.from);let s=0,i=null;for(let e=0;e<this._staffLayouts.length;e++){let a=this._staffLayouts[e];for(;s<t.length&&e>t[s].to;)s++;i&&s<t.length&&e>t[s].from&&e<=t[s].to?i.ensureStaveCount(i.staves.length+1):(i=new ns,i.ensureStaveCount(1),i.name=a.description,i.playbackInfo.volume=Math.floor(a.volume/128*16),i.playbackInfo.program=a.instrument,a.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this._trackChannel++,i.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(i));let r=i.staves[i.staves.length-1];r.isPercussion=a.percussion,r.transpositionPitch=a.transpose,r.displayTranspositionPitch=0,r.showTablature=!1,this._staffLookup.set(a.index,r)}}_parseBrackets(e){for(let t of e.childElements())"bracket"===t.localName&&this._parseBracket(t)}_parseBracket(e){let t=new ci;t.from=Number.parseInt(e.getAttribute("from"),10),t.to=Number.parseInt(e.getAttribute("to"),10),e.attributes.has("curly")&&(t.curly="true"===e.attributes.get("curly")),this._brackets.push(t)}_parseLayoutStaves(e){for(let t of e.childElements())"staffLayout"===t.localName&&this._parseStaffLayout(t)}_parseStaffLayout(e){let t=new di;t.description=e.getAttribute("description");for(let s of e.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(t.defaultClef=this._parseClef(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(t.percussion="true"===s.attributes.get("percussion")),s.attributes.has("instr")&&(t.instrument=Number.parseInt(s.attributes.get("instr"),10)),s.attributes.has("volume")&&(t.volume=Number.parseInt(s.attributes.get("volume"),10)),s.attributes.has("transpose")&&(t.transpose=Number.parseInt(s.attributes.get("transpose"),10))}this._staffLayoutLookup.set(t.description,t),t.index=this._staffLayouts.length,this._staffLayouts.push(t)}_parseClef(e){switch(e){case"treble":return 4;case"bass":return 3;case"alto":case"tenor":return 2}return 4}_parseClefOttava(e){return e.endsWith("-")?3:e.endsWith("+")?1:2}_parseSystems(e){for(let t of e.childElements())"system"===t.localName&&this._parseSystem(t)}_parseSystem(e){e.attributes.has("tempo")&&0===this.score.masterBars.length&&(this._initialTempo=Number.parseInt(e.attributes.get("tempo"),10)),"0"===e.getAttribute("beamGrouping")&&(this._beamingMode=1);for(let t of e.childElements())"staves"===t.localName&&this._parseStaves(e,t);this._isFirstSystem=!1}_parseStaves(e,t){let s=this.score.masterBars.length;for(let i of t.childElements())"staff"===i.localName&&this._parseStaff(e,s,i)}_parseStaff(e,t,s){let i=s.getAttribute("layout");this._currentStaffLayout=this._staffLayoutLookup.get(i),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this._parseTime(s.getAttribute("defaultTime"));let a=this._staffLookup.get(this._currentStaffLayout.index);for(;a.bars.length<t;)this._addNewBar(a);for(let r of s.childElements())"voices"===r.localName&&this._parseVoices(i,a,e,t,r)}_parseTime(e){switch(e){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:if(e.indexOf("/")>0){let t=e.split("/");this._timeSignature.timeSignatureNumerator=Number.parseInt(t[0],10),this._timeSignature.timeSignatureDenominator=Number.parseInt(t[1],10),this._timeSignature.timeSignatureCommon=!1}}}_parseVoices(e,t,s,i,a){let r=0;for(let n of a.childElements())"voice"===n.localName&&(this._parseVoice(e,t,s,r,i,n),r++)}_getOrCreateBar(e,t){return t<e.bars.length?e.bars[t]:this._addNewBar(e)}_addNewBar(e){let t=new Be;if(e.bars.length>0?(t.clef=e.bars[e.bars.length-1].clef,t.clefOttava=e.bars[e.bars.length-1].clefOttava,t.keySignature=e.bars[e.bars.length-1].keySignature,t.keySignatureType=e.bars[e.bars.length-1].keySignatureType):t.clef=this._currentStaffLayout.defaultClef,e.addBar(t),e.bars.length>this.score.masterBars.length){let e=new We;this.score.addMasterBar(e),e.index>0?e.tripletFeel=e.previousMasterBar.tripletFeel:this._initialTempo>0&&e.tempoAutomations.push(w.buildTempoAutomation(!1,0,this._initialTempo,0)),e.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,e.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,e.timeSignatureCommon=this._timeSignature.timeSignatureCommon}return t}_newBar(e,t){this._currentVoiceState.currentBarIndex++,this._currentBar=this._getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this._ensureVoice(e,t)}_parseVoice(e,t,s,i,a,r){let n=`${e}_${i}`;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(n)?(this._currentVoiceState=this._voiceStates.get(n),this._currentBar=this._getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this._ensureVoice(t,i)):(this._currentVoiceState=new ui,this._currentVoiceState.currentBarIndex=a-1,this._voiceStates.set(n,this._currentVoiceState),this._newBar(t,i)),r.attributes.has("stemDir"))switch(r.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=0;break;case"down":this._currentVoiceState.voiceStemDir=1;break;default:this._currentVoiceState.voiceStemDir=null}else this._currentVoiceState.voiceStemDir=null;let o=r.findChildElement("noteObjects");if(s.attributes.has("tempo")){let e=new w;e.isLinear=!0,e.type=0,e.value=Number.parseInt(s.attributes.get("tempo"),10),e.ratioPosition=this._currentVoiceState.currentPosition/this._currentVoiceState.currentBarDuration,this._currentBar.masterBar.tempoAutomations.push(e)}if(o)for(let e of o.childElements())switch(this._currentVoiceState.currentBarComplete&&"barline"!==e.localName&&this._newBar(t,i),e.localName){case"clefSign":this._currentBar.clef=this._parseClef(e.getAttribute("clef")),this._currentBar.clefOttava=this._parseClefOttava(e.getAttribute("clef"));break;case"keySign":this._currentBar.keySignature=Number.parseInt(e.getAttribute("fifths"),10);break;case"timeSign":this._parseTime(e.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(e.getAttribute("type")){case"double":this._currentBar.barLineRight=7,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this._parseBarDrawObject(e),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this._newBar(t,i),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this._parseBarDrawObject(e),this._newBar(t,i),this._currentBar.masterBar.isRepeatStart=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0}break;case"chord":let s=new wt;this._initFromPreviousBeat(s,this._currentVoice),s.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(s.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this._parseDuration(s,e.findChildElement("duration")),s.updateDurations(),this._currentVoiceState.currentPosition+=s.playbackDuration,this._currentVoice.addBeat(s),this._parseChord(s,e),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":let a=this._parseRestDurations(e.findChildElement("duration"));a&&(this._initFromPreviousBeat(a,this._currentVoice),a.updateDurations(),this._currentVoiceState.currentPosition+=a.playbackDuration,this._currentVoice.addBeat(a),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0))}}_initFromPreviousBeat(e,t){let s=this._getLastBeat(t);s&&(e.dynamics=s.dynamics)}_getLastBeat(e){if(e.beats.length>0)return e.beats[e.beats.length-1];if(e.bar.index>0){let t=e.bar.staff.bars[e.bar.index-1];if(e.index<t.voices.length){let s=t.voices[e.index];return this._getLastBeat(s)}}return null}_ensureVoice(e,t){for(;this._currentBar.voices.length<t+1;)this._currentBar.addVoice(new Me);(!this._voiceCounts.has(e.track.index)||this._voiceCounts.get(e.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(e.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[t]}_parseChord(e,t){let s=new nt;for(let i of t.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":e.preferredBeamDirection=0;break;case"down":e.preferredBeamDirection=1}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=1;break;case"strongAccent":s.accentuated=2}break;case"lyric":this._parseLyric(e,i);break;case"drawObjects":this._parseBeatDrawObject(e,i);break;case"heads":this._parseHeads(e,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":e.beamingMode=2;break;case"divide":e.beamingMode=1}}}_parseHeads(e,t,s){for(let i of s.childElements())"head"===i.localName&&this._parseHead(e,t,i)}_parseHead(e,t,s){let i=new nt,a=qe.parseTuning(s.getAttribute("pitch"));i.octave=a.octave-1,i.tone=a.tone.noteValue,i.isStaccato=t.isStaccato,i.accentuated=t.accentuated,e.addNote(i);for(let e of s.childElements())switch(e.localName){case"alter":e.attributes.has("step")&&(i.tone+=Number.parseInt(e.attributes.get("step"),10));break;case"tie":e.attributes.has("begin")?this._tieStartIds.has(i.id)||(this._tieStartIds.set(i.id,!0),this._tieStarts.push(i)):e.attributes.has("end")&&this._tieStarts.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(i.id))}}_parseBeatDrawObject(e,t){for(let s of t.childElements())if("drawObj"===s.localName){let t=this._parseDrawObj(s);if(t)if(t instanceof ti)t.fontFace.startsWith("capella")?"u"===t.text?(e.fermata=new At,e.fermata.type=1):"f"===t.text?e.dynamics=5:"j"===t.text&&(e.dynamics=4):this._isFirstSystem&&""===this.score.title&&1===t.align&&t.height>16&&t.weight>400?this.score.title=t.text:this._isFirstSystem&&""===this.score.artist&&1===t.align&&t.y<0?this.score.artist=t.text:this._isFirstSystem&&""===this.score.music&&2===t.align&&t.y<0?this.score.music=t.text:t.text.startsWith("by capella")||(e.text=t.text);else if(!(t instanceof si))if(t instanceof ai)e.vibrato=1;else if(t instanceof ni)e.crescendo=t.decrescendo?2:1,t.noteRange++,this._crescendo.set(e,t);else if(t instanceof ii){let s=t;this._slurs.set(e,s)}else t instanceof oi&&this._applyVolta(t)}}_parseBarDrawObject(e){for(let t of e.childElements())if("drawObj"===t.localName){let e=this._parseDrawObj(t);e&&e instanceof oi&&this._applyVolta(e)}}_applyVolta(e){if(e.lastNumber>0?(this._currentVoiceState.repeatCount=e.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):e.firstNumber>0&&(this._currentVoiceState.repeatCount=e.firstNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)),e.lastNumber>0&&e.firstNumber>0){let t=0;for(let s=e.firstNumber;s<=e.lastNumber;s++)t|=1<<s-1;this._currentBar.masterBar.alternateEndings=t}else e.lastNumber>0?this._currentBar.masterBar.alternateEndings=1<<e.lastNumber-1:e.firstNumber>0&&(this._currentBar.masterBar.alternateEndings=1<<e.firstNumber-1)}_parseLyric(e,t){for(let s of t.childElements())if("verse"===s.localName){e.lyrics||(e.lyrics=[]);let t=s.innerText;"true"===s.getAttribute("hyphen")&&(t+="-"),e.lyrics.push(t)}}_parseRestDurations(e){let t=e.getAttribute("base");if(-1!==t.indexOf("/")){let t=new wt;return t.beamingMode=this._beamingMode,this._parseDuration(t,e),t}if(1===Number.parseInt(t,10)){let e=new wt;return e.beamingMode=this._beamingMode,e.duration=1,e}return re.warning("Importer","Multi-Bar rests are not supported"),null}_parseDurationValue(e){switch(e){case"2/1":return-2;case"1/1":return 1;case"1/2":return 2;case"1/4":return 4;case"1/8":return 8;case"1/16":return 16;case"1/32":return 32;case"1/64":return 64;case"1/128":return 128;default:return re.warning("Importer","Unsupported duration"),4}}_parseDuration(e,t){let s=t.getAttribute("base");e.duration=this._parseDurationValue(s),t.attributes.has("dots")&&(e.dots=Number.parseInt(t.attributes.get("dots"),10));let i=t.findChildElement("tuplet");if(i){e.tupletNumerator=Number.parseInt(i.getAttribute("count"),10);let t="true"===i.getAttribute("tripartite")?3:1,s="true"===i.getAttribute("prolong")?0:1,a=0;for(;t*Math.pow(2,a+s)<e.tupletNumerator;)a++;e.tupletDenominator=t*Math.pow(2,a)}}_parsePageObjects(e){for(let t of e.childElements())if("drawObj"===t.localName){let e=this._parseDrawObj(t);if(e&&e instanceof ti)switch(e.align){case 1:this.score.title?this.score.subTitle||(this.score.subTitle=t.innerText):this.score.title=t.innerText;break;case 2:this.score.artist||(this.score.artist=t.innerText)}}}_parseGallery(e){for(let t of e.childElements())if("drawObj"===t.localName){let e=this._parseDrawObj(t);e&&this._galleryObjects.set(t.getAttribute("name"),e)}}_parseDrawObj(e){let t=null,s=1;for(let i of e.childElements())switch(i.localName){case"text":t=this._parseText(i);break;case"guitar":t=this._parseGuitar(i);break;case"slur":t=this._parseSlur(i);break;case"wavyLine":t=this._parseWavyLine(i);break;case"bracket":t=this._parseTupletBracket(i);break;case"wedge":t=this._parseWedge(i);break;case"volta":t=this._parseVolta(i);break;case"octaveClef":t=this._parseOctaveClef(i);break;case"trill":t=this._parseTrill(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10))}return t&&(t.noteRange=s),t}_parseTrill(e){return new hi}_parseOctaveClef(e){let t=new li;return e.attributes.has("octave")&&(t.octave=Number.parseInt(e.attributes.get("octave"),10)),t}_parseVolta(e){let t=new oi;return t.allNumbers="true"===e.attributes.get("allNumbers"),e.attributes.has("firstNumber")&&(t.firstNumber=Number.parseInt(e.attributes.get("firstNumber"),10)),e.attributes.has("lastNumber")&&(t.lastNumber=Number.parseInt(e.attributes.get("lastNumber"),10)),t}_parseWedge(e){let t=new ni;return t.decrescendo="true"===e.attributes.get("decrescendo"),t}_parseTupletBracket(e){let t=new ri;return e.attributes.has("number")&&(t.number=Number.parseInt(e.attributes.get("number"),10)),t}_parseWavyLine(e){return new ai}_parseSlur(e){return new ii}_parseGuitar(e){let t=new si,s=e.innerText.trim();for(let e=0;e<s.length;e++)"/"===s.charAt(e)?t.chord.strings.push(0):t.chord.strings.push(Number.parseInt(s.charAt(e),10));return t}_parseText(e){let t=new ti;switch(e.attributes.has("x")&&(t.x=Number.parseFloat(e.attributes.get("x"))),e.attributes.has("x")&&(t.y=Number.parseFloat(e.attributes.get("y"))),e.getAttribute("align")){case"left":t.align=0;break;case"center":t.align=1;break;case"right":t.align=2}switch(e.getAttribute("frame")){case"rectangle":t.frame=1;break;case"ellipse":t.frame=2;break;case"circle":t.frame=3;break;case"none":t.frame=0}if(e.firstElement)for(let s of e.childElements())switch(s.localName){case"font":t.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(t.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(t.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":t.text=s.innerText}else t.text=e.innerText;return t}_parseInfo(e){for(let t of e.childElements())switch(t.localName){case"author":this.score.tab=t.firstChild.innerText;break;case"comment":this.score.notices=t.firstChild.innerText}}},mi=class extends Ls{get name(){return"Capella"}readScore(){re.debug(this.name,"Loading ZIP entries");let e,t=null;if(e=new $s(this.data).read(),re.debug(this.name,"Zip entries loaded"),e.length>0)for(let s of e)"score.xml"===s.fileName&&(t=Ps.toString(s.data,this.settings.importer.encoding));else this.data.reset(),t=Ps.toString(this.data.readAll(),this.settings.importer.encoding);if(!t)throw new Cs("No valid capella file");re.debug(this.name,"Start Parsing score.xml");try{let e=new pi;return e.parseXml(t,this.settings),re.debug(this.name,"score.xml parsed"),e.score}catch(e){throw new Cs("Failed to parse CapXML",e)}}},gi=class e extends Ls{constructor(){super(...arguments),this._versionNumber=0,this._globalTripletFeel=0,this._lyricsTrack=0,this._lyrics=[],this._barCount=0,this._trackCount=0,this._playbackInfos=[],this._doubleBars=new Set,this._clefsPerTrack=new Map,this._keySignatures=new Map,this._beatTextChunksByTrack=new Map,this._directionLookup=new Map}get name(){return"Guitar Pro 3-5"}readScore(){if(this._directionLookup.clear(),this.readVersion(),this._score=new Oe,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=bi.gpReadBool(this.data)?2:0),this._versionNumber>=400&&this.readLyrics(),this._versionNumber>=510&&this.data.skip(19),this._initialTempo=w.buildTempoAutomation(!1,0,0,0),this._versionNumber>=500&&(this.readPageSetup(),this._initialTempo.text=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._initialTempo.value=Ps.readInt32LE(this.data),this._versionNumber>=510&&bi.gpReadBool(this.data),Ps.readInt32LE(this.data),this._versionNumber>=400&&this.data.readByte(),this.readPlaybackInfos(),this._versionNumber>=500&&(this._readDirection(3),this._readDirection(4),this._readDirection(1),this._readDirection(2),this._readDirection(0),this._readDirection(5),this._readDirection(6),this._readDirection(7),this._readDirection(8),this._readDirection(9),this._readDirection(10),this._readDirection(11),this._readDirection(12),this._readDirection(13),this._readDirection(14),this._readDirection(15),this._readDirection(16),this._readDirection(17),this._readDirection(18),this.data.skip(4)),this._barCount=Ps.readInt32LE(this.data),this._trackCount=Ps.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this._score.masterBars.length>0){let e=w.buildTempoAutomation(!1,0,this._score.tempo,2);e.text=this._score.tempoLabel,this._score.masterBars[0].tempoAutomations.push(e)}return qe.consolidate(this._score),this._score.finish(this.settings),this._lyrics&&this._lyricsTrack>=0&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}_readDirection(e){let t,s=Ps.readInt16LE(this.data);-1!==s&&(s--,this._directionLookup.has(s)?t=this._directionLookup.get(s):(t=[],this._directionLookup.set(s,t)),t.push(e))}readVersion(){let t=bi.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!t.startsWith(e._versionString))throw new Cs("Unsupported format");t=t.substr(e._versionString.length+1);let s=t.indexOf(".");this._versionNumber=100*Number.parseInt(t.substr(0,s),10)+Number.parseInt(t.substr(s+1),10),re.debug(this.name,`Guitar Pro version ${t} detected`)}readScoreInformation(){this._score.title=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=this._versionNumber>=500?bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding);let e=Ps.readInt32LE(this.data),t="";for(let s=0;s<e;s++)s>0&&(t+="\r\n"),t+=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this._score.notices=t}readLyrics(){this._lyrics=[],this._lyricsTrack=Ps.readInt32LE(this.data)-1;for(let e=0;e<5;e++){let e=new jt;e.startBar=Ps.readInt32LE(this.data)-1,e.text=bi.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(e)}}readPageSetup(){this.data.skip(28);let e=Ps.readInt16LE(this.data);qe.getOrCreateHeaderFooterStyle(this._score,0).isVisible=!!(1&e),qe.getOrCreateHeaderFooterStyle(this._score,0).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),qe.getOrCreateHeaderFooterStyle(this._score,1).isVisible=!!(2&e),qe.getOrCreateHeaderFooterStyle(this._score,1).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),qe.getOrCreateHeaderFooterStyle(this._score,2).isVisible=!!(4&e),qe.getOrCreateHeaderFooterStyle(this._score,2).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),qe.getOrCreateHeaderFooterStyle(this._score,3).isVisible=!!(8&e),qe.getOrCreateHeaderFooterStyle(this._score,3).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),qe.getOrCreateHeaderFooterStyle(this._score,4).isVisible=!!(16&e),qe.getOrCreateHeaderFooterStyle(this._score,4).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),qe.getOrCreateHeaderFooterStyle(this._score,5).isVisible=!!(32&e),qe.getOrCreateHeaderFooterStyle(this._score,5).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),qe.getOrCreateHeaderFooterStyle(this._score,6).isVisible=!!(64&e),qe.getOrCreateHeaderFooterStyle(this._score,6).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),qe.getOrCreateHeaderFooterStyle(this._score,8).isVisible=!!(128&e),qe.getOrCreateHeaderFooterStyle(this._score,8).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),qe.getOrCreateHeaderFooterStyle(this._score,9).isVisible=!!(128&e),qe.getOrCreateHeaderFooterStyle(this._score,9).template=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),bi.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];let e=0;for(let t=0;t<64;t++){let t=new ss;t.primaryChannel=e++,t.secondaryChannel=e++,t.program=Ps.readInt32LE(this.data),t.volume=this.data.readByte(),t.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(t)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let e=null;this._score.masterBars.length>0&&(e=this._score.masterBars[this._score.masterBars.length-1]);let t=new We;!e&&this._initialTempo.value>0&&t.tempoAutomations.push(this._initialTempo);let s=this.data.readByte();if(1&s?t.timeSignatureNumerator=this.data.readByte():e&&(t.timeSignatureNumerator=e.timeSignatureNumerator),2&s?t.timeSignatureDenominator=this.data.readByte():e&&(t.timeSignatureDenominator=e.timeSignatureDenominator),t.isRepeatStart=!!(4&s),!!(8&s)&&(t.repeatCount=this.data.readByte()+(this._versionNumber>=500?0:1)),16&s&&this._versionNumber<500){let s=e,i=0;for(;s&&!(s.isRepeatEnd&&s!==e||s.isRepeatStart);)i|=s.alternateEndings,s=s.previousMasterBar;let a=0,r=this.data.readByte();for(let e=0;e<8;e++){let t=1<<e;r>e&&0===(i&t)&&(a|=t)}t.alternateEndings=a}if(32&s){let e=new Kt;e.text=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.marker="",bi.gpReadColor(this.data,!1),t.section=e}if(!!(64&s)&&this._keySignatures.set(this._score.masterBars.length,[Ps.readSInt8(this.data),this.data.readByte()]),this._versionNumber>=500&&!!(3&s)&&this.data.skip(4),this._versionNumber>=500&&(t.alternateEndings=this.data.readByte()),this._versionNumber>=500){switch(this.data.readByte()){case 1:t.tripletFeel=2;break;case 2:t.tripletFeel=1}this.data.readByte()}else t.tripletFeel=this._globalTripletFeel;let i=!!(128&s);t.isDoubleBar=i;let a=this._score.masterBars.length;if(this._directionLookup.has(a))for(let e of this._directionLookup.get(a))t.addDirection(e);this._score.addMasterBar(t),i&&this._doubleBars.add(t.index)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){let e=new ns;e.ensureStaveCount(1),this._score.addTrack(e);let t=e.staves[0],s=this.data.readByte();e.name=bi.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),!!(1&s)&&(t.isPercussion=!0),this._versionNumber>=500&&(e.isVisibleOnMultiTrack=!!(8&s)),null===this._score.stylesheet.perTrackDisplayTuning&&(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(e.index,!!(128&s));let i=Ps.readInt32LE(this.data),a=[];for(let e=0;e<7;e++){let t=Ps.readInt32LE(this.data);i>e&&a.push(t)}t.stringTuning.tunings=a;let r=Ps.readInt32LE(this.data),n=Ps.readInt32LE(this.data)-1,o=Ps.readInt32LE(this.data)-1;if(this.data.skip(4),n>=0&&n<this._playbackInfos.length){let i=this._playbackInfos[n];i.port=r,i.isSolo=!!(16&s),i.isMute=!!(32&s),i.secondaryChannel=o,Ut.isGuitar(i.program)&&(t.displayTranspositionPitch=-12),e.playbackInfo=i}if(t.capo=Ps.readInt32LE(this.data),e.color=bi.gpReadColor(this.data,!1),this._versionNumber>=500){let s=this.data.readByte();t.showTablature=!!(1&s),t.showStandardNotation=!!(2&s);let i=!!(100&s);null===this._score.stylesheet.perTrackChordDiagramsOnTop&&(this._score.stylesheet.perTrackChordDiagramsOnTop=new Map),this._score.stylesheet.perTrackChordDiagramsOnTop.set(e.index,i),this.data.readByte(),this.data.readByte(),e.playbackInfo.bank=this.data.readByte(),this.data.readByte(),12===Ps.readInt32LE(this.data)?this._clefsPerTrack.set(n,3):this._clefsPerTrack.set(n,4),Ps.readInt32LE(this.data),Ps.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this._readRseBank(),this._versionNumber>=510&&(this.data.skip(4),bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),bi.gpReadStringIntByte(this.data,this.settings.importer.encoding))}else Ut.isBass(e.playbackInfo.program)?this._clefsPerTrack.set(n,3):this._clefsPerTrack.set(n,4)}readBars(){for(let e=0;e<this._barCount;e++)for(let e=0;e<this._trackCount;e++)this.readBar(this._score.tracks[e])}readBar(e){let t=new Be,s=e.staves[0];if(s.isPercussion?t.clef=0:this._clefsPerTrack.has(e.index)&&(t.clef=this._clefsPerTrack.get(e.index)),s.addBar(t),this._keySignatures.has(t.index)){let e=this._keySignatures.get(t.index);t.keySignature=e[0],t.keySignatureType=e[1]}else t.index>0&&(t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType);this._doubleBars.has(t.index)&&(t.barLineRight=7);let i=1;this._versionNumber>=500&&(this.data.readByte(),i=2);for(let s=0;s<i;s++)this.readVoice(e,t)}readVoice(e,t){let s=Ps.readInt32LE(this.data);if(0===s)return;let i=new Me;t.addVoice(i);for(let a=0;a<s;a++)this.readBeat(e,t,i)}readBeat(e,t,s){let i=new wt,a=this.data.readByte();if(!!(1&a)&&(i.dots=1),64&a){let e=this.data.readByte();i.isEmpty=!(2&e)}switch(s.addBeat(i),Ps.readSInt8(this.data)){case-2:i.duration=1;break;case-1:i.duration=2;break;case 0:i.duration=4;break;case 1:i.duration=8;break;case 2:i.duration=16;break;case 3:i.duration=32;break;case 4:i.duration=64;break;default:i.duration=4}if(32&a)switch(i.tupletNumerator=Ps.readInt32LE(this.data),i.tupletNumerator){case 1:i.tupletDenominator=1;break;case 3:i.tupletDenominator=2;break;case 5:case 6:case 7:i.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:i.tupletDenominator=8;break;case 2:case 4:case 8:break;default:i.tupletNumerator=1,i.tupletDenominator=1}2&a&&this.readChord(i);let r=this.settings.importer.beatTextAsLyrics&&e.index!==this._lyricsTrack;if(4&a){let t=bi.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){let s=new jt;s.text=t.trim(),s.finish(!0);let i=[];for(let e=s.chunks.length-1;e>=0;e--)i.push(s.chunks[e]);this._beatTextChunksByTrack.set(e.index,i)}else i.text=t}let n=0;!!(8&a)&&(n=this.readBeatEffects(i)),16&a&&this.readMixTableChange(i);let o=this.data.readByte();for(let a=6;a>=0;a--)if(o&1<<a&&6-a<t.staff.tuning.length){let r=this.readNote(e,t,s,i,6-a);0!==n&&(r.harmonicType=n,1===r.harmonicType&&(r.harmonicValue=qe.deltaFretToHarmonicValue(r.fret)))}if(this._versionNumber>=500){let e=Ps.readInt16LE(this.data);if(!!(1&e)&&i.index>0&&(s.beats[i.index-1].beamingMode=1),!!(2&e)&&(i.preferredBeamDirection=1),!!(4&e)&&i.index>0&&(s.beats[i.index-1].beamingMode=2),!!(8&e)&&(i.preferredBeamDirection=0),!!(16&e)&&(i.ottava=1),!!(32&e)&&(i.ottava=3),!!(64&e)&&(i.ottava=0),!!(256&e)&&(i.ottava=4),2048&e){let e=0!==this.data.readByte();i.index>0&&e&&(s.beats[i.index-1].beamingMode=3)}}r&&!i.isRest&&this._beatTextChunksByTrack.has(e.index)&&this._beatTextChunksByTrack.get(e.index).length>0&&(i.lyrics=[this._beatTextChunksByTrack.get(e.index).pop()])}readChord(e){let t=new Yt,s=qe.newGuid();if(this._versionNumber>=500){this.data.skip(17),t.name=bi.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=Ps.readInt32LE(this.data);for(let s=0;s<7;s++){let i=Ps.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}let s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let e=0;e<s;e++)t.barreFrets.push(i[e]);this.data.skip(26)}else if(0!==this.data.readByte())if(this._versionNumber>=400){this.data.skip(16),t.name=bi.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=Ps.readInt32LE(this.data);for(let s=0;s<7;s++){let i=Ps.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}let s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let e=0;e<s;e++)t.barreFrets.push(i[e]);this.data.skip(26)}else{this.data.skip(25),t.name=bi.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),t.firstFret=Ps.readInt32LE(this.data);for(let s=0;s<6;s++){let i=Ps.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}this.data.skip(36)}else{let s=this._versionNumber>=406?7:6;if(t.name=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.firstFret=Ps.readInt32LE(this.data),t.firstFret>0)for(let i=0;i<s;i++){let s=Ps.readInt32LE(this.data);i<e.voice.bar.staff.tuning.length&&t.strings.push(s)}}t.name&&(e.chordId=s,e.voice.bar.staff.addChord(e.chordId,t))}readBeatEffects(t){let s=this.data.readByte(),i=0;if(this._versionNumber>=400&&(i=this.data.readByte()),!!(16&s)&&(t.fade=1),(this._versionNumber<400&&!!(1&s)||!!(2&s))&&(t.vibrato=1),!!(1&i)&&(t.rasgueado=1),32&s&&this._versionNumber>=400)switch(Ps.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}else if(32&s){switch(Ps.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}this.data.skip(4)}if(!!(4&i)&&this.readTremoloBarEffect(t),64&s){let s=0,i=0;this._versionNumber<500?(i=this.data.readByte(),s=this.data.readByte()):(s=this.data.readByte(),i=this.data.readByte()),s>0?(t.brushType=1,t.brushDuration=e._toStrokeValue(s)):i>0&&(t.brushType=2,t.brushDuration=e._toStrokeValue(i))}if(2&i)switch(Ps.readSInt8(this.data)){case 0:t.pickStroke=0;break;case 1:t.pickStroke=1;break;case 2:t.pickStroke=2}if(this._versionNumber<400){if(4&s)return 1;if(8&s)return 2}return 0}readTremoloBarEffect(t){this.data.readByte(),Ps.readInt32LE(this.data);let s=Ps.readInt32LE(this.data);if(s>0)for(let i=0;i<s;i++){let s=new T(0,0);s.offset=Ps.readInt32LE(this.data),s.value=Ps.readInt32LE(this.data)/e._bendStep|0,bi.gpReadBool(this.data),t.addWhammyBarPoint(s)}}static _toStrokeValue(e){switch(e){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}_readRseBank(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(e){let t=new yi;t.instrument=Ps.readSInt8(this.data),this._versionNumber>=500&&this._readRseBank(),t.volume=Ps.readSInt8(this.data),t.balance=Ps.readSInt8(this.data);let s=Ps.readSInt8(this.data),i=Ps.readSInt8(this.data),a=Ps.readSInt8(this.data),r=Ps.readSInt8(this.data);if(this._versionNumber>=500&&(t.tempoName=bi.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.tempo=Ps.readInt32LE(this.data),t.volume>=0&&this.data.readByte(),t.balance>=0&&this.data.readByte(),s>=0&&this.data.readByte(),i>=0&&this.data.readByte(),a>=0&&this.data.readByte(),r>=0&&this.data.readByte(),t.tempo>=0&&(t.duration=Ps.readSInt8(this.data),this._versionNumber>=510&&this.data.readByte()),this._versionNumber>=400&&this.data.readByte(),this._versionNumber>=500){let t=Ps.readSInt8(this.data);t>=100?e.wahPedal=2:t>=0&&(e.wahPedal=1)}if(this._versionNumber>=510&&(bi.gpReadStringIntByte(this.data,this.settings.importer.encoding),bi.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.volume>=0){let s=new w;s.isLinear=!0,s.type=1,s.value=t.volume,e.automations.push(s)}if(t.balance>=0){let s=new w;s.isLinear=!0,s.type=3,s.value=t.balance,e.automations.push(s)}if(t.instrument>=0){let s=new w;s.isLinear=!0,s.type=2,s.value=t.instrument,e.automations.push(s)}if(t.tempo>=0){let s=new w;s.isLinear=!0,s.type=0,s.value=t.tempo,e.automations.push(s),e.voice.bar.masterBar.tempoAutomations.some(e=>e.ratioPosition===s.ratioPosition&&e.value===s.value)||e.voice.bar.masterBar.tempoAutomations.push(s)}}readNote(e,t,s,i,a){let r=new nt;r.string=t.staff.tuning.length-a;let n=this.data.readByte();if(2&n?r.accentuated=2:!!(64&n)&&(r.accentuated=1),r.isGhost=!!(4&n),32&n){let e=this.data.readByte();3===e?r.isDead=!0:2===e&&(r.isTieDestination=!0)}if(!!(1&n)&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),16&n){let e=Ps.readSInt8(this.data);r.dynamics=this.toDynamicValue(e),i.dynamics=r.dynamics}!!(32&n)&&(r.fret=Ps.readSInt8(this.data)),128&n&&(r.leftHandFinger=Ps.readSInt8(this.data),r.rightHandFinger=Ps.readSInt8(this.data));let o=!1;if(this._versionNumber>=500&&(!!(1&n)&&(r.durationPercent=Ps.readFloat64BE(this.data)),o=!!(2&this.data.readByte())),i.addNote(r),!!(8&n)&&this.readNoteEffects(e,s,i,r),t.staff.isPercussion&&(r.percussionArticulation=r.fret,r.string=-1,r.fret=-1),o){let e=qe.computeAccidental(t.keySignature,0,r.realValueWithoutHarmonic,!1);2===e?r.accidentalMode=5:3===e&&(r.accidentalMode=3)}return r}toDynamicValue(e){switch(e){case 1:return 0;case 2:return 1;case 3:return 2;case 4:return 3;case 5:return 4;case 6:default:return 5;case 7:return 6;case 8:return 7}}readNoteEffects(e,t,s,i){let a=this.data.readByte(),r=0;this._versionNumber>=400&&(r=this.data.readByte()),!!(1&a)&&this.readBend(i),!!(16&a)&&this.readGrace(t,i),!!(4&r)&&this.readTremoloPicking(s),8&r?this.readSlide(i):this._versionNumber<400&&!!(4&a)&&(i.slideOutType=1),!!(16&r)&&this.readArtificialHarmonic(i),!!(32&r)&&this.readTrill(i),i.isLetRing=!!(8&a),i.isHammerPullOrigin=!!(2&a),!!(64&r)&&(i.vibrato=1),i.isPalmMute=!!(2&r),i.isStaccato=!!(1&r)}readBend(t){this.data.readByte(),Ps.readInt32LE(this.data);let s=Ps.readInt32LE(this.data);if(s>0)for(let i=0;i<s;i++){let s=new T(0,0);s.offset=Ps.readInt32LE(this.data),s.value=Ps.readInt32LE(this.data)/e._bendStep|0,bi.gpReadBool(this.data),t.addBendPoint(s)}}readGrace(e,t){let s=new wt,i=new nt;switch(i.string=t.string,i.fret=Ps.readSInt8(this.data),s.duration=32,s.dynamics=this.toDynamicValue(Ps.readSInt8(this.data)),Ps.readSInt8(this.data)){case 0:case 2:break;case 1:i.slideOutType=2,i.slideTarget=t;break;case 3:i.isHammerPullOrigin=!0}if(i.dynamics=s.dynamics,this.data.skip(1),this._versionNumber<500)s.graceType=2;else{let e=this.data.readByte();i.isDead=!!(1&e),s.graceType=2&e?1:2}e.addGraceBeat(s),s.addNote(i)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=8;break;case 2:e.tremoloSpeed=16;break;case 3:e.tremoloSpeed=32}}readSlide(e){if(this._versionNumber>=500){let t=Ps.readSInt8(this.data);1&t?e.slideOutType=1:2&t?e.slideOutType=2:4&t?e.slideOutType=4:!!(8&t)&&(e.slideOutType=3),16&t?e.slideInType=1:32&t&&(e.slideInType=2)}else switch(Ps.readSInt8(this.data)){case 1:e.slideOutType=1;break;case 2:e.slideOutType=2;break;case 3:e.slideOutType=4;break;case 4:e.slideOutType=3;break;case-1:e.slideInType=1;break;case-2:e.slideInType=2}}readArtificialHarmonic(e){let t=this.data.readByte();if(this._versionNumber>=500)switch(t){case 1:e.harmonicType=1,e.harmonicValue=qe.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=2;break;case 3:e.harmonicType=4,e.harmonicValue=qe.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=3,e.harmonicValue=12;break;case 5:e.harmonicType=5,e.harmonicValue=12}else if(this._versionNumber>=400)switch(t){case 1:e.harmonicType=1;break;case 3:e.harmonicType=4;break;case 4:e.harmonicType=3;break;case 5:e.harmonicType=5;break;case 15:case 17:case 22:e.harmonicType=2}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=16;break;case 2:e.trillSpeed=32;break;case 3:e.trillSpeed=64}}};gi._versionString="FICHIER GUITAR PRO ",gi._bendStep=25;var fi=gi,bi=class e{static gpReadColor(e,t=!1){let s=e.readByte(),i=e.readByte(),a=e.readByte(),r=255;return t?r=e.readByte():e.skip(1),new Jt(s,i,a,r)}static gpReadBool(e){return 0!==e.readByte()}static gpReadStringIntUnused(t,s){return t.skip(4),e.gpReadString(t,t.readByte(),s)}static gpReadStringInt(t,s){return e.gpReadString(t,Ps.readInt32LE(t),s)}static gpReadStringIntByte(t,s){let i=Ps.readInt32LE(t)-1;return t.readByte(),e.gpReadString(t,i,s)}static gpReadString(e,t,s){let i=new Uint8Array(t);return e.read(i,0,i.length),Ps.toString(i,s)}static gpWriteString(e,t){let s=Ps.stringToBytes(t);e.writeByte(t.length),e.write(s,0,s.length)}static gpReadStringByteLength(t,s,i){let a=t.readByte(),r=e.gpReadString(t,a,i);return a<s&&t.skip(s-a),r}},yi=class{constructor(){this.volume=-1,this.balance=-1,this.instrument=-1,this.tempoName="",this.tempo=-1,this.duration=-1}},_i=class e{constructor(e){this._types=new Map,this.raw=new Map,e&&this._read(e)}_read(e){let t=Fs.fromBuffer(e),s=Ps.readInt32BE(t);for(let e=0;e<s;e++){let e=bi.gpReadString(t,t.readByte(),"utf-8"),s=t.readByte();switch(this._types.set(e,s),s){case 0:let s=1===t.readByte();this.addValue(e,s);break;case 1:let i=Ps.readInt32BE(t);this.addValue(e,i);break;case 2:let a=Ps.readFloat32BE(t);this.addValue(e,a);break;case 3:let r=bi.gpReadString(t,Ps.readInt16BE(t),"utf-8");this.addValue(e,r);break;case 4:let n=Ps.readInt32BE(t),o=Ps.readInt32BE(t);this.addValue(e,new T(n,o));break;case 5:let l=Ps.readInt32BE(t),h=Ps.readInt32BE(t);this.addValue(e,new T(l,h));break;case 6:let d=new ms;d.x=Ps.readInt32BE(t),d.y=Ps.readInt32BE(t),d.w=Ps.readInt32BE(t),d.h=Ps.readInt32BE(t),this.addValue(e,d);break;case 7:let c=bi.gpReadColor(t,!0);this.addValue(e,c)}}}apply(e){for(let[t,s]of this.raw)switch(t){case"StandardNotation/hideDynamics":e.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":e.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":e.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":e.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":e.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/showTrackNameSingle":s||(e.stylesheet.singleTrackTrackNamePolicy=0);break;case"System/showTrackNameMulti":s||(e.stylesheet.multiTrackTrackNamePolicy=0);break;case"System/trackNameModeSingle":if(0!==e.stylesheet.singleTrackTrackNamePolicy)switch(s){case 0:case 1:e.stylesheet.singleTrackTrackNamePolicy=1;break;case 2:e.stylesheet.singleTrackTrackNamePolicy=2}break;case"System/trackNameModeMulti":if(0!==e.stylesheet.multiTrackTrackNamePolicy)switch(s){case 0:case 1:e.stylesheet.multiTrackTrackNamePolicy=1;break;case 2:e.stylesheet.multiTrackTrackNamePolicy=2}break;case"System/shortTrackNameOnFirstSystem":e.stylesheet.firstSystemTrackNameMode=s?1:0;break;case"System/shortTrackNameOnOtherSystems":e.stylesheet.otherSystemsTrackNameMode=s?1:0;break;case"System/horizontalTrackNameOnFirstSystem":e.stylesheet.firstSystemTrackNameOrientation=s?0:1;break;case"System/horizontalTrackNameOnOtherSystems":e.stylesheet.otherSystemsTrackNameOrientation=s?0:1;break;case"Header/Title":qe.getOrCreateHeaderFooterStyle(e,0).template=s;break;case"Header/TitleAlignment":qe.getOrCreateHeaderFooterStyle(e,0).textAlign=this._toTextAlign(s);break;case"Header/drawTitle":qe.getOrCreateHeaderFooterStyle(e,0).isVisible=s;break;case"Header/Subtitle":qe.getOrCreateHeaderFooterStyle(e,1).template=s;break;case"Header/SubtitleAlignment":qe.getOrCreateHeaderFooterStyle(e,1).textAlign=this._toTextAlign(s);break;case"Header/drawSubtitle":qe.getOrCreateHeaderFooterStyle(e,1).isVisible=s;break;case"Header/Artist":qe.getOrCreateHeaderFooterStyle(e,2).template=s;break;case"Header/ArtistAlignment":qe.getOrCreateHeaderFooterStyle(e,2).textAlign=this._toTextAlign(s);break;case"Header/drawArtist":qe.getOrCreateHeaderFooterStyle(e,2).isVisible=s;break;case"Header/Album":qe.getOrCreateHeaderFooterStyle(e,3).template=s;break;case"Header/AlbumAlignment":qe.getOrCreateHeaderFooterStyle(e,3).textAlign=this._toTextAlign(s);break;case"Header/drawAlbum":qe.getOrCreateHeaderFooterStyle(e,3).isVisible=s;break;case"Header/Words":qe.getOrCreateHeaderFooterStyle(e,4).template=s;break;case"Header/WordsAlignment":qe.getOrCreateHeaderFooterStyle(e,4).textAlign=this._toTextAlign(s);break;case"Header/drawWords":qe.getOrCreateHeaderFooterStyle(e,4).isVisible=s;break;case"Header/Music":qe.getOrCreateHeaderFooterStyle(e,5).template=s;break;case"Header/MusicAlignment":qe.getOrCreateHeaderFooterStyle(e,5).textAlign=this._toTextAlign(s);break;case"Header/drawMusic":qe.getOrCreateHeaderFooterStyle(e,5).isVisible=s;break;case"Header/WordsAndMusic":qe.getOrCreateHeaderFooterStyle(e,6).template=s;break;case"Header/WordsAndMusicAlignment":qe.getOrCreateHeaderFooterStyle(e,6).textAlign=this._toTextAlign(s);break;case"Header/drawWordsAndMusic":qe.getOrCreateHeaderFooterStyle(e,6).isVisible=s;break;case"Header/Tabber":qe.getOrCreateHeaderFooterStyle(e,7).template=s;break;case"Header/TabberAlignment":qe.getOrCreateHeaderFooterStyle(e,7).textAlign=this._toTextAlign(s);break;case"Header/drawTabber":qe.getOrCreateHeaderFooterStyle(e,7).isVisible=s;break;case"Footer/Copyright":qe.getOrCreateHeaderFooterStyle(e,8).template=s;break;case"Footer/CopyrightAlignment":qe.getOrCreateHeaderFooterStyle(e,8).textAlign=this._toTextAlign(s);break;case"Footer/drawCopyright":qe.getOrCreateHeaderFooterStyle(e,8).isVisible=s;break;case"Footer/Copyright2":qe.getOrCreateHeaderFooterStyle(e,9).template=s;break;case"Footer/Copyright2Alignment":qe.getOrCreateHeaderFooterStyle(e,9).textAlign=this._toTextAlign(s);break;case"Footer/drawCopyright2":qe.getOrCreateHeaderFooterStyle(e,9).isVisible=s}}_toTextAlign(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2}return 0}addValue(e,t,s){this.raw.set(e,t),void 0!==s&&this._types.set(e,s)}writeTo(e){Ps.writeInt32BE(e,this.raw.size);for(let[t,s]of this.raw){let i=this._getDataType(t,s);switch(bi.gpWriteString(e,t),e.writeByte(i),i){case 0:e.writeByte(s?1:0);break;case 1:Ps.writeInt32BE(e,s);break;case 2:Ps.writeFloat32BE(e,s);break;case 3:let t=Ps.stringToBytes(s);Ps.writeInt16BE(e,t.length),e.write(t,0,t.length);break;case 4:case 5:Ps.writeInt32BE(e,s.offset),Ps.writeInt32BE(e,s.value);break;case 6:Ps.writeInt32BE(e,s.x),Ps.writeInt32BE(e,s.y),Ps.writeInt32BE(e,s.w),Ps.writeInt32BE(e,s.h);break;case 7:e.writeByte(s.r),e.writeByte(s.g),e.writeByte(s.b),e.writeByte(s.a)}}}_getDataType(e,t){if(this._types.has(e))return this._types.get(e);let s=typeof t;switch(typeof t){case"string":return 3;case"number":return t===(0|t)?1:2;case"object":if(t instanceof T)return 4;if(t instanceof ms)return 6;if(t instanceof Jt)return 7}throw new u(0,`Unknown value type in BinaryStylesheet: ${s}`)}static writeForScore(t){let s=new e;switch(s.addValue("StandardNotation/hideDynamics",t.stylesheet.hideDynamics,0),s.addValue("System/bracketExtendMode",t.stylesheet.bracketExtendMode,1),s.addValue("Global/useSystemSignSeparator",t.stylesheet.useSystemSignSeparator,0),s.addValue("Global/DisplayTuning",t.stylesheet.globalDisplayTuning,0),s.addValue("Global/DrawChords",t.stylesheet.globalDisplayChordDiagramsOnTop,0),t.stylesheet.singleTrackTrackNamePolicy){case 0:s.addValue("System/showTrackNameSingle",!1,0);break;case 1:s.addValue("System/trackNameModeSingle",0,1);break;case 2:s.addValue("System/trackNameModeSingle",2,1)}switch(t.stylesheet.multiTrackTrackNamePolicy){case 0:s.addValue("System/showTrackNameMulti",!1,0);break;case 1:s.addValue("System/trackNameModeMulti",0,1);break;case 2:s.addValue("System/trackNameModeMulti",2,1)}switch(t.stylesheet.firstSystemTrackNameMode){case 0:s.addValue("System/shortTrackNameOnFirstSystem",!1,0);break;case 1:s.addValue("System/shortTrackNameOnFirstSystem",!0,0)}switch(t.stylesheet.otherSystemsTrackNameMode){case 0:s.addValue("System/shortTrackNameOnOtherSystems",!1,0);break;case 1:s.addValue("System/shortTrackNameOnOtherSystems",!0,0)}switch(t.stylesheet.firstSystemTrackNameOrientation){case 0:s.addValue("System/horizontalTrackNameOnFirstSystem",!0,0);break;case 1:s.addValue("System/horizontalTrackNameOnFirstSystem",!1,0)}switch(t.stylesheet.otherSystemsTrackNameOrientation){case 0:s.addValue("System/horizontalTrackNameOnOtherSystems",!0,0);break;case 1:s.addValue("System/horizontalTrackNameOnOtherSystems",!1,0)}let i=t.style;if(i)for(let[t,a]of i.headerAndFooter)switch(t){case 0:e._addHeaderAndFooter(s,a,"Header/","Title");break;case 1:e._addHeaderAndFooter(s,a,"Header/","Subtitle");break;case 2:e._addHeaderAndFooter(s,a,"Header/","Artist");break;case 3:e._addHeaderAndFooter(s,a,"Header/","Album");break;case 4:e._addHeaderAndFooter(s,a,"Header/","Words");break;case 5:e._addHeaderAndFooter(s,a,"Header/","Music");break;case 6:e._addHeaderAndFooter(s,a,"Header/","WordsAndMusic");break;case 7:e._addHeaderAndFooter(s,a,"Header/","Tabber");break;case 8:e._addHeaderAndFooter(s,a,"Footer/","Copyright");break;case 9:e._addHeaderAndFooter(s,a,"Footer/","Copyright2")}let a=Fs.withCapacity(128);return s.writeTo(a),a.toArray()}static _addHeaderAndFooter(e,t,s,i){e.addValue(`${s}${i}`,t.template,3),e.addValue(`${s}${i}Alignment`,t.textAlign,1),void 0!==t.isVisible&&e.addValue(`${s}draw${i}`,t.isVisible,0)}},Si=class{},ki=class{constructor(){this.id="",this.dots=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.value=4}},wi=class{constructor(){this.name="",this.path="",this.role="",this.program=0,this.bank=0}get uniqueId(){return`${this.path};${this.name};${this.role}`}},Ti=class e{constructor(){this._hasAnacrusis=!1,this._skipApplyLyrics=!1,this._backingTrackPadding=0,this._doubleBars=new Set,this._keySignatures=new Map,this._transposeKeySignaturePerTrack=new Map}parseXml(e,t){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._sustainPedalsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;let s=new Zs;try{s.parse(e)}catch(e){throw new Cs("Could not parse XML",e)}if(this._parseDom(s),this._buildModel(),qe.consolidate(this.score),this.score.finish(t),!this._skipApplyLyrics&&this._lyricsByTrack.size>0)for(let[e,t]of this._lyricsByTrack)this._tracksById.get(e).applyLyrics(t)}_parseDom(e){let t=e.firstElement;if(t){if("GPIF"!==t.localName)throw new Cs("Root node of XML was not GPIF");this.score=new Oe;for(let e of t.childElements())switch(e.localName){case"Score":this._parseScoreNode(e);break;case"MasterTrack":this._parseMasterTrackNode(e);break;case"BackingTrack":this._parseBackingTrackNode(e);break;case"Tracks":this._parseTracksNode(e);break;case"MasterBars":this._parseMasterBarsNode(e);break;case"Bars":this._parseBars(e);break;case"Voices":this._parseVoices(e);break;case"Beats":this._parseBeats(e);break;case"Notes":this._parseNotes(e);break;case"Rhythms":this._parseRhythms(e);break;case"Assets":this._parseAssets(e)}}}_parseAssets(e){for(let t of e.childElements())"Asset"===t.localName&&t.getAttribute("id")===this._backingTrackAssetId&&this._parseBackingTrackAsset(t)}_parseBackingTrackAsset(e){let t="";for(let s of e.childElements())"EmbeddedFilePath"===s.localName&&(t=s.innerText);let s=this.loadAsset;if(s){let e=s(t);e?this.score.backingTrack.rawAudioFile=e:this.score.backingTrack=void 0}}_parseScoreNode(t){for(let s of t.childElements())switch(s.localName){case"Title":this.score.title=s.innerText;break;case"SubTitle":this.score.subTitle=s.innerText;break;case"Artist":this.score.artist=s.innerText;break;case"Album":this.score.album=s.innerText;break;case"Words":this.score.words=s.innerText;break;case"Music":this.score.music=s.innerText;break;case"WordsAndMusic":let t=s.innerText;""!==t&&(t&&!this.score.words&&(this.score.words=t),t&&!this.score.music&&(this.score.music=t));break;case"Copyright":this.score.copyright=s.innerText;break;case"Tabber":this.score.tab=s.innerText;break;case"Instructions":this.score.instructions=s.innerText;break;case"Notices":this.score.notices=s.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=e._parseIntSafe(s.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=e._splitSafe(s.innerText).map(t=>e._parseIntSafe(t,4))}}static _parseIntSafe(e,t){if(!e)return t;let s=Number.parseInt(e,10);return Number.isNaN(s)?t:s}static _parseFloatSafe(e,t){if(!e)return t;let s=Number.parseFloat(e);return Number.isNaN(s)?t:s}static _splitSafe(e,t=" "){return e?e.split(t).map(e=>e.trim()).filter(e=>e.length>0):[]}_parseBackingTrackNode(t){let s=new Si,i=!1,a="",r="";for(let s of t.childElements())switch(s.localName){case"Enabled":i="true"===s.innerText;break;case"Source":a=s.innerText;break;case"AssetId":r=s.innerText;break;case"FramePadding":this._backingTrackPadding=e._parseIntSafe(s.innerText,0)/e._sampleRate*1e3}i&&"Local"===a&&(this.score.backingTrack=s,this._backingTrackAssetId=r)}_parseMasterTrackNode(t){for(let s of t.childElements())switch(s.localName){case"Automations":this._parseAutomations(s,this._masterTrackAutomations,null,null);break;case"Tracks":this._tracksMapping=e._splitSafe(s.innerText);break;case"Anacrusis":this._hasAnacrusis=!0}}_parseAutomations(e,t,s,i){for(let a of e.childElements())"Automation"===a.localName&&this._parseAutomation(a,t,s,i)}_parseAutomation(t,s,i,a){let r,n=null,o=!1,l=-1,h=0,d=0,c=null,u=0,p=null,m=!0;for(let s of t.childElements())switch(s.localName){case"Type":n=s.innerText;break;case"Linear":o="true"===s.innerText.toLowerCase();break;case"Bar":l=e._parseIntSafe(s.innerText,0);break;case"Position":h=e._parseFloatSafe(s.innerText,0);break;case"Value":if(s.firstElement&&3===s.firstElement.nodeType)c=s.innerText;else if(s.firstElement&&1===s.firstElement.nodeType&&"SyncPoint"===n){r=new k;for(let t of s.childElements())switch(t.localName){case"BarIndex":l=e._parseIntSafe(t.innerText,0);break;case"BarOccurrence":r.barOccurence=e._parseIntSafe(t.innerText,0);break;case"FrameOffset":let s=e._parseFloatSafe(t.innerText,0);r.millisecondOffset=s/e._sampleRate*1e3}}else{let t=e._splitSafe(s.innerText);1===t.length?(d=e._parseFloatSafe(t[0],0),u=1):(d=e._parseFloatSafe(t[0],0),u=e._parseIntSafe(t[1],0))}break;case"Text":p=s.innerText;break;case"Visible":m="true"===s.innerText.toLowerCase()}if(!n)return;let g=[];switch(n){case"Tempo":g.push(w.buildTempoAutomation(o,h,d,u,m));break;case"SyncPoint":let e=new w;e.type=4,e.isLinear=o,e.ratioPosition=h,e.syncPointValue=r,e.isVisible=m,g.push(e);break;case"Sound":if(c&&i&&i.has(c)){let e=new w;e.type=4,e.ratioPosition=h,e.value=i.get(c).bank,e.isVisible=m,g.push(e);let t=w.buildInstrumentAutomation(o,h,i.get(c).program);g.push(t)}break;case"SustainPedal":if(a){let e;a.has(l)?e=a.get(l):(e=[],a.set(l,e));let t=new ye;switch(t.ratioPosition=h,u){case 1:t.pedalType=0;break;case 3:t.pedalType=2}e.push(t)}}if(g.length){if(p)for(let e of g)e.text=p;if(l>=0){s.has(l)||s.set(l,[]);for(let e of g)s.get(l).push(e)}}}_parseTracksNode(e){for(let t of e.childElements())"Track"===t.localName&&this._parseTrack(t)}_parseTrack(t){this._articulationByName=new Map;let s=new ns;s.ensureStaveCount(1),s.staves[0].showStandardNotation=!0;let i=t.getAttribute("id");for(let a of t.childElements())switch(a.localName){case"Name":s.name=a.innerText;break;case"Color":let t=e._splitSafe(a.innerText);if(t.length>=3){let i=e._parseIntSafe(t[0],0),a=e._parseIntSafe(t[1],0),r=e._parseIntSafe(t[2],0);s.color=new Jt(i,a,r,255)}break;case"Instrument":let r=a.getAttribute("ref");(r.endsWith("-gs")||r.endsWith("GrandStaff"))&&(s.ensureStaveCount(2),s.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this._parseInstrumentSet(s,a);break;case"NotationPatch":this._parseNotationPatch(s,a);break;case"ShortName":s.shortName=a.innerText;break;case"SystemsDefautLayout":s.defaultSystemsLayout=e._parseIntSafe(a.innerText,4);break;case"SystemsLayout":s.systemsLayout=e._splitSafe(a.innerText).map(t=>e._parseIntSafe(t,4));break;case"Lyrics":this._parseLyrics(i,a);break;case"Properties":this._parseTrackProperties(s,a);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this._parseGeneralMidi(s,a);break;case"Sounds":this._parseSounds(i,s,a);break;case"PlaybackState":let n=a.innerText;s.playbackInfo.isSolo="Solo"===n,s.playbackInfo.isMute="Mute"===n;break;case"PartSounding":this._parsePartSounding(i,s,a);break;case"Staves":this._parseStaves(s,a);break;case"Transpose":this._parseTranspose(i,s,a);break;case"RSE":this._parseRSE(s,a);break;case"Automations":this._parseTrackAutomations(i,a)}this._tracksById.set(i,s)}_parseTrackAutomations(e,t){let s=new Map;this._automationsPerTrackIdAndBarIndex.set(e,s);let i=new Map;this._sustainPedalsPerTrackIdAndBarIndex.set(e,i),this._parseAutomations(t,s,this._soundsByTrack.get(e),i)}_parseNotationPatch(t,s){for(let i of s.childElements())switch(i.localName){case"LineCount":let s=e._parseIntSafe(i.innerText,5);for(let e of t.staves)e.standardNotationLineCount=s;break;case"Elements":this._parseElements(t,i)}}_parseInstrumentSet(t,s){for(let i of s.childElements())switch(i.localName){case"Type":if("drumKit"===i.innerText)for(let e of t.staves)e.isPercussion=!0;break;case"Elements":this._parseElements(t,i);break;case"LineCount":let s=e._parseIntSafe(i.innerText,5);for(let e of t.staves)e.standardNotationLineCount=s}}_parseElements(e,t){for(let s of t.childElements())"Element"===s.localName&&this._parseElement(e,s)}_parseElement(e,t){let s=t.findChildElement("Type")?.innerText??"";for(let i of t.childElements())switch(i.localName){case"Name":case"Articulations":this._parseArticulations(e,i,s)}}_parseArticulations(e,t,s){for(let i of t.childElements())"Articulation"===i.localName&&this._parseArticulation(e,i,s)}_parseArticulation(t,s,i){let a=new Qe;a.outputMidiNumber=-1,a.elementType=i;let r="";for(let t of s.childElements()){let s=t.innerText;switch(t.localName){case"Name":r=t.innerText;break;case"OutputMidiNumber":a.outputMidiNumber=e._parseIntSafe(s,0);break;case"TechniqueSymbol":a.techniqueSymbol=this._parseTechniqueSymbol(s);break;case"TechniquePlacement":switch(s){case"outside":a.techniqueSymbolPlacement=3;break;case"inside":a.techniqueSymbolPlacement=1;break;case"above":a.techniqueSymbolPlacement=0;break;case"below":a.techniqueSymbolPlacement=2}break;case"Noteheads":let i=e._splitSafe(s);i.length>=1&&(a.noteHeadDefault=this._parseNoteHead(i[0])),i.length>=2&&(a.noteHeadHalf=this._parseNoteHead(i[1])),i.length>=3&&(a.noteHeadWhole=this._parseNoteHead(i[2])),-1===a.noteHeadHalf&&(a.noteHeadHalf=a.noteHeadDefault),-1===a.noteHeadWhole&&(a.noteHeadWhole=a.noteHeadDefault);break;case"StaffLine":a.staffLine=e._parseIntSafe(s,0)}}-1!==a.outputMidiNumber?(t.percussionArticulations.push(a),r.length>0&&this._articulationByName.set(r,a)):r.length>0&&this._articulationByName.has(r)&&(this._articulationByName.get(r).staffLine=a.staffLine)}_parseTechniqueSymbol(e){switch(e){case"pictEdgeOfCymbal":return 59177;case"articStaccatoAbove":return 58530;case"noteheadParenthesis":return 57550;case"stringsUpBow":return 58898;case"stringsDownBow":return 58896;case"guitarGolpe":return 59458;default:return-1}}_parseNoteHead(e){switch(e){case"noteheadDoubleWholeSquare":return 57505;case"noteheadDoubleWhole":return 57504;case"noteheadWhole":return 57506;case"noteheadHalf":return 57507;case"noteheadBlack":return 57508;case"noteheadNull":return 57509;case"noteheadXOrnate":return 57514;case"noteheadTriangleUpWhole":return 57531;case"noteheadTriangleUpHalf":return 57532;case"noteheadTriangleUpBlack":return 57534;case"noteheadDiamondBlackWide":return 57564;case"noteheadDiamondWhite":return 57565;case"noteheadDiamondWhiteWide":return 57566;case"noteheadCircleX":return 57523;case"noteheadXWhole":return 57511;case"noteheadXHalf":return 57512;case"noteheadXBlack":return 57513;case"noteheadParenthesis":return 57550;case"noteheadSlashedBlack2":return 57552;case"noteheadCircleSlash":return 57591;case"noteheadHeavyX":return 57592;case"noteheadHeavyXHat":return 57593;default:return re.warning("GPIF","Unknown notehead symbol",e),-1}}_parseStaves(e,t){let s=0;for(let i of t.childElements())if("Staff"===i.localName){e.ensureStaveCount(s+1);let t=e.staves[s];this._parseStaff(t,i),s++}}_parseStaff(e,t){for(let s of t.childElements())"Properties"===s.localName&&this._parseStaffProperties(e,s)}_parseStaffProperties(e,t){for(let s of t.childElements())"Property"===s.localName&&this._parseStaffProperty(e,s)}_parseStaffProperty(t,s){switch(s.getAttribute("name")){case"Tuning":for(let i of s.childElements())switch(i.localName){case"Pitches":let a=e._splitSafe(s.findChildElement("Pitches")?.innerText),r=new Array(a.length);for(let t=0;t<r.length;t++)r[r.length-1-t]=e._parseIntSafe(a[t],0);t.stringTuning.tunings=r;break;case"Label":t.stringTuning.name=i.innerText}t.isPercussion||(t.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this._parseDiagramCollectionForStaff(t,s);break;case"CapoFret":let i=e._parseIntSafe(s.findChildElement("Fret")?.innerText,0);t.capo=i}}_parseLyrics(e,t){let s=[];for(let e of t.childElements())"Line"===e.localName&&s.push(this._parseLyricsLine(e));this._lyricsByTrack.set(e,s)}_parseLyricsLine(t){let s=new jt;for(let i of t.childElements())switch(i.localName){case"Offset":s.startBar=e._parseIntSafe(i.innerText,0);break;case"Text":s.text=i.innerText}return s}_parseDiagramCollectionForTrack(e,t){let s=t.findChildElement("Items");if(s)for(let t of s.childElements())"Item"===t.localName&&this._parseDiagramItemForTrack(e,t)}_parseDiagramCollectionForStaff(e,t){let s=t.findChildElement("Items");if(s)for(let t of s.childElements())"Item"===t.localName&&this._parseDiagramItemForStaff(e,t)}_parseDiagramItemForTrack(e,t){let s=new Yt,i=t.getAttribute("id");for(let t of e.staves)t.addChord(i,s);this._parseDiagramItemForChord(s,t)}_parseDiagramItemForStaff(e,t){let s=new Yt,i=t.getAttribute("id");e.addChord(i,s),this._parseDiagramItemForChord(s,t)}_parseDiagramItemForChord(t,s){t.name=s.getAttribute("name");let i=s.findChildElement("Diagram");if(!i)return t.showDiagram=!1,void(t.showFingering=!1);let a=e._parseIntSafe(i.getAttribute("stringCount"),6),r=e._parseIntSafe(i.getAttribute("baseFret"),0);t.firstFret=r+1;for(let e=0;e<a;e++)t.strings.push(-1);for(let s of i.childElements())switch(s.localName){case"Fret":let i=e._parseIntSafe(s.getAttribute("string"),0);t.strings[a-i-1]=r+e._parseIntSafe(s.getAttribute("fret"),0);break;case"Fingering":let n=new Map;for(let i of s.childElements())if("Position"===i.localName){let s=-2,a=r+e._parseIntSafe(i.getAttribute("fret"),0);switch(i.getAttribute("finger")){case"Index":s=1;break;case"Middle":s=2;break;case"Rank":s=3;break;case"Pinky":s=4;break;case"Thumb":s=0}-2!==s&&(n.has(s)?t.barreFrets.push(a):n.set(s,!0))}break;case"Property":switch(s.getAttribute("name")){case"ShowName":t.showName="true"===s.getAttribute("value");break;case"ShowDiagram":t.showDiagram="true"===s.getAttribute("value");break;case"ShowFingering":t.showFingering="true"===s.getAttribute("value")}}}_parseTrackProperties(e,t){for(let s of t.childElements())"Property"===s.localName&&this._parseTrackProperty(e,s)}_parseTrackProperty(t,s){switch(s.getAttribute("name")){case"Tuning":let i=e._splitSafe(s.findChildElement("Pitches")?.innerText),a=new Array(i.length);for(let t=0;t<a.length;t++)a[a.length-1-t]=e._parseIntSafe(i[t],0);for(let e of t.staves)e.stringTuning.tunings=a,e.showStandardNotation=!0,e.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this._parseDiagramCollectionForTrack(t,s);break;case"CapoFret":let r=e._parseIntSafe(s.findChildElement("Fret")?.innerText,0);for(let e of t.staves)e.capo=r}}_parseGeneralMidi(t,s){for(let i of s.childElements())switch(i.localName){case"Program":t.playbackInfo.program=e._parseIntSafe(i.innerText,0);break;case"Port":t.playbackInfo.port=e._parseIntSafe(i.innerText,0);break;case"PrimaryChannel":t.playbackInfo.primaryChannel=e._parseIntSafe(i.innerText,0);break;case"SecondaryChannel":t.playbackInfo.secondaryChannel=e._parseIntSafe(i.innerText,0)}if("Percussion"===s.getAttribute("table"))for(let e of t.staves)e.isPercussion=!0}_parseSounds(e,t,s){for(let i of s.childElements())"Sound"===i.localName&&this._parseSound(e,t,i)}_parseSound(e,t,s){let i=new wi;for(let e of s.childElements())switch(e.localName){case"Name":i.name=e.innerText;break;case"Path":i.path=e.innerText;break;case"Role":i.role=e.innerText;break;case"MIDI":this._parseSoundMidi(i,e)}this._soundsByTrack.has(e)||(this._soundsByTrack.set(e,new Map),t.playbackInfo.program=i.program,t.playbackInfo.bank=i.bank),this._soundsByTrack.get(e).set(i.uniqueId,i)}_parseSoundMidi(t,s){let i=0,a=0;for(let r of s.childElements())switch(r.localName){case"Program":t.program=e._parseIntSafe(r.innerText,0);break;case"MSB":i=e._parseIntSafe(r.innerText,0);break;case"LSB":a=e._parseIntSafe(r.innerText,0)}t.bank=(127&i)<<7|a}_parsePartSounding(t,s,i){for(let a of i.childElements())switch(a.localName){case"TranspositionPitch":for(let t of s.staves)t.displayTranspositionPitch=e._parseIntSafe(a.innerText,0);break;case"NominalKey":let i=Math.max(0,Zt.noteNames.indexOf(a.innerText));this._transposeKeySignaturePerTrack.set(t,i)}}_parseTranspose(t,s,i){let a=0,r=0;for(let t of i.childElements())switch(t.localName){case"Chromatic":r=e._parseIntSafe(t.innerText,0);break;case"Octave":a=e._parseIntSafe(t.innerText,0)}let n=12*a+r;for(let e of s.staves)e.displayTranspositionPitch=n;let o=qe.flooredDivision(n,12);this._transposeKeySignaturePerTrack.set(t,o)}_parseRSE(e,t){for(let s of t.childElements())"ChannelStrip"===s.localName&&this._parseChannelStrip(e,s)}_parseChannelStrip(e,t){for(let s of t.childElements())"Parameters"===s.localName&&this._parseChannelStripParameters(e,s)}_parseChannelStripParameters(t,s){if(s.firstChild&&s.firstChild.value){let i=e._splitSafe(s.firstChild.value);i.length>=12&&(t.playbackInfo.balance=Math.floor(16*e._parseFloatSafe(i[11],.5)),t.playbackInfo.volume=Math.floor(16*e._parseFloatSafe(i[12],.9)))}}_parseMasterBarsNode(e){for(let t of e.childElements())"MasterBar"===t.localName&&this._parseMasterBar(t)}_parseMasterBar(t){let s=new We;0===this._masterBars.length&&this._hasAnacrusis&&(s.isAnacrusis=!0);for(let i of t.childElements())switch(i.localName){case"Time":let t=i.innerText.split("/");s.timeSignatureNumerator=e._parseIntSafe(t[0],4),s.timeSignatureDenominator=e._parseIntSafe(t[1],4);break;case"FreeTime":s.isFreeTime=!0;break;case"DoubleBar":s.isDoubleBar=!0,this._doubleBars.add(s);break;case"Section":s.section=new Kt,s.section.marker=i.findChildElement("Letter")?.innerText??"",s.section.text=i.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===i.getAttribute("start").toLowerCase()&&(s.isRepeatStart=!0),"true"===i.getAttribute("end").toLowerCase()&&i.getAttribute("count")&&(s.repeatCount=e._parseIntSafe(i.getAttribute("count"),1));break;case"AlternateEndings":let a=e._splitSafe(i.innerText),r=0;for(let t=0;t<a.length;t++)r|=1<<-1+e._parseIntSafe(a[t],0);s.alternateEndings=r;break;case"Bars":this._barsOfMasterBar.push(e._splitSafe(i.innerText));break;case"TripletFeel":switch(i.innerText){case"NoTripletFeel":s.tripletFeel=0;break;case"Triplet8th":s.tripletFeel=2;break;case"Triplet16th":s.tripletFeel=1;break;case"Dotted8th":s.tripletFeel=4;break;case"Dotted16th":s.tripletFeel=3;break;case"Scottish8th":s.tripletFeel=6;break;case"Scottish16th":s.tripletFeel=5}break;case"Key":let n=e._parseIntSafe(i.findChildElement("AccidentalCount")?.innerText,0),o=i.findChildElement("Mode"),l=0;if(o)switch(o.innerText.toLowerCase()){case"major":l=0;break;case"minor":l=1}this._keySignatures.set(this._masterBars.length,[n,l]);break;case"Fermatas":this._parseFermatas(s,i);break;case"XProperties":this._parseMasterBarXProperties(s,i);break;case"Directions":this._parseDirections(s,i)}this._masterBars.push(s)}_parseDirections(e,t){for(let s of t.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":e.addDirection(3);break;case"DoubleCoda":e.addDirection(4);break;case"Segno":e.addDirection(1);break;case"SegnoSegno":e.addDirection(2);break;case"Fine":e.addDirection(0)}break;case"Jump":switch(s.innerText){case"DaCapo":e.addDirection(5);break;case"DaCapoAlCoda":e.addDirection(6);break;case"DaCapoAlDoubleCoda":e.addDirection(7);break;case"DaCapoAlFine":e.addDirection(8);break;case"DaSegno":e.addDirection(9);break;case"DaSegnoAlCoda":e.addDirection(10);break;case"DaSegnoAlDoubleCoda":e.addDirection(11);break;case"DaSegnoAlFine":e.addDirection(12);break;case"DaSegnoSegno":e.addDirection(13);break;case"DaSegnoSegnoAlCoda":e.addDirection(14);break;case"DaSegnoSegnoAlDoubleCoda":e.addDirection(15);break;case"DaSegnoSegnoAlFine":e.addDirection(16);break;case"DaCoda":e.addDirection(17);break;case"DaDoubleCoda":e.addDirection(18)}}}_parseFermatas(e,t){for(let s of t.childElements())"Fermata"===s.localName&&this._parseFermata(e,s)}_parseFermata(t,s){let i=0,a=new At;for(let t of s.childElements())switch(t.localName){case"Type":switch(t.innerText){case"Short":a.type=0;break;case"Medium":a.type=1;break;case"Long":a.type=2}break;case"Length":a.length=e._parseFloatSafe(t.innerText,0);break;case"Offset":let s=t.innerText.split("/");if(2===s.length){i=e._parseIntSafe(s[0],4)/e._parseIntSafe(s[1],4)*_.QuarterTime|0}}t.addFermata(i,a)}_parseBars(e){for(let t of e.childElements())"Bar"===t.localName&&this._parseBar(t)}_parseBar(t){let s=new Be,i=t.getAttribute("id");for(let a of t.childElements())switch(a.localName){case"Voices":this._voicesOfBar.set(i,e._splitSafe(a.innerText));break;case"Clef":switch(a.innerText){case"Neutral":s.clef=0;break;case"G2":s.clef=4;break;case"F4":s.clef=3;break;case"C4":s.clef=2;break;case"C3":s.clef=1}break;case"Ottavia":switch(a.innerText){case"8va":s.clefOttava=1;break;case"15ma":s.clefOttava=0;break;case"8vb":s.clefOttava=3;break;case"15mb":s.clefOttava=4}break;case"SimileMark":switch(a.innerText){case"Simple":s.simileMark=1;break;case"FirstOfDouble":s.simileMark=2;break;case"SecondOfDouble":s.simileMark=3}break;case"XProperties":this._parseBarXProperties(a,s)}this._barsById.set(i,s)}_parseVoices(e){for(let t of e.childElements())"Voice"===t.localName&&this._parseVoice(t)}_parseVoice(t){let s=new Me,i=t.getAttribute("id");for(let s of t.childElements())"Beats"===s.localName&&this._beatsOfVoice.set(i,e._splitSafe(s.innerText));this._voiceById.set(i,s)}_parseBeats(e){for(let t of e.childElements())"Beat"===t.localName&&this._parseBeat(t)}_parseBeat(t){let s=new wt,i=t.getAttribute("id");for(let a of t.childElements())switch(a.localName){case"Notes":this._notesOfBeat.set(i,e._splitSafe(a.innerText));break;case"Rhythm":this._rhythmOfBeat.set(i,a.getAttribute("ref"));break;case"Fadding":switch(a.innerText){case"FadeIn":s.fade=1;break;case"FadeOut":s.fade=2;break;case"VolumeSwell":s.fade=3}break;case"Tremolo":switch(a.innerText){case"1/2":s.tremoloSpeed=8;break;case"1/4":s.tremoloSpeed=16;break;case"1/8":s.tremoloSpeed=32}break;case"Chord":s.chordId=a.innerText;break;case"Hairpin":switch(a.innerText){case"Crescendo":s.crescendo=1;break;case"Decrescendo":s.crescendo=2}break;case"Arpeggio":"Up"===a.innerText?s.brushType=3:s.brushType=4;break;case"Properties":this._parseBeatProperties(a,s);break;case"XProperties":this._parseBeatXProperties(a,s);break;case"FreeText":s.text=a.innerText;break;case"TransposedPitchStemOrientation":switch(a.innerText){case"Upward":s.preferredBeamDirection=0;break;case"Downward":s.preferredBeamDirection=1}break;case"Dynamic":switch(a.innerText){case"PPP":s.dynamics=0;break;case"PP":s.dynamics=1;break;case"P":s.dynamics=2;break;case"MP":s.dynamics=3;break;case"MF":s.dynamics=4;break;case"F":s.dynamics=5;break;case"FF":s.dynamics=6;break;case"FFF":s.dynamics=7}break;case"GraceNotes":switch(a.innerText){case"OnBeat":s.graceType=1;break;case"BeforeBeat":s.graceType=2}break;case"Legato":"true"===a.getAttribute("origin")&&(s.isLegatoOrigin=!0);break;case"Whammy":let t=new T(0,0);t.value=this._toBendValue(e._parseFloatSafe(a.getAttribute("originValue"),0)),t.offset=this._toBendOffset(e._parseFloatSafe(a.getAttribute("originOffset"),0)),s.addWhammyBarPoint(t);let r=new T(0,0);r.value=this._toBendValue(e._parseFloatSafe(a.getAttribute("middleValue"),0)),r.offset=this._toBendOffset(e._parseFloatSafe(a.getAttribute("middleOffset1"),0)),s.addWhammyBarPoint(r);let n=new T(0,0);n.value=this._toBendValue(e._parseFloatSafe(a.getAttribute("middleValue"),0)),n.offset=this._toBendOffset(e._parseFloatSafe(a.getAttribute("middleOffset2"),0)),s.addWhammyBarPoint(n);let o=new T(0,0);o.value=this._toBendValue(e._parseFloatSafe(a.getAttribute("destinationValue"),0)),o.offset=this._toBendOffset(e._parseFloatSafe(a.getAttribute("destinationOffset"),0)),s.addWhammyBarPoint(o);break;case"Ottavia":switch(a.innerText){case"8va":s.ottava=1;break;case"8vb":s.ottava=3;break;case"15ma":s.ottava=0;break;case"15mb":s.ottava=4}break;case"Lyrics":s.lyrics=this._parseBeatLyrics(a),this._skipApplyLyrics=!0;break;case"Slashed":s.slashed=!0;break;case"DeadSlapped":s.deadSlapped=!0;break;case"Golpe":switch(a.innerText){case"Finger":s.golpe=2;break;case"Thumb":s.golpe=1}break;case"Wah":switch(a.innerText){case"Open":s.wahPedal=1;break;case"Closed":s.wahPedal=2}break;case"UserTransposedPitchStemOrientation":switch(a.innerText){case"Downward":s.preferredBeamDirection=1;break;case"Upward":s.preferredBeamDirection=0}break;case"Timer":s.showTimer=!0,s.timer=e._parseIntSafe(a.innerText,-1),s.timer<0&&(s.timer=null)}this._beatById.set(i,s)}_parseBeatLyrics(e){let t=[];for(let s of e.childElements())"Line"===s.localName&&t.push(s.innerText);return t}_parseBeatXProperties(t,s){for(let i of t.childElements())if("XProperty"===i.localName){let t=0;switch(i.getAttribute("id")){case"1124204546":switch(t=e._parseIntSafe(i.findChildElement("Int")?.innerText,0),t){case 1:s.beamingMode=2;break;case 2:s.beamingMode=1}break;case"1124204552":t=e._parseIntSafe(i.findChildElement("Int")?.innerText,0),1===t&&1!==s.beamingMode&&(s.beamingMode=3);break;case"1124204545":t=e._parseIntSafe(i.findChildElement("Int")?.innerText,0),s.invertBeamDirection=1===t;break;case"687935489":t=e._parseIntSafe(i.findChildElement("Int")?.innerText,0),s.brushDuration=t}}}_parseBarXProperties(t,s){for(let i of t.childElements())if("XProperty"===i.localName)if("1124139520"===i.getAttribute("id")){let t=i.findChildElement("Double")??i.findChildElement("Float");s.displayScale=e._parseFloatSafe(t?.innerText,1)}}_parseMasterBarXProperties(t,s){for(let i of s.childElements())"XProperty"===i.localName&&"1124073984"===i.getAttribute("id")&&(t.displayScale=e._parseFloatSafe(i.findChildElement("Double")?.innerText,1))}_parseBeatProperties(t,s){let i=!1,a=null,r=null,n=null,o=null,l=null;for(let h of t.childElements())if("Property"===h.localName)switch(h.getAttribute("name")){case"Brush":"Up"===h.findChildElement("Direction")?.innerText?s.brushType=1:s.brushType=2;break;case"PickStroke":"Up"===h.findChildElement("Direction")?.innerText?s.pickStroke=1:s.pickStroke=2;break;case"Slapped":h.findChildElement("Enable")&&(s.slap=!0);break;case"Popped":h.findChildElement("Enable")&&(s.pop=!0);break;case"VibratoWTremBar":switch(h.findChildElement("Strength")?.innerText){case"Wide":s.vibrato=2;break;case"Slight":s.vibrato=1}break;case"WhammyBar":i=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":a||(a=new T(0,0)),a.value=this._toBendValue(e._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":a||(a=new T(0,0)),a.offset=this._toBendOffset(e._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":r=this._toBendValue(e._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":n=this._toBendOffset(e._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":o=this._toBendOffset(e._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":l||(l=new T(T.MaxPosition,0)),l.value=this._toBendValue(e._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":l||(l=new T(0,0)),l.offset=this._toBendOffset(e._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"BarreFret":s.barreFret=e._parseIntSafe(h.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(h.findChildElement("String")?.innerText){case"0":s.barreShape=1;break;case"1":s.barreShape=2}break;case"Rasgueado":switch(h.findChildElement("Rasgueado")?.innerText){case"ii_1":s.rasgueado=1;break;case"mi_1":s.rasgueado=2;break;case"mii_1":s.rasgueado=3;break;case"mii_2":s.rasgueado=4;break;case"pmp_1":s.rasgueado=5;break;case"pmp_2":s.rasgueado=6;break;case"pei_1":s.rasgueado=7;break;case"pei_2":s.rasgueado=8;break;case"pai_1":s.rasgueado=9;break;case"pai_2":s.rasgueado=10;break;case"ami_1":s.rasgueado=11;break;case"ami_2":s.rasgueado=12;break;case"ppp_1":s.rasgueado=13;break;case"amii_1":s.rasgueado=14;break;case"amip_1":s.rasgueado=15;break;case"eami_1":s.rasgueado=16;break;case"eamii_1":s.rasgueado=17;break;case"peami_1":s.rasgueado=18}}i&&(a||(a=new T(0,0)),l||(l=new T(T.MaxPosition,0)),s.addWhammyBarPoint(a),n&&r&&s.addWhammyBarPoint(new T(n,r)),o&&r&&s.addWhammyBarPoint(new T(o,r)),!n&&!o&&r&&s.addWhammyBarPoint(new T(T.MaxPosition/2|0,r)),s.addWhammyBarPoint(l))}_parseNotes(e){for(let t of e.childElements())"Note"===t.localName&&this._parseNote(t)}_parseNote(t){let s=new nt,i=t.getAttribute("id");for(let a of t.childElements())switch(a.localName){case"Properties":this._parseNoteProperties(a,s,i);break;case"AntiAccent":"normal"===a.innerText.toLowerCase()&&(s.isGhost=!0);break;case"LetRing":s.isLetRing=!0;break;case"Trill":s.trillValue=e._parseIntSafe(a.innerText,-1),s.trillSpeed=16;break;case"Accent":let t=e._parseIntSafe(a.innerText,0);!!(1&t)&&(s.isStaccato=!0),!!(4&t)&&(s.accentuated=2),!!(8&t)&&(s.accentuated=1),16&t&&(s.accentuated=3);break;case"Tie":"true"===a.getAttribute("destination").toLowerCase()&&(s.isTieDestination=!0);break;case"Vibrato":switch(a.innerText){case"Slight":s.vibrato=1;break;case"Wide":s.vibrato=2}break;case"LeftFingering":switch(a.innerText){case"P":s.leftHandFinger=0;break;case"I":s.leftHandFinger=1;break;case"M":s.leftHandFinger=2;break;case"A":s.leftHandFinger=3;break;case"C":s.leftHandFinger=4}break;case"RightFingering":switch(a.innerText){case"P":s.rightHandFinger=0;break;case"I":s.rightHandFinger=1;break;case"M":s.rightHandFinger=2;break;case"A":s.rightHandFinger=3;break;case"C":s.rightHandFinger=4}break;case"InstrumentArticulation":s.percussionArticulation=e._parseIntSafe(a.innerText,0);break;case"Ornament":switch(a.innerText){case"Turn":s.ornament=2;break;case"InvertedTurn":s.ornament=1;break;case"UpperMordent":s.ornament=3;break;case"LowerMordent":s.ornament=4}}this._noteById.set(i,s)}_parseNoteProperties(t,s,i){let a=!1,r=null,n=null,o=null,l=null,h=null,d=-1,c=-1,u=!1;for(let p of t.childElements())if("Property"===p.localName)switch(p.getAttribute("name")){case"ShowStringNumber":p.findChildElement("Enable")&&(s.showStringNumber=!0);break;case"String":s.string=e._parseIntSafe(p.findChildElement("String")?.innerText,0)+1;break;case"Fret":s.fret=e._parseIntSafe(p.findChildElement("Fret")?.innerText,0);break;case"Element":d=e._parseIntSafe(p.findChildElement("Element")?.innerText,0);break;case"Variation":c=e._parseIntSafe(p.findChildElement("Variation")?.innerText,0);break;case"Tapped":this._tappedNotes.set(i,!0);break;case"HarmonicType":let t=p.findChildElement("HType");if(t)switch(t.innerText){case"NoHarmonic":s.harmonicType=0;break;case"Natural":s.harmonicType=1;break;case"Artificial":s.harmonicType=2;break;case"Pinch":s.harmonicType=3;break;case"Tap":s.harmonicType=4;break;case"Semi":s.harmonicType=5;break;case"Feedback":s.harmonicType=6}break;case"HarmonicFret":let m=p.findChildElement("HFret");m&&(s.harmonicValue=e._parseFloatSafe(m.innerText,0));break;case"Muted":p.findChildElement("Enable")&&(s.isDead=!0);break;case"PalmMuted":p.findChildElement("Enable")&&(s.isPalmMute=!0);break;case"Octave":s.octave=e._parseIntSafe(p.findChildElement("Number")?.innerText,0),-1===s.tone&&(s.tone=0);break;case"Tone":s.tone=e._parseIntSafe(p.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":u||this._parseConcertPitch(p,s);break;case"TransposedPitch":s.accidentalMode=0,this._parseConcertPitch(p,s),u=!0;break;case"Bended":a=!0;break;case"BendOriginValue":r||(r=new T(0,0)),r.value=this._toBendValue(e._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":r||(r=new T(0,0)),r.offset=this._toBendOffset(e._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":n=this._toBendValue(e._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":o=this._toBendOffset(e._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":l=this._toBendOffset(e._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":h||(h=new T(T.MaxPosition,0)),h.value=this._toBendValue(e._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":h||(h=new T(0,0)),h.offset=this._toBendOffset(e._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":p.findChildElement("Enable")&&(s.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":s.isLeftHandTapped=!0;break;case"Slide":let g=e._parseIntSafe(p.findChildElement("Flags")?.innerText,0);1&g?s.slideOutType=1:2&g?s.slideOutType=2:4&g?s.slideOutType=4:!!(8&g)&&(s.slideOutType=3),16&g?s.slideInType=1:!!(32&g)&&(s.slideInType=2),64&g?s.slideOutType=5:128&g&&(s.slideOutType=6)}a&&(r||(r=new T(0,0)),h||(h=new T(T.MaxPosition,0)),s.addBendPoint(r),o&&n&&s.addBendPoint(new T(o,n)),l&&n&&s.addBendPoint(new T(l,n)),!o&&!l&&n&&s.addBendPoint(new T(T.MaxPosition/2|0,n)),s.addBendPoint(h)),-1!==d&&-1!==c&&(s.percussionArticulation=et.articulationFromElementVariation(d,c))}_parseConcertPitch(e,t){let s=e.findChildElement("Pitch");if(s)for(let e of s.childElements())if("Accidental"===e.localName)switch(e.innerText){case"x":t.accidentalMode=4;break;case"#":t.accidentalMode=3;break;case"b":t.accidentalMode=5;break;case"bb":t.accidentalMode=6}}_toBendValue(t){return t*e._bendPointValueFactor|0}_toBendOffset(t){return t*e._bendPointPositionFactor}_parseRhythms(e){for(let t of e.childElements())"Rhythm"===t.localName&&this._parseRhythm(t)}_parseRhythm(t){let s=new ki,i=t.getAttribute("id");s.id=i;for(let i of t.childElements())switch(i.localName){case"NoteValue":switch(i.innerText){case"Long":s.value=-4;break;case"DoubleWhole":s.value=-2;break;case"Whole":s.value=1;break;case"Half":s.value=2;break;case"Quarter":s.value=4;break;case"Eighth":s.value=8;break;case"16th":s.value=16;break;case"32nd":s.value=32;break;case"64th":s.value=64;break;case"128th":s.value=128;break;case"256th":s.value=256}break;case"PrimaryTuplet":s.tupletNumerator=e._parseIntSafe(i.getAttribute("num"),-1),s.tupletDenominator=e._parseIntSafe(i.getAttribute("den"),-1);break;case"AugmentationDot":s.dots=e._parseIntSafe(i.getAttribute("count"),0)}this._rhythmById.set(i,s)}_buildModel(){for(let e=0,t=this._masterBars.length;e<t;e++){let t=this._masterBars[e];this.score.addMasterBar(t)}let t=this._masterBars[this._masterBars.length-1];this._doubleBars.has(t)&&(this._doubleBars.delete(t),t.isDoubleBar=!1);let s,i=[];for(let e of this._tracksMapping){if(!e)continue;let t=this._tracksById.get(e);this.score.addTrack(t),i.push(e)}for(let t of this._barsOfMasterBar){let a=0,r=0;s=[0,0],this._transposeKeySignaturePerTrack.has(i[0])&&(s=[qe.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(i[0])),s[1]]);for(let n=0;n<t.length&&r<this.score.tracks.length;n++){let o=t[n];if(o!==e._invalidId){let t=this._barsById.get(o),n=this.score.tracks[r],l=n.staves[a];l.addBar(t);let h=l.bars.length-1;if(this._keySignatures.has(h)&&(s=this._keySignatures.get(h),this._transposeKeySignaturePerTrack.has(i[r])&&(s=[qe.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(i[r])),s[1]])),t.keySignature=s[0],t.keySignatureType=s[1],this._doubleBars.has(t.masterBar)&&(t.barLineRight=7),this._voicesOfBar.has(o))for(let s of this._voicesOfBar.get(o))if(s!==e._invalidId){let i=this._voiceById.get(s);if(t.addVoice(i),this._beatsOfVoice.has(s))for(let t of this._beatsOfVoice.get(s))if(t!==e._invalidId){let s=Pt.clone(this._beatById.get(t));i.addBeat(s);let a=this._rhythmOfBeat.get(t),r=this._rhythmById.get(a);if(s.duration=r.value,s.dots=r.dots,s.tupletNumerator=r.tupletNumerator,s.tupletDenominator=r.tupletDenominator,this._notesOfBeat.has(t))for(let i of this._notesOfBeat.get(t))if(i!==e._invalidId){let e=Bt.clone(this._noteById.get(i));l.isPercussion?(e.fret=-1,e.string=-1):e.percussionArticulation=-1,s.addNote(e),this._tappedNotes.has(i)&&(s.tap=!0)}}}else{let e=new Me;t.addVoice(e);let s=new wt;s.isEmpty=!0,s.duration=4,e.addBeat(s)}a===n.staves.length-1?(r++,a=0):a++,s=[0,0],r<i.length&&this._transposeKeySignaturePerTrack.has(i[r])&&(s=[qe.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(i[r])),s[1]])}else r++}}for(let e of this._tracksMapping){if(!e)continue;let t=this._tracksById.get(e),s=!1;for(let e of t.staves)if(e.isPercussion){s=!0;break}if(s||(t.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(e)){let s=this._automationsPerTrackIdAndBarIndex.get(e);for(let[e,i]of s)if(t.staves.length>0&&e<t.staves[0].bars.length){let s=t.staves[0].bars[e];if(s.voices.length>0&&s.voices[0].beats.length>0){let e=s.voices[0].beats[0];for(let t of i)4===t.type&&0===t.value&&0===s.index||e.automations.push(t)}}}if(this._sustainPedalsPerTrackIdAndBarIndex.has(e)){let s=this._sustainPedalsPerTrackIdAndBarIndex.get(e);for(let[e,i]of s)if(t.staves.length>0&&e<t.staves[0].bars.length){t.staves[0].bars[e].sustainPedals=i}}}for(let[e,t]of this._masterTrackAutomations){let s=this.score.masterBars[e];for(let e=0,i=t.length;e<i;e++){let i=t[e];switch(i.type){case 0:s.tempoAutomations.push(i);break;case 4:i.syncPointValue.millisecondOffset-=this._backingTrackPadding,s.addSyncPoint(i)}}}}};Ti._invalidId="-1",Ti._bendPointPositionFactor=T.MaxPosition/100,Ti._bendPointValueFactor=.04,Ti._sampleRate=44100;var Bi=Ti,xi=class{constructor(){this.isMultiRest=!1,this.trackViewGroups=[]}},vi=class{constructor(){this.showNumbered=!1,this.showSlash=!1,this.showStandardNotation=!1,this.showTablature=!1}},Pi=class{constructor(e){this.scoreViews=[];let t=Fs.fromBuffer(e),s=Ps.readInt32BE(t);for(let e=0;e<s;e++){let e=new xi;this.scoreViews.push(e),e.isMultiRest=bi.gpReadBool(t);let s=Ps.readInt32BE(t);for(let i=0;i<s;i++){let s=t.readByte();0===s&&(s=1);let i=new vi;i.showStandardNotation=!!(1&s),i.showTablature=!!(2&s),i.showSlash=!!(4&s),i.showNumbered=!!(8&s),e.trackViewGroups.push(i)}}}apply(e){if(this.scoreViews.length>0){let t=0;e.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(let s of this.scoreViews[0].trackViewGroups){if(t<e.tracks.length){let i=e.tracks[t];for(let e of i.staves)e.isPercussion||(e.showTablature=s.showTablature),e.showStandardNotation=s.showStandardNotation,e.showSlash=s.showSlash,e.showNumbered=s.showNumbered}t++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(e.stylesheet.perTrackMultiBarRest||(e.stylesheet.perTrackMultiBarRest=new Set),t=s-1,e.stylesheet.perTrackMultiBarRest.add(t))}}static writeForScore(e){let t=Fs.withCapacity(128),s=[new xi];s[0].isMultiRest=e.stylesheet.multiTrackMultiBarRest;for(let t of e.tracks){let i=new vi;i.showStandardNotation=t.staves[0].showStandardNotation,i.showTablature=t.staves[0].showTablature,i.showSlash=t.staves[0].showSlash,i.showNumbered=t.staves[0].showNumbered,s[0].trackViewGroups.push(i);let a=new xi;a.isMultiRest=!0===e.stylesheet.perTrackMultiBarRest?.has(t.index),a.trackViewGroups.push(i),s.push(a)}Ps.writeInt32BE(t,s.length);for(let e of s){t.writeByte(e.isMultiRest?1:0),Ps.writeInt32BE(t,e.trackViewGroups.length);for(let s of e.trackViewGroups){let e=0;s.showStandardNotation&&(e|=1),s.showTablature&&(e|=2),s.showSlash&&(e|=4),s.showNumbered&&(e|=8),t.writeByte(e)}}return Ps.writeInt32BE(t,1),t.toArray()}},Ni=class{constructor(){this.trackViewGroups=[]}},Mi=class{constructor(){this.isVisible=!1}},Ei=class{constructor(e,t){this.zoomLevel=4,this.view=0,this.muiltiVoiceCursor=!1,this.scoreViews=[];let s=Fs.fromBuffer(t);this.zoomLevel=Ps.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=0!==s.readByte();let i=e.scoreViews.length;for(let t=0;t<i;t++){let i=new Ni;this.scoreViews.push(i);let a=e.scoreViews[t];for(let e=0;e<a.trackViewGroups.length;e++){let e=new Mi;e.isVisible=0!==s.readByte(),i.trackViewGroups.push(e)}}}apply(e){if(this.scoreViews.length>0){let t=0;for(let s of this.scoreViews[0].trackViewGroups){if(t<e.tracks.length){e.tracks[t].isVisibleOnMultiTrack=s.isVisible}t++}}}static writeForScore(e){let t=Fs.withCapacity(128);Ps.writeInt32BE(t,4),t.writeByte(0);let s=e.tracks.length>0&&e.tracks[0].staves[0].bars[0].isMultiVoice;t.writeByte(s?255:0);for(let s of e.tracks)t.writeByte(s.isVisibleOnMultiTrack?255:0);for(let s of e.tracks)t.writeByte(255);return t.toArray()}},Li=class extends Ls{get name(){return"Guitar Pro 7-8"}readScore(){re.debug(this.name,"Loading ZIP entries");let e,t=new $s(this.data);try{e=t.read()}catch(e){throw new Cs("No Zip archive",e)}re.debug(this.name,"Zip entries loaded");let s=null,i=null,a=null,r=null,n=new Map;for(let t of e)switch(n.set(t.fullName,t),t.fileName){case"score.gpif":s=Ps.toString(t.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=t.data;break;case"PartConfiguration":a=t.data;break;case"LayoutConfiguration":r=t.data}if(!s)throw new Cs("No score.gpif found in zip archive");re.debug(this.name,"Start Parsing score.gpif");let o=new Bi;o.loadAsset=e=>{if(n.has(e))return n.get(e).data},o.parseXml(s,this.settings),re.debug(this.name,"score.gpif parsed");let l=o.score;i&&(re.debug(this.name,"Start Parsing BinaryStylesheet"),new _i(i).apply(l),re.debug(this.name,"BinaryStylesheet parsed"));let h=null;return a&&(re.debug(this.name,"Start Parsing Part Configuration"),h=new Pi(a),h.apply(l),re.debug(this.name,"Part Configuration parsed")),r&&null!=h&&(re.debug(this.name,"Start Parsing Layout Configuration"),new Ei(h,r).apply(l),re.debug(this.name,"Layout Configuration parsed")),l}},Ci=class extends u{constructor(){super(1,"Unexpected end of data within reader")}},Fi=class e{constructor(t){this._currentByte=0,this._position=e._byteSize,this._source=t}readByte(){return this.readBits(8)}readBytes(e){let t=new Uint8Array(e);for(let s=0;s<e;s++)t[s]=255&this.readByte();return t}readBits(e){let t=0,s=e-1;for(;s>=0;)t|=this.readBit()<<s,s--;return t}readBitsReversed(e){let t=0;for(let s=0;s<e;s++)t|=this.readBit()<<s;return t}readBit(){if(this._position>=8){if(this._currentByte=this._source.readByte(),-1===this._currentByte)throw new Ci;this._position=0}let t=this._currentByte>>e._byteSize-this._position-1&1;return this._position++,t}readAll(){let e=Fs.empty();try{for(;;)e.writeByte(255&this.readByte())}catch(e){if(!(e instanceof Ci))throw e}return e.toArray()}};Fi._byteSize=8;var Di=Fi,Ii=class{constructor(){this.fileName="",this.fileSize=0,this.data=null}},Ai=class{constructor(){this.files=[],this.files=[],this.fileFilter=e=>!0}load(e){let t=new Di(e);this._readBlock(t)}readHeader(e){return this._getString(e.readBytes(4),0,4)}decompress(e,t=!1){let s,i=Fs.empty(),a=this._getInteger(e.readBytes(4),0);try{for(;i.length<a;)if(1===e.readBits(1)){let t=e.readBits(4),a=e.readBitsReversed(t),r=e.readBitsReversed(t),n=i.length-a,o=Math.min(a,r);s=i.getBuffer(),i.write(s,n,o)}else{let t=e.readBitsReversed(2);for(let s=0;s<t;s++)i.writeByte(e.readByte())}}catch(e){if(!(e instanceof Ci))throw e}s=i.getBuffer();let r=t?4:0,n=i.length-r,o=new Uint8Array(n),l=n;return o.set(s.subarray(r,r+l),0),o}_readBlock(e){let t=this.readHeader(e);if("BCFZ"===t)this._readUncompressedBlock(this.decompress(e,!0));else{if("BCFS"!==t)throw new Cs("Unsupported format");this._readUncompressedBlock(e.readAll())}}_readUncompressedBlock(e){let t=4096;for(;t+3<e.length;){if(2===this._getInteger(e,t)){let s=new Ii;s.fileName=this._getString(e,t+4,127),s.fileSize=this._getInteger(e,t+140);let i=!this.fileFilter||this.fileFilter(s.fileName);i&&this.files.push(s);let a=t+148,r=0,n=0,o=i?Fs.withCapacity(s.fileSize):null;for(;r=this._getInteger(e,a+4*n++),0!==r;)t=4096*r,i&&o.write(e,t,4096);if(i){s.data=new Uint8Array(Math.min(s.fileSize,o.length));let e=o.toArray();s.data.set(e.subarray(0,0+s.data.length),0)}}t+=4096}}_getString(e,t,s){let i="";for(let a=0;a<s;a++){let s=255&e[t+a];if(0===s)break;i+=String.fromCharCode(s)}return i}_getInteger(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}};Ai.HeaderBcFs="BCFS",Ai.HeaderBcFz="BCFZ";var Ri=class extends Ls{get name(){return"Guitar Pro 6"}readScore(){re.debug(this.name,"Loading GPX filesystem");let e=new Ai;e.fileFilter=e=>e.endsWith("score.gpif")||e.endsWith("BinaryStylesheet")||e.endsWith("PartConfiguration")||e.endsWith("LayoutConfiguration"),e.load(this.data),re.debug(this.name,"GPX filesystem loaded");let t=null,s=null,i=null,a=null;for(let r of e.files)switch(r.fileName){case"score.gpif":t=Ps.toString(r.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=r.data;break;case"PartConfiguration":i=r.data;break;case"LayoutConfiguration":a=r.data}if(!t)throw new Cs("No score.gpif found in GPX");re.debug(this.name,"Start Parsing score.gpif");let r=new Bi;r.parseXml(t,this.settings),re.debug(this.name,"score.gpif parsed");let n=r.score;s&&(re.debug(this.name,"Start Parsing BinaryStylesheet"),new _i(s).apply(n),re.debug(this.name,"BinaryStylesheet parsed"));let o=null;return i&&(re.debug(this.name,"Start Parsing Part Configuration"),o=new Pi(i),o.apply(n),re.debug(this.name,"Part Configuration parsed")),a&&null!=o&&(re.debug(this.name,"Start Parsing Layout Configuration"),new Ei(o,a).apply(n),re.debug(this.name,"Layout Configuration parsed")),n}},Oi=class{constructor(){this.maxLine=-1e3,this.maxLineNote=null,this.minLine=-1e3,this.minLineNote=null}},Vi=class e{constructor(e){this._registeredAccidentals=new Map,this._appliedScoreLines=new Map,this._appliedScoreLinesByValue=new Map,this._notesByValue=new Map,this._beatLines=new Map,this.maxLineBeat=null,this.minLineBeat=null,this.maxLine=-1e3,this.minLine=-1e3,this._barRenderer=e,this._bar=e.bar}static getPercussionLine(e,t){return t<e.staff.track.percussionArticulations.length?e.staff.track.percussionArticulations[t].staffLine:et.getArticulationByInputMidiNumber(t)?.staffLine??0}static getNoteValue(e){if(e.isPercussion)return e.percussionArticulation;let t=e.displayValue;switch(e.accidentalMode){case 6:t+=2;break;case 4:t-=2;break;case 5:t+=1;break;case 3:t-=1}return t}applyAccidental(t){let s=e.getNoteValue(t),i=t.hasQuarterToneOffset;return this._getAccidental(s,i,t.beat,!1,t)}applyAccidentalForValue(e,t,s,i){return this._getAccidental(t,s,e,i,null)}static computeLineWithoutAccidentals(t,s){let i=0,a=e.getNoteValue(s);return i=s.isPercussion?e.getPercussionLine(t,a):e.calculateNoteSteps(t.keySignature,t.clef,a),i}_getAccidental(t,s,i,a,r=null){let n=0,o=0;if(null!=r?r.isPercussion:this._bar.staff.isPercussion)n=e.getPercussionLine(this._bar,t);else{let i=r?r.accidentalMode:0;n=e.calculateNoteSteps(this._bar.keySignature,this._bar.clef,t);let a=this._registeredAccidentals.has(n)?this._registeredAccidentals.get(n):null;o=qe.computeAccidental(this._bar.keySignature,i,t,s,a);let l=!1;switch(o){case 4:case 5:case 6:break;default:if(r&&r.isTieDestination&&0===r.beat.index){let e=this._barRenderer.scoreRenderer.layout?.getRendererForBar(this._barRenderer.staff.staffId,r.tieOrigin.beat.voice.bar);e&&e.staff===this._barRenderer.staff&&e.accidentalHelper.getNoteLine(r.tieOrigin)===n&&(l=!0)}l?o=0:0!==o&&this._registeredAccidentals.set(n,o)}}return r?(this._appliedScoreLines.set(r.id,n),this._notesByValue.set(t,r)):this._appliedScoreLinesByValue.set(t,n),(-1e3===this.minLine||this.minLine<n)&&(this.minLine=n,this.minLineBeat=i),(-1e3===this.maxLine||this.maxLine>n)&&(this.maxLine=n,this.maxLineBeat=i),a||this._registerLine(i,n,r),o}_registerLine(e,t,s){let i;this._beatLines.has(e.id)?i=this._beatLines.get(e.id):(i=new Oi,this._beatLines.set(e.id,i)),(-1e3===i.minLine||t<i.minLine)&&(i.minLine=t,i.minLineNote=s),(-1e3===i.minLine||t>i.maxLine)&&(i.maxLine=t,i.maxLineNote=s)}getMaxLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLine:0}getMaxLineNote(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLineNote:null}getMinLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLine:0}getMinLineNote(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLineNote:null}static calculateNoteSteps(t,s,i){let a=t,r=s,n=i%12,o=(i/12|0)-1,l=e._octaveSteps[r];return l-=o*e._stepsPerOctave,l-=(qe.keySignatureIsSharp(a)||qe.keySignatureIsNatural(a)?e.sharpNoteSteps:e.flatNoteSteps)[n],l}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,t=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):t&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}};Vi._stepsPerOctave=7,Vi._octaveSteps=[38,32,30,26,38],Vi.sharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6],Vi.flatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];var Wi=Vi,Hi=class{constructor(){this.currentDynamics=5,this.slideOrigins=new Map,this.transpose=0,this.isExplicitlyBeamed=!1,this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}},Gi=class extends Qe{constructor(){super(...arguments),this.outputMidiChannel=-1,this.outputMidiProgram=-1,this.outputMidiBank=-1,this.outputVolume=-1,this.outputBalance=-1}},zi=class e{constructor(e){this.instruments=new Map,this._instrumentIdToArticulationIndex=new Map,this._lyricsLine=0,this._lyricsLines=new Map,this.track=e}getLyricLine(e){if(this._lyricsLines.has(e))return this._lyricsLines.get(e);let t=this._lyricsLine;return this._lyricsLines.set(e,t),this._lyricsLine++,t}getOrCreateArticulation(t,s){let i,a=12*s.octave+s.tone,r=`${t}_${a}`;if(this._instrumentIdToArticulationIndex.has(r))return this._instrumentIdToArticulationIndex.get(r);i=this.instruments.has(t)?this.instruments.get(t):e._defaultNoteArticulation;let n,o=this.track.percussionArticulations.length,l=s.beat.voice.bar;n=0===a?4:Wi.calculateNoteSteps(l.keySignature,l.clef,a);let h=n-(9-(2*s.beat.voice.bar.staff.standardNotationLineCount-1)),d=new Qe(i.elementType,h,i.outputMidiNumber,i.noteHeadDefault,i.noteHeadHalf,i.noteHeadWhole,i.techniqueSymbol,i.techniqueSymbolPlacement);return this._instrumentIdToArticulationIndex.set(r,o),this.track.percussionArticulations.push(d),o}};zi._defaultNoteArticulation=new Qe("Default",0,0,57508,57507,57506);var Ui=zi,Yi=class e extends Ls{constructor(){super(...arguments),this._idToTrackInfo=new Map,this._indexToTrackInfo=new Map,this._staffToContext=new Map,this._divisionsPerQuarterNote=1,this._currentDynamics=5,this._musicalPosition=0,this._lastBeat=null,this._nextMasterBarRepeatEnding=0,this._nextBeatAutomations=null,this._nextBeatChord=null,this._nextBeatCrescendo=null,this._nextBeatLetRing=!1,this._nextBeatPalmMute=!1,this._nextBeatOttavia=null,this._nextBeatText=null,this._simileMarkAllStaves=null,this._simileMarkPerStaff=null,this._isBeatSlash=!1,this._keyAllStaves=null,this._currentTrillStep=-1}get name(){return"MusicXML"}readScore(){let e=this._extractMusicXml(),t=new Zs;try{t.parse(e)}catch(e){throw new Cs("Unsupported format",e)}return this._score=new Oe,this._score.stylesheet.hideDynamics=!0,this._parseDom(t),qe.consolidate(this._score),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}_extractMusicXml(){let e,t=new $s(this.data);try{e=t.read()}catch{e=[]}if(0===e.length)return this.data.reset(),Ps.toString(this.data.readAll(),this.settings.importer.encoding);let s=e.find(e=>"META-INF/container.xml"===e.fullName);if(!s)throw new Cs("No compressed MusicXML");let i=new Zs;try{i.parse(Ps.toString(s.data,this.settings.importer.encoding))}catch(e){throw new Cs("Malformed container.xml, could not parse as XML",e)}let a=i.firstElement;if(!a||"container"!==a.localName)throw new Cs("Malformed container.xml, root element not 'container'");let r=a.findChildElement("rootfiles");if(!r)throw new Cs("Malformed container.xml, 'container/rootfiles' not found");let n="";for(let e of r.childElements())if("rootfile"===e.localName){n=e.getAttribute("full-path");break}if(!n)throw new Cs("Unsupported compressed MusicXML, missing rootfile");let o=e.find(e=>e.fullName===n);if(!o)throw new Cs(`Malformed container.xml, '${n}' not contained in zip`);return Ps.toString(o.data,this.settings.importer.encoding)}_parseDom(e){let t=e.firstElement;if(!t)throw new Cs("Unsupported format");switch(t.localName){case"score-partwise":this._parsePartwise(t);break;case"score-timewise":this._parseTimewise(t);break;default:throw new Cs("Unsupported format")}}_parsePartwise(e){for(let t of e.childElements())switch(t.localName){case"credit":this._parseCredit(t);break;case"identification":this._parseIdentification(t);break;case"movement-title":this._parseMovementTitle(t);break;case"part":this._parsePartwisePart(t);break;case"part-list":this._parsePartList(t);break;case"work":this._parseWork(t)}}_parseTimewise(e){let t=0;for(let s of e.childElements())switch(s.localName){case"credit":this._parseCredit(s);break;case"identification":this._parseIdentification(s);break;case"movement-title":this._parseMovementTitle(s);break;case"part-list":this._parsePartList(s);break;case"work":this._parseWork(s);break;case"measure":this._parseTimewiseMeasure(s,t),t++}}_parseCredit(t){if("1"!==t.getAttribute("page","1"))return;let s=[],i=null,a="";for(let e of t.childElements())switch(e.localName){case"credit-type":s.push(e.innerText);break;case"credit-words":null===i&&(i=e),a+=e.innerText}if(s.length>0)for(let t of s)switch(t){case"title":this._score.title=e._sanitizeDisplay(a);break;case"subtitle":this._score.subTitle=e._sanitizeDisplay(a);break;case"composer":case"arranger":this._score.artist=e._sanitizeDisplay(a);break;case"lyricist":this._score.words=e._sanitizeDisplay(a);break;case"rights":this._score.copyright=e._sanitizeDisplay(a)}else if(i){let t=i.getAttribute("font-size","0"),s=i.getAttribute("font-size","top"),r=i.getAttribute("halign","left");if("top"===s){if(a.includes("copyright")||a.includes("Copyright")||a.includes("")||a.includes("(c)")||a.includes("(C)"))return void(this._score.copyright=e._sanitizeDisplay(a));if("center"===r||"center"===t){if(0===this._score.title.length)return void(this._score.title=e._sanitizeDisplay(a));if(0===this._score.subTitle.length)return void(this._score.subTitle=e._sanitizeDisplay(a));if(0===this._score.album.length)return void(this._score.album=e._sanitizeDisplay(a))}else if(("right"===r||"right"===t)&&0===this._score.music.length)return void(this._score.music=e._sanitizeDisplay(a));if(0===this._score.artist.length)return void(this._score.artist=e._sanitizeDisplay(a));if(0===this._score.words.length)return void(this._score.words=e._sanitizeDisplay(a))}}}static _sanitizeDisplay(e){return e.replaceAll("\r","").replaceAll("\n"," ").replaceAll("\t","").replaceAll(" ","")}_parseIdentification(t){for(let s of t.childElements())switch(s.localName){case"creator":if(s.attributes.has("type"))switch(s.attributes.get("type")){case"composer":this._score.artist=e._sanitizeDisplay(s.innerText);break;case"lyricist":this._score.words=e._sanitizeDisplay(s.innerText);break;case"arranger":this._score.music=e._sanitizeDisplay(s.innerText)}else this._score.artist=e._sanitizeDisplay(s.innerText);break;case"rights":this._score.copyright.length>0&&(this._score.copyright+=", "),this._score.copyright+=s.innerText,s.attributes.has("type")&&(this._score.copyright+=` (${s.attributes.get("type")})`);break;case"encoding":this._parseEncoding(s)}}_parseEncoding(t){for(let s of t.childElements())switch(s.localName){case"encoder":this._score.tab.length>0&&(this._score.tab+=", "),this._score.tab+=s.innerText,s.attributes.has("type")&&(this._score.tab+=` (${s.attributes.get("type")})`);break;case"encoding-description":this._score.notices+=e._sanitizeDisplay(s.innerText)}}_parseMovementTitle(t){0===this._score.title.length?this._score.title=e._sanitizeDisplay(t.innerText):this._score.subTitle=e._sanitizeDisplay(t.innerText)}_parsePartList(e){for(let t of e.childElements())"score-part"===t.localName&&this._parseScorePart(t)}_parseScorePart(t){let s=new ns;s.ensureStaveCount(1),this._score.addTrack(s);let i=t.attributes.get("id"),a=new Ui(s);this._idToTrackInfo.set(i,a),this._indexToTrackInfo.set(s.index,a);for(let i of t.childElements())switch(i.localName){case"part-name":s.name=e._sanitizeDisplay(i.innerText);break;case"part-name-display":s.name=this._parsePartDisplayAsText(i);break;case"part-abbreviation":s.shortName=e._sanitizeDisplay(i.innerText);break;case"part-abbreviation-display":s.shortName=this._parsePartDisplayAsText(i);break;case"score-instrument":this._parseScoreInstrument(i,a);break;case"midi-device":i.attributes.has("port")&&(s.playbackInfo.port=Number.parseInt(i.attributes.get("port"),10));break;case"midi-instrument":this._parseScorePartMidiInstrument(i,a)}a.firstArticulation&&(a.firstArticulation.outputMidiProgram>=0&&(s.playbackInfo.program=a.firstArticulation.outputMidiProgram),a.firstArticulation.outputMidiBank>=0&&(s.playbackInfo.bank=a.firstArticulation.outputMidiBank),a.firstArticulation.outputBalance>=0&&(s.playbackInfo.balance=a.firstArticulation.outputBalance),a.firstArticulation.outputVolume>=0&&(s.playbackInfo.volume=a.firstArticulation.outputVolume),a.firstArticulation.outputMidiChannel>=0&&(s.playbackInfo.primaryChannel=a.firstArticulation.outputMidiChannel,s.playbackInfo.secondaryChannel=a.firstArticulation.outputMidiChannel))}_parseScoreInstrument(e,t){let s=new Gi;t.firstArticulation||(t.firstArticulation=s),t.instruments.set(e.getAttribute("id",""),s)}_parseScorePartMidiInstrument(t,s){let i=t.getAttribute("id","");if(!s.instruments.has(i))return;let a=s.instruments.get(i);for(let s of t.childElements())switch(s.localName){case"midi-channel":a.outputMidiChannel=Number.parseInt(s.innerText,10)-1;break;case"midi-bank":a.outputMidiBank=Number.parseInt(s.innerText,10)-1;break;case"midi-program":a.outputMidiProgram=Number.parseInt(s.innerText,10)-1;break;case"midi-unpitched":a.outputMidiNumber=Number.parseInt(s.innerText,10)-1;break;case"volume":a.outputVolume=e._interpolatePercent(Number.parseFloat(s.innerText));break;case"pan":a.outputBalance=e._interpolatePan(Number.parseFloat(s.innerText))}}static _interpolatePercent(t){return 0|e._interpolate(0,100,0,16,t)}static _interpolatePan(t){return 0|e._interpolate(-90,90,0,16,t)}static _interpolate(e,t,s,i,a){return s+(i-s)*((a-e)/(t-e))}_parsePartDisplayAsText(t){let s="";for(let e of t.childElements())switch(e.localName){case"display-text":s+=e.innerText;break;case"accidental-text":switch(e.innerText){case"sharp":s+="";break;case"natural":s+="";break;case"flat":s+="";break;case"double-sharp":s+="";break;case"sharp-sharp":s+="";break;case"flat-flat":s+="";break;case"natural-sharp":s+="";break;case"natural-flat":s+="";break;case"sharp-down":s+="";break;case"sharp-up":s+="";break;case"natural-down":s+="";break;case"natural-up":s+="";break;case"flat-down":s+="";break;case"flat-up":s+="";break;case"arrow-down":s+="";break;case"arrow-up":s+="";break;case"triple-sharp":s+="";break;case"triple-flat":s+="";break;case"sharp-1":s+="";break;case"sharp-2":s+="";break;case"sharp-3":s+="";break;case"sharp-4":s+="";break;case"sharp-5":s+="";break;case"flat-1":s+="";break;case"flat-2":s+="";break;case"flat-3":s+="";break;case"flat-4":s+="";break;case"flat-5":s+=""}}return e._sanitizeDisplay(s)}_parseWork(t){for(let s of t.childElements())"work-title"===s.localName&&(this._score.title=e._sanitizeDisplay(s.innerText))}_parsePartwisePart(e){let t=e.attributes.get("id");if(!t||!this._idToTrackInfo.has(t))return;let s=this._idToTrackInfo.get(t).track,i=0;for(let t of e.childElements())"measure"===t.localName&&(this._parsePartwiseMeasure(t,s,i),i++)}_parsePartwiseMeasure(e,t,s){let i=this._getOrCreateMasterBar(e,s);this._parsePartMeasure(e,i,t)}_parseTimewiseMeasure(e,t){let s=this._getOrCreateMasterBar(e,t);for(let t of e.childElements())"part"===t.localName&&this._parseTimewisePart(t,s)}_getOrCreateMasterBar(e,t){let s="yes"===e.attributes.get("implicit");for(;this._score.masterBars.length<=t;){let e=new We;s&&(e.isAnacrusis=!0),this._score.addMasterBar(e),e.index>0&&(e.timeSignatureDenominator=e.previousMasterBar.timeSignatureDenominator,e.timeSignatureNumerator=e.previousMasterBar.timeSignatureNumerator,e.tripletFeel=e.previousMasterBar.tripletFeel)}return this._score.masterBars[t]}_parseTimewisePart(e,t){let s=e.attributes.get("id");if(!s||!this._idToTrackInfo.has(s))return;let i=this._idToTrackInfo.get(s).track;this._parsePartMeasure(e,t,i)}_parsePartMeasure(e,t,s){this._musicalPosition=0,this._lastBeat=null,t.alternateEndings=this._nextMasterBarRepeatEnding;let i=[];for(let a of e.childElements())switch(a.localName){case"note":this._parseNote(a,t,s);break;case"backup":this._parseBackup(a);break;case"forward":this._parseForward(a);break;case"direction":this._parseDirection(a,t,s);break;case"attributes":this._parseAttributes(a,t,s);break;case"harmony":this._parseHarmony(a,s);break;case"print":this._parsePrint(a,t,s);break;case"sound":this._parseSound(a,t,s);break;case"barline":i.push(a)}for(let e of i)this._parseBarLine(e,t,s);this._applySimileMarks(t,s);let a=this._getOrCreateStaff(s,0);this._getOrCreateBar(a,t),this._keyAllStaves=null}_parsePrint(e,t,s){("yes"===e.getAttribute("new-system","no")||"yes"===e.getAttribute("new-page","no"))&&s.addLineBreaks(t.index)}_applySimileMarks(e,t){if(null!==this._simileMarkAllStaves){for(let s of t.staves){let t=this._getOrCreateBar(s,e);t.simileMark=this._simileMarkAllStaves,0!==t.simileMark&&this._clearBar(t)}2===this._simileMarkAllStaves?this._simileMarkAllStaves=3:this._simileMarkAllStaves=null}if(null!==this._simileMarkPerStaff){let s=Array.from(this._simileMarkPerStaff.keys());for(let i of s){let s=this._getOrCreateStaff(t,i),a=this._getOrCreateBar(s,e);a.simileMark=this._simileMarkPerStaff.get(i),0!==a.simileMark&&this._clearBar(a),2===a.simileMark?this._simileMarkPerStaff.set(i,3):this._simileMarkPerStaff.delete(i)}0===this._simileMarkPerStaff.size&&(this._simileMarkPerStaff=null)}}_clearBar(e){for(let t of e.voices){let e=new wt;e.isEmpty=!0,t.addBeat(e)}}_parseBarLine(e,t,s){for(let i of e.childElements())switch(i.localName){case"bar-style":this._parseBarStyle(i,t,s,e.getAttribute("location","right"));break;case"ending":this._parseEnding(i,t);break;case"repeat":this._parseRepeat(i,t)}}_parseRepeat(e,t){let s=e.getAttribute("direction"),i=Number.parseInt(e.getAttribute("times"),10);(i<0||Number.isNaN(i))&&(i=2),"backward"===s?t.repeatCount=i:"forward"===s&&(t.isRepeatStart=!0)}_parseEnding(e,t){let s=e.getAttribute("number").split(",").map(e=>Number.parseInt(e,10)),i=0;for(let e of s)i|=1<<e-1&255;switch(t.alternateEndings=i,e.getAttribute("type","")){case"start":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding|i;break;case"stop":case"discontinue":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding&~i}}_parseBarStyle(e,t,s,i){let a=0;switch(e.innerText){case"dashed":a=1;break;case"dotted":a=2;break;case"heavy":a=3;break;case"heavy-heavy":a=4;break;case"heavy-light":a=5;break;case"light-heavy":a=6;break;case"light-light":a=7;break;case"none":a=8;break;case"regular":a=9;break;case"short":a=10;break;case"tick":a=11}for(let e of s.staves){let s=this._getOrCreateBar(e,t);switch(i){case"left":s.barLineLeft=a;break;case"right":s.barLineRight=a}}}_parseSound(t,s,i){for(let e of t.childElements())switch(e.localName){case"midi-instrument":this._parseSoundMidiInstrument(e,s);break;case"swing":this._parseSwing(e,s)}if(t.attributes.has("coda")&&s.addDirection(3),t.attributes.has("tocoda")&&s.addDirection(17),t.attributes.has("dacapo")&&s.addDirection(5),t.attributes.has("dalsegno")&&s.addDirection(9),t.attributes.has("fine")&&s.addDirection(0),t.attributes.has("segno")&&s.addDirection(1),t.attributes.has("pan")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);let s=new w;s.type=3,s.value=e._interpolatePan(Number.parseFloat(t.attributes.get("pan"))),this._nextBeatAutomations.push(s)}if(t.attributes.has("tempo")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);let s=new w;s.type=0,s.value=e._interpolatePercent(Number.parseFloat(t.attributes.get("tempo"))),this._nextBeatAutomations.push(s)}}_parseSwing(e,t){let s=0,i=0,a=null;for(let r of e.childElements())switch(r.localName){case"straight":return void(t.tripletFeel=0);case"first":s=Number.parseInt(r.innerText,10);break;case"second":i=Number.parseInt(r.innerText,10);break;case"swing-type":a=this._parseBeatDuration(r)}a||(a=8),8===a?2===s&&1===i?t.tripletFeel=2:3===s&&1===i?t.tripletFeel=4:1===s&&3===i&&(t.tripletFeel=6):16===a&&(2===s&&1===i?t.tripletFeel=1:3===s&&1===i?t.tripletFeel=3:1===s&&3===i&&(t.tripletFeel=5))}_parseSoundMidiInstrument(t,s){let i;for(let s of t.childElements())switch(s.localName){case"midi-bank":this._nextBeatAutomations||(this._nextBeatAutomations=[]),i=new w,i.type=4,i.value=Number.parseInt(s.innerText,10)-1,this._nextBeatAutomations.push(i);break;case"midi-program":this._nextBeatAutomations||(this._nextBeatAutomations=[]),i=new w,i.type=2,i.value=Number.parseInt(s.innerText,10)-1,this._nextBeatAutomations.push(i);break;case"volume":this._nextBeatAutomations||(this._nextBeatAutomations=[]),i=new w,i.type=1,i.value=e._interpolatePercent(Number.parseFloat(s.innerText)),this._nextBeatAutomations.push(i);break;case"pan":this._nextBeatAutomations||(this._nextBeatAutomations=[]),i=new w,i.type=3,i.value=e._interpolatePan(Number.parseFloat(s.innerText)),this._nextBeatAutomations.push(i)}}_parseHarmony(e,t){let s=new Yt,i=!1,a="";for(let t of e.childElements())switch(t.localName){case"root":s.name=this._parseHarmonyRoot(t);break;case"kind":s.name=s.name+this._parseHarmonyKind(t),"yes"===t.getAttribute("parentheses-degrees","no")&&(i=!0);break;case"frame":this._parseHarmonyFrame(t,s);break;case"degree":a+=this._parseDegree(t)}a&&(s.name+=i?`(${a})`:a),null===this._nextBeatChord&&(this._nextBeatChord=s)}_parseDegree(e){let t="",s="",i="";for(let a of e.childElements())switch(a.localName){case"degree-value":t=a.innerText;break;case"degree-alter":switch(a.innerText){case"-1":s="";break;case"1":s=""}break;case"degree-type":i+=a.getAttribute("text","")}return`${i}${s}${t}`}_parseHarmonyRoot(e){let t="",s="";for(let i of e.childElements())switch(i.localName){case"root-step":t=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##"}}return t+s}_parseHarmonyKind(e){let t=e.getAttribute("text"),s="";if(t)s=t;else{let t=e.innerText;switch(t){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="II";break;case"Italian":s="It";break;case"French":case"German":s="Fr";break;default:s=t}}return s}_parseHarmonyFrame(e,t){for(let s of e.childElements())switch(s.localName){case"frame-strings":let e=Number.parseInt(s.innerText,10);t.strings=new Array(e);for(let s=0;s<e;s++)t.strings[s]=-1;break;case"first-fret":t.firstFret=Number.parseInt(s.innerText,10);break;case"frame-note":let i=null,a=null;for(let e of s.childElements())switch(e.localName){case"string":i=Number.parseInt(e.innerText,10);break;case"fret":a=Number.parseInt(e.innerText,10),i&&a>=0&&(t.strings[i-1]=a);break;case"barre":i&&a&&"start"===e.getAttribute("type")&&t.barreFrets.push(a)}}}_parseAttributes(e,t,s){let i,a,r;if(null==this._lastBeat)for(let n of e.childElements())switch(n.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(n.innerText);break;case"key":this._parseKey(n,t,s);break;case"time":this._parseTime(n,t);break;case"staves":s.ensureStaveCount(Number.parseInt(n.innerText,10));break;case"clef":i=Number.parseInt(n.getAttribute("number","1"),10)-1,a=this._getOrCreateStaff(s,i),r=this._getOrCreateBar(a,t),this._parseClef(n,r);break;case"staff-details":i=Number.parseInt(n.getAttribute("number","1"),10)-1,a=this._getOrCreateStaff(s,i),this._parseStaffDetails(n,a);break;case"transpose":this._parseTranspose(n,s);break;case"measure-style":this._parseMeasureStyle(n,s,!1)}else for(let t of e.childElements())switch(t.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(t.innerText);break;case"measure-style":this._parseMeasureStyle(t,s,!0)}}_parseMeasureStyle(e,t,s){for(let t of e.childElements())switch(t.localName){case"measure-repeat":if(!s){let s=null;switch(t.getAttribute("type")){case"start":switch(Number.parseInt(t.getAttribute("slashes","1"),10)){case 1:s=1;break;case 2:s=2}break;case"stop":s=null}if(e.attributes.has("number")){this._simileMarkPerStaff=this._simileMarkPerStaff??new Map;let t=Number.parseInt(e.attributes.get("number"),10)-1;null==s?this._simileMarkPerStaff.delete(t):this._simileMarkPerStaff.set(t,s)}else this._simileMarkAllStaves=s}break;case"slash":switch(t.getAttribute("type")){case"start":this._isBeatSlash=!0;break;case"stop":this._isBeatSlash=!1}}}_parseTranspose(e,t){let s=0;for(let t of e.childElements())switch(t.localName){case"chromatic":s+=Number.parseFloat(t.innerText);break;case"octave-change":s+=12*Number.parseFloat(t.innerText)}if(e.attributes.has("number")){let i=this._getOrCreateStaff(t,Number.parseInt(e.attributes.get("number"),10)-1);this._getStaffContext(i).transpose=s,i.displayTranspositionPitch=s}else for(let e of t.staves)this._getStaffContext(e).transpose=s,e.displayTranspositionPitch=s}_parseStaffDetails(e,t){for(let s of e.childElements())switch(s.localName){case"staff-lines":t.standardNotationLineCount=Number.parseInt(s.innerText,10);break;case"staff-tuning":this._parseStaffTuning(s,t);break;case"capo":t.capo=Number.parseInt(s.innerText,10)}}_parseStaffTuning(e,t){0===t.stringTuning.tunings.length&&(t.showTablature=!0,t.showStandardNotation=!1,t.stringTuning.tunings=new Array(t.standardNotationLineCount).fill(0));let s=Number.parseInt(e.getAttribute("line"),10),i="C",a="",r=0;for(let t of e.childElements())switch(t.localName){case"tuning-step":i=t.innerText;break;case"tuning-alter":r=Number.parseFloat(t.innerText);break;case"tuning-octave":a=t.innerText}let n=qe.getTuningForText(i+a)+r;t.tuning[t.tuning.length-s]=n}_parseClef(e,t){let s="s",i=0;for(let a of e.childElements())switch(a.localName){case"sign":s=a.innerText.toLowerCase();break;case"line":i=Number.parseInt(a.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(a.innerText,10)){case-2:t.clefOttava=4;break;case-1:t.clefOttava=3;break;case 1:t.clefOttava=1;break;case 2:t.clefOttava=4}}switch(s){case"g":default:t.clef=4;break;case"f":t.clef=3;break;case"c":t.clef=3===i?1:2;break;case"percussion":t.clef=0,t.staff.isPercussion=!0;break;case"tab":t.clef=4,t.staff.showTablature=!0}}_parseTime(e,t){let s=!1,i=!1;for(let a of e.childElements()){let e=a.innerText;switch(a.localName){case"beats":s||(-1===e.indexOf("+")?t.timeSignatureNumerator=Number.parseInt(e,10):t.timeSignatureNumerator=e.split("+").map(e=>Number.parseInt(e,10)).reduce((e,t)=>t+e,0),s=!0);break;case"beat-type":i||(-1===e.indexOf("+")?t.timeSignatureDenominator=Number.parseInt(e,10):t.timeSignatureDenominator=e.split("+").map(e=>Number.parseInt(e,10)).reduce((e,t)=>t+e,0),i=!0)}}switch(e.getAttribute("symbol","")){case"common":case"cut":t.timeSignatureCommon=!0}}_parseKey(e,t,s){let i,a,r=-0,n="";for(let t of e.childElements())switch(t.localName){case"fifths":r=Number.parseInt(t.innerText,10);break;case"mode":n=t.innerText}if(i=-7<=r&&r<=7?r:0,a="minor"===n?1:0,e.attributes.has("number")){let r=this._getOrCreateStaff(s,Number.parseInt(e.attributes.get("number"),10)-1),n=this._getOrCreateBar(r,t);n.keySignature=i,n.keySignatureType=a}else{this._keyAllStaves=[i,a];for(let e of s.staves)e.bars.length>t.index&&(e.bars[t.index].keySignature=i,e.bars[t.index].keySignatureType=a)}}_parseDirection(e,t,s){let i=[],a=null,r=-1,n=-1;for(let t of e.childElements())switch(t.localName){case"direction-type":let e=t.firstElement;e&&i.push(e);break;case"offset":a=Number.parseFloat(t.innerText);break;case"voice":break;case"staff":r=Number.parseInt(t.innerText,10)-1;break;case"sound":t.attributes.has("tempo")&&(n=Number.parseFloat(t.attributes.get("tempo")))}let o=null;o=r>=0?this._getOrCreateStaff(s,r):null!==this._lastBeat?this._lastBeat.voice.bar.staff:this._getOrCreateStaff(s,0);let l=o?this._getOrCreateBar(o,t):null,h=()=>{let e=this._musicalPosition;return null!==a&&(e+=a),e/t.calculateDuration(!1)};if(n>0){let e=new w;e.type=0,e.value=n,e.ratioPosition=h(),this._hasSameTempo(t,e)||t.tempoAutomations.push(e)}let d="";for(let e of i)switch(e.localName){case"rehearsal":t.section=new Kt,t.section.marker=e.innerText;break;case"segno":t.addDirection(1);break;case"coda":t.addDirection(3);break;case"words":d=e.innerText;break;case"wedge":switch(e.getAttribute("type")){case"crescendo":this._nextBeatCrescendo=1;break;case"diminuendo":this._nextBeatCrescendo=2;break;case"stop":this._nextBeatCrescendo=null}break;case"dynamics":let s=this._parseDynamics(e);null!==s&&(this._currentDynamics=s,this._score.stylesheet.hideDynamics=!1);break;case"dashes":let i=e.getAttribute("type","start");switch(d){case"LetRing":this._nextBeatLetRing="start"===i||"continue"===i;break;case"P.M.":this._nextBeatPalmMute="start"===i||"continue"===i}d="";break;case"pedal":let a=this._parsePedal(e);if(a&&l){a.ratioPosition=h();let e=l.sustainPedals.length>0&&2!==l.sustainPedals[l.sustainPedals.length-1].pedalType;(2!==a.pedalType||e)&&l.sustainPedals.push(a)}break;case"metronome":this._parseMetronome(e,t,h());break;case"octave-shift":this._nextBeatOttavia=this._parseOctaveShift(e)}d&&(this._nextBeatText=d)}_parseOctaveShift(e){let t=e.getAttribute("type");switch(Number.parseInt(e.getAttribute("size","8"),10)){case 15:switch(t){case"up":return 4;case"down":return 0;case"stop":return 2;case"continue":return this._nextBeatOttavia}break;case 8:switch(t){case"up":return 3;case"down":return 1;case"stop":return 2;case"continue":return this._nextBeatOttavia}}return null}_parseMetronome(e,t,s){let i=null,a=-1;for(let t of e.childElements())switch(t.localName){case"beat-unit":i=this._parseBeatDuration(t);break;case"per-minute":a=Number.parseFloat(t.innerText)}if(null!==i&&a>0){let e=new w;e.type=0,e.value=a*(i/4)|0,e.ratioPosition=s,this._hasSameTempo(t,e)||t.tempoAutomations.push(e)}}_hasSameTempo(e,t){for(let s of e.tempoAutomations)if(t.ratioPosition===s.ratioPosition&&t.value===s.value)return!0;return!1}_parsePedal(e){let t=new ye;switch(e.getAttribute("type")){case"start":t.pedalType=0;break;case"stop":t.pedalType=2;break;case"continue":t.pedalType=1;break;default:return null}return t}_parseDynamics(e){for(let t of e.childElements()){let e=t.localName.toUpperCase();switch(e){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return f[e]}}return null}_parseForward(e){for(let t of e.childElements())"duration"===t.localName&&(this._musicalPosition+=this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText)))}_parseBackup(e){for(let t of e.childElements())if("duration"===t.localName)if(this._lastBeat){let e=this._musicalPosition;e-=this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText)),e<0&&(e=0),this._musicalPosition=e}}_getOrCreateStaff(e,t){for(;e.staves.length<=t;){let t=new ts;e.addStaff(t),this._score.masterBars.length>0&&this._getOrCreateBar(t,this._score.masterBars[this._score.masterBars.length-1])}return e.staves[t]}_getOrCreateBar(e,t){let s=0===e.bars.length?1:e.bars[0].voices.length;for(;e.bars.length<=t.index;){let t=new Be;e.addBar(t),t.previousBar&&(t.clef=t.previousBar.clef,t.clefOttava=t.previousBar.clefOttava,t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType),null!=this._keyAllStaves&&(t.keySignature=this._keyAllStaves[0],t.keySignatureType=this._keyAllStaves[1]);for(let e=0;e<s;e++){let e=new Me;t.addVoice(e)}}return e.bars[t.index]}_getOrCreateVoice(e,t){let s=!1;for(;e.voices.length<=t;)e.addVoice(new Me),s=!0;if(s)for(let s of e.staff.bars)for(;s.voices.length<=t;)s.addVoice(new Me);return e.voices[t]}_parseNote(e,t,s){let i=null,a=0,r=0,n=null,o=!1,l=0,h=0,d=-1,c=null,u=0,p=-1,m=-1,g=null,f=null,b=!1,y=null,S="no"!==e.getAttribute("print-object","yes"),k=()=>{if(null!==i)return;o&&!this._lastBeat&&(re.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),o=!1),o&&!f&&(re.warning("MusicXML","Cannot mix <chord /> and <rest />"),o=!1);let e=this._getOrCreateStaff(s,l);if(o)return i=this._lastBeat,void i.addNote(f);let k=this._getOrCreateBar(e,t),w=this._getOrCreateVoice(k,h),T=0===w.beats.length?0:w.beats[w.beats.length-1].displayEnd,B=this._musicalPosition-T;if(B>0){if(this._lastBeat&&2===this._lastBeat.beamingMode&&this._lastBeat.voice.bar.staff.index!==l&&w.beats.length>0&&2===w.beats[w.beats.length-1].beamingMode){let e=w.beats[w.beats.length-1].duration;for(;B>0;){let t=this._createRestForGap(B,e);if(null===t)break;this._insertBeatToVoice(t,w),B-=t.playbackDuration}}if(B>0){let e=new wt;e.dynamics=this._currentDynamics,e.isEmpty=!0,e.duration=256,e.overrideDisplayDuration=B,e.updateDurations(),this._insertBeatToVoice(e,w)}}else B<0&&re.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");d<0&&null!==c&&(d=_.toTicks(c),u>0&&(d=_.applyDot(d,2===u)));let x=new wt;i=x,null===n?x.beamingMode=this._getStaffContext(e).isExplicitlyBeamed?1:0:(x.beamingMode=n,this._getStaffContext(e).isExplicitlyBeamed=!0),x.isEmpty=!1,x.dynamics=this._currentDynamics,this._isBeatSlash&&(x.slashed=!0);let v=this._nextBeatAutomations;if(this._nextBeatAutomations=null,null!==v)for(let e of v)x.automations.push(e);let P=this._nextBeatChord;this._nextBeatChord=null,null!==P&&(x.chordId=P.uniqueId,w.bar.staff.hasChord(P.uniqueId)||w.bar.staff.addChord(x.chordId,P));let N=this._nextBeatCrescendo;null!==N&&(x.crescendo=N);let M=this._nextBeatOttavia;if(null!==M&&(x.ottava=M),x.isLetRing=this._nextBeatLetRing,x.isPalmMute=this._nextBeatPalmMute,this._nextBeatText&&(x.text=this._nextBeatText,this._nextBeatText=null),null!==f&&x.addNote(f),this._insertBeatToVoice(x,w),null!==f){f.isVisible=S;let e=this._indexToTrackInfo.get(s.index);null!==y?f.percussionArticulation=e.getOrCreateArticulation(y,f):b||(f.percussionArticulation=e.getOrCreateArticulation("",f))}0!==a?(x.graceType=a,this._applyBeatDurationFromTicks(x,r,null,!1)):(x.tupletNumerator=p,x.tupletDenominator=m,x.dots=u,x.preferredBeamDirection=g,this._applyBeatDurationFromTicks(x,d,c,!0)),this._musicalPosition=x.displayEnd,this._lastBeat=x};for(let t of e.childElements())switch(t.localName){case"grace":let e=Number.parseFloat(t.getAttribute("make-time","-1"));e>=0?(r=this._musicXmlDivisionsToAlphaTabTicks(e),a=2):a=1,"yes"===t.getAttribute("slash")&&(a=2);break;case"chord":o=!0;break;case"cue":return;case"pitch":f=this._parsePitch(t),b=!0;break;case"unpitched":f=this._parseUnpitched(t,s);break;case"rest":f=null,null===c&&(c=1);break;case"duration":d=this._parseDuration(t);break;case"instrument":y=t.getAttribute("id","");break;case"voice":h=Number.parseInt(t.innerText,10),Number.isNaN(h)?(re.warning("MusicXML","Voices need to be specified as numbers"),h=0):h-=1;break;case"type":c=this._parseBeatDuration(t);break;case"dot":u++;break;case"accidental":null===f?re.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this._parseAccidental(t,f);break;case"time-modification":for(let e of t.childElements())switch(e.localName){case"actual-notes":p=Number.parseInt(e.innerText,10);break;case"normal-notes":m=Number.parseInt(e.innerText,10)}break;case"stem":g=this._parseStem(t);break;case"notehead":null===f?re.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this._parseNoteHead(t,f,c??4,g??this._estimateBeamDirection(f));break;case"staff":l=Number.parseInt(t.innerText,10)-1;break;case"beam":if("1"===t.getAttribute("number","1"))switch(t.innerText){case"begin":case"continue":n=2;break;case"end":n=1}break;case"notations":k(),this._parseNotations(t,f,i);break;case"lyric":k(),this._parseLyric(t,i,s);break;case"play":this._parsePlay(t,f)}if(b){let e=this._getOrCreateStaff(s,l),t=this._getStaffContext(e).transpose;if(0!==t){let e=12*f.octave+f.tone+t;f.octave=e/12|0,f.tone=e-12*f.octave}}k()}_parsePlay(e,t){for(let s of e.childElements())if("mute"===s.localName)t&&"palm"===s.innerText&&(t.isPalmMute=!0)}_estimateBeamDirection(t){return t.calculateRealValue(!1,!1)<e._b4Value?1:0}_parseNoteHead(e,t,s,i){"yes"===e.getAttribute("parentheses","no")&&(t.isGhost=!0);let a,r=e.getAttribute("filled","");switch("yes"===r?a=!0:"no"===r&&(a=!1),t.style=new at,e.innerText){case"arrow down":t.style.noteHeadCenterOnStem=!0,this._applyNoteHead(t,s,a,57548,57540,57541,57543);break;case"arrow up":t.style.noteHeadCenterOnStem=!0,this._applyNoteHead(t,s,a,57530,57531,57532,57534);break;case"back slashed":this._applyNoteHead(t,s,a,57558,57556,57554,57552);break;case"circle dot":t.style.noteHead=57621;break;case"circle-x":this._applyNoteHead(t,s,a,57520,57521,57522,57523);break;case"circled":this._applyNoteHead(t,s,a,57575,57574,57573,57572);break;case"cluster":this._applyNoteHead(t,s,a,57640,57641,57642,57643);break;case"cross":this._applyNoteHead(t,s,a,57516,57517,57518,57519);break;case"diamond":this._applyNoteHead(t,s,a,57559,57560,57561,57563);break;case"do":this._applyNoteHead(t,s,a,57786,57786,57786,57787);break;case"fa":0===i?this._applyNoteHead(t,s,a,57780,57780,57780,57781):this._applyNoteHead(t,s,a,57782,57782,57782,57783);break;case"fa up":this._applyNoteHead(t,s,a,57782,57782,57782,57783);break;case"inverted triangle":this._applyNoteHead(t,s,a,57548,57540,57541,57543);break;case"la":case"square":this._applyNoteHead(t,s,a,57778,57778,57778,57779);break;case"left triangle":this._applyNoteHead(t,s,a,57537,57537,57537,57538);break;case"mi":this._applyNoteHead(t,s,a,57784,57784,57784,57785);break;case"none":t.style.noteHead=57509;break;case"normal":this._applyNoteHead(t,s,a,57504,57506,57507,57508);break;case"re":this._applyNoteHead(t,s,a,57788,57788,57788,57789);break;case"rectangle":this._applyNoteHead(t,s,a,57528,57528,57528,57529);break;case"slash":this._applyNoteHead(t,s,a,57602,57602,57603,57601);break;case"slashed":this._applyNoteHead(t,s,a,57557,57555,57553,57551);break;case"so":this._applyNoteHead(t,s,a,57776,57776,57776,57777);break;case"ti":this._applyNoteHead(t,s,a,57790,57790,57790,57791);break;case"triangle":this._applyNoteHead(t,s,a,57530,57531,57532,57534);break;case"x":this._applyNoteHead(t,s,a,57510,57511,57512,57513)}}_createRestForGap(e,t){let s=_.toTicks(t);for(;s>e;){if(256===t)return null;t*=2,s=_.toTicks(t)}let i=new wt;return i.dynamics=this._currentDynamics,i.isEmpty=!1,i.duration=t,i.overrideDisplayDuration=s,i.updateDurations(),i}_insertBeatToVoice(e,t){if(t.beats.length>0){let s=t.beats[t.beats.length-1];s.nextBeat=e,e.previousBeat=s;let i=s;for(;null!==i&&0!==i.graceType;)i=i.index>0?i.previousBeat:null;null!==i&&(e.displayStart=i.displayEnd)}t.addBeat(e)}_musicXmlDivisionsToAlphaTabTicks(e){return e*_.QuarterTime/this._divisionsPerQuarterNote}_parseBeatDuration(e){switch(e.innerText){case"1024th":case"512th":case"256th":return 256;case"128th":return 128;case"64th":return 64;case"32nd":return 32;case"16th":return 16;case"eighth":return 8;case"quarter":return 4;case"half":return 2;case"whole":return 1;case"breve":return-2;case"long":return-4}return null}_applyBeatDurationFromTicks(t,s,i,a){if(!i)for(let t=0;t<e._allDurations.length;t++){if(!(s>=e._allDurationTicks[t]))break;i=e._allDurations[t]}t.duration=i??16,a&&(t.overrideDisplayDuration=s),t.updateDurations()}_parseLyric(e,t,s){let i=this._indexToTrackInfo.get(s.index).getLyricLine(e.getAttribute("number",""));for(null===t.lyrics&&(t.lyrics=[]);t.lyrics.length<=i;)t.lyrics.push("");for(let s of e.childElements())switch(s.localName){case"text":t.lyrics[i]?t.lyrics[i]+=` ${s.innerText}`:t.lyrics[i]=s.innerText;break;case"elision":t.lyrics[i]+=s.innerText}}_parseNotations(e,t,s){for(let i of e.childElements())switch(i.localName){case"tied":t&&this._parseTied(i,t,s.voice.bar.staff);break;case"slur":t&&this._parseSlur(i,t);break;case"glissando":t&&this._parseGlissando(i,t);break;case"slide":t&&this._parseSlide(i,t);break;case"ornaments":t&&this._parseOrnaments(i,t);break;case"technical":this._parseTechnical(i,t,s);break;case"articulations":t&&this._parseArticulations(i,t);break;case"dynamics":let e=this._parseDynamics(i);null!==e&&(s.dynamics=e,this._currentDynamics=e);break;case"fermata":this._parseFermata(i,s);break;case"arpeggiate":this._parseArpeggiate(i,s)}}_getStaffContext(e){if(!this._staffToContext.has(e)){let t=new Hi;return this._staffToContext.set(e,t),t}return this._staffToContext.get(e)}_parseGlissando(e,t){let s=e.getAttribute("type"),i=e.getAttribute("number","1"),a=this._getStaffContext(t.beat.voice.bar.staff);switch(s){case"start":a.slideOrigins.set(i,t);break;case"stop":if(a.slideOrigins.has(i)){let e=a.slideOrigins.get(i);e.slideTarget=t,t.slideOrigin=e,e.slideOutType=1}}}_parseSlur(e,t){let s=e.getAttribute("number","1"),i=this._getStaffContext(t.beat.voice.bar.staff);switch(e.getAttribute("type")){case"start":i.slurStarts.set(s,t);break;case"stop":if(i.slurStarts.has(s)){t.isSlurDestination=!0;let e=i.slurStarts.get(s);e.slurDestination=t,t.slurOrigin=e,i.slurStarts.delete(s)}}}_parseArpeggiate(e,t){switch(e.getAttribute("direction","down")){case"down":t.brushType=4;break;case"up":t.brushType=3}}_parseFermata(e,t){let s;switch(e.innerText){case"normal":default:s=1;break;case"angled":s=0;break;case"square":s=2}t.fermata=new At,t.fermata.type=s}_parseArticulations(e,t){for(let s of e.childElements())switch(s.localName){case"accent":t.accentuated=1;break;case"strong-accent":t.accentuated=2;break;case"staccato":t.isStaccato=!0;break;case"tenuto":t.accentuated=3}}_parseTechnical(e,t,s){let i=[];for(let a of e.childElements())switch(a.localName){case"up-bow":s.pickStroke=1;break;case"down-bow":s.pickStroke=2;break;case"harmonic":break;case"fingering":t&&(t.leftHandFinger=this._parseFingering(a));break;case"pluck":t&&(t.rightHandFinger=this._parseFingering(a));break;case"fret":t&&(t.fret=Number.parseInt(a.innerText,10));break;case"string":t&&(t.string=s.voice.bar.staff.tuning.length-Number.parseInt(a.innerText,10)+1);break;case"hammer-on":case"pull-off":t&&(t.isHammerPullOrigin=!0);break;case"bend":i.push(a);break;case"tap":s.tap=!0;break;case"smear":t&&(t.vibrato=1);break;case"golpe":switch(a.getAttribute("placement","above")){case"above":s.golpe=2;break;case"below":s.golpe=1}}t&&i.length>0&&this._parseBends(i,t)}_parseBends(e,t){let s=T.MaxPosition/e.length,i=0,a=0,r=!0;for(let n of e){let e=n.findChildElement("bend-alter");if(e){let o=Math.round(2*Math.abs(Number.parseFloat(e.innerText)));n.findChildElement("pre-bend")?r?(i+=o,t.addBendPoint(new T(a,i)),a+=s,t.addBendPoint(new T(a,i)),r=!1):a+=s:n.findChildElement("release")?(r&&(i+=o),t.addBendPoint(new T(a,i)),a+=s,i-=o,t.addBendPoint(new T(a,i)),r=!1):(t.addBendPoint(new T(a,i)),i+=o,a+=s,t.addBendPoint(new T(a,i)),r=!1)}}}_parseFingering(e){switch(e.innerText){case"0":return-1;case"1":case"p":case"t":return 0;case"2":case"i":return 1;case"3":case"m":return 2;case"4":case"a":return 3;case"5":case"c":return 4}return-2}_parseOrnaments(e,t){let s=-1;for(let i of e.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2"),10),t.isStringed?t.trillValue=t.stringTuning+s:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+s);break;case"turn":t.ornament=2;break;case"inverted-turn":t.ornament=1;break;case"wavy-line":s>0?"start"===i.getAttribute("type")&&(this._currentTrillStep=s):this._currentTrillStep>0?"stop"===i.getAttribute("type")?this._currentTrillStep=-1:t.isStringed?t.trillValue=t.stringTuning+this._currentTrillStep:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+this._currentTrillStep):t.vibrato=1;break;case"mordent":t.ornament=4;break;case"inverted-mordent":t.ornament=3;break;case"tremolo":switch(i.innerText){case"1":t.beat.tremoloSpeed=8;break;case"2":t.beat.tremoloSpeed=16;break;case"3":t.beat.tremoloSpeed=32}}}_parseSlide(e,t){let s=e.getAttribute("type"),i=e.getAttribute("number","1"),a=this._getStaffContext(t.beat.voice.bar.staff);switch(s){case"start":a.slideOrigins.set(i,t);break;case"stop":if(a.slideOrigins.has(i)){let e=a.slideOrigins.get(i);e.slideTarget=t,t.slideOrigin=e,e.slideOutType=1}}}_parseTied(e,t,s){let i=e.getAttribute("type"),a=e.getAttribute("number",""),r=this._getStaffContext(s);if("start"===i){if(a){if(r.tieStartIds.has(a)){let e=r.tieStartIds.get(a);r.tieStarts.delete(e)}r.tieStartIds.set(a,t)}r.tieStarts.add(t)}else if("stop"===i&&!t.isTieDestination){let e=null;if(a){if(!r.tieStartIds.has(a))return;e=r.tieStartIds.get(a),r.tieStartIds.delete(a),r.tieStarts.delete(t)}else{let s=this._calculatePitchedNoteValue(t);for(let t of r.tieStarts)if(this._calculatePitchedNoteValue(t)===s){e=t,r.tieStarts.delete(e);break}}if(!e)return;t.isTieDestination=!0,t.tieOrigin=e}}_parseStem(e){switch(e.innerText){case"down":return 1;case"up":return 0;default:return null}}_parseAccidental(e,t){switch(e.innerText){case"sharp":t.accidentalMode=3;break;case"natural":t.accidentalMode=2;break;case"flat":t.accidentalMode=5;break;case"double-sharp":t.accidentalMode=4;break;case"flat-flat":t.accidentalMode=6}}_calculatePitchedNoteValue(e){return 12*e.octave+e.tone}_parseDuration(e){return this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(e.innerText))}_parseUnpitched(e,t){let s="",i=0;for(let t of e.childElements())switch(t.localName){case"display-step":s=t.innerText;break;case"display-octave":i=Number.parseInt(t.innerText,10)+1}let a=new nt;if(""===s)a.octave=0,a.tone=0;else{let e=12*i+(qe.getToneForText(s)?.noteValue??0);a.octave=e/12|0,a.tone=e-12*a.octave}return a}_parsePitch(e){let t="",s=0,i=0;for(let a of e.childElements())switch(a.localName){case"step":t=a.innerText;break;case"alter":s=Number.parseFloat(a.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(a.innerText,10)+1}s|=0;let a=12*i+(qe.getToneForText(t)?.noteValue??0)+s,r=new nt;return r.octave=a/12|0,r.tone=a-12*r.octave,r}_applyNoteHead(e,t,s,i,a,r,n){if(void 0===s)switch(t){case-4:case-2:e.style.noteHead=i;break;case 1:e.style.noteHead=a;break;case 2:e.style.noteHead=r;break;default:e.style.noteHead=n}else if(!0===s)e.style.noteHead=n;else switch(t){case-4:case-2:e.style.noteHead=i;break;case 1:e.style.noteHead=a;break;default:e.style.noteHead=r}}};Yi._b4Value=71,Yi._allDurations=[256,128,64,32,16,8,4,2,1,-2,-4],Yi._allDurationTicks=Yi._allDurations.map(e=>_.toTicks(e));var Xi=Yi,$i=class{constructor(e){this._writePosition=0,this._readPosition=0,this.count=0,this._buffer=new Float32Array(e)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(e,t,s){let i=0;s>this._buffer.length-this.count&&(s=this._buffer.length-this.count);let a=Math.min(this._buffer.length-this._writePosition,s);return this._buffer.set(e.subarray(t,t+a),this._writePosition),this._writePosition+=a,this._writePosition%=this._buffer.length,i+=a,i<s&&(this._buffer.set(e.subarray(t+i,t+i+s-i),this._writePosition),this._writePosition+=s-i,i=s),this.count+=i,i}read(e,t,s){s>this.count&&(s=this.count);let i=0,a=Math.min(this._buffer.length-this._readPosition,s);return e.set(this._buffer.subarray(this._readPosition,this._readPosition+a),t),i+=a,this._readPosition+=a,this._readPosition%=this._buffer.length,i<s&&(e.set(this._buffer.subarray(this._readPosition,this._readPosition+s-i),t+i),this._readPosition+=s-i,i=s),this.count-=i,i}},Ji=class e{constructor(){this.ready=new ds,this.samplesPlayed=new cs,this.sampleRequest=new ds}get sampleRate(){return e.preferredSampleRate}open(){re.debug("AlphaSynth","Initializing synth worker"),this._worker=bu.globalThis,this._worker.addEventListener("message",this._handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}_handleMessage(t){let s=t.data;switch(s.cmd){case e.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case e.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(s.samples)}}addSamples(e){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:bu.prepareForPostMessage(e)})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}};Ji.CmdOutputPrefix="alphaSynth.output.",Ji.CmdOutputAddSamples=`${Ji.CmdOutputPrefix}addSamples`,Ji.CmdOutputPlay=`${Ji.CmdOutputPrefix}play`,Ji.CmdOutputPause=`${Ji.CmdOutputPrefix}pause`,Ji.CmdOutputResetSamples=`${Ji.CmdOutputPrefix}resetSamples`,Ji.CmdOutputStop=`${Ji.CmdOutputPrefix}stop`,Ji.CmdOutputSampleRequest=`${Ji.CmdOutputPrefix}sampleRequest`,Ji.CmdOutputSamplesPlayed=`${Ji.CmdOutputPrefix}samplesPlayed`,Ji.preferredSampleRate=0;var qi=Ji,ji=class{constructor(e){this.isDefault=!1,this.device=e}get deviceId(){return this.device.deviceId}get label(){return this.device.label}},Ki=class e{static findKnownDevice(t){return e._knownDevices.find(e=>e.deviceId===t)}static createAudioContext(){if("AudioContext"in bu.globalThis)return new AudioContext;if("webkitAudioContext"in bu.globalThis)return new webkitAudioContext;throw new u(0,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in e.createAudioContext()||(re.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await e.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){re.warning("WebAudio","Output device permission rejected",e)}let t=await navigator.mediaDevices.enumerateDevices(),s="",i="",a=new Map;for(let e of t)"audiooutput"===e.kind&&(a.set(e.groupId,new ji(e)),("default"===e.deviceId||""===e.deviceId)&&(s=e.groupId,i=e.deviceId));let r=Array.from(a.values()),n=r.find(e=>e.deviceId===i);return n||(n=r.find(e=>e.device.groupId===s)),!n&&r.length>0&&(n=r[0]),n&&(n.isDefault=!0),e._knownDevices=r,r}catch(e){return re.error("WebAudio","Failed to enumerate output devices",e),[]}}};Ki._knownDevices=[];var Qi=Ki,Zi=class e{constructor(){this.context=null,this.buffer=null,this.source=null,this.ready=new ds,this.samplesPlayed=new cs,this.sampleRequest=new ds}get sampleRate(){return this.context?this.context.sampleRate:e.PreferredSampleRate}activate(e){this.context||(this.context=Qi.createAudioContext()),("suspended"===this.context.state||"interrupted"===this.context.state)&&(re.debug("WebAudio","Audio Context is suspended, trying resume"),this.context.resume().then(()=>{re.debug("WebAudio",`Audio Context resume success: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}`),e&&e()},e=>{re.warning("WebAudio",`Audio Context resume failed: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}, reason=${e}`)}))}_patchIosSampleRate(){let t=navigator.userAgent;if(-1!==t.indexOf("iPhone")||-1!==t.indexOf("iPad")){let t=Qi.createAudioContext(),s=t.createBuffer(1,1,e.PreferredSampleRate),i=t.createBufferSource();i.buffer=s,i.connect(t.destination),i.start(0),i.disconnect(0),t.close()}}open(e){this._patchIosSampleRate(),this.context=Qi.createAudioContext(),"suspended"===this.context.state&&this._registerResumeHandler()}_registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this._unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}_unregisterResumeHandler(){let e=this._resumeHandler;e&&(document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("click",e,!1))}play(){let t=this.context;this.activate(),this.buffer=t.createBuffer(2,e.BufferSize,t.sampleRate),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0}pause(){this.source&&(this.source.stop(0),this.source.disconnect()),this.source=null}destroy(){this.pause(),this.context?.close(),this.context=null,this._unregisterResumeHandler()}onSamplesPlayed(e){this.samplesPlayed.trigger(e)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return Qi.enumerateOutputDevices()}async setOutputDevice(e){await Qi.checkSinkIdSupport()&&(e?await this.context.setSinkId(e.deviceId):await this.context.setSinkId(""))}async getOutputDevice(){if(!await Qi.checkSinkIdSupport())return null;let e=this.context.sinkId;if("string"!=typeof e||""===e||"default"===e)return null;let t=Qi.findKnownDevice(e);if(t)return t;let s=await this.enumerateOutputDevices();return t=s.find(t=>t.deviceId===e),t||(re.warning("WebAudio","Could not find output device in device list",e,s),null)}};Zi.BufferSize=4096,Zi.PreferredSampleRate=44100;var ea=Zi,ta=class e{static init(){var t;e._isRegistered||(e._isRegistered=!0,registerProcessor("alphatab",(t=class extends AudioWorkletProcessor{constructor(e){super(e),this._outputBuffer=new Float32Array(0),this._bufferCount=0,this._requestedBufferCount=0,this._isStopped=!1,re.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(e.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/t.BufferSize),this._circularBuffer=new $i(t.BufferSize*this._bufferCount),this.port.onmessage=this._handleMessage.bind(this)}_handleMessage(e){let t=e.data;switch(t.cmd){case qi.CmdOutputAddSamples:let e=t.samples;this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--;break;case qi.CmdOutputResetSamples:this._circularBuffer.clear();break;case qi.CmdOutputStop:this._isStopped=!0}}process(e,t,s){if(1!==t.length&&2!==t[0].length)return!1;let i=t[0][0],a=t[0][1];if(!i||!a)return!0;let r=i.length+a.length,n=this._outputBuffer;n.length!==r&&(n=new Float32Array(r),this._outputBuffer=n);let o=this._circularBuffer.read(n,0,Math.min(n.length,this._circularBuffer.count)),l=0,h=Math.min(i.length,o);for(let e=0;e<h;e++)i[e]=n[l++],a[e]=n[l++];if(o<i.length)for(let e=o;e<i.length;e++)i[e]=0,a[e]=0;return this.port.postMessage({cmd:qi.CmdOutputSamplesPlayed,samples:o/ze.AudioChannels}),this._requestBuffers(),this._circularBuffer.count>0||!this._isStopped}_requestBuffers(){let e=this._bufferCount/2|0,s=e*t.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*t.BufferSize<s){for(let t=0;t<e;t++)this.port.postMessage({cmd:qi.CmdOutputSampleRequest});this._requestedBufferCount+=e}}},t.BufferSize=4096,t)))}};ta._isRegistered=!1;var sa,ia=ta,aa=class extends ea{constructor(e){super(),this._worklet=null,this._bufferTimeInMilliseconds=0,this._settings=e}open(e){super.open(e),this._bufferTimeInMilliseconds=e,this.onReady()}play(){super.play();let e=this.context;bu.createAudioWorklet(e,this._settings).then(()=>{this._worklet=new AudioWorkletNode(e,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this._handleMessage.bind(this),this.source.connect(this._worklet),this.source.start(0),this._worklet.connect(e.destination)},e=>{re.error("WebAudio",`Audio Worklet creation failed: reason=${e}`)})}_handleMessage(e){let t=e.data;switch(t.cmd){case qi.CmdOutputSamplesPlayed:this.onSamplesPlayed(t.samples);break;case qi.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this._worklet&&(this._worklet.port.postMessage({cmd:qi.CmdOutputStop}),this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(e){this._worklet?.port.postMessage({cmd:qi.CmdOutputAddSamples,samples:bu.prepareForPostMessage(e)})}resetSamples(){this._worklet?.port.postMessage({cmd:qi.CmdOutputResetSamples})}},ra=(e=>(e[e.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",e[e.MultiTrack=1]="MultiTrack",e))(ra||{}),na=class{constructor(){this.events=[]}addEvent(e){if(0===this.events.length||e.tick>=this.events[this.events.length-1].tick)this.events.push(e);else{let t=this.events.length;for(;t>0&&this.events[t-1].tick>e.tick;)t--;this.events.splice(t,0,e)}}writeTo(e){let t=Fs.empty(),s=0;for(let e of this.events){let i=e.tick-s;oa.writeVariableInt(t,i),e.writeTo(t),s=e.tick}let i=new Uint8Array([77,84,114,107]);e.write(i,0,i.length);let a=t.toArray();Ps.writeInt32BE(e,a.length),e.write(a,0,a.length)}},oa=class{constructor(){this.format=0,this.division=_.QuarterTime,this.tracks=[]}get events(){if(1===this.tracks.length)return this.tracks[0].events;let e=[];for(let e of this.tracks)this.events.push(...e.events);return e.sort((e,t)=>e.tick-t.tick),e}_ensureTracks(e){for(;this.tracks.length<e;)this.tracks.push(new na)}addEvent(e){0===this.format?(this._ensureTracks(1),this.tracks[0].addEvent(e)):(this._ensureTracks(e.track+1),this.tracks[e.track].addEvent(e))}toBinary(){let e=Fs.empty();return this.writeTo(e),e.toArray()}writeTo(e){let t=new Uint8Array([77,84,104,100]);e.write(t,0,t.length),Ps.writeInt32BE(e,6),Ps.writeInt16BE(e,this.format),Ps.writeInt16BE(e,this.tracks.length),Ps.writeInt16BE(e,this.division);for(let t of this.tracks)t.writeTo(e)}static writeVariableInt(e,t){let s=new Uint8Array(4),i=0;do{s[i++]=127&t,t>>=7}while(t>0);for(;i>0;)i--,i>0?e.writeByte(128|s[i]):e.writeByte(s[i])}},la=((sa=la||{})[sa.TimeSignature=88]="TimeSignature",sa[sa.NoteOn=128]="NoteOn",sa[sa.NoteOff=144]="NoteOff",sa[sa.ControlChange=176]="ControlChange",sa[sa.ProgramChange=192]="ProgramChange",sa[sa.TempoChange=81]="TempoChange",sa[sa.PitchBend=224]="PitchBend",sa[sa.PerNotePitchBend=96]="PerNotePitchBend",sa[sa.EndOfTrack=47]="EndOfTrack",sa[sa.AlphaTabRest=241]="AlphaTabRest",sa[sa.AlphaTabMetronome=242]="AlphaTabMetronome",sa[sa.SystemExclusive=240]="SystemExclusive",sa[sa.SystemExclusive2=247]="SystemExclusive2",sa[sa.Meta=255]="Meta",sa),ha=class{constructor(e,t,s){this.track=e,this.tick=t,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}},da=class extends ha{constructor(e,t,s,i,a,r){super(e,t,88),this.track=e,this.tick=t,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=a,this.thirtySecondNodesInQuarter=r}writeTo(e){e.writeByte(255),e.writeByte(88),oa.writeVariableInt(e,4),e.writeByte(255&this.numerator),e.writeByte(255&this.denominatorIndex),e.writeByte(255&this.midiClocksPerMetronomeClick),e.writeByte(255&this.thirtySecondNodesInQuarter)}},ca=class e extends ha{writeTo(t){t.writeByte(240);let s=Fs.withCapacity(16);s.writeByte(e.AlphaTabManufacturerId),this.writeEventData(s),s.writeByte(247),oa.writeVariableInt(t,s.length),s.copyTo(t)}};ca.AlphaTabManufacturerId=125,ca.MetronomeEventId=0,ca.RestEventId=1;var ua=ca,pa=class extends ua{constructor(e,t,s,i,a){super(e,t,242),this.isMetronome=!0,this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=a,this.metronomeDurationInTicks=i}writeEventData(e){e.writeByte(ua.MetronomeEventId),e.writeByte(this.metronomeNumerator),Ps.writeInt32LE(e,this.metronomeDurationInTicks),Ps.writeInt32LE(e,this.metronomeDurationInMilliseconds)}},ma=class extends ua{constructor(e,t,s){super(e,t,241),this.channel=s}writeEventData(e){e.writeByte(ua.RestEventId),e.writeByte(this.channel)}},ga=class extends ha{constructor(e,t,s,i,a,r){super(e,t,s),this.channel=i,this.noteKey=a,this.noteVelocity=r}get data1(){return this.noteKey}get data2(){return this.noteVelocity}},fa=class extends ga{constructor(e,t,s,i,a){super(e,t,128,s,i,a)}writeTo(e){e.writeByte(15&this.channel|144),e.writeByte(255&this.noteKey),e.writeByte(255&this.noteVelocity)}},ba=class extends ga{constructor(e,t,s,i,a){super(e,t,144,s,i,a)}writeTo(e){e.writeByte(15&this.channel|128),e.writeByte(255&this.noteKey),e.writeByte(255&this.noteVelocity)}},ya=class extends ha{constructor(e,t,s,i,a){super(e,t,176),this.channel=s,this.controller=i,this.value=a}writeTo(e){e.writeByte(15&this.channel|176),e.writeByte(255&this.controller),e.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}},_a=class extends ha{constructor(e,t,s,i){super(e,t,192),this.channel=s,this.program=i}writeTo(e){e.writeByte(15&this.channel|192),e.writeByte(255&this.program)}get data1(){return this.program}},Sa=class extends ha{constructor(e,t){super(0,e,81),this.beatsPerMinute=0,this.microSecondsPerQuarterNote=t}get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(e){this.beatsPerMinute=6e7/e}writeTo(e){e.writeByte(255),e.writeByte(81),e.writeByte(3),e.writeByte(this.microSecondsPerQuarterNote>>16&255),e.writeByte(this.microSecondsPerQuarterNote>>8&255),e.writeByte(255&this.microSecondsPerQuarterNote)}},ka=class extends ha{constructor(e,t,s,i){super(e,t,224),this.channel=s,this.value=i}writeTo(e){e.writeByte(15&this.channel|224),e.writeByte(127&this.value),e.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}},wa=class extends ha{constructor(e,t,s,i,a){super(e,t,96),this.channel=s,this.noteKey=i,this.value=a}writeTo(e){throw new u(0,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}},Ta=class extends ha{constructor(e,t){super(e,t,47)}writeTo(e){e.writeByte(255),e.writeByte(47),e.writeByte(0)}},Ba=class e{constructor(e,t){this.time=0,this.eventIndex=e,this.event=t,this.isMetronome=242===this.event.type}static newMetronomeEvent(t,s,i,a,r){let n=new pa(0,s,i,a,r);return new e(t,n)}},xa=class{constructor(){this.masterBarIndex=0,this.masterBarOccurence=0,this.synthBpm=0,this.synthTime=0,this.synthTick=0,this.syncTime=0,this.syncBpm=0}updateSyncBpm(e,t){let s=(e-this.synthTime)/(t-this.syncTime)*this.synthBpm;this.syncBpm=s}},va=class{constructor(e,t,s){this.bpm=e,this.ticks=t,this.time=s}},Pa=class{constructor(){this.tempoChanges=[],this.tempoChangeIndex=0,this.syncPoints=[],this.firstProgramEventPerChannel=new Map,this.firstTimeSignatureNumerator=0,this.firstTimeSignatureDenominator=0,this.synthData=[],this.division=_.QuarterTime,this.eventIndex=0,this.currentTime=0,this.syncPointIndex=0,this.playbackRange=null,this.playbackRangeStartTime=0,this.playbackRangeEndTime=0,this.endTick=0,this.endTime=0,this.currentTempo=0,this.syncPointTempo=0}},Na=class{constructor(e){this._oneTimeState=null,this._countInState=null,this.isLooping=!1,this.playbackSpeed=1,this.instrumentPrograms=new Set,this.percussionKeys=new Set,this._synthesizer=e,this._mainState=new Pa,this._currentState=this._mainState}get isPlayingMain(){return this._currentState===this._mainState}get isPlayingOneTimeMidi(){return this._currentState===this._oneTimeState}get isPlayingCountIn(){return this._currentState===this._countInState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(e){this._mainState.playbackRange=e,e&&(this._mainState.playbackRangeStartTime=this._tickPositionToTimePositionWithSpeed(this._mainState,e.startTick,1),this._mainState.playbackRangeEndTime=this._tickPositionToTimePositionWithSpeed(this._mainState,e.endTick,1))}get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}get currentTempo(){return this._currentState.currentTempo}get modifiedTempo(){return this._currentState.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this._currentState.syncPointTempo}get currentSyncPoints(){return this._currentState.syncPoints}mainSeek(e){if(e*=this.playbackSpeed,this.mainPlaybackRange&&(e<this._mainState.playbackRangeStartTime?e=this._mainState.playbackRangeStartTime:e>this._mainState.playbackRangeEndTime&&(e=this._mainState.playbackRangeEndTime)),e>this._mainState.currentTime)this._mainSilentProcess(e-this._mainState.currentTime);else if(e<this._mainState.currentTime){if(this._mainState.currentTime=0,this._mainState.eventIndex=0,this._mainState.syncPointIndex=0,this._mainState.tempoChangeIndex=0,this._mainState.currentTempo=this._mainState.tempoChanges[0].bpm,this._mainState.syncPointTempo=this._mainState.syncPoints.length>0?this._mainState.syncPoints[0].syncBpm:this._mainState.currentTempo,this.isPlayingMain){let e=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(e)}this._mainSilentProcess(e)}}_mainSilentProcess(e){if(e<=0)return;let t=Date.now(),s=this._mainState.currentTime+e;if(this.isPlayingMain)for(;this._mainState.currentTime<s;)this._fillMidiEventQueueLimited(s-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(ze.MicroBufferSize);this._mainState.currentTime=s;let i=Date.now()-t;re.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(e){this._oneTimeState=this.createStateFromFile(e),this._currentState=this._oneTimeState}loadMidi(e){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this._mainState=this.createStateFromFile(e),this._currentState=this._mainState}createStateFromFile(e){let t=new Pa;this.percussionKeys.add(ze.MetronomeKey),t.tempoChanges=[],t.division=e.division,t.eventIndex=0,t.currentTime=0,t.synthData=[];let s=120,i=0,a=0,r=0,n=0,o=0,l=0,h=0,d=0;for(let c of e.events){let u=new Ba(t.synthData.length,c);t.synthData.push(u);let p=c.tick-d;if(i+=p,a+=p*(6e4/(s*e.division)),u.time=a,d=c.tick,n>0)for(;l<i;){let e=Ba.newMetronomeEvent(t.synthData.length,l,Math.floor(l/n)%r,n,o);t.synthData.push(e),e.time=h,l+=n,h+=o}if(81===c.type)s=c.beatsPerMinute,t.tempoChanges.push(new va(s,i,a)),o=n*(6e4/(s*e.division));else if(88===c.type){let i=c,a=Math.pow(2,i.denominatorIndex);r=i.numerator,n=t.division*(4/a)|0,o=n*(6e4/(s*e.division)),0===t.firstTimeSignatureDenominator&&(t.firstTimeSignatureNumerator=i.numerator,t.firstTimeSignatureDenominator=a)}else if(192===c.type){let e=c,s=e.channel;t.firstProgramEventPerChannel.has(s)||t.firstProgramEventPerChannel.set(s,u),s===ze.PercussionChannel||this.instrumentPrograms.add(e.program)}else if(128===c.type){let e=c;e.channel===ze.PercussionChannel&&this.percussionKeys.add(e.noteKey)}}return t.currentTempo=t.tempoChanges.length>0?t.tempoChanges[0].bpm:s,t.syncPointTempo=t.currentTempo,t.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),t.endTime=a,t.endTick=i,t}fillMidiEventQueue(){return this._fillMidiEventQueueLimited(-1)}fillMidiEventQueueToEndTime(e){for(;this._mainState.currentTime<e;)this._fillMidiEventQueueLimited(e-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(ze.MicroBufferSize);let t=!1;for(this._currentState.currentTime=e;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime;){let e=this._currentState.synthData[this._currentState.eventIndex];this._synthesizer.dispatchEvent(e),this._currentState.eventIndex++,t=!0}return t}_fillMidiEventQueueLimited(e){let t=ze.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,s=this._internalEndTime;e>0&&(e<t&&(t=e),s=Math.min(this._internalEndTime,this._currentState.currentTime+e));let i=!1;for(this._currentState.currentTime+=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<s;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(e){return this._tickPositionToTimePositionWithSpeed(this._mainState,e,this.playbackSpeed)}mainUpdateSyncPoints(e){let t=this._mainState;if(e.sort((e,t)=>e.synthTick-t.synthTick),t.syncPoints=[],e.length>=0){let s=120,i=0,a=0,r=0;for(let n=0;n<e.length;n++){let o,l,h,d=e[n],c=0;if(0===n)o=s,l=0,h=0;else{let t=e[n-1];o=t.syncBpm,l=t.syncTime,h=t.synthTick}for(;r<t.tempoChanges.length&&t.tempoChanges[r].ticks<=d.synthTick;){if(c=t.tempoChanges[r].ticks-i,c>0){i+=c,a+=c*(6e4/(s*t.division));let e=(i-h)*((d.syncTime-l)/(d.synthTick-h))+l,r=new xa;r.synthTick=i,r.synthBpm=s,r.synthTime=a,r.syncTime=e,r.syncBpm=o}s=t.tempoChanges[r].bpm,r++}c=d.synthTick-i,i+=c,a+=c*(6e4/(s*t.division)),t.syncPoints.push(d)}}t.syncPointIndex=0,t.syncPointTempo=t.syncPoints.length>0?t.syncPoints[0].syncBpm:t.currentTempo}currentTimePositionToTickPosition(e){let t=this._currentState;if(0===t.tempoChanges.length)return 0;e*=this.playbackSpeed,this._updateCurrentTempo(t,e);let s=t.tempoChanges[t.tempoChangeIndex],i=(e-s.time)/(6e4/(s.bpm*t.division))|0;return s.ticks+i+1}currentUpdateCurrentTempo(e){this._updateCurrentTempo(this._mainState,e*this.playbackSpeed)}_updateCurrentTempo(e,t){let s=e.tempoChangeIndex;for(t<e.tempoChanges[s].time&&(s=0);s+1<e.tempoChanges.length&&e.tempoChanges[s+1].time<=t;)s++;s!==e.tempoChangeIndex&&(e.tempoChangeIndex=s,e.currentTempo=e.tempoChanges[e.tempoChangeIndex].bpm,0===e.syncPoints.length&&(e.syncPointTempo=e.currentTempo))}currentUpdateSyncPoints(e){this._updateSyncPoints(this._mainState,e)}_updateSyncPoints(e,t){let s=e.syncPoints;if(s.length>0){let i=Math.min(e.syncPointIndex,s.length-1);for(t<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=t;)i++;i!==e.syncPointIndex&&(e.syncPointIndex=i,e.syncPointTempo=s[i].syncBpm)}else e.syncPointTempo=e.currentTempo}mainTimePositionFromBackingTrack(e,t){let s=this._mainState,i=s.syncPoints;if(e<0||0===i.length)return e;this._updateSyncPoints(this._mainState,e);let a,r=Math.min(s.syncPointIndex,i.length-1),n=i[r],o=e-n.syncTime;if(r+1<i.length){let e=i[r+1],t=o/(e.syncTime-n.syncTime);a=(e.synthTime-n.synthTime)*t}else{let e=o/(t-n.syncTime);a=(s.endTime-n.synthTime)*e}return(n.synthTime+a)/this.playbackSpeed}mainTimePositionToBackingTrack(e,t){let s=this._mainState,i=s.syncPoints;if(e<0||0===i.length)return e;e*=this.playbackSpeed;let a=Math.min(s.syncPointIndex,i.length-1);for(e<i[a].synthTime&&(a=0);a+1<i.length&&i[a+1].synthTime<=e;)a++;let r,n=i[a],o=e-n.synthTime;if(a+1<i.length){let e=i[a+1],t=o/(e.synthTime-n.synthTime),s=e.syncTime-n.syncTime;r=n.syncTime+s*t}else{let e=o/(s.endTime-n.synthTime),i=t-n.syncTime;r=n.syncTime+i*e}return r}_tickPositionToTimePositionWithSpeed(e,t,s){let i=0,a=120,r=0;for(let s of e.tempoChanges){if(t<s.ticks)break;i=s.time,a=s.bpm,r=s.ticks}return i+=(t-=r)*(6e4/(a*e.division)),i/s}get _internalEndTime(){return this.isPlayingMain&&this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this._internalEndTime}stop(){this.isPlayingMain&&this.mainPlaybackRange?this._currentState.currentTime=this.mainPlaybackRange.startTick:this._currentState.currentTime=0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){let e=new Pa;e.division=this._mainState.division;let t=120,s=4,i=4;0===this._mainState.eventIndex?(t=this._mainState.tempoChanges[0].bpm,s=this._mainState.firstTimeSignatureNumerator,i=this._mainState.firstTimeSignatureDenominator):(t=this._synthesizer.currentTempo,s=this._synthesizer.timeSignatureNumerator,i=this._synthesizer.timeSignatureDenominator),e.tempoChanges.push(new va(t,0,0));let a=e.division*(4/i)|0,r=a*(6e4/(t*this._mainState.division)),n=0,o=0;for(let t=0;t<s;t++){let s=Ba.newMetronomeEvent(e.synthData.length,n,t,a,r);e.synthData.push(s),s.time=o,n+=a,o+=r}e.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),e.endTime=o,e.endTick=n,e.currentTempo=t,e.syncPointTempo=t,this._countInState=e}},Ma=(e=>(e[e.Paused=0]="Paused",e[e.Playing=1]="Playing",e))(Ma||{}),Ea=class{constructor(e,t){this.state=e,this.stopped=t}},La=class{constructor(e,t,s,i,a,r,n){this.originalTempo=0,this.modifiedTempo=0,this.currentTime=e,this.endTime=t,this.currentTick=s,this.endTick=i,this.isSeek=a,this.originalTempo=r,this.modifiedTempo=n}},Ca=class e{constructor(){this.id="",this.size=0}static load(t,s,i){if(t&&e.HeaderSize>t.size||i.position+e.HeaderSize>=i.length||(s.id=Ps.read8BitStringLength(i,4),s.id.charCodeAt(0)<=32||s.id.charCodeAt(0)>=122)||(s.size=Ps.readUInt32LE(i),t&&e.HeaderSize+s.size>t.size))return!1;t&&(t.size-=e.HeaderSize+s.size);let a="RIFF"===s.id,r="LIST"===s.id;return(!a||!t)&&(!a&&!r||(s.id=Ps.read8BitStringLength(i,4),!(s.id.charCodeAt(0)<=32||s.id.charCodeAt(0)>=122)&&(s.size-=4,!0)))}};Ca.HeaderSize=8;var Fa=Ca,Da=class{constructor(e,t,s,i){this.packetData=e,this.isBeginningOfStream=t,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(e){let t=this.packetData,s=new Uint8Array(t.length+e.length);s.set(t,0),s.set(e,t.length)}},Ia=class{constructor(e){this._readable=e}read(){let e=[];for(;this._findAndReadPage(e););return e}_findAndReadPage(e){return!!this._seekPageHeader()&&this._readPage(e)}_seekPageHeader(){for(let e=0;e<65536;e++){if(1399285583===Ps.readInt32LE(this._readable))return!0;this._readable.position-=3}return!1}_readPage(e){let t=this._readable.readByte();if(-1===t||0!==t)return!1;let s=this._readable.readByte(),i=Ps.readInt64LE(this._readable);this._readable.skip(4),this._readable.skip(4),this._readable.skip(4);let a=this._readable.readByte();if(-1===a)return!1;let r=[],n=0;for(let e=0;e<a;e++){let e=this._readable.readByte();n===r.length&&r.push(0),r[n]+=e,e<255&&n++}for(let t=0;t<r.length;t++){let a=new Uint8Array(r[t]);if(this._readable.read(a,0,a.length)!==a.length)return!1;if(1&s){if(0===e.length)throw new u(1,"OGG: Continuation page without any previous packets");e[e.length-1].addData(a)}else{let n=new Da(a,!!(2&s)&&0===t,!!(4&s)&&t===r.length-1,i);e.push(n)}}return!0}},Aa=class{constructor(){this.audioChannels=0,this.audioSampleRate=0,this.samples=new Float32Array(0),this.bitrateMaximum=0,this.bitrateNominal=0,this.bitrateMinimum=0,this.blocksize0=0,this.blocksize1=0}},Ra=class{constructor(){this.value=0,this.bitsRead=0}},Oa=class e{constructor(e){this._bitBucket=0n,this._bitCount=0n,this._overflowBits=0n,this._source=e}readByte(){return this.readBits(e._byteSize)}readBit(){return 1===this.readBits(1)}readBytes(e){let t=new Uint8Array(e);for(let s=0;s<e;s++)t[s]=255&this.readByte();return t}readBits(e){if(0===e)return 0;let t=this.tryPeekBits(e);return this.skipBits(e),t.value}tryPeekBits(e){if(e<0||e>32)throw new u(0,"IO: Cannot read more than 32 bits in one go");if(0===e)return new Ra;let t=new Ra;for(;this._bitCount<e;){let e=BigInt(this._source.readByte());if(-1n===e)return t.bitsRead=Number(this._bitCount),t.value=Number(this._bitBucket),this._bitBucket=0n,this._bitCount=0n,t;this._bitBucket=(0xffn&e)<<this._bitCount|this._bitBucket,this._bitCount+=8n,this._bitCount>32&&(this._overflowBits=e>>40n-this._bitCount&0xffn)}let s=this._bitBucket;return e<64&&(s&=(1n<<BigInt(e))-1n),t.value=Number(s),t.bitsRead=e,t}skipBits(e){let t=BigInt(e);if(0!==e)if(this._bitCount>t){if(this._bitBucket=e>31?0n:this._bitBucket>>t,this._bitCount>32){let s=this._bitCount-32n;this._bitBucket=this._bitBucket|this._overflowBits<<this._bitCount-t-s,s>e&&(this._overflowBits=this._overflowBits>>t&0xffn)}this._bitCount-=t}else if(this._bitCount===t)this._bitBucket=0n,this._bitCount=0n;else{for(t-=this._bitCount,this._bitCount=0n,this._bitBucket=0n;t>8;){if(-1===this._source.readByte()){t=0n;break}t-=8n}if(t>0){let e=BigInt(this._source.readByte());-1n===e||(this._bitBucket=e>>t,this._bitCount=8n-t)}}}};Oa._byteSize=8;var Va=Oa,Wa=class{constructor(){this.codebooks=[],this.timeDomainTransforms=[],this.floors=[],this.residues=[],this.mappings=[],this.modes=[]}},Ha=class{static ilog(e){let t=0;for(;e>0;)++t,e>>=1;return t}static bitReverse(e,t=32){let s=BigInt(e);return s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(t),Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(e){let t=BigInt(e),s=t&BigInt(2097151),i=t&BigInt(2147483648),a=(t&BigInt(2145386496))>>21n;return 0n!==i&&(s=-s),Number(s)*Math.pow(2,Number(a)-788)}},Ga=class{constructor(e){this._data=e}get(e){return this._data[e]}},za=class{get(e){return e}};za.instance=new za;var Ua=za,Ya=class{constructor(e,t){if(this._maxBits=0,this._overflowList=null,this._prefixList=null,this._prefixBitLength=0,this.dimensions=0,this.entries=0,this.mapType=0,5653314!==e.readBits(24))throw new u(1,"Vorbis: Book header had invalid signature!");this.dimensions=e.readBits(16),this.entries=e.readBits(24),this._lengths=new Int32Array(this.entries),this._initTree(e,t),this._initLookupTable(e)}get(e,t){return this._lookupTable[e*this.dimensions+t]}decodeScalar(e){let t=e.tryPeekBits(this._prefixBitLength);if(0===t.bitsRead)return-1;let s=this._prefixList[t.value];if(null!=s)return e.skipBits(s.length),s.value;if(t=e.tryPeekBits(this._maxBits),null!==this._overflowList)for(let i=0;i<this._overflowList.length;i++){s=this._overflowList[i];let a=t.value&s.mask;if(s.bits===a)return e.skipBits(s.length),s.value}return-1}_initTree(e,t){let s,i,a=0;if(e.readBit()){let t=e.readBits(5)+1;for(let s=0;s<this.entries;){let i=e.readBits(Ha.ilog(this.entries-s));for(;--i>=0;)this._lengths[s++]=t;++t}a=0,s=!1,i=t}else{i=-1,s=e.readBit();for(let t=0;t<this.entries;t++)!s||e.readBit()?(this._lengths[t]=e.readBits(5)+1,++a):this._lengths[t]=-1,this._lengths[t]>i&&(i=this._lengths[t])}if(this._maxBits=i,i>-1){let e,i=null;s&&a>=this.entries>>2&&(i=new Int32Array(this.entries),i.set(this._lengths.subarray(0,this.entries),0),s=!1),e=s?a:0;let r=null,n=null;if(s?0!==e&&(i=new Int32Array(e),n=new Int32Array(e),r=new Int32Array(e)):n=new Int32Array(this.entries),!this._computeCodewords(s,n,i,this._lengths,this.entries,r))throw new u(1,"Vorbis: Failed to compute codewords");let o=null==r?Ua.instance:new Ga(r);t.generateTable(o,i??this._lengths,n),this._prefixList=t.prefixTree,this._prefixBitLength=t.tableBits,this._overflowList=t.overflowList}}_computeCodewords(e,t,s,i,a,r){let n=new Uint32Array(32),o=0,l=0;for(o=0;o<a&&!(i[o]>0);++o);if(o===a)return!0;this._addEntry(e,t,s,0,o,l++,i[o],r);for(let e=1;e<=i[o];++e)n[e]=1<<32-e;for(let h=o+1;h<a;++h){let a=i[h];if(a<=0)continue;for(;a>0&&0===n[a];)--a;if(0===a)return!1;let o=n[a];if(n[a]=0,this._addEntry(e,t,s,Ha.bitReverse(o),h,l++,i[h],r),a!==i[h])for(let e=i[h];e>a;--e)n[e]=o+(1<<32-e)}return!0}_addEntry(e,t,s,i,a,r,n,o){e?(t[r]=i,s[r]=n,o[r]=a):t[a]=i}_initLookupTable(e){if(this.mapType=e.readBits(4),0===this.mapType)return;let t=Ha.convertFromVorbisFloat32(e.readBits(32)),s=Ha.convertFromVorbisFloat32(e.readBits(32)),i=e.readBits(4)+1,a=e.readBit(),r=this.entries*this.dimensions,n=new Float32Array(r);1===this.mapType&&(r=this._lookup1Values());let o=new Uint32Array(r);for(let t=0;t<r;t++)o[t]=e.readBits(i);if(1===this.mapType)for(let e=0;e<this.entries;e++){let i=0,l=1;for(let h=0;h<this.dimensions;h++){let d=o[e/l%r|0]*s+t+i;n[e*this.dimensions+h]=d,a&&(i=d),l*=r}}else for(let e=0;e<this.entries;e++){let i=0,r=e*this.dimensions;for(let l=0;l<this.dimensions;l++){let h=o[r]*s+t+i;n[e*this.dimensions+l]=h,a&&(i=h),++r}}this._lookupTable=n}_lookup1Values(){let e=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(e+1,this.dimensions))<=this.entries&&++e,e}},Xa=class{constructor(){this.value=0,this.length=0,this.bits=0,this.mask=0}},$a=class e{constructor(){this.tableBits=0,this.prefixTree=[],this.overflowList=null}generateTable(t,s,i){let a=new Array(s.length),r=0;for(let e=0;e<a.length;e++){let n=new Xa;n.value=t.get(e),n.length=s[e]<=0?99999:s[e],n.bits=i[e],n.mask=(1<<s[e])-1,a[e]=n,s[e]>0&&r<s[e]&&(r=s[e])}a.sort((e,t)=>{let s=e.length-t.length;return 0===s?e.bits-t.bits:s});let n=r>e.maxTableBits?e.maxTableBits:r,o=[],l=null;for(let e=0;e<a.length&&a[e].length<99999;e++){let t=a[e].length;if(t>n)for(l=[];e<a.length&&a[e].length<99999;e++)l.push(a[e]);else{let s=1<<n-t,i=a[e];for(let e=0;e<s;e++){let s=e<<t|i.bits;for(;o.length<=s;)o.push(null);o[s]=i}}}for(;o.length<1<<n;)o.push(null);this.tableBits=n,this.prefixTree=o,this.overflowList=l}};$a.maxTableBits=10;var Ja=$a,qa=class{constructor(e){e.readBits(16)}},ja=class{constructor(e){this.amp=0,this.forceEnergy=!1,this.forceNoEnergy=!1,this.coeff=e}get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}},Ka=class e{constructor(e,t,s,i){if(this._order=e.readBits(8),this._rate=e.readBits(16),this._barkMapSize=e.readBits(16),this._ampBits=e.readBits(6),this._ampOfs=e.readBits(8),this._books=new Array(e.readBits(4)+1),this._order<1||this._rate<1||this._barkMapSize<1||0===this._books.length)throw new u(1,"Vorbis: Invalid Floor0 Data");this._ampDiv=(1<<this._ampBits)-1;for(let t=0;t<this._books.length;t++){let s=e.readBits(8);if(s<0||s>=i.length)throw new u(1,"Vorbis: Invalid Floor0 Data");let a=i[s];if(0===a.mapType||a.dimensions<1)throw new u(1,"Vorbis: Invalid Floor0 Data");this._books[t]=a}this._bookBits=Ha.ilog(this._books.length),this._barkMaps=new Map([[t,this._synthesizeBarkCurve(t/2)],[s,this._synthesizeBarkCurve(s/2)]]),this._wMap=new Map([[t,this._synthesizeWDelMap(t/2)],[s,this._synthesizeWDelMap(s/2)]])}_synthesizeBarkCurve(t){let s=this._barkMapSize/e._toBARK(this._rate/2),i=new Int32Array(t+1);for(let a=0;a<t-1;a++)i[a]=Math.min(this._barkMapSize-1,Math.floor(e._toBARK(this._rate/2/t*a)*s));return i[t]=-1,i}static _toBARK(e){return 13.1*Math.atan(74e-5*e)+2.24*Math.atan(1.85e-8*e*e)+1e-4*e}_synthesizeWDelMap(e){let t=Math.PI/this._barkMapSize,s=new Float32Array(e);for(let i=0;i<e;i++)s[i]=2*Math.cos(t*i);return s}unpack(e,t,s){let i=new ja(new Float32Array(this._order+1));if(i.amp=e.readBits(this._ampBits),i.amp>0){i.amp=i.amp/this._ampDiv*this._ampOfs;let t=e.readBits(this._bookBits);if(t>=this._books.length)return i.amp=0,i;let s=this._books[t];for(let t=0;t<this._order;){let a=s.decodeScalar(e);if(-1===a)return i.amp=0,i;for(let e=0;t<this._order&&e<s.dimensions;e++,t++)i.coeff[t]=s.get(a,e)}let a=0;for(let e=0;e<this._order;){for(let t=0;e<this._order&&t<s.dimensions;e++,t++)i.coeff[e]+=a;a=i.coeff[e-1]}}return i}apply(e,t,s){let i=e,a=t/2;if(i.amp>0){let e=this._barkMaps.get(t),r=this._wMap.get(t),n=0;for(n=0;n<this._order;n++)i.coeff[n]=2*Math.cos(i.coeff[n]);for(n=0;n<a;){let t=0,a=e[n],o=.5,l=.5,h=r[a];for(t=1;t<this._order;t+=2)l*=h-i.coeff[t-1],o*=h-i.coeff[t];for(t===this._order?(l*=h-i.coeff[t-1],o*=o*(4-h*h),l*=l):(o*=o*(2-h),l*=l*(2+h)),l=i.amp/Math.sqrt(o+l)-this._ampOfs,l=Math.exp(.11512925*l),s[n]*=l;e[++n]===a;)s[n]*=l}}else s.fill(0,0,a)}},Qa=class{constructor(){this.posts=new Int32Array(64),this.postCount=0,this.forceEnergy=!1,this.forceNoEnergy=!1}get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}},Za=class e{constructor(t,s){let i=-1;this._partitionClass=new Int32Array(t.readBits(5));for(let e=0;e<this._partitionClass.length;e++)this._partitionClass[e]=t.readBits(4),this._partitionClass[e]>i&&(i=this._partitionClass[e]);++i,this._classDimensions=new Int32Array(i),this._classSubclasses=new Int32Array(i),this._classMasterbooks=new Array(i),this._classMasterBookIndex=new Int32Array(i),this._subclassBooks=new Array(i),this._subclassBookIndex=new Array(i);for(let e=0;e<i;e++){this._classDimensions[e]=t.readBits(3)+1,this._classSubclasses[e]=t.readBits(2),this._classSubclasses[e]>0&&(this._classMasterBookIndex[e]=t.readBits(8),this._classMasterbooks[e]=s[this._classMasterBookIndex[e]]),this._subclassBooks[e]=new Array(1<<this._classSubclasses[e]),this._subclassBookIndex[e]=new Int32Array(this._subclassBooks[e].length);for(let i=0;i<this._subclassBooks[e].length;i++){let a=t.readBits(8)-1;a>=0&&(this._subclassBooks[e][i]=s[a]),this._subclassBookIndex[e][i]=a}}this._multiplier=t.readBits(2),this._range=e._rangeLookup[this._multiplier],this._yBits=e._yBitsLookup[this._multiplier],++this._multiplier;let a=t.readBits(4),r=[];r.push(0),r.push(1<<a);for(let e=0;e<this._partitionClass.length;e++){let s=this._partitionClass[e];for(let e=0;e<this._classDimensions[s];e++)r.push(t.readBits(a))}this._xList=new Int32Array(r),this._lNeigh=new Int32Array(r.length),this._hNeigh=new Int32Array(r.length),this._sortIdx=new Int32Array(r.length),this._sortIdx[0]=0,this._sortIdx[1]=1;for(let e=2;e<this._lNeigh.length;e++){this._lNeigh[e]=0,this._hNeigh[e]=1,this._sortIdx[e]=e;for(let t=2;t<e;t++){let s=this._xList[t];s<this._xList[e]?s>this._xList[this._lNeigh[e]]&&(this._lNeigh[e]=t):s<this._xList[this._hNeigh[e]]&&(this._hNeigh[e]=t)}}for(let e=0;e<this._sortIdx.length-1;e++)for(let t=e+1;t<this._sortIdx.length;t++){if(this._xList[e]===this._xList[t])throw new u(1,"Vorbis: Invalid Floor1 Data");if(this._xList[this._sortIdx[e]]>this._xList[this._sortIdx[t]]){let s=this._sortIdx[e];this._sortIdx[e]=this._sortIdx[t],this._sortIdx[t]=s}}}unpack(e,t,s){let i=new Qa;if(e.readBit()){let t=2;i.posts[0]=e.readBits(this._yBits),i.posts[1]=e.readBits(this._yBits);for(let s=0;s<this._partitionClass.length;s++){let a=this._partitionClass[s],r=this._classDimensions[a],n=this._classSubclasses[a],o=(1<<n)-1,l=0;if(n>0&&(l=this._classMasterbooks[a].decodeScalar(e),-1===l)){t=0;break}for(let h=0;h<r;h++){let r=this._subclassBooks[a][l&o];if(l>>=n,null!=r&&(i.posts[t]=r.decodeScalar(e),-1===i.posts[t])){t=0,s=this._partitionClass.length;break}++t}}i.postCount=t}return i}apply(e,t,s){let i=e,a=t/2;if(i.postCount>0){let e=this._unwrapPosts(i),t=0,r=i.posts[0]*this._multiplier;for(let n=1;n<i.postCount;n++){let o=this._sortIdx[n];if(e[o]){let e=this._xList[o],n=i.posts[o]*this._multiplier;t<a&&this._renderLineMulti(t,r,Math.min(e,a),n,s),t=e,r=n}if(t>=a)break}t<a&&this._renderLineMulti(t,r,a,r,s)}else s.fill(0,0,a)}_unwrapPosts(e){let t=new Array(64);t.fill(!1),t[0]=!0,t[1]=!0;let s=new Int32Array(64);s[0]=e.posts[0],s[1]=e.posts[1];for(let i=2;i<e.postCount;i++){let a,r=this._lNeigh[i],n=this._hNeigh[i],o=this._renderPoint(this._xList[r],s[r],this._xList[n],s[n],this._xList[i]),l=e.posts[i],h=this._range-o,d=o;a=h<d?2*h:2*d,0!==l?(t[r]=!0,t[n]=!0,t[i]=!0,s[i]=l>=a?h>d?l-d+o:o-l+h-1:l%2==1?o-(l+1)/2:o+l/2):(t[i]=!1,s[i]=o)}for(let t=0;t<e.postCount;t++)e.posts[t]=s[t];return t}_renderPoint(e,t,s,i,a){let r=i-t,n=s-e,o=Math.abs(r)*(a-e)/n|0;return r<0?t-o:t+o}_renderLineMulti(t,s,i,a,r){let n=a-s,o=i-t,l=Math.abs(n),h=1-2*(n>>31&1),d=n/o|0,c=t,u=s,p=-o;for(r[t]*=e._inverseDbTable[s],l-=Math.abs(d)*o;++c<i;)u+=d,p+=l,p>=0&&(p-=o,u+=h),r[c]*=e._inverseDbTable[u]}};Za._rangeLookup=[256,128,86,64],Za._yBitsLookup=[8,7,7,6],Za._inverseDbTable=new Float32Array([1.0649863e-7,1.1341951e-7,1.2079015e-7,1.2863978e-7,1.3699951e-7,1.4590251e-7,1.5538408e-7,1.6548181e-7,1.7623575e-7,1.8768855e-7,1.9988561e-7,2.128753e-7,2.2670913e-7,2.4144197e-7,2.5713223e-7,2.7384213e-7,2.9163793e-7,3.1059021e-7,3.3077411e-7,3.5226968e-7,3.7516214e-7,3.9954229e-7,4.255068e-7,4.5315863e-7,4.8260743e-7,5.1396998e-7,5.4737065e-7,5.8294187e-7,6.2082472e-7,6.6116941e-7,7.0413592e-7,7.4989464e-7,7.9862701e-7,8.505263e-7,9.0579828e-7,9.6466216e-7,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1]);var er=Za,tr=class{constructor(e,t,s,i){let a=e.readBits(16);switch(a){case 0:this.floor=new Ka(e,t,s,i);break;case 1:this.floor=new er(e,i);break;default:throw new u(1,`Vorbis: Invalid Floor type: ${a}`)}}apply(e,t,s){this.floor.apply(e,t,s)}unpack(e,t,s){return this.floor.unpack(e,t,s)}},sr=class e{constructor(t,s,i){this._begin=t.readBits(24),this._end=t.readBits(24),this._partitionSize=t.readBits(24)+1,this._classifications=t.readBits(6)+1,this._classBook=i[t.readBits(8)],this._cascade=new Int32Array(this._classifications);let a=0;for(let s=0;s<this._classifications;s++){let i=t.readBits(3);t.readBit()?this._cascade[s]=t.readBits(5)<<3|i:this._cascade[s]=i,a+=e._icount(this._cascade[s])}let r=new Int32Array(a);for(let e=0;e<a;e++)if(r[e]=t.readBits(8),0===i[r[e]].mapType)throw new u(1,"Vorbis: Invalid Residue 0");let n=this._classBook.entries,o=this._classBook.dimensions,l=1;for(;o>0;){if(l*=this._classifications,l>n)throw new u(1,"Vorbis: Invalid Residue 0");--o}this._books=new Array(this._classifications),a=0;let h,d=0;for(let e=0;e<this._classifications;e++)if(h=Ha.ilog(this._cascade[e]),this._books[e]=new Array(h),h>0){d=Math.max(d,h);for(let t=0;t<h;t++)(this._cascade[e]&1<<t)>0&&(this._books[e][t]=i[r[a++]])}this._maxStages=d,this._decodeMap=new Array(l);for(let e=0;e<l;e++){let t=e,s=l/this._classifications|0;this._decodeMap[e]=new Int32Array(this._classBook.dimensions);for(let i=0;i<this._classBook.dimensions;i++){let a=t/s|0;t-=a*s,s=s/this._classifications|0,this._decodeMap[e][i]=a}}this._channels=s}static _icount(e){let t=0;for(;0!==e;)t+=1&e,e>>=1;return t}decode(e,t,s,i){let a=(this._end<s/2?this._end:s/2)-this._begin;if(a>0&&-1!==t.indexOf(!1)){let t=a/this._partitionSize,s=(t+this._classBook.dimensions-1)/this._classBook.dimensions|0,r=[];for(let e=0;e<this._channels;e++)r.push(new Array(s));for(let s=0;s<this._maxStages;s++)for(let a=0,n=0;a<t;n++){if(0===s)for(let i=0;i<this._channels;i++){let o=this._classBook.decodeScalar(e);if(!(o>=0&&o<this._decodeMap.length)){a=t,s=this._maxStages;break}r[i][n]=this._decodeMap[o]}for(let o=0;a<t&&o<this._classBook.dimensions;o++,a++){let l=this._begin+a*this._partitionSize;for(let h=0;h<this._channels;h++){let d=r[h][n][o];if(this._cascade[d]&1<<s){let r=this._books[d][s];if(r&&this.writeVectors(r,e,i,h,l,this._partitionSize)){a=t,s=this._maxStages;break}}}}}}}writeVectors(e,t,s,i,a,r){let n=s[i],o=r/e.dimensions,l=new Int32Array(o);for(let s=0;s<o;s++)if(l[s]=e.decodeScalar(t),-1===l[s])return!0;for(let t=0;t<e.dimensions;t++)for(let s=0;s<o;s++,a++)n[a]+=e.get(l[s],t);return!1}},ir=class extends sr{writeVectors(e,t,s,i,a,r){let n=s[i];for(let s=0;s<r;){let i=e.decodeScalar(t);if(-1===i)return!0;for(let t=0;t<e.dimensions;s++,t++)n[a+s]+=e.get(i,t)}return!1}},ar=class extends sr{constructor(e,t,s){super(e,1,s),this._realChannels=t}decode(e,t,s,i){super.decode(e,t,s*this._realChannels,i)}writeVectors(e,t,s,i,a,r){let n=0;a/=this._realChannels;for(let i=0;i<r;){let r=e.decodeScalar(t);if(-1===r)return!0;for(let t=0;t<e.dimensions;t++,i++)s[n][a]+=e.get(r,t),++n===this._realChannels&&(n=0,a++)}return!1}},rr=class{constructor(e,t,s){let i=e.readBits(16);switch(i){case 0:this.residue=new sr(e,t,s);break;case 1:this.residue=new ir(e,t,s);break;case 2:this.residue=new ar(e,t,s);break;default:throw new u(1,`Vorbis: Invalid Residue type: ${i}`)}}decode(e,t,s,i){this.residue.decode(e,t,s,i)}},nr=class{constructor(e,t,s,i,a){if(0!==e.readBits(16))throw new u(1,"Vorbis: Invalid mapping type!");let r=1;e.readBit()&&(r+=e.readBits(4));let n=0;e.readBit()&&(n=e.readBits(8)+1);let o=Ha.ilog(t-1);this._couplingAngle=new Int32Array(n),this._couplingMangitude=new Int32Array(n);for(let s=0;s<n;s++){let i=e.readBits(o),a=e.readBits(o);if(i===a||i>t-1||a>t-1)throw new u(1,"Vorbis: Invalid magnitude or angle in mapping header!");this._couplingAngle[s]=a,this._couplingMangitude[s]=i}if(0!==e.readBits(2))throw new u(1,"Vorbis: Reserved bits not 0 in mapping header.");let l=new Int32Array(t);if(r>1)for(let s=0;s<t;s++)if(l[s]=e.readBits(4),l[s]>r)throw new u(1,"Vorbis: Invalid channel mux submap index in mapping header!");this._submapFloor=new Array(r),this._submapResidue=new Array(r);for(let t=0;t<r;t++){e.skipBits(8);let a=e.readBits(8);if(a>=s.length)throw new u(1,"Vorbis: Invalid floor number in mapping header!");let r=e.readBits(8);if(r>=i.length)throw new u(1,"Vorbis: Invalid residue number in mapping header!");this._submapFloor[t]=s[a],this._submapResidue[t]=i[r]}this._channelFloor=new Array(t),this._channelResidue=new Array(t);for(let e=0;e<t;e++)this._channelFloor[e]=this._submapFloor[l[e]],this._channelResidue[e]=this._submapResidue[l[e]];this._mdct=a}decodePacket(e,t,s){let i=t>>1,a=new Array(this._channelFloor.length),r=new Array(this._channelFloor.length);r.fill(!1);for(let n=0;n<this._channelFloor.length;n++)a[n]=this._channelFloor[n].unpack(e,t,n),r[n]=!a[n].executeChannel,s[n].fill(0,0,i);for(let e=0;e<this._couplingAngle.length;e++)(a[this._couplingAngle[e]].executeChannel||a[this._couplingMangitude[e]].executeChannel)&&(a[this._couplingAngle[e]].forceEnergy=!0,a[this._couplingMangitude[e]].forceEnergy=!0);for(let i=0;i<this._submapFloor.length;i++){for(let e=0;e<this._channelFloor.length;e++)(this._submapFloor[i]!==this._channelFloor[e]||this._submapResidue[i]!==this._channelResidue[e])&&(a[e].forceNoEnergy=!0);this._submapResidue[i].decode(e,r,t,s)}for(let e=this._couplingAngle.length-1;e>=0;e--)if(a[this._couplingAngle[e]].executeChannel||a[this._couplingMangitude[e]].executeChannel){let t=s[this._couplingMangitude[e]],a=s[this._couplingAngle[e]];for(let e=0;e<i;e++){let s,i,r=t[e],n=a[e];r>0?n>0?(s=r,i=r-n):(i=r,s=r+n):n>0?(s=r,i=r+n):(i=r,s=r-n),t[e]=s,a[e]=i}}for(let e=0;e<this._channelFloor.length;e++)a[e].executeChannel?(this._channelFloor[e].apply(a[e],t,s[e]),this._mdct.reverse(s[e],t)):s[e].fill(0,i,2*i)}},or=class{constructor(){this.packetStartIndex=0,this.packetTotalLength=0,this.packetValidLength=0}},lr=class{constructor(){this.overlapInfo=new or,this.windowIndex=0}},hr=class{constructor(e=null){this.samplePosition=null,this.samplePosition=e}},dr=class e{constructor(t,s,i,a,r){if(this._overlapInfo=null,this._channels=s,this._blockFlag=t.readBit(),0!==t.readBits(32))throw new u(1,"Vorbis: Mode header had invalid window or transform type!");let n=t.readBits(8);if(n>=r.length)throw new u(1,"Vorbis: Mode header had invalid mapping index!");this._mapping=r[n],this._blockFlag?(this._blockSize=a,this._windows=[e._calcWindow(i,a,i),e._calcWindow(a,a,i),e._calcWindow(i,a,a),e._calcWindow(a,a,a)],this._overlapInfo=[e._calcOverlap(i,a,i),e._calcOverlap(a,a,i),e._calcOverlap(i,a,a),e._calcOverlap(a,a,a)]):(this._blockSize=i,this._windows=[e._calcWindow(i,i,i)])}decode(e,t){let s=this._getPacketInfo(e);this._mapping.decodePacket(e,this._blockSize,t);let i=this._windows[s.windowIndex];for(let e=0;e<this._blockSize;e++)for(let s=0;s<this._channels;s++)t[s][e]*=i[e];return s.overlapInfo}_getPacketInfo(e){let t=new lr;if(this._blockFlag){let s=e.readBit(),i=e.readBit();t.windowIndex=(s?1:0)+(i?2:0);let a=this._overlapInfo[t.windowIndex];t.overlapInfo.packetStartIndex=a.packetStartIndex,t.overlapInfo.packetValidLength=a.packetValidLength,t.overlapInfo.packetTotalLength=a.packetTotalLength}else t.windowIndex=0,t.overlapInfo.packetStartIndex=0,t.overlapInfo.packetValidLength=this._blockSize/2,t.overlapInfo.packetTotalLength=this._blockSize;return t}static _calcWindow(t,s,i){let a=new Float32Array(s),r=t/2,n=i/2,o=s/4-r/2,l=s-s/4-n/2;for(let t=0;t<r;t++){let s=Math.sin((t+.5)/r*e._piHalf);s*=s,a[o+t]=Math.sin(s*e._piHalf)}for(let e=o+r;e<l;e++)a[e]=1;for(let t=0;t<n;t++){let s=Math.sin((n-t-.5)/n*e._piHalf);s*=s,a[l+t]=Math.sin(s*e._piHalf)}return a}static _calcOverlap(e,t,s){let i=s/4,a=t/4-e/4,r=t/4*3+i,n=r-2*i,o=new or;return o.packetStartIndex=a,o.packetValidLength=n,o.packetTotalLength=r,o}};dr._piHalf=1.57079632695;var cr=dr,ur=class e{constructor(t){this._n=t,this._n2=t>>1,this._n4=this._n2>>1,this._n8=this._n4>>1,this._ld=Ha.ilog(t)-1,this._a=new Float32Array(this._n2),this._b=new Float32Array(this._n2),this._c=new Float32Array(this._n4);let s=0,i=0;for(;s<this._n4;++s,i+=2)this._a[i]=Math.cos(4*s*e._pi/t),this._a[i+1]=-Math.sin(4*s*e._pi/t),this._b[i]=.5*Math.cos((i+1)*e._pi/t/2),this._b[i+1]=.5*Math.sin((i+1)*e._pi/t/2);for(s=0,i=0;s<this._n8;++s,i+=2)this._c[i]=Math.cos(2*(i+1)*e._pi/t),this._c[i+1]=-Math.sin(2*(i+1)*e._pi/t);this._bitrev=new Uint16Array(this._n8);for(let e=0;e<this._n8;++e)this._bitrev[e]=vs.int32ToUint16(Ha.bitReverse(e,this._ld-3)<<2)}calcReverse(e){let t,s,i=new Float32Array(this._n2);{let t=this._n2-2,s=0,a=0,r=this._n2;for(;a!==r;)i[t+1]=e[a]*this._a[s]-e[a+2]*this._a[s+1],i[t]=e[a]*this._a[s+1]+e[a+2]*this._a[s],t-=2,s+=2,a+=4;for(a=this._n2-3;t>=0;)i[t+1]=-e[a+2]*this._a[s]- -e[a]*this._a[s+1],i[t]=-e[a+2]*this._a[s+1]+-e[a]*this._a[s],t-=2,s+=2,a-=4}t=e,s=i;{let e=this._n2-8,i=this._n4,a=0,r=this._n4,n=0;for(;e>=0;){let o,l;l=s[i+1]-s[a+1],o=s[i]-s[a],t[r+1]=s[i+1]+s[a+1],t[r]=s[i]+s[a],t[n+1]=l*this._a[e+4]-o*this._a[e+5],t[n]=o*this._a[e+4]+l*this._a[e+5],l=s[i+3]-s[a+3],o=s[i+2]-s[a+2],t[r+3]=s[i+3]+s[a+3],t[r+2]=s[i+2]+s[a+2],t[n+3]=l*this._a[e]-o*this._a[e+1],t[n+2]=o*this._a[e]+l*this._a[e+1],e-=8,r+=4,n+=4,i+=4,a+=4}}this._step3Iter0Loop(this._n>>4,t,this._n2-1-0*this._n4,-this._n8),this._step3Iter0Loop(this._n>>4,t,this._n2-1-1*this._n4,-this._n8),this._step3InnerRLoop(this._n>>5,t,this._n2-1-0*this._n8,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,t,this._n2-1-1*this._n8,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,t,this._n2-1-2*this._n8,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,t,this._n2-1-3*this._n8,-(this._n>>4),16);let a=2;for(;a<this._ld-3>>1;++a){let e=this._n>>a+2,s=e>>1,i=1<<a+1;for(let r=0;r<i;++r)this._step3InnerRLoop(this._n>>a+4,t,this._n2-1-e*r,-s,1<<a+3)}for(;a<this._ld-6;++a){let e=this._n>>a+2,s=1<<a+3,i=e>>1,r=this._n>>a+6,n=1<<a+1,o=this._n2-1,l=0;for(let a=r;a>0;--a)this._step3InnerSLoop(n,t,o,-i,l,s,e),l+=4*s,o-=8}this._step3InnerSLoopLd654(this._n>>5,t,this._n2-1,this._n);{let e=0,i=this._n4-4,a=this._n2-4;for(;i>=0;){let r;r=this._bitrev[e],s[a+3]=t[r],s[a+2]=t[r+1],s[i+3]=t[r+2],s[i+2]=t[r+3],r=this._bitrev[e+1],s[a+1]=t[r],s[a]=t[r+1],s[i+1]=t[r+2],s[i]=t[r+3],i-=4,a-=4,e+=2}}{let e=0,t=0,i=this._n2-4;for(;t<i;){let a,r,n,o,l,h;a=s[t]-s[i+2],r=s[t+1]+s[i+3],n=this._c[e+1]*a+this._c[e]*r,o=this._c[e+1]*r-this._c[e]*a,l=s[t]+s[i+2],h=s[t+1]-s[i+3],s[t]=l+n,s[t+1]=h+o,s[i+2]=l-n,s[i+3]=o-h,a=s[t+2]-s[i],r=s[t+3]+s[i+1],n=this._c[e+3]*a+this._c[e+2]*r,o=this._c[e+3]*r-this._c[e+2]*a,l=s[t+2]+s[i],h=s[t+3]-s[i+1],s[t+2]=l+n,s[t+3]=h+o,s[i]=l-n,s[i+1]=o-h,e+=4,t+=4,i-=4}}{let t=this._n2-8,s=this._n2-8,a=0,r=this._n2-4,n=this._n2,o=this._n-4;for(;s>=0;){let l,h,d,c;c=i[s+6]*this._b[t+7]-i[s+7]*this._b[t+6],d=-i[s+6]*this._b[t+6]-i[s+7]*this._b[t+7],e[a]=c,e[r+3]=-c,e[n]=d,e[o+3]=d,h=i[s+4]*this._b[t+5]-i[s+5]*this._b[t+4],l=-i[s+4]*this._b[t+4]-i[s+5]*this._b[t+5],e[a+1]=h,e[r+2]=-h,e[n+1]=l,e[o+2]=l,c=i[s+2]*this._b[t+3]-i[s+3]*this._b[t+2],d=-i[s+2]*this._b[t+2]-i[s+3]*this._b[t+3],e[a+2]=c,e[r+1]=-c,e[n+2]=d,e[o+1]=d,h=i[s]*this._b[t+1]-i[s+1]*this._b[t],l=-i[s]*this._b[t]-i[s+1]*this._b[t+1],e[a+3]=h,e[r]=-h,e[n+3]=l,e[o]=l,t-=8,s-=8,a+=4,n+=4,r-=4,o-=4}}}_step3InnerRLoop(e,t,s,i,a){let r,n,o=s,l=o+i,h=0;for(let s=e>>2;s>0;--s)r=t[o]-t[l],n=t[o-1]-t[l-1],t[o]+=t[l],t[o-1]+=t[l-1],t[l]=r*this._a[h]-n*this._a[h+1],t[l-1]=n*this._a[h]+r*this._a[h+1],h+=a,r=t[o-2]-t[l-2],n=t[o-3]-t[l-3],t[o-2]+=t[l-2],t[o-3]+=t[l-3],t[l-2]=r*this._a[h]-n*this._a[h+1],t[l-3]=n*this._a[h]+r*this._a[h+1],h+=a,r=t[o-4]-t[l-4],n=t[o-5]-t[l-5],t[o-4]+=t[l-4],t[o-5]+=t[l-5],t[l-4]=r*this._a[h]-n*this._a[h+1],t[l-5]=n*this._a[h]+r*this._a[h+1],h+=a,r=t[o-6]-t[l-6],n=t[o-7]-t[l-7],t[o-6]+=t[l-6],t[o-7]+=t[l-7],t[l-6]=r*this._a[h]-n*this._a[h+1],t[l-7]=n*this._a[h]+r*this._a[h+1],h+=a,o-=8,l-=8}_step3Iter0Loop(e,t,s,i){let a=s,r=a+i,n=0;for(let s=e>>2;s>0;--s){let e,s;e=t[a]-t[r],s=t[a-1]-t[r-1],t[a]+=t[r],t[a-1]+=t[r-1],t[r]=e*this._a[n]-s*this._a[n+1],t[r-1]=s*this._a[n]+e*this._a[n+1],n+=8,e=t[a-2]-t[r-2],s=t[a-3]-t[r-3],t[a-2]+=t[r-2],t[a-3]+=t[r-3],t[r-2]=e*this._a[n]-s*this._a[n+1],t[r-3]=s*this._a[n]+e*this._a[n+1],n+=8,e=t[a-4]-t[r-4],s=t[a-5]-t[r-5],t[a-4]+=t[r-4],t[a-5]+=t[r-5],t[r-4]=e*this._a[n]-s*this._a[n+1],t[r-5]=s*this._a[n]+e*this._a[n+1],n+=8,e=t[a-6]-t[r-6],s=t[a-7]-t[r-7],t[a-6]+=t[r-6],t[a-7]+=t[r-7],t[r-6]=e*this._a[n]-s*this._a[n+1],t[r-7]=s*this._a[n]+e*this._a[n+1],n+=8,a-=8,r-=8}}_step3InnerSLoop(e,t,s,i,a,r,n){let o,l,h=this._a[a],d=this._a[a+1],c=this._a[a+r],u=this._a[a+r+1],p=this._a[a+2*r],m=this._a[a+2*r+1],g=this._a[a+3*r],f=this._a[a+3*r+1],b=s,y=b+i;for(let s=e;s>0;--s)o=t[b]-t[y],l=t[b-1]-t[y-1],t[b]+=t[y],t[b-1]+=t[y-1],t[y]=o*h-l*d,t[y-1]=l*h+o*d,o=t[b-2]-t[y-2],l=t[b-3]-t[y-3],t[b-2]+=t[y-2],t[b-3]+=t[y-3],t[y-2]=o*c-l*u,t[y-3]=l*c+o*u,o=t[b-4]-t[y-4],l=t[b-5]-t[y-5],t[b-4]+=t[y-4],t[b-5]+=t[y-5],t[y-4]=o*p-l*m,t[y-5]=l*p+o*m,o=t[b-6]-t[y-6],l=t[b-7]-t[y-7],t[b-6]+=t[y-6],t[b-7]+=t[y-7],t[y-6]=o*g-l*f,t[y-7]=l*g+o*f,b-=n,y-=n}_step3InnerSLoopLd654(e,t,s,i){let a=i>>3,r=this._a[a],n=s,o=n-16*e;for(;n>o;){let e,s;e=t[n]-t[n-8],s=t[n-1]-t[n-9],t[n]+=t[n-8],t[n-1]+=t[n-9],t[n-8]=e,t[n-9]=s,e=t[n-2]-t[n-10],s=t[n-3]-t[n-11],t[n-2]+=t[n-10],t[n-3]+=t[n-11],t[n-10]=(e+s)*r,t[n-11]=(s-e)*r,e=t[n-12]-t[n-4],s=t[n-5]-t[n-13],t[n-4]+=t[n-12],t[n-5]+=t[n-13],t[n-12]=s,t[n-13]=e,e=t[n-14]-t[n-6],s=t[n-7]-t[n-15],t[n-6]+=t[n-14],t[n-7]+=t[n-15],t[n-14]=(e+s)*r,t[n-15]=(e-s)*r,this._iter54(t,n),this._iter54(t,n-8),n-=16}}_iter54(e,t){let s=e[t]-e[t-4],i=e[t]+e[t-4],a=e[t-2]+e[t-6],r=e[t-2]-e[t-6];e[t]=i+a,e[t-2]=i-a;let n=e[t-3]-e[t-7];e[t-4]=s+n,e[t-6]=s-n;let o=e[t-1]-e[t-5],l=e[t-1]+e[t-5],h=e[t-3]+e[t-7];e[t-1]=l+h,e[t-3]=l-h,e[t-5]=o-r,e[t-7]=o+r}};ur._pi=3.141592653589793;var pr=ur,mr=class{constructor(){this._setupCache=new Map}reverse(e,t){let s;this._setupCache.has(t)?s=this._setupCache.get(t):(s=new pr(t),this._setupCache.set(t,s)),s.calcReverse(e)}},gr=class e{constructor(e,t,s){this._packetIndex=0,this._stream=e,this._setup=t,this._packets=s,this._currentPosition=0,this._prevPacketBuf=null,this._prevPacketStart=0,this._prevPacketEnd=0,this._prevPacketStop=0,this._nextPacketBuf=null,this._eosFound=!1,this._hasPosition=!1,this._modeFieldBits=Ha.ilog(t.modes.length-1)}decode(){let e=new Float32Array(this._packets[this._packets.length-1].granulePosition*this._stream.audioChannels),t=new Float32Array(.2*this._stream.audioSampleRate*this._stream.audioChannels),s=0,i=0;for(;s=this.read(t,0,t.length),0!==s;){if(i+s>=e.length){let s=new Float32Array(e.length+t.length);s.set(e,0),e=s}e.set(t.subarray(0,s),i),i+=s}return e.subarray(0,i)}read(e,t,s){if(0===s)return 0;let i=t,a=t+s;for(;i<a;){if(this._prevPacketStart===this._prevPacketEnd){if(this._eosFound){this._nextPacketBuf=null,this._prevPacketBuf=null;break}let e=this._readNextPacket((i-t)/this._stream.audioChannels);null===e&&(this._prevPacketEnd=this._prevPacketStop),null!==e&&null!==e.samplePosition&&!this._hasPosition&&(this._hasPosition=!0,this._currentPosition=e.samplePosition-(this._prevPacketEnd-this._prevPacketStart)-(i-t)/this._stream.audioChannels)}let s=Math.min((a-i)/this._stream.audioChannels,this._prevPacketEnd-this._prevPacketStart);s>0&&(i+=this._copyBuffer(e,i,s))}return s=i-t,this._currentPosition+=s/this._stream.audioChannels,s}_copyBuffer(e,t,s){let i=t;for(;s>0;this._prevPacketStart++,s--)for(let t=0;t<this._stream.audioChannels;t++)e[i++]=this._prevPacketBuf[t][this._prevPacketStart];return i-t}_readNextPacket(t){let s=this._decodeNextPacket();if(this._eosFound=this._eosFound||s.isEndOfStream,null==s.curPacket)return null;if(null!==s.samplePosition&&s.isEndOfStream){let e=this._currentPosition+t+s.validLen-s.startIndex,i=s.samplePosition-e;i<0&&(s.validLen+=i,s.validLen<0&&(s.validLen=0))}return this._prevPacketEnd>0?(e._overlapBuffers(this._prevPacketBuf,s.curPacket,this._prevPacketStart,this._prevPacketStop,s.startIndex,this._stream.audioChannels),this._prevPacketStart=s.startIndex):null==this._prevPacketBuf&&(this._prevPacketStart=s.validLen),this._nextPacketBuf=this._prevPacketBuf,this._prevPacketEnd=s.validLen,this._prevPacketStop=s.totalLen,this._prevPacketBuf=s.curPacket,new hr(s.samplePosition)}static _overlapBuffers(e,t,s,i,a,r){for(;s<i;s++,a++)for(let i=0;i<r;i++)t[i][a]+=e[i][s]}_decodeNextPacket(){let e=new fr,t=null;if(this._packetIndex>=this._packets.length)e.isEndOfStream=!0;else{t=this._packets[this._packetIndex++];let s=new Va(Fs.fromBuffer(t.packetData));if(e.isEndOfStream=t.isEndOfStream,!s.readBit()){let i=this._setup.modes[s.readBits(this._modeFieldBits)];if(null==this._nextPacketBuf){this._nextPacketBuf=new Array(this._stream.audioChannels);for(let e=0;e<this._stream.audioChannels;e++)this._nextPacketBuf[e]=new Float32Array(this._stream.blocksize1)}let a=i.decode(s,this._nextPacketBuf);return e.startIndex=a.packetStartIndex,e.validLen=a.packetValidLength,e.totalLen=a.packetTotalLength,e.samplePosition=t.granulePosition,e.curPacket=this._nextPacketBuf,e}}return e}},fr=class{constructor(){this.curPacket=null,this.startIndex=0,this.validLen=0,this.totalLen=0,this.isEndOfStream=!1,this.samplePosition=null}},br=class e{constructor(e){this._packetIndex=-1,this._packets=e}read(){let e;for(;;){if(e=this._nextPacket(),null==e)return null;if(e.isBeginningOfStream){let t=this._readStream(e);if(null!=t)return t}}}_nextPacket(){return this._packetIndex++,this._packetIndex<this._packets.length?this._packets[this._packetIndex]:null}_readStream(e){let t=new Aa;if(!this._readIdentificationHeader(t,e)||!this._readComments(this._nextPacket()))return null;let s=new Wa;if(!this._readSetupHeader(t,s,this._nextPacket()))return null;let i,a=[];for(;i=this._nextPacket(),null!=i&&(a.push(i),!i.isEndOfStream););let r=new gr(t,s,a);return t.samples=r.decode(),t}_commonHeaderDecode(t,s){let i=new Uint8Array(7);if(s.read(i,0,i.length),i[0]!==t)return!1;for(let t=0;t<e.vorbisHeaderMarker.length;t++)if(i[1+t]!==e.vorbisHeaderMarker[t])return!1;return!0}_commonHeaderDecodeBit(t,s){let i=s.readBytes(7);if(i[0]!==t)return!1;for(let t=0;t<e.vorbisHeaderMarker.length;t++)if(i[1+t]!==e.vorbisHeaderMarker[t])return!1;return!0}_readIdentificationHeader(t,s){let i=Fs.fromBuffer(s.packetData);if(!this._commonHeaderDecode(1,i)||0!==Ps.readUInt32LE(i)||(t.audioChannels=i.readByte(),t.audioSampleRate=Ps.readUInt32LE(i),t.audioChannels<=0||t.audioSampleRate<=0))return!1;t.bitrateMaximum=Ps.readInt32LE(i),t.bitrateNominal=Ps.readInt32LE(i),t.bitrateMinimum=Ps.readInt32LE(i);let a=i.readByte();return t.blocksize0=1<<(15&a),t.blocksize1=1<<(a>>4),!(t.blocksize0>t.blocksize1||!e._isAllowedBlockSize(t.blocksize0)||!e._isAllowedBlockSize(t.blocksize0)||0===i.readByte())}static _isAllowedBlockSize(e){switch(e){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}_readComments(e){if(null==e)return!1;let t=Fs.fromBuffer(e.packetData);if(!this._commonHeaderDecode(3,t))return!1;let s=Ps.readUInt32LE(t);t.skip(s);let i=Ps.readUInt32LE(t);for(let e=0;e<i;e++){let e=Ps.readUInt32LE(t);t.skip(e)}return 0!==t.readByte()}_readSetupHeader(e,t,s){if(null==s)return!1;let i=new Va(Fs.fromBuffer(s.packetData)),a=new mr,r=new Ja;if(!this._commonHeaderDecodeBit(5,i))return!1;let n=i.readByte()+1;for(let e=0;e<n;e++)t.codebooks.push(new Ya(i,r));n=i.readBits(6)+1;for(let e=0;e<n;e++)t.timeDomainTransforms.push(new qa(i));n=i.readBits(6)+1;for(let s=0;s<n;s++)t.floors.push(new tr(i,e.blocksize0,e.blocksize1,t.codebooks));n=i.readBits(6)+1;for(let s=0;s<n;s++)t.residues.push(new rr(i,e.audioChannels,t.codebooks));n=i.readBits(6)+1;for(let s=0;s<n;s++)t.mappings.push(new nr(i,e.audioChannels,t.floors,t.residues,a));n=i.readBits(6)+1;for(let s=0;s<n;s++)t.modes.push(new cr(i,e.audioChannels,e.blocksize0,e.blocksize1,t.mappings));return!!i.readBit()}};br.vorbisHeaderMarker=new Uint8Array([118,111,114,98,105,115]);var yr=br,_r=class{constructor(e){this.streams=[];let t=new Ia(e).read(),s=new yr(t);for(;;){let e=s.read();if(null==e)break;this.streams.push(e)}}},Sr=class{constructor(){this.phdrs=[],this.pbags=[],this.pmods=[],this.pgens=[],this.insts=[],this.ibags=[],this.imods=[],this.igens=[],this.sHdrs=[],this.sampleData=new Uint8Array(0),this._sampleCache=new Map}decodeSamples(e,t,s){let i=`${e}_${t}_${s}`;if(!this._sampleCache.has(i)){let a,r=this.sampleData.slice(e,t);if(s)a=new _r(Fs.fromBuffer(r)).streams[0].samples;else{let e=new DataView(r.buffer,r.byteOffset,r.length);a=new Float32Array(r.length/2);for(let t=0;t<a.length;t++)a[t]=e.getInt16(2*t,!0)/32767}return this._sampleCache.set(i,a),a}return this._sampleCache.get(i)}load(e){let t=new Fa,s=new Fa;if(!Fa.load(null,t,e)||"sfbk"!==t.id)throw new Xt("Soundfont is not a valid Soundfont2 file");for(;Fa.load(t,s,e);){let t=new Fa;if("pdta"===s.id)for(;Fa.load(s,t,e);)switch(t.id){case"phdr":for(let s=0,i=t.size/Pr.SizeInFile|0;s<i;s++)this.phdrs.push(new Pr(e));break;case"pbag":for(let s=0,i=t.size/xr.SizeInFile|0;s<i;s++)this.pbags.push(new xr(e));break;case"pmod":for(let s=0,i=t.size/Nr.SizeInFile|0;s<i;s++)this.pmods.push(new Nr(e));break;case"pgen":for(let s=0,i=t.size/vr.SizeInFile|0;s<i;s++)this.pgens.push(new vr(e));break;case"inst":for(let s=0,i=t.size/Br.SizeInFile|0;s<i;s++)this.insts.push(new Br(e));break;case"ibag":for(let s=0,i=t.size/kr.SizeInFile|0;s<i;s++)this.ibags.push(new kr(e));break;case"imod":for(let s=0,i=t.size/wr.SizeInFile|0;s<i;s++)this.imods.push(new wr(e));break;case"igen":for(let s=0,i=t.size/Tr.SizeInFile|0;s<i;s++)this.igens.push(new Tr(e));break;case"shdr":for(let s=0,i=t.size/Mr.SizeInFile|0;s<i;s++)this.sHdrs.push(new Mr(e));break;default:e.position+=t.size}else if("sdta"===s.id)for(;Fa.load(s,t,e);)"smpl"===t.id?(this.sampleData=new Uint8Array(t.size),e.read(this.sampleData,0,t.size)):e.position+=t.size;else e.position+=s.size}}},kr=class{constructor(e){this.instGenNdx=Ps.readUInt16LE(e),this.instModNdx=Ps.readUInt16LE(e)}};kr.SizeInFile=4;var wr=class{constructor(e){this.modSrcOper=Ps.readUInt16LE(e),this.modDestOper=Ps.readUInt16LE(e),this.modAmount=Ps.readInt16LE(e),this.modAmtSrcOper=Ps.readUInt16LE(e),this.modTransOper=Ps.readUInt16LE(e)}};wr.SizeInFile=10;var Tr=class{constructor(e){this.genOper=Ps.readUInt16LE(e),this.genAmount=new Er(e)}};Tr.SizeInFile=4;var Br=class{constructor(e){this.instName=Ps.read8BitStringLength(e,20),this.instBagNdx=Ps.readUInt16LE(e)}};Br.SizeInFile=22;var xr=class{constructor(e){this.genNdx=Ps.readUInt16LE(e),this.modNdx=Ps.readUInt16LE(e)}};xr.SizeInFile=4;var vr=class{constructor(e){this.genOper=Ps.readUInt16LE(e),this.genAmount=new Er(e)}};vr.SizeInFile=4,vr.GenInstrument=41,vr.GenKeyRange=43,vr.GenVelRange=44,vr.GenSampleId=53;var Pr=class{constructor(e){this.presetName=Ps.read8BitStringLength(e,20),this.preset=Ps.readUInt16LE(e),this.bank=Ps.readUInt16LE(e),this.presetBagNdx=Ps.readUInt16LE(e),this.library=Ps.readUInt32LE(e),this.genre=Ps.readUInt32LE(e),this.morphology=Ps.readUInt32LE(e)}};Pr.SizeInFile=38;var Nr=class{constructor(e){this.modSrcOper=Ps.readUInt16LE(e),this.modDestOper=Ps.readUInt16LE(e),this.modAmount=Ps.readUInt16LE(e),this.modAmtSrcOper=Ps.readUInt16LE(e),this.modTransOper=Ps.readUInt16LE(e)}};Nr.SizeInFile=10;var Mr=class{constructor(e){this.sampleName=Ps.read8BitStringLength(e,20),this.start=Ps.readUInt32LE(e),this.end=Ps.readUInt32LE(e),this.startLoop=Ps.readUInt32LE(e),this.endLoop=Ps.readUInt32LE(e),this.sampleRate=Ps.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=Ps.readSInt8(e),this.sampleLink=Ps.readUInt16LE(e),this.sampleType=Ps.readUInt16LE(e)}};Mr.SizeInFile=46;var Er=class{get shortAmount(){return vs.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(e){this.wordAmount=Ps.readUInt16LE(e)}},Lr=class{constructor(){this.presetIndex=0,this.bank=0,this.pitchWheel=0,this.perNotePitchWheel=new Map,this.midiPan=0,this.midiVolume=0,this.midiExpression=0,this.midiRpn=0,this.midiData=0,this.panOffset=0,this.gainDb=0,this.pitchRange=0,this.tuning=0,this.mixVolume=0,this.mute=!1,this.solo=!1}},Cr=class{constructor(){this.activeChannel=0,this.channelList=[]}setupVoice(e,t){let s=this.channelList[this.activeChannel],i=t.region.pan+s.panOffset;t.playingChannel=this.activeChannel,t.mixVolume=s.mixVolume,t.noteGainDb+=s.gainDb,t.updatePitchRatio(s,e.outSampleRate),i<=-.5?(t.panFactorLeft=1,t.panFactorRight=0):i>=.5?(t.panFactorLeft=0,t.panFactorRight=1):(t.panFactorLeft=Math.sqrt(.5-i),t.panFactorRight=Math.sqrt(.5+i))}},Fr=class{constructor(){this.name="",this.presetNumber=0,this.bank=0,this.regions=null}},Dr=class{static timecents2Secs(e){return Math.pow(2,e/1200)}static decibelsToGain(e){return e>-100?Math.pow(10,.05*e):0}static gainToDecibels(e){return e<=1e-5?-100:20*Math.log10(e)}static cents2Hertz(e){return 8.176*Math.pow(2,e/1200)}},Ir=class{constructor(e){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0,e&&(this.delay=e.delay,this.attack=e.attack,this.hold=e.hold,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.keynumToHold=e.keynumToHold,this.keynumToDecay=e.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(e){this.delay=this.delay<-11950?0:Dr.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Dr.timecents2Secs(this.attack),this.release=this.release<-11950?0:Dr.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:Dr.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:Dr.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=e?Dr.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}},Ar=class e{constructor(t){this.loopMode=0,this.samples=e._noSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv=new Ir,this.modEnv=new Ir,this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,t&&(this.loopMode=t.loopMode,this.samples=t.samples,this.sampleRate=t.sampleRate,this.loKey=t.loKey,this.hiKey=t.hiKey,this.loVel=t.loVel,this.hiVel=t.hiVel,this.group=t.group,this.offset=t.offset,this.end=t.end,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.transpose=t.transpose,this.tune=t.tune,this.pitchKeyCenter=t.pitchKeyCenter,this.pitchKeyTrack=t.pitchKeyTrack,this.attenuation=t.attenuation,this.pan=t.pan,this.ampEnv=new Ir(t.ampEnv),this.modEnv=new Ir(t.modEnv),this.initialFilterQ=t.initialFilterQ,this.initialFilterFc=t.initialFilterFc,this.modEnvToPitch=t.modEnvToPitch,this.modEnvToFilterFc=t.modEnvToFilterFc,this.modLfoToFilterFc=t.modLfoToFilterFc,this.modLfoToVolume=t.modLfoToVolume,this.delayModLFO=t.delayModLFO,this.freqModLFO=t.freqModLFO,this.modLfoToPitch=t.modLfoToPitch,this.delayVibLFO=t.delayVibLFO,this.freqVibLFO=t.freqVibLFO,this.vibLfoToPitch=t.vibLfoToPitch)}clear(t){this.loopMode=0,this.samples=e._noSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,!t&&(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(e,t){switch(e){case 0:this.offset+=vs.int16ToUint32(t.shortAmount);break;case 1:this.end+=vs.int16ToUint32(t.shortAmount);break;case 2:this.loopStart+=vs.int16ToUint32(t.shortAmount);break;case 3:this.loopEnd+=vs.int16ToUint32(t.shortAmount);break;case 4:this.offset+=32768*vs.int16ToUint32(t.shortAmount);break;case 5:this.modLfoToPitch=t.shortAmount;break;case 6:this.vibLfoToPitch=t.shortAmount;break;case 7:this.modEnvToPitch=t.shortAmount;break;case 8:this.initialFilterFc=t.shortAmount;break;case 9:this.initialFilterQ=t.shortAmount;break;case 10:this.modLfoToFilterFc=t.shortAmount;break;case 11:this.modEnvToFilterFc=t.shortAmount;break;case 12:this.end+=32768*vs.int16ToUint32(t.shortAmount);break;case 13:this.modLfoToVolume=t.shortAmount;break;case 17:this.pan=t.shortAmount/1e3;break;case 21:this.delayModLFO=t.shortAmount;break;case 22:this.freqModLFO=t.shortAmount;break;case 23:this.delayVibLFO=t.shortAmount;break;case 24:this.freqVibLFO=t.shortAmount;break;case 25:this.modEnv.delay=t.shortAmount;break;case 26:this.modEnv.attack=t.shortAmount;break;case 27:this.modEnv.hold=t.shortAmount;break;case 28:this.modEnv.decay=t.shortAmount;break;case 29:this.modEnv.sustain=t.shortAmount;break;case 30:this.modEnv.release=t.shortAmount;break;case 31:this.modEnv.keynumToHold=t.shortAmount;break;case 32:this.modEnv.keynumToDecay=t.shortAmount;break;case 33:this.ampEnv.delay=t.shortAmount;break;case 34:this.ampEnv.attack=t.shortAmount;break;case 35:this.ampEnv.hold=t.shortAmount;break;case 36:this.ampEnv.decay=t.shortAmount;break;case 37:this.ampEnv.sustain=t.shortAmount;break;case 38:this.ampEnv.release=t.shortAmount;break;case 39:this.ampEnv.keynumToHold=t.shortAmount;break;case 40:this.ampEnv.keynumToDecay=t.shortAmount;break;case 43:this.loKey=t.lowByteAmount,this.hiKey=t.highByteAmount;break;case 44:this.loVel=t.lowByteAmount,this.hiVel=t.highByteAmount;break;case 45:this.loopStart+=32768*vs.int16ToUint32(t.shortAmount);break;case 48:this.attenuation+=.1*t.shortAmount;break;case 50:this.loopEnd+=32768*vs.int16ToUint32(t.shortAmount);break;case 51:this.transpose+=t.shortAmount;break;case 52:this.tune+=t.shortAmount;break;case 54:this.loopMode=3&~t.wordAmount?1==(3&t.wordAmount)?1:0:2;break;case 56:this.pitchKeyTrack=t.shortAmount;break;case 57:this.group=t.wordAmount;break;case 58:this.pitchKeyCenter=t.shortAmount}}};Ar._noSamples=new Float32Array(0);var Rr=Ar,Or=class e{constructor(){this.level=0,this.slope=0,this.samplesUntilNextSegment=0,this.segment=0,this.midiVelocity=0,this.parameters=null,this.segmentIsExponential=!1,this.isAmpEnv=!1}nextSegment(t,s){if(this.parameters)for(;;)switch(t){case 0:if(this.samplesUntilNextSegment=this.parameters.delay*s|0,this.samplesUntilNextSegment>0)return this.segment=1,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);t=1;break;case 1:if(this.samplesUntilNextSegment=this.parameters.attack*s|0,this.samplesUntilNextSegment>0)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*s|0),this.segment=2,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);t=2;break;case 2:if(this.samplesUntilNextSegment=this.parameters.hold*s|0,this.samplesUntilNextSegment>0)return this.segment=3,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);t=3;break;case 3:if(this.samplesUntilNextSegment=this.parameters.decay*s|0,this.samplesUntilNextSegment>0){if(this.segment=4,this.level=1,this.isAmpEnv){let e=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(e),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/e|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*s|0,this.segmentIsExponential=!1;return}t=4;break;case 4:return this.segment=5,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case 5:if(this.segment=6,this.samplesUntilNextSegment=(this.parameters.release<=0?e._fastReleaseTime:this.parameters.release)*s|0,this.isAmpEnv){let e=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(e),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:return this.segment=7,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(e,t,s,i,a){this.parameters=new Ir(e),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-t),this.parameters.hold=this.parameters.hold<-1e4?0:Dr.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-t),this.parameters.decay=this.parameters.decay<-1e4?0:Dr.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|s,this.isAmpEnv=i,this.nextSegment(0,a)}process(e,t){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),this.samplesUntilNextSegment-=e,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,t)}};Or._fastReleaseTime=.01;var Vr=Or,Wr=class{constructor(){this.samplesUntil=0,this.level=0,this.delta=0}setup(e,t,s){this.samplesUntil=e*s|0,this.delta=4*Dr.cents2Hertz(t)/s,this.level=0}process(e){this.samplesUntil>e?this.samplesUntil-=e:(this.level+=this.delta*e,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}},Hr=class{constructor(e){this.qInv=0,this.a0=0,this.a1=0,this.b1=0,this.b2=0,this.z1=0,this.z2=0,this.active=!1,e&&(this.qInv=e.qInv,this.a0=e.a0,this.a1=e.a1,this.b1=e.b1,this.b2=e.b2,this.z1=e.z1,this.z2=e.z2,this.active=e.active)}setup(e){let t=Math.tan(Math.PI*e),s=t*t,i=1/(1+t*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-t*this.qInv+s)*i}process(e){let t=e*this.a0+this.z1;return this.z1=e*this.a1+this.z2-this.b1*t,this.z2=e*this.a0-this.b2*t,t}},Gr=class e{constructor(){this.playingPreset=0,this.playingKey=0,this.playingChannel=0,this.region=null,this.pitchInputTimecents=0,this.pitchOutputFactor=0,this.sourceSamplePosition=0,this.noteGainDb=0,this.panFactorLeft=0,this.panFactorRight=0,this.playIndex=0,this.loopStart=0,this.loopEnd=0,this.ampEnv=new Vr,this.modEnv=new Vr,this.lowPass=new Hr,this.modLfo=new Wr,this.vibLfo=new Wr,this.mixVolume=0,this.mute=!1}updatePitchRatio(e,t){let s=e.pitchWheel;e.perNotePitchWheel.has(this.playingKey)&&(s+=e.perNotePitchWheel.get(this.playingKey)-8192);let i=8192===s?e.tuning:s/16383*e.pitchRange*2-e.pitchRange+e.tuning;this.calcPitchRatio(i,t)}calcPitchRatio(e,t){if(!this.region)return;let s=this.playingKey+this.region.transpose+this.region.tune/100,i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==e&&(i+=e),this.pitchInputTimecents=100*i,this.pitchOutputFactor=this.region.sampleRate/(Dr.timecents2Secs(100*this.region.pitchKeyCenter)*t)}end(e){this.region&&(this.ampEnv.nextSegment(5,e),this.modEnv.nextSegment(5,e),2===this.region.loopMode&&(this.loopEnd=this.loopStart))}endQuick(e){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(5,e),this.modEnv.parameters.release=0,this.modEnv.nextSegment(5,e)}render(t,s,i,a,r){if(!this.region)return;let n=this.region,o=n.samples,l=0,h=1===t.outputMode?a:-1,d=0!==n.modEnvToPitch||0!==n.modEnvToFilterFc,c=this.modLfo.delta>0&&(0!==n.modLfoToPitch||0!==n.modLfoToFilterFc||0!==n.modLfoToVolume),u=this.vibLfo.delta>0&&0!==n.vibLfoToPitch,p=this.loopStart<this.loopEnd,m=this.loopStart,g=this.loopEnd,f=n.end,b=g+1,y=this.sourceSamplePosition,_=new Hr(this.lowPass),S=0!==n.modLfoToFilterFc||0!==n.modEnvToFilterFc,k=0,w=0,T=0,B=0,x=0!==n.modLfoToPitch||0!==n.modEnvToPitch||0!==n.vibLfoToPitch,v=0,P=0,N=0,M=0,E=0!==n.modLfoToVolume,L=0,C=0;for(S?(k=t.outSampleRate,w=n.initialFilterFc,T=n.modLfoToFilterFc,B=n.modEnvToFilterFc):(k=0,w=0,T=0,B=0),x?(v=0,P=n.modLfoToPitch,N=n.vibLfoToPitch,M=n.modEnvToPitch):(v=Dr.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,P=0,N=0,M=0),E?C=.1*n.modLfoToVolume:(L=Dr.decibelsToGain(this.noteGainDb),C=0);a>0;){let n,F,D=0,I=a>e.renderEffectSampleBlock?e.renderEffectSampleBlock:a;if(a-=I,S){let e=w+this.modLfo.level*T+this.modEnv.level*B;_.active=e<=13500,_.active&&_.setup(Dr.cents2Hertz(e)/k)}switch(x&&(v=Dr.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*P+this.vibLfo.level*N+this.modEnv.level*M))*this.pitchOutputFactor),E&&(L=Dr.decibelsToGain(this.noteGainDb+this.modLfo.level*C)),n=L*this.ampEnv.level,r?n=0:n*=this.mixVolume,this.ampEnv.process(I,t.outSampleRate),d&&this.modEnv.process(I,t.outSampleRate),c&&this.modLfo.process(I),u&&this.vibLfo.process(I),t.outputMode){case 0:for(F=n*this.panFactorLeft,D=n*this.panFactorRight;I-- >0&&y<f;){let e=0|y,t=e>=g&&p?m:e+1,a=y-e,r=o[e]*(1-a)+o[t]*a;_.active&&(r=_.process(r)),s[i+l]+=r*F,l++,s[i+l]+=r*D,l++,y+=v,y>=b&&p&&(y-=g-m+1)}break;case 1:for(F=n*this.panFactorLeft,D=n*this.panFactorRight;I-- >0&&y<f;){let e=0|y,t=e>=g&&p?m:e+1,a=y-e,r=o[e]*(1-a)+o[t]*a;_.active&&(r=_.process(r)),s[i+l]+=r*F,l++,s[i+h]+=r*D,h++,y+=v,y>=b&&p&&(y-=g-m+1)}break;case 2:for(;I-- >0&&y<f;){let e=0|y,t=e>=g&&p?m:e+1,a=y-e,r=o[e]*(1-a)+o[t]*a;_.active&&(r=_.process(r)),s[i+l]=r*n,l++,y+=v,y>=b&&p&&(y-=g-m+1)}}if(y>=f||7===this.ampEnv.segment)return void this.kill()}this.sourceSamplePosition=y,(_.active||S)&&(this.lowPass=_)}kill(){this.playingPreset=-1}};Gr.renderEffectSampleBlock=ze.MicroBufferSize;var zr,Ur=Gr,Yr=class{constructor(e){this.value=e}},Xr=class{get isEmpty(){return void 0===this._head}clear(){this._head=void 0,this._tail=void 0}enqueue(e){let t=new Yr(e);this._tail?(this._tail.next=t,this._tail=t):(this._head=t,this._tail=t)}enqueueFront(e){let t=new Yr(e);t.next=this._head,this._head?this._head=t:(this._head=t,this._tail=t)}peek(){let e=this._head;if(e)return e.value}dequeue(){let e=this._head;if(!e)return;let t=e.next;return this._head=t,t||(this._tail=void 0),e.value}},$r=((zr=$r||{})[zr.BankSelectCoarse=0]="BankSelectCoarse",zr[zr.ModulationCoarse=1]="ModulationCoarse",zr[zr.DataEntryCoarse=6]="DataEntryCoarse",zr[zr.VolumeCoarse=7]="VolumeCoarse",zr[zr.PanCoarse=10]="PanCoarse",zr[zr.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",zr[zr.BankSelectFine=32]="BankSelectFine",zr[zr.ModulationFine=33]="ModulationFine",zr[zr.DataEntryFine=38]="DataEntryFine",zr[zr.VolumeFine=39]="VolumeFine",zr[zr.PanFine=42]="PanFine",zr[zr.ExpressionControllerFine=43]="ExpressionControllerFine",zr[zr.HoldPedal=64]="HoldPedal",zr[zr.LegatoPedal=68]="LegatoPedal",zr[zr.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",zr[zr.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",zr[zr.RegisteredParameterFine=100]="RegisteredParameterFine",zr[zr.RegisteredParameterCourse=101]="RegisteredParameterCourse",zr[zr.AllSoundOff=120]="AllSoundOff",zr[zr.ResetControllers=121]="ResetControllers",zr[zr.AllNotesOff=123]="AllNotesOff",zr),Jr=class e{constructor(e){this._midiEventQueue=new Xr,this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1,this._transpositionPitches=new Map,this._liveTranspositionPitches=new Map,this.currentTempo=0,this.timeSignatureNumerator=0,this.timeSignatureDenominator=0,this.presets=null,this._voices=[],this._channels=null,this._voicePlayIndex=0,this.outputMode=0,this.outSampleRate=0,this.globalGainDb=0,this.outSampleRate=e}synthesize(e,t,s){return this._fillWorkingBuffer(e,t,s)}synthesizeSilent(e){this._fillWorkingBuffer(null,0,e)}channelGetMixVolume(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].mixVolume:1}channelSetMixVolume(e,t){let s=this._channelInit(e);for(let s of this._voices)s.playingChannel===e&&-1!==s.playingPreset&&(s.mixVolume=t);s.mixVolume=t}channelSetMute(e,t){t?this._mutedChannels.set(e,!0):this._mutedChannels.delete(e)}channelSetSolo(e,t){t?this._soloChannels.set(e,!0):this._soloChannels.delete(e),this._isAnySolo=this._soloChannels.size>0}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._liveTranspositionPitches=new Map,this.applyTranspositionPitches(new Map),this._isAnySolo=!1}setChannelTranspositionPitch(e,t){let s=0;this._liveTranspositionPitches.has(e)&&(s=this._liveTranspositionPitches.get(e)),0===t?this._liveTranspositionPitches.delete(e):this._liveTranspositionPitches.set(e,t);for(let i of this._voices)if(i.playingChannel===e&&9!==i.playingChannel){let e=0;e-=s,e+=t,i.playingKey+=e,this._channels&&i.updatePitchRatio(this._channels.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(e){let t=this._transpositionPitches;for(let s of this._voices)if(s.playingChannel>=0&&9!==s.playingChannel){let i=0;t.has(s.playingChannel)&&(i-=t.get(s.playingChannel)),e.has(s.playingChannel)&&(i+=e.get(s.playingChannel)),s.playingKey+=i,this._channels&&s.updatePitchRatio(this._channels.channelList[s.playingChannel],this.outSampleRate)}this._transpositionPitches=e}dispatchEvent(e){this._midiEventQueue.enqueue(e)}_fillWorkingBuffer(e,t,s){let i=this._isAnySolo,a=[];for(;!this._midiEventQueue.isEmpty;){let e=this._midiEventQueue.dequeue();e.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(ze.MetronomeChannel,ze.MetronomeKey),this.channelNoteOn(ze.MetronomeChannel,ze.MetronomeKey,95/127)):e.event&&this.processMidiMessage(e.event),a.push(e)}for(let a of this._voices)if(-1!==a.playingPreset){let r=a.playingChannel,n=this._mutedChannels.has(r)||i&&r!==ze.MetronomeChannel&&!this._soloChannels.has(r);e?a.render(this,e,t,s,n):a.kill()}return a}processMidiMessage(e){switch(e.type){case 88:let t=e;this.timeSignatureNumerator=t.numerator,this.timeSignatureDenominator=Math.pow(2,t.denominatorIndex);break;case 128:let s=e;this.channelNoteOn(s.channel,s.noteKey,s.noteVelocity/127);break;case 144:let i=e;this.channelNoteOff(i.channel,i.noteKey);break;case 176:let a=e;this.channelMidiControl(a.channel,a.controller,a.value);break;case 192:let r=e;this.channelSetPresetNumber(r.channel,r.program,9===r.channel);break;case 81:let n=e;this.currentTempo=n.beatsPerMinute;break;case 224:let o=e;this.channelSetPitchWheel(o.channel,o.value);break;case 96:let l=e,h=l.value;h=h*ze.MaxPitchWheel/ze.MaxPitchWheel20,this.channelSetPerNotePitchWheel(l.channel,l.noteKey,h)}}get metronomeVolume(){return this.channelGetMixVolume(ze.MetronomeChannel)}set metronomeVolume(e){this.setupMetronomeChannel(e)}setupMetronomeChannel(e){this.channelSetMixVolume(ze.MetronomeChannel,e),e>0&&(this.channelSetVolume(ze.MetronomeChannel,1),this.channelSetPresetNumber(ze.MetronomeChannel,0,!0))}get masterVolume(){return Dr.decibelsToGain(this.globalGainDb)}set masterVolume(e){let t=Dr.gainToDecibels(e),s=t-this.globalGainDb;if(0!==s){for(let e of this._voices)-1!==e.playingPreset&&(e.noteGainDb+=s);this.globalGainDb=t}}resetSoft(){for(let e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<6||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);if(this._channels)for(let e of this._channels.channelList)e.presetIndex=0,e.bank=0,e.pitchWheel=8192,e.midiPan=8192,e.perNotePitchWheel.clear(),e.midiVolume=16383,e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0}get presetCount(){return this.presets?.length??0}reset(){for(let e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<6||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);this._channels=null}setOutput(e,t,s){this.outputMode=e,this.outSampleRate=t>=1?t:44100,this.globalGainDb=s}noteOn(e,t,s){if(!this.presets)return;let i=127*s|0;if(e<0||e>=this.presets.length)return;if(s<=0)return void this.noteOff(e,t);let a=this._voicePlayIndex++;for(let r of this.presets[e].regions){if(t<r.loKey||t>r.hiKey||i<r.loVel||i>r.hiVel)continue;let n=null;if(0!==r.group)for(let t of this._voices)t.playingPreset===e&&t.region.group===r.group?t.endQuick(this.outSampleRate):-1===t.playingPreset&&!n&&(n=t);else for(let e of this._voices)-1===e.playingPreset&&(n=e);if(!n){for(let e=0;e<4;e++){let e=new Ur;e.playingPreset=-1,this._voices.push(e)}n=this._voices[this._voices.length-4]}n.region=r,n.playingPreset=e,n.playingKey=t,n.playIndex=a,n.noteGainDb=this.globalGainDb-r.attenuation-Dr.gainToDecibels(1/s),this._channels?this._channels.setupVoice(this,n):(n.calcPitchRatio(0,this.outSampleRate),n.panFactorLeft=Math.sqrt(.5-r.pan),n.panFactorRight=Math.sqrt(.5+r.pan)),n.sourceSamplePosition=r.offset;let o=0!==r.loopMode&&r.loopStart<r.loopEnd;n.loopStart=o?r.loopStart:0,n.loopEnd=o?r.loopEnd:0,n.ampEnv.setup(r.ampEnv,t,i,!0,this.outSampleRate),n.modEnv.setup(r.modEnv,t,i,!1,this.outSampleRate);let l=r.initialFilterQ/10;n.lowPass.qInv=1/Math.pow(10,l/20),n.lowPass.z1=0,n.lowPass.z2=0,n.lowPass.active=r.initialFilterFc<=13500,n.lowPass.active&&n.lowPass.setup(Dr.cents2Hertz(r.initialFilterFc)/this.outSampleRate),n.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),n.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}bankNoteOn(e,t,s,i){let a=this._getPresetIndex(e,t);return-1!==a&&(this.noteOn(a,s,i),!0)}noteOff(e,t){let s=null,i=null,a=[];for(let r of this._voices)r.playingPreset!==e||r.playingKey!==t||r.ampEnv.segment>=6||(!s||r.playIndex<s.playIndex?(s=r,i=r,a.push(r)):r.playIndex===s.playIndex&&(i=r,a.push(r)));if(s)for(let r of a)r!==s&&r!==i&&(r.playIndex!==s.playIndex||r.playingPreset!==e||r.playingKey!==t||r.ampEnv.segment>=6)||r.end(this.outSampleRate)}bankNoteOff(e,t,s){let i=this._getPresetIndex(e,t);return-1!==i&&(this.noteOff(i,s),!0)}noteOffAll(e){for(let t of this._voices)-1!==t.playingPreset&&(e?t.endQuick(this.outSampleRate):t.ampEnv.segment<6&&t.end(this.outSampleRate))}get activeVoiceCount(){let e=0;for(let t of this._voices)-1!==t.playingPreset&&e++;return e}_channelInit(e){if(this._channels&&e<this._channels.channelList.length)return this._channels.channelList[e];this._channels||(this._channels=new Cr);for(let t=this._channels.channelList.length;t<=e;t++){let e=new Lr;e.presetIndex=0,e.bank=0,e.pitchWheel=8192,e.midiPan=8192,e.midiVolume=16383,e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0,e.mixVolume=1,this._channels.channelList.push(e)}return this._channels.channelList[e]}_getPresetIndex(e,t){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){let i=this.presets[s];if(i.presetNumber===t&&i.bank===e)return s}return-1}getPresetName(e){return this.presets?e<0||e>=this.presets.length?null:this.presets[e].name:null}bankGetPresetName(e,t){return this.getPresetName(this._getPresetIndex(e,t))}channelNoteOn(e,t,s){!this._channels||e>this._channels.channelList.length||(this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e)),this._channels.activeChannel=e,this.noteOn(this._channels.channelList[e].presetIndex,t,s))}channelNoteOff(e,t){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));let s=[],i=null,a=null;for(let r of this._voices)-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=6||(!i||r.playIndex<i.playIndex?(i=r,a=r,s.push(r)):r.playIndex===i.playIndex&&(a=r,s.push(r)));if(this._channelInit(e).perNotePitchWheel.delete(t),i)for(let r of s)r!==i&&r!==a&&(r.playIndex!==i.playIndex||-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=6)||r.end(this.outSampleRate)}channelNoteOffAll(e){this._channelInit(e).perNotePitchWheel.clear();for(let t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&t.ampEnv.segment<6&&t.end(this.outSampleRate)}channelSoundsOffAll(e){this._channelInit(e).perNotePitchWheel.clear();for(let t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&(t.ampEnv.segment<6||0===t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate)}channelSetPresetIndex(e,t){this._channelInit(e).presetIndex=vs.int32ToUint16(t)}channelSetPresetNumber(e,t,s=!1){let i=this._channelInit(e),a=0;return s?(a=this._getPresetIndex(128|32767&i.bank,t),-1===a&&(a=this._getPresetIndex(128,t)),-1===a&&(a=this._getPresetIndex(128,0)),-1===a&&(a=this._getPresetIndex(2047&i.bank,t))):a=this._getPresetIndex(2047&i.bank,t),i.presetIndex=a,-1!==a}channelSetBank(e,t){this._channelInit(e).bank=vs.int32ToUint16(t)}channelSetBankPreset(e,t,s){let i=this._channelInit(e),a=this._getPresetIndex(t,s);return-1!==a&&(i.presetIndex=vs.int32ToUint16(a),i.bank=vs.int32ToUint16(t),!0)}channelSetPan(e,t){for(let s of this._voices)if(s.playingChannel===e&&-1!==s.playingPreset){let e=s.region.pan+t-.5;e<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):e>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-e),s.panFactorRight=Math.sqrt(.5+e))}this._channelInit(e).panOffset=t-.5}channelSetVolume(e,t){let s=this._channelInit(e),i=Dr.gainToDecibels(t),a=i-s.gainDb;if(0!==a){for(let t of this._voices)t.playingChannel===e&&-1!==t.playingPreset&&(t.noteGainDb+=a);s.gainDb=i}}channelSetPitchWheel(e,t){let s=this._channelInit(e);s.pitchWheel!==t&&(s.pitchWheel=vs.int32ToUint16(t),this._channelApplyPitch(e,s))}channelSetPerNotePitchWheel(e,t,s){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));let i=this._channelInit(e);i.perNotePitchWheel.has(t)&&i.perNotePitchWheel.get(t)===s||(i.perNotePitchWheel.set(t,s),this._channelApplyPitch(e,i,t))}_channelApplyPitch(e,t,s=-1){for(let i of this._voices)i.playingChannel===e&&-1!==i.playingPreset&&(-1===s||i.playingKey===s)&&i.updatePitchRatio(t,this.outSampleRate)}channelSetPitchRange(e,t){let s=this._channelInit(e);s.pitchRange!==t&&(s.pitchRange=t,8192!==s.pitchWheel&&this._channelApplyPitch(e,s))}channelSetTuning(e,t){let s=this._channelInit(e);s.tuning!==t&&(s.tuning=t,this._channelApplyPitch(e,s))}channelMidiControl(e,t,s){let i=this._channelInit(e);switch(t){case 38:return i.midiData=vs.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(e,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(e,s-64+(i.tuning-(0|i.tuning))));case 7:return i.midiVolume=vs.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 39:return i.midiVolume=vs.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 11:return i.midiExpression=vs.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 43:return i.midiExpression=vs.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 10:return i.midiPan=vs.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(e,i.midiPan/16383);case 42:return i.midiPan=vs.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(e,i.midiPan/16383);case 6:return i.midiData=vs.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(e,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&6===t&&this.channelSetTuning(e,s-64+(i.tuning-(0|i.tuning))));case 0:return void(i.bank=vs.int32ToUint16(32768|s));case 32:return void(i.bank=vs.int32ToUint16((32768&i.bank?(127&i.bank)<<7:0)|s));case 101:return void(i.midiRpn=vs.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case 100:return void(i.midiRpn=vs.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case 98:case 99:return void(i.midiRpn=65535);case 120:return void this.channelSoundsOffAll(e);case 123:return void this.channelNoteOffAll(e);case 121:return i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(e,1),this.channelSetPan(e,.5),void this.channelSetPitchRange(e,2)}}channelGetPresetIndex(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].presetIndex:0}channelGetPresetBank(e){return this._channels&&e<this._channels.channelList.length?32767&this._channels.channelList[e].bank:0}channelGetPan(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].panOffset-.5:.5}channelGetVolume(e){return this._channels&&e<this._channels.channelList.length?Dr.decibelsToGain(this._channels.channelList[e].gainDb):1}channelGetPitchWheel(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchWheel:8192}channelGetPitchRange(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchRange:2}channelGetTuning(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].tuning:0}resetPresets(){this.presets=[]}loadPresets(t,s,i,a){let r=[];for(let a=0;a<t.phdrs.length-1;a++){let n=t.phdrs[a],o=0,l=new Fr;r.push(l),l.name=n.presetName,l.bank=n.bank,l.presetNumber=n.preset;let h=0;for(let e=n.presetBagNdx;e<t.phdrs[a+1].presetBagNdx;e++){let s=0,i=127,a=0,r=127;for(let n=t.pbags[e].genNdx;n<t.pbags[e+1].genNdx;n++){let e=t.pgens[n];if(e.genOper!==vr.GenKeyRange)if(e.genOper!==vr.GenVelRange){if(!(e.genOper!==vr.GenInstrument||e.genAmount.wordAmount>=t.insts.length))for(let n=t.insts[e.genAmount.wordAmount].instBagNdx;n<t.insts[e.genAmount.wordAmount+1].instBagNdx;n++){let e=0,o=127,l=0,d=127;for(let c=t.ibags[n].instGenNdx;c<t.ibags[n+1].instGenNdx;c++){let n=t.igens[c];n.genOper!==vr.GenKeyRange?n.genOper!==vr.GenVelRange?53===n.genOper&&o>=s&&e<=i&&d>=a&&l<=r&&h++:(l=n.genAmount.lowByteAmount,d=n.genAmount.highByteAmount):(e=n.genAmount.lowByteAmount,o=n.genAmount.highByteAmount)}}}else a=e.genAmount.lowByteAmount,r=e.genAmount.highByteAmount;else s=e.genAmount.lowByteAmount,i=e.genAmount.highByteAmount}}l.regions=new Array(h);let d=new Rr;d.clear(!0);for(let r=n.presetBagNdx;r<t.phdrs[a+1].presetBagNdx;r++){let a=t.pbags[r],h=new Rr(d),c=!1;for(let d=a.genNdx;d<t.pbags[r+1].genNdx;d++){let a=t.pgens[d];if(a.genOper===vr.GenInstrument){let r=a.genAmount.wordAmount;if(r>=t.insts.length)continue;let d=new Rr;d.clear(!1);let u=t.insts[r];for(let a=u.instBagNdx;a<t.insts[r+1].instBagNdx;a++){let r=t.ibags[a],c=new Rr(d),p=!1;for(let d=r.instGenNdx;d<t.ibags[a+1].instGenNdx;d++){let a=t.igens[d];if(a.genOper===vr.GenSampleId){if(c.hiKey<h.loKey||c.loKey>h.hiKey||c.hiVel<h.loVel||c.loVel>h.hiVel)continue;h.loKey>c.loKey&&(c.loKey=h.loKey),h.hiKey<c.hiKey&&(c.hiKey=h.hiKey),h.loVel>c.loVel&&(c.loVel=h.loVel),h.hiVel<c.hiVel&&(c.hiVel=h.hiVel),c.offset+=h.offset,c.end+=h.end,c.loopStart+=h.loopStart,c.loopEnd+=h.loopEnd,c.transpose+=h.transpose,c.tune+=h.tune,c.pitchKeyTrack+=h.pitchKeyTrack,c.attenuation+=h.attenuation,c.pan+=h.pan,c.ampEnv.delay+=h.ampEnv.delay,c.ampEnv.attack+=h.ampEnv.attack,c.ampEnv.hold+=h.ampEnv.hold,c.ampEnv.decay+=h.ampEnv.decay,c.ampEnv.sustain+=h.ampEnv.sustain,c.ampEnv.release+=h.ampEnv.release,c.modEnv.delay+=h.modEnv.delay,c.modEnv.attack+=h.modEnv.attack,c.modEnv.hold+=h.modEnv.hold,c.modEnv.decay+=h.modEnv.decay,c.modEnv.sustain+=h.modEnv.sustain,c.modEnv.release+=h.modEnv.release,c.initialFilterQ+=h.initialFilterQ,c.initialFilterFc+=h.initialFilterFc,c.modEnvToPitch+=h.modEnvToPitch,c.modEnvToFilterFc+=h.modEnvToFilterFc,c.delayModLFO+=h.delayModLFO,c.freqModLFO+=h.freqModLFO,c.modLfoToPitch+=h.modLfoToPitch,c.modLfoToFilterFc+=h.modLfoToFilterFc,c.modLfoToVolume+=h.modLfoToVolume,c.delayVibLFO+=h.delayVibLFO,c.freqVibLFO+=h.freqVibLFO,c.vibLfoToPitch+=h.vibLfoToPitch,c.ampEnv.envToSecs(!0),c.modEnv.envToSecs(!1),c.delayModLFO=c.delayModLFO<-11950?0:Dr.timecents2Secs(c.delayModLFO),c.delayVibLFO=c.delayVibLFO<-11950?0:Dr.timecents2Secs(c.delayVibLFO),c.pan<-.5?c.pan=-.5:c.pan>.5&&(c.pan=.5),(c.initialFilterQ<1500||c.initialFilterQ>13500)&&(c.initialFilterQ=0);let r=t.sHdrs[a.genAmount.wordAmount];c.offset+=r.start,c.end+=r.end,c.loopStart+=r.startLoop,c.loopEnd+=r.endLoop,r.endLoop>0&&(c.loopEnd-=1),-1===c.pitchKeyCenter&&(c.pitchKeyCenter=r.originalPitch),c.tune+=r.pitchCorrection,c.sampleRate=r.sampleRate;let d=n.bank===ze.PercussionBank;d&&e._setContainsRange(i,c.loKey,c.hiKey)||!d&&s.has(n.preset)?1&r.sampleType?(re.debug("AlphaSynth",`Loading of used sample ${r.sampleName} for preset ${n.presetName} (bank ${l.bank} program ${l.presetNumber})`),16&r.sampleType?c.samples=t.decodeSamples(r.start,r.end,!0):(c.samples=t.decodeSamples(2*c.offset,2*c.end,!1),c.loopStart>0&&(c.loopStart-=c.offset),c.loopEnd>0&&(c.loopEnd-=c.offset)),c.offset=0,c.end=c.samples.length-1):32783&r.sampleType?(re.debug("AlphaSynth",`Loading sample ${r.sampleName} for preset ${n.presetName} as mono fallback (type ${r.sampleType})`),c.samples=t.decodeSamples(2*c.offset,2*c.end,!1),c.loopStart>0&&(c.loopStart-=c.offset),c.loopEnd>0&&(c.loopEnd-=c.offset),c.offset=0,c.end=c.samples.length-1):(re.warning("AlphaSynth",`Skipping load of unsupported sample ${r.sampleName} for preset ${n.presetName}, sample type ${r.sampleType} is not supported (bank ${l.bank} program ${l.presetNumber})`),c.samples=new Float32Array(0)):(re.debug("AlphaSynth",`Skipping load of unused sample ${r.sampleName} for preset ${n.presetName} (bank ${l.bank} program ${l.presetNumber})`),c.samples=new Float32Array(0)),l.regions[o]=new Rr(c),o++,p=!0}else c.operator(a.genOper,a.genAmount)}r===t.ibags[u.instBagNdx]&&!p&&(d=new Rr(c))}c=!0}else h.operator(a.genOper,a.genAmount)}a===t.pbags[n.presetBagNdx]&&!c&&(d=h)}}if(a&&this.presets)for(let e of r)this.presets.push(e);else this.presets=r}static _setContainsRange(e,t,s){for(let i=t;i<=s;i++)if(e.has(i))return!0;return!1}hasSamplesForProgram(e){let t=this.presets;if(!t)return!1;for(let s of t)if(s.presetNumber===e)for(let e of s.regions)if(e.samples.length>0)return!0;return!1}hasSamplesForPercussion(e){let t=this.presets;if(!t)return!1;for(let s of t)if(s.bank===ze.PercussionBank)for(let t of s.regions)if(t.loKey>=e&&t.hiKey<=e&&t.samples.length>0)return!0;return!1}},qr=class{constructor(e){this.events=e}},jr=class{constructor(e){this.playbackRange=e}},Kr=class{constructor(){this.sampleRate=44100,this.useSyncPoints=!1,this.masterVolume=1,this.metronomeVolume=0,this.trackVolume=new Map,this.trackTranspositionPitches=new Map}},Qr=class{constructor(){this.currentTime=0,this.endTime=0,this.currentTick=0,this.endTick=0}},Zr=class{constructor(e,t,s){this.isSoundFontLoaded=!1,this._isMidiLoaded=!1,this._tickPosition=0,this._timePosition=0,this._metronomeVolume=0,this._countInVolume=0,this.playedEventsQueue=new Xr,this.midiEventsPlayedFilterSet=new Set,this._notPlayedSamples=0,this._synthStopping=!1,this._currentPosition=new La(0,0,0,0,!1,120,120),this.isReady=!1,this.state=0,this._loadedSoundFonts=[],this.readyForPlayback=new ds,this.finished=new ds,this.soundFontLoaded=new ds,this.soundFontLoadFailed=new cs,this.midiLoadFailed=new cs,this.midiEventsPlayed=new cs,re.debug("AlphaSynth","Initializing player"),this.state=0,this.ready=new ds(()=>this.isReady),this.readyForPlayback=new ds(()=>this.isReadyForPlayback),this.midiLoaded=new cs(()=>this._loadedMidiInfo?this._loadedMidiInfo:null),this.stateChanged=new cs(()=>new Ea(this.state,!1)),this.positionChanged=new cs(()=>this._currentPosition),this.playbackRangeChanged=new cs(()=>this.playbackRange?new jr(this.playbackRange):null),re.debug("AlphaSynth","Creating output"),this._output=e,re.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=t,this.sequencer=new Na(this.synthesizer),re.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this._checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this._onSamplesPlayed.bind(this)),this.output.open(s)}get output(){return this._output}get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return re.logLevel}set logLevel(e){re.logLevel=e}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(e){e=Math.max(e,ze.MinVolume),this.updateMasterVolume(e)}updateMasterVolume(e){this.synthesizer.masterVolume=e}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,ze.MinVolume),this._metronomeVolume=e,this.synthesizer.metronomeVolume=e}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,ze.MinVolume),this._countInVolume=e}get midiEventsPlayedFilter(){return Array.from(this.midiEventsPlayedFilterSet)}set midiEventsPlayedFilter(e){this.midiEventsPlayedFilterSet=new Set(e)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(e){e=qe.clamp(e,ze.MinPlaybackSpeed,ze.MaxPlaybackSpeed),this.updatePlaybackSpeed(e)}updatePlaybackSpeed(e){let t=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=e,this.timePosition=this.timePosition*(t/e)}get loadedMidiInfo(){return this._loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._tickPosition}set tickPosition(e){this.timePosition=this.sequencer.mainTickPositionToTimePosition(e)}get timePosition(){return this._timePosition}set timePosition(e){re.debug("AlphaSynth",`Seeking to position ${e}ms (main)`),this.sequencer.mainSeek(e),this.updateTimePosition(e,!0),this.sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(e){this.sequencer.mainPlaybackRange=e,e&&(this.tickPosition=e.startTick),this.playbackRangeChanged.trigger(new jr(e))}get isLooping(){return this.sequencer.isLooping}set isLooping(e){this.sequencer.isLooping=e}destroy(){re.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}onSampleRequest(){if(1===this.state&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let e=new Float32Array(ze.MicroBufferSize*ze.MicroBufferCount*ze.AudioChannels),t=0;for(let s=0;s<ze.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();let s=this.synthesizer.synthesize(e,t,ze.MicroBufferSize);t+=ze.MicroBufferSize*ze.AudioChannels;for(let e of s)this.midiEventsPlayedFilterSet.has(e.event.type)&&this.playedEventsQueue.enqueue(e);if(this.sequencer.isFinished)break}t<e.length&&(e=e.subarray(0,t)),this._notPlayedSamples+=e.length,this.output.addSamples(e)}else{let e=new Float32Array(0);this.output.addSamples(e)}}play(){return!(0!==this.state||!this._isMidiLoaded)&&(this.output.activate(),this._playInternal(),this._countInVolume>0&&(re.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),!0)}_playInternal(){this.sequencer.isPlayingOneTimeMidi&&(re.debug("AlphaSynth","Cancelling one time midi"),this._stopOneTimeMidi()),re.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this._synthStopping=!1,this.state=1,this.stateChanged.trigger(new Ea(this.state,!1))}pause(){0===this.state||!this._isMidiLoaded||(re.debug("AlphaSynth","Pausing playback"),this.state=0,this.stateChanged.trigger(new Ea(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){0===this.state&&this._isMidiLoaded?this.play():this.pause()}stop(){this._isMidiLoaded&&(re.debug("AlphaSynth","Stopping playback"),this.state=0,this.output.pause(),this._notPlayedSamples=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new Ea(this.state,!0)))}playOneTimeMidiFile(e){this.sequencer.isPlayingOneTimeMidi?this._stopOneTimeMidi():this.pause(),this.sequencer.loadOneTimeMidi(e),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this._loadedSoundFonts=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}loadSoundFont(e,t){this.pause();let s=Fs.fromBuffer(e);try{re.debug("AlphaSynth","Loading soundfont from bytes");let e=new Sr;e.load(s),t||(this._loadedSoundFonts=[]),this._loadedSoundFonts.push(e),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),re.debug("AlphaSynth","soundFont successfully loaded"),this._checkReadyForPlayback()}catch(e){re.error("AlphaSynth",`Could not load soundfont from bytes ${e}`),this.soundFontLoadFailed.trigger(e)}}_checkReadyForPlayback(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);let e=this.sequencer.instrumentPrograms,t=this.sequencer.percussionKeys,s=!1;for(let i of this._loadedSoundFonts)this.synthesizer.loadPresets(i,e,t,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(e){this.stop();try{re.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(e),this._isMidiLoaded=!0,this._loadedMidiInfo=new La(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo),re.debug("AlphaSynth","Midi successfully loaded"),this._checkReadyForPlayback(),this.tickPosition=0}catch(e){re.error("AlphaSynth",`Could not load midi from model ${e}`),this.midiLoadFailed.trigger(e)}}applyTranspositionPitches(e){this.synthesizer.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this.synthesizer.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this.synthesizer.channelSetMute(e,t)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(e,t){this.synthesizer.channelSetSolo(e,t)}setChannelVolume(e,t){t=Math.max(t,ze.MinVolume),this.synthesizer.channelSetMixVolume(e,t)}_onSamplesPlayed(e){if(0===e)return;let t=e/this.synthesizer.outSampleRate*1e3;this._notPlayedSamples-=e*ze.AudioChannels,this.updateTimePosition(this._timePosition+t,!1),this.checkForFinish()}checkForFinish(){let e=0,t=0;this.playbackRange&&this.sequencer.isPlayingMain?(e=this.playbackRange.startTick,t=this.playbackRange.endTick):t=this.sequencer.currentEndTick,this._tickPosition>=t&&(this._notPlayedSamples<=0?(this._notPlayedSamples=0,this.sequencer.isPlayingCountIn?(re.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this._playInternal(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(re.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=0,this._stopOneTimeMidi()):this.isLooping?(re.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=e,this._synthStopping=!1):this.synthesizer.activeVoiceCount>0?this._synthStopping||(re.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0):(this._synthStopping=!1,re.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this._synthStopping||(re.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0))}_stopOneTimeMidi(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}_createPositionChangedEventArgs(e){let t=this._timePosition,s=this.sequencer.currentTimePositionToTickPosition(t),i=this.sequencer.currentEndTime,a=this.sequencer.currentEndTick;return t>i&&(t=i,s=a),new La(t,i,s,a,e,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(e,t){this._timePosition=e;let s=this._createPositionChangedEventArgs(t);this._tickPosition=s.currentTick;let i=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(re.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${i}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this._currentPosition=s,this.positionChanged.trigger(s)),t)this.playedEventsQueue.clear();else{let e=[];for(;!this.playedEventsQueue.isEmpty&&this.playedEventsQueue.peek().time<s.currentTime;){let t=this.playedEventsQueue.dequeue();e.push(t.event)}e.length>0&&(e.reverse(),this.midiEventsPlayed.trigger(new qr(e)))}}hasSamplesForProgram(e){return this.synthesizer.hasSamplesForProgram(e)}hasSamplesForPercussion(e){return this.synthesizer.hasSamplesForPercussion(e)}loadBackingTrack(e){}updateSyncPoints(e){}},en=class extends Zr{constructor(e,t){super(e,new Jr(e.sampleRate),t)}exportAudio(e,t,s,i){let a=new tn(e);a.loadMidiFile(t),e.useSyncPoints&&a.updateSyncPoints(s),a.applyTranspositionPitches(i);for(let[t,s]of e.trackTranspositionPitches)a.setChannelTranspositionPitch(t,s);for(let[t,s]of e.trackVolume)a.channelSetMixVolume(t,s);if(e.soundFonts)for(let t of e.soundFonts)a.loadSoundFont(t);else a.loadPresets(this.synthesizer.presets);return e.playbackRange&&a.limitExport(e.playbackRange),a.setup(),a}},tn=class{constructor(e){this._generatedAudioCurrentTime=0,this._generatedAudioEndTime=0,this._synth=new Jr(e.sampleRate),this._sequencer=new Na(this._synth),this._synth.masterVolume=Math.max(e.masterVolume,ze.MinVolume),this._synth.metronomeVolume=Math.max(e.metronomeVolume,ze.MinVolume)}loadSoundFont(e){let t=Fs.fromBuffer(e),s=new Sr;s.load(t);let i=this._sequencer.instrumentPrograms,a=this._sequencer.percussionKeys;this._synth.loadPresets(s,i,a,!0)}loadPresets(e){this._synth.presets=e}limitExport(e){this._sequencer.mainPlaybackRange=e,this._sequencer.mainSeek(this._sequencer.mainTickPositionToTimePosition(e.startTick))}setChannelTranspositionPitch(e,t){this._synth.setChannelTranspositionPitch(e,t)}applyTranspositionPitches(e){this._synth.applyTranspositionPitches(e)}loadMidiFile(e){this._sequencer.loadMidi(e)}updateSyncPoints(e){this._sequencer.mainUpdateSyncPoints(e)}channelSetMixVolume(e,t){t=Math.max(t,ze.MinVolume),this._synth.channelSetMixVolume(e,t)}setup(){this._synth.setupMetronomeChannel(this._synth.metronomeVolume);let e=this._sequencer.currentSyncPoints,t=this._sequencer.currentEndTime;if(0===e.length)this._generatedAudioEndTime=t;else{let t=e[e.length-1],s=t.syncTime,i=this._sequencer.currentEndTick-t.synthTick;i>0&&(s+=_.ticksToMillis(i,t.syncBpm)),this._generatedAudioEndTime=s}}render(e){if(this._sequencer.isFinished)return;let t=1e3*ze.MicroBufferSize/this._synth.outSampleRate,s=Math.ceil(e/t),i=new Float32Array(ze.MicroBufferSize*s*ze.AudioChannels),a=this._sequencer.currentSyncPoints,r=0,n=this._generatedAudioCurrentTime;for(let e=0;e<s;e++){if(a.length>0){this._sequencer.currentUpdateSyncPoints(n),this._sequencer.currentUpdateCurrentTempo(this._sequencer.currentTime);let e=this._sequencer.syncPointTempo/this._sequencer.currentTempo;this._sequencer.playbackSpeed!==e&&(this._sequencer.playbackSpeed=e)}if(this._sequencer.fillMidiEventQueue(),this._synth.synthesize(i,r,ze.MicroBufferSize),r+=ze.MicroBufferSize*ze.AudioChannels,n+=t,this._sequencer.isFinished)break}r<i.length&&(i=i.subarray(0,r));let o=new Qr;return o.currentTime=this._generatedAudioCurrentTime,o.endTime=this._generatedAudioEndTime,o.currentTick=this._sequencer.currentTimePositionToTickPosition(this._sequencer.currentTime),o.endTick=this._sequencer.currentEndTick,this._generatedAudioCurrentTime+=e,o.samples=i,this._sequencer.isFinished&&this._synth.noteOffAll(!0),o}},sn=class{static parseEnum(e,t){switch(typeof e){case"string":let s=Number.parseInt(e,10);return Number.isNaN(s)?t[Object.keys(t).find(t=>t.toLowerCase()===e.toLowerCase())]:s;case"number":return e;case"undefined":case"object":return}throw new u(1,`Could not parse enum value '${e}'`)}static parseEnumExact(e,t){if(e in t)return t[e]}static forEach(e,t){if(e instanceof Map)e.forEach(t);else if("object"==typeof e)for(let s in e)t(e[s],s)}static getValue(e,t){return e instanceof Map?e.get(t):"object"==typeof e?e[t]:null}},an=class{constructor(e,t,s){this.text=e,this.startPos=t,this.endPos=s}},rn=class e{constructor(e){this.style="normal",this.variant="normal",this.weight="normal",this.stretch="normal",this.lineHeight="normal",this.size="1rem",this.families=[],this.parseOnlyFamilies=!1,this._currentTokenIndex=-1,this._input="",this._currentToken=null,this._input=e,this._tokens=this._splitToTokens(e)}_splitToTokens(e){let t=[],s=0;for(;s<e.length;){let i=s;for(;i<e.length&&" "!==e.charAt(i);)i++;i>s&&t.push(new an(e.substring(s,i),s,i)),s=i+1}return t}parse(){if(this._reset(),1===this._tokens.length)switch(this._currentToken?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this._fontStyleVariantWeight(),this._fontSizeLineHeight()),this._fontFamily()}static parseFamilies(t){let s=new e(t);return s.parseOnlyFamilies=!0,s.parse(),s.families}_fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}let e=this._input.substr(this._currentToken.startPos).trim(),t=0;for(;t<e.length;){let s=e.charAt(t);if(" "===s||","===s)t++;else if('"'===s||"'"===s){let i=this._findEndOfQuote(e,t+1,s);this.families.push(e.substring(t+1,i).split(`\\${s}`).join(s)),t=i+1}else{let s=this._findEndOfQuote(e,t+1,",");this.families.push(e.substring(t,s).trim()),t=s+1}}}_findEndOfQuote(e,t,s){let i=!1;for(;t<e.length;){let a=e.charAt(t);if(!i&&a===s)return t;i=!i&&"\\"===a,t+=1}return e.length}_fontSizeLineHeight(){if(!this._currentToken)throw new Error("Missing font size");let e=this._currentToken.text.split("/");if(e.length>=3)throw new Error(`Invalid font size '${this._currentToken}' specified`);if(this._nextToken(),e.length>=2)if("/"===e[1]){if(!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this._nextToken()}else this.size=e[0],this.lineHeight=e[1];else{if(!(e.length>=1))throw new Error("Missing font size");if(this.size=e[0],this._currentToken&&0===this._currentToken.text.indexOf("/"))if("/"===this._currentToken.text){if(this._nextToken(),!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this._nextToken()}else this.lineHeight=this._currentToken.text.substr(1),this._nextToken()}}_nextToken(){this._currentTokenIndex++,this._currentTokenIndex<this._tokens.length?this._currentToken=this._tokens[this._currentTokenIndex]:this._currentToken=null}_fontStyleVariantWeight(){let e=!1,t=!1,s=!1,i=3,a=[];for(;;){if(!this._currentToken)return;let r=this._currentToken.text;switch(r){case"normal":case"inherit":a.push(r),i--,this._nextToken();break;case"italic":case"oblique":this.style=r,e=!0,i--,this._nextToken();break;case"small-caps":this.variant=r,t=!0,i--,this._nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,s=!0,i--,this._nextToken();break;default:return}if(0===i)break}for(;a.length>0;){let i=a.pop();s?t?e||(this.style=i):this.variant=i:this.weight=i}}_reset(){this._currentTokenIndex=-1,this._nextToken()}static quoteFont(e){return-1===e.indexOf(" ")?e:`"${e.replaceAll('"','\\"')}"`}},nn=(e=>(e[e.Plain=0]="Plain",e[e.Italic=1]="Italic",e))(nn||{}),on=(e=>(e[e.Regular=0]="Regular",e[e.Bold=1]="Bold",e))(on||{}),ln=class e{constructor(e,t,s=0,i=0){this._cssScale=0,this._families=rn.parseFamilies(e),this._size=t,this._style=s,this._weight=i,this._css=this.toCssString()}_reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(e){this.families=rn.parseFamilies(e)}get families(){return this._families}set families(e){this._families=e,this._reset()}get size(){return this._size}set size(e){this._size=e,this._reset()}get style(){return this._style}set style(e){this._style=e,this._reset()}get weight(){return this._weight}set weight(e){this._weight=e,this._reset()}get isBold(){return 1===this.weight}get isItalic(){return 1===this.style}withSize(t){return e.withFamilyList(this._families,t,this._style,this._weight)}static withFamilyList(t,s,i=0,a=0){let r=new e("",s,i,a);return r.families=t,r}toCssString(e=1){if(!(this._css&&Math.abs(e-this._cssScale)<.01)){let t="";this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+=this.size*e,t+="px ",t+=this.families.map(e=>rn.quoteFont(e)).join(", "),this._css=t,this._cssScale=e}return this._css}static fromJson(t){if(t instanceof e)return t;switch(typeof t){case"undefined":default:return;case"object":{let s=t,i=s.get("families"),a=s.get("size"),r=sn.parseEnum(s.get("style"),nn),n=sn.parseEnum(s.get("weight"),on);return e.withFamilyList(i,a,r,n)}case"string":{let s=new rn(t);s.parse();let i=s.families,a=s.size.toLowerCase(),r=0;switch(a){case"xx-small":r=7;break;case"x-small":r=10;break;case"small":case"smaller":r=13;break;case"medium":r=16;break;case"large":case"larger":r=18;break;case"x-large":r=24;break;case"xx-large":r=32;break;default:try{r=a.endsWith("em")?16*Number.parseFloat(a.substr(0,a.length-2)):a.endsWith("pt")?16*Number.parseFloat(a.substr(0,a.length-2))/12:a.endsWith("px")?Number.parseFloat(a.substr(0,a.length-2)):12}catch{r=12}}let n=0;"italic"===s.style&&(n=1);let o=0;switch(s.weight.toLowerCase()){case"normal":case"lighter":break;default:o=1}return e.withFamilyList(i,r,n,o)}}}static toJson(e){if(!e)return;let t=new Map;return t.set("families",e.families),t.set("size",e.size),t.set("style",e.style),t.set("weight",e.weight),t}},hn=class{static clone(e){let t=new un;return t.musicFontSize=e.musicFontSize,t.oneStaffSpace=e.oneStaffSpace,t.tabLineSpacing=e.tabLineSpacing,t.arrowShaftThickness=e.arrowShaftThickness,t.barlineSeparation=e.barlineSeparation,t.beamSpacing=e.beamSpacing,t.beamThickness=e.beamThickness,t.bracketThickness=e.bracketThickness,t.dashedBarlineDashLength=e.dashedBarlineDashLength,t.dashedBarlineGapLength=e.dashedBarlineGapLength,t.dashedBarlineThickness=e.dashedBarlineThickness,t.hairpinThickness=e.hairpinThickness,t.legerLineThickness=e.legerLineThickness,t.legerLineExtension=e.legerLineExtension,t.octaveLineThickness=e.octaveLineThickness,t.pedalLineThickness=e.pedalLineThickness,t.repeatBarlineDotSeparation=e.repeatBarlineDotSeparation,t.repeatEndingLineThickness=e.repeatEndingLineThickness,t.slurMidpointThickness=e.slurMidpointThickness,t.staffLineThickness=e.staffLineThickness,t.stemThickness=e.stemThickness,t.thickBarlineThickness=e.thickBarlineThickness,t.thinBarlineThickness=e.thinBarlineThickness,t.thinThickBarlineSeparation=e.thinThickBarlineSeparation,t.tieMidpointThickness=e.tieMidpointThickness,t.tupletBracketThickness=e.tupletBracketThickness,t.stemUp=new Map(e.stemUp),t.stemDown=new Map(e.stemDown),t.repeatOffsetX=new Map(e.repeatOffsetX),t.standardStemLength=e.standardStemLength,t.stemFlagOffsets=new Map(e.stemFlagOffsets),t.glyphTop=new Map(e.glyphTop),t.glyphBottom=new Map(e.glyphBottom),t.glyphWidths=new Map(e.glyphWidths),t.glyphHeights=new Map(e.glyphHeights),t.numberedBarRendererBarSize=e.numberedBarRendererBarSize,t.numberedBarRendererBarSpacing=e.numberedBarRendererBarSpacing,t.numberedDashGlyphPadding=e.numberedDashGlyphPadding,t.numberedDashGlyphWidth=e.numberedDashGlyphWidth,t.lineRangedGlyphDashGap=e.lineRangedGlyphDashGap,t.lineRangedGlyphDashSize=e.lineRangedGlyphDashSize,t.preNoteEffectPadding=e.preNoteEffectPadding,t.postNoteEffectPadding=e.postNoteEffectPadding,t.onNoteEffectPadding=e.onNoteEffectPadding,t.stringNumberCirclePadding=e.stringNumberCirclePadding,t.rowContainerPadding=e.rowContainerPadding,t.rowContainerGap=e.rowContainerGap,t.alternateEndingsPadding=e.alternateEndingsPadding,t.sustainPedalLinePadding=e.sustainPedalLinePadding,t.tieHeight=e.tieHeight,t.beatTimerPadding=e.beatTimerPadding,t.bendNoteHeadElementPadding=e.bendNoteHeadElementPadding,t.ghostParenthesisWidth=e.ghostParenthesisWidth,t.ghostParenthesisPadding=e.ghostParenthesisPadding,t.brokenBeamWidth=e.brokenBeamWidth,t.tabWhammyTextPadding=e.tabWhammyTextPadding,t.tabWhammyPerHalfHeight=e.tabWhammyPerHalfHeight,t.tabWhammyDashSize=e.tabWhammyDashSize,t.songBookWhammyDipHeight=e.songBookWhammyDipHeight,t.deadSlappedLineWidth=e.deadSlappedLineWidth,t.leftHandTabTieWidth=e.leftHandTabTieWidth,t.tabBendDashSize=e.tabBendDashSize,t.tabBendPerValueHeight=e.tabBendPerValueHeight,t.tabBendLabelPadding=e.tabBendLabelPadding,t.simpleSlideWidth=e.simpleSlideWidth,t.simpleSlideHeight=e.simpleSlideHeight,t.chordDiagramPaddingX=e.chordDiagramPaddingX,t.chordDiagramPaddingY=e.chordDiagramPaddingY,t.chordDiagramStringSpacing=e.chordDiagramStringSpacing,t.chordDiagramFretSpacing=e.chordDiagramFretSpacing,t.chordDiagramNutHeight=e.chordDiagramNutHeight,t.chordDiagramFretHeight=e.chordDiagramFretHeight,t.chordDiagramLineWidth=e.chordDiagramLineWidth,t.tripletFeelBracketPadding=e.tripletFeelBracketPadding,t.accidentalPadding=e.accidentalPadding,t.preBeatGlyphSpacing=e.preBeatGlyphSpacing,t.tempoNoteScale=e.tempoNoteScale,t.tuningGlyphCircleNumberScale=e.tuningGlyphCircleNumberScale,t.tuningGlyphStringColumnScale=e.tuningGlyphStringColumnScale,t.tuningGlyphStringRowPadding=e.tuningGlyphStringRowPadding,t.directionsScale=e.directionsScale,t}},dn=class{constructor(){this.topY=0,this.bottomY=0,this.x=0}},cn=class e{constructor(){this.musicFontSize=0,this.oneStaffSpace=0,this.tabLineSpacing=0,this.arrowShaftThickness=0,this.barlineSeparation=0,this.beamSpacing=0,this.beamThickness=0,this.bracketThickness=0,this.dashedBarlineDashLength=0,this.dashedBarlineGapLength=0,this.dashedBarlineThickness=0,this.hairpinThickness=0,this.legerLineThickness=0,this.legerLineExtension=0,this.octaveLineThickness=0,this.pedalLineThickness=0,this.repeatBarlineDotSeparation=0,this.repeatEndingLineThickness=0,this.slurMidpointThickness=0,this.staffLineThickness=0,this.stemThickness=0,this.thickBarlineThickness=0,this.thinBarlineThickness=0,this.thinThickBarlineSeparation=0,this.tieMidpointThickness=0,this.tupletBracketThickness=0,this.stemUp=new Map,this.stemDown=new Map,this.repeatOffsetX=new Map,this.standardStemLength=0,this.stemFlagOffsets=new Map,this.glyphTop=new Map,this.glyphBottom=new Map,this.glyphWidths=new Map,this.glyphHeights=new Map,this.numberedBarRendererBarSize=0,this.numberedBarRendererBarSpacing=0,this.numberedDashGlyphPadding=0,this.numberedDashGlyphWidth=0,this.lineRangedGlyphDashGap=0,this.lineRangedGlyphDashSize=0,this.preNoteEffectPadding=0,this.postNoteEffectPadding=0,this.onNoteEffectPadding=0,this.stringNumberCirclePadding=0,this.rowContainerPadding=0,this.rowContainerGap=0,this.alternateEndingsPadding=0,this.sustainPedalLinePadding=0,this.tieHeight=0,this.beatTimerPadding=0,this.bendNoteHeadElementPadding=0,this.ghostParenthesisWidth=0,this.ghostParenthesisPadding=0,this.brokenBeamWidth=0,this.tabWhammyTextPadding=0,this.tabWhammyPerHalfHeight=0,this.tabWhammyDashSize=0,this.songBookWhammyDipHeight=0,this.deadSlappedLineWidth=0,this.leftHandTabTieWidth=0,this.tabBendDashSize=0,this.tabBendPerValueHeight=0,this.tabBendLabelPadding=0,this.simpleSlideWidth=0,this.simpleSlideHeight=0,this.chordDiagramPaddingX=0,this.chordDiagramPaddingY=0,this.chordDiagramStringSpacing=0,this.chordDiagramFretSpacing=0,this.chordDiagramNutHeight=0,this.chordDiagramFretHeight=0,this.chordDiagramLineWidth=0,this.tripletFeelBracketPadding=0,this.accidentalPadding=0,this.preBeatGlyphSpacing=0,this.tempoNoteScale=.7,this.tuningGlyphCircleNumberScale=.7,this.tuningGlyphStringColumnScale=1.5,this.tuningGlyphStringRowPadding=0,this.directionsScale=.6}static get bravuraDefaults(){let t=e._bravuraDefaults;return t||(t=new e,t.fillFromSmufl(e.bravuraMetadata),e._bravuraDefaults=t),hn.clone(t)}hasSymbol(e){return this.glyphWidths.get(e)>0&&this.glyphHeights.get(e)>0}fillFromSmufl(t,s=36){this.musicFontSize=s,this.oneStaffSpace=s/4,this.tabLineSpacing=Math.floor(1.5*this.oneStaffSpace),this.arrowShaftThickness=t.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=t.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=t.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=t.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=t.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=t.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=t.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=t.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=t.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=t.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=t.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=t.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=t.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=t.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=t.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=t.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=t.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=t.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=t.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,"number"==typeof t.engravingDefaults.thinThickBarlineSeparation?this.thinThickBarlineSeparation=t.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=t.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=t.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;let i=3*this.oneStaffSpace;this.standardStemLength=i,this.stemFlagOffsets.set(-4,0),this.stemFlagOffsets.set(-2,0),this.stemFlagOffsets.set(1,0),this.stemFlagOffsets.set(2,0),this.stemFlagOffsets.set(4,0),this.stemFlagOffsets.set(8,0),this.stemFlagOffsets.set(16,0),this.stemFlagOffsets.set(32,0),this.stemFlagOffsets.set(64,0),this.stemFlagOffsets.set(128,0),this.stemFlagOffsets.set(256,0);for(let[s,i]of Object.entries(t.glyphsWithAnchors)){let t=e._smuflNameToMusicFontSymbol(s);if(t){if(i.stemDownNW){let e=new dn;e.x=i.stemDownNW[0]*this.oneStaffSpace,e.topY=i.stemDownNW[1]*this.oneStaffSpace,i.stemDownSW?e.bottomY=i.stemDownSW[1]*this.oneStaffSpace:e.bottomY=0,this.stemDown.set(t,e)}if(i.stemUpSE){let e=new dn,s=i.stemUpSE[0]*this.oneStaffSpace;e.bottomY=i.stemUpSE[1]*this.oneStaffSpace,i.stemUpNW?(e.x=i.stemUpNW[0]*this.oneStaffSpace,e.topY=i.stemUpNW[1]*this.oneStaffSpace):(e.x=s-this.stemThickness,e.topY=0),this.stemUp.set(t,e)}if(i.repeatOffset&&this.repeatOffsetX.set(t,i.repeatOffset[0]*this.oneStaffSpace),i.stemUpNW){let e=i.stemUpNW[1]*this.oneStaffSpace;switch(t){case 57920:this.stemFlagOffsets.set(8,e);break;case 57922:this.stemFlagOffsets.set(16,e);break;case 57924:this.stemFlagOffsets.set(32,e);break;case 57926:this.stemFlagOffsets.set(64,e);break;case 57928:this.stemFlagOffsets.set(128,e);break;case 57930:this.stemFlagOffsets.set(256,e)}}}}let a=new Set,r=t.glyphBBoxes;if(r)for(let[t,s]of Object.entries(r)){let i=e._smuflNameToMusicFontSymbol(t);i&&(a.add(i),this.glyphTop.set(i,s.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(i,s.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(i,(s.bBoxNE[0]-s.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(i,(s.bBoxNE[1]-s.bBoxSW[1])*this.oneStaffSpace))}let n=new Set([-1,32,57509]);for(let e of qe.getAllMusicFontSymbols())a.has(e)||(n.has(e)||re.warning("SmuFL",`The provided SmuFL font is missing the glyph ${Ue[e]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(e,0),this.glyphBottom.set(e,0),this.glyphWidths.set(e,0),this.glyphHeights.set(e,0));this.numberedBarRendererBarSize=1*this.staffLineThickness,this.numberedBarRendererBarSpacing=this.beamSpacing+this.numberedBarRendererBarSize,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=1*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(1*this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=1*this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static _smuflNameToMusicFontSymbol(t){let s=e.smuflNameToGlyphNameMapping.has(t)?e.smuflNameToGlyphNameMapping.get(t):t.substring(0,1).toUpperCase()+t.substring(1);return sn.parseEnumExact(s,Ue)}};cn.smuflNameToGlyphNameMapping=new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]]),cn.bravuraMetadata={engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}};var un=cn,pn=class e{constructor(){this.engravingSettings=un.bravuraDefaults,this.copyrightFont=new ln(e._sansFont,12,0,1),this.titleFont=new ln(e._serifFont,32,0),this.subTitleFont=new ln(e._serifFont,20,0),this.wordsFont=new ln(e._serifFont,15,0),this.effectFont=new ln(e._serifFont,12,1),this.timerFont=new ln(e._serifFont,12,0),this.directionsFont=new ln(e._serifFont,14,0),this.fretboardNumberFont=new ln(e._sansFont,11,0),this.numberedNotationFont=new ln(e._sansFont,16,0),this.numberedNotationGraceFont=new ln(e._sansFont,14,0),this.tablatureFont=new ln(e._sansFont,14,0),this.graceFont=new ln(e._sansFont,12,0),this.staffLineColor=new Jt(165,165,165,255),this.barSeparatorColor=new Jt(34,34,17,255),this.barNumberFont=new ln(e._sansFont,11,0),this.barNumberColor=new Jt(200,0,0,255),this.fingeringFont=new ln(e._serifFont,14,0),this.inlineFingeringFont=new ln(e._serifFont,12,0),this.markerFont=new ln(e._serifFont,14,0,1),this.mainGlyphColor=new Jt(0,0,0,255),this.secondaryGlyphColor=new Jt(0,0,0,100),this.scoreInfoColor=new Jt(0,0,0,255)}getFontForElement(e){switch(e){case 0:return this.titleFont;case 1:case 2:case 3:return this.subTitleFont;case 4:case 5:case 6:case 7:return this.wordsFont;case 8:case 9:return this.copyrightFont}return this.wordsFont}};pn._sansFont="Arial, sans-serif",pn._serifFont="Georgia, serif";var mn=pn,gn=(e=>(e[e.Default=0]="Default",e[e.ScoreTab=1]="ScoreTab",e[e.Score=2]="Score",e[e.Tab=3]="Tab",e[e.TabMixed=4]="TabMixed",e))(gn||{}),fn=(e=>(e[e.Automatic=0]="Automatic",e[e.UseModelLayout=1]="UseModelLayout",e))(fn||{}),bn=class{constructor(){this.scale=1,this.stretchForce=1,this.layoutMode=0,this.staveProfile=0,this.barsPerRow=-1,this.startBar=1,this.barCount=-1,this.barCountPerPartial=10,this.justifyLastSystem=!1,this.resources=new mn,this.padding=[35,35],this.firstSystemPaddingTop=5,this.systemPaddingTop=10,this.systemPaddingBottom=10,this.lastSystemPaddingBottom=0,this.systemLabelPaddingLeft=0,this.systemLabelPaddingRight=3,this.accoladeBarPaddingRight=3,this.notationStaffPaddingTop=5,this.notationStaffPaddingBottom=5,this.effectStaffPaddingTop=0,this.effectStaffPaddingBottom=0,this.firstStaffPaddingLeft=6,this.staffPaddingLeft=2,this.effectBandPaddingBottom=2,this.systemsLayoutMode=0}},yn=class{constructor(){this.encoding="utf-8",this.mergePartGroupsInMusicXml=!1,this.beatTextAsLyrics=!1}},_n=(e=>(e[e.Off=0]="Off",e[e.Continuous=1]="Continuous",e[e.OffScreen=2]="OffScreen",e))(_n||{}),Sn=class{constructor(){this.noteWideLength=240,this.noteWideAmplitude=1,this.noteSlightLength=360,this.noteSlightAmplitude=.5,this.beatWideLength=480,this.beatWideAmplitude=2,this.beatSlightLength=480,this.beatSlightAmplitude=2}},kn=class{constructor(){this.simpleSlidePitchOffset=6,this.simpleSlideDurationRatio=.25,this.shiftSlideDurationRatio=.5}},wn=(e=>(e[e.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",e[e.WebAudioScriptProcessor=1]="WebAudioScriptProcessor",e))(wn||{}),Tn=(e=>(e[e.Disabled=0]="Disabled",e[e.EnabledAutomatic=1]="EnabledAutomatic",e[e.EnabledSynthesizer=2]="EnabledSynthesizer",e[e.EnabledBackingTrack=3]="EnabledBackingTrack",e[e.EnabledExternalMedia=4]="EnabledExternalMedia",e))(Tn||{}),Bn=class{constructor(){this.soundFont=null,this.scrollElement="html,body",this.outputMode=0,this.enablePlayer=!1,this.playerMode=0,this.enableCursor=!0,this.enableAnimatedBeatCursor=!0,this.enableElementHighlighting=!0,this.enableUserInteraction=!0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollMode=1,this.scrollSpeed=300,this.nativeBrowserSmoothScroll=!0,this.songBookBendDuration=75,this.songBookDipDuration=150,this.vibrato=new Sn,this.slide=new kn,this.playTripletFeel=!0,this.bufferTimeInMilliseconds=500}},xn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("scriptfile",e.scriptFile),t.set("fontdirectory",e.fontDirectory),null!==e.smuflFontSources){let s=new Map;t.set("smuflfontsources",s);for(let[t,i]of e.smuflFontSources)s.set(t.toString(),i)}return t.set("file",e.file),t.set("tex",e.tex),t.set("tracks",e.tracks),t.set("enablelazyloading",e.enableLazyLoading),t.set("engine",e.engine),t.set("loglevel",e.logLevel),t.set("useworkers",e.useWorkers),t.set("includenotebounds",e.includeNoteBounds),t}static setProperty(e,t,s){switch(t){case"scriptfile":return e.scriptFile=s,!0;case"fontdirectory":return e.fontDirectory=s,!0;case"smuflfontsources":return e.smuflFontSources=new Map,sn.forEach(s,(t,s)=>{e.smuflFontSources.set(sn.parseEnum(s,yu),t)}),!0;case"file":return e.file=s,!0;case"tex":return e.tex=s,!0;case"tracks":return e.tracks=s,!0;case"enablelazyloading":return e.enableLazyLoading=s,!0;case"engine":return e.engine=s,!0;case"loglevel":return e.logLevel=sn.parseEnum(s,Q),!0;case"useworkers":return e.useWorkers=s,!0;case"includenotebounds":return e.includeNoteBounds=s,!0}return!1}},vn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("topy",e.topY),t.set("bottomy",e.bottomY),t.set("x",e.x),t}static setProperty(e,t,s){switch(t){case"topy":return e.topY=s,!0;case"bottomy":return e.bottomY=s,!0;case"x":return e.x=s,!0}return!1}},Pn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;t.set("musicfontsize",e.musicFontSize),t.set("onestaffspace",e.oneStaffSpace),t.set("tablinespacing",e.tabLineSpacing),t.set("arrowshaftthickness",e.arrowShaftThickness),t.set("barlineseparation",e.barlineSeparation),t.set("beamspacing",e.beamSpacing),t.set("beamthickness",e.beamThickness),t.set("bracketthickness",e.bracketThickness),t.set("dashedbarlinedashlength",e.dashedBarlineDashLength),t.set("dashedbarlinegaplength",e.dashedBarlineGapLength),t.set("dashedbarlinethickness",e.dashedBarlineThickness),t.set("hairpinthickness",e.hairpinThickness),t.set("legerlinethickness",e.legerLineThickness),t.set("legerlineextension",e.legerLineExtension),t.set("octavelinethickness",e.octaveLineThickness),t.set("pedallinethickness",e.pedalLineThickness),t.set("repeatbarlinedotseparation",e.repeatBarlineDotSeparation),t.set("repeatendinglinethickness",e.repeatEndingLineThickness),t.set("slurmidpointthickness",e.slurMidpointThickness),t.set("stafflinethickness",e.staffLineThickness),t.set("stemthickness",e.stemThickness),t.set("thickbarlinethickness",e.thickBarlineThickness),t.set("thinbarlinethickness",e.thinBarlineThickness),t.set("thinthickbarlineseparation",e.thinThickBarlineSeparation),t.set("tiemidpointthickness",e.tieMidpointThickness),t.set("tupletbracketthickness",e.tupletBracketThickness);{let s=new Map;t.set("stemup",s);for(let[t,i]of e.stemUp)s.set(t.toString(),vn.toJson(i))}{let s=new Map;t.set("stemdown",s);for(let[t,i]of e.stemDown)s.set(t.toString(),vn.toJson(i))}{let s=new Map;t.set("repeatoffsetx",s);for(let[t,i]of e.repeatOffsetX)s.set(t.toString(),i)}t.set("standardstemlength",e.standardStemLength);{let s=new Map;t.set("stemflagoffsets",s);for(let[t,i]of e.stemFlagOffsets)s.set(t.toString(),i)}{let s=new Map;t.set("glyphtop",s);for(let[t,i]of e.glyphTop)s.set(t.toString(),i)}{let s=new Map;t.set("glyphbottom",s);for(let[t,i]of e.glyphBottom)s.set(t.toString(),i)}{let s=new Map;t.set("glyphwidths",s);for(let[t,i]of e.glyphWidths)s.set(t.toString(),i)}{let s=new Map;t.set("glyphheights",s);for(let[t,i]of e.glyphHeights)s.set(t.toString(),i)}return t.set("numberedbarrendererbarsize",e.numberedBarRendererBarSize),t.set("numberedbarrendererbarspacing",e.numberedBarRendererBarSpacing),t.set("numbereddashglyphpadding",e.numberedDashGlyphPadding),t.set("numbereddashglyphwidth",e.numberedDashGlyphWidth),t.set("linerangedglyphdashgap",e.lineRangedGlyphDashGap),t.set("linerangedglyphdashsize",e.lineRangedGlyphDashSize),t.set("prenoteeffectpadding",e.preNoteEffectPadding),t.set("postnoteeffectpadding",e.postNoteEffectPadding),t.set("onnoteeffectpadding",e.onNoteEffectPadding),t.set("stringnumbercirclepadding",e.stringNumberCirclePadding),t.set("rowcontainerpadding",e.rowContainerPadding),t.set("rowcontainergap",e.rowContainerGap),t.set("alternateendingspadding",e.alternateEndingsPadding),t.set("sustainpedallinepadding",e.sustainPedalLinePadding),t.set("tieheight",e.tieHeight),t.set("beattimerpadding",e.beatTimerPadding),t.set("bendnoteheadelementpadding",e.bendNoteHeadElementPadding),t.set("ghostparenthesiswidth",e.ghostParenthesisWidth),t.set("ghostparenthesispadding",e.ghostParenthesisPadding),t.set("brokenbeamwidth",e.brokenBeamWidth),t.set("tabwhammytextpadding",e.tabWhammyTextPadding),t.set("tabwhammyperhalfheight",e.tabWhammyPerHalfHeight),t.set("tabwhammydashsize",e.tabWhammyDashSize),t.set("songbookwhammydipheight",e.songBookWhammyDipHeight),t.set("deadslappedlinewidth",e.deadSlappedLineWidth),t.set("lefthandtabtiewidth",e.leftHandTabTieWidth),t.set("tabbenddashsize",e.tabBendDashSize),t.set("tabbendpervalueheight",e.tabBendPerValueHeight),t.set("tabbendlabelpadding",e.tabBendLabelPadding),t.set("simpleslidewidth",e.simpleSlideWidth),t.set("simpleslideheight",e.simpleSlideHeight),t.set("chorddiagrampaddingx",e.chordDiagramPaddingX),t.set("chorddiagrampaddingy",e.chordDiagramPaddingY),t.set("chorddiagramstringspacing",e.chordDiagramStringSpacing),t.set("chorddiagramfretspacing",e.chordDiagramFretSpacing),t.set("chorddiagramnutheight",e.chordDiagramNutHeight),t.set("chorddiagramfretheight",e.chordDiagramFretHeight),t.set("chorddiagramlinewidth",e.chordDiagramLineWidth),t.set("tripletfeelbracketpadding",e.tripletFeelBracketPadding),t.set("accidentalpadding",e.accidentalPadding),t.set("prebeatglyphspacing",e.preBeatGlyphSpacing),t.set("temponotescale",e.tempoNoteScale),t.set("tuningglyphcirclenumberscale",e.tuningGlyphCircleNumberScale),t.set("tuningglyphstringcolumnscale",e.tuningGlyphStringColumnScale),t.set("tuningglyphstringrowpadding",e.tuningGlyphStringRowPadding),t.set("directionsscale",e.directionsScale),t}static setProperty(e,t,s){switch(t){case"musicfontsize":return e.musicFontSize=s,!0;case"onestaffspace":return e.oneStaffSpace=s,!0;case"tablinespacing":return e.tabLineSpacing=s,!0;case"arrowshaftthickness":return e.arrowShaftThickness=s,!0;case"barlineseparation":return e.barlineSeparation=s,!0;case"beamspacing":return e.beamSpacing=s,!0;case"beamthickness":return e.beamThickness=s,!0;case"bracketthickness":return e.bracketThickness=s,!0;case"dashedbarlinedashlength":return e.dashedBarlineDashLength=s,!0;case"dashedbarlinegaplength":return e.dashedBarlineGapLength=s,!0;case"dashedbarlinethickness":return e.dashedBarlineThickness=s,!0;case"hairpinthickness":return e.hairpinThickness=s,!0;case"legerlinethickness":return e.legerLineThickness=s,!0;case"legerlineextension":return e.legerLineExtension=s,!0;case"octavelinethickness":return e.octaveLineThickness=s,!0;case"pedallinethickness":return e.pedalLineThickness=s,!0;case"repeatbarlinedotseparation":return e.repeatBarlineDotSeparation=s,!0;case"repeatendinglinethickness":return e.repeatEndingLineThickness=s,!0;case"slurmidpointthickness":return e.slurMidpointThickness=s,!0;case"stafflinethickness":return e.staffLineThickness=s,!0;case"stemthickness":return e.stemThickness=s,!0;case"thickbarlinethickness":return e.thickBarlineThickness=s,!0;case"thinbarlinethickness":return e.thinBarlineThickness=s,!0;case"thinthickbarlineseparation":return e.thinThickBarlineSeparation=s,!0;case"tiemidpointthickness":return e.tieMidpointThickness=s,!0;case"tupletbracketthickness":return e.tupletBracketThickness=s,!0;case"stemup":return e.stemUp=new Map,sn.forEach(s,(t,s)=>{let i=new dn;vn.fromJson(i,t),e.stemUp.set(sn.parseEnum(s,Ue),i)}),!0;case"stemdown":return e.stemDown=new Map,sn.forEach(s,(t,s)=>{let i=new dn;vn.fromJson(i,t),e.stemDown.set(sn.parseEnum(s,Ue),i)}),!0;case"repeatoffsetx":return e.repeatOffsetX=new Map,sn.forEach(s,(t,s)=>{e.repeatOffsetX.set(sn.parseEnum(s,Ue),t)}),!0;case"standardstemlength":return e.standardStemLength=s,!0;case"stemflagoffsets":return e.stemFlagOffsets=new Map,sn.forEach(s,(t,s)=>{e.stemFlagOffsets.set(sn.parseEnum(s,I),t)}),!0;case"glyphtop":return e.glyphTop=new Map,sn.forEach(s,(t,s)=>{e.glyphTop.set(sn.parseEnum(s,Ue),t)}),!0;case"glyphbottom":return e.glyphBottom=new Map,sn.forEach(s,(t,s)=>{e.glyphBottom.set(sn.parseEnum(s,Ue),t)}),!0;case"glyphwidths":return e.glyphWidths=new Map,sn.forEach(s,(t,s)=>{e.glyphWidths.set(sn.parseEnum(s,Ue),t)}),!0;case"glyphheights":return e.glyphHeights=new Map,sn.forEach(s,(t,s)=>{e.glyphHeights.set(sn.parseEnum(s,Ue),t)}),!0;case"numberedbarrendererbarsize":return e.numberedBarRendererBarSize=s,!0;case"numberedbarrendererbarspacing":return e.numberedBarRendererBarSpacing=s,!0;case"numbereddashglyphpadding":return e.numberedDashGlyphPadding=s,!0;case"numbereddashglyphwidth":return e.numberedDashGlyphWidth=s,!0;case"linerangedglyphdashgap":return e.lineRangedGlyphDashGap=s,!0;case"linerangedglyphdashsize":return e.lineRangedGlyphDashSize=s,!0;case"prenoteeffectpadding":return e.preNoteEffectPadding=s,!0;case"postnoteeffectpadding":return e.postNoteEffectPadding=s,!0;case"onnoteeffectpadding":return e.onNoteEffectPadding=s,!0;case"stringnumbercirclepadding":return e.stringNumberCirclePadding=s,!0;case"rowcontainerpadding":return e.rowContainerPadding=s,!0;case"rowcontainergap":return e.rowContainerGap=s,!0;case"alternateendingspadding":return e.alternateEndingsPadding=s,!0;case"sustainpedallinepadding":return e.sustainPedalLinePadding=s,!0;case"tieheight":return e.tieHeight=s,!0;case"beattimerpadding":return e.beatTimerPadding=s,!0;case"bendnoteheadelementpadding":return e.bendNoteHeadElementPadding=s,!0;case"ghostparenthesiswidth":return e.ghostParenthesisWidth=s,!0;case"ghostparenthesispadding":return e.ghostParenthesisPadding=s,!0;case"brokenbeamwidth":return e.brokenBeamWidth=s,!0;case"tabwhammytextpadding":return e.tabWhammyTextPadding=s,!0;case"tabwhammyperhalfheight":return e.tabWhammyPerHalfHeight=s,!0;case"tabwhammydashsize":return e.tabWhammyDashSize=s,!0;case"songbookwhammydipheight":return e.songBookWhammyDipHeight=s,!0;case"deadslappedlinewidth":return e.deadSlappedLineWidth=s,!0;case"lefthandtabtiewidth":return e.leftHandTabTieWidth=s,!0;case"tabbenddashsize":return e.tabBendDashSize=s,!0;case"tabbendpervalueheight":return e.tabBendPerValueHeight=s,!0;case"tabbendlabelpadding":return e.tabBendLabelPadding=s,!0;case"simpleslidewidth":return e.simpleSlideWidth=s,!0;case"simpleslideheight":return e.simpleSlideHeight=s,!0;case"chorddiagrampaddingx":return e.chordDiagramPaddingX=s,!0;case"chorddiagrampaddingy":return e.chordDiagramPaddingY=s,!0;case"chorddiagramstringspacing":return e.chordDiagramStringSpacing=s,!0;case"chorddiagramfretspacing":return e.chordDiagramFretSpacing=s,!0;case"chorddiagramnutheight":return e.chordDiagramNutHeight=s,!0;case"chorddiagramfretheight":return e.chordDiagramFretHeight=s,!0;case"chorddiagramlinewidth":return e.chordDiagramLineWidth=s,!0;case"tripletfeelbracketpadding":return e.tripletFeelBracketPadding=s,!0;case"accidentalpadding":return e.accidentalPadding=s,!0;case"prebeatglyphspacing":return e.preBeatGlyphSpacing=s,!0;case"temponotescale":return e.tempoNoteScale=s,!0;case"tuningglyphcirclenumberscale":return e.tuningGlyphCircleNumberScale=s,!0;case"tuningglyphstringcolumnscale":return e.tuningGlyphStringColumnScale=s,!0;case"tuningglyphstringrowpadding":return e.tuningGlyphStringRowPadding=s,!0;case"directionsscale":return e.directionsScale=s,!0}return!1}},Nn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("smuflfontfamilyname",e.smuflFontFamilyName),t.set("engravingsettings",Pn.toJson(e.engravingSettings)),t.set("copyrightfont",ln.toJson(e.copyrightFont)),t.set("titlefont",ln.toJson(e.titleFont)),t.set("subtitlefont",ln.toJson(e.subTitleFont)),t.set("wordsfont",ln.toJson(e.wordsFont)),t.set("effectfont",ln.toJson(e.effectFont)),t.set("timerfont",ln.toJson(e.timerFont)),t.set("directionsfont",ln.toJson(e.directionsFont)),t.set("fretboardnumberfont",ln.toJson(e.fretboardNumberFont)),t.set("numberednotationfont",ln.toJson(e.numberedNotationFont)),t.set("numberednotationgracefont",ln.toJson(e.numberedNotationGraceFont)),t.set("tablaturefont",ln.toJson(e.tablatureFont)),t.set("gracefont",ln.toJson(e.graceFont)),t.set("stafflinecolor",Jt.toJson(e.staffLineColor)),t.set("barseparatorcolor",Jt.toJson(e.barSeparatorColor)),t.set("barnumberfont",ln.toJson(e.barNumberFont)),t.set("barnumbercolor",Jt.toJson(e.barNumberColor)),t.set("fingeringfont",ln.toJson(e.fingeringFont)),t.set("inlinefingeringfont",ln.toJson(e.inlineFingeringFont)),t.set("markerfont",ln.toJson(e.markerFont)),t.set("mainglyphcolor",Jt.toJson(e.mainGlyphColor)),t.set("secondaryglyphcolor",Jt.toJson(e.secondaryGlyphColor)),t.set("scoreinfocolor",Jt.toJson(e.scoreInfoColor)),t}static setProperty(e,t,s){switch(t){case"smuflfontfamilyname":return e.smuflFontFamilyName=s,!0;case"copyrightfont":return e.copyrightFont=ln.fromJson(s),!0;case"titlefont":return e.titleFont=ln.fromJson(s),!0;case"subtitlefont":return e.subTitleFont=ln.fromJson(s),!0;case"wordsfont":return e.wordsFont=ln.fromJson(s),!0;case"effectfont":return e.effectFont=ln.fromJson(s),!0;case"timerfont":return e.timerFont=ln.fromJson(s),!0;case"directionsfont":return e.directionsFont=ln.fromJson(s),!0;case"fretboardnumberfont":return e.fretboardNumberFont=ln.fromJson(s),!0;case"numberednotationfont":return e.numberedNotationFont=ln.fromJson(s),!0;case"numberednotationgracefont":return e.numberedNotationGraceFont=ln.fromJson(s),!0;case"tablaturefont":return e.tablatureFont=ln.fromJson(s),!0;case"gracefont":return e.graceFont=ln.fromJson(s),!0;case"stafflinecolor":return e.staffLineColor=Jt.fromJson(s),!0;case"barseparatorcolor":return e.barSeparatorColor=Jt.fromJson(s),!0;case"barnumberfont":return e.barNumberFont=ln.fromJson(s),!0;case"barnumbercolor":return e.barNumberColor=Jt.fromJson(s),!0;case"fingeringfont":return e.fingeringFont=ln.fromJson(s),!0;case"inlinefingeringfont":return e.inlineFingeringFont=ln.fromJson(s),!0;case"markerfont":return e.markerFont=ln.fromJson(s),!0;case"mainglyphcolor":return e.mainGlyphColor=Jt.fromJson(s),!0;case"secondaryglyphcolor":return e.secondaryGlyphColor=Jt.fromJson(s),!0;case"scoreinfocolor":return e.scoreInfoColor=Jt.fromJson(s),!0}return["engravingsettings"].indexOf(t)>=0&&(Pn.fromJson(e.engravingSettings,s),!0)}},Mn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("scale",e.scale),t.set("stretchforce",e.stretchForce),t.set("layoutmode",e.layoutMode),t.set("staveprofile",e.staveProfile),t.set("barsperrow",e.barsPerRow),t.set("startbar",e.startBar),t.set("barcount",e.barCount),t.set("barcountperpartial",e.barCountPerPartial),t.set("justifylastsystem",e.justifyLastSystem),t.set("resources",Nn.toJson(e.resources)),t.set("padding",e.padding),t.set("firstsystempaddingtop",e.firstSystemPaddingTop),t.set("systempaddingtop",e.systemPaddingTop),t.set("systempaddingbottom",e.systemPaddingBottom),t.set("lastsystempaddingbottom",e.lastSystemPaddingBottom),t.set("systemlabelpaddingleft",e.systemLabelPaddingLeft),t.set("systemlabelpaddingright",e.systemLabelPaddingRight),t.set("accoladebarpaddingright",e.accoladeBarPaddingRight),t.set("notationstaffpaddingtop",e.notationStaffPaddingTop),t.set("notationstaffpaddingbottom",e.notationStaffPaddingBottom),t.set("effectstaffpaddingtop",e.effectStaffPaddingTop),t.set("effectstaffpaddingbottom",e.effectStaffPaddingBottom),t.set("firststaffpaddingleft",e.firstStaffPaddingLeft),t.set("staffpaddingleft",e.staffPaddingLeft),t.set("effectbandpaddingbottom",e.effectBandPaddingBottom),t.set("systemslayoutmode",e.systemsLayoutMode),t}static setProperty(e,t,s){switch(t){case"scale":return e.scale=s,!0;case"stretchforce":return e.stretchForce=s,!0;case"layoutmode":return e.layoutMode=sn.parseEnum(s,hs),!0;case"staveprofile":return e.staveProfile=sn.parseEnum(s,gn),!0;case"barsperrow":return e.barsPerRow=s,!0;case"startbar":return e.startBar=s,!0;case"barcount":return e.barCount=s,!0;case"barcountperpartial":return e.barCountPerPartial=s,!0;case"justifylastsystem":return e.justifyLastSystem=s,!0;case"padding":return e.padding=s,!0;case"firstsystempaddingtop":return e.firstSystemPaddingTop=s,!0;case"systempaddingtop":return e.systemPaddingTop=s,!0;case"systempaddingbottom":return e.systemPaddingBottom=s,!0;case"lastsystempaddingbottom":return e.lastSystemPaddingBottom=s,!0;case"systemlabelpaddingleft":return e.systemLabelPaddingLeft=s,!0;case"systemlabelpaddingright":return e.systemLabelPaddingRight=s,!0;case"accoladebarpaddingright":return e.accoladeBarPaddingRight=s,!0;case"notationstaffpaddingtop":return e.notationStaffPaddingTop=s,!0;case"notationstaffpaddingbottom":return e.notationStaffPaddingBottom=s,!0;case"effectstaffpaddingtop":return e.effectStaffPaddingTop=s,!0;case"effectstaffpaddingbottom":return e.effectStaffPaddingBottom=s,!0;case"firststaffpaddingleft":return e.firstStaffPaddingLeft=s,!0;case"staffpaddingleft":return e.staffPaddingLeft=s,!0;case"effectbandpaddingbottom":return e.effectBandPaddingBottom=s,!0;case"systemslayoutmode":return e.systemsLayoutMode=sn.parseEnum(s,fn),!0}if(["resources"].indexOf(t)>=0)return Nn.fromJson(e.resources,s),!0;for(let i of["resources"])if(0===t.indexOf(i)&&Nn.setProperty(e.resources,t.substring(i.length),s))return!0;return!1}},En=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;t.set("notationmode",e.notationMode),t.set("fingeringmode",e.fingeringMode);{let s=new Map;t.set("elements",s);for(let[t,i]of e.elements)s.set(t.toString(),i)}return t.set("rhythmmode",e.rhythmMode),t.set("rhythmheight",e.rhythmHeight),t.set("transpositionpitches",e.transpositionPitches),t.set("displaytranspositionpitches",e.displayTranspositionPitches),t.set("smallgracetabnotes",e.smallGraceTabNotes),t.set("extendbendarrowsontiednotes",e.extendBendArrowsOnTiedNotes),t.set("extendlineeffectstobeatend",e.extendLineEffectsToBeatEnd),t.set("slurheight",e.slurHeight),t.set("showchorddiagramsonbeats",e.showChordDiagramsOnBeats),t}static setProperty(e,t,s){switch(t){case"notationmode":return e.notationMode=sn.parseEnum(s,$),!0;case"fingeringmode":return e.fingeringMode=sn.parseEnum(s,X),!0;case"elements":return e.elements=new Map,sn.forEach(s,(t,s)=>{e.elements.set(sn.parseEnum(s,J),t)}),!0;case"rhythmmode":return e.rhythmMode=sn.parseEnum(s,Y),!0;case"rhythmheight":return e.rhythmHeight=s,!0;case"transpositionpitches":return e.transpositionPitches=s,!0;case"displaytranspositionpitches":return e.displayTranspositionPitches=s,!0;case"smallgracetabnotes":return e.smallGraceTabNotes=s,!0;case"extendbendarrowsontiednotes":return e.extendBendArrowsOnTiedNotes=s,!0;case"extendlineeffectstobeatend":return e.extendLineEffectsToBeatEnd=s,!0;case"slurheight":return e.slurHeight=s,!0;case"showchorddiagramsonbeats":return e.showChordDiagramsOnBeats=s,!0}return!1}},Ln=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("encoding",e.encoding),t.set("mergepartgroupsinmusicxml",e.mergePartGroupsInMusicXml),t.set("beattextaslyrics",e.beatTextAsLyrics),t}static setProperty(e,t,s){switch(t){case"encoding":return e.encoding=s,!0;case"mergepartgroupsinmusicxml":return e.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return e.beatTextAsLyrics=s,!0}return!1}},Cn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("notewidelength",e.noteWideLength),t.set("notewideamplitude",e.noteWideAmplitude),t.set("noteslightlength",e.noteSlightLength),t.set("noteslightamplitude",e.noteSlightAmplitude),t.set("beatwidelength",e.beatWideLength),t.set("beatwideamplitude",e.beatWideAmplitude),t.set("beatslightlength",e.beatSlightLength),t.set("beatslightamplitude",e.beatSlightAmplitude),t}static setProperty(e,t,s){switch(t){case"notewidelength":return e.noteWideLength=s,!0;case"notewideamplitude":return e.noteWideAmplitude=s,!0;case"noteslightlength":return e.noteSlightLength=s,!0;case"noteslightamplitude":return e.noteSlightAmplitude=s,!0;case"beatwidelength":return e.beatWideLength=s,!0;case"beatwideamplitude":return e.beatWideAmplitude=s,!0;case"beatslightlength":return e.beatSlightLength=s,!0;case"beatslightamplitude":return e.beatSlightAmplitude=s,!0}return!1}},Fn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("simpleslidepitchoffset",e.simpleSlidePitchOffset),t.set("simpleslidedurationratio",e.simpleSlideDurationRatio),t.set("shiftslidedurationratio",e.shiftSlideDurationRatio),t}static setProperty(e,t,s){switch(t){case"simpleslidepitchoffset":return e.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return e.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return e.shiftSlideDurationRatio=s,!0}return!1}},Dn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("soundfont",e.soundFont),t.set("outputmode",e.outputMode),t.set("enableplayer",e.enablePlayer),t.set("playermode",e.playerMode),t.set("enablecursor",e.enableCursor),t.set("enableanimatedbeatcursor",e.enableAnimatedBeatCursor),t.set("enableelementhighlighting",e.enableElementHighlighting),t.set("enableuserinteraction",e.enableUserInteraction),t.set("scrolloffsetx",e.scrollOffsetX),t.set("scrolloffsety",e.scrollOffsetY),t.set("scrollmode",e.scrollMode),t.set("scrollspeed",e.scrollSpeed),t.set("nativebrowsersmoothscroll",e.nativeBrowserSmoothScroll),t.set("songbookbendduration",e.songBookBendDuration),t.set("songbookdipduration",e.songBookDipDuration),t.set("vibrato",Cn.toJson(e.vibrato)),t.set("slide",Fn.toJson(e.slide)),t.set("playtripletfeel",e.playTripletFeel),t.set("buffertimeinmilliseconds",e.bufferTimeInMilliseconds),t}static setProperty(e,t,s){switch(t){case"soundfont":return e.soundFont=s,!0;case"scrollelement":return e.scrollElement=s,!0;case"outputmode":return e.outputMode=sn.parseEnum(s,wn),!0;case"enableplayer":return e.enablePlayer=s,!0;case"playermode":return e.playerMode=sn.parseEnum(s,Tn),!0;case"enablecursor":return e.enableCursor=s,!0;case"enableanimatedbeatcursor":return e.enableAnimatedBeatCursor=s,!0;case"enableelementhighlighting":return e.enableElementHighlighting=s,!0;case"enableuserinteraction":return e.enableUserInteraction=s,!0;case"scrolloffsetx":return e.scrollOffsetX=s,!0;case"scrolloffsety":return e.scrollOffsetY=s,!0;case"scrollmode":return e.scrollMode=sn.parseEnum(s,_n),!0;case"scrollspeed":return e.scrollSpeed=s,!0;case"nativebrowsersmoothscroll":return e.nativeBrowserSmoothScroll=s,!0;case"songbookbendduration":return e.songBookBendDuration=s,!0;case"songbookdipduration":return e.songBookDipDuration=s,!0;case"playtripletfeel":return e.playTripletFeel=s,!0;case"buffertimeinmilliseconds":return e.bufferTimeInMilliseconds=s,!0}if(["vibrato"].indexOf(t)>=0)return Cn.fromJson(e.vibrato,s),!0;for(let i of["vibrato"])if(0===t.indexOf(i)&&Cn.setProperty(e.vibrato,t.substring(i.length),s))return!0;if(["slide"].indexOf(t)>=0)return Fn.fromJson(e.slide,s),!0;for(let i of["slide"])if(0===t.indexOf(i)&&Fn.setProperty(e.slide,t.substring(i.length),s))return!0;return!1}},In=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("indent",e.indent),t.set("comments",e.comments),t}static setProperty(e,t,s){switch(t){case"indent":return e.indent=s,!0;case"comments":return e.comments=s,!0}return!1}},An=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i.toLowerCase(),s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("core",xn.toJson(e.core)),t.set("display",Mn.toJson(e.display)),t.set("notation",En.toJson(e.notation)),t.set("importer",Ln.toJson(e.importer)),t.set("player",Dn.toJson(e.player)),t.set("exporter",In.toJson(e.exporter)),t}static setProperty(e,t,s){if(["core",""].indexOf(t)>=0)return xn.fromJson(e.core,s),!0;for(let i of["core",""])if(0===t.indexOf(i)&&xn.setProperty(e.core,t.substring(i.length),s))return!0;if(["display",""].indexOf(t)>=0)return Mn.fromJson(e.display,s),!0;for(let i of["display",""])if(0===t.indexOf(i)&&Mn.setProperty(e.display,t.substring(i.length),s))return!0;if(["notation"].indexOf(t)>=0)return En.fromJson(e.notation,s),!0;for(let i of["notation"])if(0===t.indexOf(i)&&En.setProperty(e.notation,t.substring(i.length),s))return!0;if(["importer"].indexOf(t)>=0)return Ln.fromJson(e.importer,s),!0;for(let i of["importer"])if(0===t.indexOf(i)&&Ln.setProperty(e.importer,t.substring(i.length),s))return!0;if(["player"].indexOf(t)>=0)return Dn.fromJson(e.player,s),!0;for(let i of["player"])if(0===t.indexOf(i)&&Dn.setProperty(e.player,t.substring(i.length),s))return!0;if(["exporter"].indexOf(t)>=0)return In.fromJson(e.exporter,s),!0;for(let i of["exporter"])if(0===t.indexOf(i)&&In.setProperty(e.exporter,t.substring(i.length),s))return!0;return!1}},Rn=class{constructor(){this.indent=2,this.comments=!1}},On=class e{constructor(){this.core=new _u,this.display=new bn,this.notation=new j,this.importer=new yn,this.player=new Bn,this.exporter=new Rn}setSongBookModeSettings(){this.notation.notationMode=1,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=2,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(11,!1),this.notation.elements.set(12,!1),this.notation.elements.set(13,!0)}static get songBook(){let t=new e;return t.setSongBookModeSettings(),t}fillFromJson(e){An.fromJson(this,e)}handleBackwardsCompatibility(){0===this.player.playerMode&&this.player.enablePlayer&&(this.player.playerMode=1)}},Vn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("marker",e.marker),t.set("text",e.text),t}static setProperty(e,t,s){switch(t){case"marker":return e.marker=s,!0;case"text":return e.text=s,!0}return!1}},Wn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("baroccurence",e.barOccurence),t.set("millisecondoffset",e.millisecondOffset),t}static setProperty(e,t,s){switch(t){case"baroccurence":return e.barOccurence=s,!0;case"millisecondoffset":return e.millisecondOffset=s,!0}return!1}},Hn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("islinear",e.isLinear),t.set("type",e.type),t.set("value",e.value),e.syncPointValue&&t.set("syncpointvalue",Wn.toJson(e.syncPointValue)),t.set("ratioposition",e.ratioPosition),t.set("text",e.text),t.set("isvisible",e.isVisible),t}static setProperty(e,t,s){switch(t){case"islinear":return e.isLinear=s,!0;case"type":return e.type=sn.parseEnum(s,S),!0;case"value":return e.value=s,!0;case"syncpointvalue":return s?(e.syncPointValue=new k,Wn.fromJson(e.syncPointValue,s)):e.syncPointValue=void 0,!0;case"ratioposition":return e.ratioPosition=s,!0;case"text":return e.text=s,!0;case"isvisible":return e.isVisible=s,!0}return!1}},Gn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("type",e.type),t.set("length",e.length),t}static setProperty(e,t,s){switch(t){case"type":return e.type=sn.parseEnum(s,It),!0;case"length":return e.length=s,!0}return!1}},zn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("alternateendings",e.alternateEndings),t.set("isdoublebar",e.isDoubleBar),t.set("isrepeatstart",e.isRepeatStart),t.set("repeatcount",e.repeatCount),t.set("timesignaturenumerator",e.timeSignatureNumerator),t.set("timesignaturedenominator",e.timeSignatureDenominator),t.set("timesignaturecommon",e.timeSignatureCommon),t.set("isfreetime",e.isFreeTime),t.set("tripletfeel",e.tripletFeel),e.section&&t.set("section",Vn.toJson(e.section)),t.set("tempoautomations",e.tempoAutomations.map(e=>Hn.toJson(e))),void 0!==e.syncPoints&&t.set("syncpoints",e.syncPoints?.map(e=>Hn.toJson(e))),null!==e.fermata){let s=new Map;t.set("fermata",s);for(let[t,i]of e.fermata)s.set(t.toString(),Gn.toJson(i))}if(t.set("start",e.start),t.set("isanacrusis",e.isAnacrusis),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),null!==e.directions){let s=[];t.set("directions",s);for(let t of e.directions)s.push(t)}return t}static setProperty(e,t,s){switch(t){case"alternateendings":return e.alternateEndings=s,!0;case"isdoublebar":return e.isDoubleBar=s,!0;case"isrepeatstart":return e.isRepeatStart=s,!0;case"repeatcount":return e.repeatCount=s,!0;case"timesignaturenumerator":return e.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return e.timeSignatureDenominator=s,!0;case"timesignaturecommon":return e.timeSignatureCommon=s,!0;case"isfreetime":return e.isFreeTime=s,!0;case"tripletfeel":return e.tripletFeel=sn.parseEnum(s,Ve),!0;case"section":return s?(e.section=new Kt,Vn.fromJson(e.section,s)):e.section=null,!0;case"tempoautomations":e.tempoAutomations=[];for(let t of s){let s=new w;Hn.fromJson(s,t),e.tempoAutomations.push(s)}return!0;case"syncpoints":if(s){e.syncPoints=[];for(let t of s){let s=new w;Hn.fromJson(s,t),e.addSyncPoint(s)}}return!0;case"fermata":return e.fermata=new Map,sn.forEach(s,(t,s)=>{let i=new At;Gn.fromJson(i,t),e.addFermata(Number.parseInt(s),i)}),!0;case"start":return e.start=s,!0;case"isanacrusis":return e.isAnacrusis=s,!0;case"displayscale":return e.displayScale=s,!0;case"displaywidth":return e.displayWidth=s,!0;case"directions":for(let t of s)e.addDirection(sn.parseEnum(t,Dt));return!0}return!1}},Un=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("offset",e.offset),t.set("value",e.value),t}static setProperty(e,t,s){switch(t){case"offset":return e.offset=s,!0;case"value":return e.value=s,!0}return!1}},Yn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;t.set("notehead",e.noteHead),t.set("noteheadcenteronstem",e.noteHeadCenterOnStem);{let s=new Map;t.set("colors",s);for(let[t,i]of e.colors)s.set(t.toString(),Jt.toJson(i))}return t}static setProperty(e,t,s){switch(t){case"notehead":return e.noteHead=sn.parseEnum(s,Ue),!0;case"noteheadcenteronstem":return e.noteHeadCenterOnStem=s,!0;case"colors":return e.colors=new Map,sn.forEach(s,(t,s)=>{e.colors.set(sn.parseEnum(s,it),Jt.fromJson(t))}),!0}return!1}},Xn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("id",e.id),t.set("accentuated",e.accentuated),t.set("bendtype",e.bendType),t.set("bendstyle",e.bendStyle),t.set("iscontinuedbend",e.isContinuedBend),null!==e.bendPoints&&t.set("bendpoints",e.bendPoints?.map(e=>Un.toJson(e))),t.set("fret",e.fret),t.set("string",e.string),t.set("showstringnumber",e.showStringNumber),t.set("octave",e.octave),t.set("tone",e.tone),t.set("percussionarticulation",e.percussionArticulation),t.set("isvisible",e.isVisible),t.set("islefthandtapped",e.isLeftHandTapped),t.set("ishammerpullorigin",e.isHammerPullOrigin),t.set("isslurdestination",e.isSlurDestination),t.set("harmonictype",e.harmonicType),t.set("harmonicvalue",e.harmonicValue),t.set("isghost",e.isGhost),t.set("isletring",e.isLetRing),t.set("ispalmmute",e.isPalmMute),t.set("isdead",e.isDead),t.set("isdeadvisual",e.isDeadVisual),t.set("isstaccato",e.isStaccato),t.set("slideintype",e.slideInType),t.set("slideouttype",e.slideOutType),t.set("vibrato",e.vibrato),t.set("istiedestination",e.isTieDestination),t.set("lefthandfinger",e.leftHandFinger),t.set("righthandfinger",e.rightHandFinger),t.set("trillvalue",e.trillValue),t.set("trillspeed",e.trillSpeed),t.set("durationpercent",e.durationPercent),t.set("accidentalmode",e.accidentalMode),t.set("dynamics",e.dynamics),t.set("ornament",e.ornament),e.style&&t.set("style",Yn.toJson(e.style)),e.toJson(t),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"accentuated":return e.accentuated=sn.parseEnum(s,R),!0;case"bendtype":return e.bendType=sn.parseEnum(s,C),!0;case"bendstyle":return e.bendStyle=sn.parseEnum(s,L),!0;case"iscontinuedbend":return e.isContinuedBend=s,!0;case"bendpoints":if(s){e.bendPoints=[];for(let t of s){let s=new T;Un.fromJson(s,t),e.addBendPoint(s)}}return!0;case"fret":return e.fret=s,!0;case"string":return e.string=s,!0;case"showstringnumber":return e.showStringNumber=s,!0;case"octave":return e.octave=s,!0;case"tone":return e.tone=s,!0;case"percussionarticulation":return e.percussionArticulation=s,!0;case"isvisible":return e.isVisible=s,!0;case"islefthandtapped":return e.isLeftHandTapped=s,!0;case"ishammerpullorigin":return e.isHammerPullOrigin=s,!0;case"isslurdestination":return e.isSlurDestination=s,!0;case"harmonictype":return e.harmonicType=sn.parseEnum(s,V),!0;case"harmonicvalue":return e.harmonicValue=s,!0;case"isghost":return e.isGhost=s,!0;case"isletring":return e.isLetRing=s,!0;case"ispalmmute":return e.isPalmMute=s,!0;case"isdead":return e.isDead=s,!0;case"isdeadvisual":return e.isDeadVisual=s,!0;case"isstaccato":return e.isStaccato=s,!0;case"slideintype":return e.slideInType=sn.parseEnum(s,G),!0;case"slideouttype":return e.slideOutType=sn.parseEnum(s,z),!0;case"vibrato":return e.vibrato=sn.parseEnum(s,U),!0;case"istiedestination":return e.isTieDestination=s,!0;case"lefthandfinger":return e.leftHandFinger=sn.parseEnum(s,O),!0;case"righthandfinger":return e.rightHandFinger=sn.parseEnum(s,O),!0;case"trillvalue":return e.trillValue=s,!0;case"trillspeed":return e.trillSpeed=sn.parseEnum(s,I),!0;case"durationpercent":return e.durationPercent=s,!0;case"accidentalmode":return e.accidentalMode=sn.parseEnum(s,W),!0;case"dynamics":return e.dynamics=sn.parseEnum(s,f),!0;case"ornament":return e.ornament=sn.parseEnum(s,tt),!0;case"style":return s?(e.style=new at,Yn.fromJson(e.style,s)):e.style=void 0,!0}return e.setProperty(t,s)}},$n=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;{let s=new Map;t.set("colors",s);for(let[t,i]of e.colors)s.set(t.toString(),Jt.toJson(i))}return t}static setProperty(e,t,s){return"colors"===t&&(e.colors=new Map,sn.forEach(s,(t,s)=>{e.colors.set(sn.parseEnum(s,yt),Jt.fromJson(t))}),!0)}},Jn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("id",e.id),t.set("notes",e.notes.map(e=>Xn.toJson(e))),t.set("isempty",e.isEmpty),t.set("whammystyle",e.whammyStyle),t.set("ottava",e.ottava),t.set("islegatoorigin",e.isLegatoOrigin),t.set("duration",e.duration),t.set("automations",e.automations.map(e=>Hn.toJson(e))),t.set("dots",e.dots),t.set("fade",e.fade),t.set("lyrics",e.lyrics),t.set("pop",e.pop),t.set("slap",e.slap),t.set("tap",e.tap),t.set("text",e.text),t.set("slashed",e.slashed),t.set("deadslapped",e.deadSlapped),t.set("brushtype",e.brushType),t.set("brushduration",e.brushDuration),t.set("tupletdenominator",e.tupletDenominator),t.set("tupletnumerator",e.tupletNumerator),t.set("iscontinuedwhammy",e.isContinuedWhammy),t.set("whammybartype",e.whammyBarType),null!==e.whammyBarPoints&&t.set("whammybarpoints",e.whammyBarPoints?.map(e=>Un.toJson(e))),t.set("vibrato",e.vibrato),t.set("chordid",e.chordId),t.set("gracetype",e.graceType),t.set("pickstroke",e.pickStroke),t.set("tremolospeed",e.tremoloSpeed),t.set("crescendo",e.crescendo),t.set("displaystart",e.displayStart),t.set("playbackstart",e.playbackStart),t.set("displayduration",e.displayDuration),t.set("playbackduration",e.playbackDuration),t.set("overridedisplayduration",e.overrideDisplayDuration),t.set("golpe",e.golpe),t.set("dynamics",e.dynamics),t.set("invertbeamdirection",e.invertBeamDirection),t.set("preferredbeamdirection",e.preferredBeamDirection),t.set("beamingmode",e.beamingMode),t.set("wahpedal",e.wahPedal),t.set("barrefret",e.barreFret),t.set("barreshape",e.barreShape),t.set("rasgueado",e.rasgueado),t.set("showtimer",e.showTimer),t.set("timer",e.timer),e.style&&t.set("style",$n.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"notes":e.notes=[];for(let t of s){let s=new nt;Xn.fromJson(s,t),e.addNote(s)}return!0;case"isempty":return e.isEmpty=s,!0;case"whammystyle":return e.whammyStyle=sn.parseEnum(s,L),!0;case"ottava":return e.ottava=sn.parseEnum(s,H),!0;case"islegatoorigin":return e.isLegatoOrigin=s,!0;case"duration":return e.duration=sn.parseEnum(s,I),!0;case"automations":e.automations=[];for(let t of s){let s=new w;Hn.fromJson(s,t),e.automations.push(s)}return!0;case"dots":return e.dots=s,!0;case"fade":return e.fade=sn.parseEnum(s,pt),!0;case"lyrics":return e.lyrics=s,!0;case"pop":return e.pop=s,!0;case"slap":return e.slap=s,!0;case"tap":return e.tap=s,!0;case"text":return e.text=s,!0;case"slashed":return e.slashed=s,!0;case"deadslapped":return e.deadSlapped=s,!0;case"brushtype":return e.brushType=sn.parseEnum(s,F),!0;case"brushduration":return e.brushDuration=s,!0;case"tupletdenominator":return e.tupletDenominator=s,!0;case"tupletnumerator":return e.tupletNumerator=s,!0;case"iscontinuedwhammy":return e.isContinuedWhammy=s,!0;case"whammybartype":return e.whammyBarType=sn.parseEnum(s,ct),!0;case"whammybarpoints":if(s){e.whammyBarPoints=[];for(let t of s){let s=new T;Un.fromJson(s,t),e.addWhammyBarPoint(s)}}return!0;case"vibrato":return e.vibrato=sn.parseEnum(s,U),!0;case"chordid":return e.chordId=s,!0;case"gracetype":return e.graceType=sn.parseEnum(s,A),!0;case"pickstroke":return e.pickStroke=sn.parseEnum(s,je),!0;case"tremolospeed":return e.tremoloSpeed=sn.parseEnum(s,I)??null,!0;case"crescendo":return e.crescendo=sn.parseEnum(s,D),!0;case"displaystart":return e.displayStart=s,!0;case"playbackstart":return e.playbackStart=s,!0;case"displayduration":return e.displayDuration=s,!0;case"playbackduration":return e.playbackDuration=s,!0;case"overridedisplayduration":return e.overrideDisplayDuration=s,!0;case"golpe":return e.golpe=sn.parseEnum(s,ut),!0;case"dynamics":return e.dynamics=sn.parseEnum(s,f),!0;case"invertbeamdirection":return e.invertBeamDirection=s,!0;case"preferredbeamdirection":return e.preferredBeamDirection=sn.parseEnum(s,Ss)??null,!0;case"beamingmode":return e.beamingMode=sn.parseEnum(s,bt),!0;case"wahpedal":return e.wahPedal=sn.parseEnum(s,mt),!0;case"barrefret":return e.barreFret=s,!0;case"barreshape":return e.barreShape=sn.parseEnum(s,gt),!0;case"rasgueado":return e.rasgueado=sn.parseEnum(s,ft),!0;case"showtimer":return e.showTimer=s,!0;case"timer":return e.timer=s,!0;case"style":return s?(e.style=new _t,$n.fromJson(e.style,s)):e.style=void 0,!0}return!1}},qn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;{let s=new Map;t.set("colors",s);for(let[t,i]of e.colors)s.set(t.toString(),Jt.toJson(i))}return t}static setProperty(e,t,s){return"colors"===t&&(e.colors=new Map,sn.forEach(s,(t,s)=>{e.colors.set(sn.parseEnum(s,ve),Jt.fromJson(t))}),!0)}},jn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("id",e.id),t.set("beats",e.beats.map(e=>Jn.toJson(e))),e.style&&t.set("style",qn.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"beats":e.beats=[];for(let t of s){let s=new wt;Jn.fromJson(s,t),e.addBeat(s)}return!0;case"style":return s?(e.style=new Pe,qn.fromJson(e.style,s)):e.style=void 0,!0}return!1}},Kn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("ratioposition",e.ratioPosition),t.set("pedaltype",e.pedalType),t}static setProperty(e,t,s){switch(t){case"ratioposition":return e.ratioPosition=s,!0;case"pedaltype":return e.pedalType=sn.parseEnum(s,be),!0}return!1}},Qn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;{let s=new Map;t.set("colors",s);for(let[t,i]of e.colors)s.set(t.toString(),Jt.toJson(i))}return t}static setProperty(e,t,s){return"colors"===t&&(e.colors=new Map,sn.forEach(s,(t,s)=>{e.colors.set(sn.parseEnum(s,_e),Jt.fromJson(t))}),!0)}},Zn=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("id",e.id),t.set("clef",e.clef),t.set("clefottava",e.clefOttava),t.set("voices",e.voices.map(e=>jn.toJson(e))),t.set("similemark",e.simileMark),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),t.set("sustainpedals",e.sustainPedals.map(e=>Kn.toJson(e))),t.set("barlineleft",e.barLineLeft),t.set("barlineright",e.barLineRight),t.set("keysignature",e.keySignature),t.set("keysignaturetype",e.keySignatureType),e.style&&t.set("style",Qn.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"clef":return e.clef=sn.parseEnum(s,pe),!0;case"clefottava":return e.clefOttava=sn.parseEnum(s,H),!0;case"voices":e.voices=[];for(let t of s){let s=new Me;jn.fromJson(s,t),e.addVoice(s)}return!0;case"similemark":return e.simileMark=sn.parseEnum(s,me),!0;case"displayscale":return e.displayScale=s,!0;case"displaywidth":return e.displayWidth=s,!0;case"sustainpedals":e.sustainPedals=[];for(let t of s){let s=new ye;Kn.fromJson(s,t),e.sustainPedals.push(s)}return!0;case"barlineleft":return e.barLineLeft=sn.parseEnum(s,ke),!0;case"barlineright":return e.barLineRight=sn.parseEnum(s,ke),!0;case"keysignature":return e.keySignature=sn.parseEnum(s,ge),!0;case"keysignaturetype":return e.keySignatureType=sn.parseEnum(s,fe),!0;case"style":return s?(e.style=new Se,Qn.fromJson(e.style,s)):e.style=void 0,!0}return!1}},eo=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("name",e.name),t.set("firstfret",e.firstFret),t.set("strings",e.strings),t.set("barrefrets",e.barreFrets),t.set("showname",e.showName),t.set("showdiagram",e.showDiagram),t.set("showfingering",e.showFingering),t}static setProperty(e,t,s){switch(t){case"name":return e.name=s,!0;case"firstfret":return e.firstFret=s,!0;case"strings":return e.strings=s,!0;case"barrefrets":return e.barreFrets=s,!0;case"showname":return e.showName=s,!0;case"showdiagram":return e.showDiagram=s,!0;case"showfingering":return e.showFingering=s,!0}return!1}},to=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("isstandard",e.isStandard),t.set("name",e.name),t.set("tunings",e.tunings),t}static setProperty(e,t,s){switch(t){case"isstandard":return e.isStandard=s,!0;case"name":return e.name=s,!0;case"tunings":return e.tunings=s,!0}return!1}},so=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("bars",e.bars.map(e=>Zn.toJson(e))),null!==e.chords){let s=new Map;t.set("chords",s);for(let[t,i]of e.chords)s.set(t.toString(),eo.toJson(i))}return t.set("capo",e.capo),t.set("transpositionpitch",e.transpositionPitch),t.set("displaytranspositionpitch",e.displayTranspositionPitch),t.set("stringtuning",to.toJson(e.stringTuning)),t.set("showslash",e.showSlash),t.set("shownumbered",e.showNumbered),t.set("showtablature",e.showTablature),t.set("showstandardnotation",e.showStandardNotation),t.set("ispercussion",e.isPercussion),t.set("standardnotationlinecount",e.standardNotationLineCount),t}static setProperty(e,t,s){switch(t){case"bars":e.bars=[];for(let t of s){let s=new Be;Zn.fromJson(s,t),e.addBar(s)}return!0;case"chords":return e.chords=new Map,sn.forEach(s,(t,s)=>{let i=new Yt;eo.fromJson(i,t),e.addChord(s,i)}),!0;case"capo":return e.capo=s,!0;case"transpositionpitch":return e.transpositionPitch=s,!0;case"displaytranspositionpitch":return e.displayTranspositionPitch=s,!0;case"stringtuning":return to.fromJson(e.stringTuning,s),!0;case"showslash":return e.showSlash=s,!0;case"shownumbered":return e.showNumbered=s,!0;case"showtablature":return e.showTablature=s,!0;case"showstandardnotation":return e.showStandardNotation=s,!0;case"ispercussion":return e.isPercussion=s,!0;case"standardnotationlinecount":return e.standardNotationLineCount=s,!0}return!1}},io=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("volume",e.volume),t.set("balance",e.balance),t.set("port",e.port),t.set("program",e.program),t.set("bank",e.bank),t.set("primarychannel",e.primaryChannel),t.set("secondarychannel",e.secondaryChannel),t.set("ismute",e.isMute),t.set("issolo",e.isSolo),t}static setProperty(e,t,s){switch(t){case"volume":return e.volume=s,!0;case"balance":return e.balance=s,!0;case"port":return e.port=s,!0;case"program":return e.program=s,!0;case"bank":return e.bank=s,!0;case"primarychannel":return e.primaryChannel=s,!0;case"secondarychannel":return e.secondaryChannel=s,!0;case"ismute":return e.isMute=s,!0;case"issolo":return e.isSolo=s,!0}return!1}},ao=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("elementtype",e.elementType),t.set("staffline",e.staffLine),t.set("noteheaddefault",e.noteHeadDefault),t.set("noteheadhalf",e.noteHeadHalf),t.set("noteheadwhole",e.noteHeadWhole),t.set("techniquesymbol",e.techniqueSymbol),t.set("techniquesymbolplacement",e.techniqueSymbolPlacement),t.set("outputmidinumber",e.outputMidiNumber),t}static setProperty(e,t,s){switch(t){case"elementtype":return e.elementType=s,!0;case"staffline":return e.staffLine=s,!0;case"noteheaddefault":return e.noteHeadDefault=sn.parseEnum(s,Ue),!0;case"noteheadhalf":return e.noteHeadHalf=sn.parseEnum(s,Ue),!0;case"noteheadwhole":return e.noteHeadWhole=sn.parseEnum(s,Ue),!0;case"techniquesymbol":return e.techniqueSymbol=sn.parseEnum(s,Ue),!0;case"techniquesymbolplacement":return e.techniqueSymbolPlacement=sn.parseEnum(s,Ke),!0;case"outputmidinumber":return e.outputMidiNumber=s,!0}return!1}},ro=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;{let s=new Map;t.set("colors",s);for(let[t,i]of e.colors)s.set(t.toString(),Jt.toJson(i))}return t}static setProperty(e,t,s){return"colors"===t&&(e.colors=new Map,sn.forEach(s,(t,s)=>{e.colors.set(sn.parseEnum(s,is),Jt.fromJson(t))}),!0)}},no=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("staves",e.staves.map(e=>so.toJson(e))),t.set("playbackinfo",io.toJson(e.playbackInfo)),t.set("color",Jt.toJson(e.color)),t.set("name",e.name),t.set("isvisibleonmultitrack",e.isVisibleOnMultiTrack),t.set("shortname",e.shortName),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),void 0!==e.lineBreaks){let s=[];t.set("linebreaks",s);for(let t of e.lineBreaks)s.push(t)}return t.set("percussionarticulations",e.percussionArticulations.map(e=>ao.toJson(e))),e.style&&t.set("style",ro.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"staves":e.staves=[];for(let t of s){let s=new ts;so.fromJson(s,t),e.addStaff(s)}return!0;case"playbackinfo":return io.fromJson(e.playbackInfo,s),!0;case"color":return e.color=Jt.fromJson(s),!0;case"name":return e.name=s,!0;case"isvisibleonmultitrack":return e.isVisibleOnMultiTrack=s,!0;case"shortname":return e.shortName=s,!0;case"defaultsystemslayout":return e.defaultSystemsLayout=s,!0;case"systemslayout":return e.systemsLayout=s,!0;case"linebreaks":for(let t of s)e.addLineBreaks(t);return!0;case"percussionarticulations":e.percussionArticulations=[];for(let t of s){let s=new Qe;ao.fromJson(s,t),e.percussionArticulations.push(s)}return!0;case"style":return s?(e.style=new as,ro.fromJson(e.style,s)):e.style=void 0,!0}return!1}},oo=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;if(t.set("hidedynamics",e.hideDynamics),t.set("bracketextendmode",e.bracketExtendMode),t.set("usesystemsignseparator",e.useSystemSignSeparator),t.set("globaldisplaytuning",e.globalDisplayTuning),null!==e.perTrackDisplayTuning){let s=new Map;t.set("pertrackdisplaytuning",s);for(let[t,i]of e.perTrackDisplayTuning)s.set(t.toString(),i)}if(t.set("globaldisplaychorddiagramsontop",e.globalDisplayChordDiagramsOnTop),null!==e.perTrackChordDiagramsOnTop){let s=new Map;t.set("pertrackchorddiagramsontop",s);for(let[t,i]of e.perTrackChordDiagramsOnTop)s.set(t.toString(),i)}if(t.set("singletracktracknamepolicy",e.singleTrackTrackNamePolicy),t.set("multitracktracknamepolicy",e.multiTrackTrackNamePolicy),t.set("firstsystemtracknamemode",e.firstSystemTrackNameMode),t.set("othersystemstracknamemode",e.otherSystemsTrackNameMode),t.set("firstsystemtracknameorientation",e.firstSystemTrackNameOrientation),t.set("othersystemstracknameorientation",e.otherSystemsTrackNameOrientation),t.set("multitrackmultibarrest",e.multiTrackMultiBarRest),null!==e.perTrackMultiBarRest){let s=[];t.set("pertrackmultibarrest",s);for(let t of e.perTrackMultiBarRest)s.push(t)}return t}static setProperty(e,t,s){switch(t){case"hidedynamics":return e.hideDynamics=s,!0;case"bracketextendmode":return e.bracketExtendMode=sn.parseEnum(s,ne),!0;case"usesystemsignseparator":return e.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return e.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return e.perTrackDisplayTuning=new Map,sn.forEach(s,(t,s)=>{e.perTrackDisplayTuning.set(Number.parseInt(s),t)}),!0;case"globaldisplaychorddiagramsontop":return e.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return e.perTrackChordDiagramsOnTop=new Map,sn.forEach(s,(t,s)=>{e.perTrackChordDiagramsOnTop.set(Number.parseInt(s),t)}),!0;case"singletracktracknamepolicy":return e.singleTrackTrackNamePolicy=sn.parseEnum(s,oe),!0;case"multitracktracknamepolicy":return e.multiTrackTrackNamePolicy=sn.parseEnum(s,oe),!0;case"firstsystemtracknamemode":return e.firstSystemTrackNameMode=sn.parseEnum(s,le),!0;case"othersystemstracknamemode":return e.otherSystemsTrackNameMode=sn.parseEnum(s,le),!0;case"firstsystemtracknameorientation":return e.firstSystemTrackNameOrientation=sn.parseEnum(s,he),!0;case"othersystemstracknameorientation":return e.otherSystemsTrackNameOrientation=sn.parseEnum(s,he),!0;case"multitrackmultibarrest":return e.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return e.perTrackMultiBarRest=new Set(s),!0}return!1}},lo=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){return e?new Map:null}static setProperty(e,t,s){return!1}},ho=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("template",e.template),t.set("isvisible",e.isVisible),t.set("textalign",e.textAlign),t}static setProperty(e,t,s){switch(t){case"template":return e.template=s,!0;case"isvisible":return e.isVisible=s,!0;case"textalign":return e.textAlign=sn.parseEnum(s,Ee),!0}return!1}},co=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;{let s=new Map;t.set("headerandfooter",s);for(let[t,i]of e.headerAndFooter)s.set(t.toString(),ho.toJson(i))}{let s=new Map;t.set("colors",s);for(let[t,i]of e.colors)s.set(t.toString(),Jt.toJson(i))}return t}static setProperty(e,t,s){switch(t){case"headerandfooter":return e.headerAndFooter=new Map,sn.forEach(s,(t,s)=>{let i=new Ae;ho.fromJson(i,t),e.headerAndFooter.set(sn.parseEnum(s,De),i)}),!0;case"colors":return e.colors=new Map,sn.forEach(s,(t,s)=>{e.colors.set(sn.parseEnum(s,De),Jt.fromJson(t))}),!0}return!1}},uo=class e{static fromJson(t,s){s&&sn.forEach(s,(s,i)=>e.setProperty(t,i,s))}static toJson(e){if(!e)return null;let t=new Map;return t.set("album",e.album),t.set("artist",e.artist),t.set("copyright",e.copyright),t.set("instructions",e.instructions),t.set("music",e.music),t.set("notices",e.notices),t.set("subtitle",e.subTitle),t.set("title",e.title),t.set("words",e.words),t.set("tab",e.tab),t.set("masterbars",e.masterBars.map(e=>zn.toJson(e))),t.set("tracks",e.tracks.map(e=>no.toJson(e))),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),t.set("stylesheet",oo.toJson(e.stylesheet)),e.backingTrack&&t.set("backingtrack",lo.toJson(e.backingTrack)),e.style&&t.set("style",co.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"album":return e.album=s,!0;case"artist":return e.artist=s,!0;case"copyright":return e.copyright=s,!0;case"instructions":return e.instructions=s,!0;case"music":return e.music=s,!0;case"notices":return e.notices=s,!0;case"subtitle":return e.subTitle=s,!0;case"title":return e.title=s,!0;case"words":return e.words=s,!0;case"tab":return e.tab=s,!0;case"masterbars":e.masterBars=[];for(let t of s){let s=new We;zn.fromJson(s,t),e.addMasterBar(s)}return!0;case"tracks":e.tracks=[];for(let t of s){let s=new ns;no.fromJson(s,t),e.addTrack(s)}return!0;case"defaultsystemslayout":return e.defaultSystemsLayout=s,!0;case"systemslayout":return e.systemsLayout=s,!0;case"stylesheet":return oo.fromJson(e.stylesheet,s),!0;case"backingtrack":return s?(e.backingTrack=new Si,lo.fromJson(e.backingTrack,s)):e.backingTrack=void 0,!0;case"style":return s?(e.style=new Re,co.fromJson(e.style,s)):e.style=void 0,!0}return!1}},po=class e{static _jsonReplacer(e,t){if(t instanceof Map){if("fromEntries"in Object)return Object.fromEntries(t);let e={};for(let[s,i]of t)e[s]=i;return e}return ArrayBuffer.isView(t)?Array.apply([],[t]):t}static scoreToJson(t){let s=e.scoreToJsObject(t);return JSON.stringify(s,e._jsonReplacer)}static jsonToScore(t,s){return e.jsObjectToScore(JSON.parse(t),s)}static scoreToJsObject(e){return uo.toJson(e)}static jsObjectToScore(e,t){let s=new Oe;return uo.fromJson(s,e),s.finish(t??new On),s}static settingsToJson(t){let s=e.settingsToJsObject(t);return JSON.stringify(s,e._jsonReplacer)}static jsonToSettings(t){return e.jsObjectToSettings(JSON.parse(t))}static settingsToJsObject(e){return An.toJson(e)}static jsObjectToSettings(e){let t=new On;return An.fromJson(t,e),t}static jsObjectToMidiFile(t){let s=new oa;return sn.forEach(t,(t,i)=>{switch(i){case"division":s.division=t;break;case"tracks":for(let i of t){let t=e._jsObjectToMidiTrack(i);s.tracks.push(t)}}}),s}static _jsObjectToMidiTrack(t){let s=new na;return sn.forEach(t,(t,i)=>{if("events"===i)for(let i of t){let t=e.jsObjectToMidiEvent(i);s.events.push(t)}}),s}static jsObjectToMidiEvent(e){let t=sn.getValue(e,"track"),s=sn.getValue(e,"tick"),i=sn.getValue(e,"type");switch(i){case 88:return new da(t,s,sn.getValue(e,"numerator"),sn.getValue(e,"denominatorIndex"),sn.getValue(e,"midiClocksPerMetronomeClick"),sn.getValue(e,"thirdySecondNodesInQuarter"));case 241:return new ma(t,s,sn.getValue(e,"channel"));case 242:return new pa(t,s,sn.getValue(e,"metronomeNumerator"),sn.getValue(e,"metronomeDurationInTicks"),sn.getValue(e,"metronomeDurationInMilliseconds"));case 128:return new fa(t,s,sn.getValue(e,"channel"),sn.getValue(e,"noteKey"),sn.getValue(e,"noteVelocity"));case 144:return new ba(t,s,sn.getValue(e,"channel"),sn.getValue(e,"noteKey"),sn.getValue(e,"noteVelocity"));case 176:return new ya(t,s,sn.getValue(e,"channel"),sn.getValue(e,"controller"),sn.getValue(e,"value"));case 192:return new _a(t,s,sn.getValue(e,"channel"),sn.getValue(e,"program"));case 81:let i=new Sa(s,0);return i.beatsPerMinute=sn.getValue(e,"beatsPerMinute"),i;case 224:return new ka(t,s,sn.getValue(e,"channel"),sn.getValue(e,"value"));case 96:return new wa(t,s,sn.getValue(e,"channel"),sn.getValue(e,"noteKey"),sn.getValue(e,"value"));case 47:return new Ta(t,s)}throw new u(1,`Unknown Midi Event type: ${i}`)}static midiFileToJsObject(t){let s=new Map;s.set("division",t.division);let i=[];for(let s of t.tracks)i.push(e._midiTrackToJsObject(s));return s.set("tracks",i),s}static _midiTrackToJsObject(t){let s=new Map,i=[];for(let s of t.events)i.push(e.midiEventToJsObject(s));return s.set("events",i),s}static midiEventToJsObject(e){let t=new Map;switch(t.set("track",e.track),t.set("tick",e.tick),t.set("type",e.type),e.type){case 88:t.set("numerator",e.numerator),t.set("denominatorIndex",e.denominatorIndex),t.set("midiClocksPerMetronomeClick",e.midiClocksPerMetronomeClick),t.set("thirdySecondNodesInQuarter",e.thirtySecondNodesInQuarter);break;case 241:t.set("channel",e.channel);break;case 242:t.set("metronomeNumerator",e.metronomeNumerator),t.set("metronomeDurationInMilliseconds",e.metronomeDurationInMilliseconds),t.set("metronomeDurationInTicks",e.metronomeDurationInTicks);break;case 128:case 144:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("noteVelocity",e.noteVelocity);break;case 176:t.set("channel",e.channel),t.set("controller",e.controller),t.set("value",e.value);break;case 192:t.set("channel",e.channel),t.set("program",e.program);break;case 81:t.set("beatsPerMinute",e.beatsPerMinute);break;case 224:t.set("channel",e.channel),t.set("value",e.value);break;case 96:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("value",e.value)}return t}},mo=class e{constructor(e,t){this._exporter=new Map,this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new en(new qi,t),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){let t=bu.globalThis;t.addEventListener("message",s=>{let i=s.data;"alphaSynth.initialize"===i.cmd&&(qi.preferredSampleRate=i.sampleRate,re.logLevel=i.logLevel,bu.globalThis.alphaSynthWebWorker=new e(t,i.bufferTimeInMilliseconds))})}handleMessage(e){let t=e.data,s=t.cmd;switch(s){case"alphaSynth.setLogLevel":re.logLevel=t.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=t.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=t.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=t.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=t.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=t.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=t.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=t.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=t.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=t.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(po.jsObjectToMidiFile(t.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(t.data,t.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(po.jsObjectToMidiFile(t.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(t.channel,t.mute);break;case"alphaSynth.setChannelTranspositionPitch":this._player.setChannelTranspositionPitch(t.channel,t.semitones);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(t.channel,t.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(t.channel,t.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this._player.applyTranspositionPitches(new Map(JSON.parse(t.transpositionPitches)))}s.startsWith("alphaSynth.exporter")&&this._handleExporterMessage(e)}_handleExporterMessage(e){let t=e.data,s=t.cmd;try{switch(s){case"alphaSynth.exporter.initialize":let e=this._player.exportAudio(t.options,po.jsObjectToMidiFile(t.midi),t.syncPoints,t.transpositionPitches);this._exporter.set(t.exporterId,e),this._main.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:t.exporterId});break;case"alphaSynth.exporter.render":if(this._exporter.has(t.exporterId)){let e=this._exporter.get(t.exporterId).render(t.milliseconds);this._main.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:t.exporterId,chunk:e})}else this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:t.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this._exporter.delete(t.exporterId)}}catch(e){this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:t.exporterId,error:e})}}onPositionChanged(e){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onPlayerStateChanged(e){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:e.state,stopped:e.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this._serializeException(bu.prepareForPostMessage(e))})}_serializeException(e){let t=JSON.parse(JSON.stringify(e));return e.message&&(t.message=e.message),e.stack&&(t.stack=e.stack),e.constructor&&e.constructor.name&&(t.type=e.constructor.name),t}onMidiLoaded(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onMidiLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this._serializeException(bu.prepareForPostMessage(e))})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(e){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:e.events.map(po.midiEventToJsObject)})}onPlaybackRangeChanged(e){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:e.playbackRange})}},go=(e=>(e[e.Browser=0]="Browser",e[e.NodeJs=1]="NodeJs",e[e.BrowserModule=2]="BrowserModule",e))(go||{}),fo=class{constructor(e,t){this.characterWidths=e,this.characterHeights=t}},bo=class e{static generateFontLookup(t){if(!e.fontSizeLookupTables.has(t))if(bu.isRunningInWorker||1===bu.webPlatform){let s=new fo(new Uint8Array([8]),new Uint8Array([10]));e.fontSizeLookupTables.set(t,s)}else{let s=document.createElement("canvas").getContext("2d"),i=11;s.font=`${i}px ${t}`;let a=[],r=[];for(let t=e.ControlChars;t<255;t++){let e=String.fromCharCode(t),i=s.measureText(e);a.push(i.width);let n=i.actualBoundingBoxDescent+i.actualBoundingBoxAscent;r.push(n)}let n=new fo(new Uint8Array(a),new Uint8Array(r));e.fontSizeLookupTables.set(t,n)}}static measureString(t,s,i,a,r){let n,o=s[0];for(let t=0;t<s.length;t++)if(e.fontSizeLookupTables.has(s[t])){o=s[t];break}e.fontSizeLookupTables.has(o)||e.generateFontLookup(o),n=e.fontSizeLookupTables.get(o);let l=1;1===a&&(l*=1.1),1===r&&(l*=1.1);let h=0,d=0;for(let s=0;s<t.length;s++){let a=Math.min(n.characterWidths.length-1,t.charCodeAt(s)-e.ControlChars);a>=0&&(h+=n.characterWidths[a]*i/11,d=Math.max(d,n.characterHeights[a]*i/11))}return l*=1.07,new Ce(h*l,d)}};bo.fontSizeLookupTables=new Map,bo.ControlChars=32;var yo=bo,_o=class e{constructor(e){this._main=e,this._main.addEventListener("message",this._handleMessage.bind(this),!1)}static init(){bu.globalThis.alphaTabWebWorker=new e(bu.globalThis)}_handleMessage(e){let t=e.data;switch(t?t.cmd:""){case"alphaTab.initialize":let e=po.jsObjectToSettings(t.settings);re.logLevel=e.core.logLevel,this._renderer=new _s(e),this._renderer.partialRenderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:e})}),this._renderer.partialLayoutFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:e})}),this._renderer.renderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:e})}),this._renderer.postRenderFinished.on(()=>{this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this._renderer.boundsLookup?.toJson()??null})}),this._renderer.preRender.on(e=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:e})}),this._renderer.error.on(this._error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(t.resultId);break;case"alphaTab.setWidth":this._renderer.width=t.width;break;case"alphaTab.renderScore":this._updateFontSizes(t.fontSizes);let s=null==t.score?null:po.jsObjectToScore(t.score,this._renderer.settings);this._renderMultiple(s,t.trackIndexes);break;case"alphaTab.updateSettings":this._updateSettings(t.settings)}}_updateFontSizes(e){if(!(e instanceof Map)){let t=e;e=new Map;for(let s in t)e.set(s,t[s])}if(e)for(let[t,s]of e)yo.fontSizeLookupTables.set(t,s)}_updateSettings(e){An.fromJson(this._renderer.settings,e)}_renderMultiple(e,t){try{this._renderer.renderScore(e,t)}catch(e){this._error(e)}}_error(e){re.error("Worker","An unexpected error occurred in worker",e),this._main.postMessage({cmd:"alphaTab.error",error:e})}},So=class{constructor(){this._canvas=null,this._color=new Jt(0,0,0,255),this._font=new ln("Arial",10,0),this._lineWidth=0,this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(e,t){this._musicFont=new ln(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,0,0);let s=this.settings.display.scale;this._canvas=document.createElement("canvas"),this._canvas.width=e*bu.highDpiFactor|0,this._canvas.height=t*bu.highDpiFactor|0,this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`,this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(bu.highDpiFactor*s,bu.highDpiFactor*s),this._context.lineWidth=this._lineWidth}endRender(){let e=this._canvas;return this._canvas=null,e}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._context.strokeStyle=e.rgba,this._context.fillStyle=e.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._context&&(this._context.lineWidth=e)}fillRect(e,t,s,i){s>0&&this._context.fillRect(e,t,s,i)}strokeRect(e,t,s,i){let a=this.lineWidth%2==0?0:.5;this._context.strokeRect(e+a,t+a,s,i)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(e,t){this._context.moveTo(e,t)}lineTo(e,t){this._context.lineTo(e,t)}quadraticCurveTo(e,t,s,i){this._context.quadraticCurveTo(e,t,s,i)}bezierCurveTo(e,t,s,i,a,r){this._context.bezierCurveTo(e,t,s,i,a,r)}fillCircle(e,t,s){this._context.beginPath(),this._context.arc(e,t,s,0,2*Math.PI,!0),this.fill()}strokeCircle(e,t,s){this._context.beginPath(),this._context.arc(e,t,s,0,2*Math.PI,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(e){this._font=e,this._context&&(this._context.font=e.toCssString(1)),this._measureContext.font=e.toCssString(1)}get textAlign(){switch(this._context.textAlign){case"left":default:return 0;case"center":return 1;case"right":return 2}}set textAlign(e){switch(e){case 0:this._context.textAlign="left";break;case 1:this._context.textAlign="center";break;case 2:this._context.textAlign="right"}}get textBaseline(){switch(this._context.textBaseline){case"hanging":default:return 0;case"middle":return 1;case"bottom":return 2;case"alphabetic":return 3}}set textBaseline(e){switch(e){case 0:this._context.textBaseline="hanging";break;case 1:this._context.textBaseline="middle";break;case 2:this._context.textBaseline="bottom";break;case 3:this._context.textBaseline="alphabetic"}}beginGroup(e){}endGroup(){}fillText(e,t,s){this._context.fillText(e,t,s)}measureText(e){let t=this._measureContext.measureText(e);return new Ce(t.width,t.actualBoundingBoxDescent+t.actualBoundingBoxAscent)}fillMusicFontSymbol(e,t,s,i,a=!1){-1!==i&&this._fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),a)}fillMusicFontSymbols(e,t,s,i,a=!1){let r="";for(let e of i)-1!==e&&(r+=String.fromCharCode(e));this._fillMusicFontSymbolText(e,t,s,r,a)}_fillMusicFontSymbolText(e,t,s,i,a){let r=this._context.textAlign,n=this._context.textBaseline,o=this._context.font;this._context.font=this._musicFont.toCssString(s),this._context.textBaseline="alphabetic",this._context.textAlign=a?"center":"left",this._context.fillText(i,e,t),this._context.textBaseline=n,this._context.font=o,this._context.textAlign=r}beginRotate(e,t,s){this._context.save(),this._context.translate(e,t),this._context.rotate(s*Math.PI/180)}endRotate(){this._context.restore()}},ko=class e{constructor(e,t=!1){this._midiFile=e,this._smf1Mode=t}addTimeSignature(e,t,s){let i=0,a=s;for(;a>>=1,a>0;)i++;this._midiFile.addEvent(new da(0,e,t,i,48,8))}addRest(e,t,s){this._smf1Mode||this._midiFile.addEvent(new ma(e,t,s))}addNote(t,s,i,a,r,n){this._midiFile.addEvent(new fa(t,s,n,e._fixValue(a),e._fixValue(r))),this._midiFile.addEvent(new ba(t,s+i,n,e._fixValue(a),e._fixValue(r)))}static _fixValue(e){return e>127?127:e<0?0:e}addControlChange(t,s,i,a,r){this._midiFile.addEvent(new ya(t,s,i,a,e._fixValue(r)))}addProgramChange(e,t,s,i){this._midiFile.addEvent(new _a(e,t,s,i))}addTempo(e,t){let s=new Sa(e,0);s.beatsPerMinute=t,this._midiFile.addEvent(s)}addBend(e,t,s,i){i=i>=ze.MaxPitchWheel?ze.MaxPitchWheel:Math.floor(i),this._midiFile.addEvent(new ka(e,t,s,i))}addNoteBend(e,t,s,i,a){this._smf1Mode?this.addBend(e,t,s,a):(a=a*ze.MaxPitchWheel20/ze.MaxPitchWheel,this._midiFile.addEvent(new wa(e,t,s,i,a)))}finishTrack(e,t){(1===this._midiFile.format||0===e)&&this._midiFile.addEvent(new Ta(e,t))}},wo=class{constructor(e,t){this.closingIndex=0,this.group=e,this.opening=t,e.closings=e.closings.sort((e,t)=>e.index-t.index),this.iterations=e.closings.map(e=>0)}},To=class{constructor(e){this._repeatStack=[],this._groupsOnStack=new Set,this._previousAlternateEndings=0,this._state=0,this.shouldPlay=!0,this.index=0,this.currentTick=0,this._score=e}get finished(){return this.index>=this._score.masterBars.length}processCurrent(){let e=this._score.masterBars[this.index];if(0===this._state){let t=e.alternateEndings;if(0===t&&(t=this._previousAlternateEndings),e===e.repeatGroup.opening&&e.repeatGroup.isClosed&&!this._groupsOnStack.has(e.repeatGroup)){let s=new wo(e.repeatGroup,e);this._repeatStack.push(s),this._groupsOnStack.add(e.repeatGroup),this._previousAlternateEndings=0,t=e.alternateEndings}if(0===this._repeatStack.length||0===t)this.shouldPlay=!0;else{let e=this._repeatStack[this._repeatStack.length-1],s=e.iterations[e.closingIndex];this._previousAlternateEndings=t,this.shouldPlay=!!(t&1<<s)}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=e.calculateDuration())}moveNext(){this._moveNextWithDirections()||this._moveNextWithNormalRepeats()}_resetRepeats(){this._groupsOnStack.clear(),this._previousAlternateEndings=0,this._repeatStack=[]}_handleDaCapo(e,t,s){return!!e.has(t)&&(this.index=0,this._state=s,this._resetRepeats(),!0)}_handleDalSegno(e,t,s,i){if(e.has(t)){let e=this._findJumpTarget(i,this.index,!0);return-1!==e&&(this.index=e,this._state=s,this._resetRepeats(),!0)}return!1}_handleDaCoda(e,t,s){if(e.has(t)){let e=this._findJumpTarget(s,this.index,!1);return-1===e?(this.index++,!0):(this.index=e,this._state=0,!0)}return!1}_moveNextWithDirections(){let e=this._score.masterBars[this.index],t=null!==e.directions&&e.directions.size>0;if(0===this._state&&!t)return!1;if(!t)return this.index++,!0;switch(this._state){case 0:return!!(this._handleDaCapo(e.directions,5,1)||this._handleDaCapo(e.directions,6,2)||this._handleDaCapo(e.directions,7,3)||this._handleDaCapo(e.directions,8,4)||this._handleDalSegno(e.directions,9,1,1)||this._handleDalSegno(e.directions,10,2,1)||this._handleDalSegno(e.directions,11,3,1)||this._handleDalSegno(e.directions,12,4,1)||this._handleDalSegno(e.directions,13,1,2)||this._handleDalSegno(e.directions,14,2,2)||this._handleDalSegno(e.directions,15,3,2)||this._handleDalSegno(e.directions,16,4,2));case 1:return this.index++,!0;case 2:return this._handleDaCoda(e.directions,17,3)||this.index++,!0;case 3:return this._handleDaCoda(e.directions,18,4)||this.index++,!0;case 4:return e.directions.has(0)?(this.index=this._score.masterBars.length,!0):(this.index++,!0)}return!0}_findJumpTarget(e,t,s){let i;return s?(i=this._findJumpTargetBackwards(e,t),-1===i&&(i=this._findJumpTargetForwards(e,t)),i):(i=this._findJumpTargetForwards(e,t),-1===i&&(i=this._findJumpTargetBackwards(e,t)),i)}_findJumpTargetForwards(e,t){let s=t;for(;s<this._score.masterBars.length;){let t=this._score.masterBars[s].directions;if(t&&t.has(e))return s;s++}return-1}_findJumpTargetBackwards(e,t){let s=t;for(;s>=0;){let t=this._score.masterBars[s].directions;if(t&&t.has(e))return s;s--}return-1}_moveNextWithNormalRepeats(){let e=this._score.masterBars[this.index].repeatCount-1;if(this._repeatStack.length>0&&e>0){let t=this._repeatStack[this._repeatStack.length-1];if(t.iterations[t.closingIndex]<e){this.index=t.opening.index,t.iterations[t.closingIndex]++;for(let e=0;e<t.closingIndex;e++)t.iterations[e]=0;t.closingIndex=0,this._previousAlternateEndings=0}else t.closingIndex<t.group.closings.length-1?(t.closingIndex++,this.index++):(this._repeatStack.pop(),this._groupsOnStack.delete(t.group),this.index++)}else this.index++}},Bo=class{constructor(e,t){this.beat=e,this.playbackStart=t}},xo=class{constructor(e,t){this._highlightedBeats=new Map,this.highlightedBeats=[],this.nextBeat=null,this.previousBeat=null,this.start=e,this.end=t}get duration(){return this.end-this.start}highlightBeat(e,t){e.isEmpty&&!e.voice.isEmpty||this._highlightedBeats.has(e.id)||(this._highlightedBeats.set(e.id,!0),this.highlightedBeats.push(new Bo(e,t)))}getVisibleBeatAtStart(e){for(let t of this.highlightedBeats)if(t.playbackStart===this.start&&e.has(t.beat.voice.bar.staff.track.index))return t.beat;return null}},vo=class{constructor(e,t){this.tick=e,this.tempo=t}},Po=class{constructor(){this.start=0,this.end=0,this.tempoChanges=[],this.firstBeat=null,this.lastBeat=null,this.nextMasterBar=null,this.previousMasterBar=null}get tempo(){return this.tempoChanges[0].tempo}_insertAfter(e,t){null==this.firstBeat||null==e||null==this.lastBeat?(this.firstBeat=t,this.lastBeat=t):(t.nextBeat=e.nextBeat,t.previousBeat=e,e.nextBeat&&(e.nextBeat.previousBeat=t),e.nextBeat=t,e===this.lastBeat&&(this.lastBeat=t))}_insertBefore(e,t){null==this.firstBeat||null==e||null==this.lastBeat?(this.firstBeat=t,this.lastBeat=t):(t.previousBeat=e.previousBeat,t.nextBeat=e,e.previousBeat&&(e.previousBeat.nextBeat=t),e.previousBeat=t,e===this.firstBeat&&(this.firstBeat=t))}addBeat(e,t,s,i){let a=s+i;if(null==this.firstBeat){let i=new xo(s,a);i.highlightBeat(e,t),this._insertAfter(this.firstBeat,i)}else if(s>=this.lastBeat.end){let s=new xo(this.lastBeat.end,a);s.highlightBeat(e,t),this._insertAfter(this.lastBeat,s)}else{let i=null;if(s<this.firstBeat.start)i=this.firstBeat;else{let e=this.firstBeat;for(;null!=e;){if(s>=e.start&&s<e.end){i=e;break}e=e.nextBeat}if(null===i)throw new u(0,"Error on building lookup, unknown variant")}if(s<i.start)if(a===i.start){let a=new xo(s,i.start);a.highlightBeat(e,t),this._insertBefore(this.firstBeat,a)}else if(a<i.end){let r=new xo(s,i.start);r.highlightBeat(e,t),this._insertBefore(i,r);let n=new xo(i.start,a);for(let e of i.highlightedBeats)n.highlightBeat(e.beat,e.playbackStart);n.highlightBeat(e,t),this._insertBefore(i,n),i.start=a}else if(a===i.end){let a=new xo(s,i.start);a.highlightBeat(e,t),i.highlightBeat(e,t),this._insertBefore(i,a)}else{let r=new xo(s,i.start);r.highlightBeat(e,t),i.highlightBeat(e,t),this._insertBefore(i,r),this.addBeat(e,t,i.end,a-i.end)}else if(s>i.start)if(a===i.end){let a=new xo(i.start,s);for(let e of i.highlightedBeats)a.highlightBeat(e.beat,e.playbackStart);i.start=s,i.highlightBeat(e,t),this._insertBefore(i,a)}else if(a<i.end){let r=new xo(i.start,s);this._insertBefore(i,r);let n=new xo(s,a);this._insertBefore(i,n);for(let e of i.highlightedBeats)r.highlightBeat(e.beat,e.playbackStart),n.highlightBeat(e.beat,e.playbackStart);n.highlightBeat(e,t),i.start=a}else{let r=new xo(i.start,s);for(let e of i.highlightedBeats)r.highlightBeat(e.beat,e.playbackStart);i.start=s,i.highlightBeat(e,t),this._insertBefore(i,r),this.addBeat(e,t,i.end,a-i.end)}else if(a===i.end)i.highlightBeat(e,t);else if(a<i.end){let s=new xo(i.start,a);for(let e of i.highlightedBeats)s.highlightBeat(e.beat,e.playbackStart);s.highlightBeat(e,t),i.start=a,this._insertBefore(i,s)}else i.highlightBeat(e,t),this.addBeat(e,t,i.end,a-i.end)}}},No=(e=>(e[e.Unknown=0]="Unknown",e[e.ToNextBext=1]="ToNextBext",e[e.ToEndOfBar=2]="ToEndOfBar",e))(No||{}),Mo=class{constructor(e){this.nextBeat=null,this.tickDuration=0,this.duration=0,this.cursorMode=0,this.masterBar=e}get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=_.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let e=0,t=this.start,s=this.masterBar.tempoChanges[0].tempo,i=this.end;for(let a of this.masterBar.tempoChanges)if(a.tick<t)s=a.tempo;else{if(a.tick>i)break;e+=_.ticksToMillis(a.tick-t,s),s=a.tempo,t=a.tick}i>t&&(e+=_.ticksToMillis(i-t,s)),this.duration=e}}},Eo=class{constructor(){this._currentMasterBar=null,this.masterBarLookup=new Map,this.masterBars=[],this.multiBarRestInfo=null}findBeat(e,t,s=null){let i=null;return s&&(i=this._findBeatFast(e,s,t)),i||(i=this._findBeatSlow(e,s,t,!1)),i}_findBeatFast(e,t,s){if(s>=t.start&&s<t.end)return t;if(t.nextBeat&&s>=t.nextBeat.start&&s<t.nextBeat.end){let s=t.nextBeat;return this._fillNextBeat(s,e),s}return null}_fillNextBeatMultiBarRest(e,t){let s=this.multiBarRestInfo.get(e.masterBar.masterBar.index),i=e.masterBar;for(let e=0;e<s.length&&i;e++)i=i.nextMasterBar;i?i.nextMasterBar?(e.nextBeat=this._firstBeatInMasterBar(t,i.nextMasterBar,i.nextMasterBar.start,!0),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=1,e.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==i.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=2)):(e.tickDuration=i.nextMasterBar.end-e.start,e.cursorMode=2)):(e.tickDuration=i.end-e.start,e.cursorMode=2):(re.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),e.tickDuration=(e.masterBar.end-e.masterBar.start)*(s.length+1),e.cursorMode=2),e.calculateDuration()}_fillNextBeat(e,t){this._isMultiBarRestResult(e)?this._fillNextBeatMultiBarRest(e,t):this._fillNextBeatDefault(e,t)}_fillNextBeatDefault(e,t){e.nextBeat=this._findBeatInMasterBar(e.masterBar,e.beatLookup.nextBeat,e.end,t,!0),null==e.nextBeat&&(e.nextBeat=this._findBeatSlow(t,e,e.end,!0)),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=1,e.calculateDuration()):(e.tickDuration=e.masterBar.end-e.start,e.cursorMode=2,e.calculateDuration()),e.nextBeat&&e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=2)}_isMultiBarRestResult(e){return this._internalIsMultiBarRestResult(e.masterBar.masterBar.index,e.beat)}_internalIsMultiBarRestResult(e,t){return this.multiBarRestInfo&&this.multiBarRestInfo.has(e)&&t.isRest&&t.voice.bar.isRestOnly}_findBeatSlow(e,t,s,i){let a=null;return null!=t&&(t.masterBar.start<=s&&t.masterBar.end>s?a=t.masterBar:t.masterBar.nextMasterBar&&t.masterBar.nextMasterBar.start<=s&&t.masterBar.nextMasterBar.end>s&&(a=t.masterBar.nextMasterBar)),a||(a=this._findMasterBar(s)),a?this._firstBeatInMasterBar(e,a,s,i):null}_firstBeatInMasterBar(e,t,s,i){let a=t;for(;a;){if(a.firstBeat){let t=this._findBeatInMasterBar(a,a.firstBeat,s,e,i);if(t)return t}a=a.nextMasterBar}return null}_findBeatInMasterBar(e,t,s,i,a){if(!t)return null;let r=null,n=null,o=s-e.start;for(;null!=t&&null==n;){if((t.start<=o||a&&o<0)&&o<t.end){if(r=t,n=t.getVisibleBeatAtStart(i),!n)if(a){let s=e;for(;null!=s&&null==n;){for(;null!=t;){if(n=t.getVisibleBeatAtStart(i),n){r=t,e=s;break}t=t.nextBeat}(!n||!r)&&(s=s.nextMasterBar,t=s?.firstBeat??null)}}else{let s=e;for(;null!=s&&null==n;){for(;null!=t;){if(n=t.getVisibleBeatAtStart(i),n){r=t,e=s;break}t=t.previousBeat}(!n||!r)&&(s=s.previousMasterBar,t=s?.firstBeat??null)}}}else if(t.end>o)break;t=t?.nextBeat??null}return null==n?null:this._createResult(e,r,n,a,i)}_createResult(e,t,s,i,a){let r=new Mo(e);if(r.beat=s,r.beatLookup=t,r.tickDuration=t.end-t.start,i){if(this._isMultiBarRestResult(r)){let s=this.multiBarRestInfo.get(e.masterBar.index),i=e;for(let e=0;e<s.length&&i;e++)i=i.nextMasterBar;i?i.nextMasterBar?r.tickDuration=i.nextMasterBar.start-t.start:r.tickDuration=i.end-t.start:re.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this._fillNextBeat(r,a);return r.calculateDuration(),r}_findMasterBar(e){let t=this.masterBars,s=0,i=t.length-1;for(;s<=i;){let a=(i+s)/2|0,r=t[a];if(e>=r.start&&e<r.end)return r;e<r.start?i=a-1:s=a+1}return null}getMasterBar(e){if(!this.masterBarLookup.has(e.index)){let t=new Po;return t.masterBar=e,t}return this.masterBarLookup.get(e.index)}getMasterBarStart(e){return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index).start:0}getBeatStart(e){return this.masterBarLookup.has(e.voice.bar.index)?this.masterBarLookup.get(e.voice.bar.index).start+e.playbackStart:0}addMasterBar(e){this.masterBars.push(e),this._currentMasterBar&&(e.previousMasterBar=this._currentMasterBar,this._currentMasterBar.nextMasterBar=e),this._currentMasterBar=e,this.masterBarLookup.has(e.masterBar.index)||this.masterBarLookup.set(e.masterBar.index,e)}addBeat(e,t,s){let i=this._currentMasterBar;if(i)if(t<0&&i.previousMasterBar){let a=i.previousMasterBar.end-i.previousMasterBar.start,r=a+t,n=r+s;if(i.previousMasterBar.addBeat(e,r,r,s),n>a){let a=s+t;i.addBeat(e,t,0,a)}}else i.addBeat(e,t,t,s)}},Lo=class{constructor(){this.noteOnly=0,this.untilTieOrSlideEnd=0,this.letRingEnd=0}},Co=class{constructor(){this.firstBeatDuration=0,this.secondBeatStartOffset=0,this.secondBeatDuration=0}},Fo=class{constructor(){this.durations=[],this.brushInfos=[]}},Do=class{constructor(){this.synthTick=0,this.synthTime=0,this.currentTempo=0,this.automationToSyncPoint=new Map,this.createNewSyncPoints=!1}},Io=class e{constructor(e,t,s){this._programsPerChannel=new Map,this._currentTime=0,this._calculatedBeatTimers=new Set,this.tickLookup=new Eo,this.applyTranspositionPitches=!0,this.syncPoints=[],this.transpositionPitches=new Map,this._currentTripletFeel=null,this.vibratoResolution=16,this._score=e,this._settings=t||new On,this._handler=s}generate(){this.transpositionPitches.clear(),this._calculatedBeatTimers.clear(),this._currentTime=0;for(let e of this._score.tracks)this._generateTrack(e);re.debug("Midi","Begin midi generation"),this.syncPoints=[],e._playThroughSong(this._score,this.syncPoints,!1,(e,t,s,i,a)=>{this._generateMasterBar(e,t,s,i,a)},(e,t,s)=>{for(let i of this._score.tracks)for(let a of i.staves)e<a.bars.length&&this._generateBar(a.bars[e],t,s)},e=>{for(let t of this._score.tracks)this._handler.finishTrack(t.index,e)}),re.debug("Midi","Midi generation done")}_generateTrack(e){this._generateChannel(e,e.playbackInfo.primaryChannel,e.playbackInfo),e.playbackInfo.primaryChannel!==e.playbackInfo.secondaryChannel&&this._generateChannel(e,e.playbackInfo.secondaryChannel,e.playbackInfo)}_addProgramChange(e,t,s,i){(!this._programsPerChannel.has(s)||this._programsPerChannel.get(s)!==i)&&(this._handler.addProgramChange(e.index,t,s,i),this._programsPerChannel.set(s,i))}_addBankChange(e,t,s,i){let a=Ut.bankToLsbMsb(i);this._handler.addControlChange(e.index,t,s,0,a[1]),this._handler.addControlChange(e.index,t,s,32,a[0])}static buildTranspositionPitches(e,t){let s=new Map;for(let i of e.tracks){let e=i.index<t.notation.transpositionPitches.length?t.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,e),s.set(i.playbackInfo.secondaryChannel,e)}return s}_generateChannel(t,s,i){let a=t.index<this._settings.notation.transpositionPitches.length?this._settings.notation.transpositionPitches[t.index]:-t.staves[0].transpositionPitch;this.transpositionPitches.set(s,a);let r=e._toChannelShort(i.volume),n=e._toChannelShort(i.balance);this._handler.addControlChange(t.index,0,s,7,r),this._handler.addControlChange(t.index,0,s,10,n),this._handler.addControlChange(t.index,0,s,11,127),this._handler.addControlChange(t.index,0,s,100,0),this._handler.addControlChange(t.index,0,s,101,0),this._handler.addControlChange(t.index,0,s,38,0),this._handler.addControlChange(t.index,0,s,6,e._pitchBendRangeInSemitones),this._addBankChange(t,0,s,i.bank),this._addProgramChange(t,0,s,i.program)}static generateSyncPoints(t,s=!1){let i=[];return e._playThroughSong(t,i,s,(e,t,s,i,a)=>{},(e,t,s)=>{},e=>{}),i}static buildModifiedTempoLookup(t){return e._playThroughSong(t,[],!1,(e,t,s,i,a)=>{},(e,t,s)=>{},e=>{}).automationToSyncPoint}static _playThroughSong(t,s,i,a,r,n){let o=new To(t),l=new Do;l.currentTempo=t.tempo,l.syncPoints=s,l.createNewSyncPoints=i;let h=null,d=new Map;for(;!o.finished;){let s=o.index,i=t.masterBars[s],n=o.currentTick;if(o.processCurrent(),o.shouldPlay){let t=d.has(s)?d.get(s):-1;t++,d.set(s,t),a(i,h,n,l.currentTempo,t),r(s,n,i.tempoAutomations.length>0?i.tempoAutomations[0].value:l.currentTempo),l.synthTick=n,e._processBarTime(i,t,l)}o.moveNext(),h=i}if(s.length>0){let e=s[s.length-1],t=o.currentTick-e.synthTick;if(t>0){let i=new xa;i.masterBarIndex=h.index,i.masterBarOccurence=d.get(h.index)-1,i.synthTick=o.currentTick,i.synthBpm=l.currentTempo,l.createNewSyncPoints?(i.syncBpm=e.synthBpm,i.synthBpm=e.synthBpm):1===s.length?i.syncBpm=e.synthBpm:i.syncBpm=s[s.length-2].syncBpm,i.synthTime=e.synthTime+_.ticksToMillis(t,e.synthBpm),i.syncTime=e.syncTime+_.ticksToMillis(t,i.syncBpm),l.createNewSyncPoints||e.updateSyncBpm(i.synthTime,i.syncTime),s.push(i)}}return n(o.currentTick),l}static _processBarTime(t,s,i){let a=t.calculateDuration(),r=t.syncPoints,n=i.synthTick;i.createNewSyncPoints?e._processBarTimeWithNewSyncPoints(t,s,i):r?e._processBarTimeWithSyncPoints(t,s,i):e._processBarTimeNoSyncPoints(t,i);let o=n+a,l=o-i.synthTick;l>0&&(i.synthTime+=_.ticksToMillis(l,i.currentTempo),i.synthTick=o)}static _processBarTimeWithNewSyncPoints(e,t,s){let i=s.synthTick;if(0===e.index&&0===t){s.currentTempo=e.score.tempo;let a=new xa;a.masterBarIndex=e.index,a.masterBarOccurence=t,a.synthTick=i,a.synthBpm=s.currentTempo,a.synthTime=s.synthTime,a.syncBpm=s.currentTempo,a.syncTime=s.synthTime,s.syncPoints.push(a)}let a=e.calculateDuration();for(let r of e.tempoAutomations){let n=i+r.ratioPosition*a,o=n-s.synthTick;if(o>0&&(s.synthTick=n,s.synthTime+=_.ticksToMillis(o,s.currentTempo)),r.value!==s.currentTempo){s.currentTempo=r.value;let i=new xa;i.masterBarIndex=e.index,i.masterBarOccurence=t,i.synthTick=n,i.synthBpm=s.currentTempo,i.synthTime=s.synthTime,i.syncBpm=s.currentTempo,i.syncTime=s.synthTime,s.syncPoints.push(i)}}}static _processBarTimeWithSyncPoints(e,t,s){let i,a=s.synthTick,r=e.calculateDuration(),n=0;for(let o of e.syncPoints){if(o.syncPointValue.barOccurence!==t)continue;let l=a+o.ratioPosition*r;for(;n<e.tempoAutomations.length&&e.tempoAutomations[n].ratioPosition<=o.ratioPosition;){let t=e.tempoAutomations[n],o=a+t.ratioPosition*r;i=o-s.synthTick,i>0&&(s.synthTick=o,s.synthTime+=_.ticksToMillis(i,s.currentTempo)),s.currentTempo=t.value,n++}i=l-s.synthTick,i>0&&(s.synthTick=l,s.synthTime+=_.ticksToMillis(i,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,o.syncPointValue.millisecondOffset);let h=new xa;h.masterBarIndex=e.index,h.masterBarOccurence=t,h.synthTick=l,h.synthBpm=s.currentTempo,h.synthTime=s.synthTime,h.syncTime=o.syncPointValue.millisecondOffset,h.syncBpm=0,s.syncPoints.push(h),s.automationToSyncPoint.set(o,h)}for(;n<e.tempoAutomations.length;){let t=e.tempoAutomations[n],o=a+t.ratioPosition*r;i=o-s.synthTick,i>0&&(s.synthTick=o,s.synthTime+=_.ticksToMillis(i,s.currentTempo)),s.currentTempo=t.value,n++}}static _processBarTimeNoSyncPoints(e,t){let s=t.synthTick,i=e.calculateDuration();for(let a of e.tempoAutomations){let e=s+a.ratioPosition*i,r=e-t.synthTick;r>0&&(t.synthTick=e,t.synthTime+=_.ticksToMillis(r,t.currentTempo)),t.currentTempo=a.value}}static _toChannelShort(e){let t=Math.max(-32768,Math.min(32767,8*e-1));return Math.max(t,-1)+1}_generateMasterBar(e,t,s,i,a){(!t||t.timeSignatureDenominator!==e.timeSignatureDenominator||t.timeSignatureNumerator!==e.timeSignatureNumerator)&&this._handler.addTimeSignature(s,e.timeSignatureNumerator,e.timeSignatureDenominator);let r=e.calculateDuration(),n=new Po;if(e.tempoAutomations.length>0){e.tempoAutomations[0].ratioPosition>0&&n.tempoChanges.push(new vo(s,i));for(let t of e.tempoAutomations){let e=s+r*t.ratioPosition;this._handler.addTempo(e,t.value),n.tempoChanges.push(new vo(e,t.value))}}else t?n.tempoChanges.push(new vo(s,i)):(this._handler.addTempo(s,e.score.tempo),n.tempoChanges.push(new vo(s,e.score.tempo)));n.masterBar=e,n.start=s,n.end=n.start+r,this.tickLookup.addMasterBar(n)}_generateBar(e,t,s){let i=this._getPlaybackBar(e),a=this._currentTime;for(let r of i.voices)this._currentTime=a,this._generateVoice(r,t,e,s);let r=i.masterBar,n=r.calculateDuration(),o=r.tempoAutomations.slice();if(0===o.length)this._currentTime=a+_.ticksToMillis(n,s);else{this._currentTime=a;let e=t,i=s,r=t+n;for(let t of o){let s=n*t.ratioPosition-e;s>0&&(this._currentTime+=_.ticksToMillis(s,i)),i=t.value,e+=s}let l=r-e;l>0&&(this._currentTime+=_.ticksToMillis(l,i))}i.id!==e.id&&this.tickLookup.addBeat(e.voices[0].beats[0],0,n)}_getPlaybackBar(e){switch(e.simileMark){case 1:e.previousBar&&(e=this._getPlaybackBar(e.previousBar));break;case 2:case 3:e.previousBar&&e.previousBar.previousBar&&(e=this._getPlaybackBar(e.previousBar.previousBar))}return e}_generateVoice(e,t,s,i){if(e.isEmpty&&(!e.bar.isEmpty||0!==e.index))return;let a=s.masterBar.tempoAutomations.slice(),r=i,n=s.masterBar.calculateDuration();for(let i of e.beats){let e=i.playbackStart/n;for(;a.length>0&&a[0].ratioPosition<=e;)r=a.shift().value;this._generateBeat(i,t,s,r)}}_generateBeat(t,s,i,a){let r=t.playbackStart,n=t.playbackDuration,o=t.voice.bar.masterBar.calculateDuration();t.voice.bar.isEmpty?n=o:0!==t.voice.bar.masterBar.tripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(r-=this._currentTripletFeel.secondBeatStartOffset,n=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=e._calculateTripletFeelInfo(r,n,t),this._currentTripletFeel&&(n=this._currentTripletFeel.firstBeatDuration))),t.showTimer&&!this._calculatedBeatTimers.has(t.id)&&(t.timer=this._currentTime,this._calculatedBeatTimers.add(t.id)),this._currentTime+=_.ticksToMillis(n,a),i===t.voice.bar&&this.tickLookup.addBeat(t,r,n);let l=t.voice.bar.staff.track;for(let e of t.automations)this._generateNonTempoAutomation(t,e,s);if(t.isRest)this._handler.addRest(l.index,s+r,l.playbackInfo.primaryChannel);else if(t.deadSlapped)this._generateDeadSlap(t,s+r);else{let e=this._getBrushInfo(t),i=this._getRasgueadoInfo(t,n);for(let o of t.notes)this._generateNote(o,s+r,n,a,e,i)}if(0!==t.fade&&this._generateFade(t,s+r,n),0!==t.vibrato){let e=240,i=3;switch(t.vibrato){case 1:e=this._settings.player.vibrato.beatSlightLength,i=this._settings.player.vibrato.beatSlightAmplitude;break;case 2:e=this._settings.player.vibrato.beatWideLength,i=this._settings.player.vibrato.beatWideAmplitude}this._generateVibratorWithParams(s+r,t.playbackDuration,e,0,i,(e,s)=>{this._handler.addBend(t.voice.bar.staff.track.index,e,l.playbackInfo.secondaryChannel,s)})}}static _calculateTripletFeelInfo(e,t,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case 2:case 4:case 6:i=8;break;case 1:case 3:case 5:i=16;break;default:return null}let a=_.toTicks(i);if(t!==a||e%a!==0||!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==a)return null;let r=new Co;switch(s.voice.bar.masterBar.tripletFeel){case 2:r.firstBeatDuration=_.applyTuplet(_.toTicks(4),3,2),r.secondBeatDuration=_.applyTuplet(_.toTicks(8),3,2);break;case 4:r.firstBeatDuration=_.applyDot(_.toTicks(8),!1),r.secondBeatDuration=_.toTicks(16);break;case 6:r.firstBeatDuration=_.toTicks(16),r.secondBeatDuration=_.applyDot(_.toTicks(8),!1);break;case 1:r.firstBeatDuration=_.applyTuplet(_.toTicks(8),3,2),r.secondBeatDuration=_.applyTuplet(_.toTicks(16),3,2);break;case 3:r.firstBeatDuration=_.applyDot(_.toTicks(16),!1),r.secondBeatDuration=_.toTicks(32);break;case 5:r.firstBeatDuration=_.toTicks(32),r.secondBeatDuration=_.applyDot(_.toTicks(16),!1)}return r.secondBeatStartOffset=t-r.firstBeatDuration,r}_generateDeadSlap(e,t){let s=_.toTicks(64),i=e.voice.bar.staff;if(i.tuning.length>0)for(let e of i.tuning)this._handler.addNote(i.track.index,t,s,e,_.dynamicToVelocity(5),i.track.playbackInfo.primaryChannel)}_needsSecondaryChannel(e){return e.hasBend||e.beat.hasWhammyBar||0!==e.beat.vibrato}_determineChannel(e,t){if(this._needsSecondaryChannel(t))return e.playbackInfo.secondaryChannel;let s=t;for(;s.isTieDestination;)if(s=s.tieOrigin,this._needsSecondaryChannel(s))return e.playbackInfo.secondaryChannel;for(s=t;s.isTieOrigin;)if(s=s.tieDestination,this._needsSecondaryChannel(s))return e.playbackInfo.secondaryChannel;return e.playbackInfo.primaryChannel}_generateNote(t,s,i,a,r,n){let o=t.beat.voice.bar.staff.track,l=t.beat.voice.bar.staff,h=t.calculateRealValue(this.applyTranspositionPitches,!0);if(t.isPercussion){let e=et.getArticulation(t);e&&(h=e.outputMidiNumber)}t.isDead&&(h=127);let d=null==n&&t.isStringed&&t.string<=r.length?r[t.string-1]:0,c=s+d,u=this._getNoteDuration(t,i,a);u.untilTieOrSlideEnd-=d,u.noteOnly-=d,u.letRingEnd-=d;let p=e._getNoteVelocity(t),m=this._determineChannel(o,t),g=0,f=Math.max(u.untilTieOrSlideEnd,u.letRingEnd);g=t.hasBend?e.getPitchWheel(t.bendPoints[0].value):t.beat.hasWhammyBar?e.getPitchWheel(t.beat.whammyBarPoints[0].value):t.isTieDestination||t.slideOrigin&&2===t.slideOrigin.slideOutType?-1:e.getPitchWheel(0),g>=0&&this._handler.addNoteBend(o.index,c,m,h,g),t.beat.hasRasgueado?this._generateRasgueado(o,t,c,h,p,m,n):0===t.ornament?!t.isTrill||l.isPercussion?t.beat.isTremolo?this._generateTremoloPicking(t,c,u,h,p,m):(t.hasBend?this._generateBend(t,c,u,h,m,a):t.beat.hasWhammyBar&&0===t.index?this._generateWhammy(t.beat,c,u,m,a):0!==t.slideInType||0!==t.slideOutType?this._generateSlide(t,c,u,h,m,a):(0!==t.vibrato||t.isTieDestination&&0!==t.tieOrigin.vibrato)&&this._generateVibrato(t,c,u,h,m),!t.isTieDestination&&(!t.slideOrigin||2!==t.slideOrigin.slideOutType)&&this._handler.addNote(o.index,c,f,h,p,m)):this._generateTrill(t,c,u,h,p,m):this._generateOrnament(o,t,c,f,h,p,m)}_generateOrnament(t,s,i,a,r,n,o){let l,h,d=r%12,c=1/3;switch(s.ornament){case 2:l=[r+e._ornamentKeysUp[d],r,r+e.ornamentKeysDown[d]],h=[_.toTicks(16)*c,_.toTicks(16)*c,_.toTicks(16)*c];break;case 1:l=[r+e.ornamentKeysDown[d],r,r+e._ornamentKeysUp[d]],h=[_.toTicks(16)*c,_.toTicks(16)*c,_.toTicks(16)*c];break;case 3:l=[r,r+e._ornamentKeysUp[d]],h=[_.toTicks(32),_.toTicks(32)];break;case 4:l=[r,r+e.ornamentKeysDown[d]],h=[_.toTicks(32),_.toTicks(32)];break;default:return}let u=1;a<_.QuarterTime&&(u=a/_.QuarterTime),n-=_.VelocityIncrement;let p=0;for(let e=0;e<l.length;e++){let s=h[e]*u;this._handler.addNote(t.index,i,s,l[e],n,o),i+=s,p+=s}let m=a-p;this._handler.addNote(t.index,i,m,r,n,o)}_getNoteDuration(t,s,i){let a=new Lo;if(a.noteOnly=s,a.untilTieOrSlideEnd=s,a.letRingEnd=s,t.isDead)return a.noteOnly=this._applyStaticDuration(e._defaultDurationDead,s,i),a.untilTieOrSlideEnd=a.noteOnly,a.letRingEnd=a.noteOnly,a;if(t.isPalmMute)return a.noteOnly=this._applyStaticDuration(e._defaultDurationPalmMute,s,i),a.untilTieOrSlideEnd=a.noteOnly,a.letRingEnd=a.noteOnly,a;if(t.isStaccato)return a.noteOnly=s/2|0,a.untilTieOrSlideEnd=a.noteOnly,a.letRingEnd=a.noteOnly,a;if(t.isTieOrigin){let e=t.tieDestination;if(e)if(t.isTieDestination){let t=this._getNoteDuration(e,e.beat.playbackDuration,i);a.untilTieOrSlideEnd=s+t.untilTieOrSlideEnd}else{let s=t.beat.absolutePlaybackStart,r=this._getNoteDuration(e,e.beat.playbackDuration,i),n=e.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;a.untilTieOrSlideEnd=n-s}}else if(2===t.slideOutType){let e=t.slideTarget;if(e){let s=t.beat.absolutePlaybackStart,r=this._getNoteDuration(e,e.beat.playbackDuration,i),n=e.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;a.untilTieOrSlideEnd=n-s}}if(t.isLetRing&&0===this._settings.notation.notationMode){let e=t.beat,i=0,r=t.beat.voice.bar.masterBar.calculateDuration();for(;e.nextBeat;){let s=e.nextBeat;if(s.isRest||t.isStringed&&s.hasNoteOnString(t.string))break;if(e=e.nextBeat,i=e.absolutePlaybackStart-t.beat.absolutePlaybackStart+e.playbackDuration,i>r){i=r;break}}e===t.beat?a.letRingEnd=s:a.letRingEnd=i}else a.letRingEnd=a.untilTieOrSlideEnd;return a}_applyStaticDuration(e,t,s){let i=s*e/T.MaxPosition|0;return Math.min(i,t)}static _getNoteVelocity(e){let t=0;switch(!e.beat.voice.bar.staff.isPercussion&&e.hammerPullOrigin&&t--,e.isGhost&&t--,e.accentuated){case 1:t++;break;case 2:t+=2}return _.dynamicToVelocity(e.dynamics,t)}_generateFade(t,s,i){let a=t.voice.bar.staff.track;switch(t.fade){case 1:this._generateFadeSteps(a,s,i,0,e._toChannelShort(a.playbackInfo.volume));break;case 2:this._generateFadeSteps(a,s,i,e._toChannelShort(a.playbackInfo.volume),0);break;case 3:let t=i/2|0;this._generateFadeSteps(a,s,t,0,e._toChannelShort(a.playbackInfo.volume)),this._generateFadeSteps(a,s+t,t,e._toChannelShort(a.playbackInfo.volume),0)}}_generateFadeSteps(e,t,s,i,a){let r=(a-i)/(s=.8*s|0),n=s/120+1|0,o=t+s;for(let s=0;s<n;s++){let l=s===n-1,h=l?o:t+120*s,d=l?a:Math.round(i+(h-t)*r);this._handler.addControlChange(e.index,h,e.playbackInfo.primaryChannel,7,d),this._handler.addControlChange(e.index,h,e.playbackInfo.secondaryChannel,7,d)}}_generateVibrato(e,t,s,i,a){let r=0,n=0;switch(0!==e.vibrato?e.vibrato:e.isTieDestination?e.tieOrigin.vibrato:1){case 1:r=this._settings.player.vibrato.noteSlightLength,n=this._settings.player.vibrato.noteSlightAmplitude;break;case 2:r=this._settings.player.vibrato.noteWideLength,n=this._settings.player.vibrato.noteWideAmplitude;break;default:return}let o=e.beat.voice.bar.staff.track,l=0;if(e.isTieDestination&&e.tieOrigin.hasBend){let t=e.tieOrigin.bendPoints;l=t[t.length-1].value}this._generateVibratorWithParams(t,s.noteOnly,r,l,n,(e,t)=>{this._handler.addNoteBend(o.index,e,a,i,t)})}_generateVibratorWithParams(t,s,i,a,r,n){let o=this.vibratoResolution,l=i/2|0,h=t+s;for(;t<h;){let s=0,d=t+i<h?i:h-t;for(;s<d;){let i=a+r*Math.sin(s*Math.PI/l);n(t+s|0,e.getPitchWheel(i)),s+=o}t+=i}n(0|h,e.getPitchWheel(a))}static getPitchWheel(t){return ze.DefaultPitchWheel+t/2*e._pitchValuePerSemitone}_generateSlide(e,t,s,i,a,r){let n=2===e.slideOutType?s.noteOnly:s.untilTieOrSlideEnd,o=[],l=e.beat.voice.bar.staff.track,h=this._settings.player.slide.simpleSlidePitchOffset,d=Math.floor(T.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),c=Math.floor(T.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(e.slideInType){case 2:o.push(new T(0,h)),o.push(new T(d,0));break;case 1:o.push(new T(0,-h)),o.push(new T(d,0))}switch(e.slideOutType){case 2:case 1:o.push(new T(c,0));let t=2*(e.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-e.calculateRealValue(this.applyTranspositionPitches,!0));o.push(new T(T.MaxPosition,t));break;case 4:o.push(new T(T.MaxPosition-d,0)),o.push(new T(T.MaxPosition,-h));break;case 3:o.push(new T(T.MaxPosition-d,0)),o.push(new T(T.MaxPosition,h))}this._generateWhammyOrBend(t,n,o,r,(e,t)=>{this._handler.addNoteBend(l.index,e,a,i,t)})}_generateBend(t,s,i,a,r,n){let o,l=t.bendPoints,h=t.beat.voice.bar.staff.track,d=(e,t)=>{this._handler.addNoteBend(h.index,e,r,a,t)},c=null;if(t.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let e=t;for(;e.isTieOrigin&&!e.tieDestination.hasBend&&0===e.tieDestination.vibrato;)e=e.tieDestination;o=e.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this._getNoteDuration(e,e.beat.playbackDuration,n).noteOnly}else if(t.isTieOrigin&&0!==t.beat.graceType){switch(t.tieDestination.bendType){case 2:case 4:case 7:c=t.tieDestination.bendPoints[1].value;break;case 6:case 8:c=t.tieDestination.bendPoints[0].value}o=Math.max(i.noteOnly,_.millisToTicks(this._settings.player.songBookBendDuration,n))}else o=i.noteOnly;l[0].value>0&&!t.isContinuedBend&&s>0&&s--;let u=Math.min(o,_.millisToTicks(this._settings.player.songBookBendDuration,n)),p=[];switch(t.bendType){case 1:case 5:case 6:p=l;break;case 2:case 3:switch(t.bendStyle){case 0:p=l;break;case 1:p.push(new T(0,t.bendPoints[0].value)),(!c||c<t.bendPoints[1].value)&&(c=t.bendPoints[1].value),p.push(new T(T.MaxPosition,c));break;case 2:return(!c||c<t.bendPoints[1].value)&&(c=t.bendPoints[1].value),void(3===t.beat.graceType?this._generateSongBookWhammyOrBend(s,o,!0,[t.bendPoints[0].value,c],u,n,d):this._generateSongBookWhammyOrBend(s,o,!1,[t.bendPoints[0].value,c],u,n,d))}break;case 4:switch(t.bendStyle){case 0:p=l;break;case 1:p.push(new T(0,t.bendPoints[0].value)),p.push(new T(T.MaxPosition/2|0,t.bendPoints[1].value)),p.push(new T(T.MaxPosition,t.bendPoints[2].value));break;case 2:return void this._generateSongBookWhammyOrBend(s,o,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],u,n,d)}break;case 7:switch(t.bendStyle){case 0:p=l;break;case 1:p.push(new T(0,t.bendPoints[0].value)),p.push(new T(T.MaxPosition,t.bendPoints[1].value));break;case 2:return d(s,0|e.getPitchWheel(t.bendPoints[0].value)),(!c||c<t.bendPoints[1].value)&&(c=t.bendPoints[1].value),void this._generateSongBookWhammyOrBend(s,o,!1,[t.bendPoints[0].value,c],u,n,d)}break;case 8:switch(t.bendStyle){case 0:p=l;break;case 1:p.push(new T(0,t.bendPoints[0].value)),p.push(new T(T.MaxPosition,t.bendPoints[1].value));break;case 2:return d(s,0|e.getPitchWheel(t.bendPoints[0].value)),void this._generateSongBookWhammyOrBend(s,o,!1,[t.bendPoints[0].value,t.bendPoints[1].value],u,n,d)}}this._generateWhammyOrBend(s,o,p,n,d)}_generateSongBookWhammyOrBend(t,s,i,a,r,n,o){let l=i?t:t+s-r,h=r/(a.length-1);for(let t=0;t<a.length-1;t++){let s=e.getPitchWheel(a[t]),i=e.getPitchWheel(a[t+1]),r=l+h*t;this._generateBendValues(r,h,s,i,n,o)}}_generateWhammy(t,s,i,a,r){let n=t.whammyBarPoints,o=t.voice.bar.staff.track,l=i.noteOnly;n[0].value>0&&!t.isContinuedWhammy&&s--;let h=(e,t)=>{this._handler.addBend(o.index,e,a,t)},d=[];switch(t.whammyBarType){case 1:case 4:case 5:d=n;break;case 2:switch(t.whammyStyle){case 0:d=n;break;case 1:d.push(new T(0,n[0].value)),d.push(new T(T.MaxPosition,n[1].value));break;case 2:let e=Math.min(l,_.millisToTicks(this._settings.player.songBookBendDuration,r));return void this._generateSongBookWhammyOrBend(s,l,!1,[n[0].value,n[1].value],e,r,h)}break;case 3:switch(t.whammyStyle){case 0:d=n;break;case 1:d.push(new T(0,n[0].value)),d.push(new T(T.MaxPosition/2|0,n[1].value)),d.push(new T(T.MaxPosition,n[2].value));break;case 2:let e=Math.min(l,_.millisToTicks(this._settings.player.songBookDipDuration,r));return void this._generateSongBookWhammyOrBend(s,l,!0,[n[0].value,n[1].value,n[2].value],e,r,h)}break;case 6:switch(t.whammyStyle){case 0:d=n;break;case 1:d.push(new T(0,n[0].value)),d.push(new T(T.MaxPosition/2|0,n[0].value)),d.push(new T(T.MaxPosition,n[1].value));break;case 2:let t=e.getPitchWheel(n[0].value);this._handler.addBend(o.index,s,a,0|t);let i=Math.min(l,_.millisToTicks(this._settings.player.songBookBendDuration,r));return void this._generateSongBookWhammyOrBend(s,l,!1,[n[0].value,n[1].value],i,r,h)}}this._generateWhammyOrBend(s,l,d,r,h)}_generateWhammyOrBend(t,s,i,a,r){let n=s/T.MaxPosition;for(let s=0;s<i.length-1;s++){let o=i[s],l=i[s+1],h=e.getPitchWheel(o.value),d=e.getPitchWheel(l.value),c=n*(l.offset-o.offset),u=t+n*o.offset;this._generateBendValues(u,c,h,d,a,r)}}_generateBendValues(t,s,i,a,r,n){let o=_.ticksToMillis(s,r),l=Math.abs(a-i)/e._pitchValuePerSemitone,h=Math.max(e._minBreakpointsPerSemitone*l,o/e._millisecondsPerBreakpoint),d=s/h,c=(a-i)/h,u=t+s;for(let e=0;e<h;e++)n(0|t,Math.round(i)),i+=c,t+=d;n(0|u,a)}_generateRasgueado(e,t,s,i,a,r,n){let o=s;for(let s=0;s<n.durations.length;s++){let l=n.brushInfos[s],h=t.isStringed&&t.string<=l.length?l[t.string-1]:0,d=n.durations[s];this._handler.addNote(e.index,o+h,d-h,i,a,r),o+=d}}_generateTrill(e,t,s,i,a,r){let n=e.beat.voice.bar.staff.track,o=e.stringTuning+e.trillFret,l=_.toTicks(e.trillSpeed),h=!0,d=t,c=t+s.untilTieOrSlideEnd;for(;d+10<c;)d+l>=c&&(l=c-d),this._handler.addNote(n.index,d,l,h?o:i,a,r),h=!h,d+=l}_generateTremoloPicking(e,t,s,i,a,r){let n=e.beat.voice.bar.staff.track,o=_.toTicks(e.beat.tremoloSpeed),l=t,h=t+s.untilTieOrSlideEnd;for(;l+10<h;)l+o>=h&&(o=h-l),this._handler.addNote(n.index,l,o,i,a,r),l+=o}_getRasgueadoInfo(t,s){if(!t.hasRasgueado)return null;let i=new Fo,a=e._rasgueadoDurations.get(t.rasgueado).reduce((e,t)=>e+t,0);i.durations=e._rasgueadoDurations.get(t.rasgueado).map(e=>s*e/a),i.brushInfos=new Array(i.durations.length);let r=_.toTicks(16),n=0,o=0;for(let e of t.notes)e.isTieDestination||(n|=1<<e.string-1,o++);let l=e._rasgueadoDirections.get(t.rasgueado);for(let e=0;e<i.durations.length;e++){let s=i.durations[e]*r/_.QuarterTime,a=new Int32Array(t.voice.bar.staff.tuning.length);i.brushInfos[e]=a;let h=l[e];0!==h&&this._fillBrushInfo(t,a,4===h||2===h,n,o,s)}return i}_getBrushInfo(e){let t=new Int32Array(e.voice.bar.staff.tuning.length);if(e.brushType){let s=0,i=0;for(let t of e.notes)t.isTieDestination||(s|=1<<t.string-1,i++);this._fillBrushInfo(e,t,4===e.brushType||2===e.brushType,s,i,e.brushDuration)}return t}_fillBrushInfo(e,t,s,i,a,r){if(e.notes.length>0){let n=0,o=r/(a-1)|0;for(let a=0;a<e.voice.bar.staff.tuning.length;a++){let e=s?a:t.length-1-a;i&1<<e&&(t[e]=n,n+=o)}}return t}_generateNonTempoAutomation(t,s,i){switch(s.type){case 2:this._addProgramChange(t.voice.bar.staff.track,t.playbackStart+i,t.voice.bar.staff.track.playbackInfo.primaryChannel,255&s.value),this._addProgramChange(t.voice.bar.staff.track,t.playbackStart+i,t.voice.bar.staff.track.playbackInfo.secondaryChannel,255&s.value);break;case 4:this._addBankChange(t.voice.bar.staff.track,t.playbackStart+i,t.voice.bar.staff.track.playbackInfo.primaryChannel,s.value),this._addBankChange(t.voice.bar.staff.track,t.playbackStart+i,t.voice.bar.staff.track.playbackInfo.secondaryChannel,s.value);break;case 3:let a=e._toChannelShort(s.value);this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+i,t.voice.bar.staff.track.playbackInfo.primaryChannel,10,a),this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+i,t.voice.bar.staff.track.playbackInfo.secondaryChannel,10,a);break;case 1:let r=e._toChannelShort(s.value);this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+i,t.voice.bar.staff.track.playbackInfo.primaryChannel,7,r),this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+i,t.voice.bar.staff.track.playbackInfo.secondaryChannel,7,r)}}prepareSingleBeat(t){let s=-1,i=-1,a=t;for(;a&&(-1===s||-1===i);){for(let e of t.automations)switch(e.type){case 2:i=e.value;break;case 0:s=e.value}a=a.previousBeat}let r=t.voice.bar.staff.track,n=t.voice.bar.masterBar;-1===s&&(s=n.score.tempo);let o=t.playbackStart/n.calculateDuration();for(let e of n.tempoAutomations){if(!(e.ratioPosition<=o))break;s=e.value}-1===i&&(i=r.playbackInfo.program);let l=r.playbackInfo.volume;this._generateTrack(r),this._handler.addTimeSignature(0,n.timeSignatureNumerator,n.timeSignatureDenominator),this._handler.addTempo(0,s);let h=e._toChannelShort(l);return this._handler.addControlChange(0,0,r.playbackInfo.primaryChannel,7,h),this._handler.addControlChange(0,0,r.playbackInfo.secondaryChannel,7,h),s}generateSingleBeat(e){let t=this.prepareSingleBeat(e);this._generateBeat(e,-e.playbackStart,e.voice.bar,t)}generateSingleNote(e){let t=this.prepareSingleBeat(e.beat);this._generateNote(e,0,e.beat.playbackDuration,t,new Int32Array(e.beat.voice.bar.staff.tuning.length),null)}};Io._defaultDurationDead=30,Io._defaultDurationPalmMute=80,Io._ornamentKeysUp=[2,2,2,1,1,2,2,2,2,2,1,1],Io.ornamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],Io._pitchBendRangeInSemitones=16,Io._pitchValuePerSemitone=ze.DefaultPitchWheel/Io._pitchBendRangeInSemitones,Io._minBreakpointsPerSemitone=6,Io._millisecondsPerBreakpoint=150,Io._rasgueadoDirections=new Map([[1,[2,1]],[2,[2,2]],[3,[2,2,1]],[4,[2,2,1]],[5,[1,2,2]],[6,[1,2,2]],[7,[1,2,2]],[8,[1,2,2]],[9,[1,2,2]],[10,[1,2,2]],[11,[2,2,2]],[12,[2,2,2]],[13,[0,2,1]],[14,[2,2,2,1]],[15,[2,2,2,1]],[16,[2,2,2,2]],[17,[2,2,2,2,1]],[18,[2,2,2,2,1]]]),Io._rasgueadoDurations=new Map([[1,[_.toTicks(8),_.toTicks(8)]],[2,[_.toTicks(8),_.toTicks(8)]],[3,[_.toTicks(8)/3,_.toTicks(8)/3,_.toTicks(8)/3]],[4,[_.toTicks(16),_.toTicks(16),_.toTicks(8)]],[5,[_.toTicks(8)/3,_.toTicks(8)/3,_.toTicks(8)/3]],[6,[_.toTicks(16)/3,_.toTicks(16)/3,_.toTicks(8)/3]],[7,[_.toTicks(8)/3,_.toTicks(8)/3,_.toTicks(8)/3]],[8,[_.toTicks(16),_.toTicks(16),_.toTicks(8)]],[9,[_.toTicks(8)/3,_.toTicks(8)/3,_.toTicks(8)/3]],[10,[_.toTicks(16),_.toTicks(16),_.toTicks(8)]],[11,[_.toTicks(8)/3,_.toTicks(8)/3,_.toTicks(8)/3]],[12,[_.toTicks(16)/3,_.toTicks(16)/3,_.toTicks(8)/3]],[13,[_.toTicks(16)/3,_.toTicks(16)/3,_.toTicks(8)/3]],[14,[_.toTicks(16)/3,_.toTicks(16)/3,_.toTicks(16)/3,_.toTicks(8)]],[15,[_.toTicks(16)/3,_.toTicks(16)/3,_.toTicks(16)/3,_.toTicks(8)]],[16,[_.toTicks(16),_.toTicks(16),_.toTicks(16),_.toTicks(16)]],[17,[_.toTicks(16)/5,_.toTicks(16)/5,_.toTicks(16)/5,_.toTicks(16)/5,_.toTicks(16)/5]],[18,[_.toTicks(16)/5,_.toTicks(16)/5,_.toTicks(16)/5,_.toTicks(16)/5,_.toTicks(16)/5]]]);var Ao=Io,Ro=class{constructor(){this.oldWidth=0,this.newWidth=0,this.settings=null}},Oo=class{constructor(e,t){this.width=0,this.height=0,this.x=e,this.y=t}getBoundingBoxTop(){return this.y}doLayout(){}paint(e,t,s){}},Vo=class extends Oo{constructor(e=0,t=0){super(e,t),this.beat=null,this.nextGlyph=null,this.previousGlyph=null}},Wo=class extends Vo{constructor(e,t,s,i){super(e,t),this.glyphScale=0,this.center=!1,this.offsetX=0,this.offsetY=0,this.glyphScale=s,this.symbol=i}getBoundingBoxTop(){let e=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-e}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(e,t,s){if(0===this.width&&0===this.height)return;let i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(e+this.x+this.offsetX,t+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),s.color=i}},Ho=class extends Vo{constructor(e,t,s,i){super(e,t),this.glyphScale=0,this.center=!1,this.offsetX=0,this.offsetY=0,this.glyphScale=s,this.symbols=i}getBoundingBoxTop(){let e=0;for(let t=0;t<this.symbols.length;t++){let s=this.renderer.smuflMetrics.glyphTop.get(this.symbols[t]);(0===t||s<e)&&(e=s)}return this.y-this.offsetY-e}doLayout(){this.width=0,this.height=0;for(let e=0;e<this.symbols.length;e++){let t=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[e])*this.glyphScale,s=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[e])*this.glyphScale;(0===e||t>this.width)&&(this.width=t),(0===e||s>this.height)&&(this.height=s)}}paint(e,t,s){if(0===this.width&&0===this.height)return;let i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbols(e+this.x+this.offsetX,t+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),s.color=i}},Go=class e extends Wo{constructor(t,s,i,a){super(t,s,a?e.GraceScale:1,e.getSymbol(i)),this.centerOnStem=!1}paint(e,t,s){this.centerOnStem&&(this.center=!0),super.paint(e,t,s)}static getSymbol(e){switch(e){case-4:return 57505;case-2:return 57504;case 1:return 57506;case 2:return 57507;default:return 57508}}};Go.GraceScale=.75;var zo=Go,Uo=class e extends Wo{constructor(t,s,i,a,r){super(t,s,r?zo.GraceScale:1,e.getSymbol(i,a,r))}static getSymbol(e,t,s){if(s&&(e=8),0===t)switch(e){case 8:default:return 57920;case 16:return 57922;case 32:return 57924;case 64:return 57926;case 128:return 57928;case 256:return 57930}switch(e){case 8:default:return 57921;case 16:return 57923;case 32:return 57925;case 64:return 57927;case 128:case 256:return 57929}}},Yo=class e extends Oo{constructor(e,t){super(0,0),this.ties=[],this.minWidth=0,this.beat=e,this.ties=[],this.voiceContainer=t}get onTimeX(){return this.onNotes.x+this.onNotes.centerX}addTie(e){e.renderer=this.renderer,this.ties.push(e)}drawBeamHelperAsFlags(e){return e.hasFlag(!1,void 0)}registerLayoutingInfo(e){let t=this.preNotes.computedWidth+this.onNotes.centerX,s=this.onNotes.computedWidth-this.onNotes.centerX,i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(0!==this.beat.graceType||i&&this.drawBeamHelperAsFlags(i))&&(s+=this.renderer.smuflMetrics.glyphWidths.get(57920)*zo.GraceScale);for(let e of this.ties)s+=e.width;e.addBeatSpring(this.beat,t,s)}applyLayoutingInfo(e){this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout(),this.onNotes.updateBeamingHelper();let e=this.beat.notes.length-1;for(;e>=0;)this.createTies(this.beat.notes[e--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest&&1===this.onNotes.beamingHelper.beats.length&&this.beat.duration>=8){let e=Uo.getSymbol(this.beat.duration,this.onNotes.beamingHelper.direction,0!==this.beat.graceType);this.minWidth+=this.renderer.smuflMetrics.glyphWidths.get(e)}let e=0;for(let t of this.ties)t.width>e&&(e=t.width);this.minWidth+=e,this.width=this.minWidth}scaleToWidth(e){this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return`b${e.id}`}paint(t,s,i){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.ties.length)return;i.beginGroup(e.getGroupId(this.beat)),this.preNotes.paint(t+this.x,s+this.y,i),this.onNotes.paint(t+this.x,s+this.y,i);let a=t-this.voiceContainer.x-this.renderer.x,r=s-this.voiceContainer.y-this.renderer.y;for(let e=0,t=this.ties.length;e<t;e++){let t=this.ties[e];t.renderer=this.renderer,t.paint(a,r,i)}i.endGroup()}buildBoundingsLookup(e,t,s,i){let a=new ps;if(a.beat=this.beat,this.beat.isEmpty)a.visualBounds=new ms,a.visualBounds.x=t+this.x,a.visualBounds.y=e.visualBounds.y,a.visualBounds.w=this.width,a.visualBounds.h=e.visualBounds.h,a.realBounds=new ms,a.realBounds.x=t+this.x,a.realBounds.y=e.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=e.realBounds.h,a.onNotesX=t+this.x+this.onNotes.centerX;else{a.visualBounds=new ms,a.visualBounds.x=t+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?a.visualBounds.x=t+this.x:a.visualBounds.x=t+this.x+this.onNotes.x:a.visualBounds.x=t+this.x+this.preNotes.x;let s=0;s=this.onNotes.isEmpty?this.preNotes.isEmpty?t+this.x+this.width:t+this.x+this.preNotes.x+this.preNotes.width:t+this.x+this.onNotes.x+this.onNotes.width,a.visualBounds.w=s-a.visualBounds.x;let i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(i&&this.drawBeamHelperAsFlags(i)||0!==this.beat.graceType)&&(a.visualBounds.w+=this.renderer.smuflMetrics.glyphWidths.get(57920)*(0!==this.beat.graceType?zo.GraceScale:1)),a.visualBounds.y=e.visualBounds.y,a.visualBounds.h=e.visualBounds.h,a.realBounds=new ms,a.realBounds.x=t+this.x,a.realBounds.y=e.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=e.realBounds.h,a.onNotesX=t+this.x+this.onNotes.x+this.onNotes.centerX}e.addBeat(a),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(a,t+this.x,s+this.y)}},Xo=class{constructor(){this._width=0,this._score=null,this._trackIndexes=null,this.preRender=new cs,this.renderFinished=new cs,this.partialRenderFinished=new cs,this.partialLayoutFinished=new cs,this.postRenderFinished=new ds,this.error=new cs}get instance(){return this._instance}set instance(e){this._instance=e;let t=this._instanceEventUnregister;if(t)for(let e of t)e();if(e){let t=[];t.push(e.preRender.on(e=>this.preRender.trigger(e))),t.push(e.renderFinished.on(e=>this.renderFinished.trigger(e))),t.push(e.partialRenderFinished.on(e=>this.partialRenderFinished.trigger(e))),t.push(e.partialLayoutFinished.on(e=>this.partialLayoutFinished.trigger(e))),t.push(e.postRenderFinished.on(()=>this.postRenderFinished.trigger())),t.push(e.error.on(e=>this.error.trigger(e))),this._instanceEventUnregister=t,this._settings&&e.updateSettings(this._settings),e.width=this._width,null!==this._score&&e.renderScore(this._score,this._trackIndexes)}else this._instanceEventUnregister=void 0}get boundsLookup(){return this._instance?this._instance.boundsLookup:null}get width(){return this._instance?this._instance.width:0}set width(e){this._width=e,this._instance&&(this._instance.width=e)}render(){this._instance?.render()}resizeRender(){this._instance?.resizeRender()}renderScore(e,t){this._score=e,this._trackIndexes=t,this._instance?.renderScore(e,t)}renderResult(e){this._instance?.renderResult(e)}updateSettings(e){this._settings=e,this._instance?.updateSettings(e)}destroy(){this._instance?.destroy(),this._instance=void 0}},$o=class{constructor(e){this.activeBeats=e}},Jo=class{constructor(){this._masterVolume=1,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=1,this._isLooping=!1,this._midiEventsPlayedFilter=[],this.finished=new ds,this.soundFontLoaded=new ds,this.soundFontLoadFailed=new cs,this.midiLoadFailed=new cs,this.midiEventsPlayed=new cs,this.ready=new ds(()=>this.isReady),this.readyForPlayback=new ds(()=>this.isReadyForPlayback),this.midiLoaded=new cs(()=>this._instance?.loadedMidiInfo??null),this.stateChanged=new cs(()=>new Ea(this.state,!1)),this.positionChanged=new cs(()=>this.currentPosition),this.playbackRangeChanged=new cs(()=>{let e=this.playbackRange;return e?new jr(e):null})}get instance(){return this._instance}set instance(e){this._instance=e;let t=this._instanceEventUnregister;if(t)for(let e of t)e();if(e){let t=[];t.push(e.ready.on(()=>this.ready.trigger())),t.push(e.readyForPlayback.on(()=>this.readyForPlayback.trigger())),t.push(e.finished.on(()=>this.finished.trigger())),t.push(e.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),t.push(e.soundFontLoadFailed.on(e=>this.soundFontLoadFailed.trigger(e))),t.push(e.midiLoaded.on(e=>{this.midiLoaded.trigger(e)})),t.push(e.midiLoadFailed.on(e=>this.midiLoadFailed.trigger(e))),t.push(e.stateChanged.on(e=>this.stateChanged.trigger(e))),t.push(e.positionChanged.on(e=>{this.positionChanged.trigger(e)})),t.push(e.midiEventsPlayed.on(e=>this.midiEventsPlayed.trigger(e))),t.push(e.playbackRangeChanged.on(e=>this.playbackRangeChanged.trigger(e))),this._instanceEventUnregister=t,this.isReady?(e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter,this.ready.trigger()):t.push(e.ready.on(()=>{e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter}))}else this._instanceEventUnregister=void 0}get output(){return this._instance.output}get isReady(){return!!this._instance&&this._instance.isReady}get isReadyForPlayback(){return!!this._instance&&this._instance.isReadyForPlayback}get state(){return this._instance?this._instance.state:0}get logLevel(){return re.logLevel}set logLevel(e){re.logLevel=e,this._instance&&(this._instance.logLevel=e)}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,ze.MinVolume),this._masterVolume=e,this._instance&&(this._instance.masterVolume=e)}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,ze.MinVolume),this._metronomeVolume=e,this._instance&&(this._instance.metronomeVolume=e)}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._instance&&(this._instance.playbackSpeed=e)}get loadedMidiInfo(){return this._instance?this._instance.loadedMidiInfo:void 0}get currentPosition(){return this._instance?this._instance.currentPosition:new La(0,0,0,0,!1,120,120)}get tickPosition(){return this._instance?this._instance.tickPosition:0}set tickPosition(e){this._instance&&(this._instance.tickPosition=e)}get timePosition(){return this._instance?this._instance.timePosition:0}set timePosition(e){this._instance&&(this._instance.timePosition=e)}get playbackRange(){return this._instance?this._instance.playbackRange:null}set playbackRange(e){this._instance&&(this._instance.playbackRange=e)}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._instance&&(this._instance.isLooping=e)}get countInVolume(){return this._countInVolume}set countInVolume(e){this._countInVolume=e,this._instance&&(this._instance.countInVolume=e)}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._instance&&(this._instance.midiEventsPlayedFilter=e)}destroy(){this._instance&&(this._instance.destroy(),this._instance=void 0)}play(){return!!this._instance&&this._instance.play()}pause(){this._instance&&this._instance.pause()}playPause(){this._instance&&this._instance.playPause()}stop(){this._instance&&this._instance.stop()}playOneTimeMidiFile(e){this._instance&&this._instance.playOneTimeMidiFile(e)}loadSoundFont(e,t){this._instance&&this._instance.loadSoundFont(e,t)}resetSoundFonts(){this._instance&&this._instance.resetSoundFonts()}loadMidiFile(e){this._instance&&this._instance.loadMidiFile(e)}loadBackingTrack(e){this._instance&&this._instance.loadBackingTrack(e)}updateSyncPoints(e){this._instance&&this._instance.updateSyncPoints(e)}applyTranspositionPitches(e){this._instance&&this._instance.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this._instance&&this._instance.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this._instance&&this._instance.setChannelMute(e,t)}resetChannelStates(){this._instance&&this._instance.resetChannelStates()}setChannelSolo(e,t){this._instance&&this._instance.setChannelSolo(e,t)}setChannelVolume(e,t){this._instance&&this._instance.setChannelVolume(e,t)}},qo=class{constructor(){this._midiEventQueue=new Xr,this.masterVolume=1,this.metronomeVolume=0,this.outSampleRate=44100,this.currentTempo=120,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.activeVoiceCount=0}noteOffAll(e){}resetSoft(){}resetPresets(){}loadPresets(e,t,s,i){}setupMetronomeChannel(e){}synthesizeSilent(e){this.fakeSynthesize()}_processMidiMessage(e){}dispatchEvent(e){this._midiEventQueue.enqueue(e)}synthesize(e,t,s){return this.fakeSynthesize()}fakeSynthesize(){let e=[];for(;!this._midiEventQueue.isEmpty;){let t=this._midiEventQueue.dequeue();t.isMetronome&&this.metronomeVolume>0||t.event&&this._processMidiMessage(t.event),e.push(t)}return e}applyTranspositionPitches(e){}setChannelTranspositionPitch(e,t){}channelSetMute(e,t){}channelSetSolo(e,t){}resetChannelStates(){}channelSetMixVolume(e,t){}hasSamplesForProgram(e){return!0}hasSamplesForPercussion(e){return!0}},jo=class extends Zr{constructor(e,t){super(e,new qo,t),this.synthesizer.output=e,this._backingTrackOutput=e,e.timeUpdate.on(t=>{let s=this.sequencer.mainTimePositionFromBackingTrack(t,e.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(s),this.synthesizer.fakeSynthesize(),this.updateTimePosition(s,!1),this.checkForFinish()})}updateMasterVolume(e){super.updateMasterVolume(e),this._backingTrackOutput.masterVolume=e}updatePlaybackSpeed(e){super.updatePlaybackSpeed(e),this._backingTrackOutput.playbackRate=e}onSampleRequest(){}loadMidiFile(e){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(e)}updateTimePosition(e,t){super.updateTimePosition(e,t),t&&this._backingTrackOutput.seekTo(this.sequencer.mainTimePositionToBackingTrack(e,this._backingTrackOutput.backingTrackDuration))}loadBackingTrack(e){let t=e.backingTrack;t&&(this._backingTrackOutput.loadBackingTrack(t),this.timePosition=0)}updateSyncPoints(e){this.sequencer.mainUpdateSyncPoints(e),this.tickPosition=this.tickPosition}},Ko=class{constructor(){this.sampleRate=44100,this._seekPosition=0,this.ready=new ds,this.samplesPlayed=new cs,this.timeUpdate=new cs,this.sampleRequest=new ds}get handler(){return this._handler}set handler(e){e&&0!==this._seekPosition&&(e.seekTo(this._seekPosition),this._seekPosition=0),this._handler=e}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(e){let t=this.handler;t&&(t.playbackRate=e)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(e){let t=this.handler;t&&(t.masterVolume=e)}seekTo(e){let t=this.handler;t?t.seekTo(e):this._seekPosition=e}loadBackingTrack(e){}open(e){this.ready.trigger()}updatePosition(e){this.timeUpdate.trigger(e)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(e){}resetSamples(){}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}},Qo=class extends jo{get handler(){return this.output.handler}set handler(e){this.output.handler=e}constructor(e){super(new Ko,e)}},Zo=class{constructor(){this.startTick=0,this.endTick=0}},el=class{constructor(e){this.bounds=null,this.beat=e}},tl=class{constructor(e,t){this._startTime=0,this._trackIndexes=null,this._trackIndexLookup=null,this._isDestroyed=!1,this._score=null,this._tracks=[],this._actualPlayerMode=0,this._tickCache=null,this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._currentBeat=null,this._currentBeatBounds=null,this._isInitialBeatCursorUpdate=!0,this._previousStateForCursor=0,this._previousCursorCache=null,this._lastScroll=0,this._isBeatMouseDown=!1,this._isNoteMouseDown=!1,this._selectionStart=null,this._selectionEnd=null,this.beatMouseDown=new cs,this.beatMouseMove=new cs,this.beatMouseUp=new cs,this.noteMouseDown=new cs,this.noteMouseMove=new cs,this.noteMouseUp=new cs,this.resize=new cs,this.renderStarted=new cs,this.renderFinished=new cs,this.postRenderFinished=new ds,this.error=new cs,this.midiLoad=new cs,this.settingsUpdated=new ds,this.uiFacade=e,this.container=e.rootContainer,this.activeBeatsChanged=new cs(()=>1===this._player.state&&this._currentBeat?new $o(this._currentBeat.beatLookup.highlightedBeats.map(e=>e.beat)):null),this.playedBeatChanged=new cs(()=>1===this._player.state&&this._currentBeat?this._currentBeat.beat:null),this.scoreLoaded=new cs(()=>this._score?this._score:null),this.midiLoaded=new cs(()=>this._player.loadedMidiInfo??null),e.initialize(this,t),re.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),bu.printEnvironmentInfo(!1),this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this._renderer=new Xo,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&bu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this._renderer.instance=this.uiFacade.createWorkerRenderer():this._renderer.instance=new _s(this.settings),this.container.resize.on(bu.throttle(()=>{this._isDestroyed||this.container.width!==this._renderer.width&&this.triggerResize()},e.resizeThrottle));let s=new Ro;s.oldWidth=this._renderer.width,s.newWidth=0|this.container.width,s.settings=this.settings,this._onResize(s),this._renderer.preRender.on(this._onRenderStarted.bind(this)),this._renderer.renderFinished.on(e=>{this._onRenderFinished(e)}),this._renderer.postRenderFinished.on(()=>{let e=Date.now()-this._startTime;re.debug("rendering",`Rendering completed in ${e}ms`),this._onPostRenderFinished()}),this._renderer.preRender.on(e=>{this._startTime=Date.now()}),this._renderer.partialLayoutFinished.on(e=>this._appendRenderResult(e,!1)),this._renderer.partialRenderFinished.on(this._updateRenderResult.bind(this)),this._renderer.renderFinished.on(e=>{this._appendRenderResult(e,!0)}),this._renderer.error.on(this.onError.bind(this)),this._setupPlayerWrapper(),0!==this.settings.player.playerMode&&this._setupOrDestroyPlayer(),this._setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}get actualPlayerMode(){return this._actualPlayerMode}get renderer(){return this._renderer}get score(){return this._score}get tracks(){return this._tracks}_setupPlayerWrapper(){let e=new Jo;this._player=e,e.ready.on(()=>{this.loadMidiForScore()}),e.readyForPlayback.on(()=>{if(this._onPlayerReady(),this.tracks)for(let t of this.tracks){let s=t.playbackInfo.volume/16;e.setChannelVolume(t.playbackInfo.primaryChannel,s),e.setChannelVolume(t.playbackInfo.secondaryChannel,s)}}),e.soundFontLoaded.on(this._onSoundFontLoaded.bind(this)),e.soundFontLoadFailed.on(e=>{this.onError(e)}),e.midiLoaded.on(this._onMidiLoaded.bind(this)),e.midiLoadFailed.on(e=>{this.onError(e)}),e.stateChanged.on(this._onPlayerStateChanged.bind(this)),e.positionChanged.on(this._onPlayerPositionChanged.bind(this)),e.midiEventsPlayed.on(this._onMidiEventsPlayed.bind(this)),e.playbackRangeChanged.on(this._onPlaybackRangeChanged.bind(this)),e.finished.on(this._onPlayerFinished.bind(this))}destroy(){this._isDestroyed=!0,this._player.destroy(),this.uiFacade.destroy(),this._renderer.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();let e=this.score;e&&qe.applyPitchOffsets(this.settings,e),this._updateRenderer(),this._renderer.updateSettings(this.settings),this._setupOrDestroyPlayer(),this._onSettingsUpdated()}_updateRenderer(){let e=this._renderer;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&bu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?e.instance instanceof _s&&(e.destroy(),e.instance=this.uiFacade.createWorkerRenderer()):e.instance instanceof _s||(e.destroy(),e.instance=new _s(this.settings))}load(e,t){try{return this.uiFacade.load(e,e=>{this.renderScore(e,t)},e=>{this.onError(e)})}catch(e){return this.onError(e),!1}}renderScore(e,t){let s=[];if(t)if(0===t.length)e.tracks.length>0&&s.push(e.tracks[0]);else if(1===t.length&&-1===t[0])for(let t of e.tracks)s.push(t);else for(let i of t)i>=0&&i<=e.tracks.length&&s.push(e.tracks[i]);else e.tracks.length>0&&s.push(e.tracks[0]);this._internalRenderTracks(e,s)}renderTracks(e){if(e.length>0){let t=e[0].score;for(let s of e)if(s.score!==t)return void this.onError(new u(0,"All rendered tracks must belong to the same score."));this._internalRenderTracks(t,e)}}_internalRenderTracks(e,t){if(qe.applyPitchOffsets(this.settings,e),e!==this.score){this._score=e,this._tracks=t,this._tickCache=null,this._trackIndexes=[];for(let e of t)this._trackIndexes.push(e.index);this._trackIndexLookup=new Set(this._trackIndexes),this._onScoreLoaded(e),this.loadMidiForScore(),this.render()}else{this._tracks=t;let s=qe.computeFirstDisplayedBarIndex(e,this.settings),i=qe.computeLastDisplayedBarIndex(e,this.settings,s);this._tickCache&&(this._tickCache.multiBarRestInfo=qe.buildMultiBarRestInfo(this.tracks,s,i)),this._trackIndexes=[];for(let e of t)this._trackIndexes.push(e.index);this._trackIndexLookup=new Set(this._trackIndexes),this.render()}}triggerResize(){if(this.container.isVisible){let e=new Ro;e.oldWidth=this._renderer.width,e.newWidth=this.container.width,e.settings=this.settings,this._onResize(e),this._renderer.updateSettings(this.settings),this._renderer.width=this.container.width,this._renderer.resizeRender()}else re.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{re.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}_appendRenderResult(e,t){t&&(this.canvasElement.width=e.totalWidth,this.canvasElement.height=e.totalHeight,this._cursorWrapper&&(this._cursorWrapper.width=e.totalWidth,this._cursorWrapper.height=e.totalHeight)),(e.width>0||e.height>0)&&this.uiFacade.beginAppendRenderResults(e),t&&this.uiFacade.beginAppendRenderResults(null)}_updateRenderResult(e){e&&e.renderResult&&this.uiFacade.beginUpdateRenderResults(e)}tex(e,t){try{let s=new As;s.logErrors=!0,s.initFromString(e,this.settings);let i=s.readScore();this.renderScore(i,t)}catch(e){this.onError(e)}}loadSoundFont(e,t=!1){return this.uiFacade.loadSoundFont(e,t)}resetSoundFonts(){this._player.resetSoundFonts()}render(){this.uiFacade.canRender?(this._renderer.width=this.container.width,this._renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render())}get tickCache(){return this._tickCache}get boundsLookup(){return this._renderer.boundsLookup}get player(){return this._player.instance?this._player:null}get isReadyForPlayback(){return this._player.isReadyForPlayback}get playerState(){return this._player.state}get masterVolume(){return this._player.masterVolume}set masterVolume(e){this._player.masterVolume=e}get metronomeVolume(){return this._player.metronomeVolume}set metronomeVolume(e){this._player.metronomeVolume=e}get countInVolume(){return this._player.countInVolume}set countInVolume(e){this._player.countInVolume=e}get midiEventsPlayedFilter(){return this._player.midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._player.midiEventsPlayedFilter=e}get tickPosition(){return this._player.tickPosition}set tickPosition(e){this._player.tickPosition=e}get timePosition(){return this._player.timePosition}set timePosition(e){this._player.timePosition=e}get endTick(){return this._player.currentPosition.endTick}get endTime(){return this._player.currentPosition.endTime}get playbackRange(){return this._player.playbackRange}set playbackRange(e){this._player.playbackRange=e,this._updateSelectionCursor(e)}get playbackSpeed(){return this._player.playbackSpeed}set playbackSpeed(e){this._player.playbackSpeed=e}get isLooping(){return this._player.isLooping}set isLooping(e){this._player.isLooping=e}_destroyPlayer(){this._player.destroy(),this._previousTick=0,this._destroyCursors()}_setupOrDestroyPlayer(){let e=this.settings.player.playerMode;if(1===e){let t=this.score;if(!t)return!1;e=t?.backingTrack?.rawAudioFile?3:2}let t=null;if(e===this._actualPlayerMode)return this._updateCursors(),!1;switch(this._destroyPlayer(),this._updateCursors(),e){case 0:t=null;break;case 2:t=this.uiFacade.createWorkerPlayer();break;case 3:t=this.uiFacade.createBackingTrackPlayer();break;case 4:t=new Qo(this.settings.player.bufferTimeInMilliseconds)}return this._actualPlayerMode=e,t&&(this._player.instance=t),!1}loadMidiForScore(){if(!this.score)return;let e=this.score;re.debug("AlphaTab","Generating Midi");let t=new oa,s=new ko(t),i=new Ao(e,this.settings,s),a=qe.computeFirstDisplayedBarIndex(e,this.settings),r=qe.computeLastDisplayedBarIndex(e,this.settings,a);i.tickLookup.multiBarRestInfo=qe.buildMultiBarRestInfo(this.tracks,a,r),i.applyTranspositionPitches=!1,i.generate(),this._tickCache=i.tickLookup,this._onMidiLoad(t);let n=this._player;n.loadMidiFile(t),n.loadBackingTrack(e),n.updateSyncPoints(i.syncPoints),n.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){if(!this.score)return;let e=this.score;this._player.updateSyncPoints(Ao.generateSyncPoints(e))}changeTrackVolume(e,t){for(let s of e)this._player.setChannelVolume(s.playbackInfo.primaryChannel,t),this._player.setChannelVolume(s.playbackInfo.secondaryChannel,t)}changeTrackSolo(e,t){for(let s of e)this._player.setChannelSolo(s.playbackInfo.primaryChannel,t),this._player.setChannelSolo(s.playbackInfo.secondaryChannel,t)}changeTrackMute(e,t){for(let s of e)this._player.setChannelMute(s.playbackInfo.primaryChannel,t),this._player.setChannelMute(s.playbackInfo.secondaryChannel,t)}changeTrackTranspositionPitch(e,t){for(let s of e)this._player.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,t),this._player.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,t)}play(){return this._player.play()}pause(){this._player.pause()}playPause(){this._player.playPause()}stop(){this._player.stop()}playBeat(e){let t=new oa,s=new ko(t);new Ao(e.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(e),this._player.playOneTimeMidiFile(t)}playNote(e){let t=new oa,s=new ko(t);new Ao(e.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(e),this._player.playOneTimeMidiFile(t)}_destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null)}_updateCursors(){let e=this._hasCursor;if(e&&!this._cursorWrapper){let e=this.uiFacade.createCursors();e&&(this._cursorWrapper=e.cursorWrapper,this._barCursor=e.barCursor,this._beatCursor=e.beatCursor,this._selectionWrapper=e.selectionWrapper,this._isInitialBeatCursorUpdate=!0),null!==this._currentBeat&&this._cursorUpdateBeat(this._currentBeat,!1,this._previousTick>10,1,!0)}else!e&&this._cursorWrapper&&this._destroyCursors()}_cursorUpdateTick(e,t,s,i=!1,a=!1){this._previousTick=e;let r=this._tickCache;if(r){let n=this._trackIndexLookup;if(null!=n&&n.size>0){let o=r.findBeat(n,e,this._currentBeat);o&&this._cursorUpdateBeat(o,t,i,s,a||0===this.playerState)}}}_cursorUpdateBeat(e,t,s,i,a=!1){let r=e.beat,n=e.nextBeat?.beat??null,o=e.duration,l=e.beatLookup.highlightedBeats;if(!r)return;let h=this._renderer.boundsLookup;if(!h)return;let d=this._currentBeat,c=this._previousCursorCache,u=this._previousStateForCursor;if(!a&&r===d?.beat&&h===c&&u===this._player.state&&d?.start===e.start)return;let p=h.findBeat(r);p&&(this._currentBeat=e,this._previousCursorCache=h,this._previousStateForCursor=this._player.state,this.uiFacade.beginInvoke(()=>{this._internalCursorUpdateBeat(r,n,o,t,l,h,p,s,e.cursorMode,i)}))}scrollToCursor(){let e=this._currentBeatBounds;e&&this._internalScrollToCursor(e.barBounds.masterBarBounds)}_internalScrollToCursor(e){let t=this.uiFacade.getScrollContainer(),s=bu.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,i=this.settings.player.scrollMode;if(s){let s=e.realBounds.y+this.settings.player.scrollOffsetY;if(s!==this._lastScroll)switch(this._lastScroll=s,i){case 1:let i=this.uiFacade.getOffset(t,this.container),a=this.uiFacade.getOffset(null,t).h,r=e.realBounds.h/2;this.uiFacade.scrollToY(t,i.y+s-a/2+r,this.settings.player.scrollSpeed);break;case 2:let n=t.scrollTop+this.uiFacade.getOffset(null,t).h;if(e.visualBounds.y+e.visualBounds.h>=n||e.visualBounds.y<t.scrollTop){let s=e.realBounds.y+this.settings.player.scrollOffsetY;this.uiFacade.scrollToY(t,s,this.settings.player.scrollSpeed)}}}else{let s=e.visualBounds.x;if(s!==this._lastScroll)switch(this._lastScroll=s,i){case 1:let s=this.uiFacade.getOffset(null,t).w,i=(this._currentBeatBounds?this._currentBeatBounds.onNotesX:e.realBounds.x)-s/2+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,i,this.settings.player.scrollSpeed);break;case 2:let a=t.scrollLeft+this.uiFacade.getOffset(null,t).w;if(e.visualBounds.x+e.visualBounds.w>=a||e.visualBounds.x<t.scrollLeft){let s=e.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,s,this.settings.player.scrollSpeed)}}}}_internalCursorUpdateBeat(e,t,s,i,a,r,n,o,l,h){let d=this._barCursor,c=this._beatCursor,u=n.barBounds.masterBarBounds,p=u.visualBounds,m=this._currentBeatBounds;this._currentBeatBounds=n,d&&d.setBounds(p.x,p.y,p.w,p.h);let g=1===this._player.state&&!i,f=u.visualBounds.x+u.visualBounds.w;if(t&&1===l){let e=r.findBeat(t);e&&e.barBounds.masterBarBounds.staffSystemBounds===u.staffSystemBounds&&(f=e.onNotesX)}let b=n.onNotesX;if(c){if(this.settings.player.enableAnimatedBeatCursor){let e=f-n.onNotesX,t=this._previousTick-this._currentBeat.start,i=this._currentBeat.tickDuration>0?t/this._currentBeat.tickDuration:0;b=n.onNotesX+e*i,s-=s*i,g?((!m||this._isInitialBeatCursorUpdate||p.y!==m.barBounds.masterBarBounds.visualBounds.y||b<m.onNotesX||u.index>m.barBounds.masterBarBounds.index+1)&&(c.transitionToX(0,b),c.setBounds(b,p.y,1,p.h)),this.uiFacade.beginInvoke(()=>{let e=1===l?2:1,t=b+(f-b)*e;c.transitionToX(s/h*e,t)})):(c.transitionToX(0,b),c.setBounds(b,p.y,1,p.h))}else c.transitionToX(0,b),c.setBounds(b,p.y,1,p.h);this._isInitialBeatCursorUpdate=!1}else this._isInitialBeatCursorUpdate=!0;this.uiFacade.removeHighlights();let y=!1;if(g){if(this.settings.player.enableElementHighlighting)for(let t of a){let s=Yo.getGroupId(t.beat);this.uiFacade.highlightElements(s,e.voice.bar.index)}o=!i,y=!0}o&&!this._isBeatMouseDown&&0!==this.settings.player.scrollMode&&this._internalScrollToCursor(u),y&&(this._onPlayedBeatChanged(e),this._onActiveBeatsChanged(new $o(a.map(e=>e.beat))))}_onPlayedBeatChanged(e){this._isDestroyed||(this.playedBeatChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",e))}_onActiveBeatsChanged(e){this._isDestroyed||(this.activeBeatsChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",e))}get _hasCursor(){return 0!==this.settings.player.playerMode&&this.settings.player.enableCursor}_onBeatMouseDown(e,t){this._isDestroyed||(this._hasCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new el(t),this._selectionEnd=null),this._isBeatMouseDown=!0,this.beatMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseDown",t,e))}_onNoteMouseDown(e,t){this._isDestroyed||(this._isNoteMouseDown=!0,this.noteMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseDown",t,e))}_onBeatMouseMove(e,t){this._isDestroyed||(this.settings.player.enableUserInteraction&&(!this._selectionEnd||this._selectionEnd.beat!==t)&&(this._selectionEnd=new el(t),this._cursorSelectRange(this._selectionStart,this._selectionEnd)),this.beatMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseMove",t,e))}_onNoteMouseMove(e,t){this._isDestroyed||(this.noteMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseMove",t,e))}_onBeatMouseUp(e,t){if(!this._isDestroyed){if(this._hasCursor&&this.settings.player.enableUserInteraction){if(this._selectionEnd){let e=this._tickCache?.getBeatStart(this._selectionStart.beat)??this._selectionStart.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(this._selectionEnd.beat)??this._selectionEnd.beat.absolutePlaybackStart)<e){let e=this._selectionStart;this._selectionStart=this._selectionEnd,this._selectionEnd=e}}if(this._selectionStart&&this._tickCache){let e=this._tickCache,t=e.getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar);if(this._currentBeat=null,0===this._player.state&&this._cursorUpdateTick(this._tickCache.getBeatStart(this._selectionStart.beat),!1,1),this.tickPosition=t+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat){let s=e.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),i=new Zo;i.startTick=t+this._selectionStart.beat.playbackStart,i.endTick=s+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=i}else this._selectionStart=null,this.playbackRange=null,this._cursorSelectRange(this._selectionStart,this._selectionEnd)}}this.beatMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseUp",t,e),this._isBeatMouseDown=!1}}_onNoteMouseUp(e,t){this._isDestroyed||(this.noteMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseUp",t,e),this._isNoteMouseDown=!1)}_updateSelectionCursor(e){if(this._tickCache)if(e){let t=this._tickCache.findBeat(this._trackIndexLookup,e.startTick),s=this._tickCache.findBeat(this._trackIndexLookup,e.endTick);if(t&&s){let e=new el(t.beat),i=new el(s.beat);this._cursorSelectRange(e,i)}}else this._cursorSelectRange(null,null)}_setupClickHandling(){this.canvasElement.mouseDown.on(e=>{if(!e.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&e.preventDefault();let t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(i&&(this._onBeatMouseDown(e,i),this.settings.core.includeNoteBounds)){let a=this._renderer.boundsLookup?.getNoteAtPos(i,t,s);a&&this._onNoteMouseDown(e,a)}}),this.canvasElement.mouseMove.on(e=>{if(!this._isBeatMouseDown)return;let t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(i&&(this._onBeatMouseMove(e,i),this._isNoteMouseDown)){let a=this._renderer.boundsLookup?.getNoteAtPos(i,t,s);a&&this._onNoteMouseMove(e,a)}}),this.canvasElement.mouseUp.on(e=>{if(!this._isBeatMouseDown)return;this.settings.player.enableUserInteraction&&e.preventDefault();let t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(this._onBeatMouseUp(e,i),this._isNoteMouseDown)if(i){let a=this._renderer.boundsLookup?.getNoteAtPos(i,t,s)??null;this._onNoteMouseUp(e,a)}else this._onNoteMouseUp(e,null)}),this._renderer.postRenderFinished.on(()=>{!this._selectionStart||!this._hasCursor||!this.settings.player.enableUserInteraction||this._cursorSelectRange(this._selectionStart,this._selectionEnd)})}_cursorSelectRange(e,t){let s=this._renderer.boundsLookup;if(!s)return;let i=this._selectionWrapper;if(!i||(i.clear(),!e||!t||e.beat===t.beat))return;e.bounds||(e.bounds=s.findBeat(e.beat)),t.bounds||(t.bounds=s.findBeat(t.beat));let a=this._tickCache?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart)<a){let s=e;e=t,t=s}let r=e.bounds.realBounds.x,n=t.bounds.realBounds.x+t.bounds.realBounds.w;if(t.beat.index===t.beat.voice.beats.length-1&&(n=t.bounds.barBounds.masterBarBounds.realBounds.x+t.bounds.barBounds.masterBarBounds.realBounds.w),e.bounds.barBounds.masterBarBounds.staffSystemBounds!==t.bounds.barBounds.masterBarBounds.staffSystemBounds){let a=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,o=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,l=this.uiFacade.createSelectionElement();l.setBounds(r,e.bounds.barBounds.masterBarBounds.visualBounds.y,o-r,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(l);let h=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,d=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let e=h;e<d;e++){let t=s.staffSystems[e],r=this.uiFacade.createSelectionElement();r.setBounds(a,t.visualBounds.y,o-a,t.visualBounds.h),i.appendChild(r)}let c=this.uiFacade.createSelectionElement();c.setBounds(a,t.bounds.barBounds.masterBarBounds.visualBounds.y,n-a,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(c)}else{let t=this.uiFacade.createSelectionElement();t.setBounds(r,e.bounds.barBounds.masterBarBounds.visualBounds.y,n-r,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(t)}}_onScoreLoaded(e){this._isDestroyed||(this.scoreLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"scoreLoaded",e),this._setupOrDestroyPlayer()||this.loadMidiForScore())}_onResize(e){this._isDestroyed||(this.resize.trigger(e),this.uiFacade.triggerEvent(this.container,"resize",e))}_onRenderStarted(e){this._isDestroyed||(this.renderStarted.trigger(e),this.uiFacade.triggerEvent(this.container,"renderStarted",e))}_onRenderFinished(e){this._isDestroyed||(this.renderFinished.trigger(e),this.uiFacade.triggerEvent(this.container,"renderFinished",e))}_onPostRenderFinished(){this._isDestroyed||(this._currentBeat=null,this._cursorUpdateTick(this._previousTick,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}onError(e){this._isDestroyed||(re.error("API","An unexpected error occurred",e),this.error.trigger(e),this.uiFacade.triggerEvent(this.container,"error",e))}get playerReady(){return this._player.readyForPlayback}_onPlayerReady(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this._player.finished}_onPlayerFinished(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this._player.soundFontLoaded}_onSoundFontLoaded(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}_onMidiLoad(e){this._isDestroyed||(this.midiLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"midiLoad",e))}_onMidiLoaded(e){this._isDestroyed||(this.midiLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",e))}get playerStateChanged(){return this._player.stateChanged}_onPlayerStateChanged(e){if(!this._isDestroyed){if(!e.stopped&&0===e.state){let e=this._currentBeat,t=this._tickCache;e&&t&&(this._player.tickPosition=t.getBeatStart(e.beat))}this.uiFacade.triggerEvent(this.container,"playerStateChanged",e)}}get playerPositionChanged(){return this._player.positionChanged}_onPlayerPositionChanged(e){this._isDestroyed||(this._previousTick=e.currentTick,this.uiFacade.beginInvoke(()=>{let t=e.modifiedTempo/e.originalTempo;this._cursorUpdateTick(e.currentTick,!1,t,!1,e.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",e))}get midiEventsPlayed(){return this._player.midiEventsPlayed}_onMidiEventsPlayed(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",e)}get playbackRangeChanged(){return this._player.playbackRangeChanged}_onPlaybackRangeChanged(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",e)}_onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this._player.output.enumerateOutputDevices()}async setOutputDevice(e){await this._player.output.setOutputDevice(e)}async getOutputDevice(){return await this._player.output.getOutputDevice()}async exportAudio(e){if(!this.score)throw new u(0,"No song loaded");let t;t=2===this._actualPlayerMode?this.uiFacade.createWorkerAudioExporter(this._player.instance):this.uiFacade.createWorkerAudioExporter(null);let s=this.score,i=new oa,a=new ko(i),r=new Ao(s,this.settings,a);r.applyTranspositionPitches=!1,r.generate();let n=new Kr;n.soundFonts=e.soundFonts,n.sampleRate=e.sampleRate,n.useSyncPoints=e.useSyncPoints,n.masterVolume=e.masterVolume,n.metronomeVolume=e.metronomeVolume,n.playbackRange=e.playbackRange;for(let[t,s]of e.trackVolume)if(t<this.score.tracks.length){let e=this.score.tracks[t];n.trackVolume.set(e.playbackInfo.primaryChannel,s),n.trackVolume.set(e.playbackInfo.secondaryChannel,s)}for(let[t,s]of e.trackTranspositionPitches)if(t<this.score.tracks.length){let e=this.score.tracks[t];n.trackTranspositionPitches.set(e.playbackInfo.primaryChannel,s),n.trackTranspositionPitches.set(e.playbackInfo.secondaryChannel,s)}return await t.initialize(n,i,r.syncPoints,r.transpositionPitches),t}},sl=class extends u{constructor(e,t){super(0,e),this.xhr=t}},il=class e{static loadAlphaTex(e,t){let s=new As;return s.logErrors=!0,s.initFromString(e,t??new On),s.readScore()}static loadScoreAsync(t,s,i,a){let r=new XMLHttpRequest;r.open("GET",t,!0,null,null),r.responseType="arraybuffer",r.onreadystatechange=()=>{if(r.readyState===XMLHttpRequest.DONE){let t=r.response;if(200===r.status||0===r.status&&t)try{let t=r.response,i=new Uint8Array(t),n=e.loadScoreFromBytes(i,a);s(n)}catch(e){i(e)}else 0===r.status?i(new sl("You are offline!!\n Please Check Your Network.",r)):404===r.status?i(new sl("Requested URL not found.",r)):500===r.status?i(new sl("Internel Server Error.",r)):"parsererror"===r.statusText?i(new sl("Error.\nParsing JSON Request failed.",r)):"timeout"===r.statusText?i(new sl("Request Time out.",r)):i(new sl(`Unknow Error: ${r.responseText}`,r))}},r.send()}static loadScoreFromBytes(e,t){t||(t=new On);let s=bu.buildImporters();re.debug("ScoreLoader",`Loading score from ${e.length} bytes using ${s.length} importers`);let i=null,a=Fs.fromBuffer(e);for(let e of s){a.reset();try{re.debug("ScoreLoader",`Importing using importer ${e.name}`),e.init(a,t),i=e.readScore(),re.debug("ScoreLoader",`Score imported using ${e.name}`);break}catch(t){if(!(t instanceof Cs))throw re.error("ScoreLoader","Score import failed due to unexpected error: ",t),t;re.debug("ScoreLoader",`${e.name} does not support the file`)}}if(i)return i;throw new Cs("No compatible importer found for file")}},al=class{get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(e){let t=e.element,s=t.getBoundingClientRect().left+t.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-s}getY(e){let t=e.element,s=t.getBoundingClientRect().top+t.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-s}preventDefault(){this.mouseEvent.preventDefault()}constructor(e){this.mouseEvent=e}},rl=class e{constructor(t){this._resizeListeners=0,this.lastBounds=new ms,this.element=t,this.mouseDown={on:e=>{let t=t=>{e(new al(t))};return this.element.addEventListener("mousedown",t,!0),()=>{this.element.removeEventListener("mousedown",t,!0)}},off:e=>{}},this.mouseUp={on:e=>{let t=t=>{e(new al(t))};return this.element.addEventListener("mouseup",t,!0),()=>{this.element.removeEventListener("mouseup",t,!0)}},off:e=>{}},this.mouseMove={on:e=>{let t=t=>{e(new al(t))};return this.element.addEventListener("mousemove",t,!0),()=>{this.element.removeEventListener("mousemove",t,!0)}},off:e=>{}};let s=this;this.resize={on:function(t){return 0===s._resizeListeners&&e._resizeObserver.value.observe(s.element),s.element.addEventListener("resize",t,!0),s._resizeListeners++,()=>this.off(t)},off:t=>{this.element.removeEventListener("resize",t,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,e._resizeObserver.value.unobserve(this.element))}}}get width(){return this.element.offsetWidth}set width(e){this.element.style.width=`${e}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(e){this.element.scrollLeft=e}get scrollTop(){return this.element.scrollTop}set scrollTop(e){this.element.scrollTop=e}get height(){return this.element.offsetHeight}set height(e){this.element.style.height=e>=0?`${e}px`:"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}stopAnimation(){this.element.style.transition="none"}transitionToX(e,t){this.element.style.transition=`transform ${e}ms linear`,this.setBounds(t,Number.NaN,Number.NaN,Number.NaN)}setBounds(e,t,s,i){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${e}px, ${t}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=s,this.lastBounds.h=i}appendChild(e){this.element.appendChild(e.element)}clear(){this.element.innerHTML=""}};rl._resizeObserver=new K(()=>new ResizeObserver(e=>{for(let t of e){let e=new CustomEvent("resize",{detail:t});t.target.dispatchEvent(e)}}));var nl=rl,ol=class{constructor(e){this._isStarted=!1,this.isFontLoaded=!1,this.fontLoaded=new cs,this._originalFamilies=e,this._families=e}checkForFontAvailability(){if(bu.isRunningInWorker)return void(this.isFontLoaded=!1);if(this._isStarted)return;this._isStarted=!0;let e=0,t=window.setInterval(()=>{re.warning("Rendering",`Could not load font '${this._families[0]}' within ${5*(e+1)} seconds`,null),this._families.length>1?(this._families.shift(),e=0):e++},5e3);re.debug("Font",`Start checking for font availablility: ${this._families.join(", ")}`);let s=e=>{this._families.length>1?(re.debug("Font",`[${this._families[0]}] Loading Failed, switching to ${this._families[1]}`,e),this._families.shift(),window.setTimeout(()=>{a()},0)):(re.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,e),window.clearInterval(t))},i=e=>{re.debug("Font",`[${e}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._families[0])},a=async()=>{for(let e of this._families)if(await this._isFontAvailable(e,!1))return void i(e);try{await document.fonts.load(`1em ${this._families[0]}`)}catch(e){s(e)}return re.debug("Font",`[${this._families[0]}] Font API signaled loaded`),await this._isFontAvailable(this._families[0],!0)?i(this._families[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{a()})}_isFontAvailable(e,t){return new Promise(s=>{let i=`1em ${e}`;if(document.fonts.check(i))s(!0);else if(t){re.debug("Font",`Font ${e} not available, creating test element to trigger load`);let t=document.createElement("div");t.style.font=i,t.style.opacity="0",t.style.position="absolute",t.style.top="0",t.style.left="0",t.innerText=`Trigger ${e} load`,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}},ll=class extends ea{constructor(){super(...arguments),this._audioNode=null,this._bufferCount=0,this._requestedBufferCount=0,this._outputBuffer=new Float32Array(0)}open(e){super.open(e),this._bufferCount=Math.floor(e*this.sampleRate/1e3/ea.BufferSize),this._circularBuffer=new $i(ea.BufferSize*this._bufferCount),this.onReady()}play(){super.play();let e=this.context;this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this._generateSound.bind(this),this._circularBuffer.clear(),this._requestBuffers(),this.source=e.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this._audioNode,0,0),this.source.start(0),this._audioNode.connect(e.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(e){this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}_requestBuffers(){let e=this._bufferCount/2|0,t=e*ea.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*ea.BufferSize<t){for(let t=0;t<e;t++)this.onSampleRequest();this._requestedBufferCount+=e}}_generateSound(e){let t=e.outputBuffer.getChannelData(0),s=e.outputBuffer.getChannelData(1),i=t.length+s.length,a=this._outputBuffer;a.length!==i&&(a=new Float32Array(i),this._outputBuffer=a);let r=this._circularBuffer.read(a,0,Math.min(a.length,this._circularBuffer.count)),n=0,o=Math.min(t.length,r);for(let e=0;e<o;e++)t[e]=a[n++],s[e]=a[n++];if(r<t.length)for(let e=r;e<t.length;e++)t[e]=0,s[e]=0;this.onSamplesPlayed(r/ze.AudioChannels),this._requestBuffers()}},hl=class{constructor(e,t){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=0,this._masterVolume=0,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._midiEventsPlayedFilter=[],this._currentPosition=new La(0,0,0,0,!1,120,120),this.ready=new ds,this.readyForPlayback=new ds,this.finished=new ds,this.soundFontLoaded=new ds,this.soundFontLoadFailed=new cs,this.midiLoaded=new cs,this.midiLoadFailed=new cs,this.stateChanged=new cs,this.positionChanged=new cs,this.midiEventsPlayed=new cs,this.playbackRangeChanged=new cs,this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=0,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._output=e,this._output.ready.on(this._onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(t.player.bufferTimeInMilliseconds);try{this._synth=bu.createWebWorker(t)}catch(e){re.error("AlphaSynth",`Failed to create WebWorker: ${e}`)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:t.core.logLevel,bufferTimeInMilliseconds:t.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}get output(){return this._output}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return re.logLevel}get worker(){return this._synth}set logLevel(e){re.logLevel=e,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:e})}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,ze.MinVolume),this._masterVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:e})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,ze.MinVolume),this._metronomeVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:e})}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,ze.MinVolume),this._countInVolume=e,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:e})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:bu.prepareForPostMessage(e)})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){e=qe.clamp(e,ze.MinPlaybackSpeed,ze.MaxPlaybackSpeed),this._playbackSpeed=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:e})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._currentPosition.currentTick}set tickPosition(e){e<0&&(e=0),this._currentPosition=new La(this._currentPosition.currentTime,this._currentPosition.endTime,e,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:e})}get timePosition(){return this._currentPosition.currentTime}set timePosition(e){e<0&&(e=0),this._currentPosition=new La(e,this._currentPosition.endTime,this._currentPosition.currentTick,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:e})}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:e})}get playbackRange(){return this._playbackRange}set playbackRange(e){e&&(e.startTick<0&&(e.startTick=0),e.endTick<0&&(e.endTick=0)),this._playbackRange=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:bu.prepareForPostMessage(e)})}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:po.midiFileToJsObject(bu.prepareForPostMessage(e))})}loadSoundFont(e,t){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:bu.prepareForPostMessage(e),append:t})}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:po.midiFileToJsObject(bu.prepareForPostMessage(e))})}applyTranspositionPitches(e){this._synth.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(bu.prepareForPostMessage(e).entries()))})}setChannelTranspositionPitch(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:e,semitones:t})}setChannelMute(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:e,mute:t})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:e,solo:t})}setChannelVolume(e,t){t=Math.max(t,ze.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:e,volume:t})}handleWorkerMessage(e){let t=e.data;switch(t.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this._checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this._checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._currentPosition=new La(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.positionChanged.trigger(this._currentPosition);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new qr(t.events.map(po.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=t.state,this.stateChanged.trigger(new Ea(t.state,t.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=t.playbackRange,this.playbackRangeChanged.trigger(new jr(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(t.error);break;case"alphaSynth.midiLoaded":this._checkReadyForPlayback(),this._loadedMidiInfo=new La(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo);break;case"alphaSynth.midiLoadFailed":this._checkReadyForPlayback(),this.midiLoadFailed.trigger(t.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(t.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples()}}_checkReady(){this.isReady&&this.ready.trigger()}_checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(e){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:e})}_onOutputReady(){this._outputIsReady=!0,this._checkReady()}loadBackingTrack(e){}updateSyncPoints(e){}},dl=class{constructor(e,t){this._width=0,this.boundsLookup=null,this.preRender=new cs,this.partialRenderFinished=new cs,this.partialLayoutFinished=new cs,this.renderFinished=new cs,this.postRenderFinished=new ds,this.error=new cs,this._api=e;try{this._worker=bu.createWebWorker(t)}catch(e){return void re.error("Rendering",`Failed to create WebWorker: ${e}`)}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this._serializeSettingsForWorker(t)}),this._worker.addEventListener("message",this._handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(e){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this._serializeSettingsForWorker(e)})}_serializeSettingsForWorker(e){let t=po.settingsToJsObject(bu.prepareForPostMessage(e));return t.delete("player"),t}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(e){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:e})}get width(){return this._width}set width(e){this._width=e,this._worker.postMessage({cmd:"alphaTab.setWidth",width:e})}_handleWorkerMessage(e){let t=e.data;switch(t.cmd){case"alphaTab.preRender":this.preRender.trigger(t.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(t.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(t.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(t.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=ys.fromJson(t.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(t.error)}}renderScore(e,t){let s=null==e?null:po.scoreToJsObject(bu.prepareForPostMessage(e));this._worker.postMessage({cmd:"alphaTab.renderScore",score:s,trackIndexes:bu.prepareForPostMessage(t),fontSizes:yo.fontSizeLookupTables})}},cl=class{constructor(e,t,s,i){this.cursorWrapper=e,this.barCursor=t,this.beatCursor=s,this.selectionWrapper=i}},ul=class extends nl{constructor(e,t,s){super(e),this._xscale=t,this._yscale=s}get width(){return this.element.offsetWidth/this._xscale}set width(e){this.element.style.width=e*this._xscale+"px"}get height(){return this.element.offsetHeight/this._yscale}set height(e){this.element.style.height=e>=0?e*this._yscale+"px":"100%"}setBounds(e,t,s,i){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s/=this._xscale,Number.isNaN(i)?i=this.lastBounds.h:i/=this._yscale,this.element.style.transform=`translate(${e}px, ${t}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=s,this.lastBounds.h=i}},pl=class{constructor(){this.sampleRate=44100,this._updateInterval=0,this.ready=new ds,this.samplesPlayed=new cs,this.timeUpdate=new cs,this.sampleRequest=new ds}get backingTrackDuration(){let e=this.audioElement.duration??0;return Number.isFinite(e)?1e3*e:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(e){this.audioElement.playbackRate=e}get masterVolume(){return this.audioElement.volume}set masterVolume(e){this.audioElement.volume=e}seekTo(e){this.audioElement.currentTime=e/1e3}loadBackingTrack(e){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);let t=new Blob([e.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(t),this.audioElement.playbackRate=s}open(e){let t=document.createElement("audio");t.style.display="none",document.body.appendChild(t),t.addEventListener("seeked",()=>{this._updatePosition()}),t.addEventListener("timeupdate",()=>{this._updatePosition()}),this.audioElement=t,this.ready.trigger()}_updatePosition(){let e=1e3*this.audioElement.currentTime;this.timeUpdate.trigger(e)}play(){this.audioElement.play(),this._updateInterval=window.setInterval(()=>{this._updatePosition()},50)}destroy(){let e=this.audioElement;e&&document.body.removeChild(e)}pause(){this.audioElement.pause(),window.clearInterval(this._updateInterval)}addSamples(e){}resetSamples(){}activate(){}async enumerateOutputDevices(){return Qi.enumerateOutputDevices()}async setOutputDevice(e){await Qi.checkSinkIdSupport()&&(e?await this.audioElement.setSinkId(e.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await Qi.checkSinkIdSupport())return null;let e=this.audioElement.sinkId;if("string"!=typeof e||""===e||"default"===e)return null;let t=Qi.findKnownDevice(e);if(t)return t;let s=await this.enumerateOutputDevices();return t=s.find(t=>t.deviceId===e),t||(re.warning("WebAudio","Could not find output device in device list",e,s),null)}},ml=class e{constructor(t,s){this._promise=null,this._exporterId=e._nextExporterId++,this._worker=t,this._ownsWorker=s}async initialize(e,t,s,i){let a=this.handleWorkerMessage.bind(this);this._worker.worker.addEventListener("message",a,!1),this._unsubscribe=()=>{this._worker.worker.removeEventListener("message",a,!1)},this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this._exporterId,options:bu.prepareForPostMessage(e),midi:po.midiFileToJsObject(bu.prepareForPostMessage(t)),syncPoints:bu.prepareForPostMessage(s),transpositionPitches:bu.prepareForPostMessage(i)}),await this._promise.promise}handleWorkerMessage(e){let t=e.data;if(t.exporterId===this._exporterId)switch(t.cmd){case"alphaSynth.exporter.initialized":this._promise?.resolve(null),this._promise=null;break;case"alphaSynth.exporter.error":this._promise?.reject(t.error),this._promise=null;break;case"alphaSynth.exporter.rendered":this._promise?.resolve(t.chunk),this._promise=null;break;case"alphaSynth.destroyed":this._promise?.reject(new u(0,"Worker was destroyed")),this._promise=null}}async render(e){if(this._promise)throw new u(0,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this._exporterId,milliseconds:e}),await this._promise.promise}destroy(){this._worker.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this._exporterId}),this._unsubscribe(),this._ownsWorker&&this._worker.destroy()}[Symbol.dispose](){this.destroy()}};ml._nextExporterId=1;var gl=ml,fl=class e{constructor(e){if(this._fontCheckers=new Map,this._contents=null,this._file=null,this._totalResultCount=0,this._initialTrackIndexes=null,this._barToElementLookup=new Map,this._resultIdToElementLookup=new Map,this.rootContainerBecameVisible=new ds,this.canRenderChanged=new ds,this._highlightedElements=[],this._scrollContainer=null,0!==bu.webPlatform&&2!==bu.webPlatform)throw new u(0,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");e.classList.add("alphaTab"),this.rootContainer=new nl(e),this.areWorkersSupported="Worker"in window,this._intersectionObserver=new IntersectionObserver(this._onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(e)}get resizeThrottle(){return 10}get canRender(){return this._areAllFontsLoaded()}_areAllFontsLoaded(){let e=!1;for(let t of this._fontCheckers.values())t.isFontLoaded||(e=!0);return!e&&(re.debug("Font",`All fonts loaded: ${this._fontCheckers.size}`),!0)}_onFontLoaded(e){yo.generateFontLookup(e),this._areAllFontsLoaded()&&this.canRenderChanged.trigger()}_onElementVisibilityChanged(e){for(let t of e){let e=t.target;if(e===this.rootContainer.element)t.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element));else if("layoutResultId"in e&&this._api.settings.core.enableLazyLoading){let s=e;t.isIntersecting?s.renderedResultId!==s.layoutResultId?this._resultIdToElementLookup.has(s.layoutResultId)?1!==s.resultState&&(s.resultState=1,this._api.renderer.renderResult(s.layoutResultId)):e.replaceChildren():3===s.resultState&&(e.replaceChildren(...s.renderedResult),s.resultState=2):2===s.resultState&&(s.resultState=3,s.replaceChildren())}}}createWorkerRenderer(){return new dl(this._api,this._api.settings)}initialize(e,t){let s;this._api=e,s=t instanceof On?t:po.jsObjectToSettings(t);let i=this._getDataAttributes();An.fromJson(s,i),1===s.notation.notationMode&&s.setSongBookModeSettings(),e.settings=s,this._setupFontCheckers(s),this._initialTrackIndexes=this.parseTracks(s.core.tracks),this._contents="";let a=e.container;s.core.tex&&(this._contents=a.element.innerHTML,a.element.innerHTML=""),this._createStyleElements(s),this._file=s.core.file}_setupFontCheckers(e){this._registerFontChecker(e.display.resources.copyrightFont),this._registerFontChecker(e.display.resources.effectFont),this._registerFontChecker(e.display.resources.graceFont),this._registerFontChecker(e.display.resources.markerFont),this._registerFontChecker(e.display.resources.tablatureFont),this._registerFontChecker(e.display.resources.titleFont),this._registerFontChecker(e.display.resources.wordsFont),this._registerFontChecker(e.display.resources.barNumberFont),this._registerFontChecker(e.display.resources.fretboardNumberFont),this._registerFontChecker(e.display.resources.subTitleFont)}_registerFontChecker(e){if(!this._fontCheckers.has(e.families.join(", "))){let t=new ol(e.families);this._fontCheckers.set(e.families.join(", "),t),t.fontLoaded.on(this._onFontLoaded.bind(this)),t.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML="";let t=this._webFont,s=this.rootContainer.element.ownerDocument,i=t.elements.get(s);i&&(i.usages--,i.usages<=0&&(i.element.remove(),t.elements.delete(s))),0===t.elements.size&&e._registeredWebFonts.delete(t.hash)}createCanvasElement(){let e=this.rootContainer.element.ownerDocument.createElement("div");return e.classList.add("at-surface",`at${this._webFont.fontSuffix}`),e.style.fontSize="0",e.style.overflow="hidden",e.style.lineHeight="0",e.style.position="relative",new nl(e)}triggerEvent(e,t,s=null,i){let a=e.element;t=`alphaTab.${t}`;let r=a.ownerDocument.createEvent("CustomEvent"),n=i?i.mouseEvent:null;if(r.initCustomEvent(t,!1,!1,s),n&&(r.originalEvent=n),a.dispatchEvent(r),window&&"jQuery"in window){let e=window.jQuery,i=[];i.push(s),n&&i.push(n),e(a).trigger(t,i)}}load(e,t,s){if(e instanceof Oe)return t(e),!0;if(e instanceof ArrayBuffer){let s=new Uint8Array(e);return t(il.loadScoreFromBytes(s,this._api.settings)),!0}return e instanceof Uint8Array?(t(il.loadScoreFromBytes(e,this._api.settings)),!0):"string"==typeof e&&(il.loadScoreAsync(e,t,s,this._api.settings),!0)}loadSoundFont(e,t){return!!this._api.player&&(e instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(e),t),!0):e instanceof Uint8Array?(this._api.player.loadSoundFont(e,t),!0):"string"==typeof e&&(this._api.loadSoundFontFromUrl(e,t),!0))}initialRender(){this._api.renderer.preRender.on(e=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});let e=()=>{this._api.renderer.width=0|this.rootContainer.width,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null):this._file&&il.loadScoreAsync(this._file,e=>{this._api.renderScore(e,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null},e=>{this._api.onError(e)},this._api.settings)};this.rootContainer.isVisible?e():this.rootContainerBecameVisible.on(e)}_createStyleElements(t){let s=this._api.container.element.ownerDocument;e.createSharedStyleElement(s);let i=t.core.smuflFontSources??_u.buildDefaultSmuflFontSources(t.core.fontDirectory),a=e._cyrb53(i.values()),r=e._registeredWebFonts;if(r.has(a)){let e=r.get(a);return e.checker.fontLoaded.on(this._onFontLoaded.bind(this)),this._createStyleElement(e,s),void(this._webFont=e)}let n=0===r.size?"":String(r.size),o=`alphaTab${n}`,l=`\n            @font-face {\n                font-display: block;\n                font-family: '${o}';\n                src: ${Array.from(i.entries()).map(t=>`url(${JSON.stringify(t[1])}) format('${e._cssFormat(t[0])}')`).join(",")};\n                font-weight: normal;\n                font-style: normal;\n            }\n            .at-surface.at${n} .at {\n                font-family: '${o}';\n                speak: none;\n                font-style: normal;\n                font-weight: normal;\n                font-variant: normal;\n                text-transform: none;\n                line-height: 1;\n                line-height: 1;\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n                font-size: ${t.display.resources.engravingSettings.musicFontSize}px;\n                overflow: visible !important;\n            }`,h=new ol([o]);h.fontLoaded.on(this._onFontLoaded.bind(this)),this._fontCheckers.set(o,h),h.checkForFontAvailability(),t.display.resources.smuflFontFamilyName=o;let d={hash:a,elements:new Map,fontSuffix:n,checker:h,cssSource:l};this._createStyleElement(d,s),r.set(a,d),this._webFont=d}_createStyleElement(e,t){if(e.elements.has(t))return void e.elements.get(t).usages++;let s=t.createElement("style");s.id=`alphaTabStyle${e.fontSuffix}`,s.innerHTML=e.cssSource,t.getElementsByTagName("head").item(0).appendChild(s),e.elements.set(t,{element:s,usages:1})}static _cssFormat(e){switch(e){case 0:return"embedded-opentype";case 1:return"woff";case 2:return"woff2";case 3:return"opentype";case 4:return"truetype";case 5:return"svg"}}static _cyrb53(e,t=0){let s=3735928559^t,i=1103547991^t;for(let t of e)for(let e=0;e<t.length;e++){let a=t.charCodeAt(e);s=Math.imul(s^a,2654435761),i=Math.imul(i^a,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(e){let t=e.getElementById("alphaTabStyle");if(!t){t=e.createElement("style"),t.id="alphaTabStyleShared";let s="\n                .at-surface * {\n                    cursor: default;\n                    vertical-align: top;\n                    overflow: visible;\n                }\n                .at-surface-svg text {\n                    dominant-baseline: alphabetic;\n                    white-space:pre;\n                }";t.innerHTML=s,e.getElementsByTagName("head").item(0).appendChild(t)}}parseTracks(e){if(!e)return[];let t=[];if("string"==typeof e)try{if("all"===e)return[-1];e=JSON.parse(e)}catch{e=[0]}if("number"==typeof e)t.push(e);else if("length"in e){let s=e.length,i=e;for(let e=0;e<s;e++){let s=i[e],a=0;a="number"==typeof s?s:"index"in s?s.index:Number.parseInt(s.toString(),10),(a>=0||-1===a)&&t.push(a)}}else"index"in e&&t.push(e.index);return t}_getDataAttributes(){let e=new Map,t=this._api.container.element;if(t.dataset)for(let s of Object.keys(t.dataset)){let i=t.dataset[s];try{i=JSON.parse(i)}catch{""===i&&(i=null)}e.set(s,i)}else for(let s=0;s<t.attributes.length;s++){let i=t.attributes.item(s),a=i.nodeName;if(a.startsWith("data-")){let t=a.substr(5).split("-"),s=t[0];for(let e=1;e<t.length;e++)s+=t[e].substr(0,1).toUpperCase()+t[e].substr(1);let r=i.nodeValue;try{r=JSON.parse(r)}catch{""===r&&(r=null)}e.set(s,r)}}return e}beginUpdateRenderResults(e){if(!this._resultIdToElementLookup.has(e.id))return;let t=this._resultIdToElementLookup.get(e.id),s=e.renderResult;"string"==typeof s?t.innerHTML=s:"nodeType"in s&&t.replaceChildren(s),t.resultState=2,t.renderedResultId=e.id,t.renderedResult=Array.from(t.children)}beginAppendRenderResults(e){let t=this._api.canvasElement.element;if(e){let s;this._totalResultCount<t.childElementCount?s=t.childNodes.item(this._totalResultCount):(s=document.createElement("div"),t.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${e.x}px`,s.style.top=`${e.y}px`,s.style.width=`${e.width}px`,s.style.height=`${e.height}px`,s.style.display="inline-block",s.layoutResultId=e.id,s.resultState=0,s.renderedResultId=void 0,s.renderedResult=void 0,this._resultIdToElementLookup.set(e.id,s);for(let t=e.firstMasterBarIndex;t<=e.lastMasterBarIndex;t++)t>=0&&this._barToElementLookup.set(t,s);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(s),this._intersectionObserver.observe(s)),this._totalResultCount++}else for(;t.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(t.lastChild),t.removeChild(t.lastElementChild)}createWorkerPlayer(){let e=null,t="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&0===this._api.settings.player.outputMode?(re.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),e=new hl(new aa(this._api.settings),this._api.settings)):t&&(re.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),e=new hl(new ll,this._api.settings)),e?e.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):re.error("Player","Player requires webworkers and web audio api, browser unsupported",null),e}createWorkerAudioExporter(e){let t=null===e||!(e instanceof hl);return t&&(e=this.createWorkerPlayer()),new gl(e,t)}beginInvoke(e){window.requestAnimationFrame(()=>{e()})}highlightElements(e,t){let s=this._barToElementLookup.get(t);if(s){let t=s.getElementsByClassName(e);for(let e=0;e<t.length;e++)t.item(e).classList.add("at-highlight"),this._highlightedElements.push(t.item(e))}}removeHighlights(){let e=this._highlightedElements;if(e){for(let t of e)t.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){let e=this._api.container.element,t=e.querySelector(".at-cursors");e.removeChild(t)}createCursors(){let e=this._api.container.element,t=document.createElement("div");t.classList.add("at-cursors");let s=document.createElement("div");s.classList.add("at-selection");let i=this.createScalingElement(),a=this.createScalingElement(),r=i.element;r.classList.add("at-cursor-bar");let n=a.element;return n.classList.add("at-cursor-beat"),e.style.position="relative",e.style.textAlign="left",t.style.position="absolute",t.style.zIndex="1000",t.style.display="inline",t.style.pointerEvents="none",s.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),n.style.position="absolute",n.style.transition="all 0s linear",n.style.left="0",n.style.top="0",n.style.willChange="transform",a.width=3,a.height=1,a.setBounds(0,0,1,1),e.insertBefore(t,e.firstChild),t.appendChild(s),t.appendChild(r),t.appendChild(n),new cl(new nl(t),i,a,new nl(s))}getOffset(e,t){let s=t.element,i=s.getBoundingClientRect(),a=i.top+s.ownerDocument.defaultView.pageYOffset,r=i.left+s.ownerDocument.defaultView.pageXOffset;if(e){let t=e.element,s=t.nodeName.toLowerCase();if("html"!==s&&"body"!==s){let s=this.getOffset(null,e);a=a+t.scrollTop-s.y,r=r+t.scrollLeft-s.x}}let n=new ms;return n.x=r,n.y=a,n.w=i.width,n.h=i.height,n}getScrollContainer(){if(this._scrollContainer)return this._scrollContainer;let e="string"==typeof this._api.settings.player.scrollElement?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement,t=e.nodeName.toLowerCase();return("html"===t||"body"===t)&&(e="scrollingElement"in document?document.scrollingElement:-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement),this._scrollContainer=new nl(e),this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){let e=document.createElement("div");e.style.position="absolute";let t=new ul(e,100,100);return t.width=1,t.height=1,t.setBounds(0,0,1,1),t}scrollToY(e,t,s){this._internalScrollToY(e.element,t,s)}scrollToX(e,t,s){this._internalScrollToX(e.element,t,s)}_internalScrollToY(e,t,s){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({top:t,behavior:"smooth"});else{let i=e.scrollTop,a=t-i,r=0,n=t=>{0===r&&(r=t);let o=t-r,l=Math.min(o/s,1);e.scrollTop=i+a*l|0,o<s&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)}}_internalScrollToX(e,t,s){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({left:t,behavior:"smooth"});else{let i=e.scrollLeft,a=t-i,r=0,n=t=>{0===r&&(r=t);let o=t-r,l=Math.min(o/s,1);e.scrollLeft=i+a*l|0,o<s&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)}}createBackingTrackPlayer(){return new jo(new pl,this._api.settings.player.bufferTimeInMilliseconds)}};fl._registeredWebFonts=new Map;var bl=fl,yl=class{constructor(e,t){this.loaded=e,this.total=t}},_l=class e extends tl{constructor(e,t){super(new bl(e),t),this.soundFontLoad=new cs}tex(e,t){let s=this.uiFacade;super.tex(e,s.parseTracks(t))}print(t,s=null){let i=window.open("","","width=0,height=0"),a=i.document.createElement("div");t?a.style.width=t:1===this.settings.display.layoutMode?a.style.width="297mm":a.style.width="210mm",i.document.write("\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <style>\n            .at-surface {\n                width: auto !important;\n                height: auto !important;\n            }\n            .at-surface > div {\n                position: relative!important;\n                left: auto !important;\n                top: auto !important;\n                break-inside: avoid;\n            }\n            </style>\n          </head>\n          <body></body>\n        </html>\n        ");let r=this.score;r&&(r.artist&&r.title?i.document.title=`${r.title} - ${r.artist}`:r.title&&(i.document.title=`${r.title}`)),i.document.body.appendChild(a);let n=typeof window.screenLeft<"u"?window.screenLeft:window.left,o=typeof window.screenTop<"u"?window.screenTop:window.top,l="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,h="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,d=a.offsetWidth+50,c=window.innerHeight,u=(l/2|0)-(d/2|0)+n,p=(h/2|0)-(c/2|0)+o;i.resizeTo(d,c),i.moveTo(u,p),i.focus();let m=po.jsObjectToSettings(po.settingsToJsObject(this.settings));m.core.enableLazyLoading=!1,m.core.useWorkers=!0,m.core.file=null,m.core.tracks=null,m.player.enableCursor=!1,m.player.playerMode=0,m.player.enableElementHighlighting=!1,m.player.enableUserInteraction=!1,m.player.soundFont=null,m.display.scale=.8,m.display.stretchForce=.8,An.fromJson(m,s);let g=new e(a,m);i.onunload=()=>{g.destroy()},g.renderer.postRenderFinished.on(()=>{i.print()}),g.renderTracks(this.tracks)}downloadMidi(e=0){if(!this.score)return;let t=new oa;t.format=e;let s=new ko(t,!0);new Ao(this.score,this.settings,s).generate();let i=t.toBinary(),a=this.score.title?`${this.score.title}.mid`:"File.mid",r=document.createElement("a");r.download=a;let n=new Blob([i],{type:"audio/midi"}),o=URL.createObjectURL(n);r.href=o,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}changeTrackMute(e,t){let s=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(s,t)}changeTrackSolo(e,t){let s=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(s,t)}changeTrackVolume(e,t){let s=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(s,t)}_trackIndexesToTracks(e){if(!this.score)return[];let t=[];if(1===e.length&&-1===e[0])for(let e of this.score.tracks)t.push(e);else for(let s of e)s>=0&&s<this.score.tracks.length&&t.push(this.score.tracks[s]);return t}loadSoundFontFromUrl(e,t){let s=this.player;if(!s)return;re.debug("AlphaSynth",`Start loading Soundfont from url ${e}`);let i=new XMLHttpRequest;i.open("GET",e,!0,null,null),i.responseType="arraybuffer",i.onload=e=>{let s=new Uint8Array(i.response);this.loadSoundFont(s,t)},i.onerror=e=>{re.error("AlphaSynth",`Loading failed: ${e.message}`),s.soundFontLoadFailed.trigger(new sl(e.message,i))},i.onprogress=e=>{re.debug("AlphaSynth",`Soundfont downloading: ${e.loaded}/${e.total} bytes`);let t=new yl(e.loaded,e.total);this.soundFontLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"soundFontLoad",t)},i.send()}},Sl=class{constructor(){this._initListeners=[]}exec(e,t,s){if("string"!=typeof t&&(s=[t],t="init"),95===t.charCodeAt(0)||"exec"===t)return null;let i=new jQuery(e),a=i.data("alphaTab");if("destroy"===t&&!a)return null;if("init"!==t&&!a)throw new Error("alphaTab not initialized");let r=this[t];if(r){let e=[i,a].concat(s);return r.apply(this,e)}return re.error("Api",`Method '${t}' does not exist on jQuery.alphaTab`),null}init(e,t,s){if(!t){t=new _l(e[0],s),e.data("alphaTab",t);for(let i of this._initListeners)i(e,t,s)}}destroy(e,t){e.removeData("alphaTab"),t.destroy()}print(e,t,s,i){t.print(s,i)}load(e,t,s,i){return t.load(s,i)}render(e,t){t.render()}renderScore(e,t,s,i){t.renderScore(s,i)}renderTracks(e,t,s){t.renderTracks(s)}invalidate(e,t){t.render()}tex(e,t,s,i){t.tex(s,i)}muteTrack(e,t,s,i){t.changeTrackMute(s,i)}soloTrack(e,t,s,i){t.changeTrackSolo(s,i)}trackVolume(e,t,s,i){t.changeTrackVolume(s,i)}loadSoundFont(e,t,s,i){t.loadSoundFont(s,i)}resetSoundFonts(e,t){t.resetSoundFonts()}pause(e,t){t.pause()}play(e,t){return t.play()}playPause(e,t){t.playPause()}stop(e,t){t.stop()}api(e,t){return t}player(e,t){return t.player}isReadyForPlayback(e,t){return t.isReadyForPlayback}playerState(e,t){return t.playerState}masterVolume(e,t,s){return"number"==typeof s&&(t.masterVolume=s),t.masterVolume}metronomeVolume(e,t,s){return"number"==typeof s&&(t.metronomeVolume=s),t.metronomeVolume}countInVolume(e,t,s){return"number"==typeof s&&(t.countInVolume=s),t.countInVolume}midiEventsPlayedFilter(e,t,s){return Array.isArray(s)&&(t.midiEventsPlayedFilter=s),t.midiEventsPlayedFilter}playbackSpeed(e,t,s){return"number"==typeof s&&(t.playbackSpeed=s),t.playbackSpeed}tickPosition(e,t,s){return"number"==typeof s&&(t.tickPosition=s),t.tickPosition}timePosition(e,t,s){return"number"==typeof s&&(t.timePosition=s),t.timePosition}loop(e,t,s){return"boolean"==typeof s&&(t.isLooping=s),t.isLooping}renderer(e,t){return t.renderer}score(e,t){return t.score}settings(e,t){return t.settings}tracks(e,t){return t.tracks}_oninit(e){this._initListeners.push(e)}static restore(e){new jQuery(e).empty().removeData("alphaTab")}},kl=class e{constructor(){this._color=new Jt(0,0,0,0),this._lineWidth=0,this._textStyle=null,this._scale=1,this._textStyles=new Map,this._font=new ln("Arial",10,0),this._musicTextStyle=null,this.textAlign=0,this.textBaseline=0,this._canvas=new e._alphaSkia.AlphaSkiaCanvas,this.color=new Jt(0,0,0,255)}static enable(t,s){e._alphaSkia=s,e.initializeMusicFont(e._alphaSkia.AlphaSkiaTypeface.register(t))}static initializeMusicFont(t){e._defaultMusicTextStyle=new e._alphaSkia.AlphaSkiaTextStyle([t.familyName],t.weight,t.isItalic)}static registerFont(t,s){let i=e._alphaSkia.AlphaSkiaTypeface.register(t.buffer);return s||(s=ln.withFamilyList([i.familyName],12,i.isItalic?1:0,i.weight>400?1:0)),s}get font(){return this._font}set font(t){if(this._font===t)return;this._font=t;let s=this._textStyleKey(t);if(this._textStyles.has(s))this._textStyle=this._textStyles.get(s);else{let i=new e._alphaSkia.AlphaSkiaTextStyle(t.families,1===t.weight?700:400,t.isItalic);this._textStyles.set(s,i),this._textStyle=i}}_textStyleKey(e){return[...e.families,e.weight.toString(),e.isItalic?"italic":"upright"].join("_")}destroy(){this._canvas[Symbol.dispose]();for(let e of this._textStyles.values())e[Symbol.dispose]()}onRenderFinished(){return null}beginRender(t,s){this._scale=this.settings.display.scale,this._canvas.beginRender(t,s,bu.highDpiFactor);let i=this.settings.display.resources.smuflFontFamilyName;i&&i!==e._defaultMusicTextStyle.familyNames[0]?this._textStyles.has(i)?this._musicTextStyle=this._textStyles.get(i):(this._musicTextStyle=new e._alphaSkia.AlphaSkiaTextStyle([i],e._defaultMusicTextStyle.weight,e._defaultMusicTextStyle.isItalic),this._textStyles.set(i,this._musicTextStyle)):this._musicTextStyle=e._defaultMusicTextStyle}endRender(){return this._canvas.endRender()}get color(){return this._color}set color(t){this._color.rgba!==t.rgba&&(this._color=t,this._canvas.color=e._alphaSkia.AlphaSkiaCanvas.rgbaToColor(t.r,t.g,t.b,t.a))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._canvas.lineWidth=e}fillRect(e,t,s,i){s>0&&this._canvas.fillRect(e*this._scale,t*this._scale,s*this._scale,i*this._scale)}strokeRect(e,t,s,i){let a=this.lineWidth%2==0?0:.5;this._canvas.strokeRect(e*this._scale+a,t*this._scale+a,s*this._scale,i*this._scale)}beginPath(){this._canvas.beginPath()}closePath(){this._canvas.closePath()}moveTo(e,t){this._canvas.moveTo(e*this._scale,t*this._scale)}lineTo(e,t){this._canvas.lineTo(e*this._scale,t*this._scale)}quadraticCurveTo(e,t,s,i){this._canvas.quadraticCurveTo(e*this._scale,t*this._scale,s*this._scale,i*this._scale)}bezierCurveTo(e,t,s,i,a,r){this._canvas.bezierCurveTo(e*this._scale,t*this._scale,s*this._scale,i*this._scale,a*this._scale,r*this._scale)}fillCircle(e,t,s){this._canvas.fillCircle(e*this._scale,t*this._scale,s*this._scale)}strokeCircle(e,t,s){this._canvas.strokeCircle(e*this._scale,t*this._scale,s*this._scale)}fill(){this._canvas.fill()}stroke(){this._canvas.stroke()}beginGroup(e){}endGroup(){}fillText(t,s,i){if(0===t.length)return;let a=e._alphaSkia.AlphaSkiaTextAlign.Left;switch(this.textAlign){case 0:a=e._alphaSkia.AlphaSkiaTextAlign.Left;break;case 1:a=e._alphaSkia.AlphaSkiaTextAlign.Center;break;case 2:a=e._alphaSkia.AlphaSkiaTextAlign.Right}let r=e._alphaSkia.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case 0:r=e._alphaSkia.AlphaSkiaTextBaseline.Top;break;case 1:r=e._alphaSkia.AlphaSkiaTextBaseline.Middle;break;case 2:r=e._alphaSkia.AlphaSkiaTextBaseline.Bottom;break;case 3:r=e._alphaSkia.AlphaSkiaTextBaseline.Alphabetic}this._canvas.fillText(t,this._textStyle,this._font.size*this._scale,s*this._scale,i*this._scale,a,r)}measureText(t){var s=[];try{let i=o(s,this._canvas.measureText(t,this._textStyle,this._font.size,e._alphaSkia.AlphaSkiaTextAlign.Left,e._alphaSkia.AlphaSkiaTextBaseline.Alphabetic)),[a,r]=this._getTextWidthAndHeight(i,t);return new Ce(a,r)}catch(e){var i=e,a=!0}finally{l(s,i,a)}}_getTextWidthAndHeight(e,t){let s=e.width;if(t.length>0&&s<1)for(let t=0;t<5&&(s=e.width,!(s>1));t++);return[s,e.actualBoundingBoxAscent+e.actualBoundingBoxDescent]}fillMusicFontSymbol(e,t,s,i,a){-1!==i&&this._fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),a)}fillMusicFontSymbols(e,t,s,i,a){let r="";for(let e of i)-1!==e&&(r+=String.fromCharCode(e));this._fillMusicFontSymbolText(e,t,s,r,a)}_fillMusicFontSymbolText(t,s,i,a,r){this._canvas.fillText(a,this._musicTextStyle,this.settings.display.resources.engravingSettings.musicFontSize*this._scale*i,t*this._scale,s*this._scale,r?e._alphaSkia.AlphaSkiaTextAlign.Center:e._alphaSkia.AlphaSkiaTextAlign.Left,e._alphaSkia.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(e,t,s){this._canvas.beginRotate(e*this._scale,t*this._scale,s)}endRotate(){this._canvas.endRotate()}};kl._defaultMusicTextStyle=null;var wl=kl,Tl=class e{constructor(){this.buffer="",this._currentPath="",this._currentPathIsEmpty=!0,this.scale=1,this.color=new Jt(255,255,255,255),this.lineWidth=1,this.font=new ln("Arial",10,0),this.textAlign=0,this.textBaseline=0}destroy(){}beginRender(e,t){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|e}px" height="${0|t}px" class="at-surface-svg">\n`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=0}beginGroup(e){this.buffer+=`<g class="${e}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(e,t,s,i){s>0&&(this.buffer+=`<rect x="${e*this.scale}" y="${t*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />\n`)}strokeRect(e,t,s,i){let a=this.lineWidth*this.scale%2==0?0:.5;this.buffer+=`<rect x="${e*this.scale+a}" y="${t*this.scale+a}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(e,t){this._currentPath+=` M${e*this.scale},${t*this.scale}`}lineTo(e,t){this._currentPathIsEmpty=!1,this._currentPath+=` L${e*this.scale},${t*this.scale}`}quadraticCurveTo(e,t,s,i){this._currentPathIsEmpty=!1,this._currentPath+=` Q${e*this.scale},${t*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(e,t,s,i,a,r){this._currentPathIsEmpty=!1,this._currentPath+=` C${e*this.scale},${t*this.scale},${s*this.scale},${i*this.scale},${a*this.scale},${r*this.scale}`}fillCircle(e,t,s){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,s*=this.scale,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.fill()}strokeCircle(e,t,s){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,s*=this.scale,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let e=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;(1!==this.lineWidth||1!==this.scale)&&(e+=` stroke-width="${this.lineWidth*this.scale}"`),e+=' style="fill: none" />',this.buffer+=e}this._currentPath="",this._currentPathIsEmpty=!0}fillText(t,s,i){if(""===t)return;let a=`<text x="${s*this.scale}" y="${i*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(a+=` fill="${this.color.rgba}"`),0!==this.textAlign&&(a+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),a+=`>${e._escapeText(t)}</text>`,this.buffer+=a}static _escapeText(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(e){switch(e){case 0:return"start";case 1:return"middle";case 2:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case 0:return"dominant-baseline: hanging";case 2:return"dominant-baseline: ideographic";case 3:default:return"";case 1:return"dominant-baseline: middle"}}measureText(e){return e?yo.measureString(e,this.font.families,this.font.size,this.font.style,this.font.weight):new Ce(0,0)}onRenderFinished(){return null}beginRotate(e,t,s){this.buffer+=`<g transform="translate(${e*this.scale} ,${t*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}},Bl=class extends Tl{fillMusicFontSymbol(e,t,s,i,a){-1!==i&&this._fillMusicFontSymbolText(e,t,s,`&#${i};`,a)}fillMusicFontSymbols(e,t,s,i,a){let r="";for(let e of i)-1!==e&&(r+=`&#${e};`);this._fillMusicFontSymbolText(e,t,s,r,a)}_fillMusicFontSymbolText(e,t,s,i,a){e*=this.scale,t*=this.scale,this.buffer+=`<g transform="translate(${e} ${t})" class="at" ><text`;let r=this.scale*s;this.buffer+=1!==r?` style="font-size: ${100*r}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),a&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(1)}"`),this.buffer+=`>${i}</text></g>`}},xl=class{constructor(){this.isInsideBracket=!0,this.isRelevantForBoundsLookup=!0,this.hideOnMultiTrack=!1,this.hideOnPercussionTrack=!1}canCreate(e,t){return!this.hideOnPercussionTrack||!t.isPercussion}},vl=class extends Oo{constructor(){super(...arguments),this.glyphs=null}get isEmpty(){return!this.glyphs||0===this.glyphs.length}getBoundingBoxTop(){let e=0,t=this.glyphs;if(t)for(let s of t){let t=s.getBoundingBoxTop();t<e&&(e=t)}return e}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);let e=0,t=0;for(let s=0,i=this.glyphs.length;s<i;s++){let i=this.glyphs[s];i.renderer=this.renderer,i.doLayout(),e=Math.max(e,i.width),t=Math.max(t,i.y+i.height)}this.width=e,this.height=t}addGlyph(e){this.glyphs||(this.glyphs=[]),this.renderer&&(e.renderer=this.renderer),this.glyphs.push(e)}paint(e,t,s){let i=this.glyphs;if(i&&0!==i.length)for(let a of i)a.paint(e+this.x,t+this.y,s)}},Pl=class extends vl{constructor(){super(0,0),this.gap=0,this.glyphs=[]}doLayout(){}addGlyph(e){e.x=this.width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width+this.gap,super.addGlyph(e)}},Nl=class e{static score(t,s,i,a=!1){if(!i.style&&!a)return;let r=e._scoreDefaultColor(t.settings.display.resources,s);return new Ml(t,s,i.style,r)}static scoreColor(t,s,i){let a=e._scoreDefaultColor(t,s);if(i.style&&i.style.colors.has(s))return i.style.colors.get(s)??a}static _scoreDefaultColor(e,t){return e.mainGlyphColor}static bar(e,t,s,i=!1){if(!s.style&&!i)return;let a=e.settings.display.resources.mainGlyphColor;switch(t){case 0:case 1:case 2:case 3:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:break;case 8:case 9:case 10:case 11:a=e.settings.display.resources.barSeparatorColor;break;case 4:case 6:case 7:case 5:a=e.settings.display.resources.barNumberColor;break;case 20:case 21:case 22:case 23:a=e.settings.display.resources.staffLineColor}return new Ml(e,t,s.style,a)}static voice(e,t,s,i=!1){if(!s.style&&!i)return;let a=0===s.index?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor;return new Ml(e,t,s.style,a)}static trackColor(t,s,i){let a=e._trackDefaultColor(t,s);if(i.style&&i.style.colors.has(s))return i.style.colors.get(s)??a}static _trackDefaultColor(e,t){let s=e.mainGlyphColor;switch(t){case 0:case 2:case 3:break;case 1:s=e.barSeparatorColor}return s}static track(t,s,i,a=!1){if(!i.style&&!a)return;let r=e._trackDefaultColor(t.settings.display.resources,s);return new Ml(t,s,i.style,r)}static beatColor(t,s,i){let a=e._beatDefaultColor(t,s,i);if(i.style&&i.style.colors.has(s))return i.style.colors.get(s)??a}static _beatDefaultColor(e,t,s){return 0===s.voice.index?e.mainGlyphColor:e.secondaryGlyphColor}static beat(t,s,i,a=!1){if(!i.style&&!a)return;let r=e._beatDefaultColor(t.settings.display.resources,s,i);return new Ml(t,s,i.style,r)}static noteColor(t,s,i){let a=e._noteDefaultColor(t,s,i);if(i.style&&i.style.colors.has(s))return i.style.colors.get(s)??a}static _noteDefaultColor(e,t,s){return 0===s.beat.voice.index?e.mainGlyphColor:e.secondaryGlyphColor}static note(e,t,s,i=!1){if(!s.style&&!i)return;let a=0===s.beat.voice.index?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor;return new Ml(e,t,s.style,a)}},Ml=class{constructor(e,t,s,i){this._canvas=e,s&&s.colors.has(t)?(this._previousColor=e.color,e.color=s.colors.get(t)??i):s||(this._previousColor=e.color,e.color=i)}[Symbol.dispose](){this._previousColor&&(this._canvas.color=this._previousColor)}},El=class extends vl{constructor(e,t,s){super(e,t),this.voice=s,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){let t=this.renderer.layoutingInfo.spaceToForce(e);this._scaleToForce(t)}_scaleToForce(e){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e);let t=this.renderer.layoutingInfo.buildOnTimePositions(e),s=this.beatGlyphs;for(let e=0,i=s.length;e<i;e++){let a=s[e];if(0===a.beat.graceType)a.x=t.get(a.beat.absoluteDisplayStart)-a.onTimeX;else{let i=a.beat.graceGroup.beats[0].absoluteDisplayStart,r=a.beat.graceGroup.id;if(a.beat.graceGroup.isComplete&&t.has(i)){a.x=t.get(i)-a.onTimeX;let e=this.renderer.layoutingInfo.allGraceRods.get(r),s=a.beat.graceGroup.beats[a.beat.graceGroup.beats.length-1].nextBeat,n=s?this.renderer.layoutingInfo.getPreBeatSize(s):0;a.x-=n,a.x-=e[a.beat.graceIndex].postSpringWidth,a.x+=e[a.beat.graceIndex].graceBeatWidth;let o=e[a.beat.graceGroup.beats.length-1];a.x-=o.graceBeatWidth}else{let t=this.renderer.layoutingInfo.incompleteGraceRods.get(r),i=t[a.beat.graceIndex].postSpringWidth-t[a.beat.graceIndex].preSpringWidth;e>0?0===a.beat.graceIndex?a.x=s[e-1].x+s[e-1].width:a.x=s[e-1].x+t[a.beat.graceIndex-1].postSpringWidth-t[a.beat.graceIndex-1].preSpringWidth-i:a.x=-i}}if(e>0){let t=a.x-s[e-1].x;s[e-1].scaleToWidth(t)}if(e===i-1){let e=this.width-s[s.length-1].x;a.scaleToWidth(e)}}}registerLayoutingInfo(e){let t=this.beatGlyphs;for(let s of t)s.registerLayoutingInfo(e)}applyLayoutingInfo(e){let t=this.beatGlyphs;for(let s of t)s.applyLayoutingInfo(e);this._scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){let t=e;e.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(t),this.width=e.x+e.width,t.beat.hasTuplet&&t.beat.tupletGroup.beats[0].id===t.beat.id&&this.tupletGroups.push(t.beat.tupletGroup)}doLayout(){}paint(e,t,s){var i=[];try{o(i,Nl.voice(s,0,this.voice,!0));for(let i=0,a=this.beatGlyphs.length;i<a;i++)this.beatGlyphs[i].paint(e+this.x,t+this.y,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}};El.KeySizeBeat="Beat";var Ll=class{constructor(){this.staffId="",this.up=0,this.down=0}},Cl=class{constructor(){this.startBeat=null,this.startX=0,this.startY=0,this.endBeat=null,this.endX=0,this.endY=0}calcY(e){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(e-this.startX)+this.startY}},Fl=class e{constructor(e,t){this._beatLineXPositions=new Map,this._firstNonRestBeat=null,this._lastNonRestBeat=null,this.voice=null,this.beats=[],this.shortestDuration=-4,this.hasTuplet=!1,this.slashBeats=[],this.lowestNoteInHelper=null,this._lowestNoteCompareValueInHelper=-1,this.highestNoteInHelper=null,this._highestNoteCompareValueInHelper=-1,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.graceType=0,this.minRestLine=null,this.beatOfMinRestLine=null,this.maxRestLine=null,this.beatOfMaxRestLine=null,this.direction=0,this.drawingInfos=new Map,this._staff=e,this._renderer=t,this.beats=[]}get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasLine(e,t){return e&&this._beatHasLine(t)||!e&&1===this.beats.length&&this._beatHasLine(t)}_beatHasLine(e){return Math.abs(e.duration)>1}hasFlag(e,t){return e&&this._beatHasFlag(t)||!e&&1===this.beats.length&&this._beatHasFlag(this.beats[0])}_beatHasFlag(e){return!e.deadSlapped&&!e.isRest&&(e.duration>4||0!==e.graceType)}getBeatLineX(e,t){return t=t??this.direction,this.hasBeatLineX(e)?0===t?this._beatLineXPositions.get(e.index).up:this._beatLineXPositions.get(e.index).down:0}hasBeatLineX(e){return this._beatLineXPositions.has(e.index)}registerBeatLineX(e,t,s,i){let a=this._getOrCreateBeatPositions(t);a.staffId=e,a.up=s,a.down=i;for(let e of this.drawingInfos.values())e.startBeat===t?e.startX=this.getBeatLineX(t):e.endBeat===t&&(e.endX=this.getBeatLineX(t))}_getOrCreateBeatPositions(e){return this._beatLineXPositions.has(e.index)||this._beatLineXPositions.set(e.index,new Ll),this._beatLineXPositions.get(e.index)}finish(){this.direction=this._calculateDirection(),this._renderer.completeBeamingHelper(this)}_calculateDirection(){if(!this.voice)return 0;if(null!==this.preferredBeamDirection)return this.preferredBeamDirection;if(this.voice.index>0)return this._invert(1);if(this.voice.bar.isMultiVoice)return this._invert(0);if(0!==this.beats[0].graceType)return this._invert(0);if(this.highestNoteInHelper&&this.lowestNoteInHelper){let e=(this._renderer.getNoteY(this.highestNoteInHelper,2)+this._renderer.getNoteY(this.lowestNoteInHelper,2))/2;return this._invert(this._renderer.middleYPosition<e?0:1)}return this._invert(0)}static computeLineHeightsForRest(e){switch(e){case-4:case-2:return[2,2];case 1:return[0,1];case 2:return[1,0];case 4:return[3,3];case 8:return[2,2];case 16:return[2,4];case 32:return[4,4];case 64:return[4,6];case 128:return[6,6];case 256:return[6,8]}return[0,0]}applyRest(t,s){if(this._lastNonRestBeat&&t.index>=this._lastNonRestBeat.index||this._firstNonRestBeat&&t.index<=this._firstNonRestBeat.index)return;let i=s,a=s,r=e.computeLineHeightsForRest(t.duration);i-=r[0],a+=r[1];let n=this.minRestLine,o=this.maxRestLine;(null===n||n>i)&&(this.minRestLine=i,this.beatOfMinRestLine=t),(null===o||o<a)&&(this.maxRestLine=a,this.beatOfMaxRestLine=t)}_invert(e){return this.invertBeamDirection?1===e?0:1:e}checkBeat(t){t.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=t.voice);let s=!1;if(0===this.beats.length)s=!0;else switch(this.beats[this.beats.length-1].beamingMode){case 0:case 3:s=e._canJoin(this.beats[this.beats.length-1],t);break;case 1:s=!1;break;case 2:s=!0}return s&&(null==this.preferredBeamDirection&&null!==t.preferredBeamDirection&&(this.preferredBeamDirection=t.preferredBeamDirection),t.hasTuplet&&(this.hasTuplet=!0),t.isTremolo&&(!this.tremoloDuration||this.tremoloDuration<t.tremoloSpeed)&&(this.tremoloDuration=t.tremoloSpeed),0!==t.graceType&&(this.graceType=t.graceType),t.isRest?this.beats.push(t):(this.beats.push(t),this._checkNote(t.minNote),this._checkNote(t.maxNote),this.shortestDuration<t.duration&&(this.shortestDuration=t.duration),this._firstNonRestBeat||(this._firstNonRestBeat=t),this._lastNonRestBeat=t),t.slashed&&this.slashBeats.push(t)),s}_checkNote(e){if(!e)return;let t,s;this.voice&&e.isPercussion?(t=-Wi.getPercussionLine(this.voice.bar,Wi.getNoteValue(e)),s=t):(t=Wi.getNoteValue(e),s=t,0!==e.harmonicType&&1!==e.harmonicType&&(s=e.realValue-this._staff.displayTranspositionPitch)),(!this.lowestNoteInHelper||t<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=e,this._lowestNoteCompareValueInHelper=t),(!this.highestNoteInHelper||s>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=e,this._highestNoteCompareValueInHelper=s)}static _canJoin(t,s){if(!t||!s||t.graceType!==s.graceType||3===t.graceType||3===s.graceType||t.deadSlapped||s.deadSlapped)return!1;if(0!==t.graceType&&0!==s.graceType)return!0;let i=t.voice.bar;if(i!==s.voice.bar)return!1;let a=t.playbackStart,r=s.playbackStart;if(!e._canJoinDuration(t.duration)||!e._canJoinDuration(s.duration))return a===r;if(t.tupletGroup!==s.tupletGroup)return!1;if(t.hasTuplet&&s.hasTuplet&&t.tupletGroup===s.tupletGroup&&t.tupletGroup.isFull)return!0;let n=_.QuarterTime;return 8===i.masterBar.timeSignatureDenominator&&i.masterBar.timeSignatureNumerator%3==0&&(n+=_.QuarterTime/2|0),((n+a)/n|0)===((n+r)/n|0)}static _canJoinDuration(e){switch(e){case 1:case 2:case 4:return!1;default:return!0}}static isFullBarJoin(e,t,s){return qe.getIndex(e.duration)-2-s>0&&qe.getIndex(t.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(e,t){return!this._beatLineXPositions.has(t.index)||(this._beatLineXPositions.get(t.index).staffId===e||!this._beatLineXPositions.get(t.index).staffId)}},Dl=class{constructor(e,t){this.topY=0,this.bottomY=0,this.topY=e,this.bottomY=t}},Il=class{constructor(e){this.topY=-1e3,this.bottomY=-1e3,this.slots=[],this.beat=e}addSlot(e,t){if(this.slots.push(new Dl(e,t)),-1e3===this.topY)this.topY=e,this.bottomY=t;else{let s=Math.min(e,t),i=Math.max(e,t);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}},Al=class{constructor(){this.reservedLayoutAreasByDisplayTime=new Map,this.restDurationsByDisplayTime=new Map}getBeatMinMaxY(){let e=-1e3,t=-1e3;for(let s of this.reservedLayoutAreasByDisplayTime.values())-1e3===e?(e=s.topY,t=s.bottomY):(e>s.topY&&(e=s.topY),t<s.bottomY&&(t=s.bottomY));return-1e3===e?[0,0]:[e,t]}reserveBeatSlot(e,t,s){t!==s&&(this.reservedLayoutAreasByDisplayTime.has(e.displayStart)||this.reservedLayoutAreasByDisplayTime.set(e.displayStart,new Il(e)),this.reservedLayoutAreasByDisplayTime.get(e.displayStart).addSlot(t,s),e.isRest&&this.registerRest(e))}registerRest(e){this.restDurationsByDisplayTime.has(e.displayStart)||this.restDurationsByDisplayTime.set(e.displayStart,new Map),this.restDurationsByDisplayTime.get(e.displayStart).has(e.playbackDuration)||this.restDurationsByDisplayTime.get(e.displayStart).set(e.playbackDuration,e.id)}applyRestCollisionOffset(e,t,s){if(e.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(e.playbackStart)){let i=Fl.computeLineHeightsForRest(e.duration).map(e=>e*s),a=t-i[0],r=t+i[1],n=a,o=this.reservedLayoutAreasByDisplayTime.get(e.playbackStart),l=!1;for(let e of o.slots)if(a>=e.topY&&a<=e.bottomY||r>=e.topY&&r<=e.bottomY){l=!0;break}if(l){n=1===e.voice.index?o.topY-i[1]-i[0]:o.bottomY;let t=n+i[0]+i[1],r=2*s,l=Math.ceil(Math.abs(n-a)/r);return o.addSlot(n,t),n<a?l*-r:l*r}}return 0}},Rl=class{constructor(e){this.beamHelpers=[],this.beamHelperLookup=[],this.preferredBeamDirection=null,this._renderer=e,this.collisionHelper=new Al}initialize(){let e=this._renderer,t=this._renderer.bar,s=null,i=null;for(let a=0,r=t.voices.length;a<r;a++){let r=t.voices[a];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let a=0,n=r.beats.length;a<n;a++){let n,o=r.beats[a];0!==o.graceType?n=i:(n=s,i=null),(!n||!n.checkBeat(o))&&(n&&n.finish(),n=new Fl(t.staff,e),n.preferredBeamDirection=this.preferredBeamDirection,n.checkBeat(o),0!==o.graceType?i=n:s=n,this.beamHelpers[r.index].push(n)),this.beamHelperLookup[r.index].set(o.index,n)}s&&s.finish(),i&&i.finish(),s=null,i=null}}getBeamingHelperForBeat(e){return this.beamHelperLookup[e.voice.index].get(e.index)}},Ol=class extends Vo{constructor(e,t,s){super(e,t),this._textRow=0,this._fretRow=0,this._firstFretSpacing=0,this._chord=s}doLayout(){super.doLayout();let e=2*this.renderer.resources.effectFont.size*.4;this._textRow=.72*e,this._fretRow=.5*e,this._chord.firstFret>1?this._firstFretSpacing=.8*e:this._firstFretSpacing=0;let t=.8*e,s=4*e;this.height=this._textRow+.5*e+s+.5*e,this.width=this._firstFretSpacing+(this._chord.strings.length-1)*t+e}paint(e,t,s){let i=s.color,a=s.font,r=s.textAlign,n=s.textBaseline,o=s.lineWidth,l=this.renderer.resources,h=2*l.effectFont.size*.4,d=.8*h,c=new Jt(200,119,118),u=new Jt(0,0,0,255),p=h/20,m=.62*h-.95,g=.31*h,f=.2*h;e+=this.x,t+=this.y;let b=e,y=(this._chord.strings.length-1)*d,_=b-y/2,S=t+this._textRow+.5*h;this._chord.showName&&(s.textAlign=1,s.textBaseline=1,s.font=ln.withFamilyList(["Arial","sans-serif"],1.7*h/3*2.5,l.effectFont.style,1),s.color=c,s.fillText(this._chord.name,b,t+.72*h/2)),this._chord.firstFret>1&&(s.textAlign=1,s.textBaseline=1,s.font=ln.withFamilyList(l.effectFont.families,.8*h/3*2.5+5,l.effectFont.style,l.effectFont.weight),s.color=u,s.fillText(this._chord.firstFret.toString(),_-this._firstFretSpacing/2-2.5,S+.6*h)),s.color=u,s.lineWidth=p;for(let e=0;e<this._chord.strings.length;e++){let t=_+e*d;s.beginPath(),s.moveTo(t,S),s.lineTo(t,S+4*h),s.stroke()}for(let e=0;e<5;e++){let t=S+e*h;s.beginPath(),s.moveTo(_,t),s.lineTo(_+y,t),s.stroke()}s.lineWidth=.1*h;for(let e=0;e<this._chord.strings.length;e++){let t=_+(this._chord.strings.length-1-e)*d;if(-1===this._chord.strings[e]){let e=S-.2*h;s.beginPath(),s.moveTo(t-f,e-f),s.lineTo(t+f,e+f),s.stroke(),s.beginPath(),s.moveTo(t-f,e+f),s.lineTo(t+f,e-f),s.stroke()}}let k=new Map;for(let e of this._chord.barreFrets){let t=[-1,-1];k.set(e-this._chord.firstFret,t)}let w=[];for(let e=0;e<this._chord.strings.length;e++){let t=this._chord.strings[e];if(t>0){let s=S+(t-(this._chord.firstFret-1)-1)*h+.5*h,i=_+(this._chord.strings.length-1-e)*d;w.push({x:i,y:s});let a=t-this._chord.firstFret;if(k.has(a)){let t=k.get(a);(-1===t[0]||e<t[0])&&(t[0]=e),(-1===t[1]||e>t[1])&&(t[1]=e)}}}s.lineWidth=m,s.beginPath();for(let[e,t]of k){let i=S+(e+1-1)*h+.5*h,a=t[0],r=t[1];if(-1!==a&&-1!==r){let e=_+(this._chord.strings.length-1-a)*d,t=_+(this._chord.strings.length-1-r)*d;s.beginPath(),s.moveTo(e,i),s.lineTo(t,i),s.stroke()}}s.color=u;for(let e of w)s.fillCircle(e.x,e.y,g);s.color=i,s.font=a,s.textAlign=r,s.textBaseline=n,s.lineWidth=o}};Ol._frets=5;var Vl=class extends vl{constructor(e,t,s=1){super(e,t),this._glyphWidth=0,this.glyphs=[],this._align=s}doLayout(){let e=this.renderer.smuflMetrics.rowContainerGap,t=this._glyphWidth-e,s=0;switch(this._align){case 0:s=0;break;case 1:s=(this.width-t)/2;break;case 2:s=this.width-t}for(let t of this.glyphs)t.x=s,s+=t.width+e}addGlyphToRow(e){this.glyphs.push(e),this._glyphWidth+=e.width+this.renderer.smuflMetrics.rowContainerGap,e.height>this.height&&(this.height=e.height)}},Wl=class extends vl{constructor(e,t,s=1){super(e,t),this._rows=[],this.height=0,this.glyphs=[],this._align=s}doLayout(){let e=0,t=0,s=this.renderer.smuflMetrics.rowContainerGap;this._rows=[];let i=new Vl(e,t,this._align);i.renderer=this.renderer,i.width=this.width;for(let a of this.glyphs){let r=e+a.width+s;r<this.width?(i.addGlyphToRow(a),e=Math.ceil(r)):(i.isEmpty||(i.doLayout(),this._rows.push(i),t+=i.height+s),e=0,i=new Vl(e,t,this._align),i.renderer=this.renderer,i.width=this.width,i.addGlyphToRow(a),e+=Math.ceil(a.width+s))}i.isEmpty||(i.doLayout(),this._rows.push(i),t+=Math.ceil(i.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=t}paint(e,t,s){for(let i of this._rows)i.paint(e+this.x,t+this.y,s)}},Hl=class extends Wl{addChord(e){if(e.strings.length>0){let t=new Ol(0,0,e);t.renderer=this.renderer,t.doLayout(),this.glyphs.push(t)}}paint(e,t,s){if(this.glyphs.length>0){var i=[];try{o(i,Nl.score(s,10,this.renderer.scoreRenderer.score));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}}},Gl=class extends Vo{constructor(e,t,s,i,a=0,r=null,n){super(e,t),this._lineHeights=null,this._lines=s.split("\n"),this.font=i,this.textAlign=a,this.textBaseline=r,this.colorOverride=n}doLayout(){super.doLayout(),this._lineHeights=[];let e=this.renderer.scoreRenderer.canvas;for(let t of this._lines){e.font=this.font;let s=e.measureText(t),i=s.height;this._lineHeights.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(e,t,s){let i=s.color;s.color=this.colorOverride??i,s.font=this.font;let a=s.textAlign,r=s.textBaseline;s.textAlign=this.textAlign,null!==this.textBaseline&&(s.textBaseline=this.textBaseline);let n=t+this.y;for(let t=0;t<this._lines.length;t++)s.fillText(this._lines[t],e+this.x,n),n+=this._lineHeights[t];s.textAlign=a,s.textBaseline=r,s.color=i}},zl=class{constructor(e,t,s){this._sharedLayoutData=new Map,this.barRenderers=[],this.x=0,this.y=0,this.height=0,this.index=0,this.staffIndex=0,this.isFirstInSystem=!1,this.trackIndex=0,this.staveTop=0,this.topSpacing=0,this.bottomSpacing=0,this.staveBottom=0,this._factory=s,this.trackIndex=e,this.modelStaff=t}get staffId(){return this._factory.staffId}get contentTop(){return this.y+this.staveTop+this.topSpacing+this.topOverflow}get contentBottom(){return this.y+this.topSpacing+this.topOverflow+this.staveBottom}getSharedLayoutData(e,t){return this._sharedLayoutData.has(e)?this._sharedLayoutData.get(e):t}setSharedLayoutData(e,t){this._sharedLayoutData.set(e,t)}get isInsideBracket(){return this._factory.isInsideBracket}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(e){this.staveTop=e}registerStaffBottom(e){this.staveBottom=e}addBarRenderer(e){e.staff=this,e.index=this.barRenderers.length,e.reLayout(),this.barRenderers.push(e),this.system.layout.registerBarRenderer(this.staffId,e)}addBar(e,t,s){let i=this._factory.create(this.system.layout.renderer,e);i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=t,i.doLayout(),i.registerLayoutingInfo();let a=i.barDisplayWidth;a>0&&2===this.system.layout.systemsLayoutMode&&(i.width=a),this.barRenderers.push(i),e&&this.system.layout.registerBarRenderer(this.staffId,i)}revertLastBar(){let e=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staffId,e);for(let e of this.barRenderers)e.applyLayoutingInfo();return e}scaleToWidth(e){this._sharedLayoutData=new Map;let t=this.topOverflow,s=0;switch(this.system.layout.systemsLayoutMode){case 0:let i=(e-this.system.computedWidth)/this.barRenderers.length;for(let e of this.barRenderers){e.x=s,e.y=this.topSpacing+t;let a=e.computedWidth+i;e.scaleToWidth(a),s+=e.width}break;case 1:e-=this.system.accoladeWidth;let a=this.system.totalBarDisplayScale;for(let i of this.barRenderers){i.x=s,i.y=this.topSpacing+t;let r=i.barDisplayScale*e/a;i.scaleToWidth(r),s+=i.width}break;case 2:for(let e of this.barRenderers){e.x=s,e.y=this.topSpacing+t;let i=e.barDisplayWidth;i>0?e.scaleToWidth(i):e.scaleToWidth(e.computedWidth),s+=e.width}}}get topOverflow(){let e=0;for(let t=0,s=this.barRenderers.length;t<s;t++){let s=this.barRenderers[t];s.topOverflow>e&&(e=s.topOverflow)}return e}get bottomOverflow(){let e=0;for(let t=0,s=this.barRenderers.length;t<s;t++){let s=this.barRenderers[t];s.bottomOverflow>e&&(e=s.bottomOverflow)}return e}calculateHeightForAccolade(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=Math.ceil(this.topSpacing+this.topOverflow+this.bottomOverflow+this.bottomSpacing))}finalizeStaff(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=0;let e=!1,t=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+t,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer()&&(e=!0);if(e){t=this.topOverflow;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].y=this.topSpacing+t;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].finalizeRenderer()}this.height>0&&(this.height+=this.topSpacing+t+this.bottomOverflow+this.bottomSpacing),this.height=Math.ceil(this.height)}paint(e,t,s,i,a){if(0!==this.height&&0!==a)for(let r=i,n=Math.min(i+a,this.barRenderers.length);r<n;r++)this.barRenderers[r].paint(e+this.x,t+this.y,s)}},Ul=class{constructor(){this.timePosition=0,this.longestDuration=0,this.smallestDuration=0,this.force=0,this.springConstant=0,this.preBeatWidth=0,this.graceBeatWidth=0,this.postSpringWidth=0,this.allDurations=new Set}get springWidth(){return this.preSpringWidth+this.postSpringWidth}get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}},Yl=class e{constructor(){this._timeSortedSprings=[],this._minTime=-1,this._onTimePositionsForce=0,this._onTimePositions=new Map,this._incompleteGraceRodsWidth=0,this._minDuration=e._defaultMinDuration,this.version=0,this.preBeatSize=0,this.postBeatSize=0,this.minStretchForce=0,this.totalSpringConstant=0,this.incompleteGraceRods=new Map,this.allGraceRods=new Map,this.springs=new Map,this.height=0}_updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e)}getPreBeatSize(e){if(0!==e.graceType){let t=e.graceGroup.id;return this.allGraceRods.get(t)[e.graceIndex].preBeatWidth}let t=e.absoluteDisplayStart;return this.springs.has(t)?this.springs.get(t).preBeatWidth:0}getPostBeatSize(e){if(0!==e.graceType){let t=e.graceGroup.id;return this.allGraceRods.get(t)[e.graceIndex].postSpringWidth}let t=e.absoluteDisplayStart;return this.springs.has(t)?this.springs.get(t).postSpringWidth:0}addSpring(e,t,s,i,a){let r;if(this.version++,this.springs.has(e))r=this.springs.get(e),r.postSpringWidth<a&&(r.postSpringWidth=a),r.graceBeatWidth<s&&(r.graceBeatWidth=s),r.preBeatWidth<i&&(r.preBeatWidth=i),t<r.smallestDuration&&(r.smallestDuration=t),t>r.longestDuration&&(r.longestDuration=t),r.allDurations.add(t);else{if(r=new Ul,r.timePosition=e,r.allDurations.add(t),this._timeSortedSprings.length>0){let s=t,i=this._timeSortedSprings[this._timeSortedSprings.length-1];for(let t of i.allDurations)i.timePosition+t>=e&&t<s&&(s=t);t<this._minDuration&&(this._minDuration=t)}r.longestDuration=t,r.postSpringWidth=a,r.graceBeatWidth=s,r.preBeatWidth=i,this.springs.set(e,r);let n=this._timeSortedSprings,o=n.length-1;for(;o>0&&n[o].timePosition>e;)o--;this._timeSortedSprings.splice(o+1,0,r)}return(-1===this._minTime||this._minTime>e)&&(this._minTime=e),r}addBeatSpring(e,t,s){let i=e.absoluteDisplayStart;if(0!==e.graceType){let a=e.graceGroup.id;this.allGraceRods.has(a)||this.allGraceRods.set(a,new Array(e.graceGroup.beats.length)),!e.graceGroup.isComplete&&!this.incompleteGraceRods.has(a)&&this.incompleteGraceRods.set(a,new Array(e.graceGroup.beats.length));let r=this.allGraceRods.get(a)[e.graceIndex];if(r)r.postSpringWidth<s&&(r.postSpringWidth=s),r.preBeatWidth<t&&(r.preBeatWidth=t);else{let r=new Ul;r.timePosition=i,r.postSpringWidth=s,r.preBeatWidth=t,e.graceGroup.isComplete||(this.incompleteGraceRods.get(a)[e.graceIndex]=r),this.allGraceRods.get(a)[e.graceIndex]=r}}else{let a=0;if(e.graceGroup&&this.allGraceRods.has(e.graceGroup.id))for(let t of this.allGraceRods.get(e.graceGroup.id))a+=t.springWidth;this.addSpring(i,e.displayDuration,a,t,s)}}finish(){for(let[e,t]of this.allGraceRods){let e=0;for(let s of t)e+=s.preBeatWidth,s.graceBeatWidth=e,e+=s.postSpringWidth}this._incompleteGraceRodsWidth=0;for(let e of this.incompleteGraceRods.values())for(let t of e)this._incompleteGraceRodsWidth+=t.preBeatWidth+t.postSpringWidth;this._calculateSpringConstants(),this.version++}_calculateSpringConstants(){let e=0,t=this._timeSortedSprings;if(0===t.length)return this.totalSpringConstant=-1,void(this.minStretchForce=-1);for(let s=0;s<t.length;s++){let i=t[s],a=0;if(s===t.length-1)a=i.longestDuration;else{let e=t[s+1];a=Math.abs(e.timePosition-i.timePosition)}i.springConstant=this._calculateSpringConstant(i,a),e+=1/i.springConstant}this.totalSpringConstant=1/e,this.minStretchForce=0;for(let e=0;e<t.length;e++){let s=t[e],i=0;if(e===t.length-1)i=s.postSpringWidth;else{let a=t[e+1];i=s.postSpringWidth+a.preSpringWidth}0===e&&(i+=s.preSpringWidth);let a=i*s.springConstant;this._updateMinStretchForce(a)}}paint(e,t,s){}_calculateSpringConstant(t,s){s<=0&&(s=_.toTicks(256)),0===t.smallestDuration&&(t.smallestDuration=s);let i=t.smallestDuration,a=this._minDuration,r=e._defaultMinDurationWidth;return i/s*(1/((1+.85*Math.log2(s/a))*r))}spaceToForce(e){return-1!==this.totalSpringConstant?(this._timeSortedSprings.length>0&&(e-=this._timeSortedSprings[0].preSpringWidth),e-=this._incompleteGraceRodsWidth,Math.max(e,0)*this.totalSpringConstant):-1}calculateVoiceWidth(e){let t=0;return-1!==this.totalSpringConstant&&(t=this._calculateWidth(e,this.totalSpringConstant)),this._timeSortedSprings.length>0&&(t+=this._timeSortedSprings[0].preSpringWidth),t+=this._incompleteGraceRodsWidth,t}_calculateWidth(e,t){return e/t}buildOnTimePositions(e){if(-1===this.totalSpringConstant)return new Map;if(qe.isAlmostEqualTo(this._onTimePositionsForce,e)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=e;let t=new Map;this._onTimePositions=t;let s=this._timeSortedSprings;if(0===s.length)return t;let i=s[0].preSpringWidth;for(let a=0;a<s.length;a++)t.set(s[a].timePosition,i),i+=this._calculateWidth(e,s[a].springConstant);return t}};Yl._defaultMinDuration=30,Yl._defaultMinDurationWidth=7;var Xl=Yl,$l=class{constructor(){this.width=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.additionalMultiBarRestIndexes=null,this.renderers=[]}get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}},Jl=class{constructor(e,t){this.staves=[],this.stavesRelevantForBoundsLookup=[],this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.bracket=null,this.staffSystem=e,this.track=t}addStaff(e){this.staves.push(e),e.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(e)}},ql=class{constructor(){this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.drawAsBrace=!1,this.braceScale=1,this.width=0,this.index=0}finalizeBracket(e){if(this.firstStaffInBracket===this.lastStaffInBracket)return void(this.width=0);let t=e.glyphHeights.get(57344),s=e.glyphWidths.get(57344);if(this.drawAsBrace?this.width=s:this.width=e.bracketThickness,!this.drawAsBrace||!this.firstStaffInBracket||!this.lastStaffInBracket)return;let i=this.firstStaffInBracket.contentTop,a=(this.lastStaffInBracket.contentBottom-i)/t;this.braceScale=a,this.width=s*this.braceScale}},jl=class e extends ql{constructor(t){super(),this.track=t,this.drawAsBrace=e.isTrackDrawAsBrace(t)}includesStaff(e){return e.modelStaff.track===this.track}static isTrackDrawAsBrace(e){return e.staves.filter(e=>e.showStandardNotation).length>1}},Kl=class extends jl{includesStaff(e){return e.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===e.modelStaff.track.playbackInfo.program}},Ql=class{constructor(e){this._allStaves=[],this._firstStaffInBrackets=null,this._lastStaffInBrackets=null,this._accoladeSpacingCalculated=!1,this._brackets=[],this._hasSystemSeparator=!1,this.x=0,this.y=0,this.index=0,this.accoladeWidth=0,this.isFull=!1,this.width=0,this.computedWidth=0,this.totalBarDisplayScale=0,this.isLast=!1,this.masterBarsRenderers=[],this.staves=[],this.layout=e,this.topPadding=e.renderer.settings.display.systemPaddingTop,this.bottomPadding=e.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(e,t){if(0===e.length)return null;this.masterBarsRenderers.push(t),t.layoutingInfo.preBeatSize=0;let s=0;for(let e=0,i=this.staves.length;e<i;e++){let i=this.staves[e];for(let e=0,a=i.staves.length;e<a;e++){let a=i.staves[e],r=t.renderers[s++];a.addBarRenderer(r)}}return this._calculateAccoladeSpacing(e),this._updateWidthFromLastBar(),t}addBars(e,t,s){let i=new $l;i.additionalMultiBarRestIndexes=s,i.layoutingInfo=new Xl,i.masterBar=e[0].score.masterBars[t],this.masterBarsRenderers.push(i);let a=i.layoutingInfo;for(let e of this.staves)for(let r of e.staves){let n=e.track.staves[r.modelStaff.index].bars[t],o=null==s?null:s.map(t=>e.track.staves[r.modelStaff.index].bars[t]);r.addBar(n,a,o);let l=r.barRenderers[r.barRenderers.length-1];i.renderers.push(l),l.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),l.canWrap||(i.canWrap=!1)}return this._calculateAccoladeSpacing(e),a.finish(),i.width=this._updateWidthFromLastBar(),i}revertLastBar(){if(this.masterBarsRenderers.length>1){let e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let t=0,s=0;for(let e=0,i=this._allStaves.length;e<i;e++){let i=this._allStaves[e].revertLastBar(),a=i.computedWidth;a>t&&(t=a);let r=i.barDisplayScale;r>s&&(s=r)}return this.width-=t,this.computedWidth-=t,this.totalBarDisplayScale-=s,e}return null}_updateWidthFromLastBar(){let e=0,t=0;for(let s=0,i=this._allStaves.length;s<i;s++){let i=this._allStaves[s],a=i.barRenderers[i.barRenderers.length-1];a.applyLayoutingInfo(),a.computedWidth>e&&(e=a.computedWidth);let r=a.barDisplayScale;r>t&&(t=r)}return this.width+=e,this.computedWidth+=e,this.totalBarDisplayScale+=t,e}_calculateAccoladeSpacing(e){let t=this.layout.renderer.settings;if(!this._accoladeSpacingCalculated){this._accoladeSpacingCalculated=!0,this.accoladeWidth=0;let s=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(9)){let i=1===this.layout.renderer.tracks.length?s.singleTrackTrackNamePolicy:s.multiTrackTrackNamePolicy,a=0===this.index?s.firstSystemTrackNameMode:s.otherSystemsTrackNameMode,r=0===this.index?s.firstSystemTrackNameOrientation:s.otherSystemsTrackNameOrientation,n=!1;switch(i){case 0:break;case 1:n=0===this.index;break;case 2:n=!0}let o=!1;if(n){let s=this.layout.renderer.canvas,i=t.display.resources.effectFont;s.font=i;for(let t of e){let e="";switch(a){case 0:e=t.name;break;case 1:e=t.shortName}if(e.length>0){o=!0;let t=s.measureText(e);switch(r){case 0:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,t.width));break;case 1:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,t.height))}}}o&&(this.accoladeWidth+=t.display.systemLabelPaddingLeft,this.accoladeWidth+=t.display.systemLabelPaddingRight)}}let i=0;for(let e of this._allStaves)e.y=i,e.calculateHeightForAccolade(),i+=e.height;let a=0;for(let e of this._brackets)e.finalizeBracket(t.display.resources.engravingSettings),a=Math.max(a,e.width);this.accoladeWidth+=a,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}_getStaffTrackGroup(e){for(let t=0,s=this.staves.length;t<s;t++){let s=this.staves[t];if(s.track===e)return s}return null}addStaff(e,t){let s=this._getStaffTrackGroup(e);if(s||(s=new Jl(this,e),this.staves.push(s)),t.staffTrackGroup=s,t.system=this,t.index=this._allStaves.length,this._allStaves.push(t),s.addStaff(t),t.isInsideBracket){this._firstStaffInBrackets||(this._firstStaffInBrackets=t,t.isFirstInSystem=!0),s.firstStaffInBracket||(s.firstStaffInBracket=t),this._lastStaffInBrackets=t,s.lastStaffInBracket=t;let i=this._brackets.find(e=>e.includesStaff(t));if(!i)switch(e.score.stylesheet.bracketExtendMode){case 0:break;case 1:i=new jl(e),i.index=this._brackets.length,this._brackets.push(i);break;case 2:i=new Kl(e),i.index=this._brackets.length,this._brackets.push(i)}i&&(i.firstStaffInBracket||(i.firstStaffInBracket=t),i.lastStaffInBracket=t,s.bracket=i)}}get height(){return 0===this._allStaves.length?0:Math.ceil(this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height+this.topPadding+this.bottomPadding)}scaleToWidth(e){for(let t=0,s=this._allStaves.length;t<s;t++)this._allStaves[t].scaleToWidth(e);this.width=e}paint(e,t,s){if(this.paintPartial(e+this.x,t+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this._hasSystemSeparator){var i=[];try{o(i,Nl.track(s,2,this._allStaves[0].modelStaff.track));let a=this.layout.renderer.settings.display.resources.engravingSettings,r=Math.min(0,a.glyphBottom.get(57351)??0);Fe.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+this.height+r,1,57351,!1),Fe.fillMusicFontSymbolSafe(s,e+this.x+this.width-a.glyphWidths.get(57351),t+this.y+this.height+r,1,57351,!1)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}}paintPartial(e,t,s,i,a){for(let r=0,n=this._allStaves.length;r<n;r++)this._allStaves[r].paint(e,t,s,i,a);let r=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===i){s.color=r.barSeparatorColor;let i=this.layout.renderer.settings,a=this.layout.renderer.settings.notation.isNotationElementVisible(9);if(s.font=r.effectFont,a){let a=this.layout.renderer.score.stylesheet,r=1===this.layout.renderer.tracks.length?a.singleTrackTrackNamePolicy:a.multiTrackTrackNamePolicy,c=0===this.index?a.firstSystemTrackNameMode:a.otherSystemsTrackNameMode,u=0===this.index?a.firstSystemTrackNameOrientation:a.otherSystemsTrackNameOrientation,p=!1;switch(r){case 0:break;case 1:p=0===this.index;break;case 2:p=!0}if(p){let a=s.textBaseline,r=s.textAlign;for(let a of this.staves)if(a.firstStaffInBracket&&a.lastStaffInBracket){var n=[];try{let r=t+a.firstStaffInBracket.contentTop,l=t+a.lastStaffInBracket.contentBottom,h="";switch(c){case 0:h=a.track.name;break;case 1:h=a.track.shortName}o(n,Nl.track(s,0,a.track));if(h.length>0){let t=e+a.firstStaffInBracket.x-i.display.accoladeBarPaddingRight-(a.bracket?.width??0)-i.display.systemLabelPaddingRight;switch(u){case 0:s.textBaseline=1,s.textAlign=2,s.fillText(h,t,(r+l)/2);break;case 1:s.textBaseline=2,s.textAlign=1,s.beginRotate(t,(r+l)/2,-90.1),s.fillText(h,0,0),s.endRotate()}}}catch(e){var h=e,d=!0}finally{l(n,h,d)}}s.textBaseline=a,s.textAlign=r}}if(this._allStaves.length>0){let i=null;for(let a of this._allStaves)if(a.isInsideBracket){if(null!==i){var c=[];try{let n=i.contentBottom,l=a.contentTop,h=e+i.x,d=i.barRenderers[0],u=(o(c,Nl.bar(s,d.staffLineBarSubElement,d.bar)),Math.ceil(l-n));s.fillRect(h,t+n,r.engravingSettings.thinBarlineThickness,u)}catch(e){var u=e,p=!0}finally{l(c,u,p)}}i=a}}for(let a of this._brackets)if(a.firstStaffInBracket&&a.lastStaffInBracket){let r=e+a.firstStaffInBracket.x,n=a.width,o=i.display.accoladeBarPaddingRight,l=t+a.firstStaffInBracket.contentTop,h=t+a.lastStaffInBracket.contentBottom;if(a.drawAsBrace)Fe.fillMusicFontSymbolSafe(s,r-o-n,h,a.braceScale,57344);else if(a.firstStaffInBracket!==a.lastStaffInBracket){let e=n/2;l-=e,h+=2*e,s.fillRect(r-o-n,l,n,Math.ceil(h-l));let t=r-o-n;Fe.fillMusicFontSymbolSafe(s,t,l,1,57347),Fe.fillMusicFontSymbolSafe(s,t,Math.floor(h),1,57348)}}}}finalizeSystem(){let e=this.layout.renderer.settings;if(0===this.index&&(this.topPadding=e.display.firstSystemPaddingTop),this.isLast)this.bottomPadding=e.display.lastSystemPaddingBottom;else if(this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1){let t=e.display.resources.engravingSettings.glyphHeights.get(57351);this.bottomPadding=Math.max(this.bottomPadding,t),this._hasSystemSeparator=!0}let t=0;for(let e of this._allStaves)e.x=this.accoladeWidth,e.y=t,e.finalizeStaff(),t+=e.height;for(let t of this._brackets)t.finalizeBracket(e.display.resources.engravingSettings)}buildBoundingsLookup(e,t){if(this.layout.renderer.boundsLookup.isFinished)return;let s=this._firstStaffInBrackets,i=this._lastStaffInBrackets;if(!s||!i)return;t+=this.topPadding;let a=this._allStaves[this._allStaves.length-1],r=t+this.y+s.y,n=t+this.y+i.y+i.height,o=t+this.y+this._allStaves[0].y,l=t+this.y+a.y+a.height,h=t+this.y+s.y+s.topSpacing+s.topOverflow+(s.barRenderers.length>0?s.barRenderers[0].topPadding:0),d=n-r,c=t+this.y+a.y+a.height-a.bottomSpacing-a.bottomOverflow-(a.barRenderers.length>0?a.barRenderers[0].bottomPadding:0)-h,u=l-o,p=this.x+s.x,m=new bs;m.visualBounds=new ms,m.visualBounds.x=e+this.x,m.visualBounds.y=t+this.y,m.visualBounds.w=this.width,m.visualBounds.h=this.height-this.topPadding-this.bottomPadding,m.realBounds=new ms,m.realBounds.x=e+this.x,m.realBounds.y=t+this.y,m.realBounds.w=this.width,m.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(m);let g=new Map;for(let e=0;e<this.staves.length;e++)for(let s of this.staves[e].stavesRelevantForBoundsLookup)for(let e of s.barRenderers){let i;g.has(e.bar.masterBar.index)?i=g.get(e.bar.masterBar.index):(i=new gs,i.index=e.bar.masterBar.index,i.isFirstOfLine=e.isFirstOfLine,i.realBounds=new ms,i.realBounds.x=p+e.x,i.realBounds.y=o,i.realBounds.w=e.width,i.realBounds.h=u,i.visualBounds=new ms,i.visualBounds.x=p+e.x,i.visualBounds.y=r,i.visualBounds.w=e.width,i.visualBounds.h=d,i.lineAlignedBounds=new ms,i.lineAlignedBounds.x=p+e.x,i.lineAlignedBounds.y=h,i.lineAlignedBounds.w=e.width,i.lineAlignedBounds.h=c,this.layout.renderer.boundsLookup.addMasterBar(i),g.set(i.index,i)),e.buildBoundingsLookup(i,p,t+this.y+s.y)}}getBarX(e){if(!this._firstStaffInBrackets||0===this.layout.renderer.tracks.length)return 0;let t=this.layout.renderer.tracks[0].staves[0].bars[e];return this.layout.getRendererForBar(this._firstStaffInBrackets.staffId,t).x}},Zl=class extends Wl{constructor(e,t){super(e,t,0)}},eh=class extends vl{constructor(e,t,s,i){super(e,t),this._tuning=s,this._trackLabel=i,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this._createGlyphs(this._tuning);for(let e of this.glyphs)e.renderer=this.renderer,e.doLayout()}}paint(e,t,s){let i=s.color;this.colorOverride&&(s.color=this.colorOverride),super.paint(e,t,s),s.color=i}_createGlyphs(e){let t=this.renderer.resources;if(this.height=0,this._trackLabel.length>0){let e=new Gl(0,this.height,this._trackLabel,t.effectFont,0);e.renderer=this.renderer,e.doLayout(),this.height+=e.height,this.addGlyph(e)}if(e.name.length>0){let s=new Gl(0,this.height,e.name,t.effectFont,0);s.renderer=this.renderer,s.doLayout(),this.height+=s.height,this.addGlyph(s)}let s=this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,i=this.renderer.smuflMetrics.glyphHeights.get(59443)*s;this.renderer.scoreRenderer.canvas.font=t.effectFont;let a=(i+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*t.engravingSettings.tuningGlyphStringColumnScale;if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(e.name).width,2*a)),!e.isStandard){let r=0|Math.ceil(e.tunings.length/2),n=0,o=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding,l=o;for(let h=0,d=e.tunings.length;h<d;h++){let d=59443+(h+1);this.addGlyph(new Wo(n,l+i,s,d));let c=` = ${Zt.getTextForTuning(e.tunings[h],!1)}`;this.addGlyph(new Gl(n+i,l+i/2,c,t.effectFont,0,1)),l+=i+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;let u=l;this.height<u&&(this.height=u),h===r-1&&(l=o,n+=a)}}}},th=class{constructor(e,t){this.args=e,this.renderCallback=t}},sh=class e{constructor(e){this._barRendererLookup=new Map,this.pagePadding=null,this.width=0,this.height=0,this.multiBarRestInfo=null,this.headerGlyphs=new Map,this.footerGlyphs=new Map,this.chordDiagrams=null,this.tuningGlyph=null,this.systemsLayoutMode=0,this._lazyPartials=new Map,this.firstBarIndex=0,this.lastBarIndex=0,this.renderer=e}get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}resize(){this._lazyPartials.clear(),this.doResize()}layoutAndRender(){this._lazyPartials.clear();let e=this.renderer.score;this.firstBarIndex=qe.computeFirstDisplayedBarIndex(e,this.renderer.settings),this.lastBarIndex=qe.computeLastDisplayedBarIndex(e,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=qe.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(e=>e/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this._createScoreInfoGlyphs(),this.doLayoutAndRender()}registerPartial(e,t){if(0===e.height)return;let s=this.renderer.settings.display.scale;e.x*=s,e.y*=s,e.width*=s,e.height*=s,e.totalWidth*=s,e.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this._lazyPartials.set(e.id,new th(e,t)),this.renderer.partialLayoutFinished.trigger(e)):(this.renderer.partialLayoutFinished.trigger(e),this._internalRenderLazyPartial(e,t))}_internalRenderLazyPartial(e,t){let s=this.renderer.canvas;s.beginRender(e.width,e.height),t(s),e.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(e)}renderLazyPartial(e){if(this._lazyPartials.has(e)){let t=this._lazyPartials.get(e);this._internalRenderLazyPartial(t.args,t.renderCallback)}}_createHeaderFooterGlyph(e,t,s,i){switch(s){case 6:if(t.words!==t.music)return;break;case 4:case 5:if(t.words===t.music)return;break;case 9:if(!this.footerGlyphs.has(8))return}let a=e.display.resources,r=e.notation,n=t.style&&t.style.headerAndFooter.has(s)?t.style.headerAndFooter.get(s):Re.defaultHeaderAndFooter.get(s),o=void 0===n.isVisible||n.isVisible;if(void 0!==i&&(o=r.isNotationElementVisible(i)),!o)return;let l=n.buildText(t);return l?new Gl(0,0,l,a.getFontForElement(s),n.textAlign,void 0,Nl.scoreColor(a,s,t)):void 0}_createScoreInfoGlyphs(){re.debug("ScoreLayout","Creating score info glyphs");let t=this.renderer.settings,s=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;let i=new dh(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(let[a,r]of e.headerElements.value){let e=this._createHeaderFooterGlyph(t,s,a,r);e&&(e.renderer=i,e.doLayout(),this.headerGlyphs.set(a,e))}for(let[a,r]of e.footerElements.value){let e=this._createHeaderFooterGlyph(t,s,a,r);e&&(e.renderer=i,e.doLayout(),this.footerGlyphs.set(a,e))}let a=t.notation,r=t.display.resources;if(a.isNotationElementVisible(8)){let e=[];for(let t of this.renderer.tracks)for(let i of t.staves){let a=!i.isPercussion&&i.isStringed&&i.tuning.length>0&&i.showTablature;if(s.stylesheet.perTrackDisplayTuning&&s.stylesheet.perTrackDisplayTuning.has(t.index)&&!1===s.stylesheet.perTrackDisplayTuning.get(t.index)&&(a=!1),a){e.push(i);break}}if(e.length>0&&s.stylesheet.globalDisplayTuning){this.tuningGlyph=new Zl(0,0),this.tuningGlyph.renderer=i;for(let t of e)if(t.stringTuning.tunings.length>0){let s=e.length>1?t.track.name:"",a=new eh(0,0,t.stringTuning,s);a.colorOverride=Nl.trackColor(r,3,t.track),a.renderer=i,a.doLayout(),this.tuningGlyph.addGlyph(a)}}else this.tuningGlyph=null}if(a.isNotationElementVisible(10)){this.chordDiagrams=new Hl(0,0),this.chordDiagrams.renderer=i;let e=new Set;for(let t of this.renderer.tracks)if(s.stylesheet.globalDisplayChordDiagramsOnTop&&(null==s.stylesheet.perTrackChordDiagramsOnTop||!s.stylesheet.perTrackChordDiagramsOnTop.has(t.index)||s.stylesheet.perTrackChordDiagramsOnTop.get(t.index)))for(let s of t.staves){let t=s.chords;if(t)for(let[,s]of t)e.has(s.uniqueId)||s.showDiagram&&(e.add(s.uniqueId),this.chordDiagrams.addChord(s))}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}createEmptyStaffSystem(){let e=new Ql(this);for(let t=0;t<this.renderer.tracks.length;t++){let s=this.renderer.tracks[t];for(let i=0;i<s.staves.length;i++){let a=s.staves[i],r=bu.staveProfiles.get(this.renderer.settings.display.staveProfile);for(let i of r)i.canCreate(s,a)&&e.addStaff(s,new zl(t,a,i))}}return e}registerBarRenderer(e,t){if(this._barRendererLookup.has(e)||this._barRendererLookup.set(e,new Map),this._barRendererLookup.get(e).set(t.bar.id,t),t.additionalMultiRestBars)for(let s of t.additionalMultiRestBars)this._barRendererLookup.get(e).set(s.id,t)}unregisterBarRenderer(e,t){if(this._barRendererLookup.has(e)){let s=this._barRendererLookup.get(e);if(s.delete(t.bar.id),t.additionalMultiRestBars)for(let e of t.additionalMultiRestBars)s.delete(e.id)}}getRendererForBar(e,t){let s=t.id;return this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).has(s)?this._barRendererLookup.get(e).get(s):null}layoutAndRenderBottomScoreInfo(t){t=Math.round(t);let s=new ls;s.x=0,s.y=t;let i=0,a=this.renderer.settings.display.resources,r=[],n=0;for(let[t,s]of e.footerElements.value)if(this.footerGlyphs.has(t)){let e=this.footerGlyphs.get(t);e.y=i,this.alignScoreInfoGlyph(e),i+=e.height,r.push(e),n=Math.max(n,Math.round(e.x+e.width))}return i=Math.round(i),r.length>0&&(s.width=n,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=t+s.height,this.registerPartial(s,e=>{e.color=a.scoreInfoColor,e.textAlign=0,e.textBaseline=0;for(let t of r)t.paint(0,0,e)})),t+i}alignScoreInfoGlyph(e){if(bu.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(e.textAlign){case 0:e.x=this.pagePadding[0];break;case 1:e.x=this.scaledWidth/2;break;case 2:e.x=this.scaledWidth-this.pagePadding[2]}else e.x=this.firstBarX,e.textAlign=0}layoutAndRenderAnnotation(e){let t=this.renderer.settings.display.resources,s=ln.withFamilyList(t.copyrightFont.families,12,0,1),i=new dh(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),a=new Gl(0,0,"-Chris-",s,1,void 0,t.mainGlyphColor);a.renderer=i,a.doLayout(),this.alignScoreInfoGlyph(a);let r=new ls;return r.width=a.x+a.width,r.x=0,r.height=12,r.y=e,r.totalWidth=this.scaledWidth,r.totalHeight=e+12,r.firstMasterBarIndex=-1,r.lastMasterBarIndex=-1,this.registerPartial(r,e=>{e.color=t.mainGlyphColor,e.font=s,e.textAlign=0,e.textBaseline=0,a.paint(0,0,e)}),e+12}};sh.headerElements=new K(()=>new Map([[0,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,void 0]])),sh.footerElements=new K(()=>new Map([[8,7],[9,void 0]]));var ih=sh,ah=class extends vl{constructor(){super(0,0),this._effectGlyphs=[],this._normalGlyphs=[],this.computedWidth=0}doLayout(){let e=0;if(this.glyphs)for(let t=0,s=this.glyphs.length;t<s;t++){let s=this.glyphs[t];s.x=e,s.renderer=this.renderer,s.doLayout(),e+=s.width}this.width=e,this.computedWidth=e}noteLoop(e){for(let t=this.container.beat.notes.length-1;t>=0;t--)e(this.container.beat.notes[t])}addEffect(e){super.addGlyph(e),this._effectGlyphs.push(e)}addNormal(e){super.addGlyph(e),this._normalGlyphs.push(e)}get effectElement(){}paint(e,t,s){this._paintEffects(e,t,s),this._paintNormal(e,t,s)}_paintNormal(e,t,s){for(let i of this._normalGlyphs)i.paint(e+this.x,t+this.y,s)}_paintEffects(e,t,s){var i=[];try{o(i,this.effectElement?Nl.beat(s,this.effectElement,this.container.beat):void 0);for(let i of this._effectGlyphs)i.paint(e+this.x,t+this.y,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},rh=class extends ah{constructor(){super(...arguments),this.centerX=0}updateBeamingHelper(){}buildBoundingsLookup(e,t,s){}getNoteX(e,t){return 0}getNoteY(e,t){return 0}getHighestNoteY(){return 0}getLowestNoteY(){return 0}},nh=class e extends Oo{constructor(t,s,i,a,r=1){super(t,s),this._scale=0,this._symbols=[],this._symbols=e.getSymbols(i),this._scale=r,this._baseline=a}static getSymbols(t){let s=[];for(;t>0;){let i=t%10;s.unshift(e.getSymbol(i)),t=t/10|0}return s}static getSymbol(e){switch(e){case 0:return 57472;case 1:return 57473;case 2:return 57474;case 3:return 57475;case 4:return 57476;case 5:return 57477;case 6:return 57478;case 7:return 57479;case 8:return 57480;case 9:return 57481;default:return-1}}doLayout(){let e=0;for(let t of this._symbols)e+=this.renderer.smuflMetrics.glyphWidths.get(t);this.width=e}paint(e,t,s){switch(this._baseline){case 0:t+=this.renderer.smuflMetrics.glyphBottom.get(this._symbols[0]);break;case 2:t+=this.renderer.smuflMetrics.glyphTop.get(this._symbols[0])}s.fillMusicFontSymbols(e+this.x,t+this.y,this._scale,this._symbols)}},oh=class e extends Oo{constructor(){super(0,0),this._numberGlyph=[]}doLayout(){this.width=e._restSymbols.reduce((e,t)=>e+this.renderer.smuflMetrics.glyphWidths.get(t),0),this.renderer.registerOverflowTop(this.renderer.getLineHeight(1));let t=this.renderer.additionalMultiRestBars.length+1;this._numberGlyph=nh.getSymbols(t)}paint(t,s,i){i.fillMusicFontSymbols(t+this.x,s+this.y+this.renderer.height/2,1,e._restSymbols);let a=this.renderer.getLineY(-1.5);i.fillMusicFontSymbols(t+this.x+this.width/2,s+this.y+a|0,1,this._numberGlyph,!0)}};oh._restSymbols=[58607,58608,58608,58608,58609];var lh=oh,hh=class e extends Yo{constructor(t){super(e._getOrCreatePlaceholderBeat(t),t),this.preNotes=new ah,this.onNotes=new rh}doLayout(){this.renderer.showMultiBarRest&&this.onNotes.addNormal(new lh),super.doLayout()}static _getOrCreatePlaceholderBeat(e){if(e.voice.beats.length>1)return e.voice.beats[0];let t=new wt;return t.voice=e.voice,t}},dh=class{constructor(e,t){this._preBeatGlyphs=new Pl,this._voiceContainers=new Map,this._postBeatGlyphs=new Pl,this._ties=[],this.additionalMultiRestBars=null,this.x=0,this.y=0,this.width=0,this.computedWidth=0,this.height=0,this.index=0,this.topOverflow=0,this.bottomOverflow=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.wasFirstOfLine=!1,this._appliedLayoutingInfo=0,this.isFinalized=!1,this.topPadding=0,this.bottomPadding=0,this.scoreRenderer=e,this.bar=t,t&&(this.helpers=new Rl(this))}get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}get showMultiBarRest(){return!1}registerTies(e){this._ties.push(...e)}get middleYPosition(){return 0}registerOverflowTop(e){return(e=Math.ceil(e))>this.topOverflow&&(this.topOverflow=e,!0)}registerOverflowBottom(e){return(e=Math.ceil(e))>this.bottomOverflow&&(this.bottomOverflow=e,!0)}scaleToWidth(e){let t=e-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(let e of this._voiceContainers.values())e.scaleToWidth(t);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+t,this.width=e}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}get barDisplayScale(){return this.staff.system.staves.length>1?this.bar.masterBar.displayScale:this.bar.displayScale}get barDisplayWidth(){return this.staff.system.staves.length>1?this.bar.masterBar.displayWidth:this.bar.displayWidth}get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){let e=this.layoutingInfo,t=this._preBeatGlyphs.width;e.preBeatSize<t&&(e.preBeatSize=t);let s=0;for(let t of this._voiceContainers.values()){t.registerLayoutingInfo(e);let i=t.x+t.width;s<i&&(s=i)}let i=this._postBeatGlyphs.width;e.postBeatSize<i&&(e.postBeatSize=i)}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let e=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(let t of this._voiceContainers.values()){t.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,t.applyLayoutingInfo(this.layoutingInfo);let s=t.x+t.width;e<s&&(e=s)}this._postBeatGlyphs.x=Math.floor(e),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.computedWidth=this.width;let t=this.barDisplayWidth;return t>0&&2===this.scoreRenderer.layout.systemsLayoutMode&&(this.width=t,this.computedWidth=t),!0}finalizeRenderer(){this.isFinalized=!0;let e=!1,t=this.y-this.staff.topSpacing,s=this.y+this.height+this.staff.bottomSpacing;for(let i of this._ties)if(i.doLayout(),i.height>0){let a=i.y+i.height-s;a>0&&this.registerOverflowBottom(a)&&(e=!0);let r=i.y-t;r<0&&this.registerOverflowTop(-1*r)&&(e=!0)}return e}doLayout(){if(!this.bar)return;this.helpers.initialize(),this._ties=[],this._preBeatGlyphs=new Pl,this._preBeatGlyphs.renderer=this,this._voiceContainers.clear(),this._postBeatGlyphs=new Pl,this._postBeatGlyphs.renderer=this;for(let e=0;e<this.bar.voices.length;e++){let t=this.bar.voices[e];if(this.hasVoiceContainer(t)){let s=new El(0,0,t);s.renderer=this,this._voiceContainers.set(this.bar.voices[e].index,s)}}if(3===this.bar.simileMark&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.additionalMultiRestBars){let e=new hh(this.getVoiceContainer(this.bar.voices[0]));this.addBeatGlyph(e)}else this.createBeatGlyphs();this.createPostBeatGlyphs(),this.updateSizes();for(let e of this.helpers.beamHelpers)for(let t of e)t.finish();this.computedWidth=this.width;let e=this.height,t=this._preBeatGlyphs.glyphs;if(t)for(let s of t){let t=s.getBoundingBoxTop();t<0&&this.registerOverflowTop(-1*t);let i=t+s.height;i>e&&this.registerOverflowBottom(i-e)}let s=this._postBeatGlyphs.glyphs;if(s)for(let t of s){let s=t.getBoundingBoxTop();s<0&&this.registerOverflowTop(-1*s);let i=s+t.height;i>e&&this.registerOverflowBottom(i-e)}}hasVoiceContainer(e){return!(!this.additionalMultiRestBars&&0!==e.index)||!e.isEmpty}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);let e=this._voiceContainers,t=this.beatGlyphsStart,s=t;for(let i of e.values()){i.x=t,i.doLayout();let e=i.x+i.width;s<e&&(s=e)}this._postBeatGlyphs.x=Math.floor(s),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height)}addPreBeatGlyph(e){e.renderer=this,this._preBeatGlyphs.addGlyph(e)}addBeatGlyph(e){e.renderer=this,e.preNotes.renderer=this,e.onNotes.renderer=this,e.onNotes.beamingHelper=this.helpers.beamHelperLookup[e.beat.voice.index].get(e.beat.index),this.getVoiceContainer(e.beat.voice).addGlyph(e)}getVoiceContainer(e){return this._voiceContainers.has(e.index)?this._voiceContainers.get(e.index):void 0}getBeatContainer(e){return this.getVoiceContainer(e.voice)?.beatGlyphs?.[e.index]}getPreNotesGlyphForBeat(e){return this.getBeatContainer(e)?.preNotes}getOnNotesGlyphForBeat(e){return this.getBeatContainer(e)?.onNotes}paint(e,t,s){this.paintBackground(e,t,s),s.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(e+this.x,t+this.y,s);for(let i of this._voiceContainers.values())i.paint(e+this.x,t+this.y,s);s.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(e+this.x,t+this.y,s)}paintBackground(e,t,s){this.layoutingInfo.paint(e+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,t+this.y+this.height,s)}buildBoundingsLookup(e,t,s){let i=new us;i.bar=this.bar,i.visualBounds=new ms,i.visualBounds.x=t+this.x,i.visualBounds.y=s+this.y+this.topPadding,i.visualBounds.w=this.width,i.visualBounds.h=this.height-this.topPadding-this.bottomPadding,i.realBounds=new ms,i.realBounds.x=t+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,e.addBar(i);for(let[e,a]of this._voiceContainers){let r=this.bar.isEmpty&&0===e;if(!a.voice.isEmpty||r)for(let e=0,n=a.beatGlyphs.length;e<n;e++)a.beatGlyphs[e].buildBoundingsLookup(i,t+this.x+a.x,s+this.y+a.y,r)}}addPostBeatGlyph(e){this._postBeatGlyphs.addGlyph(e)}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(let e of this.bar.voices)this.hasVoiceContainer(e)&&this.createVoiceGlyphs(e)}createVoiceGlyphs(e){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(e,t=0){let s=this.getBeatContainer(e);if(s)switch(t){case 0:return s.voiceContainer.x+s.x;case 1:return s.voiceContainer.x+s.x+s.onNotes.x;case 2:return s.voiceContainer.x+s.x+s.onTimeX;case 3:let t=s.onNotes.beamingHelper?s.onNotes.beamingHelper.getBeatLineX(e):s.onNotes.x+s.onNotes.width/2;return s.voiceContainer.x+t;case 4:return s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.width;case 5:return s.voiceContainer.x+s.x+s.width}return 0}getRatioPositionX(e){let t=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],1);return t+(this.postBeatGlyphsStart-t)*e}getNoteX(e,t){let s=this.getBeatContainer(e.beat);return s?s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.getNoteX(e,t):0}getNoteY(e,t){let s=this.getOnNotesGlyphForBeat(e.beat);return s?s.getNoteY(e,t):Number.NaN}reLayout(){(this.wasFirstOfLine&&!this.isFirstOfLine||!this.wasFirstOfLine&&this.isFirstOfLine)&&this.recreatePreBeatGlyphs(),this.updateSizes(),this.registerLayoutingInfo()}recreatePreBeatGlyphs(){this._preBeatGlyphs=new Pl,this._preBeatGlyphs.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(e,t,s){var i=[];try{o(i,Nl.voice(s,0,this.bar.voices[0],!0));switch(this.bar.simileMark){case 1:s.beginGroup(Yo.getGroupId(this.bar.voices[0].beats[0])),Fe.fillMusicFontSymbolSafe(s,e+this.x+this.width/2,t+this.y+this.height/2,1,58624,!0),s.endGroup();break;case 3:s.beginGroup(Yo.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(Yo.getGroupId(this.bar.previousBar.voices[0].beats[0])),Fe.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+this.height/2,1,58625,!0),s.endGroup(),s.endGroup()}}catch(e){var a=e,r=!0}finally{l(i,a,r)}}completeBeamingHelper(e){}getBeatDirection(e){return this.helpers.getBeamingHelperForBeat(e).direction}},ch=class extends Oo{constructor(e,t){super(0,0),this._uniqueEffectGlyphs=[],this._effectGlyphs=[],this.isEmpty=!0,this.previousBand=null,this.isLinkedToPrevious=!1,this.firstBeat=null,this.lastBeat=null,this.height=0,this.originalHeight=0,this.slot=null,this.voice=e,this.info=t}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(e){if(e.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,e)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,(!this.firstBeat||e.isBefore(this.firstBeat))&&(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case 2:case 4:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}let t=this._createOrResizeGlyph(this.info.sizingMode,e);t.height>this.height&&(this.height=t.height,this.originalHeight=t.height)}}resetHeight(){this.height=this.originalHeight}_createOrResizeGlyph(e,t){let s;switch(e){case 5:case 0:case 1:case 2:return s=this.info.createNewGlyph(this.renderer,t),s.renderer=this.renderer,s.beat=t,s.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,s),this._uniqueEffectGlyphs[t.voice.index].push(s),s;case 3:case 4:let i=3===e?1:2;if(t.index>0||this.renderer.index>0){let e=t.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,e)){let s=null;if(t.index>0&&this._effectGlyphs[t.voice.index].has(e.index))s=this._effectGlyphs[t.voice.index].get(e.index);else if(this.renderer.index>0){let t=this.renderer.previousRenderer.getBand(e.voice,this.info.effectId);if(t){let i=t._effectGlyphs[e.voice.index];i.has(e.index)&&(s=i.get(e.index))}}let a=this._createOrResizeGlyph(i,t);return s&&this.info.canExpand(e,t)&&(s.nextGlyph=a,a.previousGlyph=s,this.isLinkedToPrevious=!0),a}return this._createOrResizeGlyph(i,t)}return this._createOrResizeGlyph(i,t);default:return this._createOrResizeGlyph(1,t)}}paint(e,t,s){super.paint(e,t,s);for(let n=0,h=this._uniqueEffectGlyphs.length;n<h;n++){let h=this._uniqueEffectGlyphs[n];for(let n=0,d=h.length;n<d;n++){var i=[];try{let a=h[n];o(i,Nl.beat(s,0,a.beat,!1));a.paint(e+this.x,t+this.y,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(let t of this._effectGlyphs[e].keys())this._alignGlyph(this.info.sizingMode,this.renderer.bar.voices[e].beats[t])}_alignGlyph(e,t){let s=this._effectGlyphs[t.voice.index].get(t.index),i=this.renderer.getBeatContainer(t);switch(e){case 0:let e=this.renderer.layoutingInfo.getPreBeatSize(t);s.x=this.renderer.beatGlyphsStart+i.x-e;break;case 1:case 3:s.x=this.renderer.beatGlyphsStart+i.x;break;case 2:case 4:if(s.x=this.renderer.beatGlyphsStart+i.x,i.beat.isLastOfVoice)s.width=this.renderer.width-s.x;else{let e=this.renderer.layoutingInfo.getPostBeatSize(t);s.width=e}break;case 5:s.width=this.renderer.width}}},uh=class{constructor(){this.uniqueEffectId=null,this.y=0,this.height=0,this.firstBeat=null,this.lastBeat=null}},ph=class{constructor(){this.bands=[],this.shared=new uh}update(e){e.info.canShareBand||(this.shared.uniqueEffectId=e.info.effectId),e.slot=this,this.bands.push(e),e.height>this.shared.height&&(this.shared.height=e.height),(!this.shared.firstBeat||e.firstBeat.isBefore(this.shared.firstBeat))&&(this.shared.firstBeat=e.firstBeat),(!this.shared.lastBeat||e.lastBeat.isAfter(this.shared.lastBeat))&&(this.shared.lastBeat=e.lastBeat)}canBeUsed(e){return(!this.shared.uniqueEffectId&&e.info.canShareBand||e.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(e.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}},mh=class{constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(e){if(this._effectSlot.has(e.info.effectId)){let t=this._effectSlot.get(e.info.effectId);if(t.canBeUsed(e))return t}for(let t of this.slots)if(t.canBeUsed(e))return t;let t=new ph;return this.slots.push(t),t}register(e){let t=this.getOrCreateSlot(e);t.update(e),this._effectSlot.set(e.info.effectId,t)}},gh=class extends dh{constructor(e,t,s){super(e,t),this._bands=[],this._bandLookup=new Map,this.sizingInfo=null,this._infos=s}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this._updateHeight(),super.updateSizes()}finalizeRenderer(){let e=super.finalizeRenderer();return this._updateHeight()&&(e=!0),e}_updateHeight(){if(!this.sizingInfo)return!1;let e=0;for(let t of this.sizingInfo.slots){t.shared.y=e;for(let s of t.bands)s.y=e,s.height=t.shared.height;e+=t.shared.height+this.settings.display.effectBandPaddingBottom}return e=Math.ceil(e),e!==this.height&&(this.height=e,!0)}applyLayoutingInfo(){let e=!super.applyLayoutingInfo();if(this.index>0){let e=this.previousRenderer;this.sizingInfo=e.sizingInfo}else this.sizingInfo=new mh;for(let e of this._bands)e.resetHeight(),e.alignGlyphs(),e.isEmpty||this.sizingInfo.register(e);return this._updateHeight(),e}scaleToWidth(e){super.scaleToWidth(e);for(let e of this._bands)e.alignGlyphs()}createBeatGlyphs(){this._bands=[],this._bandLookup=new Map;for(let e of this.bar.voices)if(this.hasVoiceContainer(e))for(let t of this._infos){let s=new ch(e,t);s.renderer=this,s.doLayout(),this._bands.push(s),this._bandLookup.set(`${e.index}.${t.effectId}`,s)}super.createBeatGlyphs();for(let e of this._bands)e.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(e){for(let t of e.beats){let s=new Yo(t,this.getVoiceContainer(e));s.preNotes=new ah,s.onNotes=new rh,this.addBeatGlyph(s);for(let e of this._bands)e.createGlyph(t)}}paint(e,t,s){this.paintBackground(e,t,s);for(let i of this._bands)s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isEmpty||i.paint(e+this.x,t+this.y,s)}getBand(e,t){let s=`${e.index}.${t}`;return this._bandLookup.has(s)?this._bandLookup.get(s):null}},fh=class extends xl{get staffId(){return this._staffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(e,t,s=null){super(),this.infos=t,this._staffId=e,this.isInsideBracket=!1,this.isRelevantForBoundsLookup=!1,this.shouldShow=s}canCreate(e,t){let s=this.shouldShow;return super.canCreate(e,t)&&(!s||s(e,t))}create(e,t){return new gh(e,t,this.infos.filter(t=>e.settings.notation.isNotationElementVisible(t.notationElement)))}},bh=class extends Vo{constructor(e,t,s,i,a,r){super(e,t),this._endingsString="",this._endings=qe.getAlternateEndingsList(s),this._openLine=i,this._closeLine=a,this._indent=r}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+2*this.renderer.smuflMetrics.alternateEndingsPadding;let e="";for(let t=0,s=this._endings.length;t<s;t++)e+=this._endings[t]+1,e+=". ";this._endingsString=e}paint(e,t,s){let i=this._closeLine?this.width-s.lineWidth:this.width;if(6===this.renderer.bar.getActualBarLineRight()&&(i-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),e=(0|e)+s.lineWidth/2,t=(0|t)+s.lineWidth/2,this._indent&&(e+=this.renderer.smuflMetrics.alternateEndingsPadding,i-=this.renderer.smuflMetrics.alternateEndingsPadding),this._openLine?(s.moveTo(e+this.x,t+this.y+this.height),s.lineTo(e+this.x,t+this.y)):s.moveTo(e+this.x,t+this.y),s.lineTo(e+this.x+i,t+this.y),this._closeLine&&s.lineTo(e+this.x+i,t+this.y+this.height),s.stroke(),this._openLine){let i=s.textBaseline;s.textBaseline=0;let a=this.renderer.resources;s.font=a.wordsFont,s.fillText(this._endingsString,e+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,t+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),s.textBaseline=i}}},yh=class{get effectId(){return this.notationElement.toString()}},_h=class extends yh{get notationElement(){return 14}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return 5}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&0!==t.voice.bar.masterBar.alternateEndings}createNewGlyph(e,t){let s=t.voice.bar.masterBar,i=null===s.previousMasterBar||s.alternateEndings!==s.previousMasterBar.alternateEndings,a=s.isRepeatEnd||null===s.nextMasterBar||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(e=>e.index>=s.index)||(a=!1);let r=null!==s.previousMasterBar&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&s.previousMasterBar.alternateEndings>0;return new bh(0,0,s.alternateEndings,i,a,r)}canExpand(e,t){return!0}},Sh=class extends Vo{constructor(e){super(),this.forceGroupedRendering=!1,this.endOnBarLine=!1,this.endPosition=e}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(e,t,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(e,t,s);let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;let a=i.renderer,r=i.beat,n=this.endPosition,o=e-this.renderer.x,l=this.calculateEndX(a,r,o,n);this.paintGrouped(e,t,l,s)}calculateEndX(e,t,s,i){return t?s+e.x+e.getBeatX(t,i):s+e.x+this.x+this.width}paintNonGrouped(e,t,s){let i=e-this.renderer.x,a=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(e,t,a,s)}},kh=class extends Sh{constructor(e,t=!0){super(1),this._labelWidth=0,this._label=e,this._dashed=t}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=5,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.effectFont;let e=this.renderer.scoreRenderer.canvas.measureText(this._label);this.height=e.height,this._labelWidth=e.width}paintNonGrouped(e,t,s){let i=this.renderer.resources;s.font=i.effectFont;let a=s.textBaseline;s.textBaseline=1,s.fillText(this._label,e+this.x-this._labelWidth/2,t+this.y+this.height/2),s.textBaseline=a}paintGrouped(e,t,s,i){this.paintNonGrouped(e,t,i);let a=this.renderer.smuflMetrics.lineRangedGlyphDashGap,r=this.renderer.smuflMetrics.lineRangedGlyphDashSize,n=this.renderer.smuflMetrics.pedalLineThickness,o=e+this.x+this._labelWidth/2+a/2,l=t+this.y+this.height/2-n/2;if(this._dashed){if(s>o){let e=o;for(;e<s;){let t=Math.min(e+r,s);i.fillRect(e,l,t-e,n),e+=r+a}i.fillRect(s,l-r/2+n/2,n,r)}}else i.fillRect(o,l,s-o,n),i.fillRect(s-n,l,n,r/2)}},wh=class e extends yh{get notationElement(){return 23}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isBarre}get sizingMode(){return 3}createNewGlyph(t,s){let i="";switch(s.barreShape){case 0:case 1:break;case 2:i+="1/2"}return i+=`B ${e.toRoman(s.barreFret)}`,new kh(i,!1)}static toRoman(t){let s="";if(t>0)for(let[i,a]of e._romanLetters){let e=Math.floor(t/a);t-=e*a,s+=i.repeat(e)}return s}canExpand(e,t){return e.barreFret===t.barreFret&&e.barreShape===t.barreShape}};wh._romanLetters=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);var Th=wh,Bh=class extends Vo{constructor(e){super(0,0),this._text="",this._textWidth=0,this._textHeight=0,this._timer=e}doLayout(){let e=this._timer/6e4|0,t=(this._timer-6e4*e)/1e3|0;this._text=`${e}:${t.toString().padStart(2,"0")}`;let s=this.renderer.scoreRenderer.canvas;s.font=this.renderer.resources.timerFont;let i=s.measureText(this._text);this._textHeight=s.font.size+2*this.renderer.smuflMetrics.beatTimerPadding,this._textWidth=i.width+2*this.renderer.smuflMetrics.beatTimerPadding,this.height=this._textHeight+2*this.renderer.smuflMetrics.beatTimerPadding}paint(e,t,s){let i=this._textWidth/2|0;s.strokeRect(e+this.x-i,t+this.y+this.renderer.smuflMetrics.beatTimerPadding,this._textWidth,this._textHeight);let a=s.font,r=s.textBaseline,n=s.textAlign;s.font=this.renderer.resources.timerFont,s.textBaseline=1,s.textAlign=1,s.fillText(this._text,e+this.x,t+this.y+this.height/2),s.font=a,s.textBaseline=r,s.textAlign=n}},xh=class extends yh{get notationElement(){return 49}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return t.showTimer}createNewGlyph(e,t){return new Bh(t.timer??0)}canExpand(e,t){return!0}},vh=class extends yh{get notationElement(){return 15}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0===t.index&&0===t.voice.bar.index&&0!==t.voice.bar.staff.capo}createNewGlyph(e,t){return new Gl(0,0,` ${t.voice.bar.staff.capo}`,e.resources.effectFont,0)}canExpand(e,t){return!1}},Ph=class extends yh{get notationElement(){return 16}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return t.hasChord}createNewGlyph(e,t){return e.settings.notation.showChordDiagramsOnBeats?new Ol(0,0,t.chord):new Gl(0,0,t.chord.name,e.resources.effectFont,1)}canExpand(e,t){return!1}},Nh=class extends Sh{constructor(e,t,s){super(5),this._crescendo=0,this._crescendo=s,this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58686)}paintGrouped(e,t,s,i){let a=e+this.x,r=this.height,n=this.renderer.smuflMetrics.glyphWidths.get(57508)/2;i.beginPath(),1===this._crescendo?(s-=n,i.moveTo(s,t+this.y),i.lineTo(a,t+this.y+r/2),i.lineTo(s,t+this.y+r)):(s-=n,i.moveTo(a,t+this.y),i.lineTo(s,t+this.y+r/2),i.lineTo(a,t+this.y+r));let o=i.lineWidth;i.lineWidth=this.renderer.smuflMetrics.hairpinThickness,i.stroke(),i.lineWidth=o}},Mh=class extends yh{get notationElement(){return 17}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 4}shouldCreateGlyph(e,t){return 0!==t.crescendo}createNewGlyph(e,t){return new Nh(0,0,t.crescendo)}canExpand(e,t){return e.crescendo===t.crescendo}},Eh=class extends Oo{constructor(e){super(0,0),this._scale=1,this._symbols=e}doLayout(){this.height=0;let e=this.renderer.smuflMetrics.directionsScale;this._scale=e;for(let t of this._symbols){let s=this.renderer.smuflMetrics.glyphHeights.get(t)*e;s>this.height&&(this.height=s)}}paint(e,t,s){s.fillMusicFontSymbols(e+this.x,t+this.y+this.height,this._scale,this._symbols,!0)}},Lh=class extends Oo{constructor(e){super(0,0),this._text=e}doLayout(){let e=this.renderer.scoreRenderer.canvas;e.font=this.renderer.resources.directionsFont,this.height=e.measureText(this._text).height}paint(e,t,s){let i=s.font,a=s.textBaseline,r=s.textAlign;s.font=this.renderer.resources.directionsFont,s.textBaseline=1,s.textAlign=2,s.fillText(this._text,e+this.x,t+this.y+this.height/2),s.font=i,s.textBaseline=a,s.textAlign=r}},Ch=class extends Vo{constructor(e,t,s){super(e,t),this._barBeginGlyphs=[],this._barEndGlyphs=[],this._directions=s}doLayout(){let e=this._directions;e.has(2)&&this._barBeginGlyphs.push(new Eh([57415,57415])),e.has(1)&&this._barBeginGlyphs.push(new Eh([57415])),e.has(4)&&this._barBeginGlyphs.push(new Eh([57416,57416])),e.has(3)&&this._barBeginGlyphs.push(new Eh([57416])),e.has(0)&&this._barEndGlyphs.push(new Lh("Fine")),e.has(18)&&this._barEndGlyphs.push(new Lh("To Double Coda")),e.has(17)&&this._barEndGlyphs.push(new Lh("To Coda")),e.has(13)&&this._barEndGlyphs.push(new Lh("D.S.S.")),e.has(14)&&this._barEndGlyphs.push(new Lh("D.S.S. al Coda")),e.has(15)&&this._barEndGlyphs.push(new Lh("D.S.S. al Double Coda")),e.has(16)&&this._barEndGlyphs.push(new Lh("D.S.S. al Fine")),e.has(9)&&this._barEndGlyphs.push(new Lh("D.S.")),e.has(10)&&this._barEndGlyphs.push(new Lh("D.S. al Coda")),e.has(11)&&this._barEndGlyphs.push(new Lh("D.S. al Double Coda")),e.has(12)&&this._barEndGlyphs.push(new Lh("D.S. al Fine")),e.has(5)&&this._barEndGlyphs.push(new Lh("D.C.")),e.has(6)&&this._barEndGlyphs.push(new Lh("D.C. al Coda")),e.has(7)&&this._barEndGlyphs.push(new Lh("D.C. al Double Coda")),e.has(8)&&this._barEndGlyphs.push(new Lh("D.C. al Fine"));let t=this._doSideLayout(this._barBeginGlyphs),s=this._doSideLayout(this._barEndGlyphs);this.height=Math.max(t,s)}_doSideLayout(e){let t=0,s=this.renderer.settings.display.effectBandPaddingBottom;for(let i of e)i.y=t,i.renderer=this.renderer,i.doLayout(),t+=i.height+s;return t}paint(e,t,s){for(let i of this._barBeginGlyphs)i.paint(e+this.x,t+this.y,s);for(let i of this._barEndGlyphs)i.paint(e+this.x+this.width,t+this.y,s)}},Fh=class extends yh{get notationElement(){return 48}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return 5}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&null!==t.voice.bar.masterBar.directions&&t.voice.bar.masterBar.directions.size>0}createNewGlyph(e,t){return new Ch(0,0,t.voice.bar.masterBar.directions)}canExpand(e,t){return!0}},Dh=class e extends Wo{constructor(t,s,i){super(t,s,1,e._getSymbol(i))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(58658);let e=this.renderer.smuflMetrics.glyphTop.get(58658);this.offsetY=e}static _getSymbol(e){switch(e){case 0:return 58666;case 1:return 58667;case 2:return 58656;case 3:return 58668;case 4:return 58669;case 5:default:return-1;case 6:return 58671;case 7:return 58672;case 8:return 58665;case 9:case 10:return 58664;case 11:return 58673;case 12:return 58674;case 13:return 58675;case 14:return 58678;case 15:return 58679;case 16:return 58680;case 17:return 58676;case 18:return 58684;case 19:return 58685;case 20:return 58681;case 21:return 58683;case 22:return 58677;case 23:return 58662;case 24:return 58670;case 25:return 58682}}},Ih=class extends yh{get notationElement(){return 18}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return this._internalShouldCreateGlyph(t)}_internalShouldCreateGlyph(e){if(e.voice.bar.staff.track.score.stylesheet.hideDynamics||e.isEmpty||e.voice.isEmpty||e.isRest)return!1;let t=this._getPreviousDynamicsBeat(e),s=0===e.voice.index&&!t||e.dynamics!==t?.dynamics;if(s&&e.voice.index>0)for(let t of e.voice.bar.voices)if(t.index<e.voice.index){let i=t.getBeatAtPlaybackStart(e.playbackStart);i&&e.dynamics===i.dynamics&&this._internalShouldCreateGlyph(i)&&(s=!1)}return s}_getPreviousDynamicsBeat(e){let t=e.previousBeat;for(;null!=t;){if(!t.isRest)return t;t=t.previousBeat}return null}createNewGlyph(e,t){return new Dh(0,0,t.dynamics)}canExpand(e,t){return!0}},Ah=class e extends Wo{constructor(t){super(0,0,1,e._getSymbol(t)),this.center=!0}static _getSymbol(e){switch(e){case 1:return 59459;case 2:return 59460;case 3:return 59461}return-1}paint(e,t,s){super.paint(e,t+this.height,s)}},Rh=class extends yh{get notationElement(){return 19}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0!==t.fade}createNewGlyph(e,t){return new Ah(t.fade)}canExpand(e,t){return!0}},Oh=class e extends Wo{constructor(t,s,i){super(t,s,1,e._getSymbol(i))}static _getSymbol(e){switch(e){case 0:return 58564;case 1:return 58560;case 2:return 58566;default:return-1}}paint(e,t,s){super.paint(e-this.width/2,t+this.height,s)}},Vh=class extends yh{get notationElement(){return 20}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0===t.voice.index&&!!t.fermata}createNewGlyph(e,t){return new Oh(0,0,t.fermata.type)}canExpand(e,t){return!0}},Wh=class{constructor(e,t){this.line=0,this.line=e,this.symbols=t}},Hh=class e extends vl{constructor(){super(0,0),this._infos=new Map}get isEmpty(){return 0===this._infos.size}addFingers(t){let s=this.renderer.settings;if(0!==s.notation.fingeringMode&&1!==s.notation.fingeringMode)return;let i=e.fingerToMusicFontSymbol(this.renderer.settings,t.beat,t.leftHandFinger,!0);-1!==i&&this._addFinger(t,i);let a=e.fingerToMusicFontSymbol(this.renderer.settings,t.beat,t.rightHandFinger,!1);-1!==a&&this._addFinger(t,a)}static fingerToMusicFontSymbol(e,t,s,i){if(1===e.notation.fingeringMode||3===e.notation.fingeringMode||Ut.isPiano(t.voice.bar.staff.track.playbackInfo.program))switch(s){case-2:case-1:return-1;case 0:return 60689;case 1:return 60690;case 2:return 60691;case 3:return 60692;case 4:return 60693;default:return-1}if(i)switch(s){case-2:return-1;case-1:return 60688;case 0:return 60696;case 1:return 60689;case 2:return 60690;case 3:return 60691;case 4:return 60692;default:return-1}switch(s){case-2:case-1:return-1;case 0:return 60695;case 1:return 60697;case 2:return 60698;case 3:return 60699;case 4:return 60700;default:return-1}}_addFinger(e,t){let s=this.renderer,i=s.getNoteLine(e);if(this._infos.has(i))this._infos.get(i).symbols.push(t);else{let a=new Wh(i,[t]);a.color=Nl.noteColor(s.resources,3,e),this._infos.set(i,a)}}doLayout(){let e=this.renderer;for(let[t,s]of this._infos){let t=new Ho(0,0,1,s.symbols);t.colorOverride=s.color,t.renderer=e,t.y=e.getScoreY(s.line),t.doLayout(),t.offsetY=t.height/2,this.addGlyph(t),this.width=Math.max(this.width,t.width)}for(let e of this.glyphs){let t=e;t.x=this.width/2,t.center=!0}}},Gh=class extends yh{get notationElement(){return 21}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return!(0!==t.voice.index||t.isRest||2!==e.notation.fingeringMode&&3!==e.notation.fingeringMode||1!==t.notes.length)&&t.notes[0].isFingering}createNewGlyph(e,t){let s=-2,i=!1,a=t.notes[0];-2!==a.leftHandFinger?(s=a.leftHandFinger,i=!0):-2!==a.rightHandFinger&&(s=a.rightHandFinger);let r=Hh.fingerToMusicFontSymbol(e.settings,t,s,i),n=new Wo(0,0,1,r);return n.center=!0,n.renderer=e,n.doLayout(),n.offsetY=e.smuflMetrics.glyphTop.get(n.symbol),n}canExpand(e,t){return!0}},zh=class extends yh{get notationElement(){return 34}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 0}shouldCreateGlyph(e,t){let s=t.voice.bar.masterBar;return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&s.isFreeTime&&(0===s.index||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(e,t){return new Gl(0,0,"Free time",e.resources.effectFont,0)}canExpand(e,t){return!0}},Uh=class extends Wo{constructor(e,t,s=!1){super(e,t,zo.GraceScale,59458),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}},Yh=class extends yh{constructor(e,t){super(),this._type=e,this._shouldCreate=t}get notationElement(){return 43}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){let s=this._shouldCreate;return t.golpe===this._type&&(!s||s(e,t))}createNewGlyph(e,t){return new Uh(0,0,!0)}canExpand(e,t){return!1}},Xh=class extends yh{constructor(){super(...arguments),this.lastCreateInfo=null}shouldCreateGlyph(e,t){this.lastCreateInfo=[];for(let e=0,s=t.notes.length;e<s;e++){let s=t.notes[e];this.shouldCreateGlyphForNote(s)&&this.lastCreateInfo.push(s)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,t){return!0}},$h=class e extends Xh{constructor(e){switch(super(),this._beat=null,this._harmonicType=e,e){case 0:this._effectId="harmonics-none";break;case 1:this._effectId="harmonics-natural";break;case 2:this._effectId="harmonics-artificial";break;case 3:this._effectId="harmonics-pinch";break;case 4:this._effectId="harmonics-tap";break;case 5:this._effectId="harmonics-semi";break;case 6:this._effectId="harmonics-feedback";break;default:this._effectId=""}}get effectId(){return this._effectId}get notationElement(){return 22}shouldCreateGlyphForNote(e){return!(!e.isHarmonic||e.harmonicType!==this._harmonicType)&&(e.beat!==this._beat&&(this._beat=e.beat),!0)}get sizingMode(){return 3}createNewGlyph(t,s){return new kh(e.harmonicToString(this._harmonicType))}static harmonicToString(e){switch(e){case 1:return"N.H.";case 2:return"A.H.";case 3:return"P.H.";case 4:return"T.H.";case 5:return"S.H.";case 6:return"Fdbk."}return""}},Jh=class extends Wo{constructor(){super(0,0,1,59456),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}},qh=class extends Xh{get notationElement(){return 32}get sizingMode(){return 1}shouldCreateGlyphForNote(e){return e.isLeftHandTapped}createNewGlyph(e,t){return new Jh}},jh=class extends yh{get notationElement(){return 23}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isLetRing}get sizingMode(){return 3}createNewGlyph(e,t){return new kh("LetRing")}canExpand(e,t){return!0}},Kh=class extends Vo{constructor(e,t,s,i,a=1){super(e,t),this._lines=s,this.font=i,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(e,t,s){s.font=this.font;let i=s.textAlign;s.textAlign=this.textAlign;for(let i=0;i<this._lines.length;i++)if(this._lines[i]){let a=this._lines[i],r=t+this.y+i*this.font.size+3,n=e+this.x;s.fillText(a,n,r)}s.textAlign=i}},Qh=class extends yh{get notationElement(){return 24}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return!!t.lyrics}createNewGlyph(e,t){return new Kh(0,0,t.lyrics,e.resources.wordsFont,1)}canExpand(e,t){return!0}},Zh=class extends yh{get notationElement(){return 25}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return 0}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.isSectionStart}createNewGlyph(e,t){return new Gl(0,0,t.voice.bar.masterBar.section.marker?`[${t.voice.bar.masterBar.section.marker}] ${t.voice.bar.masterBar.section.text}`:t.voice.bar.masterBar.section.text,e.resources.markerFont,0)}canExpand(e,t){return!0}},ed=class e extends Wo{constructor(t){super(0,0,1,e._getSymbol(t)),this.center=!0}static _getSymbol(e){switch(e){case 1:return 58728;case 2:return 58727;case 3:return 58732;case 4:return 58733}return-1}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58733),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(58733)}},td=class extends yh{get notationElement(){return 46}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return t.notes.some(e=>0!==e.ornament)}createNewGlyph(e,t){return new ed(t.notes.find(e=>0!==e.ornament).ornament)}canExpand(e,t){return!1}},sd=class extends Sh{constructor(e,t){super(4),this._ottava=e,this._aboveStaff=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58645)}paintNonGrouped(e,t,s){this._paintOttava(e,t,s)}_paintOttava(e,t,s){let i=0;switch(this._ottava){case 0:i=this.renderer.smuflMetrics.glyphWidths.get(58645),Fe.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,58645,!1);break;case 1:i=this.renderer.smuflMetrics.glyphWidths.get(58641),Fe.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,58641,!1);break;case 3:i=this.renderer.smuflMetrics.glyphWidths.get(58652),Fe.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,58652,!1);break;case 4:i=1*(this.renderer.smuflMetrics.glyphWidths.get(58644)+this.renderer.smuflMetrics.glyphWidths.get(60565)+this.renderer.smuflMetrics.glyphWidths.get(60563)),Fe.fillMusicFontSymbolsSafe(s,e+this.x-i/2,t+this.y+this.height,1,[58644,60565,60563],!1)}return i/2}paintGrouped(e,t,s,i){let a=this._paintOttava(e,t,i),r=this.renderer.smuflMetrics.lineRangedGlyphDashGap,n=e+this.x+a+r,o=t+this.y,l=.5*this.height;o+=this._aboveStaff?0:this.height;let h=this.renderer.smuflMetrics.lineRangedGlyphDashSize,d=i.lineWidth;if(i.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,s>n){let e=n;for(;e<s;)i.beginPath(),i.moveTo(e,0|o),i.lineTo(Math.min(e+h,s),0|o),e+=h+r,i.stroke();i.beginPath(),this._aboveStaff?(i.moveTo(s,o),i.lineTo(s,o+l)):(i.moveTo(s,o),i.lineTo(s,o-l)),i.stroke()}i.lineWidth=d}},id=class extends yh{get effectId(){return"ottavia-"+(this._aboveStaff?"above":"below")}get notationElement(){return 26}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 3}constructor(e){super(),this._aboveStaff=e}shouldCreateGlyph(e,t){switch(t.ottava){case 0:case 1:return this._aboveStaff;case 3:case 4:return!this._aboveStaff}return!1}createNewGlyph(e,t){return new sd(t.ottava,this._aboveStaff)}canExpand(e,t){return e.ottava===t.ottava}},ad=class extends Xh{get notationElement(){return 27}shouldCreateGlyphForNote(e){return e.isPalmMute}get sizingMode(){return 3}createNewGlyph(e,t){return new kh("P.M.")}},rd=class extends Xh{get notationElement(){return 28}shouldCreateGlyphForNote(e){return 5===e.slideOutType||6===e.slideOutType}get sizingMode(){return 3}createNewGlyph(e,t){return new kh("P.S.")}},nd=class e extends Wo{constructor(t,s,i){super(t,s,zo.GraceScale,e._getSymbol(i)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static _getSymbol(e){switch(e){case 1:return 58898;case 2:return 58896;default:return-1}}},od=class extends yh{get notationElement(){return 29}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0!==t.pickStroke}createNewGlyph(e,t){return new nd(0,0,t.pickStroke)}canExpand(e,t){return!0}},ld=class extends yh{get notationElement(){return 47}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.hasRasgueado}get sizingMode(){return 3}createNewGlyph(e,t){return new kh("rasg.")}canExpand(e,t){return!0}},hd=class extends Sh{constructor(e,t,s,i=!1){super(5),this._symbol=-1,this._repeatOffsetX=0,this._symbolOffsetY=0,this._type=s,this.x=e,this.y=t,this._partialWaves=i}doLayout(){switch(super.doLayout(),this._type){case 1:this._symbol=this.slightVibratoGlyph;break;case 2:this._symbol=this.wideVibratoGlyph}this._repeatOffsetX=this.renderer.smuflMetrics.repeatOffsetX.get(this._symbol),this._symbolOffsetY=this.renderer.smuflMetrics.glyphTop.get(this._symbol),this.height=this.renderer.smuflMetrics.glyphHeights.get(this._symbol)}paintGrouped(e,t,s,i){let a=(s-(e+this.x))/this._repeatOffsetX;this._partialWaves||(a=Math.floor(a)),a<1&&(a=1);let r=[];for(let e=0;e<a;e++)r.push(this._symbol);i.fillMusicFontSymbols(e+this.x,t+this.y+this._symbolOffsetY,1,r,!1)}},dd=class extends hd{get slightVibratoGlyph(){return 60082}get wideVibratoGlyph(){return 60083}},cd=class extends hd{get slightVibratoGlyph(){return 60090}get wideVibratoGlyph(){return 60091}},ud=class extends yh{get notationElement(){return 30}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 4}shouldCreateGlyph(e,t){return 1===t.vibrato}createNewGlyph(e,t){return new cd(0,0,1)}canExpand(e,t){return!0}},pd=class extends Xh{get notationElement(){return 31}shouldCreateGlyphForNote(e){let t=1===e.vibrato||e.isTieDestination&&1===e.tieOrigin.vibrato;return this._hideOnTiedBend&&t&&e.isTieDestination&&e.tieOrigin.hasBend&&(t=!1),t}get sizingMode(){return 4}createNewGlyph(e,t){return new dd(0,0,1)}constructor(e){super(),this._hideOnTiedBend=e}},md=class extends Vo{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58960)}paint(e,t,s){let i=this.renderer,a=t+this.y,r=this.height,n=i.bar.sustainPedals,o=this.renderer.smuflMetrics.glyphWidths.get(58960),l=this.renderer.smuflMetrics.glyphWidths.get(58965),h=0;for(;h<n.length;){let t=n[h];for(;null!=t;){let i=e+this.renderer.getRatioPositionX(t.ratioPosition),d=0;if(0===t.pedalType?(Fe.fillMusicFontSymbolSafe(s,i,a+r,1,58960,!0),d=o/2+this.renderer.smuflMetrics.sustainPedalLinePadding):2===t.pedalType&&(Fe.fillMusicFontSymbolSafe(s,i,a+r,1,58965,!0),d=l/2+this.renderer.smuflMetrics.sustainPedalLinePadding),t.nextPedalMarker)if(t.nextPedalMarker.bar===t.bar){let n=e+this.renderer.getRatioPositionX(t.nextPedalMarker.ratioPosition);switch(t.nextPedalMarker.pedalType){case 0:n-=o/2;break;case 1:break;case 2:n-=l/2}let h=i+d;n>h&&s.fillRect(h,a+r-this.renderer.smuflMetrics.pedalLineThickness,n-h,this.renderer.smuflMetrics.pedalLineThickness)}else{let t=e+this.x+this.width,n=i+d;s.fillRect(n,a+r-this.renderer.smuflMetrics.pedalLineThickness,t-n,this.renderer.smuflMetrics.pedalLineThickness)}if(0===h&&t.previousPedalMarker){let t=e+this.x,n=i-d;s.fillRect(t,a+r-this.renderer.smuflMetrics.pedalLineThickness,n-t,this.renderer.smuflMetrics.pedalLineThickness)}h++,null!=t.nextPedalMarker&&t.nextPedalMarker.bar!==t.bar?(t=null,h=n.length):t=t.nextPedalMarker}}}},gd=class extends yh{get notationElement(){return 42}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 5}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&t.voice.bar.sustainPedals.length>0}createNewGlyph(e,t){return new md}canExpand(e,t){return!0}},fd=class extends yh{get notationElement(){return 32}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return t.slap||t.pop||t.tap}createNewGlyph(e,t){let s=e.resources;return t.slap?new Gl(0,0,"S",s.effectFont,1):t.pop?new Gl(0,0,"P",s.effectFont,1):new Gl(0,0,"T",s.effectFont,1)}canExpand(e,t){return!0}},bd=class extends Vo{constructor(e){super(0,0),this._tempoAutomations=e}doLayout(){super.doLayout();let e=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(60581)*e.engravingSettings.tempoNoteScale}paint(e,t,s){for(let i of this._tempoAutomations){let a=e+this.renderer.getRatioPositionX(i.ratioPosition),r=this.renderer.resources;s.font=r.markerFont;let n=t+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(60581)*r.engravingSettings.tempoNoteScale,o=s.textBaseline;if(s.textBaseline=3,i.text){let e=`${i.text} `,t=s.measureText(e);s.fillText(e,a,n),a+=t.width}else a-=r.engravingSettings.glyphWidths.get(60581)/2;Fe.fillMusicFontSymbolSafe(s,a,n,r.engravingSettings.tempoNoteScale,60581),a+=this.renderer.smuflMetrics.glyphWidths.get(60581)*r.engravingSettings.tempoNoteScale,s.fillText(` = ${i.value.toString()}`,a,n),s.textBaseline=o,a+=s.measureText(` = ${i.value.toString()}`).width}}},yd=class extends yh{get notationElement(){return 33}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return 0}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.tempoAutomations.some(e=>e.isVisible)}createNewGlyph(e,t){return new bd(t.voice.bar.masterBar.tempoAutomations.filter(e=>e.isVisible))}canExpand(e,t){return!0}},_d=class extends yh{get notationElement(){return 34}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 1}shouldCreateGlyph(e,t){return!!t.text}createNewGlyph(e,t){return new Gl(0,0,t.text,e.resources.effectFont,0)}canExpand(e,t){return!0}},Sd=class extends Sh{constructor(e,t){super(5),this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(58726)}paintGrouped(e,t,s,i){let a=this.renderer.smuflMetrics.glyphWidths.get(58726),r=e+this.x+a,n=this.renderer.smuflMetrics.repeatOffsetX.get(60068),o=Math.ceil((s-r)/n),l=[58726];for(let e=0;e<o;e++)l.push(60068);i.fillMusicFontSymbols(e+this.x-a/2,t+this.y+this.height,1,l,!1)}},kd=class extends Xh{get notationElement(){return 35}shouldCreateGlyphForNote(e){return e.isTrill}get sizingMode(){return 4}createNewGlyph(e,t){return new Sd(0,0)}},wd=class extends Vo{constructor(e){super(0,0),this._tupletHeight=0,this._tupletPadding=0,this._tripletFeel=e}doLayout(){super.doLayout();let e=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(60581)*e,this._tupletHeight=this.renderer.smuflMetrics.glyphHeights.get(59523)*e,this._tupletPadding=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this._tupletHeight}paint(e,t,s){e+=this.x,t+=this.y;let i=0,a=0;switch(this._tripletFeel){case 0:i=0,a=0;break;case 2:i=0,a=2;break;case 1:i=1,a=3;break;case 4:i=0,a=4;break;case 3:i=1,a=5;break;case 6:i=0,a=6;break;case 5:i=1,a=7}let r=this.renderer.smuflMetrics.tempoNoteScale,n=t+this.renderer.smuflMetrics.glyphTop.get(60581)*r,o=t+this.height,l=s.textBaseline;s.textBaseline=2,s.font=this.renderer.resources.effectFont,s.fillText("(",e,o),e+=s.measureText("( ").width,e=this._drawGroup(e,n+this._tupletHeight,s,i),s.fillText(" = ",e,o),e+=s.measureText(" = ").width,e=this._drawGroup(e,n+this._tupletHeight,s,a),s.fillText(" )",e,o),s.textBaseline=l}_drawGroup(e,t,s,i){let a=this.renderer.smuflMetrics.tempoNoteScale,r=[],n=[],o=[],l=-1;switch(i){case 0:o.push(1),r=[60581],n=[60581];break;case 1:o.push(1),o.push(1),r=[60581],n=[60581];break;case 2:r=[60581],n=[60583],l=59523;break;case 3:o.push(1),o.push(2),r=[60581],n=[60581],l=59523;break;case 4:o.push(1),o.push(2),r=[60581,32,60599],n=[60581];break;case 5:o.push(1),o.push(1),o.push(2),r=[60581,32,60599],n=[60581];break;case 6:o.push(1),o.push(0),r=[60581],n=[60581,32,60599];break;case 7:o.push(1),o.push(1),o.push(0),r=[60581],n=[60581,32,60599]}let h=this.renderer.smuflMetrics.glyphWidths.get(60581)*a,d=e+h-this.renderer.smuflMetrics.stemThickness*a,c=d+2*h+this.renderer.smuflMetrics.stemThickness*a,u=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,p=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,m=this.renderer.smuflMetrics.brokenBeamWidth*a,g=t-this.renderer.smuflMetrics.glyphHeights.get(60581)*a+u;if(-1!==l){let t=(e+c)/2,i=g-this._tupletHeight-this._tupletPadding,r=this.renderer.smuflMetrics.glyphTop.get(l)*a,n=this.renderer.smuflMetrics.glyphWidths.get(l)*a;Fe.fillMusicFontSymbolSafe(s,t,i+r,a,l,!0);let o=t-n/2-this._tupletPadding,h=t+n/2+this._tupletPadding,d=this._tupletHeight/2,u=s.lineWidth;s.beginPath(),s.moveTo(e,i+d+d),s.lineTo(e,i+d),s.lineTo(o,i+d),s.moveTo(h,i+d),s.lineTo(c,i+d),s.lineTo(c,i+d+d),s.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*a,s.stroke(),s.lineWidth=u}s.fillMusicFontSymbols(e,t,a,r,!1),e+=h,e+=h,s.fillMusicFontSymbols(e,t,a,n,!1),e+=h,(60599===n[n.length-1]||60583===n[0])&&(e+=h);for(let e of o){switch(e){case 0:s.fillRect(d,g,m,u);break;case 1:s.fillRect(d,g,c-d,u);break;case 2:s.fillRect(c-m,g,m,u)}g+=u+p}return e}},Td=class extends yh{get notationElement(){return 36}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return 0}shouldCreateGlyph(e,t){return 0===t.index&&(0===t.voice.bar.masterBar.index&&0!==t.voice.bar.masterBar.tripletFeel||t.voice.bar.masterBar.index>0&&t.voice.bar.masterBar.tripletFeel!==t.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(e,t){return new wd(t.voice.bar.masterBar.tripletFeel)}canExpand(e,t){return!0}},Bd=class e extends Wo{constructor(t){super(0,0,1,e._getSymbol(t)),this.center=!0}static _getSymbol(e){switch(e){case 1:return 59453;case 2:return 59455}return-1}paint(e,t,s){super.paint(e,t+this.height,s)}},xd=class extends yh{get notationElement(){return 44}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 1}shouldCreateGlyph(e,t){return 0!==t.wahPedal}createNewGlyph(e,t){return new Bd(t.wahPedal)}canExpand(e,t){return!1}},vd=class extends yh{get notationElement(){return 37}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return 3}shouldCreateGlyph(e,t){return t.hasWhammyBar}createNewGlyph(e,t){return new kh("w/bar")}canExpand(e,t){return!0}},Pd=class extends yh{get notationElement(){return 38}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return 4}shouldCreateGlyph(e,t){return 2===t.vibrato}createNewGlyph(e,t){return new cd(0,0,2)}canExpand(e,t){return!0}},Nd=class extends Xh{get notationElement(){return 39}shouldCreateGlyphForNote(e){return 2===e.vibrato||e.isTieDestination&&2===e.tieOrigin.vibrato}get sizingMode(){return 4}createNewGlyph(e,t){return new dd(0,0,2)}},Md=class{constructor(){this.x=0,this.width=0,this.masterBars=[]}},Ed=class extends ih{constructor(){super(...arguments),this._system=null}get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let e=this.pagePadding[0];return this._system&&(e+=this._system.accoladeWidth),e}doResize(){}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case 0:this.systemsLayoutMode=0;break;case 1:this.systemsLayoutMode=2}let e=this.renderer.score,t=this.renderer.settings.display.startBar;t--,t=Math.min(e.masterBars.length-1,Math.max(0,t));let s=t,i=this.renderer.settings.display.barCount;i<=0&&(i=e.masterBars.length),i=t+i-1,i=Math.min(e.masterBars.length-1,Math.max(0,i)),this._system=this.createEmptyStaffSystem(),this._system.isLast=!0,this._system.x=this.pagePadding[0],this._system.y=this.pagePadding[1];let a=this.renderer.settings.display.barCountPerPartial,r=[],n=new Md,o=0;for(;s<=i;){let t=this.multiBarRestInfo,i=null!==t&&t.has(s)?t.get(s):null,l=this._system.addBars(this.renderer.tracks,s,i);if(0===n.masterBars.length&&l.isLinkedToPrevious&&r.length>0){let t=r[r.length-1];t.masterBars.push(e.masterBars[s]),t.width+=l.width,o+=l.width,n.x+=o}else n.masterBars.push(e.masterBars[s]),n.width+=l.width,n.masterBars.length>=a&&(0===r.length&&(n.width+=this._system.accoladeWidth+this.pagePadding[0]),o+=n.width,r.push(n),re.debug(this.name,`Finished partial from bar ${n.masterBars[0].index} to ${n.masterBars[n.masterBars.length-1].index}`,null),n=new Md,n.x=o);s++}n.masterBars.length>0&&(0===r.length&&(n.width+=this._system.accoladeWidth+this.pagePadding[0]),r.push(n),re.debug(this.name,`Finished partial from bar ${n.masterBars[0].index} to ${n.masterBars[n.masterBars.length-1].index}`,null)),this._finalizeStaffSystem(),this.height=Math.floor(this._system.y+this._system.height),this.width=this._system.x+this._system.width+this.pagePadding[2],s=0;let l=0;for(let e=0;e<r.length;e++){let t=r[e],i=new ls;i.x=l,i.y=0,i.totalWidth=this.width,i.totalHeight=this.height,i.width=t.width,i.height=this.height,i.firstMasterBarIndex=t.masterBars[0].index,i.lastMasterBarIndex=t.masterBars[t.masterBars.length-1].index,l+=t.width;let a=s,n=e;this._system.buildBoundingsLookup(0,0),this.registerPartial(i,e=>{let s=this._system.getBarX(t.masterBars[0].index)+this._system.accoladeWidth;0===n&&(s-=this._system.x+this._system.accoladeWidth),e.color=this.renderer.settings.display.resources.mainGlyphColor,e.textAlign=0,re.debug(this.name,`Rendering partial from bar ${t.masterBars[0].index} to ${t.masterBars[t.masterBars.length-1].index}`,null),this._system.paintPartial(-s,this._system.y,e,a,t.masterBars.length)}),s+=t.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3],this.height*=this.renderer.settings.display.scale}_finalizeStaffSystem(){this._system.scaleToWidth(this._system.width),this._system.finalizeSystem()}},Ld=class extends ih{constructor(){super(...arguments),this._systems=[],this._allMasterBarRenderers=[],this._barsFromPreviousSystem=[]}get name(){return"PageView"}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case 0:this.systemsLayoutMode=0;break;case 1:this.systemsLayoutMode=1}let e=this.pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],e=this._layoutAndRenderScoreInfo(e,-1),e=this._layoutAndRenderTunings(e,-1),e=this._layoutAndRenderChordDiagrams(e,-1),e=this._layoutAndRenderScore(e),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}get supportsResize(){return!0}get firstBarX(){let e=this.pagePadding[0];return this._systems.length>0&&(e+=this._systems[0].accoladeWidth),e}doResize(){let e=this.pagePadding[1];this.width=this.renderer.width;let t=this.height;e=this._layoutAndRenderScoreInfo(e,t),e=this._layoutAndRenderTunings(e,t),e=this._layoutAndRenderChordDiagrams(e,t),e=this._resizeAndRenderScore(e,t),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}_layoutAndRenderTunings(e,t=-1){if(!this.tuningGlyph)return e;let s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();let i=Math.round(this.tuningGlyph.height),a=new ls;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=i,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+a.height:t,this.registerPartial(a,e=>{e.color=s.scoreInfoColor,e.textAlign=1,this.tuningGlyph.paint(0,0,e)}),e+i}_layoutAndRenderChordDiagrams(e,t=-1){if(!this.chordDiagrams)return e;let s=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();let i=Math.round(this.chordDiagrams.height),a=new ls;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=i,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+i:t,this.registerPartial(a,e=>{e.color=s.scoreInfoColor,e.textAlign=1,this.chordDiagrams.paint(0,0,e)}),e+i}_layoutAndRenderScoreInfo(e,t=-1){re.debug(this.name,"Layouting score info");let s=new ls;s.x=0,s.y=e;let i=0,a=this.renderer.settings.display.resources,r=[];for(let[e,t]of ih.headerElements.value)if(this.headerGlyphs.has(e)){let t=this.headerGlyphs.get(e);t.y=i,this.alignScoreInfoGlyph(t);let s=t.font.size;4===e&&this.headerGlyphs.has(5)&&this.headerGlyphs.get(5).textAlign!==t.textAlign&&(s=0),i+=s,r.push(t)}return r.length>0&&(i=Math.floor(i+17),s.width=this.scaledWidth,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=t<0?e+s.height:t,this.registerPartial(s,e=>{e.color=a.scoreInfoColor,e.textAlign=1;for(let t of r)t.paint(0,0,e)})),e+i}_resizeAndRenderScore(e,t){if(this.renderer.settings.display.barsPerRow>0||1===this.systemsLayoutMode)for(let s=0;s<this._systems.length;s++){let i=this._systems[s];this._fitSystem(i),e+=this._paintSystem(i,t)}else{this._systems=[];let s=0,i=this._maxWidth,a=this.createEmptyStaffSystem();for(a.index=this._systems.length,a.x=this.pagePadding[0],a.y=e;s<this._allMasterBarRenderers.length;){let r=this._allMasterBarRenderers[s];if(a.width+r.width<=i||0===a.masterBarsRenderers.length)a.addMasterBarRenderers(this.renderer.tracks,r),s++;else{for(;r&&!r.canWrap&&a.masterBarsRenderers.length>1;)r=a.revertLastBar(),s--;a.isFull=!0,a.isLast=this.lastBarIndex===a.lastBarIndex,this._systems.push(a),this._fitSystem(a),e+=this._paintSystem(a,t),a=this.createEmptyStaffSystem(),a.index=this._systems.length,a.x=this.pagePadding[0],a.y=e}}a.isLast=this.lastBarIndex===a.lastBarIndex,this._fitSystem(a),e+=this._paintSystem(a,t)}return e}_layoutAndRenderScore(e){let t=this.firstBarIndex,s=this.lastBarIndex;for(this._systems=[];t<=s;){let i=this._createStaffSystem(t,s);this._systems.push(i),i.x=this.pagePadding[0],i.y=e,t=i.lastBarIndex+1,this._fitSystem(i),re.debug(this.name,`Rendering partial from bar ${i.firstBarIndex} to ${i.lastBarIndex}`,null),e+=this._paintSystem(i,e)}return e}_paintSystem(e,t){let s=Math.floor(e.height),i=new ls;return i.x=0,i.y=e.y,i.totalWidth=this.scaledWidth,i.totalHeight=t,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=e.firstBarIndex,i.lastMasterBarIndex=e.lastBarIndex,e.buildBoundingsLookup(0,0),this.registerPartial(i,t=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=0,e.paint(0,-i.y/this.renderer.settings.display.scale,t)}),s}_fitSystem(e){e.isFull||e.width>this._maxWidth||this.renderer.settings.display.justifyLastSystem?e.scaleToWidth(this._maxWidth):e.scaleToWidth(e.width),e.finalizeSystem()}_getBarsPerSystem(e){let t=this.renderer.settings.display.barsPerRow;if(1===this.systemsLayoutMode){let s,i;this.renderer.tracks.length>1?(s=this.renderer.score.defaultSystemsLayout,i=this.renderer.score.systemsLayout):(s=this.renderer.tracks[0].defaultSystemsLayout,i=this.renderer.tracks[0].systemsLayout),t=e<i.length?i[e]:s}return t}_createStaffSystem(e,t){let s=this.createEmptyStaffSystem();s.index=this._systems.length;let i=this._getBarsPerSystem(s.index),a=this._maxWidth,r=t+1,n=e;for(;n<r;){if(this._barsFromPreviousSystem.length>0)for(let e of this._barsFromPreviousSystem)s.addMasterBarRenderers(this.renderer.tracks,e),n=e.lastMasterBarIndex;else{let e=this.multiBarRestInfo,t=null!==e&&e.has(n)?e.get(n):null,i=s.addBars(this.renderer.tracks,n,t);this._allMasterBarRenderers.push(i),n=i.lastMasterBarIndex}this._barsFromPreviousSystem=[];let e=!1;if((-1===i&&s.width>=a&&0!==s.masterBarsRenderers.length||s.masterBarsRenderers.length===i+1)&&(e=!0),e){let e=s.revertLastBar();if(e)for(this._barsFromPreviousSystem.push(e);e&&!e.canWrap&&s.masterBarsRenderers.length>1;)e=s.revertLastBar(),e&&this._barsFromPreviousSystem.push(e);return s.isFull=!0,s.isLast=!1,this._barsFromPreviousSystem.reverse(),s}let t=!1,r=!0;for(let e of this.renderer.tracks)e.lineBreaks&&e.lineBreaks.has(n+1)?t=!0:r=!1;if(t&&r)return s.isFull=!0,s.isLast=!1,s;s.x=0,n++}return s.isLast=t===s.lastBarIndex,s}get _maxWidth(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}},Cd=class extends Oo{constructor(e,t,s){super(e,t),this.width=s}},Fd=class extends Oo{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}},Dd=class extends Fd{constructor(e,t,s){super(e,t),this._isRepeat=s}doLayout(){this.width=this._isRepeat?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paint(e,t,s){s.fillRect(e+this.x,t+this.y,this.renderer.smuflMetrics.thinBarlineThickness,this.height)}},Id=class extends Fd{paint(e,t,s){let i=this.renderer.smuflMetrics.thinBarlineThickness/2,a=this.renderer.getLineHeight(1),r=t+this.y+.5*a+i,n=t+this.y+this.height;for(;r<n;)s.fillCircle(e+this.x,r,i),r+=a}},Ad=class extends Fd{paint(e,t,s){let i=this.renderer.smuflMetrics.dashedBarlineDashLength,a=e+this.x-this.width/2,r=Math.ceil(this.height/2/i),n=t+this.y+this.height,o=this.renderer.smuflMetrics.dashedBarlineGapLength,l=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),r<1)s.moveTo(a,t+this.y),s.lineTo(a,n);else{let e=t+this.y;for(;e<n;){s.moveTo(a,e);let t=Math.min(n-e,i);s.lineTo(a,e+t),e+=i+o}}s.stroke(),s.lineWidth=l}},Rd=class extends Fd{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paint(e,t,s){s.fillRect(e+this.x,t+this.y,this.width,this.height)}},Od=class extends Fd{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(57412)}paint(e,t,s){let i=this.renderer,a=i.heightLineCount%2==0?1:.5,r=t+this.y+this.height/2,n=i.getLineHeight(a),o=i.smuflMetrics.glyphTop.get(57412)-i.smuflMetrics.glyphHeights.get(57412)/2;Fe.fillMusicFontSymbolSafe(s,e+this.x,r+o-n,1,57412),Fe.fillMusicFontSymbolSafe(s,e+this.x,r+o+n,1,57412)}},Vd=class extends Fd{paint(e,t,s){let i=this.renderer;if(i.drawnLineCount-1<=2)return;let a=i.smuflMetrics.staffLineThickness/2,r=(i.drawnLineCount-1)/2,n=i.getLineY(r-1)-a,o=i.getLineY(r+1)+a;s.fillRect(e+this.x,t+n,i.smuflMetrics.thinBarlineThickness,o-n)}},Wd=class extends Fd{paint(e,t,s){let i=this.renderer.getLineHeight(1),a=-i/2+1;s.fillRect(e+this.x,t+this.y+a,1,i)}},Hd=class extends Pl{constructor(e){super(),this._isRight=e}doLayout(){let e=this.renderer.bar,t=e.masterBar,s=this._isRight?e.getActualBarLineRight():e.getActualBarLineLeft(0===this.renderer.index),i=this._isRight&&t.isRepeatEnd||!this._isRight&&t.isRepeatStart,a=0;if(!this._isRight){let e=this.renderer.previousRenderer;if(e&&e.staff===this.renderer.staff&&(a=e.bar.getActualBarLineRight(),s===a))return}switch(this._isRight&&t.isRepeatEnd&&(this.addGlyph(new Od(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),s){case 1:this.addGlyph(new Ad(0,0));break;case 2:this.addGlyph(new Id(0,0));break;case 3:6!==a&&4!==a&&this.addGlyph(new Rd(0,0));break;case 4:6!==a&&3!==a&&this.addGlyph(new Rd(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Rd(0,0));break;case 5:6!==a&&3!==a&&4!==a&&this.addGlyph(new Rd(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Dd(0,0,i));break;case 6:5!==a&&9!==a&&7!==a&&this.addGlyph(new Dd(0,0,i)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Rd(0,0));break;case 7:5!==a&&9!==a&&this.addGlyph(new Dd(0,0,i)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Dd(0,0,i));break;case 8:break;case 9:5!==a&&7!==a&&this.addGlyph(new Dd(0,0,i));break;case 10:this.addGlyph(new Vd(0,0));break;case 11:this.addGlyph(new Wd(0,0))}this._isRight||t.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new Od(0,0)));let r=this.renderer,n=r.smuflMetrics.staffLineThickness,o=this.y+r.topPadding-n,l=this.y+this.renderer.height-this.renderer.bottomPadding-o;for(let e of this.glyphs)e.y=o,e.height=l}paint(e,t,s){var i=[];try{let a=this.renderer;o(i,Nl.bar(s,a.barLineBarSubElement,this.renderer.bar,!0));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},Gd=class extends Oo{constructor(e,t,s){super(e,t),this._count=0,this._count=0,this._count=s}doLayout(){this.width=0}paint(e,t,s){var i=[];try{o(i,Nl.bar(s,this.renderer.repeatsBarSubElement,this.renderer.bar));let a=this.renderer.resources,r=s.textAlign;s.font=a.barNumberFont,s.textAlign=2;let n=`x${this._count}`,l=s.measureText(n).width/1.5;s.fillText(n,e+this.x-l,t+this.y),s.textAlign=r}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},zd=class extends Oo{constructor(e,t,s){super(e,t),this._number=`${s}  `}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number).width}paint(e,t,s){var i=[];try{if(!this.renderer.staff.isFirstInSystem)return;o(i,Nl.bar(s,this.renderer.barNumberBarSubElement,this.renderer.bar,!0));let a=this.renderer.resources,r=s.textBaseline;s.textBaseline=0,s.font=a.barNumberFont,s.fillText(this._number,e+this.x,t+this.y),s.textBaseline=r}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},Ud=class e extends dh{constructor(){super(...arguments),this.firstLineY=0,this._startSpacing=!1,this.tupletSize=0}get lineOffset(){return this.lineSpacing}get tupletOffset(){return.5*this.smuflMetrics.oneStaffSpace}get topGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}get bottomGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){let e=this.lineOffset*(this.heightLineCount-1),t=(this.drawnLineCount-1)*this.lineOffset,s=this.smuflMetrics.staffLineThickness/2;this.firstLineY=(this.topPadding+(e-t)/2|0)-s}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(59520),super.doLayout()}getLineY(e){return this.firstLineY+this.getLineHeight(e)}getLineHeight(e){return this.lineOffset*e}paintBackground(e,t,s){super.paintBackground(e,t,s),this.paintStaffLines(e,t,s),this.paintSimileMark(e,t,s)}paintStaffLines(e,t,s){var i=[];try{o(i,Nl.bar(s,this.staffLineBarSubElement,this.bar,!0));let a=[];for(let e=0,t=this.drawnLineCount;e<t;e++)a.push([]);this.additionalMultiRestBars||this.collectSpaces(a);for(let e of a)e.sort((e,t)=>e[0]>t[0]?1:e[0]<t[0]?-1:0);let r=this.width,n=this.smuflMetrics.staffLineThickness/2;for(let i=0;i<this.drawnLineCount;i++){let o=this.getLineY(i)-n,l=0;for(let r of a[i])s.fillRect(e+this.x+l,t+this.y+o,r[0]-l,this.smuflMetrics.staffLineThickness),l=r[0]+r[1];s.fillRect(e+this.x+l,t+this.y+o,r-l,this.smuflMetrics.staffLineThickness)}}catch(e){var a=e,r=!0}finally{l(i,a,r)}}collectSpaces(e){}createStartSpacing(){if(this._startSpacing)return;let e=0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;this.addPreBeatGlyph(new Cd(0,0,e)),this._startSpacing=!0}paintTuplets(e,t,s,i,a=!1){for(let r of this.bar.voices)if(this.hasVoiceContainer(r)){let n=this.getVoiceContainer(r);for(let r of n.tupletGroups)this._paintTupletHelper(e+this.beatGlyphsStart,t,s,r,i,a)}}getTupletBeamDirection(e){return this.getBeamDirection(e)}_paintTupletHelper(e,t,s,i,a,r){var n=[];try{let l,h=this.resources,d=s.textAlign,c=s.textBaseline;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=1,s.textBaseline=1;let u=i.beats[0].tupletNumerator,p=i.beats[0].tupletDenominator;if(2===u&&3===p)l=[59522];else if(3===u&&2===p)l=[59523];else if(4===u&&6===p)l=[59524];else if(5===u&&4===p)l=[59525];else if(6===u&&4===p)l=[59526];else if(7===u&&4===p)l=[59527];else if(9===u&&8===p)l=[59529];else if(10===u&&8===p)l=[59521,59520];else if(11===u&&8===p)l=[59521,59521];else if(12===u&&8===p)l=[59521,59522];else if(13===u&&8===p)l=[59521,59523];else{l=[];let e=59520;u>10?(l.push(e+Math.floor(u/10)),l.push(e+(u-10))):l.push(e+u),l.push(59530),p>10?(l.push(e+Math.floor(p/10)),l.push(e+(p-10))):l.push(e+p)}let m=this.tupletOffset,g=this.tupletSize,f=(o(n,Nl.beat(s,a,i.beats[0])),s.lineWidth);if(s.lineWidth=this.smuflMetrics.tupletBracketThickness,1!==i.beats.length&&i.isFull){let a=i.beats[0],n=i.beats[i.beats.length-1],o=null,d=null;for(let e=0;e<i.beats.length;e++)if(!i.beats[e].isRest){o=i.beats[e];break}for(let e=i.beats.length-1;e>=0;e--)if(!i.beats[e].isRest){d=i.beats[e];break}let c=!1;o||(o=a,c=!0),d||(d=n);let u=this.getBeatX(a,1)-this.beatGlyphsStart,p=this.getBeatX(n,4)-this.beatGlyphsStart,f=this.helpers.beamHelperLookup[i.voice.index].get(o.index),b=this.helpers.beamHelperLookup[i.voice.index].get(d.index),y=this.getTupletBeamDirection(f),_=this.calculateBeamYWithDirection(f,u,y),S=this.calculateBeamYWithDirection(b,p,y);c&&(_=Math.max(_,S),S=_);let k=m+.5*g;1===y?(_+=k,S+=k):(_-=k,S-=k);let w=l.reduce((e,t)=>e+h.engravingSettings.glyphWidths.get(t),0),T=.5*h.engravingSettings.oneStaffSpace,B=(u+p)/2,x=B-w/2-T,v=B+w/2+T,P=(S-_)/(p-u),N=_-P*u,M=P*x+N,E=P*B+N,L=P*v+N,C=1===y?_-.5*g:_+.5*g,F=1===y?S-.5*g:S+.5*g,D=s.lineWidth%2==0?0:.5;e+=D,t+=D,x>u&&(s.beginPath(),s.moveTo(e+this.x+u,t+this.y+C),r?s.quadraticCurveTo(e+this.x+(x+u)/2,t+this.y+M,e+this.x+x,t+this.y+M):(s.lineTo(e+this.x+u,t+this.y+_),s.lineTo(e+this.x+x,t+this.y+M)),s.moveTo(e+this.x+v,t+this.y+L),r?s.quadraticCurveTo(e+this.x+(p+v)/2,t+this.y+L,e+this.x+p,t+this.y+F):(s.lineTo(e+this.x+p,t+this.y+S),s.lineTo(e+this.x+p,t+this.y+F)),s.stroke()),s.fillMusicFontSymbols(e+this.x+B,t+this.y+E+.5*g,1,l,!0)}else for(let a of i.beats){let r=this.helpers.beamHelperLookup[i.voice.index].get(a.index);if(!r)continue;let n=this.getTupletBeamDirection(r),o=r.getBeatLineX(a),h=this.calculateBeamYWithDirection(r,o,n);1===n?h+=m+g:h-=m+g,s.fillMusicFontSymbols(e+this.x+o,t+this.y+h,1,l,!0)}s.textAlign=d,s.textBaseline=c,s.lineWidth=f}catch(e){var h=e,d=!0}finally{l(n,h,d)}}paintBeams(e,t,s,i,a){for(let r of this.helpers.beamHelpers)for(let n of r)this._paintBeamHelper(e+this.beatGlyphsStart,t,s,n,i,a)}drawBeamHelperAsFlags(e){return 1===e.beats.length}_paintBeamHelper(e,t,s,i,a,r){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,this.drawBeamHelperAsFlags(i)?this.paintFlag(e,t,s,i,a):this.paintBar(e,t,s,i,r)}shouldPaintFlag(e,t){return!(3===e.graceType||e.deadSlapped||!t.hasBeatLineX(e)||0!==e.graceType&&1===this.settings.notation.notationMode||1===e.duration||-2===e.duration||-4===e.duration)}paintFlag(e,t,s,i,a){for(let d of i.beats){var r=[];try{if(!this.shouldPaintFlag(d,i))continue;let n=0!==d.graceType,l=i.getBeatLineX(d),h=this.getBeamDirection(i),c=t+this.y+this.getFlagTopY(d,h),u=t+this.y+this.getFlagBottomY(d,h),p=0;if(p=1===h?u:c,!i.hasLine(!0,d))continue;this.paintBeamingStem(d,t+this.y,e+this.x+l,c,u,s);o(r,Nl.beat(s,a,d));let m=0;if(i.hasFlag(!0,d)){let t=new Uo(e+this.x+l,p,d.duration,h,n);t.renderer=this,t.doLayout(),t.paint(0,0,s),m=t.width/2}2===d.graceType&&(1===h?Fe.fillMusicFontSymbolSafe(s,e+this.x+l+m/2,(c+u-this.smuflMetrics.glyphHeights.get(58725))/2,zo.GraceScale,58725,!0):Fe.fillMusicFontSymbolSafe(s,e+this.x+l+m/2,(c+u+this.smuflMetrics.glyphHeights.get(58724))/2,zo.GraceScale,58724,!0))}catch(e){var n=e,h=!0}finally{l(r,n,h)}}}getFlagStemSize(e,t=!1){let s=0;switch(e){case-4:case 2:case 4:case 8:case 16:case 32:case 64:case 128:case 256:s=this.smuflMetrics.standardStemLength+this.smuflMetrics.stemFlagOffsets.get(e);break;default:s=t?this.smuflMetrics.standardStemLength:0}return s}recreatePreBeatGlyphs(){this._startSpacing=!1,super.recreatePreBeatGlyphs()}calculateBeamY(e,t){return this.calculateBeamYWithDirection(e,t,this.getBeamDirection(e))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new Hd(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new zd(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs();let e=this.lastBar;this.addPostBeatGlyph(new Hd(!0)),e.masterBar.isRepeatEnd&&e.masterBar.repeatCount>2&&this.addPostBeatGlyph(new Gd(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))}paintBar(t,s,i,a,r){let n=this.getBeamDirection(a),h=0!==a.graceType?zo.GraceScale:1,d=(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*h,c=this.smuflMetrics.beamThickness*h;1===n&&(d=-d,c=-c);for(let g=0,f=a.beats.length;g<f;g++){var u=[];try{let l=a.beats[g];if(!a.hasBeatLineX(l)||l.deadSlapped)continue;let p=a.getBeatLineX(l),m=s+this.y+this.getBarLineStart(l,n),f=s+this.y+this.calculateBeamY(a,p)|0;m<f?this.paintBeamingStem(l,s+this.y,t+this.x+p,m,f,i):this.paintBeamingStem(l,s+this.y,t+this.x+p,f,m,i);o(u,Nl.beat(i,r,l));let b=this.smuflMetrics.brokenBeamWidth*h,y=qe.getIndex(l.duration)-2,_=s+this.y;for(let s=0;s<y;s++){let r=0,n=0,o=0,h=0,u=_+s*d;if(g<a.beats.length-1){let d=Fl.isFullBarJoin(l,a.beats[g+1],s);if(s===y-1&&d&&3===l.beamingMode)r=p,n=r+b,o=u+this.calculateBeamY(a,r),h=u+this.calculateBeamY(a,n),e.paintSingleBar(i,t+this.x+r,o,t+this.x+n,h,c),n=a.getBeatLineX(a.beats[g+1]),r=n-b,o=u+this.calculateBeamY(a,r),h=u+this.calculateBeamY(a,n),e.paintSingleBar(i,t+this.x+r,o,t+this.x+n,h,c);else{if(d)r=p,n=a.getBeatLineX(a.beats[g+1]);else{if(0!==g&&Fl.isFullBarJoin(a.beats[g-1],l,s))continue;r=p,n=r+b}o=u+this.calculateBeamY(a,r),h=u+this.calculateBeamY(a,n),0===s&&(o|=0,h|=0),e.paintSingleBar(i,t+this.x+r,o,t+this.x+n,h,c)}}else g>0&&!Fl.isFullBarJoin(l,a.beats[g-1],s)&&(r=p-b,n=p,n=p,o=u+this.calculateBeamY(a,r),h=u+this.calculateBeamY(a,n),e.paintSingleBar(i,t+this.x+r,o,t+this.x+n,h,c))}}catch(e){var p=e,m=!0}finally{l(u,p,m)}}if(2===a.graceType){let e=a.getBeatLineX(a.beats[0]),r=this.smuflMetrics.glyphWidths.get(57920)*zo.GraceScale,o=s+this.y+this.calculateBeamY(a,e)|0;o+=c+d,1===n?Fe.fillMusicFontSymbolSafe(i,t+this.x+e+r/2,o,zo.GraceScale,58725,!0):Fe.fillMusicFontSymbolSafe(i,t+this.x+e+r/2,o,zo.GraceScale,58724,!0)}}static paintSingleBar(e,t,s,i,a,r){e.beginPath(),e.moveTo(t,s),e.lineTo(i,a),e.lineTo(i,a+r),e.lineTo(t,s+r),e.closePath(),e.fill()}},Yd=class e extends Oo{constructor(e,t,s){super(0,0),this.yOffset=0,this.startNoteRenderer=null,this.endNoteRenderer=null,this.tieDirection=0,this._startX=0,this._startY=0,this._endX=0,this._endY=0,this._tieHeight=0,this._shouldDraw=!1,this.startBeat=e,this.endBeat=t,this.forEnd=s}doLayout(){if(this.width=0,!this.endBeat)return void(this._shouldDraw=!1);let t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar);this.startNoteRenderer=t;let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar);if(this.endNoteRenderer=s,this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this._shouldDraw=!1,this.tieDirection=t?this.getBeamDirection(this.startBeat,t):this.getBeamDirection(this.endBeat,s),!this.forEnd&&t?(t!==s?(this._startX=t.x+this.getStartX(),this._startY=t.y+this.getStartY()+this.yOffset,s&&t.staff===s.staff?(this._endX=s.x+this.getEndX(),this._endY=s.y+this.getEndY()+this.yOffset):(this._endX=t.x+t.width,this._endY=this._startY)):(this._startX=t.x+this.getStartX(),this._endX=s.x+this.getEndX(),this._startY=t.y+this.getStartY()+this.yOffset,this._endY=s.y+this.getEndY()+this.yOffset),this._shouldDraw=!0):(!t||t.staff!==s.staff)&&(this._startX=s.x,this._endX=s.x+this.getEndX(),this._startY=s.y+this.getEndY()+this.yOffset,this._endY=this._startY,this._shouldDraw=!0),this._shouldDraw)if(this.y=Math.min(this._startY,this._endY),this.shouldDrawBendSlur())this._tieHeight=0;else{this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY);let t=e.calculateActualTieHeight(1,this._startX,this._startY,this._endX,this._endY,1===this.tieDirection,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness);if(this.height=t.h,0===this.tieDirection){let e=this.y-t.y;e>0&&(this.y-=e)}}}paint(t,s,i){this._shouldDraw&&(this.shouldDrawBendSlur()?e.drawBendSlur(i,t+this._startX,s+this._startY,t+this._endX,s+this._endY,1===this.tieDirection,1,this.renderer.smuflMetrics.tieHeight):e.paintTie(i,1,t+this._startX,s+this._startY,t+this._endX,s+this._endY,1===this.tieDirection,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness))}shouldDrawBendSlur(){return!1}getTieHeight(e,t,s,i){return this.renderer.smuflMetrics.tieHeight}getBeamDirection(e,t){return 1}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(t,s,i,a,r,n,o,l){let h=e._computeBezierControlPoints(t,s,i,a,r,n,o,l);if(h.length<8){let e=new ms;return e.x=s,e.y=i,e.w=0,e.h=0,e}s=h[0],i=h[1];let d=h[2],c=h[3];a=h[6],r=h[7];let u=(s-d)/(s-2*d+a),p=e._calculateExtrema(s,i,d,c,a,r,u),m=p.length>0?Math.min(s,a,p[0]):Math.min(s,a),g=p.length>0?Math.max(s,a,p[0]):Math.max(s,a),f=(i-c)/(i-2*c+r),b=e._calculateExtrema(s,i,d,c,a,r,f),y=b.length>0?Math.min(i,r,b[1]):Math.min(i,r),_=b.length>0?Math.max(i,r,b[1]):Math.max(i,r),S=new ms;return S.x=m,S.y=y,S.w=g-m,S.h=_-y,S}static _calculateExtrema(e,t,s,i,a,r,n){if(n<=0||1<=n)return[];let o=e+(s-e)*n,l=t+(i-t)*n;return[o+(s+(a-s)*n-o)*n,l+(i+(r-i)*n-l)*n]}static _computeBezierControlPoints(t,s,i,a,r,n,o,l){if(s===a&&i===r||isNaN(o)||isNaN(l)||isNaN(t))return[];if(a<s){let e=s;s=a,a=e,e=i,i=r,r=e}o*=t,l*=t,n&&(o*=-1,l*=-1),t>=1&&(l*=1.2);let h=r-i,d=a-s,c=Math.sqrt(d*d+h*h),u=s+.25*c,p=i-o,m=s+.75*c,g=i-o,f=s+.75*c,b=i-o-l,y=s+.25*c,_=i-o-l,S=Math.atan2(h,d);return[u,p]=e._rotate(u,p,s,i,S),[m,g]=e._rotate(m,g,s,i,S),[f,b]=e._rotate(f,b,s,i,S),[y,_]=e._rotate(y,_,s,i,S),[s,i,u,p,m,g,a,r,f,b,y,_,s,i]}static _rotate(e,t,s,i,a){let r=e-s,n=t-i;return[s+(r*Math.cos(a)-n*Math.sin(a)),i+(r*Math.sin(a)+n*Math.cos(a))]}static paintTie(t,s,i,a,r,n,o,l,h){let d=e._computeBezierControlPoints(s,i,a,r,n,o,l,h);d.length<14||d.some(e=>isNaN(e))||(t.beginPath(),t.moveTo(d[0],d[1]),t.bezierCurveTo(d[2],d[3],d[4],d[5],d[6],d[7]),t.bezierCurveTo(d[8],d[9],d[10],d[11],d[12],d[13]),t.closePath(),t.fill())}static drawBendSlur(e,t,s,i,a,r,n,o,l){let h=a-s,d=i-t,c=Math.sqrt(h*h+d*d);if(c<1e-4)return;r?h*=-1:d*=-1,h/=c,d/=c;let u=o*n;i-t<20&&(u/=2);let p=(i+t)/2+u*h,m=(a+s)/2+u*d;if(e.beginPath(),e.moveTo(t,s),e.lineTo(p,m),e.lineTo(i,a),e.stroke(),l){let t=e.measureText(l).width,s=r?0:-e.font.size;e.fillText(l,p-t/2,m+s)}}},Xd=class extends Yd{constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return 0}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,1)}getEndY(){return this.getStartY()}getStartX(){return this._isLeftHandTap?this.getEndX()-this.startNoteRenderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,1)}getEndX(){return this._isLeftHandTap?this.endNoteRenderer.getNoteX(this.endNote,0):this.endNoteRenderer.getNoteX(this.endNote,1)}},$d=class e extends Yd{constructor(e,t,s=!1){super(e.beat,t.beat,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,t,s,i){return this._isLeftHandTap?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(e,t,s,i)}getBeamDirection(t,s){return this._isLeftHandTap?0:e.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(e){return e.string>3?0:1}getStartY(){return this._isLeftHandTap?this.startNoteRenderer.getNoteY(this.startNote,2):0===this.tieDirection?this.startNoteRenderer.getNoteY(this.startNote,1):this.startNoteRenderer.getNoteY(this.startNote,3)}getEndY(){return this.getStartY()}getStartX(){if(this._isLeftHandTap){let e=this.renderer.smuflMetrics.leftHandTabTieWidth||0;return this.getEndX()-e}return this.startNoteRenderer.getNoteX(this.startNote,1)}getEndX(){return this._isLeftHandTap?this.endNoteRenderer.getNoteX(this.endNote,0):this.endNoteRenderer.getNoteX(this.endNote,1)}},Jd=class extends $d{constructor(e,t,s,i=!1){super(e,t,i),this._direction=0,this._forSlide=s}getTieHeight(e,t,s,i){return Math.log(s-e+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,t,s,i){if(this._forSlide!==s||this.forEnd!==i||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id)return!1;switch(this._direction){case 0:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case 1:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,s){let i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,i),r=`numbered.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${a}`,n=this.renderer;n.staff.getSharedLayoutData(r,!1)||(n.staff.setSharedLayoutData(r,!0),super.paint(e,t,s))}},qd=class extends Yo{constructor(){super(...arguments),this._effectSlurs=[]}createTies(e){if(e.isVisible){if(e.isTieOrigin&&e.tieDestination.isVisible){let t=new Xd(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination){let t=new Xd(e.tieOrigin,e,!0);this.addTie(t)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){let t=new Xd(e,e,!1);this.addTie(t)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let t=!1,s=2===e.slideOutType;for(let i of this._effectSlurs)if(i.tryExpand(e,e.effectSlurDestination,s,!1)){t=!0;break}if(!t){let t=new Jd(e,e.effectSlurDestination,s,!1);this._effectSlurs.push(t),this.addTie(t)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let t=!1,s=2===e.effectSlurOrigin.slideOutType;for(let i of this._effectSlurs)if(i.tryExpand(e.effectSlurOrigin,e,s,!0)){t=!0;break}if(!t){let t=new Jd(e.effectSlurOrigin,e,s,!0);this._effectSlurs.push(t),this.addTie(t)}}}}},jd=class extends Oo{constructor(e,t,s,i,a){super(e,t),this._isGrace=i,this._number=s,this._beat=a}paint(e,t,s){var i=[];try{o(i,this._beat.isRest?Nl.beat(s,21,this._beat):this._beat.notes.length>0?Nl.note(s,8,this._beat.notes[0]):void 0);let a=this.renderer.resources;s.font=this._isGrace?a.numberedNotationGraceFont:a.numberedNotationFont,s.textBaseline=1,s.textAlign=0,s.fillText(this._number.toString(),e+this.x,t+this.y)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}doLayout(){let e=this.renderer.resources,t=this._isGrace?e.numberedNotationGraceFont:e.numberedNotationFont,s=this.renderer.scoreRenderer.canvas;s.font=t;let i=s.measureText(`${this._number}`);this.height=i.height,this.width=i.width,this._isGrace&&(this.x+=3,this.y-=10)}},Kd=class{constructor(){this.x=0,this.y=-3e3,this.width=0}},Qd=class extends vl{constructor(){super(0,0)}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);this.glyphs.sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:0);let e=[];e.push(new Kd);for(let t=0,s=this.glyphs.length;t<s;t++){let s=this.glyphs[t];s.renderer=this.renderer,s.doLayout();let i=0;for(;e[i].y>s.y;)i++,i===e.length&&e.push(new Kd);s.x=i,e[i].y=s.y+s.height,e[i].width<s.width&&(e[i].width=s.width)}this.width=0;let t=this.renderer.smuflMetrics.accidentalPadding;for(let s of e)this.width+=s.width+t,s.x=this.width;for(let t=0,s=this.glyphs.length;t<s;t++){let s=this.glyphs[t],i=e[s.x];s.x=this.width-i.x}}},Zd=class e extends Wo{constructor(t,s,i,a){super(t,s,a,e.getMusicSymbol(i))}static getMusicSymbol(e){switch(e){case 1:return 57953;case 2:return 57954;case 3:return 57952;case 4:return 57970;case 5:return 57972;case 6:return 57968;case 7:return 57955;case 8:return 57956}return-1}},ec=class extends Wo{constructor(e,t){super(e,t,1,57831)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}},tc=class extends Oo{constructor(e,t,s){super(e,t),this._beat=s}doLayout(){this.width=this.renderer.smuflMetrics.numberedDashGlyphWidth+this.renderer.smuflMetrics.numberedDashGlyphPadding,this.height=this.renderer.smuflMetrics.numberedBarRendererBarSize}paint(e,t,s){var i=[];try{o(i,Nl.beat(s,19,this._beat));let a=this.renderer.smuflMetrics.numberedDashGlyphPadding,r=0!==this._beat.graceType,n=r?3:0,l=r?-14:0;if(r){const i=1,r=1,o=Math.ceil(t+this.y-this.height)+l;s.fillRect(e+this.x+n,o,this.width-a,i),s.fillRect(e+this.x+n,o+i+r,this.width-a,i)}else s.fillRect(e+this.x+n,Math.ceil(t+this.y-this.height)+l,this.width-a,this.height)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},sc=class extends Oo{constructor(){super(0,0)}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(57603)}paint(e,t,s){let i=this.renderer,a=i.getLineHeight(i.heightLineCount-1),r=i.getLineY(0)+i.getLineHeight(i.drawnLineCount-1)/2-a/2,n=s.lineWidth;s.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,s.moveTo(e+this.x,t+r),s.lineTo(e+this.x+this.width,t+r+a),s.moveTo(e+this.x,t+r+a),s.lineTo(e+this.x+this.width,t+r),s.stroke(),s.lineWidth=n}},ic=class extends ah{constructor(){super(...arguments),this.isNaturalizeAccidental=!1,this.accidental=0}get effectElement(){return 20}doLayout(){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){let e=new Qd;if(e.renderer=this.renderer,this.container.beat.notes.length>0){let t=this.container.beat.notes[0],s=0;if(!t.isDead){let e=this.renderer.bar.keySignatureType,i=this.renderer.bar.keySignature+7,a=(1===e?ac.minorKeySignatureOneValues:ac.majorKeySignatureOneValues)[i],r=t.displayValue-a,n=r<0?(r%12+12)%12:r%12;qe.accidentalNotes[n]&&!this.container.preNotes.isNaturalizeAccidental&&(s=i<7?3:2)}if(0!==s){this.accidental=s;let i=this.renderer,a=Nl.noteColor(i.resources,9,t),r=new Zd(0,i.getLineY(0),s,0!==t.beat.graceType?zo.GraceScale*zo.GraceScale:zo.GraceScale);r.colorOverride=a,r.renderer=this.renderer,e.addGlyph(r),this.addNormal(e),this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))}}}super.doLayout()}},ac=class e extends rh{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.octaveDots=0}get effectElement(){return 20}getNoteX(e,t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let e=s.x;switch(t){case 0:break;case 1:e+=s.width/2;break;case 2:e+=s.width}return e}return 0}buildBoundingsLookup(e,t,s){if(this.noteHeads&&this.container.beat.notes.length>0){let i=new fs;i.note=this.container.beat.notes[0],i.noteHeadBounds=new ms,i.noteHeadBounds.x=t+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}}getLowestNoteY(){return this._internalGetNoteY(2)}getHighestNoteY(){return this._internalGetNoteY(2)}getNoteY(e,t){return this._internalGetNoteY(t)}_internalGetNoteY(e){let t=null;if(this.noteHeads?t=this.noteHeads:this.deadSlapped&&(t=this.deadSlapped),t){let s=this.y+t.y;switch(e){case 1:case 0:s-=t.height/2;break;case 2:case 5:case 6:break;case 3:case 4:s+=t.height/2}return s}return 0}updateBeamingHelper(){if(this.beamingHelper){let e=null,t=this.container.x+this.x,s=0;this.noteHeads?(e=this.noteHeads,t+=e.x,s=e.width):this.deadSlapped?(e=this.deadSlapped,t+=e.x,s=e.width):s=this.width,this.beamingHelper.registerBeatLineX("numbered",this.container.beat,t,t+s)}}doLayout(){let t=this.renderer;t.shortestDuration<this.container.beat.duration&&(t.shortestDuration=this.container.beat.duration);let s=t.getLineY(t.getNoteLine());if(!this.container.beat.isEmpty){let i="0";if(this.container.beat.notes.length>0){let s=this.renderer.bar.keySignatureType,a=this.renderer.bar.keySignature,r=a+7,n=(1===s?e.minorKeySignatureOneValues:e.majorKeySignatureOneValues)[r],o=this.container.beat.notes[0];if(o.isDead)i="X";else{let e=o.displayValue-n,s=e<0?(e%12+12)%12:e%12,l=e<0?-((Math.abs(e)%12==0?Math.abs(e):Math.abs(e)+12)/12|0):e/12|0;this.octaveDots=l,t.registerOctave(l);let h=(qe.keySignatureIsSharp(a)||qe.keySignatureIsNatural(a)?Wi.flatNoteSteps:Wi.sharpNoteSteps)[s]+1;qe.accidentalNotes[s]&&!this.container.preNotes.isNaturalizeAccidental&&(r<7?h++:h--),i=h.toString()}}if(this.container.beat.deadSlapped){let e=new sc;e.renderer=this.renderer,e.doLayout(),this.deadSlapped=e,this.addEffect(e)}else{let e=0!==this.container.beat.graceType,t=new jd(0,s,i,e,this.container.beat);this.noteHeads=t,this.addNormal(t)}if(this.container.beat.dots>0&&this.container.beat.duration>=4)for(let e=0;e<this.container.beat.dots;e++){let e=new ec(0,t.getLineY(0));e.renderer=this.renderer,this.addEffect(e)}let a=0;switch(this.container.beat.duration){case-4:a=16;break;case-2:a=8;break;case 1:a=4;break;case 2:a=2}let r=a;for(let e=0;e<this.container.beat.dots;e++)r=r/2|0,a+=r;for(let e=0;e<a-1;e++){let e=new tc(0,t.getLineY(0),this.container.beat);e.renderer=this.renderer,this.addNormal(e)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}};ac.majorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61],ac.minorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73];var rc=ac,nc=class extends Oo{constructor(e){super(0,0),this._isOpen=e}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(e,t,s){let i=s.color;this.colorOverride&&(s.color=this.colorOverride),this._isOpen?Yd.paintTie(s,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,t+this.y+this.height,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,t+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):Yd.paintTie(s,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,t+this.y,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,t+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),s.color=i}},oc=class extends vl{constructor(e,t,s,i,a,r){super(e,t),this._numerator=0,this._denominator=0,this.barSubElement=16,this._numerator=s,this._denominator=i,this._isCommon=a,this._isFreeTime=r}paint(e,t,s){var i=[];try{o(i,Nl.bar(s,this.barSubElement,this.renderer.bar));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}doLayout(){if(this._isCommon&&2===this._numerator&&2===this._denominator){let e=new Wo(0,0,this.commonScale,57483);this.addGlyph(e),super.doLayout()}else if(this._isCommon&&4===this._numerator&&4===this._denominator){let e=new Wo(0,0,this.commonScale,57482);this.addGlyph(e),super.doLayout()}else{let e=new nh(0,0,this._numerator,0,this.numberScale),t=new nh(0,0,this._denominator,2,this.numberScale);this.addGlyph(e),this.addGlyph(t),super.doLayout();let s=this.width;e.x=(s-e.width)/2,t.x=(s-t.width)/2,this.width=Math.max(e.x+e.width,t.x+t.width)}if(this._isFreeTime){let e=2*this.renderer.smuflMetrics.oneStaffSpace,t=new nc(!0);t.renderer=this.renderer,t.y=-e,t.height=2*e,t.doLayout();for(let e of this.glyphs)e.x+=t.width;this.width+=t.width,this.addGlyph(t);let s=new nc(!1);s.renderer=this.renderer,s.x=this.width,s.y=-e,s.height=2*e,s.doLayout(),this.addGlyph(s),this.width+=s.width}}},lc=class extends oc{get commonScale(){return 1}get numberScale(){return 1}},hc=class extends Oo{constructor(e,t,s,i){super(e,t),this._text="",this._accidental=0,this._accidentalOffset=0,this._keySignature=s,this._keySignatureType=i}doLayout(){super.doLayout();let e="1 = ",t="",s=0;switch(this._keySignatureType){case 0:switch(this._keySignature){case-7:t="  C",s=3;break;case-6:t="  G",s=3;break;case-5:t="  D",s=3;break;case-4:t="  A",s=3;break;case-3:t="  E",s=3;break;case-2:t="  B",s=3;break;case-1:t="F";break;case 0:t="C",s=0;break;case 1:t="G",s=0;break;case 2:t="D",s=0;break;case 3:t="A",s=0;break;case 4:t="E",s=0;break;case 5:t="B",s=0;break;case 6:t="  F",s=2;break;case 7:t="  C",s=2}break;case 1:switch(this._keySignature){case-7:t="  a",s=3;break;case-6:t="  e",s=3;break;case-5:t="  b",s=3;break;case-4:t="f",s=0;break;case-3:t="c",s=0;break;case-2:t="g",s=0;break;case-1:t="d";break;case 0:t="a",s=0;break;case 1:t="e",s=0;break;case 2:t="b",s=0;break;case 3:t="  f",s=2;break;case 4:t="  c",s=2;break;case 5:t="  g",s=2;break;case 6:t="  d",s=2;break;case 7:t="  a",s=2}}this._text=e+t,this._accidental=s;let i=this.renderer.scoreRenderer.canvas,a=this.renderer.resources;i.font=a.numberedNotationFont,this._accidentalOffset=i.measureText(e).width,this.width=i.measureText(e+t).width}paint(e,t,s){var i=[];try{o(i,Nl.bar(s,15,this.renderer.bar));let a=this.renderer.resources;s.font=a.numberedNotationFont,s.textBaseline=1,s.fillText(this._text,e+this.x,t+this.y),0!==this._accidental&&Fe.fillMusicFontSymbolSafe(s,e+this.x+this._accidentalOffset,t+this.y,1,Zd.getMusicSymbol(this._accidental),!1)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},dc=class extends Ud{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.shortestDuration=-4,this.lowestOctave=null,this.highestOctave=null,this._isOnlyNumbered=!t.staff.showSlash&&!t.staff.showTablature&&!t.staff.showStandardNotation}get dotSpacing(){return 2*this.smuflMetrics.glyphHeights.get(57831)}registerOctave(e){null===this.lowestOctave?(this.lowestOctave=e,this.highestOctave=e):(e<this.lowestOctave&&(this.lowestOctave=e),e>this.highestOctave&&(this.highestOctave=e))}get repeatsBarSubElement(){return 3}get barNumberBarSubElement(){return 7}get barLineBarSubElement(){return 11}get staffLineBarSubElement(){return 23}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,19,19),this.paintTuplets(e,t,s,22,!0)}doLayout(){super.doLayout();let e=!1;for(let t of this.bar.voices)if(this.hasVoiceContainer(t)&&this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}if(e&&this.registerOverflowTop(this.tupletSize),!this.bar.isEmpty){let e=qe.getIndex(this.shortestDuration)-2,t=this.dotSpacing;if(e>0){let s=(e-1)*this.smuflMetrics.numberedBarRendererBarSpacing+this.smuflMetrics.numberedBarRendererBarSize,i=0,a=this.lowestOctave;null!==a&&(i=Math.abs(a)*t+this.smuflMetrics.glyphHeights.get(57831)),this.registerOverflowBottom(s+i)}let s=this.highestOctave;if(null!==s){let e=Math.abs(s)*t+this.smuflMetrics.glyphHeights.get(57831);this.registerOverflowTop(e)}}}paintFlag(e,t,s,i,a){this.paintBar(e,t,s,i,a)}paintBar(e,t,s,i,a){if(0===i.beats.length)return;let r=this.resources;for(let c=0,u=i.beats.length;c<u;c++){var n=[];try{let l=i.beats[c],h=(o(n,Nl.beat(s,a,l)),this.smuflMetrics.numberedBarRendererBarSpacing),d=this.smuflMetrics.numberedBarRendererBarSize,u=qe.getIndex(l.duration)-2,p=t+this.y,m=this.getBeatX(l,0)-this.beatGlyphsStart,g=this.calculateBeamY(i,m),f=0!==l.graceType,b=f?3:0,y=f?-14:0;for(let t=0;t<u;t++){let a=0,r=0,n=0,o=p+t*h;if(c===i.beats.length-1?(a=m,r=Math.max(m+1,this.getBeatX(l,4)-this.beatGlyphsStart)):(a=m,r=Math.max(m+1,this.getBeatX(i.beats[c+1],0)-this.beatGlyphsStart)),n=o+g,f){const t=1,i=1,o=r-a,l=e+this.x+a+b,h=n+y;s.fillRect(l,h,o,t),s.fillRect(l,h+t+i,o,t)}else s.fillRect(e+this.x+a+b,n+y,r-a,d)}let _=this.getBeatContainer(l).onNotes,S=_ instanceof rc?_.octaveDots:0,k=this.dotSpacing,w=0,T=0;S>0?(w=p+this.getLineY(0)-r.numberedNotationFont.size,T=-1*k):S<0&&(w=p+g+u*(h+d),T=k);let B=this.getBeatX(l,2)-this.beatGlyphsStart;S=Math.abs(S);for(let t=0;t<S;t++)Fe.fillMusicFontSymbolSafe(s,e+this.x+B,w,1,57831,!0),w+=T}catch(e){var h=e,d=!0}finally{l(n,h,d)}}}getNoteLine(){return 0}get tupletOffset(){return super.tupletOffset+1.5*this.resources.numberedNotationFont.size}getFlagTopY(e,t){return this.getLineY(0)-this.resources.numberedNotationFont.size}getFlagBottomY(e,t){return this.getLineY(0)-this.resources.numberedNotationFont.size}getBeamDirection(e){return 1}getTupletBeamDirection(e){return 0}getNoteY(e,t){let s=super.getNoteY(e,t);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(e,t,s){let i=this.resources.numberedNotationFont;return this.getLineY(0)+i.size-11}getBarLineStart(e,t){let s=this.smuflMetrics.glyphHeights.get(57508);return this.getLineY(0)-s/2}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine,(0===this.index||this.bar.masterBar.isRepeatStart&&this._isOnlyNumbered)&&this.addPreBeatGlyph(new Hd(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new zd(0,this.getLineHeight(-.25),this.bar.index+1))}createLinePreBeatGlyphs(){(!this.bar.previousBar||this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this._createKeySignatureGlyphs()),this._isOnlyNumbered&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createKeySignatureGlyphs(){this.addPreBeatGlyph(new hc(0,this.getLineY(0),this.bar.keySignature,this.bar.keySignatureType))}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new Cd(0,0,this.smuflMetrics.oneStaffSpace));let e=this.bar.masterBar,t=new lc(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));t.barSubElement=19,this.addPreBeatGlyph(t)}createPostBeatGlyphs(){this._isOnlyNumbered&&super.createPostBeatGlyphs()}createVoiceGlyphs(e){for(let t of e.beats){let s=new qd(t,this.getVoiceContainer(e));s.preNotes=0===e.index?new ic:new ah,s.onNotes=0===e.index?new rc:new rh,this.addBeatGlyph(s)}}paintBeamingStem(e,t,s,i,a,r){}};dc.StaffId="numbered";var cc=class extends xl{get staffId(){return dc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new dc(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showNumbered}},uc=class e extends Wo{constructor(t,s,i,a){super(t,s,1,e._getSymbol(i,a)),this._clef=i,this._clefOttava=a}doLayout(){this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(57424),this.offsetX=this.width/2}static _getSymbol(e,t){switch(e){case 0:return 57449;case 1:case 2:return 3===t?57437:57436;case 3:switch(t){case 0:return 57446;case 1:return 57445;case 3:return 57444;case 4:return 57443;default:return 57442}case 4:switch(t){case 0:return 57428;case 1:return 57427;case 3:return 57426;case 4:return 57425;default:return 57424}default:return-1}}paint(e,t,s){var i=[];try{let a;o(i,Nl.bar(s,12,this.renderer.bar));switch(super.paint(e,t,s),this._clef){case 1:case 2:if(3===this._clefOttava)return;break;case 3:case 4:return}let r=!1;switch(this._clefOttava){case 0:a=57470,r=!0;break;case 1:a=57469,r=!0;break;case 3:a=57469;break;case 4:a=57470;break;default:return}let n=this.width/2,l=r?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(a);Fe.fillMusicFontSymbolSafe(s,e+this.x+n,t+this.y-l,1,a,!0)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},pc=class e extends Vo{constructor(e,t,s){super(e,t),this._note=s}static _getSymbol(e,t){switch(e){case 0:default:return-1;case 1:return t?58528:58529;case 2:return t?58540:58541;case 3:return t?58532:58533}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(58528),this.height=this.renderer.smuflMetrics.glyphHeights.get(58528)}paint(t,s,i){let a=this.renderer.getBeatDirection(this._note.beat),r=e._getSymbol(this._note.accentuated,1===a),n=0===a?s+this.y:s+this.y+this.height;Fe.fillMusicFontSymbolSafe(i,t+this.x,n,1,r,!0)}},mc=class extends Wo{constructor(e,t,s){super(e,t,s?zo.GraceScale:1,57514)}},gc=class e extends Wo{constructor(t,s,i,a){super(t,s,a?zo.GraceScale:1,e._getSymbol(i))}static _getSymbol(e){switch(e){case-4:case-2:case 1:case 2:return 57566;default:return 57564}}},fc=class{constructor(e,t,s){this.line=0,this.line=e,this.isGhost=t,this.color=s}},bc=class extends Oo{constructor(e){super(0,0),this._infos=[],this._glyphs=[],this.isEmpty=!0,this._isOpen=e}addParenthesis(e){let t=this.renderer,s=t.getNoteLine(e),i=e.isGhost||this._isTiedBend(e)&&t.settings.notation.isNotationElementVisible(11),a=Nl.noteColor(t.resources,0,e);this._add(new fc(s,i,a))}addParenthesisOnLine(e,t){let s=new fc(e,t,void 0);this._add(s)}_add(e){this._infos.push(e),e.isGhost&&(this.isEmpty=!1)}_isTiedBend(e){return!!e.isTieDestination&&(!!e.tieOrigin.hasBend||this._isTiedBend(e.tieOrigin))}doLayout(){let e=this.renderer;this._infos.sort((e,t)=>e.line-t.line);let t=null,s=e.getScoreHeight(1);for(let i=0,a=this._infos.length;i<a;i++){let a;if(this._infos[i].isGhost)if(t){let a=e.getScoreY(this._infos[i].line)+s;t.height=a-t.y}else a=new nc(this._isOpen),a.colorOverride=this._infos[i].color,a.renderer=this.renderer,a.y=e.getScoreY(this._infos[i].line)-s,a.height=2*s,a.doLayout(),this._glyphs.push(a),t=a;else t=null}this.width=this._glyphs.length>0?this._glyphs[0].width:0}paint(e,t,s){super.paint(e,t,s);for(let i of this._glyphs)i.paint(e+this.x,t+this.y,s)}},yc=class{constructor(e,t){this.steps=0,this.glyph=e,this.steps=t}},_c=class extends Oo{constructor(){super(0,0),this._infos=[],this.minNote=null,this.maxNote=null,this.upLineX=0,this.downLineX=0,this.noteStartX=0}getLowestNoteY(){return this.maxNote?this.renderer.getScoreY(this.maxNote.steps):0}getHighestNoteY(){return this.minNote?this.renderer.getScoreY(this.minNote.steps):0}add(e,t){let s=new yc(e,t);this._infos.push(s),(!this.minNote||this.minNote.steps>s.steps)&&(this.minNote=s),(!this.maxNote||this.maxNote.steps<s.steps)&&(this.maxNote=s)}doLayout(){this._infos.sort((e,t)=>t.steps-e.steps);let e=0,t=0,s=!0,i=0,a=!1,r=this.direction,n=this.renderer.smuflMetrics,o=this.scale,l=new Map;for(let r=0,h=this._infos.length;r<h;r++){let h=this._infos[r].glyph;if(h.renderer=this.renderer,h.doLayout(),r>0&&Math.abs(i-this._infos[r].steps)<=1?s?(s=!1,l.set(r,!1)):(a=!0,s=!0,l.set(r,!0)):(s=!1,l.set(r,!1)),n.stemUp.has(h.symbol)){let t=n.stemUp.get(h.symbol).x*o;t>e&&(e=t)}else{let t=n.glyphWidths.get(h.symbol)*o;t>e&&(e=t)}if(n.stemDown.has(h.symbol)){let s=n.stemDown.get(h.symbol).x*o;if(s>t){let i=s-t;t=s,e+=i}}i=this._infos[r].steps}let h=a||0===r?e:t,d=0;for(let e=0,s=this._infos.length;e<s;e++){let s=this._infos[e].glyph;l.get(e)?s.x=h:(s.x=t,n.stemDown.has(s.symbol)&&(s.x-=n.stemDown.get(s.symbol).x*o)),s.x+=this.noteStartX,d=Math.max(d,s.x+s.width),s instanceof zo&&s.centerOnStem&&(s.x=h)}a?(this.upLineX=h,this.downLineX=h):(this.upLineX=e,this.downLineX=t),this.width=d}paint(e,t,s){e+=this.x,t+=this.y,this._paintLedgerLines(e,t,s);let i=this._infos;for(let a of i)a.glyph.renderer=this.renderer,a.glyph.paint(e,t,s)}_paintLedgerLines(e,t,s){var i=[];try{if(!this.minNote)return;let a=this.renderer,r=(o(i,Nl.bar(s,20,a.bar,!0)),this.scale),n=this.renderer.smuflMetrics.legerLineExtension*r,l=this.width-this.noteStartX+2*n,h=a.getLineHeight(1),d=a.getLineY(-1),c=a.getLineY(a.drawnLineCount),u=a.getLineY(this.minNote.steps/2),p=a.getLineY(this.maxNote.steps/2),m=this.renderer.smuflMetrics.legerLineThickness*r/2,g=d;for(;g>=u;)s.fillRect(e-n+this.noteStartX,t+g-m,l,this.renderer.smuflMetrics.legerLineThickness*r),g-=h;for(g=c;g<=p;)s.fillRect(e-n+this.noteStartX,t+g-m,l,this.renderer.smuflMetrics.legerLineThickness*r),g+=h}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},Sc=class e extends Wo{constructor(t,s,i){super(t,s,1,e._getSymbol(i))}static _getSymbol(e){switch(e){case 32:return 57890;case 16:return 57889;case 8:return 57888;default:return-1}}},kc=class extends _c{constructor(){super(...arguments),this._noteGlyphLookup=new Map,this._notes=[],this._deadSlapped=null,this._tremoloPicking=null,this.aboveBeatEffects=new Map,this.belowBeatEffects=new Map}get direction(){return this.beamingHelper.direction}get scale(){return 0!==this.beat.graceType?zo.GraceScale:1}getNoteX(e,t){if(this._noteGlyphLookup.has(e.id)){let s=this._noteGlyphLookup.get(e.id),i=this.x+s.x;switch(t){case 0:break;case 1:i+=s.width/2;break;case 2:i+=s.width}return i}return 0}getNoteY(e,t){if(this._noteGlyphLookup.has(e.id)){let s=this._noteGlyphLookup.get(e.id);return this._internalGetNoteY(s,t)}return 0}_internalGetNoteY(e,t){let s=this.y+e.y,i=0!==this.beat.graceType?zo.GraceScale:1;switch(t){case 0:s-=(this.renderer.smuflMetrics.stemUp.has(e.symbol)?this.renderer.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*i,s-=this.renderer.smuflMetrics.standardStemLength*i;let t=this.renderer.centerStaffStemY(this.beamingHelper);return Math.min(t,s);case 1:s-=e.height/2;break;case 2:break;case 3:s+=e.height/2;break;case 4:s-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*i,s+=this.renderer.smuflMetrics.standardStemLength*i;let a=this.renderer.centerStaffStemY(this.beamingHelper);return Math.max(a,s);case 5:s-=(this.renderer.smuflMetrics.stemUp.has(e.symbol)?this.renderer.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*i;break;case 6:s-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*i}return s}addMainNoteGlyph(e,t,s){super.add(e,s),this._noteGlyphLookup.set(t.id,e),this._notes.push(t)}addEffectNoteGlyph(e,t){super.add(e,t)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.upLineX,e+this.x+this.downLineX)}doLayout(){super.doLayout();let e=this.renderer;this.beat.deadSlapped&&(this._deadSlapped=new sc,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),this.width=this._deadSlapped.width);let t=0,s=0,i=this.renderer.smuflMetrics.onNoteEffectPadding;this.beat.deadSlapped?(s=e.getScoreY(0),t=e.getScoreY(e.heightLineCount)):0===this.direction?(s=this._internalGetNoteY(this.maxNote.glyph,3)+i,t=this._internalGetNoteY(this.minNote.glyph,0)-i):(s=this._internalGetNoteY(this.maxNote.glyph,4)+i,t=this._internalGetNoteY(this.minNote.glyph,1)-i);let a=null,r=null;for(let e of this.aboveBeatEffects.values())e.renderer=this.renderer,e.doLayout(),t-=e.height,e.y=t,(null===a||a>t)&&(a=t),(null===r||r<t)&&(r=t),t-=i;for(let e of this.belowBeatEffects.values())e.renderer=this.renderer,e.doLayout(),e.y=s,(null===a||a>s)&&(a=s),(null===r||r<s)&&(r=s),s+=e.height+i;if(null!==a&&e.registerBeatEffectOverflows(a,r??0),this.beat.isTremolo&&!this.beat.deadSlapped){let e=this.direction,t=0;if(0===e){t=(this._internalGetNoteY(this.minNote.glyph,0)+this._internalGetNoteY(this.minNote.glyph,5))/2}else{t=(this._internalGetNoteY(this.maxNote.glyph,6)+this._internalGetNoteY(this.maxNote.glyph,4))/2}let s=0===e?this.upLineX:this.downLineX,i=this.beat.tremoloSpeed;this.beat.duration<2&&(s=this.width/2),this._tremoloPicking=new Sc(s,t,i),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}buildBoundingsLookup(e,t,s){for(let i of this._notes)if(this._noteGlyphLookup.has(i.id)){let a=this._noteGlyphLookup.get(i.id),r=new fs;r.note=i,r.noteHeadBounds=new ms,r.noteHeadBounds.x=t+this.x+a.x,r.noteHeadBounds.y=s+this.y+a.y-a.height/2,r.noteHeadBounds.w=a.width,r.noteHeadBounds.h=a.height,e.addNote(r)}}paint(e,t,s){this._paintEffects(e,t,s),super.paint(e,t,s)}_paintEffects(e,t,s){var i=[];try{o(i,Nl.beat(s,5,this.beat));for(let i of this.aboveBeatEffects.values())i.paint(e+this.x+this.width/2,t+this.y,s);for(let i of this.belowBeatEffects.values())i.paint(e+this.x+this.width/2,t+this.y,s);this._tremoloPicking&&this._tremoloPicking.paint(e,t,s),this._deadSlapped&&this._deadSlapped.paint(e,t,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},wc=class e extends Wo{constructor(t,s,i){super(t,s,1,e.getSymbol(i))}static getSymbol(e){switch(e){case-4:return 58593;case-2:return 58594;case 1:return 58595;case 2:return 58596;case 4:return 58597;case 8:return 58598;case 16:return 58599;case 32:return 58600;case 64:return 58601;case 128:return 58602;case 256:return 58603;default:return-1}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){this.internalPaint(e,t,s,6)}internalPaint(e,t,s,i){var a=[];try{o(a,Nl.beat(s,i,this.beat));super.paint(e,t,s)}catch(e){var r=e,n=!0}finally{l(a,r,n)}}},Tc=class extends _c{constructor(e,t=!1){super(),this._showParenthesis=!1,this._noteValueLookup=new Map,this._accidentals=new Qd,this._preNoteParenthesis=null,this._postNoteParenthesis=null,this.isEmpty=!0,this.noteHeadOffset=0,this._beat=e,this._showParenthesis=t,t&&(this._preNoteParenthesis=new bc(!0),this._postNoteParenthesis=new bc(!1))}get scale(){return zo.GraceScale}get direction(){return 0}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,t,s){let i=this.renderer,a=new zo(0,0,4,!0),r=i.accidentalHelper.applyAccidentalForValue(this._beat,e,t,!0),n=i.accidentalHelper.getNoteLineForValue(e,!1);if(a.y=i.getScoreY(n),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(n,!0),this._postNoteParenthesis.addParenthesisOnLine(n,!0)),0!==r){let e=new Zd(0,a.y,r,zo.GraceScale);e.renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(e)}this._noteValueLookup.set(e,a),this.add(a,n),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this._accidentals.isEmpty||(e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(e,t,s){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,t+this.y,s),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,t+this.y,s),this._postNoteParenthesis.paint(e+this.x,t+this.y,s)),super.paint(e,t,s)}},Bc=class extends Oo{constructor(){super(...arguments),this.bendNoteHeads=[]}drawBendSlur(e,t,s,i,a,r,n,o){Yd.drawBendSlur(e,t,s,i,a,r,n,this.renderer.smuflMetrics.tieHeight,o)}doLayout(){super.doLayout(),this.width=0;for(let e of this.bendNoteHeads)e.doLayout(),this.width+=e.width}getTieDirection(e,t){return 0===t.getBeatDirection(e)?1:0}},xc=class extends Bc{constructor(e){super(0,0),this._endGlyph=null,this._beat=e}doLayout(){let e=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case 0:case 1:case 4:return;case 2:case 6:{let e=new Tc(this._beat,!1);this._endGlyph=e,e.renderer=this.renderer;let t=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(let s of this._beat.notes)s.isTieOrigin||e.addGlyph(this._getBendNoteValue(s,t),t.value%2!=0,void 0);e.doLayout(),this.bendNoteHeads.push(e)}break;case 3:if(1===e){let e=this.renderer.resources;this.renderer.simpleWhammyOverflow=e.tablatureFont.size+this.renderer.smuflMetrics.songBookWhammyDipHeight}else{let e=new Tc(this._beat,!1);if(e.renderer=this.renderer,0===this.renderer.settings.notation.notationMode){let t=this._beat.whammyBarPoints[1];for(let s of this._beat.notes)e.addGlyph(this._getBendNoteValue(s,this._beat.whammyBarPoints[1]),t.value%2!=0,void 0)}e.doLayout(),this.bendNoteHeads.push(e);let t=new Tc(this._beat,!1);if(t.renderer=this.renderer,this._endGlyph=t,0===this.renderer.settings.notation.notationMode){let e=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(let s of this._beat.notes)t.addGlyph(this._getBendNoteValue(s,e),e.value%2!=0,void 0)}t.doLayout(),this.bendNoteHeads.push(t)}}super.doLayout()}paint(e,t,s){var i=[];try{let h=this._beat;switch(h.whammyBarType){case 0:case 1:return}let d=this.renderer.settings.notation.notationMode,c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,h.voice.bar),u=(o(i,Nl.beat(s,5,h)),e+c.x+c.getBeatX(h,2)),p=this.getTieDirection(h,c),m=1===this._beat.notes.length?p:0,g=s.textAlign,f=this.renderer.smuflMetrics.glyphHeights.get(57508);for(let i=0;i<h.notes.length;i++){var a=[];try{let r=h.notes[i],n=(o(a,Nl.note(s,3,r)),t+c.y);i>0&&i>=(this._beat.notes.length/2|0)&&(m=1),n+=1===m?c.getNoteY(r,3):c.getNoteY(r,1);let l=e+c.x;h.isLastOfVoice?l+=c.postBeatGlyphsStart:l+=c.getBeatX(h,5),this._endGlyph&&(l-=this._endGlyph.upLineX);let g=1===h.whammyStyle&&0===i?"grad.":"",b=null;r.isTieOrigin&&(b=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.tieDestination.beat.voice.bar),b&&b.staff===c.staff?l=e+b.x+b.getBeatX(r.tieDestination.beat,2):b=null);let y=f*zo.GraceScale*.5;0===m&&(y=-y);let _=h.whammyBarPoints.length>0?this._getBendNoteValue(r,h.whammyBarPoints[h.whammyBarPoints.length-1]):0,S=0,k=!1;switch(this.bendNoteHeads.length>0&&this.bendNoteHeads[0].containsNoteValue(_)?(S=this.bendNoteHeads[0].getNoteValueY(_)+y,k=!0):b&&(r.isTieOrigin&&r.tieDestination.beat.hasWhammyBar||r.beat.isContinuedWhammy)?(S=t+b.y+b.getNoteY(r.tieDestination,1),k=!0,1===m&&(S+=f)):r.isTieOrigin&&(S=b?t+b.y+b.getNoteY(r.tieDestination,1):n,1===m&&(S+=f)),h.whammyBarType){case 4:r.isTieOrigin&&Yd.paintTie(s,1,u,n,l,S,1===p,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case 2:if(0===i){this.bendNoteHeads[0].x=l-this.bendNoteHeads[0].noteHeadOffset;let e=this.bendNoteHeads[0].y;this.bendNoteHeads[0].y=t+c.y,this.bendNoteHeads[0].paint(0,0,s),this.bendNoteHeads[0].containsNoteValue(_)&&(S-=e,S+=this.bendNoteHeads[0].y)}k?this.drawBendSlur(s,u,n,l,S,1===m,1,g):r.isTieOrigin&&Yd.paintTie(s,1,u,n,l,S,1===p,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case 3:if(1===d){if(0===i){let i=e+c.x+c.getBeatX(this._beat,1),a=e+c.x+c.getBeatX(this._beat,4),r=(i+a)/2,n=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString();s.font=this.renderer.resources.tablatureFont,s.fillText(n,r,t+this.y);let o=t+this.y+s.font.size,l=o+this.renderer.smuflMetrics.songBookWhammyDipHeight;this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(s.moveTo(i,l),s.lineTo(r,o),s.lineTo(a,l)):(s.moveTo(i,o),s.lineTo(r,l),s.lineTo(a,o)),s.stroke()}r.isTieOrigin&&Yd.paintTie(s,1,u,n,l,S,1===p,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness)}else{let e=(u+l)/2;this.bendNoteHeads[0].x=e-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=t+c.y,this.bendNoteHeads[0].paint(0,0,s);let i=this._getBendNoteValue(r,h.whammyBarPoints[1]),a=this.bendNoteHeads[0].getNoteValueY(i)+y;this.drawBendSlur(s,u,n,e,a,1===m,1,g),this.bendNoteHeads[1].x=l-this.bendNoteHeads[1].noteHeadOffset,this.bendNoteHeads[1].y=t+c.y,this.bendNoteHeads[1].paint(0,0,s),S=this.bendNoteHeads[1].getNoteValueY(_)+y,this.drawBendSlur(s,e,a,l,S,1===m,1,g)}break;case 6:case 5:let a=e+c.x+c.getBeatX(r.beat,0);a+=c.getPreNotesGlyphForBeat(r.beat).prebendNoteHeadOffset;let o=t+c.y+c.getScoreY(c.accidentalHelper.getNoteLineForValue(r.displayValue-(r.beat.whammyBarPoints[0].value/2|0),!1))+y;this.drawBendSlur(s,a,o,u,n,1===m,1,g),this.bendNoteHeads.length>0&&(this.bendNoteHeads[0].x=l-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=t+c.y,this.bendNoteHeads[0].paint(0,0,s),this.drawBendSlur(s,u,n,l,S,1===m,1,g))}}catch(e){var r=e,n=!0}finally{l(a,r,n)}}s.textAlign=g}catch(e){var h=e,d=!0}finally{l(i,h,d)}}_getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}},vc=class extends Wo{constructor(e,t,s,i,a){super(e,t,a?zo.GraceScale:1,s.getSymbol(i)),this._isGrace=a,this._articulation=s}paint(e,t,s){let i=s.color;this.colorOverride&&(s.color=this.colorOverride);let a=this._isGrace?1:0;Fe.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+a,this.glyphScale,this.symbol,!1),-1!==this._articulation.techniqueSymbol&&1===this._articulation.techniqueSymbolPlacement&&Fe.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+a,this.glyphScale,this._articulation.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),0===this.width&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(57508)),0===this.height&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(57508))}},Pc=class extends Wo{constructor(e,t){super(e,t,zo.GraceScale,58530),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}},Nc=class extends Wo{constructor(e,t){super(e,t,.5,59177),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}},Mc=class extends Vo{constructor(){super(...arguments),this._strings=new Set}addString(e){this._strings.add(e)}doLayout(){let e=this.renderer.smuflMetrics.glyphWidths.get(59443)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(e+this.renderer.smuflMetrics.stringNumberCirclePadding)*this._strings.size,this.width=e}paint(e,t,s){let i=this.renderer.bar.staff.tuning.length,a=0,r=this.renderer.smuflMetrics.glyphWidths.get(59443)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(let n of this._strings){let o=59444+(i-n);Fe.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+r+a,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,o,!0),a+=r+this.renderer.smuflMetrics.stringNumberCirclePadding}}},Ec=class e extends Wo{constructor(t,s,i,a,r){super(t,s,a?zo.GraceScale:1,e.getSymbol(i)),this.beatEffects=new Map,this.noteHeadElement=6,this.effectElement=18,this._symbol=e.getSymbol(i),this.beat=r}paint(e,t,s){var i=[];try{o(i,0===this.beat.notes.length?void 0:Nl.note(s,this.noteHeadElement,this.beat.notes[0]));super.paint(e,t,s),this._paintEffects(e,t,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}_paintEffects(e,t,s){var i=[];try{o(i,Nl.beat(s,this.effectElement,this.beat));for(let i of this.beatEffects.values())i.paint(e+this.x,t+this.y,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}doLayout(){super.doLayout();let e=this.renderer.smuflMetrics.onNoteEffectPadding,t=this.renderer.smuflMetrics.glyphHeights.get(this._symbol);for(let s of this.beatEffects.values())s.y+=t,s.x+=this.width/2,s.renderer=this.renderer,s.doLayout(),t+=s.height+e}static getSymbol(e){switch(e){case-4:case-2:case 1:return 57602;case 2:return 57603;default:return 57601}}updateBeamingHelper(e){if(this.beamingHelper){let t=this._symbol,s=this.renderer.smuflMetrics.stemUp.has(t)?this.renderer.smuflMetrics.stemUp.get(t).x:0,i=this.renderer.smuflMetrics.stemDown.has(t)?this.renderer.smuflMetrics.stemDown.get(t).x:0;this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+s,e+this.x+i)}}},Lc=class extends rh{constructor(){super(...arguments),this._collisionOffset=-1e3,this._skipPaint=!1,this.noteHeads=null,this.restGlyph=null}get effectElement(){return 5}getNoteX(e,t){return this.noteHeads?this.noteHeads.getNoteX(e,t):0}buildBoundingsLookup(e,t,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(e,t+this.x,s+this.y)}getLowestNoteY(){return this.noteHeads?this.noteHeads.getLowestNoteY():0}getHighestNoteY(){return this.noteHeads?this.noteHeads.getHighestNoteY():0}getNoteY(e,t){return this.noteHeads?this.noteHeads.getNoteY(e,t):0}updateBeamingHelper(){if(this.noteHeads)this.noteHeads.updateBeamingHelper(this.container.x+this.x);else if(this.restGlyph&&(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice&&-1e3===this._collisionOffset)){this._collisionOffset=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset;let e=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime;e.has(this.container.beat.playbackStart)&&e.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&e.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}}paint(e,t,s){this._skipPaint||super.paint(e,t,s)}doLayout(){let e=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let t=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);1===this.container.beat.duration&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(t-=2);let s=new wc(0,e.getScoreY(t),this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s),this.renderer.bar.isMultiVoice)if(0===this.container.beat.voice.index){let t=Fl.computeLineHeightsForRest(this.container.beat.duration),i=s.y-e.getScoreHeight(t[0]),a=s.y+e.getScoreHeight(t[1]);this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,i,a)}else this.renderer.helpers.collisionHelper.registerRest(this.container.beat);if(this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,t),this.container.beat.dots>0)for(let e=0;e<this.container.beat.dots;e++){let e=new vl(0,0);e.renderer=this.renderer,this._createBeatDot(t,e),this.addEffect(e)}}else{let t=new kc;this.noteHeads=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper;let s=new bc(!1);s.renderer=this.renderer;for(let e of this.container.beat.notes)e.isVisible&&(!e.beat.slashed||0===e.index)&&(this._createNoteGlyph(e),s.addParenthesis(e));if(this.addNormal(t),s.isEmpty||this.addEffect(s),this.container.beat.hasWhammyBar){let e=new xc(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.dots>0)for(let t=0;t<this.container.beat.dots;t++){let t=new vl(0,0);t.renderer=this.renderer;for(let s of this.container.beat.notes){this._createBeatDot(e.getNoteLine(s),t).colorOverride=Nl.noteColor(e.resources,3,s)}this.addEffect(t)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads&&(this.centerX=this.noteHeads.x+this.noteHeads.width/2)}_createBeatDot(e,t){let s=this.renderer,i=new ec(0,s.getScoreY(e));return t.addGlyph(i),i}_createNoteHeadGlyph(e){let t=0!==this.container.beat.graceType,s=e.style;if(void 0!==s?.noteHead){let i=new zo(0,0,e.beat.duration,t);return i.symbol=s.noteHead,s.noteHeadCenterOnStem&&(i.centerOnStem=!0),i}if(e.beat.voice.bar.staff.isPercussion){let s=et.getArticulation(e);if(s)return new vc(0,0,s,e.beat.duration,t);re.warning("Rendering",`No articulation found for percussion instrument ${e.percussionArticulation}`)}return e.beat.slashed?new Ec(0,0,e.beat.duration,t,e.beat):e.isDead?new mc(0,0,t):3===e.beat.graceType?new zo(0,0,4,!0):1===e.harmonicType?new gc(0,0,e.beat.duration,t):new zo(0,0,e.beat.duration,t)}_createNoteGlyph(e){if(3===e.beat.graceType&&!e.hasBend)return;let t,s=this.renderer,i=this._createNoteHeadGlyph(e);if(i.colorOverride=Nl.noteColor(s.resources,1,e),t=e.beat.slashed?s.heightLineCount-1:s.getNoteLine(e),i.y=s.getScoreY(t),this.noteHeads.addMainNoteGlyph(i,e,t),!e.beat.slashed&&0!==e.harmonicType&&1!==e.harmonicType){let a=e.displayValue+e.harmonicPitch,r=new gc(0,0,e.beat.duration,0!==this.container.beat.graceType);r.colorOverride=i.colorOverride,t=s.accidentalHelper.getNoteLineForValue(a,!1),r.y=s.getScoreY(t),this.noteHeads.addEffectNoteGlyph(r,t)}let a=this.noteHeads.belowBeatEffects,r=this.noteHeads.aboveBeatEffects,n=0===this.beamingHelper.direction?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(e.isStaccato&&!a.has("Staccato")&&n.set("Staccato",new Pc(0,0)),1===e.accentuated&&!a.has("Accent")&&n.set("Accent",new pc(0,0,e)),2===e.accentuated&&!a.has("HAccent")&&n.set("HAccent",new pc(0,0,e)),3===e.accentuated&&!a.has("Tenuto")&&n.set("Tenuto",new pc(0,0,e)),e.showStringNumber&&e.isStringed){let t;r.has("StringNumber")?t=r.get("StringNumber"):(t=new Mc(0,0),r.set("StringNumber",t)),t.addString(e.string)}if(e.isPercussion){let t=et.getArticulation(e);if(t&&1!==t.techniqueSymbolPlacement){let e;switch(t.techniqueSymbolPlacement){case 0:e=this.noteHeads.aboveBeatEffects;break;case 2:e=this.noteHeads.belowBeatEffects;break;case 3:e=n;break;default:return}switch(t.techniqueSymbol){case 59177:e.set("PictEdgeOfCymbal",new Nc(0,0));break;case 58530:e.set("ArticStaccatoAbove",new Pc(0,0));break;case 58898:e.set("StringsUpBow",new nd(0,0,1));break;case 58896:e.set("StringsDownBow",new nd(0,0,2));break;case 59458:e.set("GuitarGolpe",new Uh(0,0,!0))}}}}},Cc=class extends Oo{constructor(e){super(0,0),this._beat=e}doLayout(){if(3===this._beat.brushType||4===this._beat.brushType){let e=new dd(0,0,1,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e,this.width=e.height}else this.width=0}paint(e,t,s){if(3===this._beat.brushType||4===this._beat.brushType){let i=!0;for(let e of this._beat.notes)if(!e.isDeadVisual){i=!1;break}let a=this.renderer,r=a.lineOffset,n=t+this.y+(a.getNoteY(this._beat.maxNote,3)-r)-5,o=t+this.y+a.getNoteY(this._beat.minNote,1)+r-5,l=e+this.x+this.width/2+(i?8:0),h=this.renderer.smuflMetrics.glyphWidths.get(60284);this._noteVibratoGlyph;if(3===this._beat.brushType){let e=n+h,t=o-h;const i=5,a=3,r=Math.floor(Math.abs(t-e)/i);s.beginPath(),s.moveTo(l,e);let d=e;for(let t=1;t<=r;t++){const r=e+t*i;t%2==1?s.quadraticCurveTo(l-a,r-i/2,l,r):s.quadraticCurveTo(l+a,r-i/2,l,r),d=r}if(d<t){const e=t-d,i=r%2==1?l+a:l-a;s.quadraticCurveTo(i,d+e/2,l,t)}s.stroke(),s.beginPath(),s.moveTo(l,o),s.lineTo(l+h/2,o-h),s.lineTo(l-h/2,o-h),s.closePath(),s.fill(),s.beginPath(),s.moveTo(l,o-h),s.lineTo(l,o),s.stroke()}else if(4===this._beat.brushType){let e=n+h,t=o;const i=5,a=3,r=Math.floor(Math.abs(t-e)/i);s.beginPath(),s.moveTo(l,e);for(let t=1;t<=r;t++){const r=e+t*i;t%2==1?s.quadraticCurveTo(l+a,r-i/2,l,r):s.quadraticCurveTo(l-a,r-i/2,l,r)}s.stroke(),s.beginPath(),s.moveTo(l,n),s.lineTo(l+h/2,n+h),s.lineTo(l-h/2,n+h),s.closePath(),s.fill(),s.beginPath(),s.moveTo(l,n),s.lineTo(l,n+h),s.stroke()}}}},Fc=class extends ah{constructor(){super(...arguments),this._prebends=null,this.accidentals=null}get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}get effectElement(){return 5}doLayout(){if(!this.container.beat.isRest){let e=new Qd;e.renderer=this.renderer;let t=new Hh;t.renderer=this.renderer;let s=new bc(!0);s.renderer=this.renderer;let i=new Tc(this.container.beat,!0);this._prebends=i,i.renderer=this.renderer;let a=!1;for(let r of this.container.beat.notes){let n=Nl.noteColor(this.renderer.resources,3,r);if(r.isVisible){if(r.hasBend)switch(r.bendType){case 7:case 6:case 8:i.addGlyph(r.displayValue-(r.bendPoints[0].value/2|0),!1,n)}else if(r.beat.hasWhammyBar)switch(r.beat.whammyBarType){case 6:case 5:this._prebends.addGlyph(r.displayValue-(r.beat.whammyBarPoints[0].value/2|0),!1,n)}switch(this._createAccidentalGlyph(r,e),s.addParenthesis(r),t.addFingers(r),r.slideInType){case 1:case 2:a=!0}}}a&&this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(0!==this.container.beat.graceType?zo.GraceScale:1))),i.isEmpty||(this.addEffect(i),this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?zo.GraceScale:1)))),0!==this.container.beat.brushType&&(this.addEffect(new Cc(this.container.beat)),this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?zo.GraceScale:1)))),t.isEmpty||(this.isEmpty||this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?zo.GraceScale:1))),this.addEffect(t),this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?zo.GraceScale:1)))),s.isEmpty||this.addEffect(s),e.isEmpty||(this.accidentals=e,this.isEmpty||this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?zo.GraceScale:1))),this.addNormal(e),this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(0!==this.container.beat.graceType?zo.GraceScale:1))))}super.doLayout()}_createAccidentalGlyph(e,t){let s=this.renderer,i=s.accidentalHelper.applyAccidental(e),a=s.getNoteLine(e),r=0!==this.container.beat.graceType,n=Nl.noteColor(s.resources,2,e),o=r?zo.GraceScale:1;if(0!==i){let e=new Zd(0,s.getScoreY(a),i,o);e.colorOverride=n,e.renderer=this.renderer,t.addGlyph(e)}if(0!==e.harmonicType&&1!==e.harmonicType){let l=e.displayValue+e.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(e.beat,l,r,!1),a=s.accidentalHelper.getNoteLineForValue(l,!1);let h=new Zd(0,s.getScoreY(a),i,o);h.colorOverride=n,h.renderer=this.renderer,t.addGlyph(h)}}},Dc=class extends Bc{constructor(e){super(0,0),this._notes=[],this._endNoteGlyph=null,this._middleNoteGlyph=null,this._beat=e}addBends(e){if(this._notes.push(e),e.isTieOrigin)return;let t=Nl.noteColor(this.renderer.resources,3,e);switch(e.bendType){case 2:case 8:case 7:{let s=this._endNoteGlyph;s||(s=new Tc(e.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.bendNoteHeads.push(s));let i=e.bendPoints[e.bendPoints.length-1];s.addGlyph(this._getBendNoteValue(e,i),i.value%2!=0,t)}break;case 3:if(!e.isTieOrigin){let s=this._endNoteGlyph;s||(s=new Tc(e.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.bendNoteHeads.push(s));let i=e.bendPoints[e.bendPoints.length-1];s.addGlyph(this._getBendNoteValue(e,i),i.value%2!=0,t)}break;case 4:{let s=this._middleNoteGlyph;s||(s=new Tc(e.beat,!1),this._middleNoteGlyph=s,s.renderer=this.renderer,this.bendNoteHeads.push(s));let i=e.bendPoints[1];s.addGlyph(this._getBendNoteValue(e,e.bendPoints[1]),i.value%2!=0,t);let a=this._endNoteGlyph;a||(a=new Tc(e.beat,!1),a.renderer=this.renderer,this._endNoteGlyph=a,this.bendNoteHeads.push(a));let r=e.bendPoints[e.bendPoints.length-1];a.addGlyph(this._getBendNoteValue(e,r),r.value%2!=0,t)}}}paint(e,t,s){let i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._beat.voice.bar),a=e+i.x+i.getBeatX(this._beat,2),r=e+i.x;this._beat.isLastOfVoice?r+=i.postBeatGlyphsStart:r+=i.getBeatX(this._beat.nextBeat,0),this._endNoteGlyph&&(r-=this._endNoteGlyph.upLineX);let n=(a+r)/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=n-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=t+i.y,this._middleNoteGlyph.paint(0,0,s)),this._endNoteGlyph&&(this._endNoteGlyph.x=r-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=t+i.y,this._endNoteGlyph.paint(0,0,s)),this._notes.sort((e,t)=>t.displayValue-e.displayValue);let h=3===this._beat.graceType?this._beat.nextBeat:this._beat,d=1===this._notes.length?this.getTieDirection(h,i):0,c=this.renderer.smuflMetrics.glyphHeights.get(57508);for(let h=0;h<this._notes.length;h++){var u=[];try{let l=this._notes[h];o(u,Nl.note(s,3,l));h>0&&h>=(this._notes.length/2|0)&&(d=1);let p=t+i.y+i.getNoteY(l,1),m=c*zo.GraceScale*.5;1===d&&(p+=c);let g=1===l.bendStyle?"grad.":"";if(l.isTieOrigin){let r=l.tieDestination,n=r?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.beat.voice.bar):null;if(n&&n.staff===i.staff){let i=e+n.x+n.getBeatX(r.beat,2),o=t+n.y+n.getNoteY(r,1);1===d&&(o+=c),5===l.bendType||6===l.bendType?Yd.paintTie(s,1,a,p,i,o,1===d,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,a,p,i,o,1===d,1,g)}else{let r=e+i.x+i.width,n=l.tieDestination.realValue;i.accidentalHelper.applyAccidentalForValue(l.beat,n,!1,!0);let o=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(n,!1));5===l.bendType||6===l.bendType?Yd.paintTie(s,1,a,p,r,o,1===d,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,a,p,r,o,1===d,1,g)}switch(l.bendType){case 6:case 7:case 8:let r=e+i.x+i.getBeatX(l.beat,0);r+=i.getPreNotesGlyphForBeat(l.beat).prebendNoteHeadOffset;let n=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1))+m;this.drawBendSlur(s,r,n,a,p,1===d,1)}}else{0===d&&(m=-m);let o=0,h=0;switch(l.bendType){case 2:o=this._getBendNoteValue(l,l.bendPoints[l.bendPoints.length-1]),h=this._endNoteGlyph.getNoteValueY(o)+m,this.drawBendSlur(s,a,p,r,h,1===d,1,g);break;case 4:let c=this._getBendNoteValue(l,l.bendPoints[1]),u=this._middleNoteGlyph.getNoteValueY(c)+m;this.drawBendSlur(s,a,p,n,u,1===d,1,g),o=this._getBendNoteValue(l,l.bendPoints[l.bendPoints.length-1]),h=this._endNoteGlyph.getNoteValueY(o)+m,this.drawBendSlur(s,n,u,r,h,1===d,1,g);break;case 3:this.bendNoteHeads.length>0&&(o=this._getBendNoteValue(l,l.bendPoints[l.bendPoints.length-1]),h=this.bendNoteHeads[0].getNoteValueY(o)+m,this.drawBendSlur(s,a,p,r,h,1===d,1,g));break;case 6:case 7:case 8:let f=e+i.x+i.getBeatX(l.beat,0);f+=i.getPreNotesGlyphForBeat(l.beat).prebendNoteHeadOffset;let b=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1))+m;this.drawBendSlur(s,f,b,a,p,1===d,1),this.bendNoteHeads.length>0&&(o=this._getBendNoteValue(l,l.bendPoints[l.bendPoints.length-1]),h=this.bendNoteHeads[0].getNoteValueY(o)+m,this.drawBendSlur(s,a,p,r,h,1===d,1,g))}}}catch(e){var p=e,m=!0}finally{l(u,p,m)}}}_getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}},Ic=class extends Yd{constructor(e,t,s=!1){super(e,t,s)}doLayout(){super.doLayout()}getBeamDirection(e,t){return e.isRest?0:0===t.getBeatDirection(e)?1:0}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):0===this.tieDirection?this.startNoteRenderer.getNoteY(this.startBeat.maxNote,1):this.startNoteRenderer.getNoteY(this.startBeat.minNote,3)}getEndY(){let e=this.endNoteRenderer;if(this.endBeat.isRest)return 0===this.tieDirection?e.getScoreY(9):e.getScoreY(0);let t=this.startNoteRenderer.getBeatDirection(this.startBeat),s=e.getBeatDirection(this.endBeat);return t!==s&&0===this.startBeat.graceType?s===this.tieDirection?0===this.tieDirection?e.getNoteY(this.endBeat.maxNote,0):e.getNoteY(this.endBeat.minNote,4):0===this.tieDirection?e.getNoteY(this.endBeat.maxNote,4):e.getNoteY(this.endBeat.minNote,0):0===this.tieDirection?e.getNoteY(this.endBeat.maxNote,1):e.getNoteY(this.endBeat.minNote,3)}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,2)}getEndX(){let e=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>1&&e===this.tieDirection?3:2)}},Ac=class extends Oo{constructor(e,t,s,i){super(0,0),this._outType=t,this._inType=e,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this._paintSlideIn(e,t,s),this._drawSlideOut(e,t,s)}_paintSlideIn(e,t,s){let i=this.renderer,a=i.smuflMetrics.simpleSlideWidth,r=e+i.x+i.getNoteX(this._startNote,0)-i.smuflMetrics.preNoteEffectPadding,n=t+i.y+i.getNoteY(this._startNote,2),o=r-a,l=t+i.y;switch(this._inType){case 1:l+=i.getNoteY(this._startNote,3);break;case 2:l+=i.getNoteY(this._startNote,1);break;default:return}let h=this._getAccidentalsWidth(i,this._startNote.beat);o-=h,r-=h,this._paintSlideLine(s,!1,o,r,l,n)}_getAccidentalsWidth(e,t){let s=e.getPreNotesGlyphForBeat(t);return s&&s.accidentals?s.accidentals.width:0}_drawSlideOut(e,t,s){let i=this.renderer,a=i.smuflMetrics.simpleSlideWidth,r=i.smuflMetrics.postNoteEffectPadding,n=0,o=0,l=0,h=0,d=!1;switch(this._outType){case 1:case 2:if(n=e+i.x+i.getBeatX(this._startNote.beat,4)+r,o=t+i.y+i.getNoteY(this._startNote,2),this._startNote.slideTarget){let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(l=e+s.x+s.getBeatX(this._startNote.slideTarget.beat,0)-r,h=t+s.y+s.getNoteY(this._startNote.slideTarget,2)):(l=e+i.x+i.width,h=this._startNote.slideTarget.realValue>this._startNote.realValue?t+i.y+i.getNoteY(this._startNote,1):t+i.y+i.getNoteY(this._startNote,3))}else l=e+i.x+this._parent.x,h=o;break;case 3:n=e+i.x+i.getNoteX(this._startNote,2)+r,o=t+i.y+i.getNoteY(this._startNote,2),l=n+a,h=t+i.y+i.getNoteY(this._startNote,1);break;case 4:n=e+i.x+i.getNoteX(this._startNote,2)+r,o=t+i.y+i.getNoteY(this._startNote,2),l=n+a,h=t+i.y+i.getNoteY(this._startNote,3);break;case 6:n=e+i.x+i.getNoteX(this._startNote,2)+2*r,o=t+i.y+i.getNoteY(this._startNote,2),h=t+i.y+i.getNoteY(this._startNote,1),l=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(l=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,0)),d=!0;break;case 5:n=e+i.x+i.getNoteX(this._startNote,2)+2*r,o=t+i.y+i.getNoteY(this._startNote,2),h=t+i.y+i.getNoteY(this._startNote,3),l=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(l=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,0)),d=!0;break;default:return}this._paintSlideLine(s,d,n,l,o,h)}_paintSlideLine(e,t,s,i,a,r){if(t){let t=new dd(0,0,1);t.renderer=this.renderer,t.doLayout(),a-=t.height/2;let n=i-s,o=(r-=t.height/2)-a,l=Math.sqrt(Math.pow(o,2)+Math.pow(n,2));t.width=n;let h=Math.asin(o/l)*(180/Math.PI);e.beginRotate(s,a,h),t.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(s,a),e.lineTo(i,r),e.stroke()}},Rc=class extends Ic{constructor(e,t,s=!1){super(e.beat,t.beat,s),this._startNote=e,this._endNote=t}getTieHeight(e,t,s,i){return Math.log2(s-e+1)*this.renderer.settings.notation.slurHeight/2}getStartY(){return this._isStartCentered()?0===this.tieDirection?this.startNoteRenderer.getNoteY(this._startNote,1):this.startNoteRenderer.getNoteY(this._startNote,3):this.startNoteRenderer.getNoteY(this._startNote,2)}getEndY(){return this._isEndCentered()?this._isEndOnStem()?0===this.tieDirection?this.endNoteRenderer.getNoteY(this._endNote,0):this.endNoteRenderer.getNoteY(this._endNote,4):0===this.tieDirection?this.endNoteRenderer.getNoteY(this._endNote,1):this.endNoteRenderer.getNoteY(this._endNote,3):this.endNoteRenderer.getNoteY(this._endNote,2)}_isStartCentered(){return this._startNote===this._startNote.beat.maxNote&&0===this.tieDirection||this._startNote===this._startNote.beat.minNote&&1===this.tieDirection}_isEndCentered(){return 0===this._startNote.beat.graceType&&(this._endNote===this._endNote.beat.maxNote&&0===this.tieDirection||this._endNote===this._endNote.beat.minNote&&1===this.tieDirection)}_isEndOnStem(){let e=this.endNoteRenderer;return this.startNoteRenderer.getBeatDirection(this.startBeat)!==e.getBeatDirection(this.endBeat)&&0===this.startBeat.graceType}getStartX(){return this._isStartCentered()?this.startNoteRenderer.getBeatX(this._startNote.beat,2):this.startNoteRenderer.getNoteX(this._startNote,2)}getEndX(){return this._isEndCentered()?this._isEndOnStem()?this.endNoteRenderer.getBeatX(this._endNote.beat,3):this.endNoteRenderer.getNoteX(this._endNote,1):this.endNoteRenderer.getBeatX(this._endNote.beat,0)}},Oc=class extends Yd{constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return 0===t.getBeatDirection(e)?1:0}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):0===this.tieDirection?this.startNoteRenderer.getNoteY(this.startNote,1):this.startNoteRenderer.getNoteY(this.startNote,3)}getEndY(){let e=this.endNoteRenderer;return this.endBeat.isRest?0===this.tieDirection?e.getScoreY(9):e.getScoreY(0):0===this.tieDirection?e.getNoteY(this.endNote,1):e.getNoteY(this.endNote,3)}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,4)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,0)}},Vc=class extends Yo{constructor(){super(...arguments),this._bend=null,this._effectSlur=null,this._effectEndSlur=null}doLayout(){this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(e.isVisible){if(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&3!==e.beat.graceType&&e.tieDestination&&e.tieDestination.isVisible){let t=new Oc(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination&&!e.tieOrigin.hasBend&&!e.beat.hasWhammyBar){let t=new Oc(e.tieOrigin,e,!0);this.addTie(t)}if(0!==e.slideInType||0!==e.slideOutType){let t=new Ac(e.slideInType,e.slideOutType,e,this);this.addTie(t)}if(e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible){let t=new Rc(e,e.slurDestination,!1);this.addTie(t)}if(e.isSlurDestination){let t=new Rc(e.slurOrigin,e,!0);this.addTie(t)}if(!this._effectSlur&&e.isEffectSlurOrigin&&e.effectSlurDestination){let t=new Rc(e,e.effectSlurDestination,!1);this._effectSlur=t,this.addTie(t)}if(!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin){let t=this.onNotes.beamingHelper.direction,s=0===t?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,i=0===t?e.beat.minNote:e.beat.maxNote,a=new Rc(s,i,!0);this._effectEndSlur=a,this.addTie(a)}if(e.hasBend){if(!this._bend){let t=new Dc(e.beat);this._bend=t,t.renderer=this.renderer,this.addTie(t)}this._bend.addBends(e)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let e=this.beat.nextBeat;for(;e.nextBeat&&e.nextBeat.isLegatoDestination;)e=e.nextBeat;this.addTie(new Ic(this.beat,e,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let e=this.beat.previousBeat;for(;e.previousBeat&&e.previousBeat.isLegatoOrigin;)e=e.previousBeat;this.addTie(new Ic(e,this.beat,!0))}}}},Wc=class extends Pl{paint(e,t,s){var i=[];try{o(i,Nl.bar(s,14,this.renderer.bar));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}},Hc=class e extends Ud{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.beatEffectsMinY=null,this.beatEffectsMaxY=null,this.accidentalHelper=new Wi(this)}get repeatsBarSubElement(){return 0}get barNumberBarSubElement(){return 4}get barLineBarSubElement(){return 8}get staffLineBarSubElement(){return 20}get showMultiBarRest(){return!0}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}registerBeatEffectOverflows(e,t){let s=this.beatEffectsMinY;(null==s||e<s)&&(this.beatEffectsMinY=e);let i=this.beatEffectsMaxY;(null==i||t>i)&&(this.beatEffectsMaxY=t)}getScoreY(e){return super.getLineY(e/2)}getScoreHeight(e){return super.getLineHeight(e/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){let e=this.getScoreY(-2),t=this.getScoreY(2*this.heightLineCount),s=this.simpleWhammyOverflow,i=this.beatEffectsMinY;if(null!==i){let t=e-i;t>0&&this.registerOverflowTop(t)}let a=this.beatEffectsMaxY;if(null!==a){let e=a-t;e>0&&this.registerOverflowBottom(e)}this.registerOverflowTop(s);let r=this.getScoreHeight(1),n=0,o=0;for(let e of this.helpers.beamHelpers)for(let t of e)if(t.isRestBeamHelper){if(t.minRestLine){let e=this.getScoreY(t.maxRestLine)-r;e<n&&(n=e)}if(t.maxRestLine){let e=this.getScoreY(t.maxRestLine)+r;e<n&&(n=e)}}else if(1===t.beats.length)if(t.beats[0].duration>=2)if(0===t.direction){let e=this.getFlagTopY(t.beats[0],t.direction);t.hasTuplet&&(e-=this.tupletSize+this.tupletOffset),e<n&&(n=e);let s=this.getFlagBottomY(t.beats[0],t.direction)+r;s>o&&(o=s)}else{let e=this.getFlagBottomY(t.beats[0],t.direction);t.hasTuplet&&(e+=this.tupletSize+this.tupletOffset),e>o&&(o=e);let s=this.getFlagTopY(t.beats[0],t.direction)-r;s<n&&(n=s)}else{let e=this.getBeatContainer(t.beats[0]);if(e){let s=e.onNotes.getHighestNoteY()-r,i=e.onNotes.getLowestNoteY()+r;0===t.direction?t.hasTuplet&&(s-=this.tupletSize+this.tupletOffset):t.hasTuplet&&(i+=this.tupletSize+this.tupletOffset),i>o&&(o=i),s<n&&(n=s)}}else{this._ensureDrawingInfo(t,t.direction);let e=t.drawingInfos.get(t.direction);if(0===t.direction){let s=Math.min(e.startY,e.endY);t.hasTuplet&&(s-=this.tupletSize+this.tupletOffset),s<n&&(n=s);let i=this.getBarLineStart(t.beatOfLowestNote,t.direction)+r;i>o&&(o=i)}else{let s=Math.max(e.startY,e.endY);t.hasTuplet&&(s+=this.tupletSize+this.tupletOffset),s>o&&(o=s);let i=this.getBarLineStart(t.beatOfHighestNote,t.direction)-r;i<n&&(n=i)}}n<e&&this.registerOverflowTop(Math.abs(n)+s),o>t&&this.registerOverflowBottom(Math.abs(o)-t)}}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,2,3),this.paintTuplets(e,t,s,4)}_getSlashFlagY(){let e=(this.heightLineCount-1)/2;return this.getLineY(e)}getFlagTopY(e,t){if(e.slashed){let s=this._getSlashFlagY(),i=Ec.getSymbol(e.duration),a=0!==e.graceType?zo.GraceScale:1;return 1===t?s-=this.smuflMetrics.stemDown.has(i)?this.smuflMetrics.stemDown.get(i).topY*a:0:(s-=this.smuflMetrics.stemUp.has(i)?this.smuflMetrics.stemUp.get(i).bottomY*a:0,s-=this.smuflMetrics.standardStemLength+a),s}let s=this.accidentalHelper.getMinLineNote(e);if(s)return this.getBeatContainer(e).onNotes.getNoteY(s,0===t?0:6);let i=this.getScoreY(this.accidentalHelper.getMinLine(e));if(0===t){let t=0!==e.graceType?zo.GraceScale:1;i-=this.smuflMetrics.standardStemLength*t}return i}getFlagBottomY(e,t){if(e.slashed){let s=this._getSlashFlagY(),i=Ec.getSymbol(e.duration),a=0!==e.graceType?zo.GraceScale:1;return 1===t?(s-=this.smuflMetrics.stemDown.has(i)?this.smuflMetrics.stemDown.get(i).topY*a:0,s+=this.smuflMetrics.standardStemLength+a):s-=this.smuflMetrics.stemUp.has(i)?this.smuflMetrics.stemUp.get(i).bottomY*a:0,s}let s=this.accidentalHelper.getMaxLineNote(e);if(s)return this.getBeatContainer(e).onNotes.getNoteY(s,0===t?5:4);let i=this.getScoreY(this.accidentalHelper.getMaxLine(e));if(1===t){let t=0!==e.graceType?zo.GraceScale:1;i+=this.smuflMetrics.standardStemLength*t}return i}getBeamDirection(e){return e.direction}centerStaffStemY(e){return this.bar.staff.standardNotationLineCount===ts.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):0===e.direction?this.getScoreY(2*this.bar.staff.standardNotationLineCount):this.getScoreY(0)}getStemBottomY(e){throw new Error("Method not implemented.")}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(e,t){if(e.beat.slashed){let e=(this.heightLineCount-1)/2;return this.getLineY(e)}let s=super.getNoteY(e,t);if(Number.isNaN(s)){let i=Wi.computeLineWithoutAccidentals(this.bar,e);s=this.getScoreY(i);let a=0===e.beat.graceType?1:zo.GraceScale,r=this.smuflMetrics.standardStemLength*a,n=this.smuflMetrics.glyphHeights.get(zo.getSymbol(e.beat.duration))*a;switch(t){case 0:s-=r;break;case 1:s-=n/2;break;case 2:case 5:case 6:break;case 3:s+=n/2;break;case 4:s+=r}}return s}applyLayoutingInfo(){let e=super.applyLayoutingInfo();if(e&&this.bar.isMultiVoice){let e=this.getScoreY(-2),t=this.getScoreY(2*this.heightLineCount),s=this.helpers.collisionHelper.getBeatMinMaxY();s[0]<e&&this.registerOverflowTop(Math.abs(s[0])),s[1]>t&&this.registerOverflowBottom(Math.abs(s[1])-t)}return e}calculateBeamYWithDirection(e,t,s){return 0===e.beats.length?0===s?this.getFlagTopY(e.beats[0],s):this.getFlagBottomY(e.beats[0],s):(this._ensureDrawingInfo(e,s),e.drawingInfos.get(s).calcY(t))}_ensureDrawingInfo(e,t){if(!e.drawingInfos.has(t)){let s=0!==e.graceType?zo.GraceScale:1,i=qe.getIndex(e.shortestDuration)-2,a=this.smuflMetrics.standardStemLength*s;if(e.tremoloDuration){let t=(this.smuflMetrics.beamThickness+this.smuflMetrics.beamSpacing)*s;e.shortestDuration>8?8===e.tremoloDuration?a+=t:a+=1.5*t:32===e.tremoloDuration&&(a+=1.5*t)}let r=new Cl;e.drawingInfos.set(t,r);let n=e.beats[0],o=e.beats[e.beats.length-1],l=e.isRestBeamHelper;r.startBeat=n,r.startX=e.getBeatLineX(n),r.startY=l?0===t?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):0===t?this.getFlagTopY(n,t):this.getFlagBottomY(n,t),r.endBeat=o,r.endX=e.getBeatLineX(o),r.endY=l?0===t?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):0===t?this.getFlagTopY(o,t):this.getFlagBottomY(o,t);let h=this.smuflMetrics.oneStaffSpace;if(1===t&&r.startY>r.endY&&r.startY-r.endY>h&&(r.endY=r.startY-h),1===t&&r.endY>r.startY&&r.endY-r.startY>h&&(r.startY=r.endY-h),0===t&&r.startY<r.endY&&r.endY-r.startY>h&&(r.endY=r.startY+h),0===t&&r.endY<r.startY&&r.startY-r.endY>h&&(r.startY=r.endY+h),e.beats.length>1){if(0===t){let t=this.getScoreY(this.accidentalHelper.getMinLine(e.beatOfHighestNote))-a,s=r.calcY(e.getBeatLineX(e.beatOfHighestNote))-t;s>0&&(r.startY-=s,r.endY-=s)}else{let t=this.getScoreY(this.accidentalHelper.getMaxLine(e.beatOfLowestNote))+a-r.calcY(e.getBeatLineX(e.beatOfLowestNote));t>0&&(r.startY+=t,r.endY+=t)}if(null!==e.minRestLine||null!==e.maxRestLine){let s=0!==e.graceType?zo.GraceScale:1,a=i*(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*s;if(a+=this.smuflMetrics.beamSpacing,0===t&&null!==e.minRestLine){let t=this.getScoreY(e.minRestLine)-a,s=r.calcY(e.getBeatLineX(e.beatOfMinRestLine))-t;s>0&&(r.startY-=s,r.endY-=s)}else if(1===t&&null!==e.maxRestLine){let t=this.getScoreY(e.maxRestLine)+a-r.calcY(e.getBeatLineX(e.beatOfMaxRestLine));t>0&&(r.startY+=t,r.endY+=t)}}if(e.slashBeats.length>0)for(let t of e.slashBeats){let s=r.calcY(e.getBeatLineX(t)),i=(0===e.direction?this.getFlagTopY(t,e.direction):this.getFlagBottomY(t,e.direction))-s;i>0&&(r.startY+=i,r.endY+=i)}}if(i>2&&!l){let e=this.smuflMetrics.beamSpacing*s,a=this.smuflMetrics.beamThickness*s,n=i*a+(i-1)*e;if(0===t){let t=r.startY+2*a+e-n,s=r.startY-t;s>0&&(r.startY-=s,r.endY-=s)}else{let t=r.startY-2*a+e+n-r.startY;t>0&&(r.startY+=t,r.endY+=t)}}}}getBarLineStart(e,t){if(e.slashed)return 1===t?this.getFlagTopY(e,t):this.getFlagBottomY(e,t);if(0===t){let t=this.accidentalHelper.getMaxLineNote(e);return t?this.getBeatContainer(e).onNotes.getNoteY(t,5):this.getScoreY(this.accidentalHelper.getMaxLine(e))}let s=this.accidentalHelper.getMinLineNote(e);return s?this.getBeatContainer(e).onNotes.getNoteY(s,6):this.getScoreY(this.accidentalHelper.getMinLine(e))}createLinePreBeatGlyphs(){let e=!1;if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let t=0;switch(this.bar.clef){case 0:t=this.bar.staff.standardNotationLineCount-1;break;case 3:case 2:t=2;break;case 1:t=4;break;case 4:t=6}this.createStartSpacing(),this.addPreBeatGlyph(new uc(0,this.getScoreY(t),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new Cd(0,0,this.smuflMetrics.preBeatGlyphSpacing)),e=!0}(e||0===this.index&&0!==this.bar.keySignature||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this._createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createKeySignatureGlyphs(){let t=0,s=this.bar.keySignature,i=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case 0:case 2:t=0;break;case 4:t=1;break;case 3:t=3;break;case 1:t=2}let a=new Wc;a.gap=this.smuflMetrics.accidentalPadding,a.renderer=this;let r=new Map,n=[];if(qe.keySignatureIsSharp(s))for(let i=0;i<Math.abs(s);i++){let s=e._sharpKsSteps[i]+t;n.push(new Zd(0,this.getScoreY(s),2,1)),r.set(s,!0)}else for(let i=0;i<Math.abs(s);i++){let s=e._flatKsSteps[i]+t;n.push(new Zd(0,this.getScoreY(s),3,1)),r.set(s,!0)}if(0===this.bar.keySignature){let s=Math.abs(i),n=qe.keySignatureIsSharp(i)?e._sharpKsSteps:e._flatKsSteps;for(let e=0;e<s;e++){let s=n[e]+t;r.has(s)||a.addGlyph(new Zd(0,this.getScoreY(n[e]+t),1,1))}}for(let e of n)a.addGlyph(e);this.addPreBeatGlyph(a),a.isEmpty||this.addPreBeatGlyph(new Cd(0,0,this.smuflMetrics.preBeatGlyphSpacing))}_createTimeSignatureGlyphs(){let e=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new lc(0,this.getScoreY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new Cd(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(e){for(let t of e.beats){let s=new Vc(t,this.getVoiceContainer(e));s.preNotes=new Fc,s.onNotes=new Lc,this.addBeatGlyph(s)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}completeBeamingHelper(e){if(this.bar.isMultiVoice&&e.highestNoteInHelper&&e.lowestNoteInHelper){let t=0,s=0,i=0;e.hasTuplet&&(i+=2*this.resources.effectFont.size),0===e.direction?(t=this.getNoteY(e.highestNoteInHelper,0)-i,s=this.getNoteY(e.lowestNoteInHelper,3)):(t=this.getNoteY(e.highestNoteInHelper,1),s=this.getNoteY(e.lowestNoteInHelper,4)+i);for(let i of e.beats)this.helpers.collisionHelper.reserveBeatSlot(i,t,s)}}paintBeamingStem(e,t,s,i,a,r){var n=[];try{o(n,Nl.beat(r,1,e));r.fillRect(s,i,this.smuflMetrics.stemThickness,a-i)}catch(e){var h=e,d=!0}finally{l(n,h,d)}}};Hc.StaffId="score",Hc._sharpKsSteps=[-1,2,-2,1,4,0,3],Hc._flatKsSteps=[3,0,4,1,5,2,6];var Gc=Hc,zc=class extends xl{get staffId(){return Gc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new Gc(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showStandardNotation}},Uc=class extends Yd{constructor(e,t,s=!1){super(e.beat,t.beat,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,t,s,i){return this._isLeftHandTap?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(e,t,s,i)}getBeamDirection(e,t){return 1}static getBeamDirectionForNote(e){return 1}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,2)}getEndY(){return this.getStartY()}getStartX(){return this._isLeftHandTap?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,2)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,0)}},Yc=class extends Yo{constructor(){super(...arguments),this._tiedNoteTie=null}createTies(e){if(e.isVisible){if(!this._tiedNoteTie&&e.isTieOrigin&&e.tieDestination.isVisible){let t=new Uc(e,e.tieDestination,!1);this._tiedNoteTie=t,this.addTie(t)}if(!this._tiedNoteTie&&e.isTieDestination){let t=new Uc(e.tieOrigin,e,!0);this._tiedNoteTie=t,this.addTie(t)}}}},Xc=class extends wc{updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){super.internalPaint(e,t,s,17)}},$c=class extends rh{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.restGlyph=null}get effectElement(){return 18}getNoteX(e,t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let e=s.x;switch(t){case 0:break;case 1:e+=s.width/2;break;case 2:e+=s.width}return e}return 0}buildBoundingsLookup(e,t,s){if(this.noteHeads&&this.container.beat.notes.length>0){let i=new fs;i.note=this.container.beat.notes[0],i.noteHeadBounds=new ms,i.noteHeadBounds.x=t+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}}getLowestNoteY(){return this.noteHeads?this.noteHeads.y:0}getHighestNoteY(){return this.noteHeads?this.noteHeads.y:0}getNoteY(e,t){let s=null,i=-1;if(this.noteHeads?(s=this.noteHeads,i=Ec.getSymbol(e.beat.duration)):this.deadSlapped&&(s=this.deadSlapped),s){let e=this.y+s.y;switch(t){case 1:case 0:e-=s.height/2;break;case 2:break;case 3:case 4:e+=s.height/2;break;case 5:e-=this.renderer.smuflMetrics.stemUp.has(i)?this.renderer.smuflMetrics.stemUp.get(i).bottomY:0;break;case 6:e-=this.renderer.smuflMetrics.stemDown.has(i)?this.renderer.smuflMetrics.stemDown.get(i).topY:0}return e}return 0}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.deadSlapped?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.deadSlapped.x+this.width,this.container.x+this.x+this.deadSlapped.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){let e=this.renderer,t=e.getNoteLine(),s=e.getLineY(t);if(this.container.beat.deadSlapped){let e=new sc;e.renderer=this.renderer,e.doLayout(),this.deadSlapped=e,this.addEffect(e)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let e=new Xc(0,s,this.container.beat.duration);this.restGlyph=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.addNormal(e),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)}else{let e=0!==this.container.beat.graceType,t=new Ec(0,s,this.container.beat.duration,e,this.container.beat);this.noteHeads=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper,this.addNormal(t)}if(this.container.beat.dots>0)for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new ec(0,e.getLineY(e.getNoteLine())-e.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}},Jc=class extends Ud{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this._isOnlySlash=!t.staff.showTablature&&!t.staff.showStandardNotation,this.helpers.preferredBeamDirection=0}get repeatsBarSubElement(){return 2}get barNumberBarSubElement(){return 6}get barLineBarSubElement(){return 10}get staffLineBarSubElement(){return 22}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,14,15),this.paintTuplets(e,t,s,16)}doLayout(){super.doLayout();let e=!1;for(let t of this.bar.voices)if(this.hasVoiceContainer(t)&&this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}e&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(e,t){let s=this.smuflMetrics.glyphHeights.get(57603),i=this.getLineY(0)-s/2;return 0===t&&(i-=this.getFlagStemSize(e.duration,!0)),i}getFlagBottomY(e,t){let s=this.smuflMetrics.glyphHeights.get(57603),i=this.getLineY(0)-s/2;return 1===t&&(i+=this.getFlagStemSize(e.duration,!0)),i}getBeamDirection(e){return 0}getNoteY(e,t){let s=super.getNoteY(e,t);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(e,t,s){return this.getLineY(0)-this.getFlagStemSize(e.shortestDuration)}getBarLineStart(e,t){let s=this.smuflMetrics.glyphHeights.get(57603);return this.getLineY(0)-s/2}createLinePreBeatGlyphs(){this._isOnlySlash&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new Cd(0,0,this.smuflMetrics.oneStaffSpace));let e=this.bar.masterBar,t=new lc(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));t.barSubElement=18,this.addPreBeatGlyph(t)}createVoiceGlyphs(e){for(let t of e.beats){let s=new Yc(t,this.getVoiceContainer(e));s.preNotes=new ah,s.onNotes=0===e.index?new $c:new rh,this.addBeatGlyph(s)}}paintBeamingStem(e,t,s,i,a,r){var n=[];try{o(n,Nl.beat(r,13,e));let t=r.lineWidth;r.lineWidth=this.smuflMetrics.stemThickness,r.beginPath(),r.moveTo(s,i),r.lineTo(s,a),r.stroke(),r.lineWidth=t}catch(e){var h=e,d=!0}finally{l(n,h,d)}}};Jc.StaffId="slash";var qc=class extends xl{get staffId(){return Jc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new Jc(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showSlash}},jc=class extends T{constructor(e=0,t=0){super(e,t),this.lineValue=0,this.lineValue=t}},Kc=class e extends Oo{constructor(){super(0,0),this._notes=[],this._renderPoints=new Map,this._preBendMinValue=-1,this._bendMiddleMinValue=-1,this._bendEndMinValue=-1,this._bendEndContinuedMinValue=-1,this._releaseMinValue=-1,this._releaseContinuedMinValue=-1,this._maxBendValue=-1}addBends(e){this._notes.push(e);let t=this._createRenderingPoints(e);this._renderPoints.set(e.id,t),(-1===this._maxBendValue||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let s=0;switch(e.bendType){case 2:s=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(-1===this._bendEndMinValue||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case 3:s=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case 4:s=t[1].value,(-1===this._bendMiddleMinValue||s<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=s),s=t[2].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case 6:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s);break;case 7:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(-1===this._bendEndMinValue||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case 8:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s)}}doLayout(){super.doLayout();let e=this._maxBendValue*this.renderer.smuflMetrics.tabBendPerValueHeight;this.renderer.registerOverflowTop(e);let t=0;for(let e of this._notes){let s=this._renderPoints.get(e.id);switch(e.bendType){case 2:s[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case 3:t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[1].lineValue=t);break;case 4:s[1].lineValue=this._bendMiddleMinValue,t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[2].lineValue=t);break;case 6:s[0].lineValue=this._preBendMinValue;break;case 7:s[0].lineValue=this._preBendMinValue,s[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case 8:s[0].lineValue=this._preBendMinValue,t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[1].lineValue=t)}}this.width=0,this._notes.sort((e,t)=>e.isStringed?e.string-t.string:e.realValue-t.realValue)}_createRenderingPoints(e){let t=[];switch(e.bendType){case 1:for(let s of e.bendPoints)t.push(new jc(s.offset,s.value));break;case 4:t.push(new jc(0,e.bendPoints[0].value)),t.push(new jc(T.MaxPosition/2|0,e.bendPoints[1].value)),t.push(new jc(T.MaxPosition,e.bendPoints[3].value));break;case 2:case 5:case 6:case 7:case 8:case 3:t.push(new jc(0,e.bendPoints[0].value)),t.push(new jc(T.MaxPosition,e.bendPoints[1].value))}return t}paint(e,t,s){let i=s.color;this._notes.length>1&&(s.color=this.renderer.resources.secondaryGlyphColor);for(let a of this._notes){let r=this._renderPoints.get(a.id),n=this.renderer,o=a,l=!1,h=null,d=!1,c=1===a.bendStyle?"grad.":"",u=null;for(;o.isTieOrigin;){let e=o.tieDestination;if(h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,e.beat.voice.bar),!h||n.staff!==h.staff)break;if(o=e,l=!0,o.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||0!==o.vibrato){d=!0;break}}u=o.beat,h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,u.voice.bar),u.isLastOfVoice&&!o.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(u=null);let p=0,m=0,g=t+n.y,f=this.renderer.smuflMetrics.glyphWidths.get(60284);p=e+n.x,r[0].value>0||a.isContinuedBend?p+=n.getBeatX(a.beat,2):p+=n.getNoteX(a,2),m=!u||u.isLastOfVoice&&!d?e+h.x+h.postBeatGlyphsStart:d||!u.nextBeat?e+h.x+h.getBeatX(u,2):5===a.bendType?e+h.x+h.getBeatX(u.nextBeat,1):e+h.x+h.getBeatX(u.nextBeat,0),l||(m-=f);let b=(m-p)/T.MaxPosition;s.beginPath();for(let e=0,t=r.length-1;e<t;e++){let t=r[e],i=r[e+1];0===e&&0!==t.value&&!a.isTieDestination&&this._paintBend(a,new jc(0,0),t,p,g,b,c,s),6!==a.bendType?(0===e&&(p+=this.renderer.smuflMetrics.postNoteEffectPadding),this._paintBend(a,t,i,p,g,b,c,s)):a.isTieOrigin&&a.tieDestination.hasBend&&(i=new jc(T.MaxPosition,t.value),i.lineValue=t.lineValue,this._paintBend(a,t,i,p,g,b,c,s))}if(0!==o.vibrato){let i=m-e+f-h.x,a=g-t-this.renderer.smuflMetrics.tabBendPerValueHeight*r[r.length-1].lineValue,n=new dd(i,a,o.vibrato);n.beat=o.beat,n.renderer=h,n.doLayout(),n.paint(e+h.x,t,s)}s.color=i}}_paintBend(t,s,i,a,r,n,o,l){let h=this.renderer,d=this.renderer.resources,c=h.lineOffset/2,u=a+n*s.offset,p=this.renderer.smuflMetrics.tabBendPerValueHeight,m=r-p*s.lineValue;0===s.value?i.offset===s.offset?m+=h.getNoteY(t.beat.maxStringNote,1)-c/2:m+=h.getNoteY(t,2):m+=c;let g=a+n*i.offset,f=r-p*i.lineValue;0===i.lineValue?f+=h.getNoteY(t,2):f+=c;let b=0,y=this.renderer.smuflMetrics.glyphWidths.get(60284)??0;if(isNaN(y)||isNaN(u)||isNaN(g)||isNaN(m)||isNaN(f))return;i.value>s.value?(f+y>m&&(f=m-y),l.beginPath(),l.moveTo(g,f),l.lineTo(g-.5*y,f+y),l.lineTo(g+.5*y,f+y),l.closePath(),l.fill(),b=y):i.value!==s.value&&(f<m&&(f=m+y),l.beginPath(),l.moveTo(g,f),l.lineTo(g-.5*y,f-y),l.lineTo(g+.5*y,f-y),l.closePath(),l.fill(),b=-y);let _=l.lineWidth;if(l.lineWidth=this.renderer.smuflMetrics.arrowShaftThickness,l.beginPath(),s.value===i.value){if(s.lineValue>0){let e=g,t=this.renderer.smuflMetrics.tabBendDashSize,s=u+t;if((e-u)/(2*t)<1)l.moveTo(e,m),l.lineTo(u,m);else for(;e>s;)l.moveTo(e,m),l.lineTo(e-t,m),e-=2*t;l.stroke()}}else g>u?(l.moveTo(u,m),l.bezierCurveTo((u+g)/2,m,g,m,g,f+b),l.stroke()):(l.moveTo(u,m),l.lineTo(g,f),l.stroke());if(o&&s.offset<i.offset){l.font=d.graceFont;let e=l.measureText(o),t=0,s=0;if(m>f){let i=Math.abs(m-f);t=i>e.height?m-i/2:m,s=(u+g-e.width)/2}else t=m,s=g-e.width;l.fillText(o,s,t)}if(0!==i.value&&s.value!==i.value){let t=i.value,a=i.value>s.value;t=Math.abs(t);let n="";if(4===t)n="full",t-=4;else if(t>=4||t<=-4){let e=t/4|0;n+=e,t-=4*e}if(t>0&&(n+=e.getFractionSign(t)),""!==n){f=r-p*i.value;let e=f;a||(e=m+1*Math.abs(f-m)/3),l.font=d.tablatureFont;let t=l.measureText(n),s=e-t.height/1.5,o=g-t.width/2;l.fillText(n,o,s-d.engravingSettings.tabBendLabelPadding)}}l.lineWidth=_}static getFractionSign(e){switch(e){case 1:return"";case 2:return"";case 3:return"";default:return`${e}/ 4`}}},Qc=class extends Oo{constructor(e,t,s,i){super(0,0),this._inType=e,this._outType=t,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this._paintSlideIn(e,t,s),this._paintSlideOut(e,t,s)}_paintSlideIn(e,t,s){let i=this.renderer,a=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight,n=0,o=0,l=0,h=0,d=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this._inType){case 1:l=e+i.x+i.getNoteX(this._startNote,0)-d,h=t+i.y+i.getNoteY(this._startNote,2)-r,n=l-a,o=t+i.y+i.getNoteY(this._startNote,2)+r;break;case 2:l=e+i.x+i.getNoteX(this._startNote,0)-d,h=t+i.y+i.getNoteY(this._startNote,2)+r,n=l-a,o=t+i.y+i.getNoteY(this._startNote,2)-r;break;default:return}this._paintSlideLine(s,!1,n,l,o,h)}_paintSlideOut(e,t,s){let i=this.renderer,a=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight,n=0,o=0,l=0,h=0,d=!1,c=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this._outType){case 1:case 2:if(n=e+i.x+i.getBeatX(this._startNote.beat,4)+c,o=t+i.y+i.getNoteY(this._startNote,2),this._startNote.slideTarget){let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(l=e+s.x+s.getBeatX(this._startNote.slideTarget.beat,1)-c,h=t+s.y+s.getNoteY(this._startNote.slideTarget,2)):(l=e+i.x+i.width,h=o),this._startNote.slideTarget.fret>this._startNote.fret?(o+=r,h-=r):(o-=r,h+=r)}else l=e+i.x+this._parent.x,h=o;break;case 3:n=e+i.x+i.getNoteX(this._startNote,2)+c,o=t+i.y+i.getNoteY(this._startNote,2)+r,l=n+a,h=t+i.y+i.getNoteY(this._startNote,2)-r;break;case 4:n=e+i.x+i.getNoteX(this._startNote,2)+c,o=t+i.y+i.getNoteY(this._startNote,2)-r,l=n+a,h=t+i.y+i.getNoteY(this._startNote,2)+r;break;case 5:n=e+i.x+i.getNoteX(this._startNote,2)+2*c,o=t+i.y+i.getNoteY(this._startNote,2),l=e+i.x+i.width,h=o+3*r,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(l=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,0)),d=!0;break;case 6:n=e+i.x+i.getNoteX(this._startNote,2)+2*c,o=t+i.y+i.getNoteY(this._startNote,2),l=e+i.x+i.width,h=o-3*r,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(l=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,0)),d=!0;break;default:return}this._paintSlideLine(s,d,n,l,o,h)}_paintSlideLine(e,t,s,i,a,r){if(t){let t=new dd(0,0,1);t.renderer=this.renderer,t.doLayout(),a-=t.height/2;let n=i-s,o=(r-=t.height/2)-a,l=Math.sqrt(Math.pow(o,2)+Math.pow(n,2));t.width=n;let h=Math.asin(o/l)*(180/Math.PI);e.beginRotate(s,a,h),t.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(s,a),e.lineTo(i,r),e.stroke()}},Zc=class extends $d{constructor(e,t,s,i=!1){super(e,t,i),this._direction=$d.getBeamDirectionForNote(e),this._forSlide=s}getTieHeight(e,t,s,i){let a=Math.max(0,s-e);return Math.log(a+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,t,s,i){if(this._forSlide!==s||this.forEnd!==i||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id||this._direction!==$d.getBeamDirectionForNote(e))return!1;switch(this._direction){case 0:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case 1:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,s){let i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,i),r=`tab.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${a}`,n=this.renderer;n.staff.getSharedLayoutData(r,!1)||(n.staff.setSharedLayoutData(r,!0),super.paint(e,t,s))}},eu=class extends Yo{constructor(){super(...arguments),this._bend=null,this._effectSlurs=[]}drawBeamHelperAsFlags(e){return e.hasFlag(this.renderer.drawBeamHelperAsFlags(e),this.beat)}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(!e.isVisible)return;let t=this.renderer;if(e.isTieOrigin&&t.showTiedNotes&&e.tieDestination.isVisible){let t=new $d(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination&&t.showTiedNotes){let t=new $d(e.tieOrigin,e,!0);this.addTie(t)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){let t=new $d(e,e,!1);this.addTie(t)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let t=!1;for(let s of this._effectSlurs)if(s.tryExpand(e,e.effectSlurDestination,!1,!1)){t=!0;break}if(!t){let t=new Zc(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(t),this.addTie(t)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let t=!1;for(let s of this._effectSlurs)if(s.tryExpand(e.effectSlurOrigin,e,!1,!0)){t=!0;break}if(!t){let t=new Zc(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(t),this.addTie(t)}}if(0!==e.slideInType||0!==e.slideOutType){let t=new Qc(e.slideInType,e.slideOutType,e,this);this.addTie(t)}if(e.hasBend){if(!this._bend){let e=new Kc;this._bend=e,e.renderer=this.renderer,this.addTie(e)}this._bend.addBends(e)}}},tu=class extends Oo{constructor(e,t,s){super(e,t),this._noteString=null,this._trillNoteString=null,this._trillNoteStringWidth=0,this.isEmpty=!1,this.noteStringWidth=0,this._note=s}doLayout(){let e=this._note,t=e.fret-e.beat.voice.bar.staff.transpositionPitch;if(1===e.harmonicType&&0!==e.harmonicValue&&(t=e.harmonicValue-e.beat.voice.bar.staff.transpositionPitch),e.isTieDestination)0===e.beat.index&&0===this.renderer.settings.notation.notationMode||(2===e.bendType||4===e.bendType)&&this.renderer.settings.notation.isNotationElementVisible(12)?this._noteString=`(${(e.tieOrigin.fret-e.beat.voice.bar.staff.transpositionPitch).toString()})`:this._noteString="";else{let s=!0,i=e.beat;for(let e of i.notes)if(!e.isDeadVisual){s=!1;break}let a=i.brushType>=1&&i.brushType<=4;if(s&&a)this._noteString="";else{let i=e.isDead||e.isDeadVisual&&!(s&&a);if(this._noteString=i?"X":t.toString(),e.isGhost&&(this._noteString=`(${this._noteString})`),1===e.harmonicType){let e=this._noteString.indexOf(".");e>=0&&(this._noteString=this._noteString.substr(0,e+2)),this._noteString=`<${this._noteString}>`}}}if(e.isTrill)this._trillNoteString=`(${(e.trillFret-e.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(qe.isAlmostEqualTo(e.harmonicValue,0))this._trillNoteString="";else switch(e.harmonicType){case 2:case 3:case 4:case 5:case 6:let s=(t+e.harmonicValue).toString(),i=s.indexOf(".");i>=0&&(s=s.substr(0,i+2)),this._trillNoteString=`<${s}>`;break;default:this._trillNoteString=""}if(this.isEmpty=!this._noteString,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont;let e=!!this._trillNoteString;this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString+(e?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,e&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString).width,this.width+=this._trillNoteStringWidth)}}paint(e,t,s){var i=[];try{if(this.isEmpty)return;let a=this.noteStringWidth+this._trillNoteStringWidth,r=e+this.x+(this.width-a)/2;0!==this._note.beat.graceType&&(r+=2),this.paintTrill(r,t,s);o(i,Nl.note(s,4,this._note));s.fillText(this._noteString,r,t+this.y)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}paintTrill(e,t,s){var i=[];try{o(i,Nl.note(s,4,this._note));let a=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this._trillNoteString,e+this.noteStringWidth,t+this.y),this.renderer.scoreRenderer.canvas.font=a}catch(e){var a=e,r=!0}finally{l(i,a,r)}}buildBoundingsLookup(e,t,s){let i=new fs;i.note=this._note,i.noteHeadBounds=new ms,i.noteHeadBounds.x=t+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}},su=class extends Oo{constructor(e,t,s){super(e,t),this._notes=[],this._deadSlapped=null,this.maxStringNote=null,this.minStringNote=null,this.beatEffects=new Map,this.notesPerString=new Map,this.noteStringWidth=0,this._isGrace=s}buildBoundingsLookup(e,t,s){for(let i of this._notes)i.buildBoundingsLookup(e,t+this.x,s+this.y)}getNoteX(e,t){if(this.notesPerString.has(e.string)){let s=this.notesPerString.get(e.string),i=this.x+s.x;switch(t){case 0:break;case 1:i+=s.noteStringWidth/2;break;case 2:i+=s.width}return i}return 0}getLowestNoteY(){return this.maxStringNote?this.getNoteY(this.maxStringNote,2):0}getHighestNoteY(){return this.minStringNote?this.getNoteY(this.minStringNote,2):0}getNoteY(e,t){if(this.notesPerString.has(e.string)){let s=this.notesPerString.get(e.string),i=this.y+s.y;switch(t){case 1:case 0:i-=s.height/2;break;case 2:case 5:case 6:break;case 3:case 4:i+=s.height/2}return i}return 0}doLayout(){let e=0;if(this.beat.deadSlapped)this._deadSlapped=new sc,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),e=this._deadSlapped.width,this.noteStringWidth=e;else{let t=0;for(let s=0,i=this._notes.length;s<i;s++){let i=this._notes[s];i.renderer=this.renderer,i.doLayout(),i.width>e&&(e=i.width),i.noteStringWidth>t&&(t=i.noteStringWidth)}this.noteStringWidth=t;let s=this.renderer.resources.tablatureFont.size,i=this.getNoteY(this.minStringNote,2)+s/2,a=this.renderer.smuflMetrics.onNoteEffectPadding;for(let e of this.beatEffects.values())e.y+=i,e.x+=this.width/2,e.renderer=this.renderer,i+=e.height+a,e.doLayout()}this.width=e}addNoteGlyph(e,t){this._notes.push(e),this.notesPerString.set(t.string,e),(!this.minStringNote||t.string<this.minStringNote.string)&&(this.minStringNote=t),(!this.maxStringNote||t.string>this.maxStringNote.string)&&(this.maxStringNote=t)}paint(e,t,s){if(e+=this.x,t+=this.y,this.beat.deadSlapped)this._deadSlapped?.paint(e,t,s);else{var i=[];try{let a=this.renderer.resources,r=s.textBaseline;s.textBaseline=1,s.font=this._isGrace?a.graceFont:a.tablatureFont;let n=this._notes,l=this.width,h=!1;for(let e of this.beat.notes)if(e.isDead){h=!0;break}if(h){let i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(let s of n){if(s.isEmpty)continue;let n=s.noteStringWidth+(s._trillNoteStringWidth||0),h=e+s.x+(l-n)/2;0!==s._note.beat.graceType&&(h+=2),i=Math.min(i,h),a=Math.max(a,h+s.noteStringWidth);let d=t+s.y-s.height/2;r=Math.min(r,d),o=Math.max(o,d+s.height)}if(i!==Number.POSITIVE_INFINITY){let e=1,t=s.lineWidth;s.lineWidth=1;let n=s.lineWidth%2==0?0:.5,l=1;s.strokeRect(i-e-n+.3,r-e-n,Math.max(1,a-i+2*e-l),Math.max(1,o-r+2*e-l)),s.lineWidth=t}}for(let i of n)i.renderer=this.renderer,i.width=l,i.paint(e,t,s);s.textBaseline=r;o(i,Nl.beat(s,11,this.beat));for(let i of this.beatEffects.values())i.paint(e,t,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}},iu=class extends Wo{constructor(e,t,s,i){super(e,t,1,wc.getSymbol(i)),this._isVisibleRest=s}doLayout(){super.doLayout()}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){if(this._isVisibleRest){var i=[];try{o(i,Nl.beat(s,12,this.beat));super.paint(e,t,s)}catch(e){var a=e,r=!0}finally{l(i,a,r)}}}},au=class e extends Oo{constructor(e){super(0,0),this._isSimpleDip=!1,this._beat=e,this._renderPoints=this._createRenderingPoints(e)}_createRenderingPoints(e){if(1===e.whammyBarType)return e.whammyBarPoints;let t=[];switch(e.whammyBarType){case 2:case 4:case 6:case 5:t.push(new T(0,e.whammyBarPoints[0].value)),t.push(new T(T.MaxPosition,e.whammyBarPoints[1].value));break;case 3:t.push(new T(0,e.whammyBarPoints[0].value)),t.push(new T(T.MaxPosition/2|0,e.whammyBarPoints[1].value)),t.push(new T(T.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value))}return t}doLayout(){super.doLayout(),this._isSimpleDip=1===this.renderer.settings.notation.notationMode&&3===this._beat.whammyBarType;let t=null,s=null,i=this._beat;for(;i&&i.hasWhammyBar;)(!t||t.value>i.minWhammyPoint.value)&&(t=i.minWhammyPoint),(!s||s.value<i.maxWhammyPoint.value)&&(s=i.maxWhammyPoint),i=i.nextBeat;let a=s.value>0?Math.abs(this._getOffset(s.value)):0;(a>0||0!==this._beat.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(13))&&(a+=this.renderer.resources.tablatureFont.size+this.renderer.smuflMetrics.tabWhammyTextPadding);let r=t.value<0?Math.abs(this._getOffset(t.value)):0,n=this.renderer.staff.getSharedLayoutData(e._topOffsetSharedDataKey,-1),o=n;a>n&&(this.renderer.staff.setSharedLayoutData(e._topOffsetSharedDataKey,a),o=a);let l=this.renderer.staff.getSharedLayoutData(e._bottomOffsetSharedDataKey,-1),h=l;r>l&&(this.renderer.staff.setSharedLayoutData(e._bottomOffsetSharedDataKey,r),h=l),this.height=a+r,this.renderer.registerOverflowTop(o+h)}_getOffset(e){if(0===e)return 0;let t=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(e)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return e<0&&(t=-t),t}paint(t,s,i){var a=[];try{o(a,Nl.beat(i,5,this._beat));let r=this.renderer,n=this._beat.nextBeat,l=null,h=0;n&&(l=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,n.voice.bar),!l||l.staff!==r.staff||l!==r&&!n.hasWhammyBar?(n=null,l=null):h=!n.hasWhammyBar||1===r.settings.notation.notationMode&&3===n.whammyBarType?0:2);let d=0,c=0;this._isSimpleDip?(d=t+r.x+r.getBeatX(this._beat,1),c=t+r.x+r.getBeatX(this._beat,4)):(d=t+r.x+r.getBeatX(this._beat,2),c=l?t+l.x+l.getBeatX(n,h):t+r.x+r.postBeatGlyphsStart);let u=i.textAlign,p=i.textBaseline;if(i.textAlign=1,i.textBaseline=3,this._renderPoints.length>=2){let t=(c-d)/T.MaxPosition;i.beginPath();let a=s+this.renderer.staff.getSharedLayoutData(e._topOffsetSharedDataKey,0),r=1===this._beat.whammyStyle?"grad.":"";for(let e=0,s=this._renderPoints.length-1;e<s;e++){let s=this._renderPoints[e],n=this._renderPoints[e+1],o=0===e;0===e&&0!==s.value&&!this._beat.isContinuedWhammy&&(this._paintWhammy(!1,new T(0,0),s,d,a,t,i),o=!1),this._paintWhammy(o,s,n,d,a,t,i,r),r=""}i.stroke()}i.textAlign=u,i.textBaseline=p}catch(e){var r=e,n=!0}finally{l(a,r,n)}}_paintWhammy(e,t,s,i,a,r,n,o){let l=i+r*t.offset,h=i+r*s.offset,d=a-this._getOffset(t.value),c=a-this._getOffset(s.value);if(t.offset===s.offset){let e=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(c-d)/(2*e)<1)n.moveTo(l,d),n.lineTo(h,c);else{let t=Math.max(d,c),s=Math.min(d,c);for(;t>s;)n.moveTo(l,s),n.lineTo(l,s+e),s+=2*e}n.stroke()}else if(t.value===s.value){let e=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(h-l)/(2*e)<1)n.moveTo(l,d),n.lineTo(h,c);else{let t=Math.max(l,h),s=Math.min(l,h);for(;t>s;)n.moveTo(t,d),n.lineTo(t-e,d),t-=2*e}n.stroke()}else n.moveTo(l,d),n.lineTo(h,c);let u=this.renderer.smuflMetrics.tabWhammyTextPadding;e&&!this._beat.isContinuedWhammy&&!this._isSimpleDip&&(this.renderer.settings.notation.isNotationElementVisible(13)&&n.fillText("0",l,d-u),o&&n.fillText(o,l,d-u));let p=Math.abs(s.value);if((0!==p||this.renderer.settings.notation.isNotationElementVisible(13)&&!this._isSimpleDip)&&t.value!==s.value){let e="";if(s.value<0&&(e+="-"),p>=4){let t=p/4|0;e+=t,p-=4*t}else 0===p&&(e+="0");p>0&&(e+=Kc.getFractionSign(p));let i=0;i=this._isSimpleDip||t.offset===s.offset?Math.min(d,c):c;let a=h;n.fillText(e,a,i-u)}}};au._topOffsetSharedDataKey="tab.whammy.topoffset",au._bottomOffsetSharedDataKey="tab.whammy.bottomffset";var ru=au,nu=class extends rh{constructor(){super(...arguments),this.slash=null,this.noteNumbers=null,this.restGlyph=null}get effectElement(){return 11}getNoteX(e,t){return this.noteNumbers?this.noteNumbers.getNoteX(e,t):0}getNoteY(e,t){return this.noteNumbers?this.noteNumbers.getNoteY(e,t):0}getLowestNoteY(){return this.noteNumbers?this.noteNumbers.getLowestNoteY():0}getHighestNoteY(){return this.noteNumbers?this.noteNumbers.getHighestNoteY():0}buildBoundingsLookup(e,t,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(e,t+this.x,s+this.y)}doLayout(){let e=this.renderer,t=[];if(this.container.beat.isRest){let t=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=e.getTabY(t),i=new iu(0,s,e.showRests,this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addNormal(i),this.container.beat.dots>0&&e.showRests)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new ec(0,s))}else{let s,i=this.renderer.settings.notation.smallGraceTabNotes&&0!==this.container.beat.graceType;if(this.container.beat.slashed&&!this.container.beat.notes.some(e=>e.isTieDestination)){let t=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),a=e.getLineY(t),r=new Ec(0,a,this.container.beat.duration,i,this.container.beat);r.noteHeadElement=4,r.effectElement=11,this.slash=r,r.beat=this.container.beat,r.beamingHelper=this.beamingHelper,this.addNormal(r),s=r.beatEffects}else{let e=new su(0,0,i);this.noteNumbers=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper;for(let e of this.container.beat.notes)e.isVisible&&this._createNoteGlyph(e);this.addNormal(e),s=e.beatEffects}if(this.container.beat.hasWhammyBar){let e=new ru(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.isTremolo&&!s.has("tremolo")){let e=this.container.beat.tremoloSpeed,i=new Sc(0,0,e);i.offsetY=this.renderer.smuflMetrics.glyphTop.get(i.symbol),s.set("tremolo",i),t.push(i)}if(this.container.beat.dots>0&&0!==e.rhythmMode)for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new ec(0,e.lineOffset*e.bar.staff.tuning.length+e.settings.notation.rhythmHeight))}if(this.isEmpty)return;let s=0;for(let e=0,t=this.glyphs.length;e<t;e++){let t=this.glyphs[e];t.x=s,t.renderer=this.renderer,t.doLayout(),s+=t.width}this.width=s,this.computedWidth=s,this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2);for(let e of t)e.x=this.centerX}updateBeamingHelper(){this.noteNumbers?this.noteNumbers.updateBeamingHelper(this.container.x+this.x):this.restGlyph?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}_createNoteGlyph(e){let t=this.renderer,s=new tu(0,0,e),i=e.beat.voice.bar.staff.tuning.length-e.string;s.y=t.getTabY(i),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,e);let a=s.y-s.height/2,r=a+s.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,a,r)}},ou=class extends Oo{constructor(e){super(0,0),this._beat=e}doLayout(){if(this.width=this.renderer.smuflMetrics.glyphWidths.get(60284),3===this._beat.brushType){let e=new dd(0,0,1,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e}else if(4===this._beat.brushType){let e=new dd(0,0,1,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e}}paint(e,t,s){let i=this.renderer,a=t+this.x+i.getNoteY(this._beat.maxStringNote,1)-4,r=t+this.y+i.getNoteY(this._beat.minStringNote,3)-4,n=!0;for(let e of this._beat.notes)if(!e.isDeadVisual){n=!1;break}let o=e+this.x+this.width/2+(n?8:0),l=this.renderer.smuflMetrics.glyphWidths.get(60284);if(0!==this._beat.brushType){if(1===this._beat.brushType||2===this._beat.brushType)s.beginPath(),s.moveTo(o,a),s.lineTo(o,r+10),s.stroke();else if(3===this._beat.brushType){let e=a,t=r-l+10;const i=5,n=3,h=Math.floor(Math.abs(t-e)/i);s.beginPath(),s.moveTo(o,e);let d=e;for(let t=1;t<=h;t++){const a=e+t*i;t%2==1?s.quadraticCurveTo(o-n,a-i/2,o,a):s.quadraticCurveTo(o+n,a-i/2,o,a),d=a}if(d<t){const e=t-d,i=h%2==1?o+n:o-n;s.quadraticCurveTo(i,d+e/2,o,t)}s.stroke()}else if(4===this._beat.brushType){let e=a+l,t=r+10;const i=5,n=3,h=Math.floor(Math.abs(t-e)/i);s.beginPath(),s.moveTo(o,e);for(let t=1;t<=h;t++){const a=e+t*i;t%2==1?s.quadraticCurveTo(o+n,a-i/2,o,a):s.quadraticCurveTo(o-n,a-i/2,o,a)}s.stroke()}1===this._beat.brushType||3===this._beat.brushType?(s.beginPath(),s.moveTo(o+l/2,r+10-l),s.lineTo(o,r+10),s.lineTo(o-l/2,r+10-l),s.stroke(),s.beginPath(),s.moveTo(o,r+10),s.lineTo(o,r+10-l),s.stroke()):(s.beginPath(),s.moveTo(o+l/2,a+l),s.lineTo(o,a),s.lineTo(o-l/2,a+l),s.stroke(),s.beginPath(),s.moveTo(o,a),s.lineTo(o,a+l),s.stroke())}}},lu=class extends ah{doLayout(){0!==this.container.beat.brushType&&!this.container.beat.isRest&&(this.addEffect(new ou(this.container.beat)),this.addNormal(new Cd(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return 11}},hu=class extends Wo{constructor(e,t){super(e,t,1,57453)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?57454:57453,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(57424),this.offsetX=this.width/2}},du=class extends oc{doLayout(){this.barSubElement=17,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?zo.GraceScale:1}},cu=class extends Ud{constructor(e,t){super(e,t),this._hasTuplets=!1,this.showTimeSignature=!1,this.showRests=!1,this.showTiedNotes=!1,this._showMultiBarRest=!1,t.staff.showStandardNotation||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this._showMultiBarRest=!0)}get showMultiBarRest(){return this._showMultiBarRest}get repeatsBarSubElement(){return 1}get barNumberBarSubElement(){return 5}get barLineBarSubElement(){return 9}get staffLineBarSubElement(){return 21}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let e=this.settings.notation.rhythmMode;return 3===e&&(e=this.bar.staff.showStandardNotation?0:2),e}getTabY(e){return super.getLineY(e)}getTabHeight(e){return super.getLineHeight(e)}collectSpaces(e){let t=this.smuflMetrics.staffLineThickness;for(let s of this.bar.voices)if(this.hasVoiceContainer(s)){let i=this.getVoiceContainer(s);for(let s of i.beatGlyphs){let a=s.onNotes,r=a.noteNumbers;if(r)for(let[n,o]of r.notesPerString)o.isEmpty||e[this.bar.staff.tuning.length-n].push(new Float32Array([i.x+s.x+a.x+r.x-t,r.width+2*t]))}}}adjustSizes(){if(0!==this.rhythmMode){let e=1;for(let t of this.helpers.beamHelpers)for(let s of t)s.tremoloDuration&&(!e||e<s.tremoloDuration)&&(e=s.tremoloDuration);switch(e){case 8:this.height+=this.smuflMetrics.glyphHeights.get(57888);break;case 16:this.height+=this.smuflMetrics.glyphHeights.get(57889);break;case 32:this.height+=this.smuflMetrics.glyphHeights.get(57890)}this.height+=this.settings.notation.rhythmHeight,this.bottomPadding+=this.settings.notation.rhythmHeight}}doLayout(){if(super.doLayout(),0!==this.rhythmMode){this._hasTuplets=!1;for(let e of this.bar.voices)if(this.hasVoiceContainer(e)&&this.getVoiceContainer(e).tupletGroups.length>0){this._hasTuplets=!0;break}this._hasTuplets&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){if(this.isFirstOfLine){let e=(this.bar.staff.tuning.length-1)/2;this.createStartSpacing(),this.addPreBeatGlyph(new hu(0,this.getTabY(e)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new Cd(0,0,this.smuflMetrics.oneStaffSpace));let e=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new du(0,this.getTabY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){if(this.additionalMultiRestBars){let t=new hh(this.getVoiceContainer(e));this.addBeatGlyph(t)}else for(let t of e.beats){let s=new eu(t,this.getVoiceContainer(e));s.preNotes=new lu,s.onNotes=new nu,this.addBeatGlyph(s)}}paint(e,t,s){super.paint(e,t,s),0!==this.rhythmMode&&(this.paintBeams(e,t,s,8,9),this.paintTuplets(e,t,s,10))}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||1===this.rhythmMode}getFlagTopY(e,t){let s=this.getOnNotesGlyphForBeat(e);return s.noteNumbers&&2!==e.duration?s.noteNumbers.getNoteY(s.noteNumbers.minStringNote,3)+this.smuflMetrics.staffLineThickness:this.height-this.settings.notation.rhythmHeight-this.tupletSize}getFlagBottomY(e,t){return this.getFlagAndBarPos()}getFlagStemSize(e,t=!1){return 0}getBarLineStart(e,t){return this.getFlagTopY(e,t)}getBeamDirection(e){return 1}getFlagAndBarPos(){return this.height-(this._hasTuplets?this.tupletSize/2:0)}calculateBeamYWithDirection(e,t,s){return this.getFlagAndBarPos()}shouldPaintFlag(e,t){return!(!super.shouldPaintFlag(e,t)||0!==e.graceType)&&this.drawBeamHelperAsFlags(t)}paintBeamingStem(e,t,s,i,a,r){var n=[];try{if(a<i){let e=a;a=i,i=e}o(n,Nl.beat(r,7,e));let l=[];this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(l=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice(),l.sort((e,t)=>e.topY-t.topY));let h=a;for(;h>i;){let e=i+8;if(!(l.length>0&&l[l.length-1].bottomY>e)){r.fillRect(s,e,this.smuflMetrics.stemThickness,h-e);break}{let i=l.pop();e=t+i.bottomY,r.fillRect(s,e,this.smuflMetrics.stemThickness,h-e),h=t+i.topY}}}catch(e){var h=e,d=!0}finally{l(n,h,d)}}};cu.StaffId="tab";var uu=class extends xl{constructor(){super(),this.showTimeSignature=null,this.showRests=null,this.showTiedNotes=null,this.hideOnPercussionTrack=!0}get staffId(){return cu.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}canCreate(e,t){return t.showTablature&&t.tuning.length>0&&super.canCreate(e,t)}create(e,t){let s=new cu(e,t);return null!==this.showRests&&(s.showRests=this.showRests),null!==this.showTimeSignature&&(s.showTimeSignature=this.showTimeSignature),null!==this.showTiedNotes&&(s.showTiedNotes=this.showTiedNotes),s}},pu={},mu=class{constructor(e,t){this.vertical=e,this.createLayout=t}},gu=class{constructor(e,t){this.supportsWorkers=e,this.createCanvas=t}},fu=class e{static get globalThis(){if(void 0===e._globalThis){try{e._globalThis=globalThis}catch{}typeof e._globalThis>"u"&&(e._globalThis=self),typeof e._globalThis>"u"&&(e._globalThis=global),typeof e._globalThis>"u"&&(e._globalThis=window),typeof e._globalThis>"u"&&(e._globalThis=Function("return this")())}return e._globalThis}static get isRunningInWorker(){return"WorkerGlobalScope"in e.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in e.globalThis}static throttle(t,s){let i=0;return()=>{e.globalThis.clearTimeout(i),i=e.globalThis.setTimeout(t,s)}}static _detectScriptFile(){if(!e.isRunningInWorker&&e.globalThis.ALPHATAB_ROOT){let t=e.globalThis.ALPHATAB_ROOT;return t=e.ensureFullUrl(t),t=e._appendScriptName(t),t}try{let e=pu.url;if(e&&-1===e.indexOf("file://"))return e}catch{}return"document"in e.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(t){if(!t)return"";if(!t.startsWith("http")&&!t.startsWith("https")&&!t.startsWith("file")){let s="",i=e.globalThis.location;if(s+=i.protocol?.toString(),s+="//",i.hostname&&(s+=i.hostname?.toString()),i.port&&(s+=":",s+=i.port?.toString()),!t.startsWith("/")){let e=i.pathname.split("/").slice(0,-1).join("/");e.length>0&&(e.startsWith("/")||(s+="/"),s+=e?.toString())}return t.startsWith("/")||(s+="/"),s+=t?.toString(),s}return t}static _appendScriptName(e){return e&&!e.endsWith(".js")&&(e.endsWith("/")||(e+="/"),e+="alphaTab.js"),e}static _detectFontDirectory(){if(!e.isRunningInWorker&&e.globalThis.ALPHATAB_FONT)return e.ensureFullUrl(e.globalThis.ALPHATAB_FONT);let t=e.scriptFile;if(t){let e=t.lastIndexOf("/");if(e>=0)return`${t.substr(0,e)}/font/`}return null}static _registerJQueryPlugin(){if(!e.isRunningInWorker&&e.globalThis&&"jQuery"in e.globalThis){let t=e.globalThis.jQuery,s=new Sl;t.fn.alphaTab=function(e){let t=Array.prototype.slice.call(arguments,1);return 1===this.length?s.exec(this[0],e,t):this.each((i,a)=>{s.exec(a,e,t)})},t.alphaTab={restore:Sl.restore},t.fn.alphaTab.fn=s}}static getRenderEngineFactory(t){return t&&e.renderEngines.has(t)?e.renderEngines.get(t):e.renderEngines.get("default")}static getLayoutEngineFactory(t){return t&&e.layoutEngines.has(t)?e.layoutEngines.get(t):e.layoutEngines.get(0)}static buildImporters(){return[new fi,new Ri,new Li,new Xi,new mi,new As]}static _createDefaultRenderEngines(){let t=new Map;return t.set("svg",new gu(!0,()=>new Bl)),t.set("default",t.get("svg")),t.set("skia",new gu(!1,()=>new wl)),e._createPlatformSpecificRenderEngines(t),t}static enableAlphaSkia(e,t){wl.enable(e,t)}static registerAlphaSkiaCustomFont(e){return wl.registerFont(e)}static _createPlatformSpecificRenderEngines(e){e.set("html5",new gu(!1,()=>new So))}static _createDefaultRenderers(){return[new fh(e._staffIdBeforeSlashAlways,[new yd,new Td,new Zh,new Fh,new _h,new zh,new _d,new xh,new Ph]),new qc,new fh(e._staffIdBeforeScoreAlways,[new Vh,new Th,new td,new ld,new xd]),new fh(e._staffIdBeforeScoreHideable,[new vd,new kd,new id(!0),new Pd,new ud,new Nd,new pd(!1),new qh,new Yh(2)],(e,t)=>t.showStandardNotation),new zc,new fh(e._staffIdBeforeNumberedAlways,[new Mh,new id(!1),new Ih,new Yh(1,(e,t)=>t.voice.bar.staff.showStandardNotation),new gd]),new cc,new fh(e._staffIdBeforeTabAlways,[new Qh]),new fh(e._staffIdBeforeTabHideable,[new kd,new Pd,new ud,new Nd,new pd(!0),new fd,new Rh,new $h(1),new $h(2),new $h(3),new $h(4),new $h(5),new $h(6),new jh,new vh,new Gh,new ad,new od,new rd,new qh,new Yh(2,(e,t)=>!t.voice.bar.staff.showStandardNotation)],(e,t)=>t.showTablature),new uu,new fh(e._staffIdBeforeEndAlways,[new Yh(1,(e,t)=>!t.voice.bar.staff.showStandardNotation)])]}static _createDefaultStaveProfiles(){let t=new Map,s=e._createDefaultRenderers();t.set(0,s),t.set(1,s);let i=new Set([e._staffIdBeforeSlashAlways,e._staffIdBeforeScoreAlways,e._staffIdBeforeNumberedAlways,e._staffIdBeforeTabAlways,Gc.StaffId,e._staffIdBeforeEndAlways]);t.set(2,s.filter(e=>i.has(e.staffId)));let a=new Set([e._staffIdBeforeSlashAlways,e._staffIdBeforeScoreAlways,e._staffIdBeforeNumberedAlways,e._staffIdBeforeTabAlways,cu.StaffId,e._staffIdBeforeEndAlways]);return t.set(3,e._createDefaultRenderers().filter(e=>{if(e instanceof uu){let t=e;t.showTimeSignature=!0,t.showRests=!0,t.showTiedNotes=!0}return a.has(e.staffId)})),t.set(4,e._createDefaultRenderers().filter(e=>{if(e instanceof uu){let t=e;t.showTimeSignature=!1,t.showRests=!1,t.showTiedNotes=!1}return a.has(e.staffId)})),t}static _createDefaultLayoutEngines(){let e=new Map;return e.set(0,new mu(!0,e=>new Ld(e))),e.set(1,new mu(!1,e=>new Ed(e))),e}static initializeMain(t,s){e.isRunningInWorker||e.isRunningInAudioWorklet||((0===e.webPlatform||2===e.webPlatform)&&(e._registerJQueryPlugin(),e.highDpiFactor=window.devicePixelRatio),e.createWebWorker=t,e.createAudioWorklet=s)}static get alphaTabWorker(){return e.globalThis.Worker}static get alphaTabUrl(){return e.globalThis.URL}static initializeWorker(){if(!e.isRunningInWorker)throw new u(0,"Not running in worker, cannot run worker initialization");_o.init(),mo.init(),e.createWebWorker=e=>{throw new u(0,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!e.isRunningInAudioWorklet)throw new u(0,"Not running in audio worklet, cannot run worklet initialization");ia.init()}static _detectWebPack(){try{if("function"==typeof __webpack_require__)return!0}catch{}return!1}static _detectVite(){try{if("string"==typeof __BASE__)return!0}catch{}return!1}static _detectWebPlatform(){if(!(typeof e.globalThis.Window<"u"&&e.globalThis instanceof e.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call(typeof process<"u"?process:0))return 1}catch{}try{let e=pu.url;if(e&&"string"==typeof e&&!e.startsWith("file://"))return 2}catch{}return 0}static printEnvironmentInfo(t=!0){let s=t?e=>{re.log.debug("VersionInfo",e)}:e=>{re.debug("VersionInfo",e)};g.print(s),s(`High DPI: ${e.highDpiFactor}`),e._printPlatformInfo(s)}static _printPlatformInfo(t){t(`Platform: ${go[e.webPlatform]}`),t(`WebPack: ${e.isWebPackBundled}`),t(`Vite: ${e.isViteBundled}`),1!==e.webPlatform&&(t(`Browser: ${navigator.userAgent}`),t(`Window Size: ${window.outerWidth}x${window.outerHeight}`),t(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(t){if(!t)return t;if("object"==typeof t){let s=t.__v_raw;if(s)return e.prepareForPostMessage(s)}return t}static quoteJsonString(e){return JSON.stringify(e)}};fu._staffIdBeforeSlashAlways="before-slash-always",fu._staffIdBeforeScoreAlways="before-score-always",fu._staffIdBeforeScoreHideable="before-score-hideable",fu._staffIdBeforeNumberedAlways="before-numbered-always",fu._staffIdBeforeTabAlways="before-tab-always",fu._staffIdBeforeTabHideable="before-tab-hideable",fu._staffIdBeforeEndAlways="before-end-always",fu.highDpiFactor=1,fu._globalThis=void 0,fu.webPlatform=fu._detectWebPlatform(),fu.isWebPackBundled=fu._detectWebPack(),fu.isViteBundled=fu._detectVite(),fu.scriptFile=fu._detectScriptFile(),fu.fontDirectory=fu._detectFontDirectory(),fu.renderEngines=fu._createDefaultRenderEngines(),fu.layoutEngines=fu._createDefaultLayoutEngines(),fu.staveProfiles=fu._createDefaultStaveProfiles();var bu=fu,yu=(e=>(e[e.EmbeddedOpenType=0]="EmbeddedOpenType",e[e.Woff=1]="Woff",e[e.Woff2=2]="Woff2",e[e.OpenType=3]="OpenType",e[e.TrueType=4]="TrueType",e[e.Svg=5]="Svg",e))(yu||{}),_u=class{constructor(){this.scriptFile=null,this.fontDirectory=null,this.smuflFontSources=null,this.file=null,this.tex=!1,this.tracks=null,this.enableLazyLoading=!0,this.engine="default",this.logLevel=2,this.useWorkers=!0,this.includeNoteBounds=!1,this.scriptFile=bu.scriptFile,this.fontDirectory=bu.fontDirectory}static buildDefaultSmuflFontSources(e){let t=new Map,s=e??"";return t.set(2,`${s}Bravura.woff2`),t.set(1,`${s}Bravura.woff`),t.set(3,`${s}Bravura.otf`),t}},Su={};n(Su,{AlphaTexErrorWithDiagnostics:()=>Ds,AlphaTexImporter:()=>As,ScoreImporter:()=>Ls,ScoreLoader:()=>il,UnsupportedFormatError:()=>Cs,alphaTex:()=>ku});var ku={};n(ku,{AlphaTexAccidentalMode:()=>Ct,AlphaTexDiagnosticBag:()=>Et,AlphaTexDiagnosticCode:()=>Mt,AlphaTexDiagnosticsSeverity:()=>Nt,AlphaTexLexer:()=>Ms,AlphaTexNodeType:()=>Vt,AlphaTexParser:()=>Es,AlphaTexStaffNoteKind:()=>Ft});var wu={};n(wu,{ByteBuffer:()=>Fs,IOHelper:()=>Ps});var Tu={};n(Tu,{AlphaTexExporter:()=>Pu,Gp7Exporter:()=>Xu,ScoreExporter:()=>Bu});var Bu=class{init(e,t){this.data=e,this.settings=t}export(e,t=null){let s=Fs.withCapacity(1024);return this.init(s,t??new On),this.writeScore(e),s.toArray()}},xu=class{constructor(){this.tex="",this.isStartOfLine=!0,this.indentString="",this.currentIndent=0}indent(){this.indentString.length>0&&this.currentIndent++}outdent(){this.indentString.length>0&&this.currentIndent--}_preWrite(){if(this.isStartOfLine&&this.indentString.length>0)for(let e=0;e<this.currentIndent;e++)this.tex+=this.indentString;this.isStartOfLine=!1}write(e){this._preWrite(),this.tex+=e,this.isStartOfLine=!1}writeString(e){this._preWrite(),this.tex+=bu.quoteJsonString(e)}writeLine(e){this._preWrite(),void 0!==e&&(this.tex+=e),this.indentString.length>0?this.tex+="\n":this.tex.endsWith(" ")||(this.tex+=" "),this.isStartOfLine=!0}},vu=class{constructor(e){this._comments=!1,this._trackIndex=0,this._staffIndex=0,this._voiceIndex=0;let t=new xu;this._comments=e.exporter.comments,t.indentString=e.exporter.indent>0?" ".repeat(e.exporter.indent):"",this._writer=t}get tex(){return this._writer.tex}writeScoreNode(e){this._writeComments(e.leadingComments);for(let t of e.bars)this._writeBar(t);this._writeComments(e.trailingComments)}_writeBar(e){this._writeComments(e.leadingComments),this._writeMetaDataList(e.metaData),this._writer.indent();for(let t of e.beats)this._writeBeat(t);this._writer.outdent(),this._writeComments(e.trailingComments),this._writeToken(e.pipe,!0)}_writeBeat(e){this._writeComments(e.leadingComments),e.durationChange&&this._writeDurationChange(e.durationChange),e.rest?this._writeValue(e.rest):e.notes&&this._writeNotes(e.notes),this._writeToken(e.durationDot,!1),this._writeValue(e.durationValue),this._writeToken(e.beatMultiplier,!1),this._writeValue(e.beatMultiplierValue),e.beatEffects&&this._writeProperties(e.beatEffects,!1),this._writeComments(e.trailingComments),this._writer.writeLine()}_writeNotes(e){this._writeComments(e.leadingComments),this._writeToken(e.openParenthesis,!1);let t=!0;for(let s of e.notes)t||this._writer.write(" "),this._writeNote(s),t=!1;this._writeToken(e.closeParenthesis,!1),this._writeComments(e.trailingComments)}_writeNote(e){this._writeComments(e.leadingComments),this._writeValue(e.noteValue),this._writeToken(e.noteStringDot,!1),this._writeValue(e.noteString),e.noteEffects&&this._writeProperties(e.noteEffects,!1),this._writeComments(e.trailingComments)}_writeDurationChange(e){this._writeComments(e.leadingComments),this._writeToken(e.colon,!1),this._writeValue(e.value),e.properties&&(this._writer.write(" "),this._writeProperties(e.properties,!1)),this._writeComments(e.trailingComments),this._writer.write(" ")}_writeMetaDataList(e){for(let t of e)this._writeMetaData(t)}_writeMetaData(e){switch(e.tag.tag.text){case"track":this._trackIndex>0&&this._writer.outdent();break;case"staff":this._staffIndex>0&&this._writer.outdent();break;case"voice":this._voiceIndex>0&&this._writer.outdent()}this._writeComments(e.leadingComments),this._writeToken(e.tag.prefix,!1),this._writeValue(e.tag.tag);let t=!0;switch(e.propertiesBeforeValues?(e.properties&&(this._writer.write(" "),this._writeProperties(e.properties,!1)),e.values&&(this._writer.write(" "),this._writeValues(e.values))):(e.values&&(this._writer.write(" "),this._writeValues(e.values)),e.properties&&(this._writer.write(" "),this._writeProperties(e.properties,!0),t=!1)),e.trailingComments&&(this._writer.write(" "),this._writeComments(e.trailingComments)),e.tag.tag.text){case"track":this._trackIndex++,this._staffIndex=0,this._voiceIndex=0,this._writer.indent();break;case"staff":this._staffIndex++,this._voiceIndex=0,this._writer.indent();break;case"voice":this._voiceIndex++,this._writer.indent()}t&&this._writer.writeLine()}_writeProperties(e,t){this._writeComments(e.leadingComments),this._writeToken(e.openBrace,t),t&&this._writer.indent();let s=!0;for(let i of e.properties)!s&&!t&&this._writer.write(" "),this._writeProperty(i),s=!1,t&&this._writer.writeLine();t&&this._writer.outdent(),this._writeToken(e.closeBrace,t),this._writeComments(e.trailingComments)}_writeProperty(e){this._writeComments(e.leadingComments),this._writeValue(e.property),e.values&&(this._writer.write(" "),this._writeValues(e.values)),this._writeComments(e.trailingComments)}_writeValues(e){this._writeComments(e.leadingComments),this._writeToken(e.openParenthesis,!1);let t=!0;for(let s of e.values)t||this._writer.write(" "),this._writeValue(s),t=!1;this._writeToken(e.closeParenthesis,!1),this._writeComments(e.trailingComments)}_writeValue(e){if(e){switch(this._writeComments(e.leadingComments),e.nodeType){case 10:this._writer.write(e.text);break;case 13:this._writeValues(e);break;case 16:this._writer.write(e.value.toString());break;case 17:this._writer.writeString(e.text)}this._writeComments(e.trailingComments)}}_writeToken(e,t){if(e){switch(this._writeComments(e.leadingComments),e.nodeType){case 0:this._writer.write(".");break;case 1:this._writer.write("\\");break;case 2:this._writer.write("\\\\");break;case 3:this._writer.write("|");break;case 4:this._writer.write("{");break;case 5:this._writer.write("}");break;case 6:this._writer.write("(");break;case 7:this._writer.write(")");break;case 8:this._writer.write(":");break;case 9:this._writer.write("*")}this._writeComments(e.trailingComments),t&&this._writer.writeLine()}}_writeComments(e){if(this._comments&&e)for(let t of e){let e=t.text;e.startsWith(" ")||(e=` ${e}`),t.multiLine?(e.endsWith(" ")||(e+=" "),this._writer.write(`/*${e}*/`)):this._writer.writeLine(`//${e}`)}}},Pu=class extends Bu{constructor(){super(...arguments),this._handler=ws.instance}get name(){return"alphaTex"}exportToString(e,t=null){return this.settings=t??new On,this.scoreToAlphaTexString(e)}writeScore(e){let t=Ps.stringToBytes(this.scoreToAlphaTexString(e));this.data.write(t,0,t.length)}scoreToAlphaTexString(e){let t=new vu(this.settings);return t.writeScoreNode(this._score(e)),t.tex}_score(e){let t={nodeType:18,bars:[]};for(let s of e.tracks)this._track(t,s);return 0===t.bars.length?t.bars.push({nodeType:19,metaData:this._handler.buildScoreMetaDataNodes(e),beats:[]}):t.bars[0].metaData=this._handler.buildScoreMetaDataNodes(e).concat(t.bars[0].metaData),t.bars.push({nodeType:19,metaData:this._handler.buildSyncPointNodes(e),beats:[]}),t}_track(e,t){for(let s of t.staves)this._staff(e,s)}_staff(e,t){let s=Math.max(...t.filledVoices)+1;if(0===t.bars.length){let s={nodeType:19,metaData:this._handler.buildBarMetaDataNodes(t,void 0,0,!1),beats:[],pipe:void 0};e.bars.push(s)}else for(let i=0;i<s;i++)this._voice(e,i,t,s>1)}_voice(e,t,s,i){for(let a of s.bars)this._bar(e,a,t,i)}_bar(e,t,s,i){var a;let r={nodeType:19,metaData:this._handler.buildBarMetaDataNodes(t.staff,t,s,i),beats:[],pipe:void 0};if(t.isEmpty)r.trailingComments=[{multiLine:!1,text:`Bar ${t.index+1} / Voice ${s+1} no contents`}];else{let e=t.voices[s];if(e.isEmpty)r.trailingComments=[{multiLine:!1,text:`Bar ${t.index+1} / Voice ${s+1} no contents`}];else{for(let t of e.beats)r.beats.push(this._beat(t));r.beats.length>0&&((a=r.beats[0]).leadingComments??(a.leadingComments=[]),r.beats[0].leadingComments.unshift({multiLine:!1,text:`Bar ${t.index+1} / Voice ${s+1} contents`}))}}t.index<t.staff.bars.length-1&&(r.pipe={nodeType:3}),e.bars.push(r)}_beat(e){let t={nodeType:20,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0};return e.isRest?t.rest={nodeType:10,text:"r"}:t.notes=this._notes(e.notes),t.durationDot={nodeType:0},t.durationValue={nodeType:16,value:e.duration},t.beatEffects=this._beatEffects(e),t}_beatEffects(e){let t=this._handler.buildBeatEffects(e);return t.length>0?{nodeType:14,openBrace:{nodeType:4},properties:t,closeBrace:{nodeType:5}}:void 0}_notes(e){let t={nodeType:22,openParenthesis:void 0,notes:[],closeParenthesis:void 0};(0===e.length||e.length>1)&&(t.openParenthesis={nodeType:6},t.closeParenthesis={nodeType:7});for(let s of e)t.notes.push(this._note(s));return t}_note(e){let t={nodeType:23,noteValue:{nodeType:10,text:""}};if(e.isPercussion)t.noteValue={nodeType:17,text:et.getArticulationName(e)};else if(e.isPiano)t.noteValue={nodeType:10,text:Zt.getTextForTuning(e.realValueWithoutHarmonic,!0)};else{if(!e.isStringed)throw new Error("What kind of note");{t.noteValue={nodeType:16,value:e.fret},t.noteStringDot={nodeType:0};let s=e.beat.voice.bar.staff.tuning.length-e.string+1;t.noteString={nodeType:16,value:s}}}return t.noteEffects=this._noteEffects(e),t}_noteEffects(e){let t=this._handler.buildNoteEffects(e);return t.length>0?{nodeType:14,openBrace:{nodeType:4},properties:t,closeBrace:{nodeType:5}}:void 0}},Nu=class{constructor(e,t,s=null){if(this.icon=10,this.icon=e,this.instrumentSetName=t,s)this.instrumentSetType=s;else{let e=t.split(" ");e[0]=e[0].substr(0,1).toLowerCase()+e[0].substr(1),this.instrumentSetType=e.join("")}}},Mu=class e{constructor(){this._rhythmIdLookup=new Map}writeXml(e){let t=new Zs;return this._rhythmIdLookup=new Map,this._writeDom(t,e),t.toFormattedString("",!0)}_writeDom(e,t){let s=e.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";let i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";let a=s.addElement("Encoding");a.addElement("EncodingDescription").innerText="GP8";let r=new Js;r.nodeType=6,r.value=`Written by alphaTab ${g.version} (${g.commit})`,a.addChild(r),this._writeScoreNode(s,t),this._writeMasterTrackNode(s,t),this._writeBackingTrackNode(s,t),this._writeAudioTracksNode(s,t),this._writeTracksNode(s,t),this._writeMasterBarsNode(s,t),this._writeAssets(s,t);let n=s.addElement("Bars"),o=s.addElement("Voices"),l=s.addElement("Beats"),h=s.addElement("Notes"),d=s.addElement("Rhythms");for(let e of t.tracks)for(let t of e.staves)for(let e of t.bars){this._writeBarNode(n,e);for(let t of e.voices){this._writeVoiceNode(o,t);for(let e of t.beats){this._writeBeatNode(l,e,d);for(let t of e.notes)this._writeNoteNode(h,t)}}}}_writeAssets(e,t){if(!t.backingTrack?.rawAudioFile)return;let s=e.addElement("Assets").addElement("Asset");s.attributes.set("id",this._backingTrackAssetId),this.backingTrackAssetFileName="Content/Assets/backing-track",s.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}_writeBackingTrackNode(e,t){if(!t.backingTrack?.rawAudioFile)return;let s=e.addElement("BackingTrack");this._backingTrackAssetId="0",s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText="0";let i=s.addElement("ChannelStrip");i.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",i.addElement("YouTubeVideoUrl").innerText="",i.addElement("Filter").innerText="6",i.addElement("FramesPerPixel").innerText="400";let a=void 0!==this._backingTrackFramePadding?this._backingTrackFramePadding:0;s.addElement("FramePadding").innerText=`${a}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}_writeNoteNode(e,t){let s=e.addElement("Note");s.attributes.set("id",t.id.toString()),this._writeNoteProperties(s,t),t.isGhost&&(s.addElement("AntiAccent").innerText="normal"),t.isLetRing&&s.addElement("LetRing"),t.isTrill&&(s.addElement("Trill").innerText=t.trillValue.toString());let i=0;switch(t.isStaccato&&(i|=1),t.accentuated){case 1:i|=8;break;case 2:i|=4;break;case 3:i|=16}if(i>0&&(s.addElement("Accent").innerText=i.toString()),t.isTieOrigin||t.isTieDestination){let e=s.addElement("Tie");e.attributes.set("origin",t.isTieOrigin?"true":"false"),e.attributes.set("destination",t.isTieDestination?"true":"false")}switch(t.vibrato){case 1:s.addElement("Vibrato").innerText="Slight";break;case 2:s.addElement("Vibrato").innerText="Wide"}if(t.isFingering){switch(t.leftHandFinger){case 0:s.addElement("LeftFingering").innerText="P";break;case 1:s.addElement("LeftFingering").innerText="I";break;case 2:s.addElement("LeftFingering").innerText="M";break;case 3:s.addElement("LeftFingering").innerText="A";break;case 4:s.addElement("LeftFingering").innerText="C"}switch(t.rightHandFinger){case 0:s.addElement("RightFingering").innerText="P";break;case 1:s.addElement("RightFingering").innerText="I";break;case 2:s.addElement("RightFingering").innerText="M";break;case 3:s.addElement("RightFingering").innerText="A";break;case 4:s.addElement("RightFingering").innerText="C"}}t.percussionArticulation>=0?s.addElement("InstrumentArticulation").innerText=t.percussionArticulation.toString():s.addElement("InstrumentArticulation").innerText="0",0!==t.ornament&&(s.addElement("Ornament").innerText=tt[t.ornament])}_writeNoteProperties(e,t){let s=e.addElement("Properties");if(this._writeConcertPitch(s,t),this._writeTransposedPitch(s,t),t.isStringed&&(this._writeSimplePropertyNode(s,"String","String",(t.string-1).toString()),this._writeSimplePropertyNode(s,"Fret","Fret",t.fret.toString()),this._writeSimplePropertyNode(s,"Midi","Number",t.realValue.toString()),t.showStringNumber&&this._writeSimplePropertyNode(s,"ShowStringNumber","Enable",null)),t.isPiano&&(this._writeSimplePropertyNode(s,"Octave","Number",t.octave.toString()),this._writeSimplePropertyNode(s,"Tone","Step",t.tone.toString()),this._writeSimplePropertyNode(s,"Midi","Number",t.realValue.toString())),t.beat.tap&&this._writeSimplePropertyNode(s,"Tapped","Enable",null),0!==t.harmonicType){switch(t.harmonicType){case 1:this._writeSimplePropertyNode(s,"HarmonicType","HType","Natural");break;case 2:this._writeSimplePropertyNode(s,"HarmonicType","HType","Artificial");break;case 3:this._writeSimplePropertyNode(s,"HarmonicType","HType","Pinch");break;case 4:this._writeSimplePropertyNode(s,"HarmonicType","HType","Tap");break;case 5:this._writeSimplePropertyNode(s,"HarmonicType","HType","Semi");break;case 6:this._writeSimplePropertyNode(s,"HarmonicType","HType","Feedback")}0!==t.harmonicValue&&this._writeSimplePropertyNode(s,"HarmonicFret","HFret",t.harmonicValue.toString())}t.isDead&&this._writeSimplePropertyNode(s,"Muted","Enable",null),t.isPalmMute&&this._writeSimplePropertyNode(s,"PalmMuted","Enable",null),t.hasBend&&this._writeBend(s,t),t.isHammerPullOrigin&&this._writeSimplePropertyNode(s,"HopoOrigin","Enable",null),t.isHammerPullDestination&&this._writeSimplePropertyNode(s,"HopoDestination","Enable",null),t.isLeftHandTapped&&this._writeSimplePropertyNode(s,"LeftHandTapped","Enable",null);let i=0;switch(t.slideInType){case 2:i|=32;break;case 1:i|=16}switch(t.slideOutType){case 1:i|=1;break;case 2:i|=2;break;case 4:i|=4;break;case 3:i|=8;break;case 5:i|=64;break;case 6:i|=128}i>0&&this._writeSimplePropertyNode(s,"Slide","Flags",i.toString())}_writeTransposedPitch(e,t){t.isPercussion?this._writePitch(e,"ConcertPitch","C","-1",""):this._writePitchForValue(e,"TransposedPitch",t.displayValueWithoutBend,t.accidentalMode,t.beat.voice.bar.keySignature)}_writeConcertPitch(e,t){t.isPercussion?this._writePitch(e,"ConcertPitch","C","-1",""):this._writePitchForValue(e,"ConcertPitch",t.realValueWithoutHarmonic,t.accidentalMode,t.beat.voice.bar.keySignature)}_writePitchForValue(t,s,i,a,r){let n=0,o=0,l="",h="",d=()=>{switch(n=i%12,o=i/12|0,l=e._defaultSteps[n],qe.computeAccidental(r,0,i,!1)){case 0:case 1:h="";break;case 2:h="#";break;case 3:h="b";break;case 7:h="x";break;case 8:h="bb"}};switch(d(),a){case 0:break;case 1:case 2:h="";break;case 3:h="#";break;case 4:"#"===h&&(i-=2,d()),h="x";break;case 5:"#"===h&&(i+=1,d()),h="b";break;case 6:"#"===h&&(i+=2,d()),h="bb"}this._writePitch(t,s,l,o.toString(),h)}_writePitch(e,t,s,i,a){let r=e.addElement("Property");r.attributes.set("name",t);let n=r.addElement("Pitch");n.addElement("Step").innerText=s,n.addElement("Accidental").innerText=a,n.addElement("Octave").innerText=i}_writeBend(e,t){t.hasBend&&t.bendPoints.length<=4&&this._writeStandardBend(e,t.bendPoints)}_writeStandardBend(e,t){this._writeSimplePropertyNode(e,"Bended","Enable",null);let s,i,a=t[0],r=t[t.length-1];switch(t.length){case 4:s=t[1],i=t[2];break;case 3:s=t[1],i=t[1];break;default:s=new T((a.offset+r.offset)/2,(a.value+r.value)/2),i=s}this._writeSimplePropertyNode(e,"BendDestinationOffset","Float",this._toBendOffset(r.offset).toString()),this._writeSimplePropertyNode(e,"BendDestinationValue","Float",this._toBendValue(r.value).toString()),this._writeSimplePropertyNode(e,"BendMiddleOffset1","Float",this._toBendOffset(s.offset).toString()),this._writeSimplePropertyNode(e,"BendMiddleOffset2","Float",this._toBendOffset(i.offset).toString()),this._writeSimplePropertyNode(e,"BendMiddleValue","Float",this._toBendValue(s.value).toString()),this._writeSimplePropertyNode(e,"BendOriginOffset","Float",this._toBendOffset(a.offset).toString()),this._writeSimplePropertyNode(e,"BendOriginValue","Float",this._toBendValue(a.value).toString())}_toBendValue(e){return 25*e}_toBendOffset(e){return e/T.MaxPosition*100}_writeBeatNode(e,t,s){let i=e.addElement("Beat");if(i.attributes.set("id",t.id.toString()),i.addElement("Dynamic").innerText=f[t.dynamics],0!==t.fade&&(i.addElement("Fadding").innerText=pt[t.fade]),t.isTremolo)switch(t.tremoloSpeed){case 8:i.addElement("Tremolo").innerText="1/2";break;case 16:i.addElement("Tremolo").innerText="1/4";break;case 32:i.addElement("Tremolo").innerText="1/8"}switch(t.hasChord&&i.addElement("Chord").setCData(t.chordId),0!==t.crescendo&&(i.addElement("Hairpin").innerText=D[t.crescendo]),t.brushType){case 3:i.addElement("Arpeggio").innerText="Up";break;case 4:i.addElement("Arpeggio").innerText="Down"}switch(t.text&&i.addElement("FreeText").setCData(t.text),t.graceType){case 1:case 2:i.addElement("GraceNotes").innerText=A[t.graceType]}if(2!==t.ottava&&(i.addElement("Ottavia").innerText=H[t.ottava].substr(1)),t.hasWhammyBar&&this._writeWhammyNode(i,t),t.isLegatoOrigin||t.isLegatoDestination){let e=i.addElement("Legato");e.attributes.set("origin",t.isLegatoOrigin?"true":"false"),e.attributes.set("destination",t.isLegatoDestination?"true":"false")}if(this._writeRhythm(i,t,s),null!==t.preferredBeamDirection)switch(t.preferredBeamDirection){case 0:i.addElement("TransposedPitchStemOrientation").innerText="Upward",i.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case 1:i.addElement("TransposedPitchStemOrientation").innerText="Downward",i.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}i.addElement("ConcertPitchStemOrientation").innerText="Undefined",t.slashed&&i.addElement("Slashed"),t.deadSlapped&&i.addElement("DeadSlapped"),t.notes.length>0&&(i.addElement("Notes").innerText=t.notes.map(e=>e.id).join(" ")),0!==t.golpe&&(i.addElement("Golpe").innerText=ut[t.golpe]),0!==t.wahPedal&&(i.addElement("Wah").innerText=mt[t.wahPedal]),t.showTimer&&(i.addElement("Timer").innerText=(t.timer??0).toString()),this._writeBeatProperties(i,t),this._writeBeatXProperties(i,t),t.lyrics&&t.lyrics.length>0&&this._writeBeatLyrics(i,t.lyrics)}_writeBeatLyrics(e,t){let s=e.addElement("Lyrics");for(let e of t)s.addElement("Line").setCData(e)}_writeBeatXProperties(e,t){let s=e.addElement("XProperties");switch(t.brushDuration>0&&this._writeSimpleXPropertyNode(s,"687935489","Int",t.brushDuration.toString()),t.beamingMode){case 1:this._writeSimpleXPropertyNode(s,"1124204546","Int","2");break;case 2:this._writeSimpleXPropertyNode(s,"1124204546","Int","1");break;case 3:this._writeSimpleXPropertyNode(s,"1124204552","Int","1")}}_writeBeatProperties(e,t){let s=e.addElement("Properties");switch(t.brushType){case 1:this._writeSimplePropertyNode(s,"Brush","Direction","Up");break;case 2:this._writeSimplePropertyNode(s,"Brush","Direction","Down")}switch(t.pickStroke){case 1:this._writeSimplePropertyNode(s,"PickStroke","Direction","Up");break;case 2:this._writeSimplePropertyNode(s,"PickStroke","Direction","Down")}switch(t.slap&&this._writeSimplePropertyNode(s,"Slapped","Enable",null),t.pop&&this._writeSimplePropertyNode(s,"Popped","Enable",null),t.vibrato){case 2:this._writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Wide");break;case 1:this._writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Slight")}if(t.isBarre)switch(this._writeSimplePropertyNode(s,"BarreFret","Fret",t.barreFret.toString()),t.barreShape){case 1:this._writeSimplePropertyNode(s,"BarreString","String","0");break;case 2:this._writeSimplePropertyNode(s,"BarreString","String","1")}if(0!==t.rasgueado){let e="";switch(t.rasgueado){case 1:e="ii_1";break;case 2:e="mi_1";break;case 3:e="mii_1";break;case 4:e="mii_2";break;case 5:e="pmp_1";break;case 6:e="pmp_2";break;case 7:e="pei_1";break;case 8:e="pei_2";break;case 9:e="pai_1";break;case 10:e="pai_2";break;case 11:e="ami_1";break;case 12:e="ami_2";break;case 13:e="ppp_1";break;case 14:e="amii_1";break;case 15:e="amip_1";break;case 16:e="eami_1";break;case 17:e="eamii_1";break;case 18:e="peami_1"}this._writeSimplePropertyNode(s,"Rasgueado","Rasgueado",e)}}_writeRhythm(e,t,s){let i,a=`${t.duration}_${t.dots}_${t.tupletNumerator}_${t.tupletDenominator}';`;if(this._rhythmIdLookup.has(a))i=this._rhythmIdLookup.get(a);else{i=this._rhythmIdLookup.size.toString(),this._rhythmIdLookup.set(a,i);let e=s.addElement("Rhythm");if(e.attributes.set("id",i),t.hasTuplet){let s=e.addElement("PrimaryTuplet");s.attributes.set("num",t.tupletNumerator.toString()),s.attributes.set("den",t.tupletDenominator.toString())}t.dots>0&&e.addElement("AugmentationDot").attributes.set("count",t.dots.toString());let r="Quarter";switch(t.duration){case-4:r="Long";break;case-2:r="DoubleWhole";break;case 1:r="Whole";break;case 2:r="Half";break;case 4:r="Quarter";break;case 8:r="Eighth";break;case 16:r="16th";break;case 32:r="32nd";break;case 64:r="64th";break;case 128:r="128th";break;case 256:r="256th"}e.addElement("NoteValue").innerText=r}e.addElement("Rhythm").attributes.set("ref",i)}_writeWhammyNode(e,t){t.hasWhammyBar&&t.whammyBarPoints.length<=4&&this._writeStandardWhammy(e,t.whammyBarPoints)}_writeStandardWhammy(e,t){let s,i,a=e.addElement("Whammy"),r=t[0],n=t[t.length-1];switch(t.length){case 4:s=t[1],i=t[2];break;case 3:s=t[1],i=t[1];break;default:s=new T((r.offset+n.offset)/2,(r.value+n.value)/2),i=s}a.attributes.set("destinationOffset",this._toBendOffset(n.offset).toString()),a.attributes.set("destinationValue",this._toBendValue(n.value).toString()),a.attributes.set("middleOffset1",this._toBendOffset(s.offset).toString()),a.attributes.set("middleOffset2",this._toBendOffset(i.offset).toString()),a.attributes.set("middleValue",this._toBendValue(s.value).toString()),a.attributes.set("originOffset",this._toBendOffset(r.offset).toString()),a.attributes.set("originValue",this._toBendValue(r.value).toString())}_writeScoreNode(e,t){let s=e.addElement("Score");s.addElement("Title").setCData(t.title),s.addElement("SubTitle").setCData(t.subTitle),s.addElement("Artist").setCData(t.artist),s.addElement("Album").setCData(t.album),s.addElement("Words").setCData(t.words),s.addElement("Music").setCData(t.music),s.addElement("WordsAndMusic").setCData(t.words===t.music?t.words:""),s.addElement("Copyright").setCData(t.copyright),s.addElement("Tabber").setCData(t.tab),s.addElement("Instructions").setCData(t.instructions),s.addElement("Notices").setCData(t.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(t.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(t.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}_writeMasterTrackNode(t,s){let i=t.addElement("MasterTrack");i.addElement("Tracks").innerText=s.tracks.map(e=>e.index).join(" ");let a=i.addElement("Automations");if(s.masterBars.length>0&&s.masterBars[0].isAnacrusis&&i.addElement("Anacrusis"),0===s.masterBars[0].tempoAutomations.length){let e=a.addElement("Automation");e.addElement("Type").innerText="Tempo",e.addElement("Linear").innerText="false",e.addElement("Bar").innerText="0",e.addElement("Position").innerText="0",e.addElement("Visible").innerText="true",e.addElement("Value").innerText=`${s.tempo} 2`,s.tempoLabel&&(e.addElement("Text").innerText=s.tempoLabel)}let r=s.masterBars[0].syncPoints?s.masterBars[0].syncPoints.find(e=>0===e.ratioPosition&&0===e.syncPointValue.barOccurence):void 0,n=r?r.syncPointValue.millisecondOffset:0;this._backingTrackFramePadding=n/1e3*e._sampleRate*-1|0;let o=new K(()=>Ao.buildModifiedTempoLookup(s));for(let t of s.masterBars){for(let e of t.tempoAutomations){let s=a.addElement("Automation");s.addElement("Type").innerText="Tempo",s.addElement("Linear").innerText=e.isLinear?"true":"false",s.addElement("Bar").innerText=t.index.toString(),s.addElement("Position").innerText=e.ratioPosition.toString(),s.addElement("Visible").innerText=e.isVisible?"true":"false",s.addElement("Value").innerText=`${e.value} 2`,e.text&&(s.addElement("Text").innerText=e.text)}if(t.syncPoints)for(let i of t.syncPoints){let r=a.addElement("Automation");r.addElement("Type").innerText="SyncPoint",r.addElement("Linear").innerText="false",r.addElement("Bar").innerText=t.index.toString(),r.addElement("Position").innerText=i.ratioPosition.toString(),r.addElement("Visible").innerText=i.isVisible?"true":"false";let l=r.addElement("Value");l.addElement("BarIndex").innerText=t.index.toString(),l.addElement("BarOccurrence").innerText=i.syncPointValue.barOccurence.toString(),l.addElement("ModifiedTempo").innerText=o.value.get(i).syncBpm.toString(),l.addElement("OriginalTempo").innerText=s.tempo.toString();let h=(i.syncPointValue.millisecondOffset-n)/1e3*e._sampleRate;h=Math.floor(h+.5),l.addElement("FrameOffset").innerText=h.toString()}}}_writeAudioTracksNode(e,t){e.addElement("AudioTracks")}_writeTracksNode(e,t){let s=e.addElement("Tracks");for(let e of t.tracks)this._writeTrackNode(s,e)}_writeTrackNode(t,s){let i=t.addElement("Track");i.attributes.set("id",s.index.toString()),i.addElement("Name").setCData(s.name),i.addElement("ShortName").setCData(s.shortName),i.addElement("Color").innerText=`${s.color.r} ${s.color.g} ${s.color.b}`,i.addElement("SystemsDefautLayout").innerText=s.defaultSystemsLayout.toString(),i.addElement("SystemsLayout").innerText=s.systemsLayout.join(" "),i.addElement("AutoBrush"),i.addElement("PalmMute").innerText="0",i.addElement("PlayingStyle").innerText=Ut.isGuitar(s.playbackInfo.program)?"StringedPick":"Default",i.addElement("UseOneChannelPerString"),i.addElement("IconId").innerText=e._getIconId(s.playbackInfo).toString(),this._writeInstrumentSetNode(i,s),this._writeTransposeNode(i,s),this._writeRseNode(i,s),i.addElement("ForcedSound").innerText="-1",this._writeMidiConnectionNode(i,s),s.playbackInfo.isSolo?i.addElement("PlaybackState").innerText="Solo":s.playbackInfo.isMute?i.addElement("PlaybackState").innerText="Mute":i.addElement("PlaybackState").innerText="Default",i.addElement("AudioEngineState").innerText="MIDI",this._writeLyricsNode(i,s),this._writeStavesNode(i,s),this._writeSoundsAndAutomations(i,s)}static _getIconId(t){return 9===t.primaryChannel?e._drumKitProgramInfo.icon:e._midiProgramInfoLookup.has(t.program)?e._midiProgramInfoLookup.get(t.program).icon:1}_writeSoundAndAutomation(e,t,s,i,a,r,n,o,l=0){let h=e.addElement("Sound");h.addElement("Name").setCData(s),h.addElement("Label").setCData(s),h.addElement("Path").setCData(i),h.addElement("Role").setCData(a);let d=h.addElement("MIDI"),c=Ut.bankToLsbMsb(o);d.addElement("LSB").innerText=c[0].toString(),d.addElement("MSB").innerText=c[1].toString(),d.addElement("Program").innerText=n.toString();let u=t.addElement("Automation");u.addElement("Type").innerText="Sound",u.addElement("Linear").innerText="false",u.addElement("Bar").innerText=r.toString(),u.addElement("Position").innerText=l.toString(),u.addElement("Visible").innerText="true",u.addElement("Value").setCData(`${i};${s};${a}`)}_writeSoundsAndAutomations(e,t){let s=e.addElement("Sounds"),i=e.addElement("Automations");if(t.staves.length>0&&t.staves[0].bars.length>0){let e=`Track_${t.index}_Initial`,a=`Midi/${t.playbackInfo.program}`,r="Factory",n=!1,o=t.playbackInfo.bank;for(let l of t.staves)for(let h of l.bars)for(let l of h.voices)for(let d of l.beats){let l=d.getAutomation(2),c=0===h.index&&0===d.index,u=d.getAutomation(4);if(u&&(o=u.value),l){let u=c?e:`ProgramChange_${d.id}`,p=c?a:`Midi/${l.value}`,m=c?r:"User";!c&&!n&&(this._writeSoundAndAutomation(s,i,e,a,r,t.staves[0].bars[0].index,t.playbackInfo.program,t.playbackInfo.bank),n=!0),this._writeSoundAndAutomation(s,i,u,p,m,h.index,l.value,o,l.ratioPosition),c&&(n=!0)}}}for(let e of t.staves)for(let t of e.bars)for(let e of t.sustainPedals)if(1!==e.pedalType){let s=i.addElement("Automation");switch(s.addElement("Type").innerText="SustainPedal",s.addElement("Linear").innerText="false",s.addElement("Bar").innerText=t.index.toString(),s.addElement("Position").innerText=e.ratioPosition.toString(),s.addElement("Visible").innerText="true",e.pedalType){case 0:s.addElement("Value").innerText="0 1";break;case 2:s.addElement("Value").innerText="0 3"}}}_writeMidiConnectionNode(e,t){let s=e.addElement("MidiConnection");s.addElement("Port").innerText=t.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=t.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=t.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}_writeRseNode(e,t){let s=e.addElement("RSE").addElement("ChannelStrip");s.attributes.set("version","E56"),s.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${t.playbackInfo.balance/16} ${t.playbackInfo.volume/16} 0.5 0.5 0.5`}_writeStavesNode(e,t){let s=e.addElement("Staves");for(let e of t.staves)this._writeStaffNode(s,e)}_writeStaffNode(e,t){let s=e.addElement("Staff").addElement("Properties");if(this._writeSimplePropertyNode(s,"CapoFret","Fret",t.capo.toString()),this._writeSimplePropertyNode(s,"FretCount","Fret","24"),t.tuning.length>0){let e=s.addElement("Property");switch(e.attributes.set("name","Tuning"),e.addElement("Pitches").innerText=t.tuning.slice().reverse().join(" "),e.addElement("Label").setCData(t.tuningName),e.addElement("LabelVisible").innerText=t.tuningName?"true":"false",e.addElement("Flat"),t.tuning.length){case 3:e.addElement("Instrument").innerText="Shamisen";break;case 4:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":42===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Cello":43===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Contrabass":40===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Violin":41===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Viola":e.addElement("Instrument").innerText="Bass";break;case 5:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":e.addElement("Instrument").innerText="Bass";break;case 6:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":t.track.playbackInfo.program<=39?e.addElement("Instrument").innerText="Bass":e.addElement("Instrument").innerText="Guitar";break;case 7:t.track.playbackInfo.program<=39?e.addElement("Instrument").innerText="Bass":e.addElement("Instrument").innerText="Guitar";break;default:e.addElement("Instrument").innerText="Guitar"}}this._writeSimplePropertyNode(s,"PartialCapoFret","Fret","0"),this._writeSimplePropertyNode(s,"PartialCapoStringFlags","Bitset",t.tuning.map(e=>"0").join("")),this._writeSimplePropertyNode(s,"TuningFlat","Enable",null),this._writeDiagramCollection(s,t,"DiagramCollection"),this._writeDiagramCollection(s,t,"DiagramWorkingSet")}_writeDiagramCollection(e,t,s){let i=e.addElement("Property");i.attributes.set("name",s);let a=i.addElement("Items"),r=t.chords;if(r)for(let[e,t]of r){let s=a.addElement("Item");s.attributes.set("id",e),s.attributes.set("name",t.name);let i=s.addElement("Diagram");i.attributes.set("stringCount",t.strings.length.toString()),i.attributes.set("fretCount","5"),i.attributes.set("baseFret",(t.firstFret-1).toString()),i.attributes.set("barStates",t.strings.map(e=>"1").join(" "));let r=[],n=new Map;for(let e=0;e<t.strings.length;e++){let s=t.strings[e];if(-1!==s){let a=i.addElement("Fret"),o=t.strings.length-1-e;a.attributes.set("string",o.toString()),a.attributes.set("fret",(s-t.firstFret+1).toString()),n.has(s)||(n.set(s,[]),r.push(s)),n.get(s).push(o)}}r.sort();let o=i.addElement("Fingering");if(t.barreFrets.length>0){let e=[4,3,2,1];for(let s of r){let i=n.get(s);if(i.length>1&&t.barreFrets.indexOf(s)>=0){let a=e.length>0?e.pop():1;for(let e of i){let i=o.addElement("Position");switch(a){case 4:i.attributes.set("finger","Pinky");break;case 3:i.attributes.set("finger","Ring");break;case 2:i.attributes.set("finger","Middle");break;case 1:i.attributes.set("finger","Index")}i.attributes.set("fret",(s-t.firstFret+1).toString()),i.attributes.set("string",e.toString())}}}}let l=i.addElement("Property");l.attributes.set("name","ShowName"),l.attributes.set("type","bool"),l.attributes.set("value",t.showName?"true":"false");let h=i.addElement("Property");h.attributes.set("name","ShowDiagram"),h.attributes.set("type","bool"),h.attributes.set("value",t.showDiagram?"true":"false");let d=i.addElement("Property");d.attributes.set("name","ShowFingering"),d.attributes.set("type","bool"),d.attributes.set("value",t.showFingering?"true":"false");let c=i.addElement("Chord"),u=c.addElement("KeyNote");u.attributes.set("step","C"),u.attributes.set("accidental","Natural");let p=c.addElement("BassNote");p.attributes.set("step","C"),p.attributes.set("accidental","Natural");let m=c.addElement("Degree");m.attributes.set("interval","Third"),m.attributes.set("alteration","Major"),m.attributes.set("omitted","false");let g=c.addElement("Degree");g.attributes.set("interval","Fifth"),g.attributes.set("alteration","Perfect"),g.attributes.set("omitted","false")}}_writeSimplePropertyNode(e,t,s,i){let a=e.addElement("Property");a.attributes.set("name",t);let r=a.addElement(s);return null!==i&&(r.innerText=i),a}_writeSimpleXPropertyNode(e,t,s,i){let a=e.addElement("XProperty");a.attributes.set("id",t);let r=a.addElement(s);return null!==i&&(r.innerText=i),a}_writeLyricsNode(e,t){let s=e.addElement("Lyrics");s.attributes.set("dispatched","true");let i=[];for(let e of t.staves[0].bars)for(let t of e.voices)if(!t.isEmpty)for(let s of t.beats)if(s.lyrics)for(let t=0;t<s.lyrics.length;t++){for(;t>=i.length;){let t=new jt;t.startBar=e.index,t.text="[Empty]",i.push(t)}let a=i[t];a.text="[Empty]"===a.text?s.lyrics[t]:`${a.text} ${s.lyrics[t].split(" ").join("+")}`}for(let e=0;e<i.length;e++){let t=s.addElement("Line");t.addElement("Text").setCData(i[e].text),t.addElement("Offset").innerText=i[e].startBar.toString()}}_writeTransposeNode(e,t){let s=e.addElement("Transpose"),i=Math.floor(t.staves[0].displayTranspositionPitch/12),a=t.staves[0].displayTranspositionPitch-12*i;s.addElement("Chromatic").innerText=a.toString(),s.addElement("Octave").innerText=i.toString()}_writeInstrumentSetNode(t,s){let i=t.addElement("InstrumentSet"),a=s.staves[0];if(i.addElement("LineCount").innerText=a.standardNotationLineCount.toString(),s.percussionArticulations.length>0||a.isPercussion){let t=s.percussionArticulations.length>0?s.percussionArticulations:Array.from(et.instrumentArticulations.values());i.addElement("Name").innerText=e._drumKitProgramInfo.instrumentSetName,i.addElement("Type").innerText=e._drumKitProgramInfo.instrumentSetType;let a="",r="",n=new Js,o=new Map,l=i.addElement("Elements");for(let e of t){if(!a||a!==e.elementType){let t=l.addElement("Element"),s=e.elementType;if(o.has(s)){let e=o.get(s);s+=` ${e}`,o.set(s,e+1)}else o.set(s,1);r=s,t.addElement("Name").innerText=s,t.addElement("Type").innerText=e.elementType,n=t.addElement("Articulations")}let t=n.addElement("Articulation");switch(t.addElement("Name").innerText=`${r} ${n.childNodes.length}`,t.addElement("StaffLine").innerText=e.staffLine.toString(),t.addElement("Noteheads").innerText=[this._mapMusicSymbol(e.noteHeadDefault),this._mapMusicSymbol(e.noteHeadHalf),this._mapMusicSymbol(e.noteHeadWhole)].join(" "),e.techniqueSymbolPlacement){case 2:t.addElement("TechniquePlacement").innerText="below";break;case 3:t.addElement("TechniquePlacement").innerText="outside";break;case 1:t.addElement("TechniquePlacement").innerText="inside";break;case 0:t.addElement("TechniquePlacement").innerText="above"}t.addElement("TechniqueSymbol").innerText=this._mapMusicSymbol(e.techniqueSymbol),t.addElement("InputMidiNumbers").innerText="",t.addElement("OutputMidiNumber").innerText=e.outputMidiNumber.toString()}}else{let t=e._midiProgramInfoLookup.has(s.playbackInfo.program)?e._midiProgramInfoLookup.get(s.playbackInfo.program):e._midiProgramInfoLookup.get(0);i.addElement("Name").innerText=t.instrumentSetName,i.addElement("Type").innerText=t.instrumentSetType;let a=i.addElement("Elements").addElement("Element");a.addElement("Pitched").innerText="Pitched",a.addElement("Type").innerText="pitched",a.addElement("SoundbankName").innerText="";let r=a.addElement("Articulations").addElement("Articulation");r.addElement("Name").innerText="",r.addElement("StaffLine").innerText="0",r.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",r.addElement("TechniquePlacement").innerText="outside",r.addElement("TechniqueSymbol").innerText="",r.addElement("InputMidiNumbers").innerText="",r.addElement("OutputRSESound").innerText="",r.addElement("OutputMidiNumber").innerText="0"}}_mapMusicSymbol(e){if(-1===e)return"";let t=Ue[e];return t.substring(0,1).toLowerCase()+t.substring(1)}_writeMasterBarsNode(e,t){let s=e.addElement("MasterBars");for(let e of t.masterBars)this._writeMasterBarNode(s,e)}_writeMasterBarNode(e,t){let s=e.addElement("MasterBar"),i=s.addElement("Key"),a=t.score.tracks[0].staves[0].bars[t.index].keySignature,r=t.score.tracks[0].staves[0].bars[t.index].keySignatureType,n=qe.flooredDivision(t.score.tracks[0].staves[0].displayTranspositionPitch,12);a=qe.transposeKey(a,-n),i.addElement("AccidentalCount").innerText=a.toString(),i.addElement("Mode").innerText=fe[r],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${t.timeSignatureNumerator}/${t.timeSignatureDenominator}`,t.isFreeTime&&s.addElement("FreeTime");let o=[];for(let e of t.score.tracks)for(let s of e.staves)o.push(s.bars[t.index].id.toString());if(s.addElement("Bars").innerText=o.join(" "),t.isDoubleBar&&s.addElement("DoubleBar"),t.isSectionStart){let e=s.addElement("Section");e.addElement("Letter").setCData(t.section.marker),e.addElement("Text").setCData(t.section.text)}if(t.isRepeatStart||t.isRepeatEnd){let e=s.addElement("Repeat");e.attributes.set("start",t.isRepeatStart?"true":"false"),e.attributes.set("end",t.isRepeatEnd?"true":"false"),t.isRepeatEnd&&e.attributes.set("count",t.repeatCount.toString())}if(t.alternateEndings>0){let e=t.alternateEndings,i=[],a=0;for(;e>0;)1==(e>>a&1)&&(i.push(a+1),e&=~(1<<a)),a++;s.addElement("AlternateEndings").innerText=i.join(" ")}if(0!==t.tripletFeel&&(s.addElement("TripletFeel").innerText=Ve[t.tripletFeel]),t.directions&&t.directions.size>0){let e=s.addElement("Directions");for(let s of t.directions)switch(s){case 0:e.addElement("Target").innerText="Fine";break;case 1:e.addElement("Target").innerText="Segno";break;case 2:e.addElement("Target").innerText="SegnoSegno";break;case 3:e.addElement("Target").innerText="Coda";break;case 4:e.addElement("Target").innerText="DoubleCoda";break;case 5:e.addElement("Jump").innerText="DaCapo";break;case 6:e.addElement("Jump").innerText="DaCapoAlCoda";break;case 7:e.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case 8:e.addElement("Jump").innerText="DaCapoAlFine";break;case 9:e.addElement("Jump").innerText="DaSegno";break;case 10:e.addElement("Jump").innerText="DaSegnoAlCoda";break;case 11:e.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case 12:e.addElement("Jump").innerText="DaSegnoAlFine";break;case 13:e.addElement("Jump").innerText="DaSegnoSegno";break;case 14:e.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case 15:e.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case 16:e.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case 17:e.addElement("Jump").innerText="DaCoda";break;case 18:e.addElement("Jump").innerText="DaDoubleCoda"}}this._writeFermatas(s,t)}_writeFermatas(e,t){let s=t.fermata?.size??0;if(0!==s&&s>0){let s=e.addElement("Fermatas");for(let[e,i]of t.fermata)this._writeFermata(s,e,i)}}_writeFermata(e,t,s){let i=-1,a=1;if(t>0)for(;a<10&&(i=t/_.QuarterTime*a,i!==Math.floor(i));)i=-1,a++;else i=0,a=1;if(-1===i)return;let r=e.addElement("Fermata");r.addElement("Type").innerText=It[s.type],r.addElement("Length").innerText=s.length.toString(),r.addElement("Offset").innerText=`${i}/${a}`}_writeBarNode(e,t){let s=e.addElement("Bar");s.attributes.set("id",t.id.toString()),s.addElement("Voices").innerText=t.voices.map(e=>e.isEmpty?"-1":e.id.toString()).join(" "),s.addElement("Clef").innerText=pe[t.clef],2!==t.clefOttava&&(s.addElement("Ottavia").innerText=H[t.clefOttava].substr(1)),0!==t.simileMark&&(s.addElement("SimileMark").innerText=me[t.simileMark])}_writeVoiceNode(e,t){if(t.isEmpty)return;let s=e.addElement("Voice");s.attributes.set("id",t.id.toString()),s.addElement("Beats").innerText=t.beats.map(e=>e.id).join(" ")}};Mu._sampleRate=44100,Mu._midiProgramInfoLookup=new Map([[0,new Nu(10,"Acoustic Piano")],[1,new Nu(10,"Acoustic Piano")],[2,new Nu(10,"Electric Piano")],[3,new Nu(10,"Acoustic Piano")],[4,new Nu(10,"Electric Piano")],[5,new Nu(10,"Electric Piano")],[6,new Nu(10,"Harpsichord")],[7,new Nu(10,"Harpsichord")],[8,new Nu(17,"Celesta")],[9,new Nu(17,"Vibraphone")],[10,new Nu(17,"Vibraphone")],[11,new Nu(17,"Vibraphone")],[12,new Nu(17,"Xylophone")],[13,new Nu(17,"Xylophone")],[14,new Nu(17,"Vibraphone")],[15,new Nu(8,"Banjo")],[16,new Nu(10,"Electric Organ")],[17,new Nu(10,"Electric Organ")],[18,new Nu(10,"Electric Organ")],[19,new Nu(10,"Electric Organ")],[20,new Nu(10,"Electric Organ")],[21,new Nu(10,"Electric Organ")],[22,new Nu(15,"Recorder")],[23,new Nu(10,"Electric Organ")],[24,new Nu(23,"Nylon Guitar")],[25,new Nu(1,"Steel Guitar")],[26,new Nu(1,"Electric Guitar")],[27,new Nu(4,"Electric Guitar")],[28,new Nu(4,"Electric Guitar")],[29,new Nu(4,"Electric Guitar")],[30,new Nu(1,"Electric Guitar")],[31,new Nu(1,"Electric Guitar")],[32,new Nu(5,"Acoustic Bass")],[33,new Nu(5,"Electric Bass")],[34,new Nu(5,"Electric Bass")],[35,new Nu(5,"Acoustic Bass")],[36,new Nu(5,"Electric Bass")],[37,new Nu(5,"Electric Bass")],[38,new Nu(12,"Synth Bass")],[39,new Nu(12,"Synth Bass")],[40,new Nu(11,"Violin")],[41,new Nu(11,"Viola")],[42,new Nu(11,"Cello")],[43,new Nu(11,"Contrabass")],[44,new Nu(11,"Violin")],[45,new Nu(11,"Violin")],[46,new Nu(10,"Harp")],[47,new Nu(20,"Timpani")],[48,new Nu(11,"Violin")],[49,new Nu(11,"Violin")],[50,new Nu(11,"Violin")],[51,new Nu(11,"Violin")],[52,new Nu(16,"Voice")],[53,new Nu(16,"Voice")],[54,new Nu(16,"Voice")],[55,new Nu(12,"Pad Synthesizer")],[56,new Nu(13,"Trumpet")],[57,new Nu(13,"Trombone")],[58,new Nu(13,"Tuba")],[59,new Nu(13,"Trumpet")],[60,new Nu(13,"French Horn")],[61,new Nu(13,"Trumpet")],[62,new Nu(13,"Trumpet")],[63,new Nu(13,"Trumpet")],[64,new Nu(14,"Saxophone")],[65,new Nu(14,"Saxophone")],[66,new Nu(14,"Saxophone")],[67,new Nu(14,"Saxophone")],[68,new Nu(14,"Oboe")],[69,new Nu(14,"English Horn")],[70,new Nu(14,"Bassoon")],[71,new Nu(14,"Clarinet")],[72,new Nu(14,"Piccolo")],[73,new Nu(15,"Flute")],[74,new Nu(15,"Recorder")],[75,new Nu(15,"Flute")],[76,new Nu(15,"Recorder")],[77,new Nu(15,"Flute")],[78,new Nu(15,"Recorder")],[79,new Nu(15,"Flute")],[80,new Nu(12,"Lead Synthesizer")],[81,new Nu(12,"Lead Synthesizer")],[82,new Nu(12,"Lead Synthesizer")],[83,new Nu(12,"Lead Synthesizer")],[84,new Nu(12,"Lead Synthesizer")],[85,new Nu(12,"Lead Synthesizer")],[86,new Nu(12,"Lead Synthesizer")],[87,new Nu(12,"Lead Synthesizer")],[88,new Nu(12,"Pad Synthesizer")],[89,new Nu(12,"Pad Synthesizer")],[90,new Nu(12,"Pad Synthesizer")],[91,new Nu(12,"Pad Synthesizer")],[92,new Nu(12,"Pad Synthesizer")],[93,new Nu(12,"Pad Synthesizer")],[94,new Nu(12,"Pad Synthesizer")],[95,new Nu(12,"Pad Synthesizer")],[96,new Nu(21,"Pad Synthesizer")],[97,new Nu(21,"Pad Synthesizer")],[98,new Nu(21,"Pad Synthesizer")],[99,new Nu(21,"Pad Synthesizer")],[100,new Nu(21,"Lead Synthesizer")],[101,new Nu(21,"Lead Synthesizer")],[102,new Nu(21,"Lead Synthesizer")],[103,new Nu(21,"Trumpet")],[104,new Nu(4,"Banjo")],[105,new Nu(8,"Banjo")],[106,new Nu(7,"Ukulele")],[107,new Nu(8,"Banjo")],[108,new Nu(17,"Xylophone")],[109,new Nu(14,"Bassoon")],[110,new Nu(11,"Violin")],[111,new Nu(15,"Flute")],[112,new Nu(17,"Xylophone")],[113,new Nu(19,"Celesta")],[114,new Nu(17,"Vibraphone")],[115,new Nu(19,"Xylophone")],[116,new Nu(20,"Xylophone")],[117,new Nu(20,"Xylophone")],[118,new Nu(20,"Xylophone")],[119,new Nu(19,"Celesta")],[120,new Nu(21,"Steel Guitar")],[121,new Nu(21,"Recorder")],[122,new Nu(21,"Recorder")],[123,new Nu(21,"Recorder")],[124,new Nu(21,"Recorder")],[125,new Nu(21,"Recorder")],[126,new Nu(21,"Recorder")],[127,new Nu(21,"Timpani")]]),Mu._drumKitProgramInfo=new Nu(18,"Drums","drumKit"),Mu._defaultSteps=["C","C","D","D","E","F","F","G","G","A","A","B"];var Eu=Mu,Lu=class e{constructor(){this._checkValue=e._crcInit,this.reset()}static _buildCrc32Lookup(){let e=new Uint32Array(256);for(let t=0;t<e.length;t++){let s=t;for(let e=0;e<8;e++)s=1&~s?s>>>1:s>>>1^3988292384;e[t]=s}return e}get value(){return~this._checkValue}update(t,s,i){for(let a=0;a<i;a++)this._checkValue=e._crc32Lookup[255&(this._checkValue^t[s+a])]^this._checkValue>>>8}reset(){this._checkValue=e._crcInit}};Lu._crc32Lookup=Lu._buildCrc32Lookup(),Lu._crcInit=4294967295;var Cu=Lu,Fu=class{};Fu.maxWbits=15,Fu.wsize=1<<Fu.maxWbits,Fu.wmask=Fu.wsize-1,Fu.minMatch=3,Fu.maxMatch=258,Fu.defaultMemLevel=8,Fu.pendingBufSize=1<<Fu.defaultMemLevel+8,Fu.hashBits=Fu.defaultMemLevel+7,Fu.hashSize=1<<Fu.hashBits,Fu.hashShift=(Fu.hashBits+Fu.minMatch-1)/Fu.minMatch,Fu.hashMask=Fu.hashSize-1,Fu.minLookahead=Fu.maxMatch+Fu.minMatch+1,Fu.maxDist=Fu.wsize-Fu.minLookahead;var Du=Fu,Iu=class e{constructor(e,t,s,i){this.length=null,this.numCodes=0,this._codes=null,this._huffman=e,this.minNumCodes=s,this._maxLength=i,this.freqs=new Int16Array(t),this._bitLengthCounts=new Int32Array(i)}reset(){for(let e=0;e<this.freqs.length;e++)this.freqs[e]=0;this._codes=null,this.length=null}buildTree(){let e=this.freqs.length,t=new Int32Array(e),s=0,i=0;for(let a=0;a<e;a++){let e=this.freqs[a];if(0!==e){let r=s++;for(;r>0;){let s=Math.floor((r-1)/2);if(!(this.freqs[t[s]]>e))break;t[r]=t[s],r=s}t[r]=a,i=a}}for(;s<2;){let e=i<2?++i:0;t[s++]=e}this.numCodes=Math.max(i+1,this.minNumCodes);let a=s,r=new Int32Array(4*s-2),n=new Int32Array(2*s-1),o=a;for(let e=0;e<s;e++){let s=t[e];r[2*e]=s,r[2*e+1]=-1,n[e]=this.freqs[s]<<8,t[e]=e}do{let e=t[0],i=t[--s],a=0,l=1;for(;l<s;)l+1<s&&n[t[l]]>n[t[l+1]]&&l++,t[a]=t[l],a=l,l=2*l+1;let h=n[i];for(;(l=a,a>0)&&(a=Math.floor((l-1)/2),n[t[a]]>h);)t[l]=t[a];t[l]=i;let d=t[0];i=o++,r[2*i]=e,r[2*i+1]=d;let c=Math.min(255&n[e],255&n[d]);for(h=n[e]+n[d]-c+1,n[i]=h,a=0,l=1;l<s;)l+1<s&&n[t[l]]>n[t[l+1]]&&l++,t[a]=t[l],a=l,l=2*a+1;for(;(l=a,l>0)&&(a=Math.floor((l-1)/2),n[t[a]]>h);)t[l]=t[a];t[l]=i}while(s>1);this._buildLength(r)}_buildLength(e){this.length=new Uint8Array(this.freqs.length);let t=Math.floor(e.length/2),s=Math.floor((t+1)/2),i=0;for(let e=0;e<this._maxLength;e++)this._bitLengthCounts[e]=0;let a=new Int32Array(t);a[t-1]=0;for(let s=t-1;s>=0;s--)if(-1!==e[2*s+1]){let t=a[s]+1;t>this._maxLength&&(t=this._maxLength,i++),a[e[2*s]]=t,a[e[2*s+1]]=t}else{let t=a[s];this._bitLengthCounts[t-1]++,this.length[e[2*s]]=a[s]}if(0===i)return;let r=this._maxLength-1;do{for(;0===this._bitLengthCounts[--r];);do{this._bitLengthCounts[r]--,this._bitLengthCounts[++r]++,i-=1<<this._maxLength-1-r}while(i>0&&r<this._maxLength-1)}while(i>0);this._bitLengthCounts[this._maxLength-1]+=i,this._bitLengthCounts[this._maxLength-2]-=i;let n=2*s;for(let t=this._maxLength;0!==t;t--){let s=this._bitLengthCounts[t-1];for(;s>0;){let i=2*e[n++];-1===e[i+1]&&(this.length[e[i]]=t,s--)}}}getEncodedLength(){let e=0;for(let t=0;t<this.freqs.length;t++)e+=this.freqs[t]*this.length[t];return e}calcBLFreq(t){let s,i,a,r=-1,n=0;for(;n<this.numCodes;){a=1;let o=this.length[n];for(0===o?(s=138,i=3):(s=6,i=3,r!==o&&(t.freqs[o]++,a=0)),r=o,n++;n<this.numCodes&&r===this.length[n]&&(n++,!(++a>=s)););a<i?t.freqs[r]+=a:0!==r?t.freqs[e._repeat3To6]++:a<=10?t.freqs[e._repeat3To10]++:t.freqs[e._repeat11To138]++}}setStaticCodes(e,t){this._codes=e,this.length=t}buildCodes(){let e=new Int32Array(this._maxLength),t=0;this._codes=new Int16Array(this.freqs.length);for(let s=0;s<this._maxLength;s++)e[s]=t,t+=this._bitLengthCounts[s]<<15-s;for(let t=0;t<this.numCodes;t++){let s=this.length[t];s>0&&(this._codes[t]=Ou.bitReverse(e[s-1]),e[s-1]+=1<<16-s)}}writeTree(t){let s,i,a,r=-1,n=0;for(;n<this.numCodes;){a=1;let o=this.length[n];for(0===o?(s=138,i=3):(s=6,i=3,r!==o&&(t.writeSymbol(o),a=0)),r=o,n++;n<this.numCodes&&r===this.length[n]&&(n++,!(++a>=s)););if(a<i)for(;a-- >0;)t.writeSymbol(r);else 0!==r?(t.writeSymbol(e._repeat3To6),this._huffman.pending.writeBits(a-3,2)):a<=10?(t.writeSymbol(e._repeat3To10),this._huffman.pending.writeBits(a-3,3)):(t.writeSymbol(e._repeat11To138),this._huffman.pending.writeBits(a-11,7))}}writeSymbol(e){this._huffman.pending.writeBits(65535&this._codes[e],this.length[e])}};Iu._repeat3To6=16,Iu._repeat3To10=17,Iu._repeat11To138=18;var Au=Iu,Ru=class e{constructor(t){this._lastLit=0,this._extraBits=0,this.pending=t,this._literalTree=new Au(this,e._literalNum,257,15),this._distTree=new Au(this,e._distNum,1,15),this._blTree=new Au(this,e._bitLenNum,4,7),this._dBuf=new Int16Array(e._bufSize),this._lBuf=new Uint8Array(e._bufSize)}static staticInit(){let t=0;for(;t<144;)e._staticLCodes[t]=e.bitReverse(48+t<<8),e._staticLLength[t++]=8;for(;t<256;)e._staticLCodes[t]=e.bitReverse(256+t<<7),e._staticLLength[t++]=9;for(;t<280;)e._staticLCodes[t]=e.bitReverse(-256+t<<9),e._staticLLength[t++]=7;for(;t<e._literalNum;)e._staticLCodes[t]=e.bitReverse(-88+t<<8),e._staticLLength[t++]=8;for(t=0;t<e._distNum;t++)e._staticDCodes[t]=e.bitReverse(t<<11),e._staticDLength[t]=5}static bitReverse(t){return e._bit4Reverse[15&t]<<12|e._bit4Reverse[t>>4&15]<<8|e._bit4Reverse[t>>8&15]<<4|e._bit4Reverse[t>>12]}isFull(){return this._lastLit>=e._bufSize}reset(){this._lastLit=0,this._extraBits=0,this._literalTree.reset(),this._distTree.reset(),this._blTree.reset()}flushStoredBlock(t,s,i,a){this.pending.writeBits((e.storedBlock<<1)+(a?1:0),3),this.pending.alignToByte(),this.pending.writeShort(i),this.pending.writeShort(~i),this.pending.writeBlock(t,s,i),this.reset()}flushBlock(t,s,i,a){this._literalTree.freqs[e._eofSymbol]++,this._literalTree.buildTree(),this._distTree.buildTree(),this._literalTree.calcBLFreq(this._blTree),this._distTree.calcBLFreq(this._blTree),this._blTree.buildTree();let r=4;for(let t=18;t>r;t--)this._blTree.length[e._blOrder[t]]>0&&(r=t+1);let n=14+3*r+this._blTree.getEncodedLength()+this._literalTree.getEncodedLength()+this._distTree.getEncodedLength()+this._extraBits,o=this._extraBits;for(let t=0;t<e._literalNum;t++)o+=this._literalTree.freqs[t]*e._staticLLength[t];for(let t=0;t<e._distNum;t++)o+=this._distTree.freqs[t]*e._staticDLength[t];n>=o&&(n=o),s>=0&&i+4<n>>3?this.flushStoredBlock(t,s,i,a):n===o?(this.pending.writeBits((e.staticTrees<<1)+(a?1:0),3),this._literalTree.setStaticCodes(e._staticLCodes,e._staticLLength),this._distTree.setStaticCodes(e._staticDCodes,e._staticDLength),this.compressBlock(),this.reset()):(this.pending.writeBits((e.dynTrees<<1)+(a?1:0),3),this.sendAllTrees(r),this.compressBlock(),this.reset())}sendAllTrees(t){this._blTree.buildCodes(),this._literalTree.buildCodes(),this._distTree.buildCodes(),this.pending.writeBits(this._literalTree.numCodes-257,5),this.pending.writeBits(this._distTree.numCodes-1,5),this.pending.writeBits(t-4,4);for(let s=0;s<t;s++)this.pending.writeBits(this._blTree.length[e._blOrder[s]],3);this._literalTree.writeTree(this._blTree),this._distTree.writeTree(this._blTree)}compressBlock(){for(let t=0;t<this._lastLit;t++){let s=255&this._lBuf[t],i=this._dBuf[t];if(0!==i--){let t=e._lCode(s);this._literalTree.writeSymbol(t);let a=Math.floor((t-261)/4);a>0&&a<=5&&this.pending.writeBits(s&(1<<a)-1,a);let r=e._dCode(i);this._distTree.writeSymbol(r),a=Math.floor(r/2)-1,a>0&&this.pending.writeBits(i&(1<<a)-1,a)}else this._literalTree.writeSymbol(s)}this._literalTree.writeSymbol(e._eofSymbol)}tallyDist(t,s){this._dBuf[this._lastLit]=t,this._lBuf[this._lastLit++]=s-3;let i=e._lCode(s-3);this._literalTree.freqs[i]++,i>=265&&i<285&&(this._extraBits+=Math.floor((i-261)/4));let a=e._dCode(t-1);return this._distTree.freqs[a]++,a>=4&&(this._extraBits+=Math.floor(a/2)-1),this.isFull()}tallyLit(e){return this._dBuf[this._lastLit]=0,this._lBuf[this._lastLit++]=e,this._literalTree.freqs[e]++,this.isFull()}static _lCode(e){if(255===e)return 285;let t=257;for(;e>=8;)t+=4,e>>=1;return t+e}static _dCode(e){let t=0;for(;e>=4;)t+=2,e>>=1;return t+e}};Ru._bufSize=1<<Du.defaultMemLevel+6,Ru._literalNum=286,Ru.storedBlock=0,Ru.staticTrees=1,Ru.dynTrees=2,Ru._distNum=30,Ru._staticLCodes=new Int16Array(Ru._literalNum),Ru._staticLLength=new Uint8Array(Ru._literalNum),Ru._staticDCodes=new Int16Array(Ru._distNum),Ru._staticDLength=new Uint8Array(Ru._distNum),Ru._blOrder=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Ru._bit4Reverse=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]),Ru._bitLenNum=19,Ru._eofSymbol=256;var Ou=Ru;Ou.staticInit();var Vu=class e{constructor(e){this._maxChain=128,this._niceLength=128,this._goodLength=8,this._insertHashIndex=0,this._lookahead=0,this._inputBuf=null,this._inputOff=0,this._inputEnd=0,this._prevAvailable=!1,this._matchStart=0,this._matchLen=0,this._pending=e,this._huffman=new Ou(e),this.inputCrc=new Cu,this._window=new Uint8Array(2*Du.wsize),this._head=new Int16Array(Du.hashSize),this._prev=new Int16Array(Du.wsize),this._blockStart=1,this._strstart=1}reset(){this._huffman.reset(),this.inputCrc.reset(),this._blockStart=1,this._strstart=1,this._lookahead=0,this._prevAvailable=!1,this._matchLen=Du.minMatch-1;for(let e=0;e<Du.hashSize;e++)this._head[e]=0;for(let e=0;e<Du.wsize;e++)this._prev[e]=0}_updateHash(){this._insertHashIndex=this._window[this._strstart]<<Du.hashShift^this._window[this._strstart+1]}needsInput(){return this._inputEnd===this._inputOff}setInput(e,t,s){let i=t+s;this._inputBuf=e,this._inputOff=t,this._inputEnd=i}deflate(e,t){let s;do{this.fillWindow();let i=e&&this._inputOff===this._inputEnd;s=this._deflateSlow(i,t)}while(this._pending.isFlushed&&s);return s}_deflateSlow(t,s){if(this._lookahead<Du.minLookahead&&!t)return!1;for(;this._lookahead>=Du.minLookahead||t;){if(0===this._lookahead)return this._prevAvailable&&this._huffman.tallyLit(255&this._window[this._strstart-1]),this._prevAvailable=!1,this._huffman.flushBlock(this._window,this._blockStart,this._strstart-this._blockStart,s),this._blockStart=this._strstart,!1;this._strstart>=2*Du.wsize-Du.minLookahead&&this._slideWindow();let t=this._matchStart,i=this._matchLen;if(this._lookahead>=Du.minMatch){let t=this._insertString();0!==t&&this._strstart-t<=Du.maxDist&&this._findLongestMatch(t)&&this._matchLen===Du.minMatch&&this._strstart-this._matchStart>e._tooFar&&(this._matchLen=Du.minMatch-1)}if(i>=Du.minMatch&&this._matchLen<=i){this._huffman.tallyDist(this._strstart-1-t,i),i-=2;do{this._strstart++,this._lookahead--,this._lookahead>=Du.minMatch&&this._insertString()}while(--i>0);this._strstart++,this._lookahead--,this._prevAvailable=!1,this._matchLen=Du.minMatch-1}else this._prevAvailable&&this._huffman.tallyLit(255&this._window[this._strstart-1]),this._prevAvailable=!0,this._strstart++,this._lookahead--;if(this._huffman.isFull()){let e=this._strstart-this._blockStart;this._prevAvailable&&e--;let t=s&&0===this._lookahead&&!this._prevAvailable;return this._huffman.flushBlock(this._window,this._blockStart,e,t),this._blockStart+=e,!t}}return!0}_findLongestMatch(e){let t,s=this._strstart,i=s+Math.min(Du.maxMatch,this._lookahead)-1,a=Math.max(s-Du.maxDist,0),r=this._window,n=this._prev,o=this._maxChain,l=Math.min(this._niceLength,this._lookahead);if(this._matchLen=Math.max(this._matchLen,Du.minMatch-1),s+this._matchLen>i)return!1;let h=r[s+this._matchLen-1],d=r[s+this._matchLen];this._matchLen>=this._goodLength&&(o>>=2);do{if(t=e,s=this._strstart,r[t+this._matchLen]===d&&r[t+this._matchLen-1]===h&&r[t]===r[s]&&r[++t]===r[++s]){switch((i-s)%8){case 1:if(r[++s]===r[++t])break;break;case 2:if(r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 3:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 4:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 5:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 6:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 7:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break}if(r[s]===r[t])do{if(s===i){++s,++t;break}}while(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]);if(s-this._strstart>this._matchLen){if(this._matchStart=e,this._matchLen=s-this._strstart,this._matchLen>=l)break;h=r[s-1],d=r[s]}e=65535&n[e&Du.wmask]}}while(e>a&&0!==--o);return this._matchLen>=Du.minMatch}_insertString(){let e=(this._insertHashIndex<<Du.hashShift^this._window[this._strstart+(Du.minMatch-1)])&Du.hashMask,t=this._head[e];return this._prev[this._strstart&Du.wmask]=t,this._head[e]=this._strstart,this._insertHashIndex=e,65535&t}fillWindow(){if(this._strstart>=Du.wsize+Du.maxDist&&this._slideWindow(),this._lookahead<Du.minLookahead&&this._inputOff<this._inputEnd){let e=2*Du.wsize-this._lookahead-this._strstart;e>this._inputEnd-this._inputOff&&(e=this._inputEnd-this._inputOff),this._window.set(this._inputBuf.subarray(this._inputOff,this._inputOff+e),this._strstart+this._lookahead),this.inputCrc.update(this._inputBuf,this._inputOff,e),this._inputOff+=e,this._lookahead+=e}this._lookahead>=Du.minMatch&&this._updateHash()}_slideWindow(){this._window.set(this._window.subarray(Du.wsize,Du.wsize+Du.wsize),0),this._matchStart-=Du.wsize,this._strstart-=Du.wsize,this._blockStart-=Du.wsize;for(let e=0;e<Du.hashSize;++e){let t=65535&this._head[e];this._head[e]=t>=Du.wsize?t-Du.wsize:0}for(let e=0;e<Du.wsize;e++){let t=65535&this._prev[e];this._prev[e]=t>=Du.wsize?t-Du.wsize:0}}};Vu._tooFar=4096;var Wu=Vu,Hu=class{constructor(e){this._start=0,this._end=0,this._bits=0,this.bitCount=0,this._buffer=new Uint8Array(e)}get isFlushed(){return 0===this._end}reset(){this._start=0,this._end=0,this.bitCount=0}writeShortMSB(e){this._buffer[this._end++]=e>>8&255,this._buffer[this._end++]=255&e}writeShort(e){this._buffer[this._end++]=e,this._buffer[this._end++]=e>>8}writeBlock(e,t,s){this._buffer.set(e.subarray(t,t+s),this._end),this._end+=s}flush(e,t,s){return this.bitCount>=8&&(this._buffer[this._end++]=255&this._bits,this._bits>>=8,this.bitCount-=8),s>this._end-this._start?(s=this._end-this._start,e.set(this._buffer.subarray(this._start,this._start+s),t),this._start=0,this._end=0):(e.set(this._buffer.subarray(this._start,this._start+s),t),this._start+=s),s}writeBits(e,t){this._bits|=e<<this.bitCount,this.bitCount+=t,this.bitCount>=16&&(this._buffer[this._end++]=255&this._bits,this._buffer[this._end++]=this._bits>>8&255,this._bits>>=16,this.bitCount-=16)}alignToByte(){this.bitCount>0&&(this._buffer[this._end++]=255&this._bits,this.bitCount>8&&(this._buffer[this._end++]=this._bits>>8&255)),this._bits=0,this.bitCount=0}},Gu=class e{constructor(){this._state=0,this._pending=new Hu(Du.pendingBufSize),this._engine=new Wu(this._pending),this.reset()}get inputCrc(){return this._engine.inputCrc.value}get isNeedingInput(){return this._engine.needsInput()}get isFinished(){return this._state===e._finishedState&&this._pending.isFlushed}reset(){this._state=e._busyState,this._pending.reset(),this._engine.reset()}setInput(e,t,s){this._engine.setInput(e,t,s)}deflate(t,s,i){let a=i;for(;;){let r=this._pending.flush(t,s,i);if(s+=r,0===(i-=r)||this._state===e._finishedState)break;if(!this._engine.deflate(0!==(this._state&e._isFlushing),0!==(this._state&e.isFinishing)))switch(this._state){case e._busyState:return a-i;case e._flushingState:let t=8+(7&-this._pending.bitCount);for(;t>0;)this._pending.writeBits(2,10),t-=10;this._state=e._busyState;break;case e._finishingState:this._pending.alignToByte(),this._state=e._finishedState}}return a-i}finish(){this._state|=e._isFlushing|e.isFinishing}};Gu._isFlushing=4,Gu.isFinishing=8,Gu._busyState=16,Gu._flushingState=20,Gu._finishingState=28,Gu._finishedState=30;var zu=Gu,Uu=class{constructor(e,t,s,i,a){this.entry=e,this.crc32=t,this.localHeaderOffset=s,this.compressionMode=i,this.compressedSize=a}},Yu=class{constructor(e){this._centralDirectoryHeaders=[],this._deflater=new zu,this._data=e}writeEntry(e){let t=Xs.CompressionMethodDeflate,s=Fs.empty(),i=this._compress(s,e.data,t),a=s.toArray(),r=new Uu(e,i,this._data.bytesWritten,t,s.length);this._centralDirectoryHeaders.push(r),Ps.writeInt32LE(this._data,Xs.LocalFileHeaderSignature),Ps.writeUInt16LE(this._data,10),Ps.writeUInt16LE(this._data,2048),Ps.writeUInt16LE(this._data,t),Ps.writeInt16LE(this._data,0),Ps.writeInt16LE(this._data,0),Ps.writeInt32LE(this._data,i),Ps.writeInt32LE(this._data,a.length),Ps.writeInt32LE(this._data,e.data.length),Ps.writeInt16LE(this._data,e.fullName.length),Ps.writeInt16LE(this._data,0);let n=Ps.stringToBytes(e.fullName);this._data.write(n,0,n.length),this._data.write(a,0,a.length)}_compress(e,t,s){if(s!==Xs.CompressionMethodDeflate){let s=new Cu;return s.update(t,0,t.length),e.write(t,0,t.length),s.value}let i=new Uint8Array(512);for(this._deflater.reset(),this._deflater.setInput(t,0,t.length);!this._deflater.isNeedingInput;){let t=this._deflater.deflate(i,0,i.length);if(t<=0)break;e.write(i,0,t)}for(this._deflater.finish();!this._deflater.isFinished;){let t=this._deflater.deflate(i,0,i.length);if(t<=0)break;e.write(i,0,t)}return this._deflater.inputCrc}end(){let e=this._data.bytesWritten;for(let e of this._centralDirectoryHeaders)this._writeCentralDirectoryHeader(e);let t=this._data.bytesWritten;this._writeEndOfCentralDirectoryRecord(e,t)}_writeEndOfCentralDirectoryRecord(e,t){Ps.writeInt32LE(this._data,Xs.EndOfCentralDirSignature),Ps.writeInt16LE(this._data,0),Ps.writeInt16LE(this._data,0),Ps.writeInt16LE(this._data,this._centralDirectoryHeaders.length),Ps.writeInt16LE(this._data,this._centralDirectoryHeaders.length),Ps.writeInt32LE(this._data,t-e),Ps.writeInt32LE(this._data,e),Ps.writeInt16LE(this._data,0)}_writeCentralDirectoryHeader(e){Ps.writeInt32LE(this._data,Xs.CentralFileHeaderSignature),Ps.writeUInt16LE(this._data,10),Ps.writeUInt16LE(this._data,10),Ps.writeUInt16LE(this._data,2048),Ps.writeUInt16LE(this._data,e.compressionMode),Ps.writeInt16LE(this._data,0),Ps.writeInt16LE(this._data,0),Ps.writeInt32LE(this._data,e.crc32),Ps.writeInt32LE(this._data,e.compressedSize),Ps.writeInt32LE(this._data,e.entry.data.length),Ps.writeInt16LE(this._data,e.entry.fullName.length),Ps.writeInt16LE(this._data,0),Ps.writeInt16LE(this._data,0),Ps.writeInt16LE(this._data,0),Ps.writeInt16LE(this._data,0),Ps.writeInt32LE(this._data,0),Ps.writeInt32LE(this._data,e.localHeaderOffset);let t=Ps.stringToBytes(e.entry.fullName);this._data.write(t,0,t.length)}},Xu=class extends Bu{get name(){return"Guitar Pro 7-8"}writeScore(e){re.debug(this.name,"Writing data entries");let t=new Eu,s=t.writeXml(e),i=_i.writeForScore(e),a=Pi.writeForScore(e),r=Ei.writeForScore(e);re.debug(this.name,"Writing ZIP entries");let n=new Yu(this.data);n.writeEntry(new Xs("VERSION",Ps.stringToBytes("7.0"))),n.writeEntry(new Xs("Content/",new Uint8Array(0))),n.writeEntry(new Xs("Content/BinaryStylesheet",i)),n.writeEntry(new Xs("Content/PartConfiguration",a)),n.writeEntry(new Xs("Content/LayoutConfiguration",r)),n.writeEntry(new Xs("Content/score.gpif",Ps.stringToBytes(s))),t.backingTrackAssetFileName&&n.writeEntry(new Xs(t.backingTrackAssetFileName,e.backingTrack.rawAudioFile)),n.end()}},$u={};n($u,{AlphaSynthMidiFileHandler:()=>ko,AlphaTabMetronomeEvent:()=>pa,AlphaTabRestEvent:()=>ma,AlphaTabSysExEvent:()=>ua,AlphaTabSystemExclusiveEvents:()=>ip,BeatTickLookup:()=>xo,BeatTickLookupItem:()=>Bo,ControlChangeEvent:()=>ya,ControllerType:()=>$r,DeprecatedMidiEvent:()=>qu,EndOfTrackEvent:()=>Ta,MasterBarTickLookup:()=>Po,MasterBarTickLookupTempoChange:()=>vo,MetaDataEvent:()=>Qu,MetaEvent:()=>Ku,MetaEventType:()=>ju,MetaNumberEvent:()=>Zu,Midi20PerNotePitchBendEvent:()=>ep,MidiEvent:()=>ha,MidiEventType:()=>la,MidiFile:()=>oa,MidiFileFormat:()=>ra,MidiFileGenerator:()=>Ao,MidiTickLookup:()=>Eo,MidiTickLookupFindBeatResult:()=>Mo,MidiTickLookupFindBeatResultCursorMode:()=>No,MidiTrack:()=>na,NoteBendEvent:()=>wa,NoteEvent:()=>ga,NoteOffEvent:()=>ba,NoteOnEvent:()=>fa,PitchBendEvent:()=>ka,ProgramChangeEvent:()=>_a,SystemCommonEvent:()=>sp,SystemCommonType:()=>tp,SystemExclusiveEvent:()=>ap,TempoChangeEvent:()=>Sa,TimeSignatureEvent:()=>da});var Ju,qu=class extends ha{constructor(){super(0,0,47)}writeTo(e){throw new u(0,"Deprecated event, serialization not supported")}},ju=((Ju=ju||{})[Ju.SequenceNumber=0]="SequenceNumber",Ju[Ju.TextEvent=1]="TextEvent",Ju[Ju.CopyrightNotice=2]="CopyrightNotice",Ju[Ju.SequenceOrTrackName=3]="SequenceOrTrackName",Ju[Ju.InstrumentName=4]="InstrumentName",Ju[Ju.LyricText=5]="LyricText",Ju[Ju.MarkerText=6]="MarkerText",Ju[Ju.CuePoint=7]="CuePoint",Ju[Ju.PatchName=8]="PatchName",Ju[Ju.PortName=9]="PortName",Ju[Ju.MidiChannel=32]="MidiChannel",Ju[Ju.MidiPort=33]="MidiPort",Ju[Ju.EndOfTrack=47]="EndOfTrack",Ju[Ju.Tempo=81]="Tempo",Ju[Ju.SmpteOffset=84]="SmpteOffset",Ju[Ju.TimeSignature=88]="TimeSignature",Ju[Ju.KeySignature=89]="KeySignature",Ju[Ju.SequencerSpecific=127]="SequencerSpecific",Ju),Ku=class extends qu{get metaStatus(){return 47}},Qu=class extends Ku{constructor(){super(...arguments),this.data=new Uint8Array}},Zu=class extends Ku{constructor(){super(...arguments),this.value=0}},ep=class extends qu{constructor(){super(...arguments),this.noteKey=0,this.pitch=0}},tp=(e=>(e[e.SystemExclusive=240]="SystemExclusive",e[e.MtcQuarterFrame=241]="MtcQuarterFrame",e[e.SongPosition=242]="SongPosition",e[e.SongSelect=243]="SongSelect",e[e.TuneRequest=246]="TuneRequest",e[e.SystemExclusive2=247]="SystemExclusive2",e))(tp||{}),sp=class extends qu{},ip=(e=>(e[e.MetronomeTick=0]="MetronomeTick",e[e.Rest=1]="Rest",e))(ip||{}),ap=class extends sp{constructor(){super(...arguments),this.data=new Uint8Array}get isMetronome(){return!1}get metronomeNumerator(){return-1}get metronomeDurationInTicks(){return-1}get metronomeDurationInMilliseconds(){return-1}get isRest(){return!1}get manufacturerId(){return 0}};ap.AlphaTabManufacturerId=125;var rp={};n(rp,{AccentuationType:()=>R,AccidentalType:()=>Ye,Automation:()=>w,AutomationType:()=>S,BackingTrack:()=>Si,Bar:()=>Be,BarLineStyle:()=>ke,BarStyle:()=>Se,BarSubElement:()=>_e,BarreShape:()=>gt,Beat:()=>wt,BeatBeamingMode:()=>bt,BeatStyle:()=>_t,BeatSubElement:()=>yt,BendPoint:()=>T,BendStyle:()=>L,BendType:()=>C,BracketExtendMode:()=>ne,BrushType:()=>F,Chord:()=>Yt,Clef:()=>pe,Color:()=>Jt,CrescendoType:()=>D,Direction:()=>Dt,Duration:()=>I,DynamicValue:()=>f,ElementStyle:()=>ue,FadeType:()=>pt,Fermata:()=>At,FermataType:()=>It,Fingers:()=>O,Font:()=>ln,FontStyle:()=>nn,FontWeight:()=>on,GolpeType:()=>ut,GraceGroup:()=>xe,GraceType:()=>A,HarmonicType:()=>V,HeaderFooterStyle:()=>Ae,InstrumentArticulation:()=>Qe,JsonConverter:()=>po,KeySignature:()=>ge,KeySignatureType:()=>fe,Lyrics:()=>jt,MasterBar:()=>We,MusicFontSymbol:()=>Ue,Note:()=>nt,NoteAccidentalMode:()=>W,NoteOrnament:()=>tt,NoteStyle:()=>at,NoteSubElement:()=>it,Ottavia:()=>H,PickStroke:()=>je,PlaybackInformation:()=>ss,Rasgueado:()=>ft,RenderStylesheet:()=>de,RepeatGroup:()=>ce,Score:()=>Oe,ScoreStyle:()=>Re,ScoreSubElement:()=>De,Section:()=>Kt,SimileMark:()=>me,SlideInType:()=>G,SlideOutType:()=>z,Staff:()=>ts,SustainPedalMarker:()=>ye,SustainPedalMarkerType:()=>be,SyncPointData:()=>k,TechniqueSymbolPlacement:()=>Ke,Track:()=>ns,TrackNameMode:()=>le,TrackNameOrientation:()=>he,TrackNamePolicy:()=>oe,TrackStyle:()=>as,TrackSubElement:()=>is,TripletFeel:()=>Ve,Tuning:()=>Zt,TupletGroup:()=>dt,VibratoType:()=>U,Voice:()=>Me,VoiceStyle:()=>Pe,VoiceSubElement:()=>ve,WahPedal:()=>mt,WhammyType:()=>ct});var np={};n(np,{CssFontSvgCanvas:()=>Bl,Cursors:()=>cl,FontSizeDefinition:()=>fo,FontSizes:()=>yo,MeasuredText:()=>Ce,SvgCanvas:()=>Tl,TextAlign:()=>Ee,TextBaseline:()=>Le});var op={};n(op,{ActiveBeatsChangedEventArgs:()=>$o,AlphaSynth:()=>en,AlphaSynthAudioWorkletOutput:()=>aa,AlphaSynthBase:()=>Zr,AlphaSynthScriptProcessorOutput:()=>ll,AlphaSynthWebAudioOutputBase:()=>ea,AlphaSynthWebWorkerApi:()=>hl,AudioExportChunk:()=>Qr,AudioExportOptions:()=>Kr,BackingTrackSyncPoint:()=>xa,CircularSampleBuffer:()=>$i,MidiEventsPlayedEventArgs:()=>qr,PlaybackRange:()=>Zo,PlaybackRangeChangedEventArgs:()=>jr,PlayerState:()=>Ma,PlayerStateChangedEventArgs:()=>Ea,PositionChangedEventArgs:()=>La});var lp,hp={},dp={};return bu.isRunningInWorker?bu.initializeWorker():bu.isRunningInAudioWorklet?bu.initializeAudioWorklet():bu.initializeMain(e=>{if(1===bu.webPlatform)throw new u(0,"Workers not yet supported in Node.js");if(2===bu.webPlatform||bu.isWebPackBundled||bu.isViteBundled){re.debug("AlphaTab","Creating webworker");try{return new bu.alphaTabWorker(new bu.alphaTabUrl("./alphaTab.worker.ts",dp.url),{type:"module"})}catch(e){re.debug("AlphaTab","ESM webworker construction with direct URL failed",e)}let t="";try{t=new bu.alphaTabUrl("./alphaTab.worker.ts",dp.url);let e=`import ${JSON.stringify(t)}`,s=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(s),{type:"module"})}catch(e){re.debug("AlphaTab","ESM webworker construction with blob import failed",t,e)}try{if(!e.core.scriptFile)throw new Error("Could not detect alphaTab script file");t=e.core.scriptFile;let s=`import ${JSON.stringify(e.core.scriptFile)}`,i=new Blob([s],{type:"application/javascript"});return new Worker(URL.createObjectURL(i),{type:"module"})}catch(t){re.debug("AlphaTab","ESM webworker construction with blob import failed",e.core.scriptFile,t)}}if(!e.core.scriptFile)throw new u(0,"Could not detect alphaTab script file, cannot initialize renderer");try{re.debug("AlphaTab","Creating Blob worker");let t=`importScripts('${e.core.scriptFile}')`,s=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(s))}catch{return re.warning("Rendering","Could not create inline worker, fallback to normal worker"),new Worker(e.core.scriptFile)}},(e,t)=>{if(1===bu.webPlatform)throw new u(0,"Audio Worklets not yet supported in Node.js");return 2===bu.webPlatform||bu.isWebPackBundled||bu.isViteBundled?(re.debug("AlphaTab","Creating Module worklet"),e.audioWorklet.addModule(new bu.alphaTabUrl("./alphaTab.worklet.ts",dp.url))):(re.debug("AlphaTab","Creating Script worklet"),e.audioWorklet.addModule(t.core.scriptFile))}),lp=h,((a,r,n,o)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let l of s(r))!i.call(a,l)&&l!==n&&e(a,l,{get:()=>r[l],enumerable:!(o=t(r,l))||o.enumerable});return a})(e({},"__esModule",{value:!0}),lp)})();
